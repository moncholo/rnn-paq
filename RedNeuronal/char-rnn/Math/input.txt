\input{preamble}

% OK, start here.
%
\begin{document}

\title{Adequate Modules}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
For any scheme $X$ the category $\QCoh(\mathcal{O}_X)$
of quasi-coherent modules is abelian and a weak Serre subcategory
of the abelian category of all $\mathcal{O}_X$-modules. The same
thing works for the category of quasi-coherent modules on
an algebraic space $X$ viewed as a subcategory of the category
of all $\mathcal{O}_X$-modules on the small \'etale site of $X$.
Moreover, for a quasi-compact and quasi-separated morphism
$f : X \to Y$ the pushforward $f_*$ and higher direct images
preserve quasi-coherence.

\medskip\noindent
Next, let $X$ be a scheme and let $\mathcal{O}$ be the structure
sheaf on one of the big sites of $X$, say, the big fppf site.
The category of quasi-coherent $\mathcal{O}$-modules is abelian
(in fact it is equivalent to the category of usual quasi-coherent
$\mathcal{O}_X$-modules on the scheme $X$ we mentioned above)
but its imbedding into $\textit{Mod}(\mathcal{O})$ is not exact.
An example is the map of quasi-coherent modules
$$
\mathcal{O}_{\mathbf{A}^1_k}
\longrightarrow
\mathcal{O}_{\mathbf{A}^1_k}
$$
on $\mathbf{A}^1_k = \Spec(k[x])$ given by multiplication by $x$.
In the abelian category of quasi-coherent sheaves this map is injective,
whereas in the abelian category of all $\mathcal{O}$-modules on the
big site of $\mathbf{A}^1_k$ this map has a nontrivial kernel as we
see by evaluating on sections over $\Spec(k[x]/(x)) = \Spec(k)$.
Moreover, for a quasi-compact and quasi-separated morphism
$f : X \to Y$ the functor $f_{big, *}$ does not preserve quasi-coherence.

\medskip\noindent
In this chapter we introduce a larger category of modules, closely related
to quasi-coherent modules, which ``fixes'' the two problems mentioned above.





\section{Conventions}
\label{section-conventions}

\noindent
In this chapter we fix
$\tau \in \{Zar, \etale, smooth, syntomic, fppf\}$
and we fix a big $\tau$-site $\Sch_\tau$ as in
Topologies, Section \ref{topologies-section-procedure}.
All schemes will be objects of $\Sch_\tau$.
In particular, given a scheme $S$ we obtain sites
$(\textit{Aff}/S)_\tau \subset (\Sch/S)_\tau$.
The structure sheaf $\mathcal{O}$ on these sites is defined by
the rule $\mathcal{O}(T) = \Gamma(T, \mathcal{O}_T)$.

\medskip\noindent
All rings $A$ will be such that $\Spec(A)$ is (isomorphic to) an
object of $\Sch_\tau$. Given a ring $A$ we denote
$\textit{Alg}_A$ the category of $A$-algebras whose objects are the
$A$-algebras $B$ of the form $B = \Gamma(U, \mathcal{O}_U)$
where $S$ is an affine object of $\Sch_\tau$. Thus given an
affine scheme $S = \Spec(A)$ the functor
$$
(\textit{Aff}/S)_\tau \longrightarrow \textit{Alg}_A,
\quad
U \longmapsto \mathcal{O}(U)
$$
is an equivalence.





\section{Adequate functors}
\label{section-quasi-coherent}

\noindent
In this section we discuss a topic closely related to
direct images of quasi-coherent sheaves. Most of this material
was taken from the paper \cite{Jaffe}.

\begin{definition}
\label{definition-module-valued-functor}
Let $A$ be a ring. A {\it module-valued functor} is a functor
$F : \textit{Alg}_A \to \textit{Ab}$ such that
\begin{enumerate}
\item for every object $B$ of $\textit{Alg}_A$ the group
$F(B)$ is endowed with the structure of a $B$-module, and
\item for any morphism $B \to B'$ of $\textit{Alg}_A$ the map
$F(B) \to F(B')$ is $B$-linear.
\end{enumerate}
A {\it morphism of module-valued functors} is a transformation of
functors $\varphi : F \to G$ such that $F(B) \to G(B)$ is $B$-linear
for all $B \in \Ob(\textit{Alg}_A)$.
\end{definition}

\noindent
Let $S = \Spec(A)$ be an affine scheme.
The category of module-valued functors on $\textit{Alg}_A$ is
equivalent to the category
$\textit{PMod}((\textit{Aff}/S)_\tau, \mathcal{O})$
of presheaves of $\mathcal{O}$-modules. The equivalence is given
by the rule which assigns to the module-valued functor $F$ the
presheaf $\mathcal{F}$ defined by the rule
$\mathcal{F}(U) = F(\mathcal{O}(U))$.
This is clear from the equivalence
$(\textit{Aff}/S)_\tau \to \textit{Alg}_A$, $U \mapsto \mathcal{O}(U)$
given in Section \ref{section-conventions}.
The quasi-inverse sets $F(B) = \mathcal{F}(\Spec(B))$.

\medskip\noindent
An important special case of a module-valued functor comes about as follows.
Let $M$ be an $A$-module. Then we will denote $\underline{M}$ the
module-valued functor $B \mapsto M \otimes_A B$ (with obvious $B$-module
structure). Note that if $M \to N$ is a map of $A$-modules then there is an
associated morphism $\underline{M} \to \underline{N}$ of module-valued
functors. Conversely, any morphism of module-valued functors
$\underline{M} \to \underline{N}$ comes from an $A$-module map $M \to N$
as the reader can see by evaluating on $B = A$. In other words
$\text{Mod}_A$ is a full
subcategory of the category of module-valued functors on $\textit{Alg}_A$.

\medskip\noindent
Given and $A$-module map $\varphi : M \to N$ then
$\Coker(\underline{M} \to \underline{N}) =
\underline{Q}$ where $Q = \Coker(M \to N)$ because $\otimes$
is right exact. But this isn't the case
for the kernel in general: for example an injective map of
$A$-modules need not be injective after base change. Thus the following
definition makes sense.

\begin{definition}
\label{definition-adequate-functor}
Let $A$ be a ring. A module-valued functor $F$ on $\textit{Alg}_A$ is
called
\begin{enumerate}
\item {\it adequate} if there exists a
map of $A$-modules $M \to N$ such that $F$ is isomorphic to
$\Ker(\underline{M} \to \underline{N})$.
\item {\it linearly adequate} if $F$ is isomorphic to the
kernel of a map $\underline{A^{\oplus n}} \to \underline{A^{\oplus m}}$.
\end{enumerate}
\end{definition}

\noindent
Note that $F$ is adequate if and only if there exists an
exact sequence $0 \to F \to \underline{M} \to \underline{N}$ and
$F$ is linearly adequate if and only if there exists an exact sequence
$0 \to F \to \underline{A^{\oplus n}} \to \underline{A^{\oplus m}}$.

\medskip\noindent
Let $A$ be a ring. In this section we will show the category of adequate
functors on $\textit{Alg}_A$ is abelian
(Lemmas \ref{lemma-cokernel-adequate} and \ref{lemma-kernel-adequate})
and has a set of generators
(Lemma \ref{lemma-adequate-surjection-from-linear}).
We will also see that it is a weak Serre subcategory of the category
of all module-valued functors on $\textit{Alg}_A$
(Lemma \ref{lemma-extension-adequate})
and that it has arbitrary colimits
(Lemma \ref{lemma-colimit-adequate}).

\begin{lemma}
\label{lemma-adequate-finite-presentation}
Let $A$ be a ring.
Let $F$ be an adequate functor on $\textit{Alg}_A$.
If $B = \colim B_i$ is a filtered
colimit of $A$-algebras, then $F(B) = \colim F(B_i)$.
\end{lemma}

\begin{proof}
This holds because for any $A$-module $M$ we have
$M \otimes_A B = \colim M \otimes_A B_i$ (see
Algebra, Lemma \ref{algebra-lemma-tensor-products-commute-with-limits})
and because filtered colimits commute with exact sequences, see
Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}.
\end{proof}

\begin{remark}
\label{remark-settheoretic}
Consider the category $\textit{Alg}_{fp, A}$ whose objects are $A$-algebras
$B$ of the form $B = A[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and whose
morphisms are $A$-algebra maps. Every $A$-algebra $B$ is a filtered colimit
of finitely presented $A$-algebra, i.e., a filtered colimit of objects of
$\textit{Alg}_{fp, A}$. By
Lemma \ref{lemma-adequate-finite-presentation}
we conclude every adequate functor $F$ is determined by its restriction to
$\textit{Alg}_{fp, A}$. For some questions we can therefore restrict to
functors on $\textit{Alg}_{fp, A}$. For example, the category of adequate
functors does not depend on the choice of the big $\tau$-site
chosen in
Section \ref{section-conventions}.
\end{remark}

\begin{lemma}
\label{lemma-adequate-flat}
Let $A$ be a ring.
Let $F$ be an adequate functor on $\textit{Alg}_A$.
If $B \to B'$ is flat, then $F(B) \otimes_B B' \to F(B')$
is an isomorphism.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F \to \underline{M} \to \underline{N}$.
This gives the diagram
$$
\xymatrix{
0 \ar[r] & F(B) \otimes_B B' \ar[r] \ar[d] &
(M \otimes_A B)\otimes_B B' \ar[r] \ar[d] &
(N \otimes_A B)\otimes_B B' \ar[d] \\
0 \ar[r] & F(B') \ar[r] &
M \otimes_A B' \ar[r] &
N \otimes_A B'
}
$$
where the rows are exact (the top one because $B \to B'$ is flat).
Since the right two vertical arrows are isomorphisms, so is the
left one.
\end{proof}

\begin{lemma}
\label{lemma-adequate-surjection-from-linear}
Let $A$ be a ring.
Let $F$ be an adequate functor on $\textit{Alg}_A$. Then there exists a
surjection $L \to F$ with $L$ a direct sum of linearly adequate functors.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F \to \underline{M} \to \underline{N}$
where $\underline{M} \to \underline{N}$ is given by
$\varphi : M \to N$. By
Lemma \ref{lemma-adequate-finite-presentation}
it suffices to construct $L \to F$ such that $L(B) \to F(B)$ is surjective
for every finitely presented $A$-algebra $B$. Hence it suffices to construct,
given a finitely presented $A$-algebra $B$ and an element $\xi \in F(B)$
a map $L \to F$ with $L$ linearly adequate such that $\xi$ is in the image
of $L(B) \to F(B)$.
(Because there is a set worth of such pairs $(B, \xi)$ up to isomorphism.)

\medskip\noindent
To do this write $\sum_{i = 1, \ldots, n} m_i \otimes b_i$ the image of
$\xi$ in $\underline{M}(B) = M \otimes_A B$. We know that
$\sum \varphi(m_i) \otimes b_i = 0$ in $N \otimes_A B$.
As $N$ is a filtered colimit of finitely presented $A$-modules, we can
find a finitely presented $A$-module $N'$, a commutative diagram
of $A$-modules
$$
\xymatrix{
A^{\oplus n} \ar[r] \ar[d]_{m_1, \ldots, m_n} & N' \ar[d] \\
M \ar[r] & N
}
$$
such that $(b_1, \ldots, b_n)$ maps to zero in $N' \otimes_A B$.
Choose a presentation $A^{\oplus l} \to A^{\oplus k} \to N' \to 0$.
Choose a lift $A^{\oplus n} \to A^{\oplus k}$ of the map
$A^{\oplus n} \to N'$ of the diagram. Then we see that there exist
$(c_1, \ldots, c_l) \in B^{\oplus l}$ such that
$(b_1, \ldots, b_n, c_1, \ldots, c_l)$ maps to zero in $B^{\oplus k}$
under the map $B^{\oplus n} \oplus B^{\oplus l} \to B^{\oplus k}$.
Consider the commutative diagram
$$
\xymatrix{
A^{\oplus n} \oplus A^{\oplus l} \ar[r] \ar[d] & A^{\oplus k} \ar[d] \\
M \ar[r] & N
}
$$
where the left vertical arrow is zero on the summand $A^{\oplus l}$.
Then we see that $L$ equal to the kernel of $\underline{A^{\oplus n + l}}
\to \underline{A^{\oplus k}}$ works because the element
$(b_1, \ldots, b_n, c_1, \ldots, c_l) \in L(B)$ maps to $\xi$.
\end{proof}

\noindent
Consider a graded $A$-algebra $B = \bigoplus_{d \geq 0} B_d$. Then there are
two $A$-algebra maps $p, a : B \to B[t, t^{-1}]$, namely $p : b \mapsto b$ and
$a : b \mapsto t^{\deg(b)} b$ where $b$ is homogeneous. If $F$ is a
module-valued functor on $\textit{Alg}_A$, then we define
\begin{equation}
\label{equation-weight-k}
F(B)^{(k)} = \{\xi \in F(B) \mid t^k F(p)(\xi) = F(a)(\xi)\}.
\end{equation}
For functors which behave well with respect to flat ring extensions
this gives a direct sum decomposition. This amounts to the fact that
representations of $\mathbf{G}_m$ are completely reducible.

\begin{lemma}
\label{lemma-flat-functor-split}
Let $A$ be a ring.
Let $F$ be a module-valued functor on $\textit{Alg}_A$.
Assume that for $B \to B'$ flat the map
$F(B) \otimes_B B' \to F(B')$ is an isomorphism.
Let $B$ be a graded $A$-algebra. Then
\begin{enumerate}
\item $F(B) = \bigoplus_{k \in \mathbf{Z}} F(B)^{(k)}$, and
\item the map $B \to B_0 \to B$ induces map $F(B) \to F(B)$
whose image is contained in $F(B)^{(0)}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in F(B)$. The map $p : B \to B[t, t^{-1}]$ is free
hence we know that
$$
F(B[t, t^{-1}]) =
\bigoplus\nolimits_{k \in \mathbf{Z}} F(p)(F(B)) \cdot t^k =
\bigoplus\nolimits_{k \in \mathbf{Z}} F(B) \cdot t^k
$$
as indicated we drop the $F(p)$ in the rest of the proof.
Write $F(a)(x) = \sum t^k x_k$ for some $x_k \in F(B)$.
Denote $\epsilon : B[t, t^{-1}] \to B$
the $B$-algebra map $t \mapsto 1$. Note that the compositions
$\epsilon \circ p, \epsilon \circ a : B \to B[t, t^{-1}] \to B$ are
the identity. Hence we see that
$$
x = F(\epsilon)(F(a)(x)) = F(\epsilon)(\sum t^k x_k) = \sum x_k.
$$
On the other hand, we claim that $x_k \in F(B)^{(k)}$. Namely, consider
the commutative diagram
$$
\xymatrix{
B \ar[r]_a \ar[d]_{a'} &
B[t, t^{-1}] \ar[d]^f \\
B[s, s^{-1}] \ar[r]^-g &
B[t, s, t^{-1}, s^{-1}]
}
$$
where $a'(b) = s^{\deg(b)}b$, $f(b) = b$, $f(t) = st$ and
$g(b) = t^{\deg(b)}b$ and $g(s) = s$. Then
$$
F(g)(F(a'))(x) = F(g)(\sum s^k x_k) =
\sum s^k F(a)(x_k)
$$
and going the other way we see
$$
F(f)(F(a))(x) = F(f)(\sum t^k x_k) = \sum (st)^k x_k.
$$
Since $B \to B[s, t, s^{-1}, t^{-1}]$ is free we see that
$F(B[t, s, t^{-1}, s^{-1}]) =
\bigoplus_{k, l \in \mathbf{Z}} F(B) \cdot t^ks^l$ and
comparing coefficients in the expressions above we find
$F(a)(x_k) = t^k x_k$ as desired.

\medskip\noindent
Finally, the image of $F(B_0) \to F(B)$ is contained in $F(B)^{(0)}$
because $B_0 \to B \xrightarrow{a} B[t, t^{-1}]$ is equal to
$B_0 \to B \xrightarrow{p} B[t, t^{-1}]$.
\end{proof}

\noindent
As a particular case of
Lemma \ref{lemma-flat-functor-split}
note that
$$
\underline{M}(B)^{(k)} = M \otimes_A B_k
$$
where $B_k$ is the degree $k$ part of the graded $A$-algebra $B$.

\begin{lemma}
\label{lemma-lift-map}
Let $A$ be a ring. Given a solid diagram
$$
\xymatrix{
0 \ar[r] &
L \ar[d]_\varphi \ar[r] &
\underline{A^{\oplus n}} \ar[r] \ar@{..>}[ld] &
\underline{A^{\oplus m}} \\
& \underline{M}
}
$$
of module-valued functors on $\textit{Alg}_A$
with exact row there exists a dotted arrow making the diagram commute.
\end{lemma}

\begin{proof}
Suppose that the map $A^{\oplus n} \to A^{\oplus m}$ is given by the
$m \times n$-matrix $(a_{ij})$. Consider the ring
$B = A[x_1, \ldots, x_n]/(\sum a_{ij}x_j)$. The element
$(x_1, \ldots, x_n) \in \underline{A^{\oplus n}}(B)$ maps to zero in
$\underline{A^{\oplus m}}(B)$ hence is the image of a unique element
$\xi \in L(B)$. Note that $\xi$ has the following universal property:
for any $A$-algebra $C$ and any $\xi' \in L(C)$ there exists an $A$-algebra
map $B \to C$ such that $\xi$ maps to $\xi'$ via the map $L(B) \to L(C)$.

\medskip\noindent
Note that $B$ is a graded $A$-algebra, hence we can use
Lemmas \ref{lemma-flat-functor-split} and \ref{lemma-adequate-flat}
to decompose the values of our functors on $B$ into graded pieces.
Note that $\xi \in L(B)^{(1)}$ as $(x_1, \ldots, x_n)$ is an element
of degree one in $\underline{A^{\oplus n}}(B)$. Hence we see that
$\varphi(\xi) \in \underline{M}(B)^{(1)} = M \otimes_A B_1$.
Since $B_1$ is generated by $x_1, \ldots, x_n$ as an $A$-module we
can write $\varphi(\xi) = \sum m_i \otimes x_i$. Consider the map
$A^{\oplus n} \to M$ which maps the $i$th basis vector to $m_i$.
By construction the associated map
$\underline{A^{\oplus n}} \to \underline{M}$
maps the element $\xi$ to $\varphi(\xi)$. It follows from the
universal property mentioned above that the diagram commutes.
\end{proof}

\begin{lemma}
\label{lemma-cokernel-into-module}
Let $A$ be a ring.
Let $\varphi : F \to \underline{M}$ be a map of module-valued functors
on $\textit{Alg}_A$ with $F$ adequate.
Then $\Coker(\varphi)$ is adequate.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-adequate-surjection-from-linear}
we may assume that $F = \bigoplus L_i$ is a direct sum of linearly adequate
functors. Choose exact sequences
$0 \to L_i \to \underline{A^{\oplus n_i}} \to \underline{A^{\oplus m_i}}$.
For each $i$ choose a map $A^{\oplus n_i} \to M$ as in
Lemma \ref{lemma-lift-map}.
Consider the diagram
$$
\xymatrix{
0 \ar[r] &
\bigoplus L_i  \ar[r] \ar[d] &
\bigoplus \underline{A^{\oplus n_i}} \ar[r] \ar[ld] &
\bigoplus \underline{A^{\oplus m_i}} \\
& \underline{M}
}
$$
Consider the $A$-modules
$$
Q =
\Coker(\bigoplus A^{\oplus n_i} \to M \oplus \bigoplus A^{\oplus m_i})
\quad\text{and}\quad
P = \Coker(\bigoplus A^{\oplus n_i} \to \bigoplus A^{\oplus m_i}).
$$
Then we see that $\Coker(\varphi)$ is isomorphic to the
kernel of $\underline{Q} \to \underline{P}$.
\end{proof}

\begin{lemma}
\label{lemma-cokernel-adequate}
\begin{slogan}
The cokernel of a map of adequate functors on the category of algebras
over a ring is adequate.
\end{slogan}
Let $A$ be a ring.
Let $\varphi : F \to G$ be a map of adequate functors on $\textit{Alg}_A$.
Then $\Coker(\varphi)$ is adequate.
\end{lemma}

\begin{proof}
Choose an injection $G \to \underline{M}$.
Then we have an injection $G/F \to \underline{M}/F$. By
Lemma \ref{lemma-cokernel-into-module}
we see that $\underline{M}/F$ is adequate, hence we can find an injection
$\underline{M}/F \to \underline{N}$.
Composing we obtain an injection $G/F \to \underline{N}$. By
Lemma \ref{lemma-cokernel-into-module}
the cokernel of the induced map $G \to \underline{N}$ is adequate
hence we can find an injection $\underline{N}/G \to \underline{K}$.
Then $0 \to G/F \to \underline{N} \to \underline{K}$ is exact and
we win.
\end{proof}

\begin{lemma}
\label{lemma-kernel-adequate}
Let $A$ be a ring.
Let $\varphi : F \to G$ be a map of adequate functors on $\textit{Alg}_A$.
Then $\Ker(\varphi)$ is adequate.
\end{lemma}

\begin{proof}
Choose an injection $F \to \underline{M}$ and an injection
$G \to \underline{N}$. Denote $F \to \underline{M \oplus N}$
the diagonal map so that
$$
\xymatrix{
F \ar[d] \ar[r] & G \ar[d] \\
\underline{M \oplus N} \ar[r] & \underline{N}
}
$$
commutes. By
Lemma \ref{lemma-cokernel-adequate}
we can find a module map $M \oplus N \to K$ such that
$F$ is the kernel of $\underline{M \oplus N} \to \underline{K}$.
Then $\Ker(\varphi)$ is the kernel of
$\underline{M \oplus N} \to \underline{K \oplus N}$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-adequate}
Let $A$ be a ring.
An arbitrary direct sum of adequate functors on $\textit{Alg}_A$
is adequate. A colimit of adequate functors is adequate.
\end{lemma}

\begin{proof}
The statement on direct sums is immediate.
A general colimit can be written as a kernel of a map between
direct sums, see
Categories, Lemma \ref{categories-lemma-colimits-coproducts-coequalizers}.
Hence this follows from
Lemma \ref{lemma-kernel-adequate}.
\end{proof}

\begin{lemma}
\label{lemma-flat-linear-functor}
Let $A$ be a ring.
Let $F, G$ be module-valued functors on $\textit{Alg}_A$.
Let $\varphi : F \to G$ be a transformation of functors. Assume
\begin{enumerate}
\item $\varphi$ is additive,
\item for every $A$-algebra $B$ and $\xi \in F(B)$ and unit
$u \in B^*$ we have $\varphi(u\xi) = u\varphi(\xi)$ in $G(B)$, and
\item for any flat ring map $B \to B'$ we have
$G(B) \otimes_B B' = G(B')$.
\end{enumerate}
Then $\varphi$ is a morphism of module-valued functors.
\end{lemma}

\begin{proof}
Let $B$ be an $A$-algebra, $\xi \in F(B)$, and $b \in B$. We have to show
that $\varphi(b \xi) = b \varphi(\xi)$. Consider the ring map
$$
B \to B' = B[x, y, x^{-1}, y^{-1}]/(x + y - b).
$$
This ring map is faithfully flat, hence $G(B) \subset G(B')$. On the
other hand
$$
\varphi(b\xi) = \varphi((x + y)\xi) =
\varphi(x\xi) + \varphi(y\xi) = x\varphi(\xi) + y\varphi(\xi)
= (x + y)\varphi(\xi) = b\varphi(\xi)
$$
because $x, y$ are units in $B'$. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-extension-adequate-key}
Let $A$ be a ring.
Let $0 \to \underline{M} \to G \to L \to 0$ be a short exact sequence
of module-valued functors on $\textit{Alg}_A$ with $L$ linearly adequate.
Then $G$ is adequate.
\end{lemma}

\begin{proof}
We first point out that for any flat $A$-algebra map
$B \to B'$ the map $G(B) \otimes_B B' \to G(B')$ is an isomorphism.
Namely, this holds for $\underline{M}$ and $L$, see
Lemma \ref{lemma-adequate-flat}
and hence follows for $G$ by the five lemma. In particular, by
Lemma \ref{lemma-flat-functor-split}
we see that $G(B) = \bigoplus_{k \in \mathbf{Z}} G(B)^{(k)}$
for any graded $A$-algebra $B$.

\medskip\noindent
Choose an exact sequence
$0 \to L \to \underline{A^{\oplus n}} \to \underline{A^{\oplus m}}$.
Suppose that the map $A^{\oplus n} \to A^{\oplus m}$ is given by the
$m \times n$-matrix $(a_{ij})$. Consider the graded $A$-algebra
$B = A[x_1, \ldots, x_n]/(\sum a_{ij}x_j)$. The element
$(x_1, \ldots, x_n) \in \underline{A^{\oplus n}}(B)$ maps to zero in
$\underline{A^{\oplus m}}(B)$ hence is the image of a unique element
$\xi \in L(B)$. Observe that $\xi \in L(B)^{(1)}$. The map
$$
\Hom_A(B, C) \longrightarrow L(C), \quad
f \longmapsto L(f)(\xi)
$$
defines an isomorphism of functors. The reason is that $f$ is
determined by the images $c_i = f(x_i) \in C$ which have to
satisfy the relations $\sum a_{ij}c_j = 0$. And $L(C)$ is the
set of $n$-tuples $(c_1, \ldots, c_n)$ satisfying the relations
$\sum a_{ij} c_j = 0$.

\medskip\noindent
Since the value of each of the functors $\underline{M}$, $G$, $L$
on $B$ is a direct sum of its weight spaces (by the lemma mentioned
above) exactness of $0 \to \underline{M} \to G \to L \to 0$ implies
the sequence $0 \to \underline{M}(B)^{(1)} \to G(B)^{(1)} \to L(B)^{(1)} \to 0$
is exact. Thus we may choose an element $\theta \in G(B)^{(1)}$ mapping
to $\xi$.

\medskip\noindent
Consider the graded $A$-algebra
$$
C = A[x_1, \ldots, x_n, y_1, \ldots, y_n]/
(\sum a_{ij}x_j, \sum a_{ij}y_j)
$$
There are three graded $A$-algebra homomorphisms $p_1, p_2, m : B \to C$
defined by the rules
$$
p_1(x_i) = x_i, \quad
p_1(x_i) = y_i, \quad
m(x_i) = x_i + y_i.
$$
We will show that the element
$$
\tau = G(m)(\theta) - G(p_1)(\theta) - G(p_2)(\theta) \in G(C)
$$
is zero. First, $\tau$ maps to zero in $L(C)$ by a direct calculation.
Hence $\tau$ is an element of $\underline{M}(C)$.
Moreover, since $m$, $p_1$, $p_2$ are graded algebra maps we see
that $\tau \in G(C)^{(1)}$ and since $\underline{M} \subset G$
we conclude
$$
\tau \in \underline{M}(C)^{(1)} = M \otimes_A C_1.
$$
We may write uniquely
$\tau = \underline{M}(p_1)(\tau_1) + \underline{M}(p_2)(\tau_2)$ with
$\tau_i \in M \otimes_A B_1 = \underline{M}(B)^{(1)}$ because
$C_1 = p_1(B_1) \oplus p_2(B_1)$.
Consider the ring map $q_1 : C \to B$ defined by $x_i \mapsto x_i$ and
$y_i \mapsto 0$. Then
$\underline{M}(q_1)(\tau) =
\underline{M}(q_1)(\underline{M}(p_1)(\tau_1) + \underline{M}(p_2)(\tau_2)) =
\tau_1$.
On the other hand, because
$q_1 \circ m = q_1 \circ p_1$ we see that
$G(q_1)(\tau) = - G(q_1 \circ p_2)(\tau)$. Since $q_1 \circ p_2$ factors as
$B \to A \to B$ we see that $G(q_1 \circ p_2)(\tau)$ is in
$G(B)^{(0)}$, see
Lemma \ref{lemma-flat-functor-split}.
Hence $\tau_1 = 0$ because it is in
$G(B)^{(0)} \cap \underline{M}(B)^{(1)} \subset
G(B)^{(0)} \cap G(B)^{(1)} = 0$.
Similarly $\tau_2 = 0$, whence $\tau = 0$.

\medskip\noindent
Since $\theta \in G(B)$ we obtain a transformation of functors
$$
\psi : L(-) = \Hom_A(B, - ) \longrightarrow G(-)
$$
by mapping $f : B \to C$ to $G(f)(\theta)$. Since $\theta$ is a lift of
$\xi$ the map $\psi$ is a right inverse of $G \to L$. In terms of
$\psi$ the statements proved above have the following meaning:
$\tau = 0$ means that $\psi$ is additive and
$\theta \in G(B)^{(1)}$ implies that for any $A$-algebra $D$ we have
$\psi(ul) = u\psi(l)$ in $G(D)$ for $l \in L(D)$ and $u \in D^*$ a unit.
This implies that $\psi$ is a morphism of module-valued functors, see
Lemma \ref{lemma-flat-linear-functor}.
Clearly this implies that $G \cong \underline{M} \oplus L$ and we win.
\end{proof}

\begin{remark}
\label{remark-linearly-adequate}
Let $A$ be a ring.
The proof of
Lemma \ref{lemma-extension-adequate-key}
shows that any extension $0 \to \underline{M} \to E \to L \to 0$
of module-valued functors on $\textit{Alg}_A$
with $L$ linearly adequate splits. It uses only the following properties
of the module-valued functor $F = \underline{M}$:
\begin{enumerate}
\item $F(B) \otimes_B B' \to F(B')$ is an isomorphism
for a flat ring map $B \to B'$, and
\item
$F(C)^{(1)} = F(p_1)(F(B)^{(1)}) \oplus F(p_2)(F(B)^{(1)})$
where $B = A[x_1, \ldots, x_n]/(\sum a_{ij}x_j)$ and
$C = A[x_1, \ldots, x_n, y_1, \ldots, y_n]/
(\sum a_{ij}x_j, \sum a_{ij}y_j)$.
\end{enumerate}
These two properties hold for any adequate functor $F$; details omitted.
Hence we see that $L$ is a projective object of the abelian category of
adequate functors.
\end{remark}

\begin{lemma}
\label{lemma-extension-adequate}
Let $A$ be a ring.
Let $0 \to F \to G \to H \to 0$ be a short exact sequence of
module-valued functors on $\textit{Alg}_A$.
If $F$ and $H$ are adequate, so is $G$.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F \to \underline{M} \to \underline{N}$.
If we can show that $(\underline{M} \oplus G)/F$ is adequate, then
$G$ is the kernel of the map of adequate functors
$(\underline{M} \oplus G)/F \to \underline{N}$, hence
adequate by
Lemma \ref{lemma-kernel-adequate}.
Thus we may assume $F = \underline{M}$.

\medskip\noindent
We can choose a surjection $L \to H$ where $L$ is a direct sum of
linearly adequate functors, see
Lemma \ref{lemma-adequate-surjection-from-linear}.
If we can show that the pullback $G \times_H L$ is adequate, then
$G$ is the cokernel of the map $\Ker(L \to H) \to G \times_H L$
hence adequate by
Lemma \ref{lemma-cokernel-adequate}.
Thus we may assume that $H = \bigoplus L_i$ is a direct sum of
linearly adequate functors. By
Lemma \ref{lemma-extension-adequate-key}
each of the pullbacks $G \times_H L_i$ is adequate. By
Lemma \ref{lemma-colimit-adequate}
we see that $\bigoplus G \times_H L_i$ is adequate.
Then $G$ is the cokernel of
$$
\bigoplus\nolimits_{i \not = i'} F \longrightarrow
\bigoplus G \times_H L_i
$$
where $\xi$ in the summand $(i, i')$ maps to
$(0, \ldots, 0, \xi, 0, \ldots, 0, -\xi, 0, \ldots, 0)$
with nonzero entries in the summands $i$ and $i'$.
Thus $G$ is adequate by
Lemma \ref{lemma-cokernel-adequate}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-adequate}
Let $A \to A'$ be a ring map. If $F$ is an adequate functor on
$\textit{Alg}_A$, then its restriction $F'$ to
$\textit{Alg}_{A'}$ is adequate too.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F \to \underline{M} \to \underline{N}$.
Then $F'(B') = F(B') = \Ker(M \otimes_A B' \to N \otimes_A B')$.
Since $M \otimes_A B' = M \otimes_A A' \otimes_{A'} B'$ and similarly
for $N$ we see that $F'$ is the kernel of
$\underline{M \otimes_A A'} \to \underline{N \otimes_A A'}$.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-adequate}
Let $A \to A'$ be a ring map. If $F'$ is an adequate functor on
$\textit{Alg}_{A'}$, then the module-valued functor
$F : B \mapsto F'(A' \otimes_A B)$ on $\textit{Alg}_A$ is adequate too.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F' \to \underline{M'} \to \underline{N'}$.
Then
\begin{align*}
F(B) & = F'(A' \otimes_A B) \\
& = \Ker(M' \otimes_{A'} (
A' \otimes_A B) \to N' \otimes_{A'} (A' \otimes_A B)) \\
& = \Ker(M' \otimes_A B \to N' \otimes_A B)
\end{align*}
Thus $F$ is the kernel of
$\underline{M} \to \underline{N}$
where $M = M'$ and $N = N'$ viewed as $A$-modules.
\end{proof}

\begin{lemma}
\label{lemma-adequate-product}
Let $A = A_1 \times \ldots \times A_n$ be a product of rings.
An adequate functor over $A$ is the same thing as a sequence
$F_1, \ldots, F_n$ of adequate functors $F_i$ over $A_i$.
\end{lemma}

\begin{proof}
This is true because an $A$-algebra $B$ is canonically a product
$B_1 \times \ldots \times B_n$ and the same thing holds for $A$-modules.
Setting $F(B) = \coprod F_i(B_i)$ gives the correspondence.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-adequate-descent}
Let $A \to A'$ be a ring map and let $F$ be a module-valued functor on
$\textit{Alg}_A$ such that
\begin{enumerate}
\item the restriction $F'$ of $F$ to the category of $A'$-algebras is
adequate, and
\item for any $A$-algebra $B$ the sequence
$$
0 \to F(B) \to F(B \otimes_A A') \to F(B \otimes_A A' \otimes_A A')
$$
is exact.
\end{enumerate}
Then $F$ is adequate.
\end{lemma}

\begin{proof}
The functors $B \to F(B \otimes_A A')$ and
$B \mapsto F(B \otimes_A A' \otimes_A A')$ are adequate, see
Lemmas \ref{lemma-pushforward-adequate} and
\ref{lemma-base-change-adequate}.
Hence $F$ as a kernel of a map of adequate functors is adequate, see
Lemma \ref{lemma-kernel-adequate}.
\end{proof}






\section{Higher exts of adequate functors}
\label{section-higher-ext}

\noindent
Let $A$ be a ring. In
Lemma \ref{lemma-extension-adequate}
we have seen that any extension of adequate functors in the category
of module-valued functors on $\textit{Alg}_A$ is adequate. In this
section we show that the same remains true for higher ext groups.

\begin{lemma}
\label{lemma-adjoint}
Let $A$ be a ring.
For every module-valued functor $F$ on $\textit{Alg}_A$
there exists a morphism $Q(F) \to F$ of module-valued functors on
$\textit{Alg}_A$ such that (1) $Q(F)$ is adequate and (2) for every
adequate functor $G$ the map $\Hom(G, Q(F)) \to \Hom(G, F)$
is a bijection.
\end{lemma}

\begin{proof}
Choose a set $\{L_i\}_{i \in I}$ of linearly adequate functors such that
every linearly adequate functor is isomorphic to one of the $L_i$.
This is possible. Suppose that we can find $Q(F) \to F$ with (1) and
(2)' or every $i \in I$ the map $\Hom(L_i, Q(F)) \to \Hom(L_i, F)$
is a bijection. Then (2) holds. Namely, combining
Lemmas \ref{lemma-adequate-surjection-from-linear} and
\ref{lemma-kernel-adequate}
we see that every adequate functor $G$ sits in an exact sequence
$$
K \to L \to G \to 0
$$
with $K$ and $L$ direct sums of linearly adequate functors. Hence (2)'
implies that
$\Hom(L, Q(F)) \to \Hom(L, F)$
and
$\Hom(K, Q(F)) \to \Hom(K, F)$
are bijections, whence the same thing for $G$.

\medskip\noindent
Consider the category $\mathcal{I}$ whose objects are pairs
$(i, \varphi)$ where $i \in I$ and $\varphi : L_i \to F$ is a morphism.
A morphism $(i, \varphi) \to (i', \varphi')$ is a map
$\psi : L_i \to L_{i'}$ such that $\varphi' \circ \psi = \varphi$.
Set
$$
Q(F) = \colim_{(i, \varphi) \in \Ob(\mathcal{I})} L_i
$$
There is a natural map $Q(F) \to F$, by
Lemma \ref{lemma-colimit-adequate}
it is adequate, and by construction it has property (2)'.
\end{proof}

\begin{lemma}
\label{lemma-enough-injectives}
Let $A$ be a ring. Denote $\mathcal{P}$ the category of module-valued
functors on $\textit{Alg}_A$ and $\mathcal{A}$ the category of adequate
functors on $\textit{Alg}_A$. Denote $i : \mathcal{A} \to \mathcal{P}$
the inclusion functor. Denote $Q : \mathcal{P} \to \mathcal{A}$
the construction of Lemma \ref{lemma-adjoint}.
Then
\begin{enumerate}
\item $i$ is fully faithful, exact, and its image is a weak Serre subcategory,
\item $\mathcal{P}$ has enough injectives,
\item the functor $Q$ is a right adjoint to $i$ hence left exact,
\item $Q$ transforms injectives into injectives,
\item $\mathcal{A}$ has enough injectives.
\end{enumerate}
\end{lemma}

\begin{proof}
This lemma just collects some facts we have already seen so far.
Part (1) is clear from the definitions, the characterization of
weak Serre subcategories (see
Homology, Lemma \ref{homology-lemma-characterize-weak-serre-subcategory}),
and
Lemmas \ref{lemma-cokernel-adequate}, \ref{lemma-kernel-adequate},
and \ref{lemma-extension-adequate}.
Recall that $\mathcal{P}$ is equivalent to the category
$\textit{PMod}((\textit{Aff}/\Spec(A))_\tau, \mathcal{O})$.
Hence (2) by
Injectives, Proposition \ref{injectives-proposition-presheaves-modules}.
Part (3) follows from
Lemma \ref{lemma-adjoint}
and
Categories, Lemma \ref{categories-lemma-adjoint-exact}.
Parts (4) and (5) follow from
Homology, Lemmas \ref{homology-lemma-adjoint-preserve-injectives} and
\ref{homology-lemma-adjoint-enough-injectives}.
\end{proof}

\noindent
Let $A$ be a ring. As in
Formal Deformation Theory, Section
\ref{formal-defos-section-tangent-spaces-functors}
given an $A$-algebra $B$ and an $B$-module $N$ we set $B[N]$ equal to
the $R$-algebra with underlying $B$-module $B \oplus N$ with multiplication
given by $(b, m)(b', m ') = (bb', bm' + b'm)$. Note that this construction
is functorial in the pair $(B, N)$ where morphism $(B, N) \to (B', N')$
is given by an $A$-algebra map $B \to B'$ and an $B$-module map
$N \to N'$. In some sense the functor $TF$ of pairs defined in the following
lemma is the tangent space of $F$.
Below we will only consider pairs $(B, N)$ such that
$B[N]$ is an object of $\textit{Alg}_A$.

\begin{lemma}
\label{lemma-tangent-functor}
Let $A$ be a ring. Let $F$ be a module valued functor.
For every $B \in \Ob(\textit{Alg}_A)$ and $B$-module $N$
there is a canonical decomposition
$$
F(B[N]) = F(B) \oplus TF(B, N)
$$
characterized by the following properties
\begin{enumerate}
\item $TF(B, N) = \Ker(F(B[N]) \to F(B))$,
\item there is a $B$-module structure $TF(B, N)$
compatible with $B[N]$-module structure on $F(B[N])$,
\item $TF$ is a functor from the category of pairs $(B, N)$,
\item
\label{item-mult-map}
there are canonical maps $N \otimes_B F(B) \to TF(B, N)$
inducing a transformation between functors defined on the category
of pairs $(B, N)$,
\item $TF(B, 0) = 0$ and the map $TF(B, N) \to TF(B, N')$ is
zero when $N \to N'$ is the zero map.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $B \to B[N] \to B$ is the identity we see that $F(B) \to F(B[N])$
is a direct summand whose complement is $TF(N, B)$ as defined in (1).
This construction is functorial in the pair $(B, N)$ simply because
given a morphism of pairs $(B, N) \to (B', N')$ we obtain a commutative
diagram
$$
\xymatrix{
B' \ar[r] & B'[N'] \ar[r] & B' \\
B \ar[r] \ar[u] & B[N] \ar[r] \ar[u] & B \ar[u]
}
$$
in $\textit{Alg}_A$. The $B$-module structure comes from the $B[N]$-module
structure and the ring map $B \to B[N]$. The map in (4) is the
composition
$$
N \otimes_B F(B) \longrightarrow
B[N] \otimes_{B[N]} F(B[N]) \longrightarrow F(B[N])
$$
whose image is contained in $TF(B, N)$. (The first arrow uses the inclusions
$N \to B[N]$ and $F(B) \to F(B[N])$ and the second arrow is the multiplication
map.) If $N = 0$, then $B = B[N]$
hence $TF(B, 0) = 0$. If $N \to N'$ is zero then it factors as
$N \to 0 \to N'$ hence the induced map is zero since $TF(B, 0) = 0$.
\end{proof}

\noindent
Let $A$ be a ring. Let $M$ be an $A$-module. Then the module-valued functor
$\underline{M}$ has tangent space $T\underline{M}$ given by the rule
$T\underline{M}(B, N) = N \otimes_A M$. In particular, for $B$ given, the
functor $N \mapsto T\underline{M}(B, N)$ is additive and right exact. It turns
out this also holds for injective module-valued functors.

\begin{lemma}
\label{lemma-tangent-injective}
Let $A$ be a ring. Let $I$ be an injective object of the category
of module-valued functors. Then for any $B \in \Ob(\textit{Alg}_A)$
and short exact sequence
$0 \to N_1 \to N \to N_2 \to 0$
of $B$-modules the sequence
$$
TI(B, N_1) \to TI(B, N) \to TI(B, N_2) \to 0
$$
is exact.
\end{lemma}

\begin{proof}
We will use the results of
Lemma \ref{lemma-tangent-functor}
without further mention.
Denote $h : \textit{Alg}_A \to \textit{Sets}$ the functor given by
$h(C) = \Mor_A(B[N], C)$. Similarly for $h_1$ and $h_2$.
The map $B[N] \to B[N_2]$ corresponding to the surjection $N \to N_2$
is surjective. It corresponds to a map $h_2 \to h$ such that
$h_2(C) \to h(C)$ is injective for all $A$-algebras $C$. On the other
hand, there are two maps $p, q : h \to h_1$, corresponding to the
zero map $N_1 \to N$ and the injection $N_1 \to N$. Note that
$$
\xymatrix{
h_2 \ar[r] & h \ar@<1ex>[r] \ar@<-1ex>[r] & h_1
}
$$
is an equalizer diagram. Denote $\mathcal{O}_h$ the module-valued functor
$C \mapsto \bigoplus_{h(C)} C$. Similarly for $\mathcal{O}_{h_1}$ and
$\mathcal{O}_{h_2}$. Note that
$$
\Hom_\mathcal{P}(\mathcal{O}_h, F) = F(B[N])
$$
where $\mathcal{P}$ is the category of of module-valued functors on
$\textit{Alg}_A$. We claim there is an equalizer diagram
$$
\xymatrix{
\mathcal{O}_{h_2} \ar[r] &
\mathcal{O}_h \ar@<1ex>[r] \ar@<-1ex>[r] &
\mathcal{O}_{h_1}
}
$$
in $\mathcal{P}$. Namely, suppose that $C \in \Ob(\textit{Alg}_A)$
and $\xi = \sum_{i = 1, \ldots, n} c_i \cdot f_i$ where $c_i \in C$ and
$f_i : B[N] \to C$ is an element of
$\mathcal{O}_h(C)$. If $p(\xi) = q(\xi)$, then
we see that
$$
\sum c_i \cdot f_i \circ z = \sum c_i \cdot f_i \circ y
$$
where $z, y : B[N_1] \to B[N]$ are the maps $z : (b, m_1) \mapsto (b, 0)$
and $y : (b, m_1) \mapsto (b, m_1)$. This means that for every $i$
there exists a $j$ such that $f_j \circ z = f_i \circ y$. Clearly, this
implies that $f_i(N_1) = 0$, i.e., $f_i$ factors through a unique map
$\overline{f}_i : B[N_2] \to C$. Hence $\xi$ is the image of
$\overline{\xi} = \sum c_i \cdot \overline{f}_i$.
Since $I$ is injective, it transforms this equalizer diagram
into a coequalizer diagram
$$
\xymatrix{
I(B[N_1]) \ar@<1ex>[r] \ar@<-1ex>[r] &
I(B[N]) \ar[r] &
I(B[N_2])
}
$$
This diagram is compatible with the direct sum decompositions
$I(B[N]) = I(B) \oplus TI(B, N)$ and $I(B[N_i]) = I(B) \oplus TI(B, N_i)$.
The zero map $N \to N_1$ induces the zero map $TI(B, N) \to TI(B, N_1)$.
Thus we see that the coequalizer property
above means we have an exact sequence
$TI(B, N_1) \to TI(B, N) \to TI(B, N_2) \to 0$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-exactness-implies}
Let $A$ be a ring. Let $F$ be a module-valued functor
such that for any $B \in \Ob(\textit{Alg}_A)$ the
functor $TF(B, -)$ on $B$-modules transforms a short exact sequence
of $B$-modules into a right exact sequence. Then
\begin{enumerate}
\item $TF(B, N_1 \oplus N_2) = TF(B, N_1) \oplus TF(B, N_2)$,
\item there is a second functorial $B$-module structure on $TF(B, N)$
defined by setting $x \cdot b = TF(B, b\cdot 1_N)(x)$ for $x \in TF(B, N)$
and $b \in B$,
\item
\label{item-mult-map-linear}
the canonical map $N \otimes_B F(B) \to TF(B, N)$ of
Lemma \ref{lemma-tangent-functor}
is $B$-linear also with respect to the second $B$-module structure,
\item
\label{item-tangent-right-exact}
given a finitely presented $B$-module $N$ there is a canonical
isomorphism $TF(B, B) \otimes_B N \to TF(B, N)$ where the tensor
product uses the second $B$-module structure on $TF(B, B)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use the results of
Lemma \ref{lemma-tangent-functor}
without further mention.
The maps $N_1 \to N_1 \oplus N_2$ and $N_2 \to N_1 \oplus N_2$ give
a map $TF(B, N_1) \oplus TF(B, N_2) \to TF(B, N_1 \oplus N_2)$
which is injective since the maps $N_1 \oplus N_2 \to N_1$ and
$N_1 \oplus N_2 \to N_2$ induce an inverse.
Since $TF$ is right exact we see that
$TF(B, N_1) \to TF(B, N_1 \oplus N_2) \to TF(B, N_2) \to 0$ is exact.
Hence $TF(B, N_1) \oplus TF(B, N_2) \to TF(B, N_1 \oplus N_2)$ is an
isomorphism. This proves (1).

\medskip\noindent
To see (2) the only thing we need to show is that
$x \cdot (b_1 + b_2) = x \cdot b_1 + x \cdot b_2$.
(Associativity and additivity are clear.) To see this consider
$$
N \xrightarrow{(b_1, b_2)} N \oplus N \xrightarrow{+} N
$$
and apply $TF(B, -)$.

\medskip\noindent
Part (3) follows immediately from the fact that
$N \otimes_B F(B) \to TF(B, N)$ is functorial in the pair $(B, N)$.

\medskip\noindent
Suppose $N$ is a finitely presented $B$-module. Choose a presentation
$B^{\oplus m} \to B^{\oplus n} \to N \to 0$. This gives an exact
sequence
$$
TF(B, B^{\oplus m}) \to TF(B, B^{\oplus n}) \to TF(B, N) \to 0
$$
by right exactness of $TF(B, -)$. By part (1) we can write
$TF(B, B^{\oplus m}) = TF(B, B)^{\oplus m}$ and
$TF(B, B^{\oplus n}) = TF(B, B)^{\oplus n}$. Next, suppose that
$B^{\oplus m} \to B^{\oplus n}$ is given by the matrix $T = (b_{ij})$.
Then the induced map $TF(B, B)^{\oplus m} \to TF(B, B)^{\oplus n}$
is given by the matrix with entries $TF(B, b_{ij} \cdot 1_B)$.
This combined with right exactness of $\otimes$ proves (4).
\end{proof}

\begin{example}
\label{example-module-structure-different}
Let $F$ be a module-valued functor as in
Lemma \ref{lemma-exactness-implies}.
It is not always the case that the two module structures on
$TF(B, N)$ agree. Here is an example. Suppose $A = \mathbf{F}_p$
where $p$ is a prime. Set $F(B) = B$ but with $B$-module structure
given by $b \cdot x = b^px$. Then $TF(B, N) = N$ with $B$-module structure
given by $b \cdot x = b^px$ for $x \in N$. However, the second $B$-module
structure is given by $x \cdot b = bx$. Note that in this case the canonical
map $N \otimes_B F(B) \to TF(B, N)$ is zero as raising an element
$n \in B[N]$ to the $p$th power is zero.
\end{example}

\noindent
In the following lemma we will frequently use the observation that
if $0 \to F \to G \to H \to 0$ is an exact sequence of module-valued
functors on $\textit{Alg}_A$, then for any pair $(B, N)$ the
sequence $0 \to TF(B, N) \to TG(B, N) \to TH(B, N) \to 0$ is exact.
This follows from the fact that $0 \to F(B[N]) \to G(B[N]) \to H(B[N]) \to 0$
is exact.

\begin{lemma}
\label{lemma-exactness-permanence}
Let $A$ be a ring. For $F$ a module-valued functor on $\textit{Alg}_A$
say $(*)$ holds if for all $B \in \Ob(\textit{Alg}_A)$ the
functor $TF(B, -)$ on $B$-modules transforms a short exact sequence
of $B$-modules into a right exact sequence. Let
$0 \to F \to G \to H \to 0$ be a short exact sequence of
module-valued functors on $\textit{Alg}_A$.
\begin{enumerate}
\item If $(*)$ holds for $F, G$ then $(*)$ holds for $H$.
\item If $(*)$ holds for $F, H$ then $(*)$ holds for $G$.
\item If $H' \to H$ is morphism of module-valued functors on $\textit{Alg}_A$
and $(*)$ holds for $F$, $G$, $H$, and $H'$, then $(*)$ holds for
$G \times_H H'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $B$ be given. Let $0 \to N_1 \to N_2 \to N_3 \to 0$ be a short exact
sequence of $B$-modules. Part (1) follows from a diagram chase in
the diagram
$$
\xymatrix{
0 \ar[r] &
TF(B, N_1) \ar[r] \ar[d] &
TG(B, N_1) \ar[r] \ar[d] &
TH(B, N_1) \ar[r] \ar[d] & 0 \\
0 \ar[r] &
TF(B, N_2) \ar[r] \ar[d] &
TG(B, N_2) \ar[r] \ar[d] &
TH(B, N_2) \ar[r] \ar[d] & 0 \\
0 \ar[r] &
TF(B, N_3) \ar[r] \ar[d] &
TG(B, N_3) \ar[r] \ar[d] &
TH(B, N_3) \ar[r] & 0 \\
& 0 & 0
}
$$
with exact horizontal rows and exact columns involving $TF$ and $TG$.
To prove part (2) we do a diagram chase in the diagram
$$
\xymatrix{
0 \ar[r] &
TF(B, N_1) \ar[r] \ar[d] &
TG(B, N_1) \ar[r] \ar[d] &
TH(B, N_1) \ar[r] \ar[d] & 0 \\
0 \ar[r] &
TF(B, N_2) \ar[r] \ar[d] &
TG(B, N_2) \ar[r] \ar[d] &
TH(B, N_2) \ar[r] \ar[d] & 0 \\
0 \ar[r] &
TF(B, N_3) \ar[r] \ar[d] &
TG(B, N_3) \ar[r] &
TH(B, N_3) \ar[r] \ar[d] & 0 \\
& 0 & & 0
}
$$
with exact horizontal rows and exact columns involving $TF$ and $TH$.
Part (3) follows from part (2) as $G \times_H H'$ sits in the exact
sequence $0 \to F \to G \times_H H' \to H' \to 0$.
\end{proof}

\noindent
Most of the work in this section was done in order to prove the
following key vanishing result.

\begin{lemma}
\label{lemma-ext-group-zero-key}
Let $A$ be a ring. Let $M$, $P$ be $A$-modules with $P$ of finite
presentation. Then
$\text{Ext}^i_\mathcal{P}(\underline{P}, \underline{M}) = 0$
for $i > 0$ where $\mathcal{P}$ is the category of module-valued
functors on $\textit{Alg}_A$.
\end{lemma}

\begin{proof}
Choose an injective resolution $\underline{M} \to I^\bullet$ in
$\mathcal{P}$, see
Lemma \ref{lemma-enough-injectives}.
By
Derived Categories, Lemma \ref{derived-lemma-compute-ext-resolutions}
any element of $\text{Ext}^i_\mathcal{P}(\underline{P}, \underline{M})$
comes from a morphism $\varphi : \underline{P} \to I^i$ with
$d^i \circ \varphi = 0$. We will prove that the
Yoneda extension
$$
E : 0 \to \underline{M} \to I^0 \to \ldots \to
I^{i - 1} \times_{\Ker(d^i)} \underline{P} \to \underline{P} \to 0
$$
of $\underline{P}$ by $\underline{M}$
associated to $\varphi$ is trivial, which will prove the lemma by
Derived Categories, Lemma \ref{derived-lemma-yoneda-extension}.

\medskip\noindent
For $F$ a module-valued functor on $\textit{Alg}_A$
say $(*)$ holds if for all $B \in \Ob(\textit{Alg}_A)$ the
functor $TF(B, -)$ on $B$-modules transforms a short exact sequence
of $B$-modules into a right exact sequence.
Recall that the module-valued functors $\underline{M}, I^n, \underline{P}$
each have property $(*)$, see
Lemma \ref{lemma-tangent-injective}
and the remarks preceding it.
By splitting $0 \to \underline{M} \to I^\bullet$ into short
exact sequences we find that each of the functors
$\Im(d^{n - 1}) = \Ker(d^n) \subset I^n$ has property $(*)$ by
Lemma \ref{lemma-exactness-permanence}
and also that $I^{i - 1} \times_{\Ker(d^i)} \underline{P}$ has property
$(*)$.

\medskip\noindent
Thus we may assume the Yoneda extension is given as
$$
E : 0 \to \underline{M} \to F_{i - 1} \to \ldots \to
F_0 \to \underline{P} \to 0
$$
where each of the module-valued functors $F_j$ has property $(*)$.
Set $G_j(B) = TF_j(B, B)$ viewed as a $B$-module via the {\it second}
$B$-module structure defined in
Lemma \ref{lemma-exactness-implies}.
Since $TF_j$ is a functor on pairs we see that $G_j$ is a module-valued
functor on $\textit{Alg}_A$. Moreover, since $E$ is an exact sequence
the sequence $G_{j + 1} \to G_j \to G_{j - 1}$ is exact (see remark
preceding
Lemma \ref{lemma-exactness-permanence}).
Observe that $T\underline{M}(B, B) = M \otimes_A B = \underline{M}(B)$
and that the two $B$-module structures agree on this.
Thus we obtain a Yoneda extension
$$
E' :  0 \to \underline{M} \to G_{i - 1} \to \ldots \to
G_0 \to \underline{P} \to 0
$$
Moreover, the canonical maps
$$
F_j(B) = B \otimes_B F_j(B) \longrightarrow TF_j(B, B) = G_j(B)
$$
of
Lemma \ref{lemma-tangent-functor} (\ref{item-mult-map})
are $B$-linear by
Lemma \ref{lemma-exactness-implies} (\ref{item-mult-map-linear})
and functorial in $B$. Hence a map
$$
\xymatrix{
0 \ar[r] &
\underline{M} \ar[r] \ar[d]^1 &
F_{i - 1} \ar[r] \ar[d] &
\ldots \ar[r] &
F_0 \ar[r] \ar[d] &
\underline{P} \ar[r] \ar[d]^1 & 0 \\
0 \ar[r] &
\underline{M} \ar[r] &
G_{i - 1} \ar[r] &
\ldots \ar[r] &
G_0 \ar[r] &
\underline{P} \ar[r] & 0
}
$$
of Yoneda extensions. In particular we see that $E$ and $E'$ have the
same class in $\text{Ext}^i_\mathcal{P}(\underline{P}, \underline{M})$
by the lemma on Yoneda Exts mentioned above. Finally, let $N$ be a
$A$-module of finite presentation. Then we see that
$$
0 \to T\underline{M}(A, N) \to TF_{i - 1}(A, N) \to \ldots \to
TF_0(A, N) \to T\underline{P}(A, N) \to 0
$$
is exact. By
Lemma \ref{lemma-exactness-implies} (\ref{item-tangent-right-exact})
with $B = A$ this translates into the exactness of the sequence of
$A$-modules
$$
0 \to M \otimes_A N \to G_{i - 1}(A) \otimes_A N \to \ldots \to
G_0(A) \otimes_A N \to P \otimes_A N \to 0
$$
Hence the sequence of $A$-modules
$0 \to M \to G_{i - 1}(A) \to \ldots \to G_0(A) \to P \to 0$
is universally exact, in the sense that it remains exact on tensoring
with any finitely presented $A$-module $N$. Let
$K = \Ker(G_0(A) \to P)$ so that we have exact sequences
$$
0 \to K \to G_0(A) \to P \to 0
\quad\text{and}\quad
G_2(A) \to G_1(A) \to K \to 0
$$
Tensoring the second sequence with $N$ we obtain that
$K \otimes_A N = \Coker(G_2(A) \otimes_A N \to G_1(A) \otimes_A N)$.
Exactness of $G_2(A) \otimes_A N \to G_1(A) \otimes_A N \to G_0(A) \otimes_A N$
then implies that $K \otimes_A N \to G_0(A) \otimes_A N$ is injective.
By
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}
this means that the $A$-module extension $0 \to K \to G_0(A) \to P \to 0$
is exact, and because $P$ is assumed of finite presentation this means
the sequence is split, see
Algebra, Lemma \ref{algebra-lemma-universally-exact-split}.
Any splitting $P \to G_0(A)$ defines a map $\underline{P} \to G_0$
which splits the surjection $G_0 \to \underline{P}$. Thus the
Yoneda extension $E'$ is equivalent to the trivial Yoneda extension
and we win.
\end{proof}

\begin{lemma}
\label{lemma-ext-group-zero}
Let $A$ be a ring. Let $M$ be an $A$-module. Let $L$ be a linearly
adequate functor on $\textit{Alg}_A$. Then
$\text{Ext}^i_\mathcal{P}(L, \underline{M}) = 0$
for $i > 0$ where $\mathcal{P}$ is the category of module-valued
functors on $\textit{Alg}_A$.
\end{lemma}

\begin{proof}
Since $L$ is linearly adequate there exists an exact sequence
$$
0 \to L \to \underline{A^{\oplus m}} \to \underline{A^{\oplus n}} \to
\underline{P} \to 0
$$
Here $P = \Coker(A^{\oplus m} \to A^{\oplus n})$ is the cokernel
of the map of finite free $A$-modules which is given by the definition
of linearly adequate functors. By
Lemma \ref{lemma-ext-group-zero-key}
we have the vanishing of
$\text{Ext}^i_\mathcal{P}(\underline{P}, \underline{M})$
and
$\text{Ext}^i_\mathcal{P}(\underline{A}, \underline{M})$
for $i > 0$.
Let $K = \Ker(\underline{A^{\oplus n}} \to \underline{P})$.
By the long exact sequence of Ext groups associated to the exact sequence
$0 \to K \to \underline{A^{\oplus n}} \to \underline{P} \to 0$
we conclude that
$\text{Ext}^i_\mathcal{P}(K, \underline{M}) = 0$ for $i > 0$.
Repeating with the sequence
$0 \to L \to \underline{A^{\oplus m}} \to K \to 0$
we win.
\end{proof}

\begin{lemma}
\label{lemma-RQ-zero}
With notation as in
Lemma \ref{lemma-enough-injectives}
we have $R^pQ(F) = 0$ for all $p > 0$ and any adequate functor $F$.
\end{lemma}

\begin{proof}
Choose an exact sequence $0 \to F \to \underline{M^0} \to \underline{M^1}$.
Set $M^2 = \Coker(M^0 \to M^1)$ so that
$0 \to F \to \underline{M^0} \to \underline{M^1}
\to \underline{M^2} \to 0$ is a resolution. By
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}
we obtain a spectral sequence
$$
R^pQ(\underline{M^q}) \Rightarrow R^{p + q}Q(F)
$$
Since $Q(\underline{M^q}) = \underline{M^q}$ it suffices to prove
$R^pQ(\underline{M}) = 0$, $p > 0$ for any $A$-module $M$.

\medskip\noindent
Choose an injective resolution $\underline{M} \to I^\bullet$ in
the category $\mathcal{P}$. Suppose that $R^iQ(\underline{M})$ is nonzero.
Then $\Ker(Q(I^i) \to Q(I^{i + 1}))$ is strictly bigger
than the image of $Q(I^{i - 1}) \to Q(I^i)$. Hence by
Lemma \ref{lemma-adequate-surjection-from-linear}
there exists a linearly adequate functor $L$ and a map
$\varphi : L \to Q(I^i)$ mapping into the kernel of $Q(I^i) \to Q(I^{i + 1})$
which does not factor through the image of $Q(I^{i - 1}) \to Q(I^i)$.
Because $Q$ is a left adjoint to the inclusion functor the map
$\varphi$ corresponds to a map $\varphi' : L \to I^i$ with the same properties.
Thus $\varphi'$ gives a nonzero element of
$\text{Ext}^i_\mathcal{P}(L, \underline{M})$ contradicting
Lemma \ref{lemma-ext-group-zero}.
\end{proof}














\section{Adequate modules}
\label{section-adequate}

\noindent
In
Descent, Section \ref{descent-section-quasi-coherent-sheaves}
we have seen that quasi-coherent modules on a scheme $S$
are the same as quasi-coherent modules on any of the big
sites $(\Sch/S)_\tau$ associated to $S$. We have seen that there
are two issues with this identification:
\begin{enumerate}
\item $\QCoh(\mathcal{O}_S) \to
\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$,
$\mathcal{F} \mapsto \mathcal{F}^a$ is not exact in general, and
\item given a quasi-compact and quasi-separated morphism $f : X \to S$
the functor $f_*$ does not preserve quasi-coherent sheaves on the
big sites in general.
\end{enumerate}
Part (1) means that we cannot define a triangulated subcategory
of $D(\mathcal{O})$ consisting of complexes whose cohomology sheaves
are quasi-coherent. Part (2) means that $Rf_*\mathcal{F}$ isn't a
complex with quasi-coherent cohomology sheaves even when $\mathcal{F}$
is quasi-coherent and $f$ is quasi-compact and quasi-separated.
Moreover, the examples given in the proofs of
Descent, Lemma
\ref{descent-lemma-equivalence-quasi-coherent-limits}
and
Descent, Proposition
\ref{descent-proposition-equivalence-quasi-coherent-functorial}
are not of a pathological nature.

\medskip\noindent
In this section we discuss a slightly larger category
of $\mathcal{O}$-modules on $(\Sch/S)_\tau$ with contains the
quasi-coherent modules, is abelian, and is preserved under $f_*$ when
$f$ is quasi-compact and quasi-separated.
To do this, suppose that $S$ is a scheme. Let $\mathcal{F}$ be a presheaf
of $\mathcal{O}$-modules on $(\Sch/S)_\tau$.
For any affine object $U = \Spec(A)$ of $(\Sch/S)_\tau$
we can restrict $\mathcal{F}$ to $(\textit{Aff}/U)_\tau$ to get
a presheaf of $\mathcal{O}$-modules on this site. The corresponding
module-valued functor, see
Section \ref{section-quasi-coherent},
will be denoted
$$
F = F_{\mathcal{F}, A} :
\textit{Alg}_A \longrightarrow \textit{Ab},
\quad
B \longmapsto \mathcal{F}(\Spec(B))
$$
The assignment $\mathcal{F} \mapsto F_{\mathcal{F}, A}$ is an exact
functor of abelian categories.

\begin{definition}
\label{definition-adequate}
A sheaf of $\mathcal{O}$-modules $\mathcal{F}$ on $(\Sch/S)_\tau$ is
{\it adequate} if there exists a $\tau$-covering
$\{\Spec(A_i) \to S\}_{i \in I}$ such that $F_{\mathcal{F}, A_i}$ is
adequate for all $i \in I$.
\end{definition}

\noindent
We will see below that the category of adequate $\mathcal{O}$-modules
is independent of the chosen topology $\tau$.

\begin{lemma}
\label{lemma-adequate-local}
Let $S$ be a scheme. Let $\mathcal{F}$ be an adequate $\mathcal{O}$-module on
$(\Sch/S)_\tau$. For any affine scheme $\Spec(A)$ over $S$
the functor $F_{\mathcal{F}, A}$ is adequate.
\end{lemma}

\begin{proof}
Let $\{\Spec(A_i) \to S\}_{i \in I}$ be a $\tau$-covering
such that $F_{\mathcal{F}, A_i}$ is adequate for all $i \in I$.
We can find a standard affine $\tau$-covering
$\{\Spec(A'_j) \to \Spec(A)\}_{j = 1, \ldots, m}$
such that $\Spec(A'_j) \to \Spec(A) \to S$ factors
through $\Spec(A_{i(j)})$ for some $i(j) \in I$. Then we see that
$F_{\mathcal{F}, A'_j}$ is the restriction of
$F_{\mathcal{F}, A_{i(j)}}$ to the category of $A'_j$-algebras.
Hence $F_{\mathcal{F}, A'_j}$ is adequate by
Lemma \ref{lemma-base-change-adequate}.
By
Lemma \ref{lemma-adequate-product}
the sequence
$F_{\mathcal{F}, A'_j}$ corresponds to an adequate ``product'' functor
$F'$ over $A' = A'_1 \times \ldots \times A'_m$. As $\mathcal{F}$ is a
sheaf (for the Zariski topology) this product functor $F'$ is equal
to $F_{\mathcal{F}, A'}$, i.e., is the restriction of $F$ to $A'$-algebras.
Finally,  $\{\Spec(A') \to \Spec(A)\}$ is a $\tau$-covering.
It follows from
Lemma \ref{lemma-adequate-descent}
that $F_{\mathcal{F}, A}$ is adequate.
\end{proof}

\begin{lemma}
\label{lemma-adequate-affine}
Let $S = \Spec(A)$ be an affine scheme. The category of adequate
$\mathcal{O}$-modules on $(\Sch/S)_\tau$ is equivalent to the
category of adequate module-valued functors on $\textit{Alg}_A$.
\end{lemma}

\begin{proof}
Given an adequate module $\mathcal{F}$ the functor $F_{\mathcal{F}, A}$
is adequate by Lemma \ref{lemma-adequate-local}.
Given an adequate functor $F$ we choose an exact sequence
$0 \to F \to \underline{M} \to \underline{N}$ and we consider
the $\mathcal{O}$-module $\mathcal{F} = \Ker(M^a \to N^a)$ where
$M^a$ denotes the quasi-coherent $\mathcal{O}$-module on
$(\Sch/S)_\tau$ associated to the quasi-coherent sheaf
$\widetilde{M}$ on $S$. Note that $F = F_{\mathcal{F}, A}$, in particular
the module $\mathcal{F}$ is adequate by definition.
We omit the proof that the constructions define mutually inverse
equivalences of categories.
\end{proof}

\begin{lemma}
\label{lemma-pullback-adequate}
Let $f : T \to S$ be a morphism of schemes.
The pullback $f^*\mathcal{F}$ of an adequate $\mathcal{O}$-module
$\mathcal{F}$ on $(\Sch/S)_\tau$ is an adequate
$\mathcal{O}$-module on $(\Sch/T)_\tau$.
\end{lemma}

\begin{proof}
The pullback map
$f^* : \textit{Mod}((\Sch/S)_\tau, \mathcal{O}) \to
\textit{Mod}((\Sch/T)_\tau, \mathcal{O})$
is given by restriction, i.e., $f^*\mathcal{F}(V) = \mathcal{F}(V)$
for any scheme $V$ over $T$. Hence this lemma follows immediately from
Lemma \ref{lemma-adequate-local}
and the definition.
\end{proof}

\noindent
Here is a characterization of the category of adequate $\mathcal{O}$-modules.
To understand the significance, consider a map $\mathcal{G} \to \mathcal{H}$
of quasi-coherent $\mathcal{O}_S$-modules on a scheme $S$.
The cokernel of the associated map $\mathcal{G}^a \to \mathcal{H}^a$
of $\mathcal{O}$-modules is quasi-coherent because it is equal to
$(\mathcal{H}/\mathcal{G})^a$. But the kernel of
$\mathcal{G}^a \to \mathcal{H}^a$ in general isn't
quasi-coherent. However, it is adequate.

\begin{lemma}
\label{lemma-adequate-characterize}
Let $S$ be a scheme. Let $\mathcal{F}$ be an $\mathcal{O}$-module on
$(\Sch/S)_\tau$. The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is adequate,
\item there exists an affine open covering $S = \bigcup S_i$ and
maps of quasi-coherent $\mathcal{O}_{S_i}$-modules
$\mathcal{G}_i \to \mathcal{H}_i$
such that $\mathcal{F}|_{(\Sch/S_i)_\tau}$ is the
kernel of $\mathcal{G}_i^a \to \mathcal{H}_i^a$
\item there exists a $\tau$-covering $\{S_i \to S\}_{i \in I}$ and
maps of $\mathcal{O}_{S_i}$-quasi-coherent modules
$\mathcal{G}_i \to \mathcal{H}_i$
such that $\mathcal{F}|_{(\Sch/S_i)_\tau}$ is the
kernel of $\mathcal{G}_i^a \to \mathcal{H}_i^a$,
\item there exists a $\tau$-covering $\{f_i : S_i \to S\}_{i \in I}$
such that each $f_i^*\mathcal{F}$ is adequate,
\item for any affine scheme $U$ over $S$ the restriction
$\mathcal{F}|_{(\Sch/U)_\tau}$ is the kernel
of a map $\mathcal{G}^a \to \mathcal{H}^a$ of quasi-coherent
$\mathcal{O}_U$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $U = \Spec(A)$ be an affine scheme over $S$.
Set $F = F_{\mathcal{F}, A}$. By definition, the functor
$F$ is adequate if and only if there exists a map of $A$-modules
$M \to N$ such that $F = \Ker(\underline{M} \to \underline{N})$.
Combining with
Lemmas \ref{lemma-adequate-local} and
\ref{lemma-adequate-affine}
we see that (1) and (5) are equivalent.

\medskip\noindent
It is clear that (5) implies (2) and (2) implies (3).
If (3) holds then we can refine the covering
$\{S_i \to S\}$ such that each $S_i = \Spec(A_i)$ is affine.
Then we see, by the preliminary remarks of the proof, that
$F_{\mathcal{F}, A_i}$ is adequate. Thus $\mathcal{F}$
is adequate by definition. Hence (3) implies (1).

\medskip\noindent
Finally, (4) is equivalent to (1) using
Lemma \ref{lemma-pullback-adequate}
for one direction and that
a composition of $\tau$-coverings is a $\tau$-covering for the other.
\end{proof}

\noindent
Just like is true for quasi-coherent sheaves the category of
adequate modules is independent of the topology.

\begin{lemma}
\label{lemma-adequate-fpqc}
Let $\mathcal{F}$ be an adequate $\mathcal{O}$-module on
$(\Sch/S)_\tau$. For any surjective flat morphism
$\Spec(B) \to \Spec(A)$ of affines over $S$
the extended {\v C}ech complex
$$
0 \to \mathcal{F}(\Spec(A)) \to
\mathcal{F}(\Spec(B)) \to
\mathcal{F}(\Spec(B \otimes_A B)) \to \ldots
$$
is exact. In particular $\mathcal{F}$ satisfies the sheaf condition
for fpqc coverings, and is a sheaf of $\mathcal{O}$-modules
on $(\Sch/S)_{fppf}$.
\end{lemma}

\begin{proof}
With $A \to B$ as in the lemma let $F = F_{\mathcal{F}, A}$. This functor
is adequate by
Lemma \ref{lemma-adequate-local}.
By
Lemma \ref{lemma-adequate-flat}
since $A \to B$, $A \to B \otimes_A B$, etc are flat we see that
$F(B) = F(A) \otimes_A B$,
$F(B \otimes_A B) = F(A) \otimes_A B \otimes_A B$, etc.
Exactness follows from
Descent, Lemma \ref{descent-lemma-ff-exact}.

\medskip\noindent
Thus $\mathcal{F}$ satisfies the sheaf condition for
$\tau$-coverings (in particular Zariski coverings) and any faithfully
flat covering of an affine by an affine. Arguing as in the proofs of
Descent, Lemma \ref{descent-lemma-standard-fpqc-covering}
and
Descent, Proposition \ref{descent-proposition-fpqc-descent-quasi-coherent}
we conclude that $\mathcal{F}$ satisfies the sheaf condition for all
fpqc coverings (made out of objects of $(\Sch/S)_\tau$).
Details omitted.
\end{proof}

\noindent
Lemma \ref{lemma-adequate-fpqc} shows in particular that
for any pair of topologies $\tau, \tau'$ the collection
of adequate modules for the $\tau$-topology and the $\tau'$-topology
are identical (as presheaves of modules on the underlying category $\Sch/S$).

\begin{definition}
\label{definition-category-adequate-modules}
Let $S$ be a scheme. The category of adequate $\mathcal{O}$-modules on
$(\Sch/S)_\tau$ is denoted {\it $\textit{Adeq}(\mathcal{O})$} or
{\it $\textit{Adeq}((\Sch/S)_\tau, \mathcal{O})$}. If we want to think just
about the abelian category of adequate modules without choosing a
topology we simply write {\it $\textit{Adeq}(S)$}.
\end{definition}

\begin{lemma}
\label{lemma-same-cohomology-adequate}
Let $S$ be a scheme. Let $\mathcal{F}$ be an adequate
$\mathcal{O}$-module on $(\Sch/S)_\tau$.
\begin{enumerate}
\item The restriction $\mathcal{F}|_{S_{Zar}}$ is a quasi-coherent
$\mathcal{O}_S$-module on the scheme $S$.
\item The restriction $\mathcal{F}|_{S_\etale}$ is the
quasi-coherent module associated to $\mathcal{F}|_{S_{Zar}}$.
\item For any affine scheme $U$ over $S$ we have $H^q(U, \mathcal{F}) = 0$
for all $q > 0$.
\item There is a canonical isomorphism
$$
H^q(S, \mathcal{F}|_{S_{Zar}}) =
H^q((\Sch/S)_\tau, \mathcal{F}).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-adequate-flat}
and
Lemma \ref{lemma-adequate-local}
we see that for any flat morphism of affines $U \to V$ over $S$
we have
$\mathcal{F}(U) = \mathcal{F}(V) \otimes_{\mathcal{O}(V)} \mathcal{O}(U)$.
This works in particular if $U \subset V \subset S$ are affine opens of
$S$, hence $\mathcal{F}|_{S_{Zar}}$ is quasi-coherent.
Thus (1) holds.

\medskip\noindent
Let $S' \to S$ be an \'etale morphism of schemes.
Then for $U \subset S'$ affine open mapping into an affine open
$V \subset S$ we see that
$\mathcal{F}(U) = \mathcal{F}(V) \otimes_{\mathcal{O}(V)} \mathcal{O}(U)$
because $U \to V$ is \'etale, hence flat. Therefore
$\mathcal{F}|_{S'_{Zar}}$ is the pullback of $\mathcal{F}|_{S_{Zar}}$.
This proves (2).

\medskip\noindent
We are going to apply
Cohomology on Sites,
Lemma \ref{sites-cohomology-lemma-cech-vanish-collection}
to the site $(\Sch/S)_\tau$ with
$\mathcal{B}$ the set of affine schemes over $S$ and
$\text{Cov}$ the set of standard affine $\tau$-coverings.
Assumption (3) of the lemma is satisfied by
Descent, Lemma \ref{descent-lemma-standard-covering-Cech}
and
Lemma \ref{lemma-adequate-fpqc}
for the case of a covering by a single affine.
Hence we conclude that $H^p(U, \mathcal{F}) = 0$ for every
affine scheme $U$ over $S$. This proves (3).
In exactly the same way as in the proof of
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
this implies the equality of cohomologies (4).
\end{proof}

\begin{remark}
\label{remark-compare}
Let $S$ be a scheme. We have functors
$u : \QCoh(\mathcal{O}_S) \to \textit{Adeq}(\mathcal{O})$
and
$v : \textit{Adeq}(\mathcal{O}) \to \QCoh(\mathcal{O}_S)$.
Namely, the functor $u : \mathcal{F} \mapsto \mathcal{F}^a$
comes from taking the associated $\mathcal{O}$-module which is
adequate by
Lemma \ref{lemma-adequate-characterize}.
Conversely, the functor $v$ comes from restriction
$v : \mathcal{G} \mapsto \mathcal{G}|_{S_{Zar}}$, see
Lemma \ref{lemma-same-cohomology-adequate}.
Since $\mathcal{F}^a$ can be described as the pullback of
$\mathcal{F}$ under a morphism of ringed topoi
$((\Sch/S)_\tau, \mathcal{O}) \to (S_{Zar}, \mathcal{O}_S)$, see
Descent, Remark \ref{descent-remark-change-topologies-ringed-sites}
and since restriction is the pushforward we see that $u$ and $v$
are adjoint as follows
$$
\SheafHom_{\mathcal{O}_S}(\mathcal{F}, v\mathcal{G})
=
\SheafHom_\mathcal{O}(u\mathcal{F}, \mathcal{G})
$$
where $\mathcal{O}$ denotes the structure sheaf on the big site.
It is immediate from the description that the adjunction mapping
$\mathcal{F} \to vu\mathcal{F}$ is an isomorphism for all quasi-coherent
sheaves.
\end{remark}

\begin{lemma}
\label{lemma-sheafification-adequate}
Let $S$ be a scheme. Let $\mathcal{F}$ be a presheaf of $\mathcal{O}$-modules
on $(\Sch/S)_\tau$. If for every affine scheme
$\Spec(A)$ over $S$ the functor $F_{\mathcal{F}, A}$ is
adequate, then the sheafification of $\mathcal{F}$ is an adequate
$\mathcal{O}$-module.
\end{lemma}

\begin{proof}
Let $U = \Spec(A)$ be an affine scheme over $S$.
Set $F = F_{\mathcal{F}, A}$.
The sheafification $\mathcal{F}^\# = (\mathcal{F}^+)^+$, see
Sites, Section \ref{sites-section-sheafification}.
By construction
$$
(\mathcal{F})^+(U) =
\colim_\mathcal{U} \check{H}^0(\mathcal{U}, \mathcal{F})
$$
where the colimit is over coverings in the site $(\Sch/S)_\tau$.
Since $U$ is affine it suffices to take the limit over standard
affine $\tau$-coverings
$\mathcal{U} = \{U_i \to U\}_{i \in I} =
\{\Spec(A_i) \to \Spec(A)\}_{i \in I}$ of $U$.
Since each $A \to A_i$ and $A \to A_i \otimes_A A_j$ is flat we see that
$$
\check{H}^0(\mathcal{U}, \mathcal{F}) =
\Ker(\prod F(A) \otimes_A A_i \to \prod F(A) \otimes_A A_i \otimes_A A_j)
$$
by
Lemma \ref{lemma-adequate-flat}.
Since $A \to \prod A_i$ is faithfully flat we see that this always
is canonically isomorphic to $F(A)$ by
Descent, Lemma \ref{descent-lemma-ff-exact}.
Thus the presheaf $(\mathcal{F})^+$ has the same value as
$\mathcal{F}$ on all affine schemes over $S$. Repeating the argument
once more we deduce the same thing for $\mathcal{F}^\# = ((\mathcal{F})^+)^+$.
Thus $F_{\mathcal{F}, A} = F_{\mathcal{F}^\#, A}$ and we conclude
that $\mathcal{F}^\#$ is adequate.
\end{proof}

\begin{lemma}
\label{lemma-abelian-adequate}
Let $S$ be a scheme.
\begin{enumerate}
\item The category $\textit{Adeq}(\mathcal{O})$ is abelian.
\item The functor
$\textit{Adeq}(\mathcal{O}) \to
\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$
is exact.
\item If $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
is a short exact sequence of $\mathcal{O}$-modules and
$\mathcal{F}_1$ and $\mathcal{F}_3$ are adequate, then
$\mathcal{F}_2$ is adequate.
\item The category $\textit{Adeq}(\mathcal{O})$ has colimits and
$\textit{Adeq}(\mathcal{O}) \to
\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$
commutes with them.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a map of adequate
$\mathcal{O}$-modules. To prove (1) and (2) it suffices to show that
$\mathcal{K} = \Ker(\varphi)$ and
$\mathcal{Q} = \Coker(\varphi)$ computed in
$\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$ are adequate.
Let $U = \Spec(A)$ be an affine scheme over $S$.
Let $F = F_{\mathcal{F}, A}$ and $G = F_{\mathcal{G}, A}$.
By
Lemmas \ref{lemma-kernel-adequate} and
\ref{lemma-cokernel-adequate}
the kernel $K$ and cokernel $Q$ of the induced map
$F \to G$ are adequate functors.
Because the kernel is computed on the level of presheaves, we see
that $K = F_{\mathcal{K}, A}$ and we conclude $\mathcal{K}$ is adequate.
To prove the result for the cokernel, denote $\mathcal{Q}'$ the presheaf
cokernel of $\varphi$. Then $Q = F_{\mathcal{Q}', A}$ and
$\mathcal{Q} = (\mathcal{Q}')^\#$. Hence $\mathcal{Q}$
is adequate by
Lemma \ref{lemma-sheafification-adequate}.

\medskip\noindent
Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
is a short exact sequence of $\mathcal{O}$-modules and
$\mathcal{F}_1$ and $\mathcal{F}_3$ are adequate.
Let $U = \Spec(A)$ be an affine scheme over $S$.
Let $F_i = F_{\mathcal{F}_i, A}$. The sequence of functors
$$
0 \to F_1 \to F_2 \to F_3 \to 0
$$
is exact, because for $V = \Spec(B)$ affine over $U$ we have
$H^1(V, \mathcal{F}_1) = 0$ by
Lemma \ref{lemma-same-cohomology-adequate}.
Since $F_1$ and $F_3$ are adequate functors by
Lemma \ref{lemma-adequate-local}
we see that $F_2$ is adequate by
Lemma \ref{lemma-extension-adequate}.
Thus $\mathcal{F}_2$ is adequate.

\medskip\noindent
Let $\mathcal{I} \to \textit{Adeq}(\mathcal{O})$, $i \mapsto \mathcal{F}_i$
be a diagram. Denote $\mathcal{F} = \colim_i \mathcal{F}_i$
the colimit computed in
$\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$.
To prove (4) it suffices to show that $\mathcal{F}$ is adequate.
Let $\mathcal{F}' = \colim_i \mathcal{F}_i$ be the colimit computed
in presheaves of $\mathcal{O}$-modules. Then
$\mathcal{F} = (\mathcal{F}')^\#$.
Let $U = \Spec(A)$ be an affine scheme over $S$.
Let $F_i = F_{\mathcal{F}_i, A}$. By
Lemma \ref{lemma-colimit-adequate}
the functor $\colim_i F_i = F_{\mathcal{F}', A}$ is adequate.
Lemma \ref{lemma-sheafification-adequate}
shows that $\mathcal{F}$ is adequate.
\end{proof}

\noindent
The following lemma tells us that the total direct image
$Rf_*\mathcal{F}$ of an adequate module under a quasi-compact and
quasi-separated morphism is a complex whose cohomology sheaves
are adequate.

\begin{lemma}
\label{lemma-direct-image-adequate}
Let $f : T \to S$ be a quasi-compact and quasi-separated morphism
of schemes. For any adequate $\mathcal{O}_T$-module on
$(\Sch/T)_\tau$ the pushforward
$f_*\mathcal{F}$ and the higher direct images $R^if_*\mathcal{F}$
are adequate $\mathcal{O}_S$-modules on $(\Sch/S)_\tau$.
\end{lemma}

\begin{proof}
First we explain how to compute the higher direct images.
Choose an injective resolution $\mathcal{F} \to \mathcal{I}^\bullet$.
Then $R^if_*\mathcal{F}$ is the $i$th cohomology sheaf of the
complex $f_*\mathcal{I}^\bullet$.
Hence $R^if_*\mathcal{F}$ is the sheaf associated to the presheaf
which associates to an object $U/S$ of $(\Sch/S)_\tau$
the module
\begin{align*}
\frac{\Ker(f_*\mathcal{I}^i(U) \to f_*\mathcal{I}^{i + 1}(U))}
{\Im(f_*\mathcal{I}^{i - 1}(U) \to f_*\mathcal{I}^i(U))}
& =
\frac{\Ker(\mathcal{I}^i(U \times_S T) \to
\mathcal{I}^{i + 1}(U \times_S T))}
{\Im(\mathcal{I}^{i - 1}(U \times_S T) \to \mathcal{I}^i(U \times_S T))}
\\
& =
H^i(U \times_S T, \mathcal{F}) \\
& = H^i((\Sch/U \times_S T)_\tau,
\mathcal{F}|_{(\Sch/U \times_S T)_\tau}) \\
& = H^i(U \times_S T, \mathcal{F}|_{(U \times_S T)_{Zar}})
\end{align*}
The first equality by
Topologies, Lemma \ref{topologies-lemma-morphism-big-fppf}
(and its analogues for other topologies),
the second equality by definition of cohomology of $\mathcal{F}$
over an object of $(\Sch/T)_\tau$,
the third equality by
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-cohomology-of-open},
and the last equality by
Lemma \ref{lemma-same-cohomology-adequate}.
Thus by
Lemma \ref{lemma-sheafification-adequate}
it suffices to prove the claim stated in the following paragraph.

\medskip\noindent
Let $A$ be a ring. Let $T$ be a scheme quasi-compact and quasi-separated
over $A$. Let $\mathcal{F}$ be an adequate $\mathcal{O}_T$-module on
$(\Sch/T)_\tau$. For an $A$-algebra $B$ set
$T_B = T \times_{\Spec(A)} \Spec(B)$ and denote
$\mathcal{F}_B = \mathcal{F}|_{(T_B)_{Zar}}$ the restriction of
$\mathcal{F}$ to the small Zariski site of $T_B$.
(Recall that this is a ``usual'' quasi-coherent sheaf on the scheme
$T_B$, see
Lemma \ref{lemma-same-cohomology-adequate}.)
Claim: The functor
$$
B \longmapsto H^q(T_B, \mathcal{F}_B)
$$
is adequate. We will prove the lemma by the usual
procedure of cutting $T$ into pieces.

\medskip\noindent
Case I: $T$ is affine. In this case the schemes $T_B$ are all affine
and $H^q(T_B, \mathcal{F}_B) = 0$ for all $q \geq 1$.
The functor $B \mapsto H^0(T_B, \mathcal{F}_B)$ is adequate by
Lemma \ref{lemma-pushforward-adequate}.

\medskip\noindent
Case II: $T$ is separated. Let $n$ be the minimal number of affines needed
to cover $T$. We argue by induction on $n$. The base case is Case I.
Choose an affine open covering $T = V_1 \cup \ldots \cup V_n$.
Set $V = V_1 \cup \ldots \cup V_{n - 1}$ and $U = V_n$. Observe that
$$
U \cap V = (V_1 \cap V_n) \cup \ldots \cup (V_{n - 1} \cap V_n)
$$
is also a union of $n - 1$ affine opens as $T$ is separated, see
Schemes, Lemma \ref{schemes-lemma-characterize-separated}.
Note that for each $B$ the base changes $U_B$, $V_B$ and
$(U \cap V)_B = U_B \cap V_B$ behave in the same way. Hence we see that
for each $B$ we have a long exact sequence
$$
0 \to
H^0(T_B, \mathcal{F}_B) \to
H^0(U_B, \mathcal{F}_B) \oplus H^0(V_B, \mathcal{F}_B) \to
H^0((U \cap V)_B, \mathcal{F}_B) \to
H^1(T_B, \mathcal{F}_B) \to \ldots
$$
functorial in $B$, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris}.
By induction hypothesis the functors
$B \mapsto H^q(U_B, \mathcal{F}_B)$,
$B \mapsto H^q(V_B, \mathcal{F}_B)$, and
$B \mapsto H^q((U \cap V)_B, \mathcal{F}_B)$
are adequate. Using
Lemmas \ref{lemma-kernel-adequate} and
\ref{lemma-cokernel-adequate}
we see that our functor $B \mapsto H^q(T_B, \mathcal{F}_B)$ sits in the
middle of a short exact sequence whose outer terms are adequate.
Thus the claim follows from
Lemma \ref{lemma-extension-adequate}.

\medskip\noindent
Case III: General quasi-compact and quasi-separated case.
The proof is again by induction on the number $n$ of affines needed to
cover $T$. The base case $n = 1$ is Case I.
Choose an affine open covering $T = V_1 \cup \ldots \cup V_n$.
Set $V = V_1 \cup \ldots \cup V_{n - 1}$ and $U = V_n$. Note that
since $T$ is quasi-separated $U \cap V$ is a quasi-compact open of an
affine scheme, hence Case II applies to it. The rest of the argument
proceeds in exactly the same manner as in the paragraph above and is
omitted.
\end{proof}







\section{Parasitic adequate modules}
\label{section-parasitic}

\noindent
In this section we start comparing adequate modules and quasi-coherent
modules on a scheme $S$. Recall that there are functors
$u : \QCoh(\mathcal{O}_S) \to \textit{Adeq}(\mathcal{O})$
and
$v : \textit{Adeq}(\mathcal{O}) \to \QCoh(\mathcal{O}_S)$
satisfying the adjunction
$$
\SheafHom_{\QCoh(\mathcal{O}_S)}(\mathcal{F}, v\mathcal{G})
=
\SheafHom_{\textit{Adeq}(\mathcal{O})}(u\mathcal{F}, \mathcal{G})
$$
and such that $\mathcal{F} \to vu\mathcal{F}$ is an isomorphism for
every quasi-coherent sheaf $\mathcal{F}$, see
Remark \ref{remark-compare}.
Hence $u$ is a fully faithful embedding and we can identify
$\QCoh(\mathcal{O}_S)$ with a full subcategory of
$\textit{Adeq}(\mathcal{O})$.
The functor $v$ is exact but $u$ is not left exact in general.
The kernel of $v$ is the subcategory of parasitic adequate modules.

\medskip\noindent
In Descent, Definition \ref{descent-definition-parasitic}
we give the definition of a parasitic module.
For adequate modules the notion does not depend
on the chosen topology.

\begin{lemma}
\label{lemma-parasitic-adequate}
Let $S$ be a scheme.
Let $\mathcal{F}$ be an adequate $\mathcal{O}$-module on
$(\Sch/S)_\tau$. The following are equivalent:
\begin{enumerate}
\item $v\mathcal{F} = 0$,
\item $\mathcal{F}$ is parasitic,
\item $\mathcal{F}$ is parasitic for the $\tau$-topology,
\item $\mathcal{F}(U) = 0$ for all $U \subset S$ open, and
\item there exists an affine open covering $S = \bigcup U_i$
such that $\mathcal{F}(U_i) = 0$ for all $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (2) $\Rightarrow$ (3) $\Rightarrow$ (4) $\Rightarrow$ (5)
are immediate from the definitions. Assume (5). Suppose that
$S = \bigcup U_i$ is an affine open covering such that $\mathcal{F}(U_i) = 0$
for all $i$. Let $V \to S$ be a flat morphism. There exists an affine
open covering $V = \bigcup V_j$ such that each $V_j$ maps into some
$U_i$. As the morphism $V_j \to S$ is flat, also $V_j \to U_i$ is flat. 
Hence the corresponding ring map
$A_i = \mathcal{O}(U_i) \to \mathcal{O}(V_j) = B_j$ is flat. Thus by
Lemma \ref{lemma-adequate-local}
and
Lemma \ref{lemma-adequate-flat}
we see that $\mathcal{F}(U_i) \otimes_{A_i} B_j \to \mathcal{F}(V_j)$
is an isomorphism. Hence $\mathcal{F}(V_j) = 0$. Since $\mathcal{F}$ is
a sheaf for the Zariski topology we conclude that $\mathcal{F}(V) = 0$.
In this way we see that (5) implies (2).

\medskip\noindent
This proves the equivalence of (2), (3), (4), and (5).
As (1) is equivalent to (3) (see
Remark \ref{remark-compare})
we conclude that all five conditions are equivalent.
\end{proof}

\noindent
Let $S$ be a scheme.
The subcategory of parasitic adequate modules is a Serre subcategory of
$\textit{Adeq}(\mathcal{O})$. The quotient is the category of
quasi-coherent modules.

\begin{lemma}
\label{lemma-adequate-by-parasitic}
Let $S$ be a scheme. The subcategory
$\mathcal{C} \subset \textit{Adeq}(\mathcal{O})$ of parasitic adequate
modules is a Serre subcategory. Moreover, the functor $v$ induces
an equivalence of categories
$$
\textit{Adeq}(\mathcal{O}) / \mathcal{C} = \QCoh(\mathcal{O}_S).
$$
\end{lemma}

\begin{proof}
The category $\mathcal{C}$ is the kernel of the exact functor
$v : \textit{Adeq}(\mathcal{O}) \to \QCoh(\mathcal{O}_S)$, see
Lemma \ref{lemma-parasitic-adequate}.
Hence it is a Serre subcategory by
Homology, Lemma \ref{homology-lemma-kernel-exact-functor}.
By
Homology, Lemma \ref{homology-lemma-serre-subcategory-is-kernel}
we obtain an induced exact functor
$\overline{v} :
\textit{Adeq}(\mathcal{O}) / \mathcal{C}
\to
\QCoh(\mathcal{O}_S)$.
Because $u$ is a right inverse to $v$ we see right away that
$\overline{v}$ is essentially surjective.
We see that $\overline{v}$ is faithful by
Homology, Lemma \ref{homology-lemma-quotient-by-kernel-exact-functor}.
Because $u$ is a right inverse to $v$ we finally conclude that
$\overline{v}$ is fully faithful.
\end{proof}

\begin{lemma}
\label{lemma-direct-image-parasitic-adequate}
Let $f : T \to S$ be a quasi-compact and quasi-separated morphism
of schemes. For any parasitic adequate $\mathcal{O}_T$-module on
$(\Sch/T)_\tau$ the pushforward
$f_*\mathcal{F}$ and the higher direct images $R^if_*\mathcal{F}$
are parasitic adequate $\mathcal{O}_S$-modules on $(\Sch/S)_\tau$.
\end{lemma}

\begin{proof}
We have already seen in
Lemma \ref{lemma-direct-image-adequate}
that these higher direct images are adequate.
Hence it suffices to show that
$(R^if_*\mathcal{F})(U_i) = 0$ for any $\tau$-covering
$\{U_i \to S\}$ open. And $R^if_*\mathcal{F}$
is parasitic by
Descent, Lemma \ref{descent-lemma-direct-image-parasitic}.
\end{proof}














\section{Derived categories of adequate modules, I}
\label{section-comparison}


\noindent
Let $S$ be a scheme. We continue the discussion started in
Section \ref{section-parasitic}.
The exact functor $v$ induces a functor
$$
D(\textit{Adeq}(\mathcal{O}))
\longrightarrow
D(\QCoh(\mathcal{O}_S))
$$
and similarly for bounded versions.

\begin{lemma}
\label{lemma-quotient-easy}
Let $S$ be a scheme. Let
$\mathcal{C} \subset \textit{Adeq}(\mathcal{O})$ denote the
full subcategory consisting of parasitic adequate modules.
Then
$$
D(\textit{Adeq}(\mathcal{O}))/D_\mathcal{C}(\textit{Adeq}(\mathcal{O}))
= D(\QCoh(\mathcal{O}_S))
$$
and similarly for the bounded versions.
\end{lemma}

\begin{proof}
Follows immediately from
Derived Categories, Lemma \ref{derived-lemma-quotient-by-serre-easy}.
\end{proof}

\noindent
Next, we look for a description the other way around by looking at
the functors
$$
K^+(\QCoh(\mathcal{O}_S))
\longrightarrow
K^+(\textit{Adeq}(\mathcal{O}))
\longrightarrow
D^+(\textit{Adeq}(\mathcal{O}))
\longrightarrow
D^+(\QCoh(\mathcal{O}_S)).
$$
In some cases the derived category of adequate modules is a localization
of the homotopy category of complexes of quasi-coherent modules at
universal quasi-isomorphisms. Let $S$ be a scheme. A map of complexes
$\varphi : \mathcal{F}^\bullet \to \mathcal{G}^\bullet$
of quasi-coherent $\mathcal{O}_S$-modules is said to be a
{\it universal quasi-isomorphism} if for every morphism of schemes
$f : T \to S$ the pullback $f^*\varphi$ is a quasi-isomorphism.

\begin{lemma}
\label{lemma-describe-Dplus-adequate}
Let $U = \Spec(A)$ be an affine scheme.
The bounded below derived category
$D^+(\textit{Adeq}(\mathcal{O}))$ is the localization
of $K^+(\QCoh(\mathcal{O}_U))$ at the multiplicative subset of
universal quasi-isomorphisms.
\end{lemma}

\begin{proof}
If $\varphi : \mathcal{F}^\bullet \to \mathcal{G}^\bullet$
is a morphism of complexes of quasi-coherent
$\mathcal{O}_U$-modules, then $u\varphi : u\mathcal{F}^\bullet \to
u\mathcal{G}^\bullet$ is a quasi-isomorphism if and only if $\varphi$ is
a universal quasi-isomorphism. Hence the collection $S$
of universal quasi-isomorphisms is a saturated multiplicative
system compatible with the triangulated structure by
Derived Categories, Lemma \ref{derived-lemma-triangle-functor-localize}.
Hence $S^{-1}K^+(\QCoh(\mathcal{O}_U))$ exists and is a
triangulated category, see
Derived Categories, Proposition
\ref{derived-proposition-construct-localization}.
We obtain a canonical functor
$can : S^{-1}K^+(\QCoh(\mathcal{O}_U)) \to
D^{+}(\textit{Adeq}(\mathcal{O}))$ by
Derived Categories, Lemma \ref{derived-lemma-universal-property-localization}.

\medskip\noindent
Note that, almost by definition, every adequate module on $U$ has an
embedding into a quasi-coherent sheaf, see
Lemma \ref{lemma-adequate-characterize}. Hence by
Derived Categories, Lemma \ref{derived-lemma-subcategory-right-resolution}
given $\mathcal{F}^\bullet \in \Ob(K^+(\textit{Adeq}(\mathcal{O})))$
there exists a quasi-isomorphism
$\mathcal{F}^\bullet \to u\mathcal{G}^\bullet$
where $\mathcal{G}^\bullet \in \Ob(K^+(\QCoh(\mathcal{O}_U)))$.
This proves that $can$ is essentially surjective.

\medskip\noindent
Similarly, suppose that $\mathcal{F}^\bullet$ and $\mathcal{G}^\bullet$
are bounded below complexes of quasi-coherent $\mathcal{O}_U$-modules.
A morphism in $D^+(\textit{Adeq}(\mathcal{O}))$ between these
consists of a pair $f : u\mathcal{F}^\bullet \to \mathcal{H}^\bullet$
and $s : u\mathcal{G}^\bullet \to \mathcal{H}^\bullet$ where $s$
is a quasi-isomorphism. Pick a quasi-isomorphism
$s' : \mathcal{H}^\bullet \to u\mathcal{E}^\bullet$. Then we see that
$s' \circ f : \mathcal{F} \to \mathcal{E}^\bullet$ and the
universal quasi-isomorphism
$s' \circ s : \mathcal{G}^\bullet \to \mathcal{E}^\bullet$ give
a morphism in $S^{-1}K^{+}(\QCoh(\mathcal{O}_U))$ mapping
to the given morphism. This proves the "fully" part of full faithfulness.
Faithfulness is proved similarly.
\end{proof}

\begin{lemma}
\label{lemma-right-adjoint-adequate}
Let $U = \Spec(A)$ be an affine scheme.
The inclusion functor
$$
\textit{Adeq}(\mathcal{O}) \to
\textit{Mod}((\Sch/U)_\tau, \mathcal{O})
$$
has a right adjoint $A$\footnote{This is the ``adequator''.}.
Moreover, the adjunction mapping
$A(\mathcal{F}) \to \mathcal{F}$ is an isomorphism for every
adequate module $\mathcal{F}$.
\end{lemma}

\begin{proof}
By
Topologies, Lemma \ref{topologies-lemma-affine-big-site-fppf}
(and similarly for the other topologies)
we may work with $\mathcal{O}$-modules on $(\textit{Aff}/U)_\tau$.
Denote $\mathcal{P}$ the category of module-valued
functors on $\textit{Alg}_A$ and $\mathcal{A}$ the category of adequate
functors on $\textit{Alg}_A$. Denote $i : \mathcal{A} \to \mathcal{P}$
the inclusion functor. Denote $Q : \mathcal{P} \to \mathcal{A}$
the construction of Lemma \ref{lemma-adjoint}.
We have the commutative diagram
\begin{equation}
\label{equation-categories}
\vcenter{
\xymatrix{
\textit{Adeq}(\mathcal{O}) \ar[r]_-k \ar@{=}[d] &
\textit{Mod}((\textit{Aff}/U)_\tau, \mathcal{O}) \ar[r]_-j &
\textit{PMod}((\textit{Aff}/U)_\tau, \mathcal{O}) \ar@{=}[d] \\
\mathcal{A} \ar[rr]^-i & & \mathcal{P}
}
}
\end{equation}
The left vertical equality is
Lemma \ref{lemma-adequate-affine}
and the right vertical equality was explained in
Section \ref{section-quasi-coherent}.
Define $A(\mathcal{F}) = Q(j(\mathcal{F}))$.
Since $j$ is fully faithful it follows immediately that $A$
is a right adjoint of the inclusion functor $k$. Also, since
$k$ is fully faithful too, the final assertion follows formally.
\end{proof}

\noindent
The functor $A$ is a right adjoint hence left exact. Since the inclusion
functor is exact, see
Lemma \ref{lemma-abelian-adequate}
we conclude that $A$ transforms injectives into injectives, and that
the category $\textit{Adeq}(\mathcal{O})$ has enough injectives, see
Homology, Lemma \ref{homology-lemma-adjoint-enough-injectives}
and
Injectives, Theorem \ref{injectives-theorem-sheaves-modules-injectives}.
This also follows from the equivalence in
(\ref{equation-categories})
and
Lemma \ref{lemma-enough-injectives}.

\begin{lemma}
\label{lemma-RA-zero}
Let $U = \Spec(A)$ be an affine scheme.
For any object $\mathcal{F}$ of $\textit{Adeq}(\mathcal{O})$
we have $R^pA(\mathcal{F}) = 0$ for all $p > 0$ where $A$ is
as in
Lemma \ref{lemma-right-adjoint-adequate}.
\end{lemma}

\begin{proof}
With notation as in the proof of
Lemma \ref{lemma-right-adjoint-adequate}
choose an injective resolution $k(\mathcal{F}) \to \mathcal{I}^\bullet$
in the category of $\mathcal{O}$-modules on $(\textit{Aff}/U)_\tau$.
By
Cohomology on Sites, Lemmas \ref{sites-cohomology-lemma-include-modules}
and
Lemma \ref{lemma-same-cohomology-adequate}
the complex $j(\mathcal{I}^\bullet)$ is exact.
On the other hand, each $j(\mathcal{I}^n)$ is an injective object
of the category of presheaves of modules by
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-injective-module-injective-presheaf}.
It follows that $R^pA(\mathcal{F}) = R^pQ(j(k(\mathcal{F})))$.
Hence the result now follows from
Lemma \ref{lemma-RQ-zero}.
\end{proof}

\noindent
Let $S$ be a scheme. By the discussion in
Section \ref{section-adequate}
the embedding
$\textit{Adeq}(\mathcal{O}) \subset
\textit{Mod}((\Sch/S)_\tau, \mathcal{O})$
exhibits $\textit{Adeq}(\mathcal{O})$ as a weak Serre subcategory of
the category of all $\mathcal{O}$-modules. Denote
$$
D_{\textit{Adeq}}(\mathcal{O}) \subset
D(\mathcal{O}) = D(\textit{Mod}((\Sch/S)_\tau, \mathcal{O}))
$$
the triangulated subcategory of complexes whose cohomology sheaves
are adequate, see
Derived Categories, Section \ref{derived-section-triangulated-sub}.
We obtain a canonical functor
$$
D(\textit{Adeq}(\mathcal{O}))
\longrightarrow
D_{\textit{Adeq}}(\mathcal{O})
$$
see
Derived Categories, Equation (\ref{derived-equation-compare}).

\begin{lemma}
\label{lemma-bounded-below}
If $U = \Spec(A)$ is an affine scheme, then the bounded
below version
\begin{equation}
\label{equation-compare-bounded-adequate}
D^+(\textit{Adeq}(\mathcal{O}))
\longrightarrow
D^+_{\textit{Adeq}}(\mathcal{O})
\end{equation}
of the functor above is an equivalence.
\end{lemma}

\begin{proof}
Let $A : \textit{Mod}(\mathcal{O}) \to \textit{Adeq}(\mathcal{O})$
be the right adjoint to the inclusion functor constructed in
Lemma \ref{lemma-right-adjoint-adequate}.
Since $A$ is left exact and since $\textit{Mod}(\mathcal{O})$
has enough injectives, $A$ has a right derived functor
$RA : D^+_{\textit{Adeq}}(\mathcal{O}) \to D^+(\textit{Adeq}(\mathcal{O}))$.
We claim that $RA$ is a quasi-inverse to
(\ref{equation-compare-bounded-adequate}).
To see this the key fact is that if $\mathcal{F}$ is an adequate module, then
the adjunction map $\mathcal{F} \to RA(\mathcal{F})$ is a
quasi-isomorphism by Lemma \ref{lemma-RA-zero}.

\medskip\noindent
Namely, to prove the lemma in full it suffices to show:
\begin{enumerate}
\item Given $\mathcal{F}^\bullet \in K^+(\textit{Adeq}(\mathcal{O}))$
the canonical map $\mathcal{F}^\bullet \to RA(\mathcal{F}^\bullet)$
is a quasi-isomorphism, and
\item given $\mathcal{G}^\bullet \in K^+(\textit{Mod}(\mathcal{O}))$
the canonical map $RA(\mathcal{G}^\bullet) \to \mathcal{G}^\bullet$
is a quasi-isomorphism.
\end{enumerate}
Both (1) and (2) follow from the key fact via a spectral sequence
argument using one of the spectral sequences of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-ext-adequate}
Let $U = \Spec(A)$ be an affine scheme.
Let $\mathcal{F}$ and $\mathcal{G}$ be adequate $\mathcal{O}$-modules.
For any $i \geq 0$ the natural map
$$
\text{Ext}^i_{\textit{Adeq}(\mathcal{O})}(\mathcal{F}, \mathcal{G})
\longrightarrow
\text{Ext}^i_{\textit{Mod}(\mathcal{O})}(\mathcal{F}, \mathcal{G})
$$
is an isomorphism.
\end{lemma}

\begin{proof}
By definition these ext groups are computed as hom sets in the
derived category. Hence this follows immediately from
Lemma \ref{lemma-bounded-below}.
\end{proof}









\section{Pure extensions}
\label{section-pure}

\noindent
We want to characterize extensions of quasi-coherent sheaves on
the big site of an affine schemes in terms of algebra. To do this
we introduce the following notion.

\begin{definition}
\label{definition-pure}
Let $A$ be a ring.
\begin{enumerate}
\item An $A$-module $P$ is said to be {\it pure projective}
if for every universally exact sequence
$0 \to K \to M \to N \to 0$ of $A$-module the sequence
$0 \to \Hom_A(P, K) \to \Hom_A(P, M) \to \Hom_A(P, N) \to 0$
is exact.
\item An $A$-module $I$ is said to be {\it pure injective}
if for every universally exact sequence
$0 \to K \to M \to N \to 0$ of $A$-module the sequence
$0 \to \Hom_A(N, I) \to \Hom_A(M, I) \to \Hom_A(K, I) \to 0$
is exact.
\end{enumerate}
\end{definition}

\noindent
Let's characterize pure projectives.

\begin{lemma}
\label{lemma-pure-projective}
Let $A$ be a ring.
\begin{enumerate}
\item A module is pure projective if and only if
it is a direct summand of a direct sum of finitely presented $A$-modules.
\item For any module $M$ there exists a universally exact sequence
$0 \to N \to P \to M \to 0$ with $P$ pure projective.
\end{enumerate}
\end{lemma}

\begin{proof}
First note that a finitely presented $A$-module is pure projective by
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
Hence a direct summand of a direct sum of finitely presented $A$-modules
is indeed pure projective. Let $M$ be any $A$-module.
Write $M = \colim_{i \in I} P_i$ as a filtered colimit of
finitely presented $A$-modules. Consider the sequence
$$
0 \to N \to \bigoplus P_i \to M \to 0.
$$
For any finitely presented $A$-module $P$ the map
$\Hom_A(P, \bigoplus P_i) \to \Hom_A(P, M)$
is surjective, as any map $P \to M$ factors through some $P_i$.
Hence by
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}
this sequence is universally exact. This proves (2).
If now $M$ is pure projective, then the sequence is split and
we see that $M$ is a direct summand of $\bigoplus P_i$.
\end{proof}

\noindent
Let's characterize pure injectives.

\begin{lemma}
\label{lemma-pure-injective}
Let $A$ be a ring. For any $A$-module $M$ set
$M^\wedge = \Hom_\mathbf{Z}(M, \mathbf{Q}/\mathbf{Z})$.
\begin{enumerate}
\item For any $A$-module $M$ the $A$-module $M^\wedge$ is pure injective.
\item An $A$-module $I$ is pure injective if and only if the map
$I \to (I^\wedge)^\wedge$ splits.
\item For any module $M$ there exists a universally exact sequence
$0 \to M \to I \to N \to 0$ with $I$ pure injective.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use the properties of the functor $M \mapsto M^\wedge$ found in
More on Algebra, Section \ref{more-algebra-section-injectives-modules}
without further mention. Part (1) holds because
$\Hom_A(N, M^\wedge) =
\Hom_\mathbf{Z}(N \otimes_A M, \mathbf{Q}/\mathbf{Z})$
and because $\mathbf{Q}/\mathbf{Z}$ is injective in the category of
abelian groups. Hence if $I \to (I^\wedge)^\wedge$ is split, then
$I$ is pure injective. We claim that for any $A$-module $M$ the
evaluation map $ev : M \to (M^\wedge)^\wedge$ is universally injective.
To see this note that $ev^\wedge : ((M^\wedge)^\wedge)^\wedge \to M^\wedge$
has a right inverse, namely $ev' : M^\wedge \to ((M^\wedge)^\wedge)^\wedge$.
Then for any $A$-module $N$ applying the exact faithful functor
${}^\wedge$ to the map $N \otimes_A M \to N \otimes_A (M^\wedge)^\wedge$
gives
$$
\Hom_A(N, ((M^\wedge)^\wedge)^\wedge) =
\Big(N \otimes_A (M^\wedge)^\wedge\Big)^\wedge
\to
\Big(N \otimes_A M\Big)^\wedge =
\Hom_A(N, M^\wedge)
$$
which is surjective by the existence of the right inverse. The claim follows.
The claim implies (3) and the necessity of the condition in (2).
\end{proof}

\noindent
Before we continue we make the following observation which we will
use frequently in the rest of this section.

\begin{lemma}
\label{lemma-split-universally-exact-sequence}
Let $A$ be a ring.
\begin{enumerate}
\item Let $L \to M \to N$ be a universally exact sequence
of $A$-modules. Let $K = \Im(M \to N)$.
Then $K \to N$ is universally injective.
\item Any universally exact complex
can be split into universally exact short exact sequences.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). For any $A$-module $T$ the sequence
$L \otimes_A T \to M \otimes_A T \to K \otimes_A T \to 0$ is exact
by right exactness of $\otimes$. By assumption the sequence
$L \otimes_A T \to M \otimes_A T \to N \otimes_A T$ is exact.
Combined this shows that $K \otimes_A T \to N \otimes_A T$ is injective.

\medskip\noindent
Part (2) means the following: Suppose that $M^\bullet$ is a universally
exact complex of $A$-modules. Set $K^i = \Ker(d^i) \subset M^i$.
Then the short exact sequences $0 \to K^i \to M^i \to K^{i + 1} \to 0$
are universally exact. This follows immediately from part (1).
\end{proof}

\begin{definition}
\label{definition-pure-resolution}
Let $A$ be a ring. Let $M$ be an $A$-module.
\begin{enumerate}
\item A {\it pure projective resolution} $P_\bullet \to M$
is a universally exact sequence
$$
\ldots \to P_1 \to P_0 \to M \to 0
$$
with each $P_i$ pure projective.
\item A {\it pure injective resolution} $M \to I^\bullet$ is a universally
exact sequence
$$
0 \to M \to I^0 \to I^1 \to \ldots
$$
with each $I^i$ pure injective.
\end{enumerate}
\end{definition}

\noindent
These resolutions satisfy the usual uniqueness properties among the class
of all universally exact left or right resolutions.

\begin{lemma}
\label{lemma-pure-projective-resolutions}
Let $A$ be a ring.
\begin{enumerate}
\item Any $A$-module has a pure projective resolution.
\end{enumerate}
Let $M \to N$ be a map of $A$-modules.
Let $P_\bullet \to M$ be a pure projective resolution and
let $N_\bullet \to N$ be a universally exact resolution.
\begin{enumerate}
\item[(2)] There exists a map of complexes $P_\bullet \to N_\bullet$
inducing the given map
$$
M = \Coker(P_1 \to P_0) \to \Coker(N_1 \to N_0) = N
$$
\item[(3)] two maps $\alpha, \beta : P_\bullet \to N_\bullet$
inducing the same map $M \to N$ are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows immediately from
Lemma \ref{lemma-pure-projective}.
Before we prove (2) and (3) note that by
Lemma \ref{lemma-split-universally-exact-sequence}
we can split the universally exact complex $N_\bullet \to N \to 0$
into universally exact short exact sequences $0 \to K_0 \to N_0 \to N \to 0$
and $0 \to K_i \to N_i \to K_{i - 1} \to 0$.

\medskip\noindent
Proof of (2). Because $P_0$ is pure projective
we can find a map $P_0 \to N_0$ lifting the map $P_0 \to M \to N$.
We obtain an induced map $P_1 \to F_0 \to N_0$ wich ends up in $K_0$.
Since $P_1$ is pure projective we may lift this
to a map $P_1 \to N_1$. This in turn induces a map
$P_2 \to P_1 \to N_1$ which maps to zero into
$N_0$, i.e., into $K_1$. Hence we may lift to get a map
$P_2 \to N_2$. Repeat.

\medskip\noindent
Proof of (3). To show that $\alpha, \beta$ are homotopic it suffices
to show the difference $\gamma = \alpha - \beta$ is homotopic
to zero. Note that the image of $\gamma_0 : P_0 \to N_0$
is contained in $K_0$. Hence we may lift
$\gamma_0$ to a map $h_0 : P_0 \to N_1$. Consider the map
$\gamma_1' = \gamma_1 - h_0 \circ d_{P, 1} : P_1 \to N_1$.
By our choice of $h_0$ we see that the image of $\gamma_1'$
is contained in $K_1$. Since $P_1$ is pure projective may lift
$\gamma_1'$ to a map $h_1 : P_1 \to N_2$. At this point we have
$\gamma_1 = h_0 \circ d_{F, 1} + d_{N, 2} \circ h_1$. Repeat.
\end{proof}

\begin{lemma}
\label{lemma-pure-injective-resolutions}
Let $A$ be a ring.
\begin{enumerate}
\item Any $A$-module has a pure injective resolution.
\end{enumerate}
Let $M \to N$ be a map of $A$-modules.
Let $M \to M^\bullet$ be a universally exact resolution and
let $N \to I^\bullet$ be a pure injective resolution.
\begin{enumerate}
\item[(2)] There exists a map of complexes $M^\bullet \to I^\bullet$
inducing the given map
$$
M = \Ker(M^0 \to M^1) \to \Ker(I^0 \to I^1) = N
$$
\item[(3)] two maps $\alpha, \beta : M^\bullet \to I^\bullet$
inducing the same map $M \to N$ are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
This lemma is dual to
Lemma \ref{lemma-pure-projective-resolutions}.
The proof is identical, except one has to reverse all the arrows.
\end{proof}

\noindent
Using the material above we can define pure extension groups as
follows. Let $A$ be a ring and let $M$, $N$ be $A$-modules.
Choose a pure injective resolution $N \to I^\bullet$. By
Lemma \ref{lemma-pure-injective-resolutions}
the complex
$$
\Hom_A(M, I^\bullet)
$$
is well defined up to homotopy. Hence its $i$th cohomology module
is a well defined invariant of $M$ and $N$.

\begin{definition}
\label{definition-pure-ext}
Let $A$ be a ring and let $M$, $N$ be $A$-modules.
The $i$th {\it pure extension module} $\text{Pext}^i_A(M, N)$
is the $i$th cohomology module of the complex
$\Hom_A(M, I^\bullet)$ where $I^\bullet$ is a pure injective
resolution of $N$.
\end{definition}

\noindent
Warning: It is not true that an exact sequence of $A$-modules gives
rise to a long exact sequence of pure extensions groups. (You need
a universally exact sequence for this.)
We collect some facts which are obvious from the material above.

\begin{lemma}
\label{lemma-facts-pext}
Let $A$ be a ring.
\begin{enumerate}
\item $\text{Pext}^i_A(M, N) = 0$ for $i > 0$ whenever $N$ is pure injective,
\item $\text{Pext}^i_A(M, N) = 0$ for $i > 0$ whenever $M$ is pure projective,
in particular if $M$ is an $A$-module of finite presentation,
\item $\text{Pext}^i_A(M, N)$ is also the $i$th cohomology module
of the complex $\Hom_A(P_\bullet, N)$ where $P_\bullet$
is a pure projective resolution of $M$.
\end{enumerate}
\end{lemma}

\begin{proof}
To see (3) consider the double complex
$$
A^{\bullet, \bullet} = \Hom_A(P_\bullet, I^\bullet)
$$
Each of its rows is exact except in degree $0$ where its cohomology
is $\Hom_A(M, I^q)$. Each of its columns is exact except in degree $0$
where its cohomology is $\Hom_A(P_p, N)$. Hence the two spectral
sequences associated to this complex in
Homology, Section \ref{homology-section-double-complex}
degenerate, giving the equality.
\end{proof}





\section{Higher exts of quasi-coherent sheaves on the big site}
\label{section-big}

\noindent
It turns out that the module-valued functor $\underline{I}$ associated to
a pure injective module $I$ gives rise to an injective object in the
category of adequate functors on $\textit{Alg}_A$.
Warning: It is not true that a pure projective module gives rise to
a projective object in the category of adequate functors. We do have
plenty of projective objects, namely, the linearly adequate functors.

\begin{lemma}
\label{lemma-pure-injective-injective-adequate}
Let $A$ be a ring.
Let $\mathcal{A}$ be the category of adequate functors on $\textit{Alg}_A$.
The injective objects of $\mathcal{A}$ are exactly the functors
$\underline{I}$ where $I$ is a pure injective $A$-module.
\end{lemma}

\begin{proof}
Let $I$ be an injective object of $\mathcal{A}$.
Choose an embedding $I \to \underline{M}$ for some $A$-module $M$.
As $I$ is injective we see that $\underline{M} = I \oplus F$ for some
module-valued functor $F$. Then $M = I(A) \oplus F(A)$ and it follows
that $I = \underline{I(A)}$. Thus we see that any injective object
is of the form $\underline{I}$ for some $A$-module $I$.
It is clear that the module $I$ has to be pure injective
since any universally exact sequence $0 \to M \to N \to L \to 0$
gives rise to an exact sequence
$0 \to \underline{M} \to \underline{N} \to \underline{L} \to 0$
of $\mathcal{A}$.

\medskip\noindent
Finally, suppose that $I$ is a pure injective
$A$-module. Choose an embedding $\underline{I} \to J$
into an injective object of $\mathcal{A}$ (see
Lemma \ref{lemma-enough-injectives}).
We have seen above that $J = \underline{I'}$
for some $A$-module $I'$ which is pure injective. As
$\underline{I} \to \underline{I'}$ is injective
the map $I \to I'$ is universally injective. By assumption on $I$
it splits. Hence $\underline{I}$ is a summand of $J = \underline{I'}$
whence an injective object of the category $\mathcal{A}$.
\end{proof}

\noindent
Let $U = \Spec(A)$ be an affine scheme. Let $M$ be an $A$-module.
We will use the notation $M^a$ to denote the quasi-coherent sheaf
of $\mathcal{O}$-modules on $(\Sch/U)_\tau$ associated to
the quasi-coherent sheaf $\widetilde{M}$ on $U$.
Now we have all the notation in place to formulate the following lemma.

\begin{lemma}
\label{lemma-big-ext}
Let $U = \Spec(A)$ be an affine scheme. Let $M$, $N$ be $A$-modules.
For all $i$ we have a canonical isomorphism
$$
\text{Ext}^i_{\textit{Mod}(\mathcal{O})}(M^a, N^a) = \text{Pext}^i_A(M, N)
$$
functorial in $M$ and $N$.
\end{lemma}

\begin{proof}
Let us construct a canonical arrow from right to left. Namely, if
$N \to I^\bullet$ is a pure injective resolution, then
$M^a \to (I^\bullet)^a$ is an exact complex of (adequate)
$\mathcal{O}$-modules. Hence any element of $\text{Pext}^i_A(M, N)$
gives rise to a map $N^a \to M^a[i]$ in $D(\mathcal{O})$, i.e.,
an element of the group on the left.

\medskip\noindent
To prove this map is an isomorphism, note that we may replace
$\text{Ext}^i_{\textit{Mod}(\mathcal{O})}(M^a, N^a)$ by
$\text{Ext}^i_{\textit{Adeq}(\mathcal{O})}(M^a, N^a)$, see
Lemma \ref{lemma-ext-adequate}.
Let $\mathcal{A}$ be the category of adequate functors
on $\textit{Alg}_A$. We have seen that $\mathcal{A}$ is
equivalent to $\textit{Adeq}(\mathcal{O})$, see
Lemma \ref{lemma-adequate-affine}; see also the proof of
Lemma \ref{lemma-right-adjoint-adequate}.
Hence now it suffices to prove that
$$
\text{Ext}^i_\mathcal{A}(\underline{M}, \underline{N}) =
\text{Pext}^i_A(M, N)
$$
However, this is clear from
Lemma \ref{lemma-pure-injective-injective-adequate}
as a pure injective resolution $N \to I^\bullet$ exactly corresponds
to an injective resolution of $\underline{N}$ in $\mathcal{A}$.
\end{proof}







\section{Derived categories of adequate modules, II}
\label{section-derived-categories}

\noindent
Let $S$ be a scheme. Denote $\mathcal{O}_S$ the structure sheaf of $S$
and $\mathcal{O}$ the structure sheaf of the big site $(\Sch/S)_\tau$.
In
Descent, Remark \ref{descent-remark-change-topologies-ringed}
we constructed a morphism of ringed sites
\begin{equation}
\label{equation-compare-big-small}
f :
((\Sch/S)_\tau, \mathcal{O})
\longrightarrow
(S_{Zar}, \mathcal{O}_S).
\end{equation}
In the previous sections have seen that the functor
$f_* : \textit{Mod}(\mathcal{O}) \to \textit{Mod}(\mathcal{O}_S)$
transforms adequate sheaves into quasi-coherent sheaves, and
induces an exact functor
$v : \textit{Adeq}(\mathcal{O}) \to \QCoh(\mathcal{O}_S)$, and
in fact that $f_* = v$ induces an equivalence
$\textit{Adeq}(\mathcal{O})/\mathcal{C} \to \QCoh(\mathcal{O}_S)$
where $\mathcal{C}$ is the subcategory of parasitic adequate modules.
Moreover, the functor $f^*$ transforms quasi-coherent modules
into adequate modules, and induces a functor
$u : \QCoh(\mathcal{O}_S) \to \textit{Adeq}(\mathcal{O})$
which is a left adjoint to $v$.

\medskip\noindent
There is a very similar relationship between
$D_{\textit{Adeq}}(\mathcal{O})$ and $D_\QCoh(S)$.
First we explain why the category $D_{\textit{Adeq}}(\mathcal{O})$
is independent of the chosen topology.

\begin{remark}
\label{remark-D-adeq-independence-topology}
Let $S$ be a scheme.
Let $\tau, \tau' \in \{Zar, \etale, smooth, syntomic, fppf\}$.
Denote $\mathcal{O}_\tau$, resp.\ $\mathcal{O}_{\tau'}$
the structure sheaf $\mathcal{O}$ viewed as a sheaf on
$(\Sch/S)_\tau$, resp.\ $(\Sch/S)_{\tau'}$.
Then $D_{\textit{Adeq}}(\mathcal{O}_\tau)$ and
$D_{\textit{Adeq}}(\mathcal{O}_{\tau'})$ are canonically isomorphic.
This follows from
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-compare-topologies-derived-adequate-modules}.
Namely, assume $\tau$ is stronger than the topology $\tau'$, let
$\mathcal{C} = (\Sch/S)_{fppf}$, and let $\mathcal{B}$ the collection
of affine schemes over $S$. Assumptions (1) and (2) we've seen above.
Assumption (3) is clear and assumption (4) follows from
Lemma \ref{lemma-same-cohomology-adequate}.
\end{remark}

\begin{remark}
\label{remark-D-adeq-and-D-QCoh}
Let $S$ be a scheme. The morphism $f$ see
(\ref{equation-compare-big-small}) induces
adjoint functors
$Rf_* : D_{\textit{Adeq}}(\mathcal{O}) \to D_\QCoh(S)$
and
$Lf^* : D_\QCoh(S) \to D_{\textit{Adeq}}(\mathcal{O})$.
Moreover $Rf_* Lf^* \cong \text{id}_{D_\QCoh(S)}$.

\medskip\noindent
We sketch the proof. By
Remark \ref{remark-D-adeq-independence-topology}
we may assume the topology $\tau$ is the Zariski topology.
We will use the existence of the unbounded total derived
functors $Lf^*$ and $Rf_*$ on $\mathcal{O}$-modules and their
adjointness, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-adjoint}.
In this case $f_*$ is just the restriction to the subcategory
$S_{Zar}$ of $(\Sch/S)_{Zar}$. Hence it is clear that
$Rf_* = f_*$ induces
$Rf_* : D_{\textit{Adeq}}(\mathcal{O}) \to D_\QCoh(S)$.
Suppose that $\mathcal{G}^\bullet$ is an object of
$D_\QCoh(S)$. We may choose a system
$\mathcal{K}_1^\bullet \to \mathcal{K}_2^\bullet \to \ldots$
of bounded above complexes of flat $\mathcal{O}_S$-modules whose
transition maps are termwise split injectives and a diagram
$$
\xymatrix{
\mathcal{K}_1^\bullet \ar[d] \ar[r] &
\mathcal{K}_2^\bullet \ar[d] \ar[r] & \ldots \\
\tau_{\leq 1}\mathcal{G}^\bullet \ar[r] &
\tau_{\leq 2}\mathcal{G}^\bullet \ar[r] & \ldots
}
$$
with the properties (1), (2), (3) listed in
Derived Categories, Lemma \ref{derived-lemma-special-direct-system}
where $\mathcal{P}$ is the collection of flat $\mathcal{O}_S$-modules.
Then $Lf^*\mathcal{G}^\bullet$ is computed by
$\colim f^*\mathcal{K}_n^\bullet$, see
Cohomology on Sites, Lemmas \ref{sites-cohomology-lemma-pullback-K-flat} and
\ref{sites-cohomology-lemma-derived-base-change}
(note that our sites have enough points by
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-points-fppf}).
We have to see that $H^i(Lf^*\mathcal{G}^\bullet) =
\colim H^i(f^*\mathcal{K}_n^\bullet)$ is adequate for each $i$. By
Lemma \ref{lemma-abelian-adequate}
we conclude that it suffices to show that
each $H^i(f^*\mathcal{K}_n^\bullet)$ is adequate.

\medskip\noindent
The adequacy of $H^i(f^*\mathcal{K}_n^\bullet)$ is local on $S$, hence
we may assume that $S = \Spec(A)$ is affine. Because $S$ is affine
$D_\QCoh(S) = D(\QCoh(\mathcal{O}_S))$, see
the discussion in
Derived Categories of Schemes, Section
\ref{perfect-section-derived-quasi-coherent}.
Hence there exists a quasi-isomorphism
$\mathcal{F}^\bullet \to \mathcal{K}_n^\bullet$
where $\mathcal{F}^\bullet$ is a bounded above complex of flat
quasi-coherent modules.
Then $f^*\mathcal{F}^\bullet \to f^*\mathcal{K}_n^\bullet$ is a
quasi-isomorphism, and the cohomology sheaves of
$f^*\mathcal{F}^\bullet$ are adequate.

\medskip\noindent
The final assertion
$Rf_* Lf^* \cong \text{id}_{D_\QCoh(S)}$
follows from the explicit description of the functors above.
(In plain English: if $\mathcal{F}$ is quasi-coherent and $p > 0$, then
$L_pf^*\mathcal{F}$ is a parasitic adequate module.)
\end{remark}


\begin{remark}
\label{remark-conclusion}
Remark \ref{remark-D-adeq-and-D-QCoh}
above implies we have an equivalence of derived categories
$$
D_{\textit{Adeq}}(\mathcal{O})/D_\mathcal{C}(\mathcal{O})
\longrightarrow
D_\QCoh(S)
$$
where $\mathcal{C}$ is the category of parasitic adequate modules.
Namely, it is clear that $D_\mathcal{C}(\mathcal{O})$ is the kernel
of $Rf_*$, hence a functor as indicated. For any object $X$ of
$D_{\textit{Adeq}}(\mathcal{O})$ the map $Lf^*Rf_*X \to X$ maps
to a quasi-isomorphism in $D_\QCoh(S)$, hence
$Lf^*Rf_*X \to X$ is an isomorphism in
$D_{\textit{Adeq}}(\mathcal{O})/D_\mathcal{C}(\mathcal{O})$.
Finally, for $X, Y$ objects of $D_{\textit{Adeq}}(\mathcal{O})$
the map
$$
Rf_* :
\Hom_{D_{\textit{Adeq}}(\mathcal{O})/D_\mathcal{C}(\mathcal{O})}(X, Y)
\to
\Hom_{D_\QCoh(S)}(Rf_*X, Rf_*Y)
$$
is bijective as $Lf^*$ gives an inverse (by the remarks above).
\end{remark}









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.






\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal. The Kronecker
symbol $\delta_{ij}$ will be used. If $R \to S$ is a ring map and
$\mathfrak q$ a prime of $S$, then we use the notation
``$\mathfrak p = R \cap \mathfrak q$''
to indicate the prime which is the inverse image of $\mathfrak q$ under
$R \to S$ even if $R$ is not a subring of $S$ and even if $R \to S$
is not injective.






\section{Basic notions}
\label{section-rings-basic}

\noindent
The following is a list of basic notions in commutative algebra. Some of these
notions are discussed in more detail in the text that follows and some are
defined in the list, but others are considered basic and will not be defined.
If you are not familiar with most of the italicized concepts, then we suggest
looking at an introductory text on algebra before continuing.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{item-ring}
\item $x\in R$ is {\it nilpotent},
\label{item-ring-element-nilpotent}
\item $x\in R$ is a {\it zerodivisor},
\label{item-ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{item-ring-element-unit}
\item $e \in R$ is an {\it idempotent},
\label{item-ring-element-idempotent}
\item an idempotent $e \in R$ is called {\it trivial} if $e = 1$ or $e = 0$,
\label{item-idempotent-trivial}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{item-ring-homomorphism}
\item
\label{item-ring-homomorphism-finite-presentation}
$\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
see Definition \ref{definition-finite-type},
\item
\label{item-ring-homomorphism-finite-type}
$\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finite type $R_1$-algebra},
see Definition \ref{definition-finite-type},
\item
\label{item-ring-homomorphism-finite}
$\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\item $R$ is a {\it (integral) domain},
\label{item-ring-domain}
\item $R$ is {\it reduced},
\label{item-ring-reduced}
\item $R$ is {\it Noetherian},
\label{item-ring-Noetherian}
\item $R$ is a {\it principal ideal domain} or a {\it PID},
\label{item-ring-PID}
\item $R$ is a {\it Euclidean domain},
\label{item-ring-Euclidean}
\item $R$ is a {\it unique factorization domain} or a {\it UFD},
\label{item-ring-UFD}
\item $R$ is a {\it discrete valuation ring} or a {\it dvr},
\label{item-ring-dvr}
\item $K$ is a {\it field},
\label{item-field}
\item $K \subset L$ is a {\it field extension},
\label{item-field-extension}
\item $K \subset L$ is an {\it algebraic field extension},
\label{item-field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{item-transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$ over $K$,
\label{item-transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{item-algebraically-closed}
\item
\label{item-extend-into-algebraically-closed}
if $K \subset L$ is algebraic, and $K \subset k$ an extension
with $k$ algebraically closed,
then there exists a map ring map $L \to k$ extending the map on $K$,
\item $I \subset R$ is an {\it ideal},
\label{item-ideal}
\item $I \subset R$ is {\it radical},
\label{item-ideal-radical}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{item-radical-ideal}
\item
\label{item-ideal-nilpotent}
$I \subset R$ is {\it nilpotent} means that $I^n = 0$ for
some $n \in \mathbf{N}$,
\item
\label{item-ideal-locally-nilpotent}
$I \subset R$ is {\it locally nilpotent} means that every
element of $I$ is nilpotent,
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{item-prime-ideal}
\item
\label{item-prime-product-ideals}
if $\mathfrak p \subset R$ is prime and if $I, J \subset R$
are ideal, and if $IJ\subset \mathfrak p$, then
$I \subset \mathfrak p$ or $J \subset \mathfrak p$.
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{item-maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{item-exists-maximal-ideal}
\item
\label{item-jacobson-radical}
the {\it Jacobson radical} of $R$ is $\text{rad}(R) =
\bigcap_{\mathfrak m \subset R} \mathfrak m$ the intersection
of all the maximal ideals of $R$,
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{item-ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{item-quotient-ring}
\item an ideal $I$ in the ring $R$ is prime if and only if $R/I$ is a domain,
\label{item-characterize-prime-ideal}
\item
\label{item-characterize-maximal-ideal}
an ideal $I$ in the ring $R$ is maximal if and only if the
ring $R/I$ is a field,
\item
\label{item-inverse-image-ideal}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\item
\label{item-image-ideal}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\item
\label{item-inverse-image-prime}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\item $M$ is an {\it $R$-module},
\label{item-module}
\item
\label{item-annihilator}
for $m \in M$ the {\it annihilator}
$I = \{f \in R \mid fm = 0\}$ of $m$ in $R$,
\item $N \subset M$ is an {\it $R$-submodule},
\label{item-submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{item-Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{item-finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{item-finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{item-finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{item-free-module}
\item
\label{item-extension-free}
if $0 \to K \to L \to M \to 0$ is a short exact sequence
of $R$-modules and $K$, $M$ are free, then $L$ is free,
\item if $N \subset M \subset L$ are $R$-modules, then $L/M = (L/N)/(M/N)$,
\label{item-isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{item-multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{item-localization-ring}
\item
\label{item-localization-zero}
if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains $0$,
\item
\label{item-localize-nonzerodivisors}
if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzerodivisors, then $R \to S^{-1}R$
is injective,
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item
\label{item-products-multiplicative-subsets}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\item
\label{item-localization-localization}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{item-localization-module}
\item
\label{item-localization-exact}
the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\item
\label{item-localization-localization-module}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $M$ is an $R$-module, then
$(SS')^{-1}M = S^{-1}((S')^{-1}M)$,
\item
\label{item-localize-ideal}
if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\item
\label{item-ideal-in-localization}
if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\item
\label{item-submodule-in-localization}
if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\item if $S = \{1, f, f^2, \ldots\}$ then $R_f = S^{-1}R$ and $M_f = S^{-1}M$,
\label{item-localize-f}
\item
\label{item-localize-p}
if $S = R \setminus \mathfrak p = \{x\in R \mid x\not\in \mathfrak p\}$
for some prime ideal $\mathfrak p$,
then it is customary to denote $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\item a {\it local ring} is a ring with exactly one maximal ideal,
\label{item-local-ring}
\item a {\it semi-local ring} is a ring with finitely many maximal ideals,
\label{item-semi-local-ring}
\item
\label{item-localize-p-local-ring}
if $\mathfrak p$ is a prime in $R$, then $R_{\mathfrak p}$ is
a local ring with maximal ideal $\mathfrak p R_{\mathfrak p}$,
\item
\label{item-residue-field}
the {\it residue field}, denoted $\kappa(\mathfrak p)$,
of the prime $\mathfrak p$ in the
ring $R$ is the quotient $R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p}
= (R \setminus \mathfrak p)^{-1}R/{\mathfrak p}$,
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} $M_1 \otimes_R M_2$,
\label{item-tensor-product}
\item etc.
\end{enumerate}




\section{Snake lemma}
\label{section-snake}

\noindent
The snake lemma and its variants are discussed in the setting of
abelian categories in
Homology, Section \ref{homology-section-abelian-categories}.

\begin{lemma}
\label{lemma-snake}
\begin{reference}
\cite[III, Lemma 3.3]{Cartan-Eilenberg}
\end{reference}
Suppose given a commutative diagram
$$
\xymatrix{
& X \ar[r] \ar[d]^\alpha &
Y \ar[r] \ar[d]^\beta &
Z \ar[r] \ar[d]^\gamma &
0 \\
0 \ar[r] & U \ar[r] & V \ar[r] & W
}
$$
of abelian groups with exact rows, then there is a canonical exact sequence
$$
\Ker(\alpha) \to \Ker(\beta) \to \Ker(\gamma)
\to
\Coker(\alpha) \to \Coker(\beta) \to \Coker(\gamma)
$$
Moreover, if $X \to Y$ is injective, then the first map is
injective, and if $V \to W$ is surjective, then the last
map is surjective.
\end{lemma}

\begin{proof}
The map $\partial : \Ker(\gamma) \to \Coker(\alpha)$ is defined
as follows. Take $z \in \Ker(\gamma)$. Choose $y \in Y$ mapping to $z$.
Then $\beta(y) \in V$ maps to zero in $W$. Hence $\beta(y)$ is the image of
some $u \in U$. Set $\partial z = \overline{u}$ the class of $u$ in the
cokernel of $\alpha$. Proof of exactness is omitted.
\end{proof}







\section{Finite modules and finitely presented modules}
\label{section-module-finite-type}

\noindent
Just some basic notation and lemmas.

\begin{definition}
\label{definition-module-finite-type}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say $M$ is a {\it finite $R$-module}, or a {\it finitely generated
$R$-module} if there exist $n \in \mathbf{N}$ and $x_1, \ldots, x_n \in M$
such that every element of $M$ is a $R$-linear combination of the $x_i$.
Equivalently, this means there exists a surjection
$R^{\oplus n} \to M$ for some $n \in \mathbf{N}$.
\item We say $M$ is a {\it finitely presented $R$-module} or an
{\it $R$-module of finite presentation} if there exist integers
$n, m \in \mathbf{N}$ and an exact sequence
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \longrightarrow 0
$$
\end{enumerate}
\end{definition}

\noindent
Informally, $M$ is a finitely presented $R$-module if and only if
it is finitely generated and the module of relations among these
generators is finitely generated as well.
A choice of an exact sequence as in the definition is called a
{\it presentation} of $M$.

\begin{lemma}
\label{lemma-lift-map}
Let $R$ be a ring. Let $\alpha : R^{\oplus n} \to M$ and $\beta : N \to M$ be
module maps. If $\Im(\alpha) \subset \Im(\beta)$, then there
exists an $R$-module map $\gamma : R^{\oplus n} \to N$ such that
$\alpha = \beta \circ \gamma$.
\end{lemma}

\begin{proof}
Let $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ be the $i$th basis vector
of $R^{\oplus n}$. Let $x_i \in N$ be an element with
$\alpha(e_i) = \beta(x_i)$ which exists by assumption. Set
$\gamma(a_1, \ldots, a_n) = \sum a_i x_i$. By construction
$\alpha = \beta \circ \gamma$.
\end{proof}

\begin{lemma}
\label{lemma-extension}
Let $R$ be a ring.
Let
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
be a short exact sequence of $R$-modules.
\begin{enumerate}
\item If $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite
$R$-module.
\item If $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$
is a finitely presented $R$-module.
\item If $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module.
\item If $M_2$ is a finitely presented $R$-module and $M_1$ is a
finite $R$-module, then $M_3$ is a finitely presented $R$-module.
\item If $M_3$ is a finitely presented $R$-module and $M_2$ is a finite
$R$-module, then $M_1$ is a finite $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $x_1, \ldots, x_n$ are generators of $M_1$ and
$y_1, \ldots, y_m \in M_2$ are elements whose images in $M_3$ are
generators of $M_3$, then $x_1, \ldots, x_n, y_1, \ldots, y_m$
generate $M_2$.

\medskip\noindent
Part (3) is immediate from the definition.

\medskip\noindent
Proof of (5). Assume $M_3$ is finitely presented and $M_2$ finite.
Choose a presentation
$$
R^{\oplus m} \to R^{\oplus n} \to M_3 \to 0
$$
By Lemma \ref{lemma-lift-map} there exists a map
$R^{\oplus n} \to M_2$ such that
the solid diagram
$$
\xymatrix{
& R^{\oplus m} \ar[r] \ar@{..>}[d] & R^{\oplus n} \ar[r] \ar[d] &
M_3 \ar[r] \ar[d]^{\text{id}} & 0 \\
0 \ar[r] & M_1 \ar[r] & M_2 \ar[r] & M_3 \ar[r] & 0
}
$$
commutes. This produces the dotted arrow. By the snake lemma
(Lemma \ref{lemma-snake}) we see that we get an isomorphism
$$
\Coker(R^{\oplus m} \to M_1)
\cong
\Coker(R^{\oplus n} \to M_2)
$$
In particular we conclude that $\Coker(R^{\oplus m} \to M_1)$
is a finite $R$-module. Since $\Im(R^{\oplus m} \to M_1)$
is finite by (3), we see that $M_1$ is finite by part (1).

\medskip\noindent
Proof of (4). Assume $M_2$ is finitely presented and $M_1$ is finite.
Choose a presentation $R^{\oplus m} \to R^{\oplus n} \to M_2 \to 0$.
Choose a surjection $R^{\oplus k} \to M_1$. By Lemma \ref{lemma-lift-map}
there exists a factorization $R^{\oplus k} \to R^{\oplus n} \to M_2$
of the composition $R^{\oplus k} \to M_1 \to M_2$. Then
$R^{\oplus k + m} \to R^{\oplus n} \to M_3 \to 0$
is a presentation.

\medskip\noindent
Proof of (2). Assume that $M_1$ and $M_3$ are finitely presented.
The argument in the proof of part (1) produces a commutative diagram
$$
\xymatrix{
0 \ar[r] & R^{\oplus n} \ar[d] \ar[r] & R^{\oplus n + m} \ar[d] \ar[r] &
R^{\oplus m} \ar[d] \ar[r] & 0 \\
0 \ar[r] & M_1 \ar[r] & M_2 \ar[r] & M_3 \ar[r] & 0
}
$$
with surjective vertical arrows. By the snake lemma we obtain a short
exact sequence
$$
0 \to \Ker(R^{\oplus n} \to M_1) \to
\Ker(R^{\oplus n + m} \to M_2) \to
\Ker(R^{\oplus m} \to M_3) \to 0
$$
By part (5) we see that the outer two modules are finite. Hence the
middle one is finite too. By (4) we see that $M_2$ is of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-trivial-filter-finite-module}
\begin{slogan}
Finite modules have filtrations such that successive quotients are
cyclic modules.
\end{slogan}
Let $R$ be a ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/I_i$ for some ideal $I_i$ of $R$.
\end{lemma}

\begin{proof}
By induction on the number of generators of $M$. Let
$x_1, \ldots, x_r \in M$ be a minimal number of generators.
Let $M' = Rx_1 \subset M$. Then $M/M'$ has $r - 1$ generators
and the induction hypothesis applies. And clearly $M' \cong R/I_1$
with $I_1 = \{f \in R \mid fx_1 = 0\}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
If $M$ is finite as an $R$-module, then $M$ is finite as an $S$-module.
\end{lemma}

\begin{proof}
In fact, any $R$-generating set of $M$ is also an $S$-generating set of
$M$, since the $R$-module structure is induced by the image of $R$ in $S$.
\end{proof}



\section{Ring maps of finite type and of finite presentation}
\label{section-finite-type}

\begin{definition}
\label{definition-finite-type}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is of {\it finite type}, or that {\it $S$ is a finite
type $R$-algebra} if there exists an $n \in \mathbf{N}$ and an surjection
of $R$-algebras $R[x_1, \ldots, x_n] \to S$.
\item We say $R \to S$ is of {\it finite presentation} if there
exist integers $n, m \in \mathbf{N}$ and polynomials
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$
and an isomorphism of $R$-algebras
$R[x_1, \ldots, x_n]/(f_1, \ldots, f_m) \cong S$.
\end{enumerate}
\end{definition}

\noindent
Informally, $R \to S$ is of finite presentation if and only if
$S$ is finitely generated as an $R$-algebra
and the ideal of relations among the generators is finitely generated.
A choice of a surjection $R[x_1, \ldots, x_n] \to S$ as in the definition
is sometimes called a {\it presentation} of $S$.

\begin{lemma}
\label{lemma-compose-finite-type}
The notions finite type and finite presentation have the following
permanence properties.
\begin{enumerate}
\item A composition of ring maps of finite type is of finite type.
\item A composition of ring maps of finite presentation is of finite
presentation.
\item Given $R \to S' \to S$ with $R \to S$ of finite type,
then $S' \to S$ is of finite type.
\item Given $R \to S' \to S$, with $R \to S$ of finite presentation,
and $R \to S'$ of finite type, then $S' \to S$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
We only prove the last assertion.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and $S' = R[y_1, \ldots, y_a]/I$. Say that the class
$\bar y_i$ of $y_i$ maps
to $h_i \bmod (f_1, \ldots, f_m)$ in $S$.
Then it is clear that
$S = S'[x_1, \ldots, x_n]/(f_1, \ldots, f_m,
h_1 - \bar y_1, \ldots, h_a - \bar y_a)$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-independent}
Let $R \to S$ be a ring map of finite presentation.
For any surjection $\alpha : R[x_1, \ldots, x_n] \to S$ the
kernel of $\alpha$ is a finitely generated ideal in $R[x_1, \ldots, x_n]$.
\end{lemma}

\begin{proof}
Write $S = R[y_1, \ldots, y_m]/(f_1, \ldots, f_k)$.
Choose $g_i \in R[y_1, \ldots, y_m]$ which are lifts
of $\alpha(x_i)$. Then we see that $S = R[x_i, y_j]/(f_j, x_i - g_i)$.
Choose $h_j \in R[x_1, \ldots, x_n]$ such that $\alpha(h_j)$
corresponds to $y_j \bmod (f_1, \ldots, f_k)$. Consider
the map $\psi : R[x_i, y_j] \to R[x_i]$, $x_i \mapsto x_i$,
$y_j \mapsto h_j$. Then the kernel of $\alpha$
is the image of $(f_j, x_i - g_i)$ under $\psi$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-finitely-presented-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume $R \to S$ is of finite type and
$M$ is finitely presented as an $R$-module.
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
This is similar to the proof of part (4) of
Lemma \ref{lemma-compose-finite-type}.
We may assume $S = R[x_1, \ldots, x_n]/J$.
Choose $y_1, \ldots, y_m \in M$ which generate $M$ as an $R$-module
and choose relations $\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ which
generate the kernel of $R^{\oplus m} \to M$. For any
$i = 1, \ldots, n$ and $j = 1, \ldots, m$ write
$$
x_i y_j = \sum a_{ijk} y_k
$$
for some $a_{ijk} \in R$. Consider the $S$-module $N$ generated by
$y_1, \ldots, y_m$ subject to the relations
$\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ and
$x_i y_j = \sum a_{ijk} y_k$, $i = 1, \ldots, n$ and $j = 1, \ldots, m$.
Then $N$ has a presentation
$$
S^{\oplus nm + t} \longrightarrow S^{\oplus m} \longrightarrow N
\longrightarrow 0
$$
By construction there is a surjective map $\varphi : N \to M$.
To finish the proof we show $\varphi$ is injective.
Suppose $z = \sum b_j y_j \in N$ for some $b_j \in S$.
We may think of $b_j$ as a polynomial in $x_1, \ldots, x_n$
with coefficients in $R$.
By applying the relations of the form $x_i y_j = \sum a_{ijk} y_k$
we can inductively lower the degree of the polynomials.
Hence we see that $z = \sum c_j y_j$ for some $c_j \in R$.
Hence if $\varphi(z) = 0$ then the vector $(c_1, \ldots, c_m)$
is an $R$-linear combination of the vectors $(a_{i1}, \ldots, a_{im})$
and we conclude that $z = 0$ as desired.
\end{proof}





\section{Finite ring maps}
\label{section-finite}

\begin{definition}
\label{definition-finite-ring-map}
Let $\varphi : R \to S$ be a ring map. We say $\varphi : R \to S$ is
{\it finite} if $S$ is finite as an $R$-module.
\end{definition}

\begin{lemma}
\label{lemma-finite-module-over-finite-extension}
Let $R \to S$ be a finite ring map.
Let $M$ be an $S$-module.
Then $M$ is finite as an $R$-module if and only if $M$ is finite
as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finite-over-subring}.
To see the other assume that $M$ is finite as an $S$-module.
Pick $x_1, \ldots, x_n \in S$ which generate $S$ as an $R$-module.
Pick $y_1, \ldots, y_m \in M$ which generate $M$ as an $S$-module.
Then $x_i y_j$ generate $M$ as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-finite-transitive}
Suppose that $R \to S$ and $S \to T$ are finite ring maps.
Then $R \to T$ is finite.
\end{lemma}

\begin{proof}
If $t_i$ generate $T$ as an $S$-module and $s_j$ generate $S$ as an
$R$-module, then $t_i s_j$ generate $T$ as an $R$-module.
(Also follows from
Lemma \ref{lemma-finite-module-over-finite-extension}.)
\end{proof}

\noindent
For more information on finite ring maps, please see
Section \ref{section-finite-ring-extensions}.


\section{Colimits}
\label{section-colimits}

\noindent
Some of the material in this section overlaps with the general
discussion on colimits in
Categories, Sections \ref{categories-section-limits} --
\ref{categories-section-posets-limits}.
The notion of a preordered set is defined in
Categories, Definition \ref{categories-definition-directed-set}.
It is a slightly weaker notion than a partially ordered set.

\begin{definition}
\label{definition-directed-system}
Let $(I, \leq)$ be a preordered set.
A {\it system $(M_i, \mu_{ij})$ of $R$-modules over $I$}
consists of a family of $R$-modules $\{M_i\}_{i\in I}$ indexed
by $I$ and a family of $R$-module maps $\{\mu_{ij} : M_i \to M_j\}_{i \leq j}$
such that for all $i \leq j \leq k$
$$
\mu_{ii} = \text{id}_{M_i}\quad
\mu_{ik} = \mu_{jk}\circ \mu_{ij}
$$
We say $(M_i, \mu_{ij})$ is a {\it directed system} if $I$ is a directed set.
\end{definition}

\noindent
This is the same as the notion defined in Categories,
Definition \ref{categories-definition-system-over-poset}
and Section \ref{categories-section-posets-limits}.
We refer to Categories, Definition \ref{categories-definition-colimit}
for the definition of a colimit of a diagram/system in any
category.

\begin{lemma}
\label{lemma-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the preordered set $I$.
The colimit of the system $(M_i, \mu_{ij})$ is the quotient $R$-module
$(\bigoplus_{i\in I} M_i) /Q$ where $Q$ is the
$R$-submodule generated by all elements
$$
\iota_i(x_i) - \iota_j(\mu_{ij}(x_i))
$$
where $\iota_i : M_i \to \bigoplus_{i\in I} M_i$
is the natural inclusion. We denote the colimit
$M = \colim_i M_i$. We denote
$\pi : \bigoplus_{i\in I} M_i \to M$ the
projection map and
$\phi_i = \pi \circ \iota_i : M_i \to M$.
\end{lemma}

\begin{proof}
This lemma is a special case of
Categories, Lemma \ref{categories-lemma-colimits-coproducts-coequalizers}
but we will also prove it directly in this case.
Namely, note that $\phi_i = \phi_j\circ \mu_{ij}$ in the above
construction. To show the pair $(M, \phi_i)$ is the colimit we have
to show it satisfies the universal property: for any other such pair
$(Y, \psi_i)$ with $\psi_i : M_i \to
Y$, $\psi_i = \psi_j\circ \mu_{ij}$, there is a unique $R$-module
homomorphism $g : M \to Y$ such that the
following diagram commutes:
$$
\xymatrix{
M_i \ar[rr]^{\mu_{ij}} \ar[dr]^{\phi_i} \ar[ddr]_{\psi_i} & &
M_j\ar[dl]_{\phi_j} \ar[ddl]^{\psi_j} \\
& M \ar[d]^{g}\\
& Y
}
$$
And this is clear because we can define $g$ by taking the
map $\psi_i$ on the summand $M_i$ in the direct sum
$\bigoplus M_i$.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the
preordered set $I$. Assume that $I$ is directed.
The colimit of the system $(M_i, \mu_{ij})$ is canonically
isomorphic to the module $M$ defined as follows:
\begin{enumerate}
\item as a set let
$$
M = \left(\coprod\nolimits_{i \in I} M_i\right)/\sim
$$
where for $m \in M_i$ and $m' \in M_{i'}$ we have
$$
m \sim m' \Leftrightarrow
\mu_{ij}(m) = \mu_{i'j}(m')\text{ for some }j \geq i, i'
$$
\item as an abelian group for $m \in M_i$ and $m' \in M_{i'}$
we define the sum of the classes of $m$ and $m'$ in $M$
to be the class of $\mu_{ij}(m) + \mu_{i'j}(m')$ where
$j \in I$ is any index with $i \leq j$ and $i' \leq j$, and
\item as an $R$-module define for $m \in M_i$ and $x \in R$
the product of $x$ and the class of $m$ in $M$ to be the
class of $xm$ in $M$.
\end{enumerate}
The canonical maps $\phi_i : M_i \to M$ are induced by the canonical
maps $M_i \to \coprod_{i \in I} M_i$.
\end{lemma}

\begin{proof}
Omitted. Compare with
Categories, Section \ref{categories-section-directed-colimits}.
\end{proof}

\begin{lemma}
\label{lemma-zero-directed-limit}
Let $(M_i, \mu_{ij})$ be a directed system.
Let $M = \colim M_i$ with $\mu_i : M_i \to M$.
Then, $\mu_i(x_i) = 0$ for $x_i \in M_i$ if and only if
there exists $j \geq i$ such that $\mu_{ij}(x_i) = 0$.
\end{lemma}

\begin{proof}
This is clear from the description of the directed colimit
in Lemma \ref{lemma-directed-colimit}.
\end{proof}

\begin{example}
\label{example-zero-colimit-different}
Consider the partially ordered set $I = \{a, b, c\}$ with
$a < b$ and $a < c$ and no other strict inequalities.
A system $(M_a, M_b, M_c, \mu_{ab}, \mu_{ac})$
over $I$ consists of three $R$-modules $M_a, M_b, M_c$
and two $R$-module homomorphisms $\mu_{ab} : M_a \to M_b$ and
$\mu_{ac} : M_a \to M_c$.
The colimit of the system is just
$$
M := \colim_{i \in I} M_i = \Coker(M_a \to M_b \oplus M_c)
$$
where the map is $\mu_{ab} \oplus -\mu_{ac}$. Thus the kernel of the
canonical map $M_a \to M$ is $\Ker(\mu_{ab}) + \Ker(\mu_{ac})$.
And the kernel of the canonical map $M_b \to M$ is the image of
$\Ker(\mu_{ac})$ under the map $\mu_{ab}$. Hence clearly
the result of Lemma \ref{lemma-zero-directed-limit} is false for
general systems.
\end{example}

\begin{definition}
\label{definition-homomorphism-directed-systems}
Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be
systems of $R$-modules over the same preordered set $I$.
A {\it homomorphism of systems} $\Phi$ from $(M_i, \mu_{ij})$ to
$(N_i, \nu_{ij})$ is by definition a family of $R$-module homomorphisms
$\phi_i : M_i \to N_i$
such that $\phi_j \circ \mu_{ij} = \nu_{ij} \circ \phi_i$
for all $i \leq j$.
\end{definition}

\noindent
This is the same notion as a transformation of functors
between the associated diagrams $M : I \to \text{Mod}_R$
and $N : I \to \text{Mod}_R$, in the language of
categories.
The following lemma is a special case of
Categories, Lemma \ref{categories-lemma-functorial-colimit}.

\begin{lemma}
\label{lemma-homomorphism-limit}
Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be
systems of $R$-modules over the same preordered set.
A morphism of systems $\Phi = (\phi_i)$ from $(M_i, \mu_{ij})$ to
$(N_i, \nu_{ij})$ induces a unique homomorphism
$$
\colim \phi_i : \colim M_i \longrightarrow \colim N_i
$$
such that
$$
\xymatrix{
M_i \ar[r] \ar[d]_{\phi_i} & \colim M_i \ar[d]^{\colim \phi_i} \\
N_i \ar[r] & \colim N_i
}
$$
commutes for all $i \in I$.
\end{lemma}

\begin{proof}
Write $M = \colim M_i$ and $N = \colim N_i$ and $\phi = \colim \phi_i$
(as yet to be constructed). We will use the explicit description of $M$
and $N$ in Lemma \ref{lemma-colimit} without further mention.
The condition of the lemma is equivalent to the condition that
$$
\xymatrix{
\bigoplus_{i\in I} M_i \ar[r] \ar[d]_{\bigoplus\phi_i} & M \ar[d]^\phi \\
\bigoplus_{i\in I} N_i \ar[r] & N
}
$$
commutes. Hence it is clear that if $\phi$ exists, then it is unique.
To see that $\phi$ exists, it suffices to show that the kernel of the
upper horizontal arrow is mapped by $\bigoplus \phi_i$ to the kernel
of the lower horizontal arrow. To see this, let $j \leq k$ and
$x_j \in M_j$. Then
$$
(\bigoplus \phi_i)(x_j - \mu_{jk}(x_j))
=
\phi_j(x_j) - \phi_k(\mu_{jk}(x_j))
=
\phi_j(x_j) - \nu_{jk}(\phi_j(x_j))
$$
which is in the kernel of the lower horizontal arrow as required.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit-exact}
\begin{slogan}
Filtered colimits are exact. Directed colimits are exact.
\end{slogan}
Let $I$ be a directed set.
Let $(L_i, \lambda_{ij})$, $(M_i, \mu_{ij})$, and
$(N_i, \nu_{ij})$ be systems of $R$-modules over $I$.
Let $\varphi_i : L_i \to M_i$ and $\psi_i : M_i \to N_i$ be
morphisms of systems over $I$. Assume that for all $i \in I$ the
sequence of $R$-modules
$$
\xymatrix{
L_i \ar[r]^{\varphi_i} &
M_i \ar[r]^{\psi_i} &
N_i
}
$$
is a complex with homology $H_i$.
Then the $R$-modules $H_i$ form a system over $I$,
the sequence of $R$-modules
$$
\xymatrix{
\colim_i L_i \ar[r]^\varphi &
\colim_i M_i \ar[r]^\psi &
\colim_i N_i
}
$$
is a complex as well, and denoting $H$ its homology we have
$$
H = \colim_i H_i.
$$
\end{lemma}

\begin{proof}
It is clear that
$
\xymatrix{
\colim_i L_i \ar[r]^\varphi &
\colim_i M_i \ar[r]^\psi &
\colim_i N_i
}
$
is a complex. For each $i \in I$, there is a canonical
$R$-module morphism $H_i \to H$ (sending each
$[m] \in H_i = \Ker(\psi_i) / \Im(\varphi_i)$ to the
residue class in $H = \Ker(\psi) / \Im(\varphi)$
of the image of $m$ in $\colim_i M_i$). These give rise
to a morphism $\colim_i H_i \to H$. It remains to
show that this morphism is surjective and injective.

\medskip\noindent
We are going to repeatedly use the description of colimits over $I$
as in Lemma \ref{lemma-directed-colimit} without further mention.
Let $h \in H$.
Since $H = \Ker(\psi)/\Im(\varphi)$ we see that
$h$ is the class mod $\Im(\varphi)$ of an element $[m]$
in $\Ker(\psi) \subset \colim_i M_i$. Choose an
$i$ such that $[m]$ comes from an element $m \in M_i$. Choose
a $j \geq i$ such that $\nu_{ij}(\psi_i(m)) = 0$ which is possible
since $[m] \in \Ker(\psi)$. After replacing $i$ by $j$ and
$m$ by $\mu_{ij}(m)$ we see that we may assume $m \in \Ker(\psi_i)$.
This shows that the map $\colim_i H_i \to H$ is surjective.

\medskip\noindent
Suppose that $h_i \in H_i$ has image zero on $H$. Since
$H_i = \Ker(\psi_i)/\Im(\varphi_i)$ we may represent
$h_i$ by an element $m \in \Ker(\psi_i) \subset M_i$.
The assumption on the vanishing of $h_i$ in $H$ means that
the class of $m$ in $\colim_i M_i$ lies in the image
of $\varphi$. Hence there exists a $j \geq i$ and an $l \in L_j$
such that $\varphi_j(l) = \mu_{ij}(m)$. Clearly this shows that
the image of $h_i$ in $H_j$ is zero. This proves the
injectivity of $\colim_i H_i \to H$.
\end{proof}

\begin{example}
\label{example-colimit-not-exact}
Taking colimits is not exact in general.
Consider the partially ordered set $I = \{a, b, c\}$ with
$a < b$ and $a < c$ and no other strict inequalities,
as in Example \ref{example-zero-colimit-different}.
Consider the map of systems
$(0, \mathbf{Z}, \mathbf{Z}, 0, 0) \to
(\mathbf{Z}, \mathbf{Z}, \mathbf{Z}, 1, 1)$.
From the description of the colimit in
Example \ref{example-zero-colimit-different}
we see that the associated map of colimits is not injective,
even though the map of systems is injective on each object.
Hence the result of Lemma \ref{lemma-directed-colimit-exact}
is false for general systems.
\end{example}

\begin{lemma}
\label{lemma-almost-directed-colimit-exact}
Let $\mathcal{I}$ be an index category satisfying the assumptions of
Categories, Lemma \ref{categories-lemma-split-into-directed}.
Then taking colimits of diagrams of abelian groups over $\mathcal{I}$
is exact (i.e., the analogue of
Lemma \ref{lemma-directed-colimit-exact}
holds in this situation).
\end{lemma}

\begin{proof}
By
Categories, Lemma \ref{categories-lemma-split-into-directed}
we may write $\mathcal{I} = \coprod_{j \in J} \mathcal{I}_j$ with each
$\mathcal{I}_j$ a filtered category, and $J$ possibly empty. By
Categories, Lemma \ref{categories-lemma-directed-category-system}
taking colimits over the index categories $\mathcal{I}_j$ is
the same as taking the colimit over some directed set. Hence
Lemma \ref{lemma-directed-colimit-exact}
applies to these colimits. This reduces the problem to showing that
coproducts in the category of $R$-modules over the set $J$ are exact.
In other words, exact sequences
$L_j \to M_j \to N_j$ of $R$ modules we have to show that
$$
\bigoplus\nolimits_{j \in J} L_j
\longrightarrow
\bigoplus\nolimits_{j \in J} M_j
\longrightarrow
\bigoplus\nolimits_{j \in J} N_j
$$
is exact. This can be verified by hand, and holds even if $J$ is empty.
\end{proof}

\noindent
For purposes of reference, we define what it means to have a relation
between elements of a module.

\begin{definition}
\label{definition-relation}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $n \geq 0$ and $x_i \in M$ for $i = 1, \ldots, n$.
A {\it relation} between $x_1, \ldots, x_n$ in $M$ is a
sequence of elements $f_1, \ldots, f_n \in R$ such that
$\sum_{i = 1, \ldots, n} f_i x_i = 0$.
\end{definition}

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(M_i, \mu_{ij})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e, s} \in R$ such that $\sum f_{e, s} x_s = 0$.
Let $M_{S, E}$ be the cokernel of the map
$$
R^{\# E} \longrightarrow R^{\# S}, \quad
(g_e)_{e\in E} \longmapsto (\sum g_e f_{e, s})_{s\in S}.
$$
There are canonical maps $M_{S, E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations
in $E'$, then there is an obvious map
$M_{S, E} \to M_{S', E'}$ commuting with the
maps to $M$. Let $I$ be the set of pairs
$(S, E)$ with ordering by inclusion as above.
It is clear that the colimit of this directed system is $M$.
\end{proof}






\section{Localization}
\label{section-localization}

\begin{definition}
\label{definition-multiplicative-subset}
Let $R$ be a ring, $S$ a subset of $R$.
We say $S$ is a {\it multiplicative subset of $R$} if
$1\in S$ and $S$ is closed
under multiplication, i.e., $s, s' \in S \Rightarrow ss' \in S$.
\end{definition}

\noindent
Given a ring $A$ and a multiplicative subset $S$, we
define a relation on $A \times S$ as follows:
$$
(x, s) \sim (y, t)
\Leftrightarrow
\exists u \in S \text{ such that } (xt-ys)u = 0
$$
It is easily checked that this is an equivalence relation.
Let $x/s$ (or $\frac{x}{s}$) be the equivalence class of $(x, s)$ and
$S^{-1}A$ be the set of all equivalence classes. Define addition
and multiplication in $S^{-1}A$ as follows:
$$
x/s + y/t = (xt + ys)/st, \quad
x/s \cdot y/t = xy/st
$$
One can check that $S^{-1}A$ becomes a ring under these operations.

\begin{definition}
\label{definition-localization}
This ring is called the {\it localization of $A$ with respect to $S$}.
\end{definition}

\noindent
We have a natural ring map from $A$ to its localization $S^{-1}A$,
$$
A \longrightarrow S^{-1}A, \quad x \longmapsto x/1
$$
which is sometimes called the {\it localization map}. In general the
localization map is not injective, unless $S$ contains no zerodivisors.
For, if $x/1 = 0$, then there is a $u\in S$ such that $xu = 0$ in $A$ and
hence $x = 0$ since there are no zerodivisors in $S$.
The localization of a ring has the following universal property.

\begin{proposition}
\label{proposition-universal-property-localization}
Let $f : A \to B$ be a ring map that sends every element in $S$ to a unit
of $B$. Then there is a unique homomorphism $g : S^{-1}A \to B$ such
that the following diagram commutes.
$$
\xymatrix{
A \ar[rr]^{f} \ar[dr] & & B \\
& S^{-1}A \ar[ur]_g
}
$$
\end{proposition}

\begin{proof}
Existence. We define a map $g$ as follows. For $x/s\in S^{-1}A$, let
$g(x/s) = f(x)f(s)^{-1}\in B$. It is easily checked from the definition
that this is a well-defined ring map. And it is also clear that
this makes the diagram commutative.

\medskip\noindent
Uniqueness. We now show that if $g' : S^{-1}A \to B$
satisfies $g'(x/1) = f(x)$, then $g = g'$. Hence $f(s) = g'(s/1)$ for
$s \in S$ by the commutativity of the diagram. But then $g'(1/s)f(s) = 1$
in $B$, which implies that $g'(1/s) = f(s)^{-1}$ and hence
$g'(x/s) = g'(x/1)g'(1/s) = f(x)f(s)^{-1} = g(x/s)$.
\end{proof}

\begin{lemma}
\label{lemma-localization-zero}
The localization $S^{-1}A$ is the zero ring if and only if $0\in S$.
\end{lemma}

\begin{proof}
If $0\in S$, any pair $(a, s)\sim (0, 1)$ by definition.
If $0\not \in S$, then clearly $1/1 \neq 0/1$ in $S^{-1}A$.
\end{proof}

\begin{lemma}
\label{lemma-localization-and-modules}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The category of $S^{-1}R$-modules is equivalent to the category
of $R$-modules $N$ with the property that every $s \in S$ acts as
an automorphism on $N$.
\end{lemma}

\begin{proof}
The functor which defines the equivalence associates to an $S^{-1}R$-module
$M$ the same module but now viewed as an $R$-module via the localization
map $R \to S^{-1}R$. Conversely, if $N$ is an $R$-module, such that every
$s \in S$ acts via an automorphism $s_N$, then we can think of $N$ as an
$S^{-1}R$-module by letting $x/s$ act via $x_N  \circ s_N^{-1}$.
We omit the verification that these two functors are quasi-inverse to
each other.
\end{proof}

\noindent
The notion of localization of a ring can be generalized to the
localization of a module. Let $A$ be a ring, $S$ a multiplicative
subset of $A$ and $M$ an $A$-module. We define a relation on
$M \times S$ as follows
$$
(m, s) \sim (n, t)
\Leftrightarrow
\exists u\in S \text{ such that } (mt-ns)u = 0
$$
This is clearly an equivalence relation. Denote by $m/s$ (or
$\frac{m}{s}$) be the equivalence class of $(m, s)$ and $S^{-1}M$ be
the set of all equivalence classes. Define the addition and scalar
multiplication as follows
$$
m/s + n/t = (mt + ns)/st,\quad
m/s\cdot n/t = mn/st
$$
It is clear that this makes $S^{-1}M$ an $S^{-1}A$ module.

\begin{definition}
\label{definition-localization-module}
The $S^{-1}A$-module $S^{-1}M$ is called the {\it localization} of $M$ at $S$.
\end{definition}

\noindent
Note that there is an $A$-module map $M \to S^{-1}M$, $m \mapsto m/1$
which is sometimes
called the {\it localization map}. It satisfies the following universal
property.

\begin{lemma}
\label{lemma-universal-property-localization-module}
Let $R$ be a ring. Let $S \subset R$ a multiplicative subset. Let $M$, $N$
be $R$-modules. Assume all the elements of $S$ act as automorphisms on $N$.
Then the canonical map
$$
\Hom_R(S^{-1}M, N) \longrightarrow \Hom_R(M, N)
$$
induced by the localization map, is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the map is well-defined and R-linear.
Injectivity: Let $\alpha \in \Hom_R(S^{-1}M, N)$ and take an arbitrary
element $m/s \in S^{-1}M$. Then, since $s \cdot \alpha(m/s) = \alpha(m/1)$,
we have $ \alpha(m/s) =s^{-1}(\alpha (m/1))$, so $\alpha$ is completely
determined by what it does on the image of $M$ in $S^{-1}M$.
Surjectivity: Let $\beta : M \rightarrow N$ be a given R-linear map.
We need to show that it can be "extended" to $S^{-1}M$. Define a map of
sets
$$
M \times S \rightarrow N,\quad
(m,s) \mapsto s^{-1}\beta(m)
$$
Clearly, this map respects the equivalence relation from above, so it
descends to a well-defined map $\alpha : S^{-1}M \rightarrow N$.
It remains to show that this map is $R$-linear, so take
$r, r^\prime \in R$ as well as $s, s^\prime \in S$ and
$m, m^\prime \in M$. Then
\begin{align*}
\alpha(r \cdot m/s + r^\prime \cdot m^\prime /s^\prime)
& = \alpha ((r \cdot s\prime \cdot m + r\prime \cdot s \cdot m^\prime)
/(ss^\prime)) \\
& =
(ss^\prime)^{-1}(\beta(r \cdot s\prime \cdot m +
r\prime \cdot s \cdot m^\prime) \\
& =
(ss^\prime)^{-1} (r \cdot s^\prime \beta (m) +
r^\prime \cdot s \beta (m^\prime) \\
& =
r \alpha (m/s) + r^\prime \alpha (m^\prime /s^\prime)
\end{align*}
and we win.
\end{proof}

\begin{example}
\label{example-localize-at-prime}
Let $A$ be a ring and let $M$ be an $A$-module.
Here are some important examples of localizations.
\begin{enumerate}
\item Given $\mathfrak p$ a prime ideal of $A$ consider
$S = A\setminus\mathfrak p$. It is
immediately checked that $S$ is a multiplicative set. In this case
we denote $A_\mathfrak p$ and $M_\mathfrak p$ the localization of
$A$ and $M$ with respect to $S$ respectively. These are
called the {\it localization of $A$, resp.\ $M$ at $\mathfrak p$}.
\item Let $f\in A$. Consider $S = \{1, f, f^2, \ldots\}$.
This is clearly a multiplicative subset of $A$.
In this case we denote $A_f$
(resp. $M_f$) the localization $S^{-1}A$ (resp. $S^{-1}M$).
This is called the {\it localization of $A$, resp.\ $M$ with
respect to $f$}.
Note that $A_f = 0$ if and only if $f$ is nilpotent in $A$.
\item Let $S = \{f \in A \mid f \text{ is not a zerodivisor in }A\}$.
This is a multiplicative subset of $A$. In this case the
ring $Q(A) = S^{-1}A$ is called either the
{\it total quotient ring}, or the {\it total ring of fractions}
of $A$.
\end{enumerate}
\end{example}

\begin{lemma}
\label{lemma-localization-colimit}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset.
Let $M$ be an $R$-module.
Then
$$
S^{-1}M = \colim_{f \in S} M_f
$$
where the preorder on $S$ is given by
$f \geq f' \Leftrightarrow f = f'f''$ for some $f'' \in R$
in which case the map $M_{f'} \to M_f$ is given
by $m/(f')^e \mapsto m(f'')^e/f^e$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the universal property of
Lemma \ref{lemma-universal-property-localization-module}.
\end{proof}

\noindent
In the following paragraph,
let $A$ denote a ring,
and $M, N$ denote modules over $A$.

\medskip\noindent
If $S$ and $S'$ are multiplicative sets of $A$, then it is
clear that
$$
SS' = \{ss' : s\in S, \ s'\in S'\}
$$
is also a multiplicative set of $A$. Then the following holds.

\begin{proposition}
\label{proposition-localize-twice}
Let $\overline{S}$ be the image of $S$ in $S'^{-1}A$, then
$(SS')^{-1}A$ is isomorphic to $\overline{S}^{-1}(S'^{-1}A)$.
\end{proposition}

\begin{proof}
The map sending $x\in A$ to $x/1\in (SS'^{-1})A$ induces a map
sending $x/s\in S'^{-1}A$ to $x/s \in (SS'^{-1})A$, by universal
property. The image of the elements in $\overline{S}$ are invertible
in $(SS'^{-1})A$. By the universal property we get a map
$f : \overline{S}^{-1}(S'^{-1}A) \to (SS'^{-1})A$ which maps
$(x/t')/(s/s')$ to $(x/t')\cdot(s/s')^{-1}$.

\medskip\noindent
On the other hand, the map from $A$ to $\overline{S}^{-1}(S'^{-1}A)$
sending $x\in A$ to $(x/1)/(1/1)$ also induces a map
$g : (SS'^{-1})A \to \overline{S}^{-1}(S'^{-1}A)$ which sends $x/ss'$
to $(x/s')/(s/1)$, by the universal property again. It is
immediately checked that $f$ and $g$ are inverse to each other,
hence they are both isomorphisms.
\end{proof}

\noindent
For the module $M$ we have

\begin{proposition}
\label{proposition-localize-twice-module}
View $S'^{-1}M$ as an $A$-module, then $S^{-1}(S'^{-1}M)$ is
isomorphic to $(SS')^{-1}M$.
\end{proposition}

\begin{proof}
Note that given a $A$-module M, we have not proved any
universal property for $S^{-1}M$. Hence we cannot reason
as in the preceding proof; we have to construct the isomorphism explicitly.

\medskip\noindent
We define the maps as follows
\begin{align*}
& f : S^{-1}(S'^{-1}M) \longrightarrow (SS')^{-1}M, \quad \frac{x/s'}{s}\mapsto
x/ss'\\
& g : (SS')^{-1}M \longrightarrow S^{-1}(S'^{-1}M), \quad x/t\mapsto
\frac{x/s'}{s}\ \text{for some }s\in S, s'\in S', \text{ and }
t = ss'
\end{align*}
We have to check that these homomorphisms are well-defined, that is,
independent the choice of the fraction. This is easily checked and it is also
straightforward to show that they are inverse to each other.
\end{proof}

\noindent
If $u : M \to N$ is an $A$ homomorphism, then the localization indeed
induces a well-defined $S^{-1}A$ homomorphism $S^{-1}u : S^{-1}M \to
S^{-1}N$ which sends $x/s$ to $u(x)/s$. It is immediately checked that
this construction is functorial, so that $S^{-1}$
is actually a functor from the category of $A$-modules to the
category of $S^{-1}A$-modules. Moreover this functor is exact,
as we show in the following proposition.

\begin{proposition}
\label{proposition-localization-exact}
\begin{slogan}
Localization is exact.
\end{slogan}
Let $L\xrightarrow{u} M\xrightarrow{v} N$ is an exact sequence
of $R$-modules. Then
$S^{-1}L \to S^{-1}M \to S^{-1}N$ is also exact.
\end{proposition}

\begin{proof}
First it is clear that $S^{-1}L \to S^{-1}M \to S^{-1}N$ is a complex
since localization is a functor. Next suppose that $x/s$ maps to zero
in $S^{-1}N$ for some $x/s \in S^{-1}M$. Then by definition there is a
$t\in S$ such that $v(xt) = v(x)t = 0$ in $M$, which means
$xt \in \Ker(v)$. By the exactness of $L \to M \to N$ we have
$xt = u(y)$ for some $y$ in $L$. Then $x/s$ is the image of $y/st$.
This proves the exactness.
\end{proof}

\begin{lemma}
\label{lemma-localize-quotient-modules}
Localization respects quotients, i.e. if $N$ is a submodule of
$M$, then $S^{-1}(M/N)\simeq (S^{-1}M)/(S^{-1}N)$.
\end{lemma}

\begin{proof}
From the exact sequence
$$
0 \longrightarrow N \longrightarrow M \longrightarrow M/N \longrightarrow 0
$$
we have
$$
0 \longrightarrow S^{-1}N \longrightarrow S^{-1}M
\longrightarrow S^{-1}(M/N) \longrightarrow 0
$$
The corollary then follows.
\end{proof}

\noindent
If, in the preceding Corollary, we take $N = I$ and $M = A$ for an ideal $I$ of
$A$, we see that $S^{-1}A/S^{-1}I \simeq S^{-1}(A/I)$ as $A$-modules. The next
proposition shows that they are isomorphic as rings.

\begin{proposition}
\label{proposition-localize-quotient}
Let $I$ be an ideal of $A$, $S$ a multiplicative set of $A$. Then
$S^{-1}I$ is an ideal of $S^{-1}A$ and $\overline{S}^{-1}(A/I)$ is
isomorphic to $S^{-1}A/S^{-1}I$, where $\overline{S}$ is
the image of $S$ in $A/I$.
\end{proposition}

\begin{proof}
The fact that $S^{-1}I$ is an ideal is clear since $I$ itself is an
ideal. Define
$$
f : S^{-1}A\longrightarrow \overline{S}^{-1}(A/I), \quad x/s\mapsto
\overline{x}/\overline{s}
$$
where $\overline{x}$ and $\overline{s}$ are the images of $x$ and
$s$ in $A/I$. We shall keep similar notations in this proof.
This map is well-defined by the universal property of
$S^{-1}A$, and $S^{-1}I$ is contained in the kernel of it,
therefore it induces a map
$$
\overline{f} : S^{-1}A/S^{-1}I \longrightarrow \overline{S}^{-1}(A/I), \quad
\overline{x/s}\mapsto \overline{x}/\overline{s}
$$

\medskip\noindent
On the other hand, the map $A \to S^{-1}A/S^{-1}I$ sending $x$ to
$\overline{x/1}$ induces a map $A/I \to S^{-1}A/S^{-1}I$ sending
$\overline{x}$ to $\overline{x/1}$. The image of $\overline{S}$ is
invertible in $S^{-1}A/S^{-1}I$, thus induces a map
$$
g : \overline{S}^{-1}(A/I) \longrightarrow S^{-1}A/S^{-1}I, \quad
\frac{\overline{x}}{\overline{s}}\mapsto \overline{x/s}
$$
by the universal property. It is then clear that $\overline{f}$ and $g$
are inverse to each other, hence are both isomorphisms.
\end{proof}

\noindent
We now consider how submodules behave in localization.

\begin{lemma}
\label{lemma-submodule-localization}
Any submodule $N'$ of $S^{-1}M$ is of the form $S^{-1}N$ for some
$N\subset M$. Indeed one can take $N$ to be the inverse image of
$N'$ in $M$.
\end{lemma}

\begin{proof}
Let $N$ be the inverse image of $N'$ in $M$. Then one can see that
$S^{-1}N\supset N'$. To show they are equal, take $x/s$ in
$S^{-1}N$, where $s\in S$ and $x\in N$. This yields that $x/1\in
N'$. Since $N'$ is an $S^{-1}R$-submodule we have
$x/s = x/1\cdot 1/s\in N'$. This finishes the proof.
\end{proof}

\noindent
Taking $M = A$ and $N = I$ an ideal of $A$, we have the following
corollary, which can be viewed as a converse of the first part of
Proposition \ref{proposition-localize-quotient}.

\begin{lemma}
\label{lemma-ideal-in-localization}
\begin{slogan}
Ideals in the localization of a ring are localizations of ideals.
\end{slogan}
Each ideal $I'$ of $S^{-1}A$ takes the form $S^{-1}I$, where one can
take $I$ to be the inverse image of $I'$ in $A$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-submodule-localization}.
\end{proof}










\section{Internal Hom}
\label{section-hom}

\noindent
If $R$ is a ring, and $M$, $N$ are $R$-modules, then
$$
\Hom_R(M, N) = \{ \varphi : M \to N\}
$$
is the set of $R$-linear maps from $M$ to $N$. This set comes with
the structure of an abelian group by setting
$(\varphi + \psi)(m) = \varphi(m) + \psi(m)$, as usual.
In fact, $\Hom_R(M, N)$ is also an $R$-module via the rule
$(x \varphi)(m) = x \varphi(m) = \varphi(xm)$.

\medskip\noindent
Given maps $a : M \to M'$ and $b : N \to N'$ of $R$-modules, we can
pre-compose and post-compose homomorphisms by $a$ and $b$. This leads
to the following commutative diagram
$$
\xymatrix{
\Hom_R(M', N) \ar[d]_{- \circ a} \ar[r]_{b \circ -} &
\Hom_R(M', N') \ar[d]^{- \circ a} \\
\Hom_R(M, N) \ar[r]^{b \circ -} &
\Hom_R(M, N')
}
$$
In fact, the maps in this diagram are $R$-module maps.
Thus $\Hom_R$ defines an additive functor
$$
\text{Mod}_R^{opp} \times \text{Mod}_R \longrightarrow \text{Mod}_R, \quad
(M, N) \longmapsto \Hom_R(M, N)
$$

\begin{lemma}
\label{lemma-hom-exact}
Exactness and $\Hom_R$. Let $R$ be a ring.
\begin{enumerate}
\item Let $M_1 \to M_2 \to M_3 \to 0$ be a complex of $R$-modules.
Then $M_1 \to M_2 \to M_3 \to 0$ is exact if and only if
$0 \to \Hom_R(M_3, N) \to \Hom_R(M_2, N) \to \Hom_R(M_1, N)$
is exact for all $R$-modules $N$.
\item  Let $0 \to M_1 \to M_2 \to M_3$ be a complex of $R$-modules.
Then $0 \to M_1 \to M_2 \to M_3$ is exact if and only if
$0 \to \Hom_R(N, M_1) \to \Hom_R(N, M_2) \to \Hom_R(N, M_3)$
is exact for all $R$-modules $N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-finitely-presented}
Let $R$ be a ring. Let $M$ be a finitely presented $R$-module.
Let $N$ be an $R$-module.
\begin{enumerate}
\item For $f \in R$ we have
$\Hom_R(M, N)_f = \Hom_{R_f}(M_f, N_f) = \Hom_R(M_f, N_f)$,
\item for a multiplicative subset $S$ of $R$ we have
$$
S^{-1}\Hom_R(M, N) = \Hom_{S^{-1}R}(S^{-1}M, S^{-1}N) =
\Hom_R(S^{-1}M, S^{-1}N).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a special case of part (2).
The second equality in (2) follows from
Lemma \ref{lemma-universal-property-localization-module}.
Choose a presentation
$$
\bigoplus\nolimits_{j = 1, \ldots, m} R
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} R
\to M \to 0.
$$
By
Lemma \ref{lemma-hom-exact}
this gives an exact sequence
$$
0 \to
\Hom_R(M, N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} N.
$$
Inverting $S$ and using Proposition \ref{proposition-localization-exact}
we get an exact sequence
$$
0 \to
S^{-1}\Hom_R(M, N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}N
$$
and the result follows since $S^{-1}M$ sits in
an exact sequence
$$
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}R
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}R \to S^{-1}M \to 0
$$
which induces (by Lemma \ref{lemma-hom-exact})
the exact sequence
$$
0 \to
\Hom_{S^{-1}R}(S^{-1}M, S^{-1}N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}N
$$
which is the same as the one above.
\end{proof}


















\section{Tensor products}
\label{section-tensor-product}

\begin{definition}
\label{definition-bilinear}
Let $R$ be a ring, $M, N, P$ be three $R$-modules.
A mapping $f : M \times N \to P$ (where $M \times N$
is viewed only as Cartesian product of two $R$-modules) is said to be
{\it $R$-bilinear} if for each $x \in M$
the mapping $y\mapsto f(x, y)$ of $N$ into $P$ is $R$-linear, and for each
$y\in N$ the mapping $x\mapsto f(x, y)$ is also $R$-linear.
\end{definition}

\begin{lemma}
\label{lemma-tensor-product}
Let $M, N$ be $R$-modules. Then there exists a pair $(T, g)$
where $T$ is an $R$-module, and
$g : M \times N \to T$ an $R$-bilinear
mapping, with the following universal property:
For any $R$-module $P$ and any $R$-bilinear mapping
$f : M \times N \to P$, there
exists a unique $R$-linear
mapping $\tilde{f} : T \to P$ such that $f = \tilde{f} \circ g$.
In other words, the following diagram commutes:
$$
\xymatrix{
M \times N \ar[rr]^f \ar[dr]_g & & P\\
& T \ar[ur]_{f'}
}
$$
Moreover, if $(T, g)$ and $(T', g')$
are two pairs with this property, then there
exists a unique isomorphism
$j : T \to T'$ such that $j\circ g = g'$.
\end{lemma}

\noindent
The $R$-module $T$ which satisfies the above universal property is called
the  {\it tensor product} of $R$-modules $M$ and $N$, denoted as
$M \otimes_R N$.

\begin{proof}
We first prove the existence of such $R$-module $T$.
Let $M, N$ be $R$-modules.
Let $T$ be the quotient module
$P/Q$, where $P$ is the free $R$-module $R^{(M \times N)}$ and $Q$ is the
$R$-module generated by all elements of
the following types: ($x\in M, y\in N$)
\begin{align*}
(x + x', y) - (x, y) - (x', y), \\
(x, y + y') - (x, y) - (x, y'), \\
(ax, y) - a(x, y), \\
(x, ay) - a(x, y)
\end{align*}
Let $\pi : M \times N \to T$ denote the natural map.
This map is $R$-bilinear, as
implied by the above relations
when we check the bilinearity conditions. Denote the image
$\pi(x, y) = x \otimes
y$, then these elements generate
$T$. Now let $f : M \times N \to P$ be an $R$-bilinear map,
then we can define
$f' : T \to P$ by extending the mapping
$f'(x \otimes y) = f(x, y)$. Clearly $f = f'\circ \pi$. Moreover, $f'$ is
uniquely determined by the value on the
generating sets $\{x \otimes y : x\in M, y\in N\}$.
Suppose there is another pair $(T', g')$ satisfying the same properties.
Then there is a unique $j : T \to T'$ and
also $j' : T' \to T$ such that $g' = j\circ g$, $g = j'\circ g'$.
But then both the maps $(j\circ j') \circ g$ and $g$
satisfies the universal properties, so by uniqueness they are equal,
and hence $j'\circ j$ is identity on $T$.
Similarly $(j'\circ j) \circ g' = g'$ and $j\circ j'$ is identity on $T'$.
So $j$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-flip-tensor-product}
Let $M, N, P$ be $R$-modules, then the bilinear maps
\begin{align*}
(x, y) & \mapsto y \otimes x\\
(x + y, z) & \mapsto x \otimes z + y \otimes z\\
(r, x) & \mapsto rx
\end{align*}
induce unique isomorphisms
\begin{align*}
M \otimes_R N & \to N \otimes_R M, \\
(M\oplus N)\otimes_R P & \to (M \otimes_R P)\oplus(N \otimes_R P),  \\
R \otimes_R M & \to M
\end{align*}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
We may generalize the tensor product of two $R$-modules to finitely many
$R$-modules, and set up a
correspondence between the multi-tensor product with multilinear mappings.
Using almost the same construction
one can prove that:

\begin{lemma}
\label{lemma-multilinear}
Let $M_1, \ldots, M_r$ be $R$-modules. Then there exists a pair $(T, g)$
consisting of an $R$-module T and an $R$-multilinear mapping
$g : M_1\times \ldots \times M_r \to T$ with the universal
property: For any $R$-multilinear mapping
$f : M_1\times \ldots \times M_r \to P$ there exists a unique $R$-module
homomorphism $f' : T \to P$ such that $f'\circ g = f$.
Such a module $T$ is unique up to unique isomorphism. We denote it
$M_1\otimes_R \ldots \otimes_R M_r$ and we denote the universal
multilinear map $(m_1, \ldots, m_r) \mapsto m_1 \otimes \ldots \otimes m_r$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-transitive}
The homomorphisms
$$
(M \otimes_R N)\otimes_R P \to
M \otimes_R N \otimes_R P \to
M \otimes_R (N \otimes_R P)
$$
such that
$f((x \otimes y)\otimes z) = x \otimes y \otimes z$
and $g(x \otimes y \otimes z) = x \otimes (y \otimes z)$,
$x\in M, y\in N, z\in P$ are well-defined and are isomorphisms.
\end{lemma}

\begin{proof}
We shall prove $f$ is well-defined and is an isomorphism, and this proof
carries analogously to $g$. Fix any
$z\in P$, then the mapping $(x, y)\mapsto x \otimes y \otimes z$,
$x\in M, y\in N$, is $R$-bilinear in $x$ and $y$,
and hence induces homomorphism $f_z : M \otimes N \to M \otimes N \otimes P$
which sends
$f_z(x \otimes y) = x \otimes y \otimes z$.
Then consider $(M \otimes N)\times P \to M \otimes N \otimes P$ given by
$(w, z)\mapsto f_z(w)$. The map is
$R$-bilinear and thus induces
$f : (M \otimes_R N)\otimes_R P \to M \otimes_R N \otimes_R P$
and $f((x \otimes y)\otimes z) = x \otimes y \otimes z$.
To construct the inverse, we note that the map
$\pi : M \times N \times P \to (M \otimes N)\otimes P$ is
$R$-trilinear.
Therefore, it induces an $R$-linear map
$h : M \otimes N \otimes P \to (M \otimes N)\otimes P$ which
agrees with the universal property. Here we see that
$h(x \otimes y \otimes z) = (x \otimes y)\otimes z$.
From the explicit expression of $f$ and $h$, $f\circ h$ and $h\circ f$ are
identity maps of $M \otimes N \otimes
P$ and $(M \otimes N)\otimes P$ respectively, hence $f$ is our desired
isomorphism.
\end{proof}

\noindent
Doing induction we see that this extends to multi-tensor products. Combined
with Lemma \ref{lemma-flip-tensor-product} we see that
the tensor product operation on the category of $R$-modules is associative,
commutative and distributive.

\begin{definition}
\label{definition-bimodule}
An abelian group $N$ is called an {\it $(A, B)$-bimodule} if it is both an
$A$-module and a $B$-module, and
the actions $A \to End(M)$ and $B \to End(M)$
are compatible in the sense that $(ax)b = a(xb)$ for all
$a\in A, b\in B, x\in N$. Usually we denote it as $_AN_B$.
\end{definition}

\begin{lemma}
\label{lemma-tensor-with-bimodule}
For $A$-module $M$, $B$-module $P$ and $(A, B)$-bimodule $N$, the modules
$(M \otimes_A N)\otimes_B P$ and $M \otimes_A(N \otimes_B P)$ can both be
given $(A, B)$-bimodule structure,
and moreover
$$
(M \otimes_A N)\otimes_B P \cong M \otimes_A(N \otimes_B P).
$$
\end{lemma}

\begin{proof}
A priori $M \otimes_A N$ is an $A$-module, but we can give it a
$B$-module structure by letting
$$
(x \otimes y)b = x \otimes yb, \quad x\in M, y\in N, b\in B
$$
Thus $M \otimes_A N$ becomes an $(A, B)$-bimodule. Similarly for
$N \otimes_B P$, and thus for
$(M \otimes_A N)\otimes_B P$ and $M \otimes_A(N \otimes_B P)$. By
Lemma \ref{lemma-transitive}, these two
modules are isomorphic as both as $A$-module and $B$-module via the same
mapping.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-tensor-product}
For any three $R$-modules $M, N, P$,
$$
\Hom_R(M \otimes_R N, P) \cong \Hom_R(M, \Hom_R(N, P))
$$
\end{lemma}

\begin{proof}
An $R$-linear map $\hat{f}\in \Hom_R(M \otimes_R N, P)$ corresponds to an
$R$-bilinear map $f : M \times N \to P$. For
each $x\in M$ the mapping $y\mapsto f(x, y)$ is $R$-linear by the universal
property. Thus $f$ corresponds to a
map $\phi_f : M \to \Hom_R(N, P)$. This map is $R$-linear since
$$
\phi_f(ax + y)(z) =
f(ax + y, z) = af(x, z)+f(y, z) =
(a\phi_f(x)+\phi_f(y))(z),
$$
for all $a \in R$, $x \in M$, $y \in M$ and
$z \in N$. Conversely, any
$f \in \Hom_R(M, \Hom_R(N, P))$ defines an $R$-bilinear
map $M \times N \to P$, namely $(x, y)\mapsto f(x)(y)$.
So this is a natural one-to-one correspondence between the
two modules
$\Hom_R(M \otimes_R N, P)$ and $\Hom_R(M, \Hom_R(N, P))$.
\end{proof}

\begin{lemma}[Tensor products commute with colimits]
\label{lemma-tensor-products-commute-with-limits}
Let $(M_i, \mu_{ij})$ be a system over the preordered set $I$.
Let $N$ be an $R$-module. Then
$$
\colim (M_i \otimes N) \cong (\colim M_i)\otimes N.
$$
Moreover, the isomorphism is induced by the homomorphisms
$\mu_i \otimes 1: M_i \otimes N \to M \otimes N$
where $M = \colim_i M_i$ with natural maps $\mu_i : M_i \to M$.
\end{lemma}

\begin{proof}
First proof. The functor $M' \mapsto M' \otimes_R N$ is left adjoint
to the functor $N' \mapsto \Hom_R(N, N')$ by
Lemma \ref{lemma-hom-from-tensor-product}. Thus $M' \mapsto M' \otimes_R N$
commutes with all colimits, see
Categories, Lemma \ref{categories-lemma-adjoint-exact}.

\medskip\noindent
Second direct proof. Let $P = \colim (M_i \otimes N)$, $M = \colim M_i$.
Then for all $i\leq j$, the following diagram commutes:
$$
\xymatrix{
M_i \otimes N \ar[r]_{\mu_i \otimes 1} \ar[d]_{\mu_{ij} \otimes 1} &
M \otimes N \ar[d]^{\text{id}} \\
M_j \otimes N \ar[r]^{\mu_j \otimes 1} &
M \otimes N
}
$$
By Lemma \ref{lemma-homomorphism-limit},
these maps induce a unique homomorphism
$\psi : P \to M \otimes N$, with $\lambda_i : M_i \otimes N \to P$ given by
$\lambda_i = \pi \circ (\iota_i \otimes 1)$.

\medskip\noindent
To construct the inverse map, for each $i\in I$, there is the canonical
$R$-bilinear mapping $g_i : M_i \times N \to
M_i \otimes N$. This induces a unique mapping
$\widehat{\phi} : M \times N \to P$
such that $\widehat{\phi} \circ (\mu_i \times 1) = \lambda_i \circ g_i$.
It is $R$-bilinear. Thus it induces an
$R$-linear mapping $\phi : M \otimes N \to P$.
From the commutative diagram below:
$$
\xymatrix{
M_i \times N \ar[r]^{g_i} \ar[d]^{\mu_i \times \text{id}} &
M_i \otimes N\ar[r]_{\text{id}} \ar[d]_{\lambda_i} &
M_i \otimes N \ar[d]_{\mu_i \otimes \text{id}} \ar[rd]^{\lambda_i} \\
M \times N \ar[r]^{\widehat{\phi}} &
P \ar[r]^{\psi} & M \otimes N \ar[r]^{\phi} & P
}
$$
we see that $\psi\circ\widehat{\phi} = g$, the canonical $R$-bilinear mapping
$g : M \times N \to M \otimes N$. So
$\psi\circ\phi$ is identity on $M \otimes N$. From the right-hand square and
triangle, $\phi\circ\psi$ is also
identity on $P$.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-exact}
Let
\begin{align*}
M_1\xrightarrow{f} M_2\xrightarrow{g} M_3 \to 0
\end{align*}
be an exact sequence of $R$-modules and homomorphisms, and let $N$ be any
$R$-module. Then the sequence
\begin{equation}
\label{equation-2ndex}
M_1\otimes N\xrightarrow{f \otimes 1} M_2\otimes N \xrightarrow{g \otimes 1}
M_3\otimes N \to 0
\end{equation}
is exact. In other words, the functor $- \otimes_R N$ is
{\it right exact}, in the sense that tensoring
each term in the original right exact sequence preserves the exactness.
\end{lemma}

\begin{proof}
We apply the functor $\Hom(-, \Hom(N, P))$ to the first exact
sequence. We obtain
$$
0 \to
\Hom(M_3, \Hom(N, P)) \to
\Hom(M_2, \Hom(N, P)) \to
\Hom(M_1, \Hom(N, P))
$$
By Lemma \ref{lemma-hom-from-tensor-product}, we have
$$
0 \to \Hom(M_3 \otimes N, P) \to
\Hom(M_2 \otimes N, P) \to \Hom(M_1 \otimes N, P)
$$
Using the pullback property again, we arrive at the desired exact sequence.
\end{proof}

\begin{remark}
\label{remark-tensor-product-not-exact}
However, tensor product does NOT preserve exact sequences in general.
In other words, if $M_1 \to M_2 \to M_3$ is
exact, then it is not necessarily true that
$M_1 \otimes N \to M_2 \otimes N \to M_3 \otimes N$
is exact for arbitrary $R$-module $N$.
\end{remark}

\begin{example}
\label{example-tensor-product-not-exact}
Consider the injective map $2 : \mathbf{Z}\to \mathbf{Z}$
viewed as a map of $\mathbf{Z}$-modules.
Let $N = \mathbf{Z}/2$. Then the induced map
$\mathbf{Z} \otimes \mathbf{Z}/2 \to \mathbf{Z} \otimes \mathbf{Z}/2$
is NOT injective. This is because for
$x \otimes y\in \mathbf{Z} \otimes \mathbf{Z}/2$,
$$
(2 \otimes 1)(x \otimes y) = 2x \otimes y = x \otimes 2y = x \otimes 0 = 0
$$
Therefore the induced map is the zero map while $\mathbf{Z} \otimes N\neq 0$.
\end{example}

\begin{remark}
\label{remark-flat-module}
For $R$-modules $N$, if the
functor $-\otimes_R N$ is exact, i.e. tensoring
with $N$ preserves all exact
sequences, then $N$ is said to be {\it flat} $R$-module.
We will discuss this later in Section \ref{section-flat}.
\end{remark}

\begin{lemma}
\label{lemma-tensor-finiteness}
Let $R$ be a ring. Let $M$ and $N$ be $R$-modules.
\begin{enumerate}
\item If $N$ and $M$ are finite, then so is $M \otimes_R N$.
\item If $N$ and $M$ are finitely presented, then so is $M \otimes_R N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $M$ is finite. Then choose a presentation
$0 \to K \to R^{\oplus n} \to M \to 0$. This gives an exact sequence
$K \otimes_R N \to N^{\oplus n} \to M \otimes_R N \to 0$ by
Lemma \ref{lemma-tensor-product-exact}.
We conclude that if $N$ is finite too then $M \otimes_R N$
is a quotient of a finite module, hence finite, see
Lemma \ref{lemma-extension}.
Similarly, if both $N$ and $M$ are finitely presented, then
we see that $K$ is finite and that $M \otimes_R N$
is a quotient of the finitely presented module $N^{\oplus n}$ by
a finite module, namely $K \otimes_R N$, and hence finitely presented, see
Lemma \ref{lemma-extension}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-localization}
Let $M$ be an $R$-module. Then the $S^{-1}R$-modules $S^{-1}M$
and $S^{-1}R \otimes_R M$ are canonically isomorphic, and the
canonical isomorphism $f : S^{-1}R \otimes_R M \to S^{-1}M$
is given by
$$
f((a/s) \otimes m) = am/s, \forall a \in R, m \in M, s \in S
$$
\end{lemma}

\begin{proof}
Obviously, the map
$f' : S^{-1}R \times M \to S^{-1}M$ given by $f((a/s, m)) = am/s$ is
bilinear, and thus by the
universal property, this map induces a unique $S^{-1}R$-module homomorphism
$f : S^{-1}R \otimes_R M \to S^{-1}M$ as in the statement of the lemma.
Actually every element in $S^{-1}M$ is of the form $m/s$, $m\in M, s\in S$ and
every element in
$S^{-1}R \otimes_R M$ is of the form $1/s \otimes m$. To see the latter fact,
write an element in
$S^{-1}R \otimes_R M$ as
$$
\sum_k \frac{a_k}{s_k} \otimes m_k =
\sum_k \frac{a_k t_k}{s} \otimes m_k =
\frac{1}{s} \otimes \sum_k {a_k t_k}m_k = \frac{1}{s} \otimes m
$$
Where $m = \sum_k {a_k t_k}m_k$. Then it is obvious that $f$ is surjective,
and if $f(\frac{1}{s} \otimes m) = m/s = 0$ then there exists $t'\in S$ with
$tm = 0$ in $M$. Then we have
$$
\frac{1}{s} \otimes m = \frac{1}{st} \otimes tm = \frac{1}{st} \otimes 0 = 0
$$
Therefore $f$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-localization}
Let $M, N$ be $R$-modules, then there is a canonical
$S^{-1}R$-module isomorphism
$f : S^{-1}M \otimes_{S^{-1}R}S^{-1}N \to S^{-1}(M \otimes_R N)$,
given by
$$
f((m/s)\otimes(n/t)) = (m \otimes n)/st
$$
\end{lemma}

\begin{proof}
We may use Lemma \ref{lemma-tensor-with-bimodule}
and Lemma \ref{lemma-tensor-localization} repeatedly to
see that these two
$S^{-1}R$-modules are isomorphic, noting that $S^{-1}R$ is an
$(R, S^{-1}R)$-bimodule:
\begin{align*}
S^{-1}(M \otimes_R N) & \cong S^{-1}R \otimes_R (M \otimes_R N)\\
 & \cong S^{-1}M \otimes_R N\\
 & \cong (S^{-1}M \otimes_{S^{-1}R}S^{-1}R)\otimes_R N\\
 & \cong S^{-1}M \otimes_{S^{-1}R}(S^{-1}R \otimes_R N)\\
 & \cong S^{-1}M \otimes_{S^{-1}R}S^{-1}N
\end{align*}
This isomorphism is easily seen to be the one stated in the lemma.
\end{proof}















\section{Tensor algebra}
\label{section-tensor-algebra}

\noindent
Let $R$ be a ring. Let $M$ be an $R$-module.
We define the {\it tensor algebra of $M$ over $R$} to
be the noncommutative $R$-algebra
$$
\text{T}(M) = \text{T}_R(M) =
\bigoplus\nolimits_{n \geq 0} \text{T}^n(M)
$$
with
$\text{T}^0(M) = R$,
$\text{T}^1(M) = M$,
$\text{T}^2(M) = M \otimes_R M$,
$\text{T}^3(M) = M \otimes_R M \otimes_R M$, and so on.
Multiplication is defined by the rule that on pure tensors we have
$$
(x_1 \otimes x_2 \otimes \ldots \otimes x_n)
\cdot
(y_1 \otimes y_2 \otimes \ldots \otimes y_m)
=
x_1 \otimes x_2 \otimes \ldots \otimes x_n \otimes
y_1 \otimes y_2 \otimes \ldots \otimes y_m
$$
and we extend this by linearity.

\medskip\noindent
We define the {\it exterior algebra $\wedge(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\wedge^n(M)$ is denoted $x_1 \wedge \ldots \wedge x_n$.
These elements generate $\wedge^n(M)$, they are $R$-linear
in each $x_i$ and they are zero when two of the $x_i$ are equal
(i.e., they are alternating as functions of
$x_1, x_2, \ldots, x_n$). The multiplication on $\wedge(M)$ is
graded commutative, i.e., every $x \in M$ and $y \in M$
satisfy $x \wedge y = - y \wedge x$.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case $\wedge(M)$ is free over
$R$ with basis the elements
$$
x_{i_1} \wedge \ldots \wedge x_{i_r}
$$
with $0 \leq r \leq n$ and $1 \leq i_1 < i_2 < \ldots < i_r \leq n$.

\medskip\noindent
We define the {\it symmetric algebra $\text{Sym}(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes y - y \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\text{Sym}^n(M)$ is denoted just $x_1 \ldots x_n$.
These elements generate $\text{Sym}^n(M)$, these are $R$-linear
in each $x_i$ and $x_1 \ldots x_n = x_1' \ldots x_n'$ if the
sequence of elements $x_1, \ldots, x_n$ is a permutation of the
sequence $x_1', \ldots, x_n'$. Thus we see that $\text{Sym}(M)$
is commutative.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case
$\text{Sym}(M) = R[x_1, \ldots, x_n]$ is a polynomial algebra.

\begin{lemma}
\label{lemma-free-tensor-algebra}
Let $R$ be a ring. Let $M$ be an $R$-module.
If $M$ is a free $R$-module, so is each symmetric and exterior power.
\end{lemma}

\begin{proof}
Omitted, but see above for the finite free case.
\end{proof}

\begin{lemma}
\label{lemma-presentation-sym-exterior}
Let $R$ be a ring.
Let $M_2 \to M_1 \to M \to 0$ be an exact sequence of $R$-modules.
There are exact sequences
$$
M_2 \otimes_R \text{Sym}^{n - 1}(M_1)
\to
\text{Sym}^n(M_1)
\to
\text{Sym}^n(M)
\to
0
$$
and similarly
$$
M_2 \otimes_R \wedge^{n - 1}(M_1)
\to
\wedge^n(M_1)
\to
\wedge^n(M)
\to
0
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-present-sym-wedge}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $x_i$, $i \in I$ be a given system of generators of
$M$ as an $R$-module. Let $n \geq 2$.
There exists a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\oplus
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\wedge^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ in the first
summand maps to
\begin{align*}
\underbrace{
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_1} \text{ and } x_{i_2}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}} \\
+
\underbrace{
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_2} \text{ and } x_{i_1}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
\end{align*}
and $m_1 \otimes \ldots \otimes m_{n - 2}$ in the second
summand maps to
$$
\underbrace{
m_1 \otimes \ldots \otimes x_i \otimes \ldots
\otimes x_i \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i} \text{ and } x_{i}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
$$
There is also a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\text{Sym}^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ maps to
\begin{align*}
\underbrace{
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_1} \text{ and } x_{i_2}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}} \\
-
\underbrace{
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_2} \text{ and } x_{i_1}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
\end{align*}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimit-tensor-algebra}
\begin{slogan}
Taking tensor algebras commutes with filtered colimits.
\end{slogan}
Let $R$ be a ring. Let $M_i$ be a directed system of
$R$-modules. Then
$\colim_i \text{T}(M) = \text{T}(\colim_i M_i)$
and similarly for the symmetric and exterior algebras.
\end{lemma}

\begin{proof}
Omitted. Hint: Apply Lemma \ref{lemma-tensor-products-commute-with-limits}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-algebra-localization}
Let $R$ be a ring and let $S \subset R$ be a multiplicative subset.
Then $S^{-1}T_R(M) = T_{S^{-1}R}(S^{-1}M)$ for any $R$-module $M$.
Similar for symmetric and exterior algebras.
\end{lemma}

\begin{proof}
Omitted. Hint: Apply Lemma \ref{lemma-tensor-product-localization}.
\end{proof}









\section{Base change}
\label{section-base-change}

\noindent
We formally introduce base change in algebra as follows.

\begin{definition}
\label{definition-base-change}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Let $R \to R'$ be any ring map. The {\it base change} of $\varphi$
by $R \to R'$ is the ring map $R' \to S \otimes_R R'$. In this situation
we often write $S' = S \otimes_R R'$.
The {\it base change} of the $S$-module $M$ is the $S'$-module
$M \otimes_R R'$.
\end{definition}

\noindent
If $S = R[x_i]/(f_j)$ for some collection of variables $x_i$, $i \in I$
and some collection of polynomials $f_j \in R[x_i]$, $j \in J$, then
$S \otimes_R R' = R'[x_i]/(f'_j)$, where $f'_j \in R'[x_i]$ is the image
of $f_j$ under the map $R[x_i] \to R'[x_i]$ induced by $R \to R'$.
This simple remark is the key to understanding base change.

\begin{lemma}
\label{lemma-base-change-finiteness}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and let $S' = S \otimes_R R'$ and
$M' = M \otimes_R R'$ be the base changes.
\begin{enumerate}
\item If $M$ is a finite $S$-module, then the base change
$M'$ is a finite $S'$-module.
\item If $M$ is an $S$-module finite presentation, then
the base change $M'$ is an $S'$-module of finite presentation.
\item If $R \to S$ is of finite type, then the base change
$R' \to S'$ is of finite type.
\item If $R \to S$ is of finite presentation, then
the base change $R' \to S'$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Take a surjective, $S$-linear map
$S^{\oplus n} \to M \to 0$.
By Lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact}
the result after tensoring with $R^\prime$ is a surjection
${S^\prime}^{\oplus n} \to M^\prime \rightarrow 0$,
so $M^\prime$ is a finitely generated $S^\prime$-module.
Proof of (2). Take a presentation
$S^{\oplus m} \to S^{\oplus n} \to M \to 0$.
By Lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact}
the result after tensoring with $R^\prime$ gives a finite presentation
${S^\prime}^{\oplus m} \to {S^\prime}^{\oplus n} \to M^\prime \to 0$, of
the $S^\prime$-module $M^\prime$. Proof of (3). This follows by the remark
preceding the lemma as we can take $I$ to be finite by assumption.
Proof of (4). This follows by the remark preceding the lemma
as we can take $I$ and $J$ to be finite by assumption.
\end{proof}

\noindent
Let $\varphi : R \to S$ be a ring map. Given an $S$-module $N$ we
obtain an $R$-module $N_R$ by the rule $r \cdot n = \varphi(r)n$.
This is sometimes called the {\it restriction} of $N$ to $R$.

\begin{lemma}
\label{lemma-adjoint-tensor-restrict}
Let $R \to S$ be a ring map. The functors
$\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction)
and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto M \otimes_R S$
(base change) are adjoint functors. In a formula
$$
\Hom_R(M, N_R) = \Hom_S(M \otimes_R S, N)
$$
\end{lemma}

\begin{proof}
If $\alpha : M \to N_R$ is an $R$-module map, then we define
$\alpha' : M \otimes_R S \to N$ by the rule
$\alpha'(m \otimes s) = s\alpha(m)$. If $\beta : M \otimes_R S \to N$
is an $S$-module map, we define $\beta' : M \to N_R$ by the rule
$\beta'(m) = \beta(m \otimes 1)$.
We omit the verification that these constructions are mutually inverse.
\end{proof}

\noindent
The lemma above tells us that restriction has a left adjoint, namely
base change. It also has a right adjoint.

\begin{lemma}
\label{lemma-adjoint-hom-restrict}
Let $R \to S$ be a ring map. The functors
$\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction)
and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto \Hom_R(S, M)$
are adjoint functors. In a formula
$$
\Hom_R(N_R, M) = \Hom_S(N, \Hom_R(S, M))
$$
\end{lemma}

\begin{proof}
If $\alpha : N_R \to M$ is an $R$-module map, then we define
$\alpha' : N \to \Hom_R(S, M)$ by the rule
$\alpha'(n) = (s \mapsto \alpha(sn))$. If $\beta : N \to \Hom_R(S, M)$
is an $S$-module map, we define $\beta' : N_R \to M$ by the rule
$\beta'(n) = \beta(n)(1)$.
We omit the verification that these constructions are mutually inverse.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-tensor-product-variant}
Let $R \to S$ be a ring map. Given $S$-modules $M, N$ and an $R$-module $P$
we have
$$
\Hom_R(M \otimes_S N, P) = \Hom_S(M, \Hom_R(N, P))
$$
\end{lemma}

\begin{proof}
This can be proved directly, but it is also a consequence of
Lemmas \ref{lemma-adjoint-hom-restrict} and \ref{lemma-hom-from-tensor-product}.
Namely, we have
\begin{align*}
\Hom_R(M \otimes_S N, P)
& =
\Hom_S(M \otimes_S N, \Hom_R(S, P)) \\
& =
\Hom_S(M, \Hom_S(N, \Hom_R(S, P))) \\
& =
\Hom_S(M, \Hom_R(N, P))
\end{align*}
as desired.
\end{proof}








\section{Miscellany}
\label{section-miscellany}

\noindent
The proofs in this section should not refer to any results except
those from the section on basic notions, Section \ref{section-rings-basic}.

\begin{lemma}
\label{lemma-product-ideals-in-prime}
Let $R$ be a ring, $I$ and $J$ two ideals and $\mathfrak p$ a prime ideal
containing the product $IJ$. Then $\mathfrak{p}$ contains $I$ or $J$.
\end{lemma}

\begin{proof}
Assume the contrary and take $x \in I \setminus \mathfrak p$ and
$y \in J \setminus \mathfrak p$. Their product is an element of
$IJ \subset \mathfrak p$, which contradicts the assumption that
$\mathfrak p$ was prime.
\end{proof}

\begin{lemma}[Prime avoidance]
\label{lemma-silly}
\begin{slogan}
In an affine scheme if a finite number of points are contained in an
open subset then they are contained in a smaller principal open subset.
\end{slogan}
Let $R$ be a ring. Let $I_i \subset R$, $i = 1, \ldots, r$,
and $J \subset R$ be ideals. Assume
\begin{enumerate}
\item $J \not\subset I_i$ for $i = 1, \ldots, r$, and
\item all but two of $I_i$ are prime ideals.
\end{enumerate}
Then there exists an $x \in J$, $x\not\in I_i$ for all $i$.
\end{lemma}

\begin{proof}
The result is true for $r = 1$. If $r = 2$, then let $x, y \in J$ with
$x \not \in I_1$ and $y \not \in I_2$. We are done unless $x \in I_2$
and $y \in I_1$. Then the element $x + y$ cannot be in $I_1$ (since that
would mean $x + y - y \in I_1$) and it also cannot be in $I_2$.

\medskip\noindent
For $r \geq 3$, assume the result holds for $r - 1$. After renumbering
we may assume that $I_r$ is prime. We may also assume there are no
inclusions among the $I_i$. Pick $x \in J$, $x \not \in I_i$ for all
$i = 1, \ldots, r - 1$. If $x \not\in I_r$ we are done. So assume
$x \in I_r$. If $J I_1 \ldots I_{r - 1} \subset I_r$ then
$J \subset I_r$ (by Lemma \ref{lemma-product-ideals-in-prime}) a contradiction.
Pick $y \in J I_1 \ldots I_{r - 1}$, $y \not \in I_r$. Then $x + y$ works.
\end{proof}

\begin{lemma}[Chinese remainder]
\label{lemma-chinese-remainder}
Let $R$ be a ring.
\begin{enumerate}
\item If $I_1, \ldots, I_r$ are ideals such that $I_a + I_b = R$
when $a \not = b$, then $I_1 \cap \ldots \cap I_r =
I_1I_2\ldots I_r$ and $R/(I_1I_2\ldots I_r)
\cong R/I_1 \times \ldots \times R/I_r$.
\item If $\mathfrak m_1, \ldots, \mathfrak m_r$ are pairwise distinct maximal
ideals then $\mathfrak m_a + \mathfrak m_b = R$ for $a \not = b$ and the
above applies.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us first prove $I_1 \cap \ldots \cap I_r = I_1 \ldots I_r$
as this will also imply the injectivity of the induced ring
homomorphism $R/(I_1 \ldots I_r) \rightarrow R/I_1 \times \ldots \times R/I_r$.
The inclusion $I_1 \cap \ldots \cap I_r \supset I_1 \ldots I_r$ is always
fulfilled since ideals are closed under multiplication with arbitrary ring
elements. To prove the other inclusion, we claim that the ideals
$$
I_1 \ldots \hat I_i \ldots I_r,\quad i = 1, \ldots, r
$$
generate the ring $R$. We prove this by induction on $r$. It holds when
$r = 2$. If $r > 2$, then we see that $R$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_{r - 1}$, $i = 1, \ldots, r - 1$.
Hence $I_r$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_r$, $i = 1, \ldots, r - 1$.
Applying the same argument with the reverse ordering on the ideals
we see that $I_1$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_r$, $i = 2, \ldots, r$.
Since $R = I_1 + I_r$ by assumption we see that $R$ is the sum of the
ideals displayed above. Therefore we can find elements
$a_i \in I_1 \ldots \hat I_i \ldots I_r$
such that their sum is one. Multiplying this equation by an element
of $I_1 \cap \ldots \cap I_r$ gives the other inclusion.
It remains to show that the canonical map
$R/(I_1 \ldots I_r) \rightarrow R/I_1 \times \ldots \times R/I_r$
is surjective. For this, consider its action on the equation
$1 = \sum_{i=1}^r a_i$ we derived above. On the one hand, a
ring morphism sends 1 to 1 and on the other hand, the image of any
$a_i$ is zero in $R/I_j$ for $j \neq i$. Therefore, the image of $a_i$
in $R/I_i$ is the identity. So given any element
$(\bar{b_1}, \ldots, \bar{b_r}) \in R/I_1 \times \ldots \times R/I_r$,
the element $\sum_{i=1}^r a_i \cdot b_i$ is an inverse image in $R$.

\medskip\noindent
To see (2), by the very definition of being distinct maximal ideals, we have
$\mathfrak{m}_a + \mathfrak{m}_b = R$ for $a \neq b$ and so the above applies.
\end{proof}

\begin{lemma}
\label{lemma-matrix-left-inverse}
Let $R$ be a ring. Let $n \geq m$. Let $A$ be an
$n \times m$ matrix with coefficients in $R$. Let $J \subset R$
be the ideal generated by the $m \times m$ minors of $A$.
\begin{enumerate}
\item For any $f \in J$ there exists a $m \times n$ matrix $B$
such that $BA = f 1_{m \times m}$.
\item If $f \in R$ and $BA = f 1_{m \times m}$ for some $m \times m$ matrix
$B$, then $f^m \in J$.
\end{enumerate}
\end{lemma}

\begin{proof}
For $I \subset \{1, \ldots, n\}$ with $|I| = m$, we denote
by $E_I$ the $m \times n$ matrix of the projection
$$
R^{\oplus n} = \bigoplus\nolimits_{i \in \{1, \ldots, n\}} R
\longrightarrow \bigoplus\nolimits_{i \in I} R
$$
and set $A_I = E_I A$, i.e., $A_I$ is the $m \times m$ matrix
whose rows are the rows of $A$ with indices in $I$.
Let $B_I$ be the adjugate (transpose of
cofactor) matrix to $A_I$, i.e., such that
$A_I B_I = B_I A_I = \det(A_I) 1_{m \times m}$.
The $m \times m$ minors of $A$ are the determinants $\det A_I$
for all the $I \subset \{1, \ldots, n\}$ with $|I| = m$.
If $f \in J$ then we can write $f = \sum c_I \det(A_I)$ for some
$c_I \in R$. Set $B = \sum c_I B_I E_I$ to see that (1) holds.

\medskip\noindent
If $f 1_{m \times m} = BA$ then by the Cauchy-Binet formula we
have $f^m = \sum b_I \det(A_I)$ where $b_I$ is the determinant
of the $m \times m$ matrix whose columns are the columns of $B$ with
indices in $I$.
\end{proof}

\begin{lemma}
\label{lemma-matrix-right-inverse}
Let $R$ be a ring. Let $n \geq m$. Let $A = (a_{ij})$ be an
$n \times m$ matrix with coefficients in $R$, written in block form
as
$$
A =
\left(
\begin{matrix}
A_1 \\
A_2
\end{matrix}
\right)
$$
where $A_1$ has size $m \times m$. Let $B$ be the adjugate (transpose of
cofactor) matrix to $A_1$. Then
$$
AB = 
\left(
\begin{matrix}
f 1_{m \times m} \\
C
\end{matrix}
\right)
$$
where $f = \det(A_1)$ and $c_{ij}$ is (up to sign) the determinant of the
$m \times m$ minor of $A$ corresponding to the rows
$1, \ldots, \hat j, \ldots, m, i$.
\end{lemma}

\begin{proof}
Since the adjugate has the property $A_1B = B A_1 = f$ the first block
of the expression for $AB$ is correct. Note that
$$
c_{ij} = \sum\nolimits_k a_{ik}b_{kj} = \sum (-1)^{j + k}a_{ik} \det(A_1^{jk})
$$
where $A_1^{ij}$ means $A_1$ with the $j$th row and $k$th column removed.
This last expression is the row expansion of the determinant of the matrix
in the statement of the lemma.
\end{proof}





\section{Cayley-Hamilton}
\label{section-cayley-hamilton}

\begin{lemma}
\label{lemma-charpoly}
Let $R$ be a ring. Let $A = (a_{ij})$ be an $n \times n$
matrix with coefficients in $R$. Let $P(x) \in R[x]$
be the characteristic polynomial of $A$ (defined
as $\det(x\text{id}_{n \times n} - A)$).
Then $P(A) = 0$ in $\text{Mat}(n \times n, R)$.
\end{lemma}

\begin{proof}
We reduce the question to the well-known Cayley-Hamilton
theorem from linear algebra in several steps:
\begin{enumerate}
\item If $\phi :S \rightarrow R$ is a ring morphism and $b_{ij}$
are inverse images of the $a_{ij}$ under this map, then it suffices
to show the statement for $S$ and $(b_{ij})$ since $\phi$ is a ring morphism.
\item If $\psi :R \hookrightarrow S$ is an injective ring morphism, it
clearly suffices to show the result for $S$ and the $a_{ij}$ considered as
elements of $S$. 
\item Thus we may first reduce to the case $R = \mathbf{Z}[X_{ij}]$,
$a_{ij} = X_{ij}$ of a polynomial ring and then further to
the case $R = \mathbf{Q}(X_{ij})$ where we may finally apply Cayley-Hamilton.
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lemma-charpoly-module}
Let $R$ be a ring.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be an endomorphism.
Then there exists a monic polynomial $P \in R[T]$ such that
$P(\varphi) = 0$ as an endomorphism of $M$.
\end{lemma}

\begin{proof}
Choose a surjective $R$-module map $R^{\oplus n} \to M$, given by
$(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in M$.
Choose $(a_{i1}, \ldots, a_{in}) \in R^{\oplus n}$ such that
$\varphi(x_i) = \sum a_{ij} x_j$. In other words the diagram
$$
\xymatrix{
R^{\oplus n} \ar[d]_A \ar[r] & M \ar[d]^\varphi \\
R^{\oplus n} \ar[r] & M
}
$$
is commutative where $A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
there exists a monic polynomial $P$ such that $P(A) = 0$.
Then it follows that $P(\varphi) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-charpoly-module-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be an endomorphism such
that $\varphi(M) \subset IM$.
Then there exists a monic polynomial
$P = t^n + a_1 t^{n - 1} + \ldots + a_n \in R[T]$
such that $a_j \in I^j$ and $P(\varphi) = 0$ as an endomorphism of $M$.
\end{lemma}

\begin{proof}
Choose a surjective $R$-module map $R^{\oplus n} \to M$, given by
$(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in M$.
Choose $(a_{i1}, \ldots, a_{in}) \in I^{\oplus n}$ such that
$\varphi(x_i) = \sum a_{ij} x_j$. In other words the diagram
$$
\xymatrix{
R^{\oplus n} \ar[d]_A \ar[r] & M \ar[d]^\varphi \\
I^{\oplus n} \ar[r] & M
}
$$
is commutative where $A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
the polynomial
$P(t) = \det(t\text{id}_{n \times n} - A)$
has all the desired properties.
\end{proof}

\noindent
As a fun example application we prove the following surprising lemma.

\begin{lemma}
\label{lemma-fun}
Let $R$ be a ring.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be a surjective $R$-module map.
Then $\varphi$ is an isomorphism.
\end{lemma}

\begin{proof}[First proof]
Write $R' = R[x]$ and think of $M$ as a finite $R'$-module with
$x$ acting via $\varphi$. Set $I = (x) \subset R'$. By our assumption that
$\varphi$ is surjective we have $IM = M$. Hence we may apply
Lemma \ref{lemma-charpoly-module-ideal}
to $M$ as an $R'$-module, the ideal $I$ and the endomorphism $\text{id}_M$.
We conclude that
$(1 + a_1 + \ldots + a_n)\text{id}_M = 0$ with $a_j \in I$.
Write $a_j = b_j(x)x$ for some $b_j(x) \in R[x]$.
Translating back into $\varphi$ we see that
$\text{id}_M = -(\sum_{j = 1, \ldots, n} b_j(\varphi)) \varphi$, and hence
$\varphi$ is invertible.
\end{proof}

\begin{proof}[Second proof]
We perform induction on the number of generators of $M$ over $R$. If
$M$ is generated by one element, then $M \cong R/I$ for some ideal
$I \subset R$. In this case we may replace $R$ by $R/I$ so that $M = R$.
In this case $\varphi : R \to R$ is given by multiplication on $M$ by an
element $r \in R$. The surjectivity of $\varphi$ forces $r$ invertible,
since $\varphi$ must hit $1$, which implies that $\varphi$ is
invertible.

\medskip\noindent
Now assume that we have proven the lemma in the case of modules
generated by $n - 1$ elements, and are examining a module $M$ generated
by $n$ elements. Let $A$ mean the ring $R[t]$, and regard the module
$M$ as an $A$-module by letting $t$ act via $\varphi$; since $M$ is
finite over $R$, it is finite over $R[t]$ as well, and since we're
trying to prove $\varphi$ injective, a set-theoretic property, we might
as well prove the endomorphism $t : M \to M$ over $A$ injective. We have
reduced our problem to the case our endomorphism is multiplication by
an element of the ground ring. Let $M' \subset M$ denote the
sub-$A$-module generated by the first $n - 1$ of the generators of $M$,
and consider the diagram
$$
\xymatrix{
0 \ar[r] & M' \ar[r]\ar[d]^{\varphi\mid_{M'}} & M\ar[d]^\varphi \ar[r] &
M/M' \ar[d]^{\varphi \bmod M'} \ar[r] & 0 \\
0 \ar[r] & M' \ar[r]                                  & M \ar[r]
           & M/M' \ar[r]                                  & 0,
}
$$
where the restriction of $\varphi$ to $M'$ and the map induced by $\varphi$
on the quotient $M/M'$ are well-defined since $\varphi$ is multiplication
by an element in the base, and $M'$ and $M/M'$ are $A$-modules in
their own right. By the case $n = 1$ the map $M/M' \to M/M'$ is an
isomorphism. A diagram chase implies that $\varphi|_{M'}$ is surjective
hence by induction $\varphi|_{M'}$ is an isomorphism. This forces the
middle column to be an isomorphism by the snake lemma.
\end{proof}













\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\Spec(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \Spec(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\Spec(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \Spec(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{item-radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \amalg V(f) = \Spec(R)$.
\item If $f \in R$ then $D(f) = \emptyset$ if and only if $f$
is nilpotent.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f, g \in R$, then $D(fg) = D(f) \cap D(g)$.
\item If $f_i \in R$ for $i \in I$, then
$\bigcup_{i\in I} D(f_i)$ is the complement of $V(\{f_i \}_{i\in I})$
in $\Spec(R)$.
\item If $f \in R$ and $D(f) = \Spec(R)$, then $f$ is a unit.
\end{enumerate}
\end{lemma}

\begin{proof}
We address each part in the corresponding item below.
\begin{enumerate}
\item This is a direct consequence of (2) or (3).
\item Let $\mathfrak{A}$ be the set of all proper ideals of $R$. This set is
ordered by inclusion and is non-empty, since $(0) \in \mathfrak{A}$ is a proper
ideal. Let $A$ be a totally ordered subset of $R$. $\bigcup_{I \in A} I$ is in
fact an ideal. Since 1 $\notin I$ for all $I \in A$, the union does not contain
1 and thus is proper. Hence $\bigcup_{I \in A} I$ is in $\mathfrak{A}$ and is
an upper bound for the set $A$. Thus by Zorn's lemma $\mathfrak{A}$ has a
maximal element, which is the sought-after maximal ideal.
\item Since $R$ is nonzero, it contains a maximal ideal which is a prime ideal.
Thus the set $\mathfrak{A}$ of all prime ideals of $R$ is nonempty.
$\mathfrak{A}$ is ordered by reverse-inclusion. Let $A$ be a totally ordered
subset of $\mathfrak{A}$. It's pretty clear that $J = \bigcap_{I \in A} I$ is
in fact an ideal. Not so clear, however, is that it is prime. Let $xy \in J$.
Then $xy \in I$ for all $I \in A$. Now let $B = \{I \in A | y \in I\}$. Let $K
= \bigcap_{I \in B} I$. Since $A$ is totally ordered, either $K = J$ (and we're
done, since then $y \in J$) or $K \supset J$ and for all $I \in A$ such that
$I$ is properly contained in $K$, we have $y \notin I$. But that means that for
all those $I, x \in I$, since they are prime. Hence $x \in J$. In either case,
$J$ is prime as desired. Hence by Zorn's lemma we get a maximal element which
in this case is a minimal prime ideal.
\item This is the same exact argument as (3) except you only consider prime
ideals contained in $\mathfrak{p}$ and containing $I$.
\item $(T)$ is the smallest ideal containing $T$. Hence if $T \subset I$, some
ideal, then $(T) \subset I$ as well. Hence if $I \in V(T)$, then $I \in V((T))$
as well. The other inclusion is obvious.
\item Since $I \subset \sqrt{I}, V(\sqrt{I}) \subset V(I)$. Now let
$\mathfrak{p} \in V(I)$. Let $x \in \sqrt{I}$. Then $x^n \in I$ for some $n$.
Hence $x^n \in \mathfrak{p}$. But since $\mathfrak{p}$ is prime, a boring
induction argument gets you that $x \in \mathfrak{p}$. Hence $\sqrt{I} \subset
\mathfrak{p}$ and $\mathfrak{p} \in V(\sqrt{I})$.
\item Let $f \in R \setminus \sqrt{I}$. Then $f^n \notin I$ for all $n$. Hence
$S = \{1, f, f^2, \ldots\}$ is a multiplicative subset, not containing $0$.
Take a
prime ideal $\bar{\mathfrak{p}} \subset S^{-1}R$ containing $S^{-1}I$. Then the
pull-back $\mathfrak{p}$ in $R$ of $\bar{\mathfrak{p}}$ is a prime ideal
containing $I$ that does not intersect $S$. This shows that $\bigcap_{I \subset
\mathfrak p} \mathfrak p \subset \sqrt{I}$. Now if $a \in \sqrt{I}$, then $a^n
\in I$ for some $n$. Hence if $I \subset \mathfrak{p}$, then $a^n \in
\mathfrak{p}$. But since $\mathfrak{p}$ is prime, we have $a \in \mathfrak{p}$.
Thus the equality is shown.
\item $I$ is not the unit ideal if and only if $I$
is contained in some maximal ideal (to
see this, apply (2) to the ring $R/I$) which is therefore prime.
\item If $\mathfrak{p} \in V(I) \cup V(J)$, then $I \subset \mathfrak{p}$ or $J
\subset \mathfrak{p}$ which means that $I \cap J \subset \mathfrak{p}$. Now if
$I \cap J \subset \mathfrak{p}$, then $IJ \subset \mathfrak{p}$ and hence
either $I$ of $J$ is in $\mathfrak{p}$, since $\mathfrak{p}$ is prime.
\item $\mathfrak{p} \in \bigcap_{a \in A} V(I_a) \Leftrightarrow I_a \subset
\mathfrak{p}, \forall a \in A \Leftrightarrow \mathfrak{p} \in V(\cup_{a\in A}
I_a)$
\item If $\mathfrak{p}$ is a prime ideal and $f \in R$, then either $f \in
\mathfrak{p}$ or $f \notin \mathfrak{p}$ (strictly) which is what the disjoint
union says.
\item If $a \in R$ is nilpotent, then $a^n = 0$ for some $n$. Hence $a^n \in
\mathfrak{p}$ for any prime ideal. Thus $a \in \mathfrak{p}$ as can be shown by
induction and $D(f) = \emptyset$. Now, as shown in (7), if $a \in R$ is not
nilpotent, then there is a prime ideal that does not contain it.
\item $f \in \mathfrak{p} \Leftrightarrow uf \in \mathfrak{p}$, since $u$ is
invertible.
\item If $\mathfrak{p} \notin V(I)$, then $\exists f \in I \setminus
\mathfrak{p}$. Then $f \notin \mathfrak{p}$ so $\mathfrak{p} \in D(f)$. Also if
$\mathfrak{q} \in D(f)$, then $f \notin \mathfrak{q}$ and thus $I$ is not
contained in $\mathfrak{q}$. Thus $D(f) \cap V(I) = \emptyset$.
\item If $fg \in \mathfrak{p}$, then $f \in \mathfrak{p}$ or $g \in
\mathfrak{p}$. Hence if $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$,
then $fg \notin \mathfrak{p}$. Since $\mathfrak{p}$ is an ideal, if $fg \notin
\mathfrak{p}$, then $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$.
\item $\mathfrak{p} \in \bigcup_{i \in I} D(f_i) \Leftrightarrow \exists i \in
I, f_i \notin \mathfrak{p} \Leftrightarrow \mathfrak{p} \in \Spec(R)
\setminus V(\{f_i\}_{i \in I})$
\item If $D(f) = \Spec(R)$, then $V(f) = \emptyset$ and
hence $fR = R$, so $f$ is a unit.
\end{enumerate}
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\Spec(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\Spec(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\Spec(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\Spec(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\Spec(\varphi) : \Spec(R') \longrightarrow \Spec(R),
\quad
\mathfrak p' \longmapsto \varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski topologies. In fact, for any
element $f \in R$ we have
$\Spec(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{item-inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\Spec(R'')
\longrightarrow
\Spec(R')
\longrightarrow
\Spec(R)
$$
equals $\Spec(\varphi' \circ \varphi)$. In other
words, $\Spec$ is a contravariant functor from the
category of rings to the category of topological spaces.

\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\Spec$
a homeomorphism
$$
\Spec(S^{-1}R)
\longrightarrow
\{\mathfrak p \in \Spec(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\Spec(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the right hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset S^{-1}R$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$.
By assumption the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{item-localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{item-localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{item-localize-nonzerodivisors}).
This proves that the map $\Spec(S^{-1}R) \to \Spec(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \Spec(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) =
D(h/1)$ in $\Spec(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\Spec$ a homeomorphism
$$
\Spec(R_f) \longrightarrow D(f) \subset \Spec(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}.
\end{proof}

\noindent
It is not the case that every ``affine open'' of a
spectrum is a standard open. See
Example \ref{example-affine-open-not-standard}.

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\Spec$ a homeomorphism
$$
\Spec(R/I) \longrightarrow V(I) \subset \Spec(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{item-isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}



\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S =
S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
(R \setminus \mathfrak p)^{-1}S/\mathfrak pS \ar[u]
\\
\kappa(\mathfrak p) =
R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows in the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectra
always a homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-in-image}
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak p$
be a prime of $R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is in the image of
$\Spec(S) \to \Spec(R)$,
\item $S \otimes_R \kappa(\mathfrak p) \not = 0$,
\item $S_{\mathfrak p}/\mathfrak p S_{\mathfrak p} \not = 0$,
\item $(S/\mathfrak pS)_{\mathfrak p} \not = 0$, and
\item $\mathfrak p = \varphi^{-1}(\mathfrak pS)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have already seen the equivalence of the first two
in Remark \ref{remark-fundamental-diagram}. The others
are just reformulations of this.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact}
Let $R$ be a ring. The space $\Spec(R)$ is quasi-compact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\Spec(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\Spec(R) = \cup D(f_i)$
for a set of elements $\{f_i\}_{i\in I}$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum:
$1 = \sum_{i \in J} r_i f_i$ with $J \subset I$ finite.
And then it follows that $\Spec(R)
= \cup_{i \in J} D(f_i)$.
\end{proof}

\begin{lemma}
\label{lemma-topology-spec}
Let $R$ be a ring.
The topology on $X = \Spec(R)$ has the following properties:
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ has a basis for the topology consisting of quasi-compact opens, and
\item the intersection of any two quasi-compact opens is quasi-compact.
\end{enumerate}
\end{lemma}

\begin{proof}
The spectrum of a ring is quasi-compact, see
Lemma \ref{lemma-quasi-compact}.
It has a basis for the topology consisting of the standard opens
$D(f) = \Spec(R_f)$
(Lemma \ref{lemma-standard-open})
which are quasi-compact by the first remark.
The intersection of two standard opens is quasi-compact
as $D(f) \cap D(g) = D(fg)$. Given any two quasi-compact opens
$U, V \subset X$ we may write $U = D(f_1) \cup \ldots \cup D(f_n)$
and $V = D(g_1) \cup \ldots \cup D(g_m)$. Then
$U \cap V = \bigcup D(f_ig_j)$ which is quasi-compact.
\end{proof}






\section{Local rings}
\label{section-local-rings}

\noindent
Local rings are the bread and butter of algebraic geometry.

\begin{definition}
\label{definition-local-ring}
A {\it local ring} is a ring with exactly one maximal ideal.
The maximal ideal is often denoted $\mathfrak m_R$ in this case.
We often say ``let $(R, \mathfrak m, \kappa)$ be a local ring''
to indicate that $R$ is local, $\mathfrak m$ is its unique maximal
ideal and $\kappa = R/\mathfrak m$ is its residue field.
A {\it local homomorphism of local rings} is a ring map
$\varphi : R \to S$ such that $R$ and $S$ are local rings and such
that $\varphi(\mathfrak m_R) \subset \mathfrak m_S$.
If it is given that $R$ and $S$ are local rings, then the phrase
``{\it local ring map $\varphi : R \to S$}'' means that $\varphi$
is a local homomorphism of local rings.
\end{definition}

\noindent
A field is a local ring. Any ring map between fields is a local homomorphism
of local rings.

\begin{lemma}
\label{lemma-characterize-local-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a local ring,
\item $\Spec(R)$ has exactly one closed point,
\item $R$ has a maximal ideal $\mathfrak m$
and every element of $R \setminus \mathfrak m$
is a unit, and
\item $R$ is not the zero ring and for every $x \in R$ either $x$
or $1 - x$ is invertible or both.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $R$ be a ring, and $\mathfrak m$ a maximal ideal.
If $x \in R \setminus \mathfrak m$, and $x$ is not a unit
then there is a maximal ideal $\mathfrak m'$ containing $x$.
Hence $R$ has at least two maximal ideals. Conversely,
if $\mathfrak m'$ is another maximal ideal, then choose
$x \in \mathfrak m'$, $x \not \in \mathfrak m$. Clearly
$x$ is not a unit. This proves the equivalence of (1) and (3).
The equivalence (1) and (2) is tautological.
If $R$ is local then (4) holds since $x$ is either in $\mathfrak m$
or not. If (4) holds, and $\mathfrak m$, $\mathfrak m'$ are distinct
maximal ideals then we may choose $x \in R$ such that
$x \bmod \mathfrak m' = 0$ and $x \bmod \mathfrak m = 1$
by the Chinese remainder theorem
(Lemma \ref{lemma-chinese-remainder}).
This element $x$ is not invertible and neither is $1 - x$ which is
a contradiction. Thus (4) and (1) are equivalent.
\end{proof}

\noindent
The localization $R_\mathfrak p$ of a ring $R$ at a prime $\mathfrak p$
is a local ring with maximal ideal $\mathfrak p R_\mathfrak p$. Namely,
the quotient $R_\mathfrak p/\mathfrak pR_\mathfrak p$ is the fraction
field of the domain $R/\mathfrak p$ and every element of $R_\mathfrak p$
which is not contained in $\mathfrak pR_\mathfrak p$ is invertible.

\begin{lemma}
\label{lemma-characterize-local-ring-map}
Let $\varphi : R \to S$ be a ring map. Assume $R$ and $S$ are local rings.
The following are equivalent:
\begin{enumerate}
\item $\varphi$ is a local ring map,
\item $\varphi(\mathfrak m_R) \subset \mathfrak m_S$, and
\item $\varphi^{-1}(\mathfrak m_S) = \mathfrak m_R$.
\item For any $x \in R$, if $\varphi(x)$ is invertible in $S$, then $x$
is invertible in $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Conditions (1) and (2) are equivalent by definition.
If (3) holds then (2) holds. Conversely, if (2) holds, then
$\varphi^{-1}(\mathfrak m_S)$ is a prime ideal containing
the maximal ideal $\mathfrak m_R$, hence
$\varphi^{-1}(\mathfrak m_S) = \mathfrak m_R$. Finally, (4) is the
contrapositive of (2) by Lemma \ref{lemma-characterize-local-ring}.
\end{proof}

\noindent
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime
and set $\mathfrak p = \varphi^{-1}(\mathfrak q)$. Then the induced ring
map $R_\mathfrak p \to S_\mathfrak q$ is a local ring map.



\section{The Jacobson radical of a ring}
\label{section-radical}

\noindent
We recall that the {\it Jacobson radical} $\text{rad}(R)$ of a ring $R$
is the intersection of all maximal ideals of $R$. If $R$ is local
then $\text{rad}(R)$ is the maximal ideal of $R$.

\begin{lemma}
\label{lemma-contained-in-radical}
Let $R$ be a ring and let $I \subset R$ be an ideal. The following are
equivalent
\begin{enumerate}
\item $I \subset \text{rad}(R)$, and
\item every element of $1 + I$ is a unit in $R$.
\end{enumerate}
In this case every element of $R$ which maps to a unit of $R/I$ is a unit.
\end{lemma}

\begin{proof}
If $f \in \text{rad}(R)$, then $f \in \mathfrak m$ for all
maximal ideals $\mathfrak m$ of $R$. Hence $1 + f \not \in \mathfrak m$
for all maximal ideals $\mathfrak m$ of $R$. Thus the closed
subset $V(1 + f)$ of $\Spec(R)$ is empty. This implies
that $1 + f$ is a unit, see Lemma \ref{lemma-Zariski-topology}.

\medskip\noindent
Conversely, assume that $1 + f$ is a unit for all $f \in I$.
If $\mathfrak m$ is a maximal ideal and $I \not \subset \mathfrak m$,
then $I + \mathfrak m = R$. Hence $1 = f + g$ for some $g \in \mathfrak m$
and $f \in I$. Then $g = 1 + (-f)$ is not a unit, contradiction.

\medskip\noindent
For the final statement let $f \in R$ map to a unit in $R/I$.
Then we can find $g \in R$ mapping to the multiplicative inverse
of $f \bmod I$. Then $fg = 1 \bmod I$. Hence $fg$ is a unit of $R$
by (2) which implies that $f$ is a unit.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-spec-units}
Let $\varphi : R \to S$ be a ring map such that the induced map
$\Spec(S) \to \Spec(R)$ is surjective. Then an element $x \in R$
is a unit if and only if $\varphi(x) \in S$ is a unit.
\end{lemma}

\begin{proof}
If $x$ is a unit, then so is $\varphi(x)$. Conversely, if $\varphi(x)$
is a unit, then $\varphi(x) \not \in \mathfrak q$ for all
$\mathfrak q \in \Spec(S)$. Hence
$x \not \in \varphi^{-1}(\mathfrak q) = \Spec(\varphi)(\mathfrak q)$
for all $\mathfrak q \in \Spec(S)$. Since $\Spec(\varphi)$ is surjective
we conclude that $x$ is a unit by
part (17) of Lemma \ref{lemma-Zariski-topology}.
\end{proof}




\section{Nakayama's lemma}
\label{section-nakayama}

\noindent
We quote from \cite{MatCA}: ``This simple but
important lemma is due to T.~Nakayama, G.~Azumaya and W.~Krull. Priority
is obscure, and although it is usually called the Lemma of Nakayama, late
Prof.~Nakayama did not like the name.''

\begin{lemma}[Nakayama's lemma]
\label{lemma-NAK}
\begin{reference}
\cite[1.M Lemma (NAK) page 11]{MatCA}
\end{reference}
\begin{history}
We quote from \cite{MatCA}: ``This simple but
important lemma is due to T.~Nakayama, G.~Azumaya and W.~Krull. Priority
is obscure, and although it is usually called the Lemma of Nakayama, late
Prof.~Nakayama did not like the name.''
\end{history}
Let $R$ be a ring, let $M$ be an $R$-module, and let $I \subset R$
be an ideal.
\begin{enumerate}
\item
\label{item-nakayama}
If $IM = M$ and $M$ is finite, then there exists a $f \in 1 + I$ such that
$fM = 0$.
\item If $IM = M$, $M$ is finite, and $I \subset \text{rad}(R)$, then $M = 0$.
\item If $N, N' \subset M$, $M = N + IN'$, and $N'$ is finite,
then there exists a $f \in 1 + I$ such that $M_f = N_f$.
\item If $N, N' \subset M$, $M = N + IN'$, $N'$ is finite, and
$I \subset \text{rad}(R)$, then $M = N$.
\item If $N \to M$ is a module map, $N/IN \to M/IM$ is
surjective, and $M$ is finite, then there exists a $f \in 1 + I$
such that $N_f \to M_f$ is surjective.
\item If $N \to M$ is a module map, $N/IN \to M/IM$ is
surjective, $M$ is finite, and $I \subset \text{rad}(R)$,
then $N \to M$ is surjective.
\item If $x_1, \ldots, x_n \in M$ generate $M/IM$ and $M$ is finite,
then there exists an $f \in 1 + I$ such that $x_1, \ldots, x_n$
generate $M_f$ over $R_f$.
\item If $x_1, \ldots, x_n \in M$ generate $M/IM$, $M$ is finite, and
$I \subset \text{rad}(R)$, then $M$ is generated by $x_1, \ldots, x_n$.
\item If $IM = M$, $I$ is nilpotent, then $M = 0$.
\item If $N, N' \subset M$, $M = N + IN'$, and $I$ is nilpotent then $M = N$.
\item If $N \to M$ is a module map, $I$ is nilpotent, and $N/IN \to M/IM$
is surjective, then $N \to M$ is surjective.
\item If $\{x_\alpha\}_{\alpha \in A}$ is a set of elements of $M$
which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated
by the $x_\alpha$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (\ref{item-nakayama}). Choose generators $y_1, \ldots, y_m$ of $M$
over $R$. For each $i$ we can write $y_i = \sum z_{ij} y_j$ with
$z_{ij} \in I$ (since $M = IM$).
In other words $\sum_j (\delta_{ij} - z_{ij})y_j = 0$.
Let $f$ be the determinant of the $m \times m$ matrix
$A = (\delta_{ij} - z_{ij})$. Note that $f \in 1 + I$
(since the matrix $A$ is entrywise congruent to the
$m \times m$ identity matrix modulo $I$).
By Lemma \ref{lemma-matrix-left-inverse} (1),
there exists an $m \times m$
matrix $B$ such that $BA = f 1_{m \times m}$. Writing out we see that
$\sum_{i} b_{hi} a_{ij} = f \delta_{hj}$ for all
$h$ and $j$; hence, $\sum_{i, j} b_{hi} a_{ij} y_j
= \sum_{j} f \delta_{hj} y_j = f y_h$ for every $h$.
In other words, $0 = f y_h$ for every $h$ (since each
$i$ satisfies $\sum_j a_{ij} y_j = 0$).
This implies that $f$ annihilates $M$.

\medskip\noindent
By Lemma \ref{lemma-Zariski-topology} an element of $1 + \text{rad}(R)$ is
invertible element of $R$. Hence we see that (\ref{item-nakayama}) implies
(2). We obtain (3) by applying (1) to $M/N$ which is finite as $N'$ is finite.
We obtain (4) by applying (2) to $M/N$ which is finite as $N'$ is finite.
We obtain (5) by applying (3) to $M$ and the submodules $\Im(N \to M)$
and $M$. We obtain (6) by applying (4) to $M$ and the submodules
$\Im(N \to M)$ and $M$.
We obtain (7) by applying (5) to the map $R^{\oplus n} \to M$,
$(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$.
We obtain (8) by applying (6) to the map $R^{\oplus n} \to M$,
$(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$.

\medskip\noindent
Part (9) holds because if $M = IM$ then $M = I^nM$ for all $n \geq 0$
and $I$ being nilpotent means $I^n = 0$ for some $n \gg 0$. Parts
(10), (11), and (12) follow from (9) by the arguments used above.
\end{proof}






\section{Open and closed subsets of spectra}
\label{section-open-and-closed}

\noindent
It turns out that open and closed subsets of a spectrum correspond to
idempotents of the ring.

\begin{lemma}
\label{lemma-idempotent-spec}
Let $R$ be a ring. Let $e \in R$ be an idempotent.
In this case
$$
\Spec(R) = D(e) \amalg D(1-e).
$$
\end{lemma}

\begin{proof}
Note that an idempotent $e$ of a domain is either $1$ or $0$.
Hence we see that
\begin{eqnarray*}
D(e)
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not = 0\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e = 1\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Similarly we have
\begin{eqnarray*}
D(1-e)
& = &
\{ \mathfrak p \in \Spec(R)
\mid
1 - e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not = 1\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e = 0\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Since the image of $e$ in any residue field is either $1$ or $0$
we deduce that $D(e)$ and $D(1-e)$ cover all of $\Spec(R)$.
\end{proof}

\begin{lemma}
\label{lemma-spec-product}
Let $R_1$ and $R_2$ be rings.
Let $R = R_1 \times R_2$.
The maps $R \to R_1$, $(x, y) \mapsto x$ and $R \to R_2$,
$(x, y) \mapsto y$
induce continuous maps $\Spec(R_1) \to \Spec(R)$ and
$\Spec(R_2) \to \Spec(R)$.
The induced map
$$
\Spec(R_1) \amalg \Spec(R_2)
\longrightarrow
\Spec(R)
$$
is a homeomorphism. In other words,
the spectrum of $R = R_1\times R_2$ is the
disjoint union of the spectrum of $R_1$ and the
spectrum of $R_2$.
\end{lemma}

\begin{proof}
Write $1 = e_1 + e_2$ with $e_1 = (1, 0)$ and $e_2 = (0, 1)$.
Note that $e_1$ and $e_2 = 1 - e_1$ are idempotents.
We leave it to the reader to show that
$R_1 = R_{e_1}$ is the localization of $R$ at $e_1$.
Similarly for $e_2$.
Thus the statement of the lemma follows from Lemma
\ref{lemma-idempotent-spec} combined with Lemma
\ref{lemma-standard-open}.
\end{proof}

\noindent
We reprove the following lemma later after introducing
a glueing lemma for functions. See Section
\ref{section-tilde-module-sheaf}.

\begin{lemma}
\label{lemma-disjoint-decomposition}
Let $R$ be a ring. For each $U \subset \Spec(R)$
which is open and closed
there exists a unique idempotent $e \in R$ such that
$U = D(e)$. This induces a 1-1 correspondence between
open and closed subsets $U \subset \Spec(R)$ and
idempotents $e \in R$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-disjoint-decomposition}]
Let $U \subset \Spec(R)$ be open and closed.
Since $U$ is closed it is quasi-compact by
Lemma \ref{lemma-quasi-compact}, and similarly for
its complement.
Write $U = \bigcup_{i = 1}^n D(f_i)$ as a finite union of standard opens.
Similarly, write $\Spec(R) \setminus U = \bigcup_{j = 1}^m D(g_j)$
as a finite union of standard opens. Since $\emptyset =
D(f_i) \cap D(g_j) = D(f_i g_j)$ we see that $f_i g_j$ is
nilpotent by Lemma \ref{lemma-Zariski-topology}.
Let $I = (f_1, \ldots, f_n) \subset R$ and let
$J = (g_1, \ldots, g_m) \subset R$.
Note that $V(J)$ equals $U$, that $V(I)$
equals the complement of $U$, so $\Spec(R) = V(I) \amalg V(J)$.
By the remark on nilpotency above,
we see that $(IJ)^N = (0)$ for some sufficiently large integer $N$.
Since $\bigcup D(f_i) \cup \bigcup D(g_j) = \Spec(R)$
we see that $I + J = R$, see Lemma \ref{lemma-Zariski-topology}.
By raising this equation to the $2N$th power we conclude that
$I^N + J^N = R$. Write $1 = x + y$ with $x \in I^N$ and $y \in J^N$.
Then $0 = xy = x(1 - x)$ as $I^N J^N = (0)$. Thus $x = x^2$
is idempotent and contained
in $I^N \subset I$. The idempotent $y = 1 - x$ is contained in $J^N \subset J$. 
This shows that the idempotent $x$ maps to $1$ in every residue field
$\kappa(\mathfrak p)$ for $\mathfrak p \in V(J)$ and that $x$ maps to $0$
in $\kappa(\mathfrak p)$ for every $\mathfrak p \in V(I)$.

\medskip\noindent
To see uniqueness suppose that $e_1, e_2$ are
distinct idempotents in $R$. We have to show there
exists a prime $\mathfrak p$ such that $e_1 \in \mathfrak p$
and $e_2 \not \in \mathfrak p$, or conversely.
Write $e_i' = 1 - e_i$. If $e_1 \not = e_2$, then
$0 \not = e_1 - e_2  = e_1(e_2 + e_2') - (e_1 + e_1')e_2
= e_1 e_2' - e_1' e_2$. Hence either the idempotent
$e_1 e_2' \not = 0$ or $e_1' e_2 \not = 0$. An idempotent
is not nilpotent, and hence we find a prime
$\mathfrak p$ such that either $e_1e_2' \not \in \mathfrak p$
or $e_1'e_2 \not \in \mathfrak p$, by Lemma \ref{lemma-Zariski-topology}.
It is easy to see this gives the desired prime.
\end{proof}

\begin{lemma}
\label{lemma-characterize-spec-connected}
Let $R$ be a nonzero ring. Then $\Spec(R)$ is
connected if and only if $R$ has no nontrivial
idempotents.
\end{lemma}

\begin{proof}
Obvious from Lemma \ref{lemma-disjoint-decomposition}
and the definition of a connected topological space.
\end{proof}


\begin{lemma}
\label{lemma-ideal-is-squared-union-connected}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal.
Assume that $I = I^2$.
Then $V(I)$ is open and closed in $\Spec(R)$,
and $R/I \cong R_e$ for some idempotent $e \in R$.
\end{lemma}

\begin{proof}
By Nakayama's Lemma \ref{lemma-NAK} there exists an element
$f = 1 + i$, $i \in I$ in $R$ such that $fI = 0$.
It follows that $V(I) = D(f)$ by a simple argument.
Also, $0 = fi = i + i^2$, and hence
$f^2 = 1 + i + i + i^2 = 1 + i = f$, so $f$ is an idempotent.
Consider the canonical map $R \to R_f$. It is surjective
since $x/f^n = x/f = xf/f^2 = xf/f = x/1$ in $R_f$.
Any element of $I$ is in the kernel since $fI = 0$.
If $x \mapsto 0$ in $R_f$, then $f^nx = 0$ for some $n > 0$
and hence $(1 + i)x = 0$ hence $x \in I$.
\end{proof}






\section{Connected components of spectra}
\label{section-connected-components}

\noindent
Connected components of spectra are not as easy to understand as one
may think at first. This is because we are used to the topology of
locally connected spaces, but the spectrum of a ring is in general
not locally connected.

\begin{lemma}
\label{lemma-closed-union-connected-components}
Let $R$ be a ring. Let $T \subset \Spec(R)$ be a subset of the spectrum.
The following are equivalent
\begin{enumerate}
\item $T$ is closed and is a union of connected components of
$\Spec(R)$,
\item $T$ is an intersection of open and closed subsets of
$\Spec(R)$, and
\item $T = V(I)$ where $I \subset R$ is an ideal generated by idempotents.
\end{enumerate}
Moreover, the ideal in (3) if it exists is unique.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-topology-spec}
and
Topology, Lemma \ref{topology-lemma-closed-union-connected-components}
we see that (1) and (2) are equivalent.
Assume (2) and write $T = \bigcap U_\alpha$ with
$U_\alpha \subset \Spec(R)$ open and closed.
Then $U_\alpha = D(e_\alpha)$ for some idempotent $e_\alpha \in R$ by
Lemma \ref{lemma-disjoint-decomposition}.
Then setting $I = (1 - e_\alpha)$ we see that $T = V(I)$, i.e., (3) holds.
Finally, assume (3). Write $T = V(I)$ and $I = (e_\alpha)$ for some
collection of idempotents $e_\alpha$. Then it is clear that
$T = \bigcap V(e_\alpha) = \bigcap D(1 - e_\alpha)$.

\medskip\noindent
Suppose that $I$ is an ideal generated by idempotents.
Let $e \in R$ be an idempotent such that $V(I) \subset V(e)$. Then by
Lemma \ref{lemma-Zariski-topology}
we see that $e^n \in I$ for some $n \geq 1$. As $e$ is an idempotent
this means that $e \in I$. Hence we see that $I$ is generated by
exactly those idempotents $e$ such that $T \subset V(e)$.
In other words, the ideal $I$ is completely determined by the
closed subset $T$ which proves uniqueness.
\end{proof}

\begin{lemma}
\label{lemma-connected-component}
Let $R$ be a ring.
A connected component of
$\Spec(R)$ is of the form $V(I)$,
where $I$ is an ideal generated by idempotents
such that every idempotent of $R$ either maps to
$0$ or $1$ in $R/I$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $R$. By
Lemma \ref{lemma-topology-spec}
we have see that the hypotheses of
Topology, Lemma \ref{topology-lemma-connected-component-intersection}
are satisfied for the topological space $\Spec(R)$.
Hence the connected component of $\mathfrak p$ in $\Spec(R)$
is the intersection of open and closed subsets of $\Spec(R)$
containing $\mathfrak p$. Hence it equals $V(I)$ where
$I$ is generated by the idempotents $e \in R$ such that $e$ maps to $0$
in $\kappa(\mathfrak p)$, see
Lemma \ref{lemma-disjoint-decomposition}.
Any idempotent $e$ which is not in this collection clearly maps to $1$
in $R/I$.
\end{proof}











\section{Glueing functions}
\label{section-tilde-module-sheaf}

\noindent
In this section we show that given an open covering
$$
\Spec(R) = \bigcup\nolimits_{i = 1}^n D(f_i)
$$
by standard opens, and given an element $h_i \in R_{f_i}$
for each $i$ such that $h_i = h_j$ as elements of $R_{f_i f_j}$
then there exists a unique $h \in R$ such that the image of
$h$ in $R_{f_i}$ is $h_i$. This result can be interpreted
in two ways:
\begin{enumerate}
\item The rule $D(f) \mapsto R_f$ is a sheaf of rings
on the standard opens, see Sheaves, Section \ref{sheaves-section-bases}.
\item If we think of elements of $R_f$ as the ``algebraic''
or ``regular'' functions on $D(f)$, then these glue
as would continuous, resp.\ differentiable functions
on a topological, resp.\ differentiable manifold.
\end{enumerate}
At the end of this section we use this result to reprove the
lemma describing open and closed subsets in terms of
idempotents.

\begin{lemma}
\label{lemma-standard-covering}
Let $R$ be a ring, and let $f_1, f_2, \ldots f_n\in R$ generate
the unit ideal in $R$.
Then the following sequence is exact:
$$
0 \longrightarrow
R \longrightarrow
\bigoplus\nolimits_i R_{f_i} \longrightarrow
\bigoplus\nolimits_{i, j}R_{f_if_j}
$$
where the maps $\alpha : R \longrightarrow \bigoplus_i R_{f_i}$
and $\beta : \bigoplus_i R_{f_i} \longrightarrow \bigoplus_{i, j} R_{f_if_j}$
are defined as
$$
\alpha(x) = \left(\frac{x}{1}, \ldots, \frac{x}{1}\right)
\text{ and }
\beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right)
=
\left(\frac{x_i}{f_i^{r_i}}-\frac{x_j}{f_j^{r_j}}~\text{in}~R_{f_if_j}\right).
$$
\end{lemma}

\begin{proof}
We first show that $\alpha$ is injective,
and then that the image of $\alpha$ equals the kernel of $\beta$.
Assume there exists $x\in R$ such that $\alpha(x) = (0, \ldots, 0)$.
Then $\frac{x}{1} = 0$ in $R_{f_i}$ for all $i$.
This means, for all $i$, there exists a number $n_i$ such that
$$
f_i^{n_i}x = 0
$$
Since the $f_i$ generate $R$, we can pick $a_i$ so
$$
1 = \sum\nolimits_{i = 1}^n a_if_i
$$
Then for all $M\geq\sum n_i$, we have
$$
1^M = \left(\sum a_if_i\right)^M
= \sum {M \choose u_1, \ldots, u_n}
a_1^{u_1} a_2^{u_2} \cdots a_n^{u_n}
f_1^{u_1} f_2^{u_2} \cdots f_n^{u_n}
$$
where each term has a factor of at least $f_i^{n_i}$ for some $i$.
Therefore,
$$
x = 1x = 1^Mx = \left(\sum a_if_i\right)^Mx = 0.
$$
Thus, if $\alpha(x) = 0$, $x = 0$ and $\alpha$ is injective.
We check that the image of $\alpha$ equals the kernel of $\beta$.
First, note that for $x\in R$,
$$
\beta(\alpha(x)) =
\beta\left(\frac{x}{1}, \ldots, \frac{x}{1}\right) =
(\frac{x}{1}-\frac{x}{1}~in~R_{f_if_j}) = 0.
$$
Therefore, the image of $\alpha$ is in the kernel of $\beta$,
and it remains only to verify that if
$$
\beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right) = 0,
$$
then there exists $x\in R$ so that for all $i$,
$$
\frac{x}{1} = \frac{x_i}{f_i^{r_i}}
$$
Assume we have $x_1, \ldots, x_n$ such that
$$
\beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right) = 0.
$$
Then, for all pairs $i, j$, there exists an $n_{ij}$ such that
$$
f_i^{n_{ij}}f_j^{n_{ij}}(f_j^{r_j}x_i-f_i^{r_i}x_j) = 0
$$
Choosing $N$ so $N\geq n_{ij}$ for all $i, j$, we see that
$$
f_i^Nf_j^N(f_j^{r_j}x_i - f_i^{r_i}x_j) = 0
$$
Define elements $\widetilde{x_i}$ and $\widetilde{f_i}$ of $R$
as follows:
$$
\widetilde{f_i} = f_i^{N + r_i}, \quad \widetilde{x_i} = f_i^N x_i.
$$
Notice that
$$
\frac{\widetilde{x_i}}{\widetilde{f_i}} = \frac{x_i}{f_i^{r_i}}.
$$
Also, we can use this to rewrite the above equation
$f_i^Nf_j^N(f_j^{r_j}x_i - f_i^{r_i}x_j) = 0$ to get
the following equality, for all $i, j$,
$$
\widetilde{f_j}\widetilde{x_i} = \widetilde{f_i}\widetilde{x_j}.
$$
Since $f_1, \ldots, f_n$ generate $R$, we clearly have that
$\widetilde{f_1}, \ldots, \widetilde{f_n}$ also generate $R$.
Therefore, there exist $a_1, \ldots, a_n$ in $R$ so that
$$
1 = \sum\nolimits_{i = 1}^n a_i\widetilde{f_i}
$$
Therefore, we finally conclude that for all $i$,
$$
\frac{x_i}{f_i^{r_i}} =
\frac{\widetilde{x_i}}{\widetilde{f_i}} =
\sum\nolimits_{j = 1}^n
\frac{a_j\widetilde{f_j}\widetilde{x_i}}{\widetilde{f_i}} =
\sum\nolimits_{j = 1}^n
\frac{a_j\widetilde{f_i}\widetilde{x_j}}{\widetilde{f_i}} =
\frac{\sum_{j = 1}^na_j\widetilde{x_j}}{1}.
$$
Thus, we have
$$
\alpha\left(\sum\nolimits_{j = 1}^na_j\widetilde{x_j}\right) =
\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right),
$$
as required.  There the sequence is exact.
\end{proof}

\begin{lemma}
\label{lemma-cover-module}
Let $R$ be a ring. Let $f_1, \ldots, f_n$ be elements of $R$
generating the unit ideal. Let $M$ be an $R$-module.
The sequence
$$
0 \to
M \xrightarrow{\alpha}
\bigoplus\nolimits_{i = 1}^n M_{f_i} \xrightarrow{\beta}
\bigoplus\nolimits_{i, j = 1}^n M_{f_i f_j}
$$
is exact, where $\alpha(m) = (m/1, \ldots, m/1)$
and $\beta(m_1/f_1^{e_1}, \ldots, m_n/f_n^{e_n})
= (m_i/f_i^{e_i} - m_j/f_j^{e_j})_{(i, j)}$.
\end{lemma}

\begin{proof}
The same as the proof of Lemma \ref{lemma-standard-covering}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-disjoint-decomposition}]
Having assured ourselves (Lemma \ref{lemma-standard-covering})
that for generators ${f_1, \ldots, f_n}$ for the unit
ideal of a ring $R$ the sequence
$$
0 \to R
\to \bigoplus\nolimits_{i = 1}^ {n} R_{f_i}
\to \bigoplus\nolimits_{i, j} R_{f_if_j}
$$
is exact, we now provide an alternate proof of the surjectivity of
the map from idempotents $e$ of $R$ to open and closed subsets of
$\Spec(R)$
presented in Lemma \ref{lemma-disjoint-decomposition}.
Let $U \subset \Spec(R)$ be open and closed, and $W$ be its
complement. We can
write $U$ and $V$ as unions of standard opens such that
$U = \bigcup_{i = 1}^{n}  D(f_i)$ and
$W = \bigcup_{j = 1}^{m} D(g_j)$.  Since
$\Spec(R) = \bigcup D(f_i) \cup \bigcup D(g_j)$,
we observe that the collection $\{ f_i;g_j\}$ must
generate the unit ideal in $R$ by Lemma \ref{lemma-Zariski-topology}.
So the following sequence is exact.
\begin{equation}
\label{equation-idempotent-exact-sequence}
0 \to R \stackrel{\alpha}{\to}
\bigoplus\nolimits_{i = 1}^ {n} R_{f_i}
\oplus \bigoplus\nolimits_{j = 1}^{m} R_{g_j}
\to
\bigoplus\nolimits_{i_1, i_2} R_{f_{i_1}f_{i_2}}
\oplus \bigoplus\nolimits_{i, j} R_{f_ig_j}
\oplus \bigoplus\nolimits_{j_1, j_2} R_{g_{j_1}g_{j_2}}
\end{equation}
However, notice that for any pair $i, j$,
$D(f_i) \cap D(g_j) = \emptyset$
since $D(f_i) \subset U$ and $D(g_j) \subset W)$. From part (15)
of Lemma \ref{lemma-Zariski-topology}
we recall that $D(f_i g_j) = D(f_i) \cap D(g_j) = \emptyset$. Therefore by
Lemma \ref{lemma-spec-localization}
$\Spec(R_{f_i g_j}) = D(f_i g_j) = \emptyset$,
implying that $R_{f_i g_j}$ is the
zero ring for each pair $i, j$ by part (3) of
Lemma \ref{lemma-Zariski-topology}.
Consider the element
$(1, \ldots, 1, 0, \ldots, 0) \in \bigoplus_{i = 1}^ {n} R_{f_i}
\oplus \bigoplus_{j = 1}^{m} R_{g_j}$
whose coordinates are $1$ in each $R_{f_i}$ and
$0$ in each $R_{g_j}$. This is sent to $0$ under the map
$$
\beta : \bigoplus\nolimits_{i = 1}^ {n} R_{f_i} \oplus
\bigoplus\nolimits_{j = 1}^{m} R_{g_j}
\to \bigoplus\nolimits_{i_1, i_2} R_{f_{i_1}f_{i_2}} \oplus
\bigoplus\nolimits_{j_1, j_2}
R_{g_{j_1}g_{j_2}}
$$
so by the exactness of the
sequence (\ref{equation-idempotent-exact-sequence}), there must be some
element of $R$ whose image under $\alpha$ is $(1, \ldots, 1, 0, \ldots, 0)$.
Call it $e$. We see that
$\alpha(e^2) = \alpha(e)^2 = (1, \ldots, 1, 0, \ldots, 0) = \alpha(e)$.
Since $\alpha$ is
injective, $e = e^2$ in $R$ and $e$ is an idempotent of $R$. We claim that
$U = D(e)$.
Notice that for arbitrary $j$, the map $R \to R_{g_j}$ maps $e$
to $0$. Therefore there must be some positive integer $k_j$ such that
$g_j^{k_j}(e-0) = 0$ in $R$. Multiplying by $e$ as necessary,
we see that $(g_j e)^{k_j} = 0$,
so $g_j e$ is nilpotent in $R$. By
Lemma \ref{lemma-Zariski-topology}
$D(g_j) \cap D(e) = D(g_j e) = \emptyset$. So since
$V = \bigcup D(g_j)$, $D(e) \cap V = \emptyset$ and
$D(e) \subset U$. Furthermore, for arbitrary $i$, the
map $R \to R_{f_i}$ maps $e$ to $1$, so there must be some $l_i$ such
that $f_i^{l_i}(e-1) =0$ in $R$. Hence $f_i^{l_i}e = f_i^{l_i}$. Suppose
$\mathfrak{p} \in \Spec(R)$ contains $e$,
then $\mathfrak{p}$ contains
$f_i^{l_i}e = f_i^{l_i}$, and since $\mathfrak{p}$ is prime, $f_i \in
\mathfrak{p}$. So $V(e) \subset V(f_i)$, implying that $D(f_i) \subset D(e)$.
Therefore $U = \bigcup D(f_i) \subset D(e)$, and $U = D(e)$.
Therefore any open
and closed subset of $\Spec(R)$ is the standard open
of an idempotent as
desired.
\end{proof}

\noindent
The following we have already seen above, but we state it explicitly here
for convenience.

\begin{lemma}
\label{lemma-disjoint-implies-product}
Let $R$ be a ring.
If $\Spec(R) = U \amalg V$ with both $U$ and $V$ open
then $R \cong R_1 \times R_2$ with $U \cong \Spec(R_1)$
and $V \cong \Spec(R_2)$ via the maps in Lemma \ref{lemma-spec-product}.
Moreover, both $R_1$ and $R_2$ are localizations as well as quotients
of the ring $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-disjoint-decomposition} we have
$U = D(e)$ and $V = D(1-e)$ for some idempotent $e$.
By Lemma \ref{lemma-standard-covering} we see that
$R \cong R_e \times R_{1 - e}$ (since clearly $R_{e(1-e)} = 0$
so the glueing condition is trivial; of course it is
trivial to prove the product decomposition directly in this
case). The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-when-injective-covering}
Let $R$ be a ring.
Let $f_1, \ldots, f_n \in R$.
Let $M$ be an $R$-module.
Then $M \to \bigoplus M_{f_i}$ is injective if and only if
$$
M \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} M, \quad
m \longmapsto (f_1m, \ldots, f_nm)
$$
is injective.
\end{lemma}

\begin{proof}
The map $M \to \bigoplus M_{f_i}$ is injective if and only if
for all $m \in M$ and $e_1, \ldots, e_n \geq 1$ such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$ we have $m = 0$.
This clearly implies the displayed map is injective.
Conversely, suppose the displayed map is injective and
$m \in M$ and $e_1, \ldots, e_n \geq 1$ are such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$. If $e_i = 1$ for all $i$,
then we immediately conclude that $m = 0$ from the injectivity of
the displayed map. Next, we prove this holds for any such data
by induction on $e = \sum e_i$. The base case is $e = n$, and we have
just dealt with this. If some $e_i > 1$, then set $m' = f_im$.
By induction we see that $m' = 0$. Hence we see that $f_i m = 0$,
i.e., we may take $e_i = 1$ which decreases $e$ and we win.
\end{proof}
















\section{More glueing results}
\label{section-more-glueing}

\noindent
In this section we put a number of standard results of the
form: if something is true for all members of a standard open
covering then it is true. In fact, it often suffices to check
things on the level of local rings as in the following lemma.

\begin{lemma}
\label{lemma-characterize-zero-local}
Let $R$ be a ring.
\begin{enumerate}
\item For an element $x$ of an $R$-module $M$ the following are equivalent
\begin{enumerate}
\item $x = 0$,
\item $x$ maps to zero in $M_\mathfrak p$ for all $\mathfrak p \in \Spec(R)$,
\item $x$ maps to zero in $M_{\mathfrak m}$ for all maximal ideals
$\mathfrak m$ of $R$.
\end{enumerate}
In other words, the map $M \to \prod_{\mathfrak m} M_{\mathfrak m}$
is injective.
\item Given an $R$-module $M$ the following are equivalent
\begin{enumerate}
\item $M$ is zero,
\item $M_{\mathfrak p}$ is zero for all $\mathfrak p \in \Spec(R)$,
\item $M_{\mathfrak m}$ is zero for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a complex $M_1 \to M_2 \to M_3$
of $R$-modules the following are equivalent
\begin{enumerate}
\item $M_1 \to M_2 \to M_3$ is exact,
\item for every prime $\mathfrak p$ of $R$ the localization
$M_{1, \mathfrak p} \to M_{2, \mathfrak p} \to M_{3, \mathfrak p}$
is exact,
\item for every maximal ideal $\mathfrak m$ of $R$ the localization
$M_{1, \mathfrak m} \to M_{2, \mathfrak m} \to M_{3, \mathfrak m}$
is exact.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is injective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is injective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is injective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is surjective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is surjective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is surjective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is bijective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is bijective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is bijective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in M$ as in (1). Let $I = \{f \in R \mid fx = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $x$). Condition (1)(c) means that for
all maximal ideals $\mathfrak m$ there exists an
$f \in R \setminus \mathfrak m$ such that $fx =0$.
In other words, $V(I)$ does not contain a closed point.
By Lemma \ref{lemma-Zariski-topology} we see $I$ is the unit ideal.
Hence $x$ is zero, i.e., (1)(a) holds. This proves (1).

\medskip\noindent
Part (2) follows by applying (1) to all elements of $M$ simultaneously.

\medskip\noindent
Proof of (3). Let $H$ be the homology of the sequence, i.e.,
$H = \Ker(M_2 \to M_3)/\Im(M_1 \to M_2)$. By
Proposition \ref{proposition-localization-exact}
we have that $H_\mathfrak p$ is the homology of the sequence
$M_{1, \mathfrak p} \to M_{2, \mathfrak p} \to M_{3, \mathfrak p}$.
Hence (3) is a consequence of (2).

\medskip\noindent
Parts (4) and (5) are special cases of (3). Part (6) follows
formally on combining (4) and (5).
\end{proof}

\begin{lemma}
\label{lemma-cover}
\begin{slogan}
Zariski-local properties of modules and algebras
\end{slogan}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra.
Suppose that $f_1, \ldots, f_n$ is a finite list of
elements of $R$ such that $\bigcup D(f_i) = \Spec(R)$
in other words $(f_1, \ldots, f_n) = R$.
\begin{enumerate}
\item If each $M_{f_i} = 0$ then $M = 0$.
\item If each $M_{f_i}$ is a finite $R_{f_i}$-module,
then $M$ is a finite $R$-module.
\item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module,
then $M$ is a finitely presented $R$-module.
\item Let $M \to N$ be a map of $R$-modules. If $M_{f_i} \to N_{f_i}$
is an isomorphism for each $i$ then $M \to N$ is an isomorphism.
\item Let $0 \to M'' \to M \to M' \to 0$ be a complex of $R$-modules.
If $0 \to M''_{f_i} \to M_{f_i} \to M'_{f_i} \to 0$ is exact for each $i$,
then $0 \to M'' \to M \to M' \to 0$ is exact.
\item If each $R_{f_i}$ is Noetherian, then $R$ is Noetherian.
\item If each $S_{f_i}$ is a finite type $R$-algebra, so is $S$.
\item If each $S_{f_i}$ is of finite presentation over $R$, so is $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove each of the parts in turn.
\begin{enumerate}
\item By Proposition \ref{proposition-localize-twice}
this implies $M_\mathfrak p = 0$ for all $\mathfrak p \in \Spec(R)$,
so we conclude by Lemma \ref{lemma-characterize-zero-local}.
\item For each $i$ take a finite generating set $X_i$ of $M_{f_i}$.
Without loss of generality, we may assume that the elements of $X_i$ are
in the image of the localization map $M \rightarrow M_{f_i}$, so we take
a finite set $Y_i$ of preimages of the elements of $X_i$ in $M$. Let $Y$
be the union of these sets. This is still a finite set.
Consider the obvious $R$-linear map $R^Y \rightarrow M$ sending the basis
element $e_y$ to $y$. By assumption this map is surjective after localizing
at an arbitrary prime ideal $\mathfrak p$ of $R$, so it surjective by
Lemma \ref{lemma-characterize-zero-local}
and $M$ is finitely generated.
\item By (2) we have a short exact sequence
$$
0 \rightarrow K \rightarrow R^n \rightarrow M \rightarrow 0
$$
Since localization is an exact functor and $M_{f_i}$ is finitely
presented we see that $K_{f_i}$ is finitely generated for all
$1 \leq i \leq n$ by Lemma \ref{lemma-extension}.
By (2) this implies that $K$ is a finite $R$-module and therefore
$M$ is finitely presented.
\item By Proposition \ref{proposition-localize-twice}
the assumption implies that the induced morphism
on localizations at all prime ideals is an isomorphism, so we conclude
by Lemma \ref{lemma-characterize-zero-local}.
\item By Proposition \ref{proposition-localize-twice} the assumption
implies that the induced
sequence of localizations at all prime ideals is short exact, so we
conclude by Lemma \ref{lemma-characterize-zero-local}.
\item We will show that every ideal of $R$ has a finite generating set:
For this, let $I \subset R$ be an arbitrary ideal. By
Proposition \ref{proposition-localization-exact}
each $I_{f_i} \subset R_{f_i}$ is an ideal. These are all
finitely generated by assumption, so we conclude by (2).
\item For each $i$ take a finite generating set $X_i$ of $S_{f_i}$.
Without loss of generality, we may assume that the elements of $X_i$
are in the image of the localization map $S \rightarrow S_{f_i}$, so
we take a finite set $Y_i$ of preimages of the elements of $X_i$ in
$S$. Let $Y$ be the union of these sets. This is still a finite set.
Consider the algebra homomorphism $R[X_y]_{y \in Y} \rightarrow S$
induced by $Y$. Since it is an algebra homomorphism, the image $T$
is an $R$-submodule of the $R$-module $S$, so we can consider the
quotient module $S/T$. By assumption, this is zero if we localize
at the $f_i$, so it is zero by (1) and therefore $S$ is an
$R$-algebra of finite type.
\item By the previous item, there exists a surjective $R$-algebra
homomorphism $R[X_1,...,X_n] \rightarrow S$. Let $K$ be the kernel
of this map. This is an ideal in $R[X_1,..X_n]$, finitely generated
in each localization at $f_i$. Since the $f_i$ generate the unit ideal
in $R$, they also generate the unit ideal in $R[X_1,...,X_n]$, so an
application of (2) finishes the proof.
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lemma-cover-upstairs}
Let $R \to S$ be a ring map.
Suppose that $g_1, \ldots, g_m$ is a finite list of
elements of $S$ such that $\bigcup D(g_j) = \Spec(S)$
in other words $(g_1, \ldots, g_m) = S$.
\begin{enumerate}
\item If each $S_{g_i}$ is of finite type over $R$, then $S$ is
of finite type over $R$.
\item If each $S_{g_i}$ is of finite presentation over $R$,
then $S$ is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following lemma is better stated and proved in the more general
context of flat descent. However, it makes sense to state it here
since it fits well with the above.

\begin{lemma}
\label{lemma-glue-modules}
Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ be elements
which generate the unit ideal in $R$. Suppose we are given
the following data:
\begin{enumerate}
\item For each $i$ an $R_{f_i}$-module $M_i$.
\item For each pair $i, j$ an $R_{f_if_j}$-module isomorphism
$\psi_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$.
\end{enumerate}
which satisfy the ``cocycle condition'' that all the diagrams
$$
\xymatrix{
(M_i)_{f_jf_k}
\ar[rd]_{\psi_{ij}}
\ar[rr]^{\psi_{ik}}
& &
(M_k)_{f_if_j} \\
&
(M_j)_{f_if_k} \ar[ru]_{\psi_{jk}}
}
$$
commute (for all triples $i, j, k$). Given this data define
$$
M = \Ker\left(
\bigoplus\nolimits_{1 \leq i \leq n} M_i
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n} (M_i)_{f_i}
\right)
$$
where $(m_1, \ldots, m_n)$ maps to the element whose
$(i, j)$th entry is $m_i/1 - \psi_{ji}(m_j/1)$.
Then the natural map $M \to M_i$ identifies
$M_i$ with $M_{f_i}$. Moreover $\psi_{ij}(m/1) = m/1$
for all $m \in M$ (with obvious notation).
\end{lemma}

\begin{proof}
Omitted.
\end{proof}












\section{Zerodivisors and total rings of fractions}
\label{section-total-quotient-ring}

\noindent
The local ring at a minimal prime has the following properties.

\begin{lemma}
\label{lemma-minimal-prime-reduced-ring}
Let $\mathfrak p$ be a minimal prime of a ring $R$.
Every element of the maximal ideal of $R_{\mathfrak p}$
is nilpotent. If $R$ is reduced then $R_{\mathfrak p}$
is a field.
\end{lemma}

\begin{proof}
If some element $x$ of ${\mathfrak p}R_{\mathfrak p}$
is not nilpotent, then $D(x) \not = \emptyset$, see
Lemma \ref{lemma-Zariski-topology}. This contradicts
the minimality of $\mathfrak p$. If $R$ is reduced,
then ${\mathfrak p}R_{\mathfrak p} = 0$ and
hence it is a field.
\end{proof}

\begin{lemma}
\label{lemma-reduced-ring-sub-product-fields}
Let $R$ be a reduced ring. Then
\begin{enumerate}
\item $R$ is a subring of a product of fields,
\item $R \to \prod_{\mathfrak p\text{ minimal}} R_{\mathfrak p}$
is an embedding into a product of fields,
\item $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$ is the set
of zerodivisors of $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-minimal-prime-reduced-ring} each of the rings
$R_\mathfrak p$ is a field. In particular, the kernel of the ring
map $R \to R_\mathfrak p$ is $\mathfrak p$.
By Lemma \ref{lemma-Zariski-topology}
we have $\bigcap_{\mathfrak p} \mathfrak p = (0)$.
Hence (2) and (1) are true. If $x y = 0$ and $y \not = 0$, then
$y \not \in \mathfrak p$ for some minimal prime $\mathfrak p$.
Hence $x \in \mathfrak p$. Thus every zerodivisor of $R$ is contained
in $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$.
Conversely, suppose that $x \in \mathfrak p$ for some minimal
prime $\mathfrak p$. Then $x$ maps to zero in $R_\mathfrak p$,
hence there exists $y \in R$, $y \not \in \mathfrak p$ such that
$xy = 0$. In other words, $x$ is a zerodivisor. This finishes the
proof of (3) and the lemma.
\end{proof}

\noindent
The total ring of fractions $Q(R)$ of a ring $R$ was introduced in
Example \ref{example-localize-at-prime}.

\begin{lemma}
\label{lemma-total-ring-fractions}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset consisting of nonzerodivisors.
Then $Q(R) \cong Q(S^{-1}R)$.
In particular $Q(R) \cong Q(Q(R))$.
\end{lemma}

\begin{proof}
If $x \in S^{-1}R$ is a nonzerodivisor, and
$x = r/f$ for some $r \in R$, $f \in S$, then
$r$ is a nonzerodivisor in $R$. Whence the lemma.
\end{proof}

\noindent
We can apply glueing results to prove something about
total rings of fractions $Q(R)$ which we introduced in
Example \ref{example-localize-at-prime}.

\begin{lemma}
\label{lemma-total-ring-fractions-no-embedded-points}
Let $R$ be a ring.
Assume that $R$ has finitely many minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and that
$\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ is the set
of zerodivisors of $R$.
Then the total ring of fractions $Q(R)$ is equal to
$R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
\end{lemma}

\begin{proof}
There are natural maps $Q(R) \to R_{\mathfrak q_i}$ since
any nonzerodivisor is contained in $R \setminus \mathfrak q_i$.
Hence a natural map
$Q(R) \to R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
For any nonminimal prime $\mathfrak p \subset R$ we see that
$\mathfrak p \not \subset \mathfrak q_1 \cup \ldots \cup \mathfrak q_t$
by Lemma \ref{lemma-silly}. Hence
$\Spec(Q(R)) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$
(as subsets of $\Spec(R)$, see Lemma \ref{lemma-spec-localization}).
Therefore $\Spec(Q(R))$ is a finite discrete set and
it follows that $Q(R) = A_1 \times \ldots \times A_t$
with $\Spec(A_i) = \{q_i\}$, see
Lemma \ref{lemma-disjoint-implies-product}.
Moreover $A_i$ is a local ring, which is a localization
of $R$. Hence $A_i \cong R_{\mathfrak q_i}$.
\end{proof}

















\section{Irreducible components of spectra}
\label{section-irreducible}

\noindent
We show that irreducible components of
the spectrum of a ring correspond to the
minimal primes in the ring.

\begin{lemma}
\label{lemma-irreducible}
Let $R$ be a ring.
\begin{enumerate}
\item For a prime $\mathfrak p \subset R$ the closure
of $\{\mathfrak p\}$ in the Zariski topology is $V(\mathfrak p)$.
In a formula $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
\item The irreducible closed subsets of $\Spec(R)$ are
exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$
a prime.
\item The irreducible components (see Topology,
Definition \ref{topology-definition-irreducible-components})
of $\Spec(R)$ are  exactly the subsets $V(\mathfrak p)$,
with $\mathfrak p \subset R$ a minimal prime.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $ \mathfrak p \in V(I)$, then
$I \subset \mathfrak p$. Hence,
clearly $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
In particular $V(\mathfrak p)$ is the closure of
a singleton and hence irreducible.
The second assertion implies the third.
To show the second, let
$V(I) \subset \Spec(R)$ with $I$ a radical ideal.
If $I$ is not prime, then choose $a, b\in R$, $a, b\not \in I$
with $ab\in I$. In this case $V(I, a) \cup V(I, b) = V(I)$,
but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by
Lemma \ref{lemma-Zariski-topology}. Hence $V(I)$ is not
irreducible.
\end{proof}

\noindent
In other words, this lemma shows that every irreducible closed
subset of $\Spec(R)$ is of the form $V(\mathfrak p)$ for
some prime $\mathfrak p$. Since $V(\mathfrak p) = \overline{\{\mathfrak p\}}$
we see that each irreducible closed subset has a unique generic point,
see Topology, Definition \ref{topology-definition-generic-point}.
In particular, $\Spec(R)$ is a sober topological space.
We record this fact in the following lemma.

\begin{lemma}
\label{lemma-spec-spectral}
The spectrum of a ring is a spectral space, see Topology, Definition
\ref{topology-definition-spectral-space}.
\end{lemma}

\begin{proof}
Formally this follows from Lemma \ref{lemma-irreducible} and
Lemma \ref{lemma-topology-spec}. See also discussion above.
\end{proof}

\begin{lemma}
\label{lemma-irreducible-components-containing-x}
Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime.
\begin{enumerate}
\item the set of irreducible closed subsets of $\Spec(R)$
passing through $\mathfrak p$ is in one-to-one correspondence with
primes $\mathfrak q \subset R_{\mathfrak p}$.
\item The set of irreducible components of $\Spec(R)$ passing through
$\mathfrak p$ is in one-to-one correspondence with minimal
primes $\mathfrak q \subset R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-irreducible}
and the description of $\Spec(R_\mathfrak p)$ in
Lemma \ref{lemma-spec-localization} which shows that
$\Spec(R_\mathfrak p)$ corresponds to primes $\mathfrak q$ in $R$
with $\mathfrak q \subset \mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-standard-open-containing-maximal-point}
Let $R$ be a ring.
Let $\mathfrak p$ be a minimal prime of $R$.
Let $W \subset \Spec(R)$ be a quasi-compact open
not containing the point $\mathfrak p$. Then there
exists an $f \in R$, $f \not \in \mathfrak p$ such
that $D(f) \cap W = \emptyset$.
\end{lemma}

\begin{proof}
Since $W$ is quasi-compact we may write it as a finite union
of standard affine opens $D(g_i)$, $i = 1, \ldots, n$.
Since $\mathfrak p \not \in W$ we have $g_i \in \mathfrak p$ for
all $i$. By Lemma \ref{lemma-minimal-prime-reduced-ring}
each $g_i$ is nilpotent in $R_{\mathfrak p}$. Hence we can find
an $f \in R$, $f \not \in \mathfrak p$ such that for all $i$ we have
$f g_i^{n_i} = 0$ for some $n_i > 0$. Then $D(f)$ works.
\end{proof}

\begin{lemma}
\label{lemma-ring-with-only-minimal-primes}
Let $R$ be a ring. Let $X = \Spec(R)$ as a topological space.
The following are equivalent
\begin{enumerate}
\item $X$ is profinite,
\item $X$ is Hausdorff,
\item $X$ is totally disconnected.
\item every quasi-compact open of $X$ is closed,
\item there are no nontrivial inclusions between its prime ideals,
\item every prime ideal is a maximal ideal,
\item every prime ideal is minimal,
\item every standard open $D(f) \subset X$ is closed, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
First proof. It is clear that (5), (6), and (7) are equivalent.
It is clear that (4) and (8) are equivalent as every quasi-compact
open is a finite union of standard opens.
The implication (7) $\Rightarrow$ (4) follows from
Lemma \ref{lemma-standard-open-containing-maximal-point}.
Assume (4) holds. Let $\mathfrak p, \mathfrak p'$ be distinct
primes of $R$. Choose an $f \in \mathfrak p'$, $f \not \in \mathfrak p$
(if needed switch $\mathfrak p$ with $\mathfrak p'$).
Then $\mathfrak p' \not \in D(f)$ and $\mathfrak p \in D(f)$.
By (4) the open $D(f)$ is also closed.
Hence $\mathfrak p$ and $\mathfrak p'$ are in disjoint open
neighbourhoods whose union is $X$. Thus $X$ is Hausdorff and totally
disconnected. Thus (4) $\Rightarrow$ (2) and (3).
If (3) holds then there cannot be any specializations
between points of $\Spec(R)$ and we see that (5) holds.
If $X$ is Hausdorff then every point is closed, so (2) implies (6).
Thus (2), (3), (4), (5), (6), (7) and (8) are equivalent.
Any profinite space is Hausdorff, so (1) implies (2).
If $X$ satisfies (2) and (3), then $X$ (being quasi-compact by
Lemma \ref{lemma-quasi-compact}) is profinite by
Topology, Lemma \ref{topology-lemma-profinite}.

\medskip\noindent
Second proof. Besides the equivalence of (4) and (8) this follows
from Lemma \ref{lemma-spec-spectral} and purely topological facts, see
Topology, Lemma \ref{topology-lemma-characterize-profinite-spectral}.
\end{proof}













\section{Examples of spectra of rings}
\label{section-examples-spectra}

\noindent
In this section we put some examples of spectra.

\begin{example}
\label{example-spec-Zxmodx2minus4}
In this example we describe $X = \Spec(\mathbf{Z}[x]/(x^2 - 4))$.
Let $\mathfrak{p}$ be an arbitrary prime in $X$.
Let $\phi : \mathbf{Z} \to \mathbf{Z}[x]/(x^2 - 4)$ be the natural ring map.
Then, $ \phi^{-1}(\mathfrak p)$ is a prime in $\mathbf{Z}$.
If $ \phi^{-1}(\mathfrak p) = (2)$, then since $\mathfrak p$ contains $2$,
it corresponds to a prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, 2) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, 2)$.
Any prime in $(\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$ corresponds to a prime
in $(\mathbf{Z}/2\mathbf{Z})[x]$ containing $(x^2)$.  Such primes will
then contain $x$.  Since
$(\mathbf{Z}/2\mathbf{Z}) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x)$ is a field,
$(x)$ is a maximal ideal.  Since any prime contains $(x)$ and $(x)$ is
maximal, the ring contains only one prime $(x)$.  Thus, in this case,
$\mathfrak p = (2, x)$.  Now, if $ \phi^{-1}(\mathfrak p) = (q)$ for
$q > 2$, then since $\mathfrak p$ contains $q$, it corresponds to a
prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, q) \cong (\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, q)$.
Any prime in $(\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$ corresponds to a
prime in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing $(x^2 - 4) = (x -2)(x + 2)$.
Hence, these primes must contain either $x -2$ or $x + 2$.  Since
$(\mathbf{Z}/q\mathbf{Z})[x]$ is a PID, all nonzero
primes are maximal, and so there
are precisely 2 primes in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing
$(x-2)(x + 2)$, namely $(x-2)$ and $(x + 2)$.  In conclusion, there exist two
primes $(q, x-2)$ and $(q, x + 2)$ since $2 \neq -2 \in \mathbf{Z}/(q)$.
Finally, we treat the case where $\phi^{-1}(\mathfrak p) = (0)$.  Notice
that $\mathfrak p$ corresponds to a prime ideal in $\mathbf{Z}[x]$ that
contains $(x^2 - 4) = (x -2)(x + 2)$.  Hence, $\mathfrak p$ contains either
$(x-2)$ or $(x + 2)$.  Hence, $\mathfrak p$ corresponds to a prime in
$\mathbf{Z}[x]/(x - 2)$ or one in $\mathbf{Z}[x]/(x + 2)$ that intersects
$\mathbf{Z}$ only at $0$, by assumption.  Since
$\mathbf{Z}[x]/(x - 2) \cong \mathbf{Z}$ and
$\mathbf{Z}[x]/(x + 2) \cong \mathbf{Z}$, this means that $\mathfrak p$
must correspond to $0$ in one of these rings.  Thus,
$\mathfrak p = (x - 2)$ or $\mathfrak p = (x + 2)$ in the original ring.
\end{example}

\begin{example}
\label{example-spec-Zx}
In this example we describe $X = \Spec(\mathbf{Z}[x])$.
Fix $\mathfrak p \in X$.
Let $\phi : \mathbf{Z} \to \mathbf{Z}[x]$ and notice
that $\phi^{-1}(\mathfrak p) \in \Spec(\mathbf{Z})$.
If $\phi^{-1}(\mathfrak p) = (q)$ for $q$ a prime number $q > 0$,
then $\mathfrak p$ corresponds to a prime in $(\mathbf{Z}/(q))[x]$,
which must be generated by a polynomial that is irreducible in
$(\mathbf{Z}/(q))[x]$.   If we choose a representative of this polynomial
with minimal degree, then it will also be irreducible in $\mathbf{Z}[x]$.
Hence, in this case $\mathfrak p = (q, f_q)$ where $f_q$ is an irreducible
polynomial in $\mathbf{Z}[x]$ that is irreducible when viewed
in $(\mathbf{Z}/(q) [x])$. Now, assume that $\phi^{-1}(\mathfrak p) = (0)$.
In this case, $\mathfrak p$ must be generated by nonconstant polynomials
which, since $\mathfrak p$ is prime, may be assumed to be irreducible in
$\mathbf{Z}[x]$.  By Gauss' lemma, these polynomials are also irreducible
in $\mathbf{Q}[x]$.  Since $\mathbf{Q}[x]$ is a Euclidean domain, if there
are at least two distinct irreducibles $f, g$ generating $\mathfrak p$,
then $1 = af + bg$ for $a, b \in \mathbf{Q}[x]$.  Multiplying through by
a common denominator, we see that $m = \bar{a}f + \bar{b} g$ for
$\bar{a}, \bar{b} \in \mathbf{Z}[x]$ and nonzero $m \in \mathbf{Z}$.
This is a contradiction.  Hence, $\mathfrak p$ is generated by one
irreducible polynomial in $\mathbf{Z}[x]$.
\end{example}

\begin{example}
\label{example-spec-kxy}
In this example we describe $X = \Spec(k[x, y])$
when $k$ is an arbitrary field.
Clearly $(0)$ is prime, and any principal ideal generated by an
irreducible polynomial will also be a prime since $k[x, y]$ is a
unique factorization domain. Now assume $\mathfrak p$ is an
element of $X$ that is not principal. Since $k[x, y]$ is a
Noetherian UFD, the prime ideal $\mathfrak p$ can be generated
by a finite number of irreducible polynomials $(f_1, \ldots, f_n)$.
Now, I claim that if $f, g$ are irreducible polynomials in $k[x, y]$
that are not associates, then $(f, g) \cap k[x] \neq 0$. To do this,
it is enough to show that $f$ and $g$ are relatively prime when
viewed in $k(x)[y]$. In this case, $k(x)[y]$ is a Euclidean domain,
so by applying the Euclidean algorithm and clearing denominators, we
obtain $p = af + bg$ for $p, a, b \in k[x]$. Thus, assume this is not
the case, that is, that some nonunit $h \in k(x)[y]$ divides both
$f$ and $g$. Then, by Gauss's lemma, for some $a, b \in k(x)$ we
have $ah | f$ and $bh | g$ for $ah, bh \in k[x]$ since
$f.f.(k[x]) = k(x)$. By irreducibility, $ah = f$ and
$bh = g$ (since $h \notin k(x)$). So, back in $k(x)[y]$, $f, g $
are associates, as $\frac{a}{b} g = f$. Since
$k(x) = f.f.(k[x])$, we can write $g = \frac{r}{s} f $
for elements $r , s \in k[x]$ sharing no common factors. This
implies that $sg = rf$ in $k[x, y]$ and so $s$ must divide $f$
since $k[x, y]$ is a UFD. Hence, $s = 1$ or $s = f$. If $s = f$,
then $r = g$, implying $f, g \in k[x]$ and thus must be units in
$k(x)$ and relatively prime in $k(x)[y]$, contradicting our
hypothesis. If $s = 1$, then $g = rf$, another contradiction.
Thus, we must have $f, g$ relatively prime in $k(x)[y]$, a
Euclidean domain. Thus, we have reduced to the case $\mathfrak p$
contains some irreducible polynomial $p \in k[x] \subset k[x, y]$.
By the above, $\mathfrak p$ corresponds to a prime in the ring
$k[x, y]/(p) = k(\alpha)[y]$, where $\alpha$ is an element
algebraic over $k$ with minimum polynomial $p$. This is a
PID, and so any prime ideal corresponds to $(0)$ or an
irreducible polynomial in $k(\alpha)[y]$. Thus, $\mathfrak p$
is of the form $(p)$ or $(p, f)$ where $f$ is a
polynomial in $k[x, y]$ that is irreducible in the quotient
$k[x, y]/(p)$.
\end{example}

\begin{example}
\label{example-affine-open-not-standard}
Consider the ring
$$
R = \{ f \in \mathbf{Q}[z]\text{ with }f(0) = f(1) \}.
$$
Consider the map
$$
\varphi : \mathbf{Q}[A, B] \to R
$$
defined by $\varphi(A) = z^2-z$ and $\varphi(B) = z^3-z^2$.  It is
easily checked that $(A^3 - B^2 + AB) \subset \Ker(\varphi)$ and that
$A^3 - B^2 + AB$ is irreducible. Assume that $\varphi$ is surjective;
then since $R$ is an integral domain (it is a subring of an integral
domain), $\Ker(\phi)$ must be a prime ideal of $\mathbf{Q}[A, B]$.
The prime ideals which contain $(A^3-B^2 + AB)$ are $(A^3-B^2 + AB)$
itself and any maximal ideal $(f, g)$ with $f, g\in\mathbf{Q}[A, B]$
such that $f$ is irreducible mod $g$. But $R$ is not a field, so the
kernel must be $(A^3-B^2 + AB)$; hence $\varphi$ gives an isomorphism
$R \to \mathbf{Q}[A, B]/(A^3-B^2 + AB)$.

\medskip\noindent
To see that $\varphi$ is surjective, we must express any
$f\in R$ as a $\mathbf{Q}$-coefficient polynomial in $A(z) = z^2-z$
and $B(z) = z^3-z^2$. Note the relation $zA(z) = B(z)$. Let
$a = f(0) = f(1)$. Then $z(z-1)$ must divide $f(z)-a$, so we can write
$f(z) = z(z-1)g(z)+a = A(z)g(z)+a$.  If $\deg(g)<2$, then
$h(z) = c_1z + c_0$ and $f(z) = A(z)(c_1z + c_0)+a = c_1B(z)+c_0A(z)+a$, so we
are done.  If $\deg(g)\geq 2$, then by the polynomial division
algorithm, we can write $g(z) = A(z)h(z)+b_1z + b_0$
($\deg(h)\leq\deg(g)-2$), so $f(z) = A(z)^2h(z)+b_1B(z)+b_0A(z)$.
Applying division to $h(z)$ and iterating, we obtain an expression
for $f(z)$ as a polynomial in $A(z)$ and $B(z)$; hence $\varphi$ is
surjective.

\medskip\noindent
Now let $a \in \mathbf{Q}$, $a \neq 0, \frac{1}{2}, 1$ and
consider
$$
R_a = \{ f \in \mathbf{Q}[z, \frac{1}{z-a}]\text{ with }f(0) = f(1)
\}.
$$
This is a finitely generated $\mathbf{Q}$-algebra as well: it is
easy to check that the functions $z^2-z$, $z^3-z$, and
$\frac{a^2-a}{z-a}+z$ generate $R_a$ as an $\mathbf{Q}$-algebra.  We
have the following inclusions:
$$
R\subset R_a\subset\mathbf{Q}[z, \frac{1}{z-a}], \quad
R\subset\mathbf{Q}[z]\subset\mathbf{Q}[z, \frac{1}{z-a}].
$$
Recall (Lemma \ref{lemma-spec-localization}) that for a ring T and a
multiplicative subset $S\subset T$, the ring map $T \to S^{-1}T$
induces a map on spectra $\Spec(S^{-1}T) \to \Spec(T)$
which is a homeomorphism onto the subset
$$
\{\mathfrak p \in \Spec(T) \mid S \cap \mathfrak p = \emptyset\}
\subset \Spec(T).
$$
When $S = \{ 1, f, f^2, \ldots\}$ for some $f\in T$, this is
the open set $D(f)\subset T$.  We now verify a corresponding
property for the ring map $R \to R_a$: we will show that the map
$\theta : \Spec(R_a) \to \Spec(R)$ induced by inclusion
$R\subset R_a$ is a homeomorphism onto an open subset of
$\Spec(R)$ by verifying that $\theta$ is an injective local
homeomorphism.  We do so with respect to an open cover of
$\Spec(R_a)$ by two distinguished opens, as we now describe.
For any $r\in\mathbf{Q}$, let $\text{ev}_r : R \to \mathbf{Q}$ be the
homomorphism given by evaluation at $r$.  Note that for $r = 0$ and
$r = 1-a$, this can be extended to a homomorphism
$\text{ev}_r' : R_a \to \mathbf{Q}$ (the latter because $\frac{1}{z-a}$
is well-defined at $z = 1-a$, since $a\neq\frac{1}{2}$).  However,
$\text{ev}_a$ does not extend to $R_a$.  Write
$\mathfrak{m}_r = \Ker(\text{ev}_r)$. We have
$$
\mathfrak{m}_0 = (z^2-z, z^3-z),
$$
$$
\mathfrak{m}_a = ((z-1 + a)(z-a), (z^2-1 + a)(z-a)), \text{ and}
$$
$$
\mathfrak{m}_{1-a} = ((z-1 + a)(z-a), (z-1 + a)(z^2-a)).
$$
To verify this, note that the right-hand sides are clearly contained in
the left-hand sides. Then check that the right-hand sides are
maximal ideals by writing the generators in terms of $A$ and $B$,
and viewing $R$ as $\mathbf{Q}[A, B]/(A^3-B^2 + AB)$. Note that
$\mathfrak{m}_a$ is not in the image of $\theta$: we have
$$
(z^2 - z)^2(z - a)(\frac{a^2 - a}{z - a} + z) =
(z^2 - z)^2(a^2 - a) + (z^2 - z)^2(z - a)z
$$
The left hand side is in $\mathfrak m_a R_a$ because
$(z^2 - z)(z - a)$ is in $\mathfrak m_a$ and because
$(z^2 - z)(\frac{a^2 - a}{z - a} + z)$ is in $R_a$. Similarly
the element $(z^2 - z)^2(z - a)z$ is in $\mathfrak m_a R_a$
because $(z^2 - z)$ is in $R_a$ and $(z^2 - z)(z - a)$ is in $\mathfrak m_a$.
As $a \not \in \{0, 1\}$ we conclude that
$(z^2 - z)^2 \in \mathfrak m_a R_a$. Hence
no ideal $I$ of $R_a$ can satisfy $I \cap R = \mathfrak m_a$, as such
an $I$ would have to contain $(z^2 - z)^2$, which is in $R$ but not in
$\mathfrak m_a$. The distinguished open set
$D((z-1 + a)(z-a))\subset\Spec(R)$ is equal to the complement of
the closed set $\{\mathfrak{m}_a, \mathfrak{m}_{1-a}\}$.
Then check that $R_{(z-1 + a)(z-a)} = (R_a)_{(z-1 + a)(z-a)}$; calling
this localized ring $R'$, then, it follows that the map $R \to R'$
factors as $R \to R_a \to R'$.  By Lemma
\ref{lemma-spec-localization}, then, these maps express
$\Spec(R') \subset \Spec(R_a)$ and
$\Spec(R') \subset \Spec(R)$ as open subsets; hence
$\theta : \Spec(R_a) \to \Spec(R)$, when restricted to
$D((z-1 + a)(z-a))$, is a homeomorphism onto an open subset.
Similarly, $\theta$ restricted to
$D((z^2 + z + 2a-2)(z-a)) \subset \Spec(R_a)$ is a homeomorphism
onto the open subset $D((z^2 + z + 2a-2)(z-a)) \subset \Spec(R)$.
Depending on whether $z^2 + z + 2a-2$ is irreducible or not over
$\mathbf{Q}$, this former distinguished open set has complement
equal to one or two closed points along with the closed point
$\mathfrak{m}_a$. Furthermore, the ideal in $R_a$ generated by the
elements $(z^2 + z + 2a-a)(z-a)$ and $(z-1 + a)(z-a)$ is all of $R_a$, so
these two distinguished open sets cover $\Spec(R_a)$. Hence in
order to show that $\theta$ is a homeomorphism onto
$\Spec(R)-\{\mathfrak{m}_a\}$, it suffices to show
that these one or two points can never equal $\mathfrak{m}_{1-a}$.
And this is indeed the case, since $1-a$ is a root of $z^2 + z + 2a-2$
if and only of $a = 0$ or $a = 1$, both of which do not occur.

\medskip\noindent
Despite this homeomorphism which mimics the behavior of a
localization at an element of $R$, while
$\mathbf{Q}[z, \frac{1}{z-a}]$ is the localization of $\mathbf{Q}[z]$
at the maximal ideal $(z-a)$, the ring $R_a$ is {\it not} a
localization of $R$: Any localization $S^{-1}R$ results in more
units than the original ring $R$.  The units of $R$ are
$\mathbf{Q}^\times$, the units of $\mathbf{Q}$.  In fact, it is
easy to see that the units of $R_a$ are $\mathbf{Q}^*$.
Namely, the units of $\mathbf{Q}[z, \frac{1}{z - a}]$ are
$c (z - a)^n$ for $c \in \mathbf{Q}^*$ and $n \in \mathbf{Z}$
and it is clear that these are in $R_a$ only if $n = 0$.
Hence $R_a$ has no more units than
$R$ does, and thus cannot be a localization of $R$.

\medskip\noindent
We used the fact that $a\neq 0, 1$ to ensure that
$\frac{1}{z-a}$ makes sense at $z = 0, 1$.  We used the fact that
$a\neq 1/2$ in a few places: (1) In order to be able to talk about
the kernel of $\text{ev}_{1-a}$ on $R_a$, which ensures that
$\mathfrak{m}_{1-a}$ is a point of $R_a$ (i.e., that $R_a$ is
missing just one point of $R$). (2) At the end in order to conclude
that $(z-a)^{k + \ell}$ can only be in $R$ for $k = \ell = 0$; indeed, if
$a = 1/2$, then this is in $R$ as long as $k + \ell$ is even. Hence
there would indeed be more units in $R_a$ than in $R$, and $R_a$
could possibly be a localization of $R$.
\end{example}





\section{A meta-observation about prime ideals}
\label{section-oka-families}

\noindent
This section is taken from the CRing project. Let $R$ be a ring and
let $S \subset R$ be a multiplicative subset.
A consequence of
Lemma \ref{lemma-spec-localization}
is that an ideal $I \subset R$ maximal with respect to the property
of not intersecting $S$ is prime. The reason is that $I = R \cap \mathfrak m$
for some maximal ideal $\mathfrak m$ of the ring $S^{-1}R$.
It turns out that for many properties of ideals, the maximal ones
are prime. A general method of seeing this was developed in \cite{Lam-Reyes}.
In this section, we digress to explain this phenomenon.

\medskip\noindent
Let $R$ be a ring. If $I$ is an ideal of $R$ and $a \in R$, we
define
$$
(I : a) = \left\{ x \in R \mid xa \in I\right\}.
$$
More generally, if $J \subset R$ is an ideal, we define
$$
(I : J) = \left\{ x \in R \mid xJ \subset I\right\}.
$$

\begin{lemma}
\label{lemma-colon}
Let $R$ be a ring. For a principal ideal $J \subset R$, and for any ideal
$I \subset J$ we have $I = J (I : J)$.
\end{lemma}

\begin{proof}
Say $J = (a)$. Then $(I : J) = (I : a)$.
Since $I \subset J$ we see that any $y \in I$ is of the form
$y = xa$ for some $x \in (I : a)$. Hence $I \subset J (I : J)$.
Conversely, if $x \in (I : a)$, then $xJ = (xa) \subset I$, which
proves the other inclusion.
\end{proof}

\noindent
Let $\mathcal{F}$ be a collection of ideals of $R$. We are interested in
conditions that will guarantee that the maximal elements in the complement
of $\mathcal{F}$ are prime.

\begin{definition}
\label{definition-oka-family}
Let $R$ be a ring. Let $\mathcal{F}$ be a set of ideals of $R$. We say
$\mathcal{F}$ is an {\it Oka family} if $R \in \mathcal{F}$ and
whenever $I \subset R$ is an ideal and $(I : a), (I, a) \in \mathcal{F}$
for some $a \in R$, then $I \in \mathcal{F}$.
\end{definition}

\noindent
Let us give some examples of Oka families. The first example is the basic
example discussed in the introduction to this section.

\begin{example}
\label{example-oka-family-not-meet-multiplicative-set}
Let $R$ be a ring and let $S$ be a multiplicative subset of $R$.
We claim that $\mathcal{F} = \{I \subset R \mid I \cap S \not = \emptyset\}$
is an Oka family. Namely, suppose that $(I : a), (I, a) \in \mathcal{F}$
for some $a \in R$. Then pick $s \in (I, a) \cap S$ and
$s' \in (I : a) \cap S$. Then $ss' \in I \cap S$ and hence
$I \in \mathcal{F}$. Thus $\mathcal{F}$ is an Oka family.
\end{example}

\begin{example}
\label{example-oka-family-finitely-generated}
Let $R$ be a ring, $I \subset R$ an ideal, and $a \in R$.
If $(I : a)$ is generated by $a_1, \ldots, a_n$ and $(I, a)$
is generated by $a, b_1, \ldots, b_m$ with
$b_1, \ldots, b_m \in I$, then $I$ is generated by
$aa_1, \ldots, aa_n, b_1, \ldots, b_m$.
To see this, note that if $x \in I$, then $x \in (I, a)$
is a linear combination of $a, b_1, \ldots, b_m$, but the
coefficient of $a$ must lie in $(I:a)$.
As a result, we deduce that
the family of finitely generated ideals is an Oka family.
\end{example}

\begin{example}
\label{example-oka-family-principal}
Let us show that the family of principal ideals of a ring $R$ is an Oka family.
Indeed, suppose $I \subset R$ is an ideal, $a \in R$, and $(I, a)$ and
$(I : a)$ are principal. Note that $(I : a) = (I : (I, a))$.
Setting $J = (I, a)$, we find that $J$ is principal and $(I : J)$ is too. By
Lemma \ref{lemma-colon}
we have $I = J (I : J)$.
Thus we find in our situation that since $J = (I, a)$ and $(I : J)$
are principal, $I$ is principal.
\end{example}

\begin{example}
\label{example-oka-family-bound-cardinality}
Let $R$ be a ring.
Let $\kappa$ be an infinite cardinal.
The family of ideals which can be generated by at most $\kappa$ elements
is an Oka family. The argument is analogous to the argument in
Example \ref{example-oka-family-finitely-generated}
and is omitted.
\end{example}

\begin{proposition}
\label{proposition-oka}
If $\mathcal{F}$ is an Oka family of ideals, then any maximal element of
the complement of $\mathcal{F}$ is prime.
\end{proposition}

\begin{proof}
Suppose $I \not \in \mathcal{F}$ is maximal with respect to not being in
$\mathcal{F}$ but $I$ is not prime. Note that $I \not = R$ because
$R \in \mathcal{F}$. Since $I$ is not prime we can find $a, b \in R - I$
with $ab \in I$. It follows that $(I, a) \neq I$ and $(I : a)$ contains
$b \not \in I$ so also $(I : a) \neq I$. Thus $(I : a), (I, a)$ both
strictly contain $I$, so they must belong to $\mathcal{F}$.
By the Oka condition, we have $I \in \mathcal{F}$, a contradiction.
\end{proof}

\noindent
At this point we are able to turn most of the examples above into
a lemma about prime ideals in a ring.

\begin{lemma}
\label{lemma-simple}
Let $R$ be a ring. Let $S$ be a multiplicative subset of $R$.
An ideal $I \subset R$ which is maximal with respect to the property
that $I \cap S = \emptyset$ is prime.
\end{lemma}

\begin{proof}
This is the example discussed in the introduction to this section.
For an alternative proof, combine
Example \ref{example-oka-family-not-meet-multiplicative-set}
with
Proposition \ref{proposition-oka}.
\end{proof}

\begin{lemma}
\label{lemma-cohen}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal $I \subset R$ maximal with respect to not being
finitely generated is prime.
\item If every prime ideal of $R$ is
finitely generated, then
every ideal of $R$ is finitely generated\footnote{Later we will say
that $R$ is Noetherian.}.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion is an immediate consequence of
Example \ref{example-oka-family-finitely-generated} and
Proposition \ref{proposition-oka}. For the second,
suppose that there exists an ideal $I \subset R$ which is not finitely
generated. The union of a totally ordered chain $\left\{I_\alpha\right\}$
of ideals that are not finitely generated is not finitely generated;
indeed, if $I = \bigcup I_\alpha$ were generated by
$a_1, \ldots, a_n$, then all the generators would belong to some
$I_\alpha $ and would consequently generate it.
By Zorn's lemma, there is an ideal maximal with respect to being not finitely
generated. By the first part this ideal is prime.
\end{proof}

\begin{lemma}
\label{lemma-primes-principal}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal $I \subset R$ maximal with respect to not being
principal is prime.
\item If every prime ideal of $R$ is principal, then
every ideal of $R$ is principal.
\end{enumerate}
\end{lemma}

\begin{proof}
The first part follows from
Example \ref{example-oka-family-principal} and
Proposition \ref{proposition-oka}.
For the second, suppose that there exists an ideal $I \subset R$
which is not principal. The union of a totally ordered chain
$\left\{I_\alpha\right\}$ of ideals that not principal is not principal;
indeed, if $I = \bigcup I_\alpha$ were generated by
$a$, then $a$ would belong to some $I_\alpha $ and $a$ would generate it.
By Zorn's lemma, there is an ideal maximal with respect to not being
principal. This ideal is necessarily prime by the first part.
\end{proof}

\begin{lemma}
\label{lemma-characterize-domain}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal maximal among the ideals which do not contain a
nonzerodivisor is prime.
\item If every nonzero prime ideal in $R$ contains a nonzerodivisor,
then $R$ is a domain.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the set $S$ of nonzerodivisors. It is a multiplicative
subset of $R$. Hence any ideal maximal with respect to not intersecting
$S$ is prime, see
Lemma \ref{lemma-simple}.
Thus, if every nonzero prime ideal contains a nonzerodivisor, then
$(0)$ is prime, i.e., $R$ is a domain.
\end{proof}

\begin{remark}
\label{remark-cohen-bound-cardinality}
Let $R$ be a ring. Let $\kappa$ be an infinite cardinal.
By applying
Example \ref{example-oka-family-bound-cardinality} and
Proposition \ref{proposition-oka}
we see that any ideal maximal with respect to the property of not being
generated by $\kappa$ elements is prime. This result is not so
useful because there exists a ring for which every prime ideal
of $R$ can be generated by $\aleph_0$ elements, but some
ideal cannot. Namely, let $k$ be a field, let $T$ be a set whose
cardinality is greater than $\aleph_0$ and let
$$
R = k[\{x_n\}_{n \geq 1}, \{z_{t, n}\}_{t \in T, n \geq 0}]/
(x_n^2, z_{t, n}^2, x_n z_{t, n} - z_{t, n - 1})
$$
This is a local ring with unique prime ideal
$\mathfrak m = (x_n)$. But the ideal $(z_{t, n})$ cannot
be generated by countably many elements.
\end{remark}












\section{Images of ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the
topology of maps $\Spec(S) \to \Spec(R)$
induced by ring maps $R \to S$, mainly Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \Spec(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\Spec(R)$,
\item $U$ is quasi-compact,
\item $U$ is a finite union of standard opens, and
\item there exists a finitely generated ideal $I \subset R$ such
that $X \setminus V(I) = U$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have (1) $\Rightarrow$ (2) because $\Spec(R)$ is quasi-compact, see
Lemma \ref{lemma-quasi-compact}. We have (2) $\Rightarrow$ (3) because
standard opens form a basis for the topology. Proof of (3) $\Rightarrow$ (1).
Let $U = \bigcup_{i = 1\ldots n} D(f_i)$. To show that $U$ is retrocompact
in $\Spec(R)$ it suffices to show that $U \cap V$ is quasi-compact for any
quasi-compact open $V$ of $\Spec(R)$. Write
$V = \bigcup_{j = 1\ldots m} D(g_j)$ which is possible by (2) $\Rightarrow$
(3). Each standard open is homeomorphic to the spectrum of a ring and hence
quasi-compact, see Lemmas \ref{lemma-standard-open} and
\ref{lemma-quasi-compact}. Thus
$U \cap V =
(\bigcup_{i = 1\ldots n} D(f_i)) \cap (\bigcup_{j = 1\ldots m} D(g_j))
= \bigcup_{i, j} D(f_i g_j)$ is a finite union of quasi-compact opens
hence quasi-compact. To finish the proof note
that (4) is equivalent to (3) by 
Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-affine-map-quasi-compact}
Let $\varphi : R \to S$ be a ring map.
The induced continuous map $f : \Spec(S) \to \Spec(R)$
is quasi-compact. For any constructible set $E \subset \Spec(R)$
the inverse image $f^{-1}(E)$ is constructible in $\Spec(S)$.
\end{lemma}

\begin{proof}
We first show that the inverse image of any quasi-compact
open $U \subset \Spec(R)$ is quasi-compact. By
Lemma \ref{lemma-qc-open} we may write $U$ as a finite
open of standard opens. Thus by Lemma \ref{lemma-spec-functorial}
we see that $f^{-1}(U)$ is a finite union of standard opens.
Hence $f^{-1}(U)$ is quasi-compact by Lemma \ref{lemma-qc-open} again.
The second assertion now follows from Topology, Lemma
\ref{topology-lemma-inverse-images-constructibles}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \Spec(R)$
be constructible. Then there exists a ring map $R \to S$ of
finite presentation such that $T$ is the image of
$\Spec(S)$ in $\Spec(R)$.
\end{lemma}

\begin{proof}
Let $T \subset \Spec(R)$ be constructible.
The spectrum of a finite product of rings
is the disjoint union of the spectra, see
Lemma \ref{lemma-spec-product}. Hence if $T = T_1 \cup T_2$
and the result holds for $T_1$ and $T_2$, then the
result holds for $T$. In particular we may assume
that $T = U \cap V^c$, where $U, V \subset \Spec(R)$
are retrocompact open. By Lemma \ref{lemma-qc-open} we may write
$T = (\bigcup D(f_i)) \cap (\bigcup D(g_j))^c =
\bigcup \big(D(f_i) \cap V(g_1, \ldots, g_m)\big)$.
In fact we may assume that $T = D(f) \cap V(g_1, \ldots, g_m)$
(by the argument on unions above).
In this case $T$ is the image of the map
$R \to (R/(g_1, \ldots, g_m))_f$, see Lemmas
\ref{lemma-standard-open} and \ref{lemma-spec-closed}.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible subset of $\Spec(S)$
is constructible in $\Spec(R)$.
\end{lemma}

\begin{proof}
We repeatedly use Lemma \ref{lemma-qc-open} without mention.
Let $U, V$ be quasi-compact open in $\Spec(S)$.
We will show that the image of $U \cap V^c$ is constructible.
Under the identification
$\Spec(S) = D(f)$ of Lemma \ref{lemma-standard-open}
the sets $U, V$ correspond to quasi-compact opens
$U', V'$ of $\Spec(R)$.
Hence it suffices to show that $U' \cap (V')^c$
is constructible in $\Spec(R)$ which is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\Spec(S)$
is constructible in $\Spec(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1, \ldots, f_m)$, then we see that
$V(I)$ is the complement of $\bigcup D(f_i)$,
see Lemma \ref{lemma-Zariski-topology}.
Hence it is constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\Spec(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\Spec(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \bigcup D(\overline{g_i})$.
Setting $U = \bigcup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\Spec(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\Spec(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\Spec(R[x]) \to \Spec(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R[x]$ is quasi-compact open.
The image of $D(f)$ is the image of
$\Spec(R[x]_f) \to \Spec(R)$.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\overline{f}$ be the image of $f$ in
$\kappa(\mathfrak p)[x]$.
Recall, see Lemma \ref{lemma-in-image},
that $\mathfrak p$ is in the image
if and only if $R[x]_f \otimes_R \kappa(\mathfrak p) =
\kappa(\mathfrak p)[x]_{\overline{f}}$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\noindent
We prove a property of characteristic polynomials which
will be used below.

\begin{lemma}
\label{lemma-characteristic-polynomial-prime}
Let $R \to A$ be a ring homomorphism.
Assume $A \cong R^{\oplus n}$ as an $R$-module.
Let $f \in A$. The multiplication map $m_f: A
\to A$ is $R$-linear and hence
has a characteristic polynomial
$P(T) = T^n + r_{n-1}T^{n-1} + \ldots + r_0 \in R[T]$.
For any prime
$\mathfrak{p} \in \Spec(R)$, $f$ acts nilpotently on $A
\otimes_R \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in
V(r_0, \ldots, r_{n-1})$.
\end{lemma}

\begin{proof}
This follows quite easily once we prove that the characteristic
polynomial $\bar P(T) \in \kappa(\mathfrak p)[T]$ of the
multiplication map $m_{\bar f}: A \otimes_R \kappa(\mathfrak p) \to
A \otimes_R \kappa(\mathfrak p)$ which multiplies elements of $A
\otimes_R \kappa(\mathfrak p)$ by $\bar f$, the image of $f$ viewed in
$\kappa(\mathfrak p)$, is just the image of $P(T)$ in
$\kappa(\mathfrak p)[T]$. Let $(a_{ij})$ be the matrix of the map
$m_f$ with entries in $R$, using a basis $e_1, \ldots, e_n$
of $A$ as an $R$-module.
Then, $A \otimes_R \kappa(\mathfrak p) \cong (R \otimes_R
\kappa(\mathfrak p))^{\oplus n} = \kappa(\mathfrak p)^n$, which is
an $n$-dimensional vector space over $\kappa(\mathfrak p)$ with
basis $e_1 \otimes 1, \ldots, e_n \otimes 1$. The image $\bar f = f
\otimes 1$, and so the multiplication map $m_{\bar f}$ has matrix
$(a_{ij} \otimes 1)$. Thus, the characteristic polynomial is
precisely the image of $P(T)$.

\medskip\noindent
From linear algebra, we know that a linear transformation acts
nilpotently on an $n$-dimensional vector space if and only if the
characteristic polynomial is $T^n$ (since the characteristic
polynomial divides some power of the minimal polynomial). Hence,
$f$ acts nilpotently on $A \otimes_R \kappa(\mathfrak p)$ if and
only if $\bar P(T) = T^n$. This occurs if and only if $r_i \in
\mathfrak p$ for all $0 \leq i \leq n - 1$, that is when $\mathfrak p \in
V(r_0, \ldots, r_{n - 1}).$
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i = 1\ldots, n$ such that
the image of $D(f) \cap V(g)$ in $\Spec(R)$ is
$\bigcup_{i = 1, \ldots, n} D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots + a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1, x, \ldots, x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots + r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }f\text{ is nilpotent on }
A \otimes_R \kappa(\mathfrak p).
$$
This was proved in Lemma \ref{lemma-characteristic-polynomial-prime}.

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then there is a nonzero map
$A \otimes_R \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ which
is compatible with multiplication by $f$.
And $f$ acts as a unit on $\kappa(\mathfrak q)$.
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d - 1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a prime ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}[Chevalley's Theorem]
\label{theorem-chevalley}
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\Spec(S)$ in $\Spec(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1, x_2]
\to \ldots \to R[x_1, \ldots, x_{n-1}] \to S$. Hence
we may assume that $S = R[x]/(f_1, \ldots, f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\bigcup_{i = 1\ldots n} D(f_i)) \cap V(g_1, \ldots, g_m)$
for $f_i , g_j \in R[x]$ then the image in $\Spec(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n = 1$,
i.e., when $T = D(f) \cap V(g_1, \ldots, g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have
$$
\Spec(R) =
V(c) \amalg D(c) =
\Spec(R/(c)) \amalg \Spec(R_c)),
$$
and correspondingly $\Spec(R[x]) =
V(c) \amalg D(c) = \Spec(R/(c)[x]) \amalg
\Spec(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1, \ldots, g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\Spec(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\Spec(R/(c))$, respectively
$\Spec(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1, \ldots, g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1, g_2', g_3\ldots, g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}











\section{More on images}
\label{section-more-images}

\noindent
In this section we collect a few additional lemmas concerning the image
on $\Spec$ for ring maps. See also Section \ref{section-going-up}
for example.

\begin{lemma}
\label{lemma-generic-finite-presentation}
Let $R \subset S$ be an inclusion of domains.
Assume that $R \to S$ is of finite type.
There exists a nonzero $f \in R$, and a nonzero $g \in S$
such that $R_f \to S_{fg}$ is of finite presentation.
\end{lemma}

\begin{proof}
By induction on the number of generators of $S$ over $R$.
During the proof we may replace $R$ by $R_f$ and $S$ by $S_f$
for some nonzero $f \in R$.

\medskip\noindent
Suppose that $S$ is generated by a single element
over $R$. Then $S = R[x]/\mathfrak q$ for some
prime ideal $\mathfrak q \subset R[x]$. If $\mathfrak q = (0)$
there is nothing to prove. If $\mathfrak q \not = (0)$,
then let $h \in \mathfrak q$ be a nonzero element with minimal
degree in $x$. Write $g = f x^d + a_{d - 1} x^{d - 1} + \ldots + a_0$
with $a_i \in R$ and $f \not = 0$. After inverting $f$
in $R$ and $S$ we may assume that $h$ is monic. We obtain
a surjective $R$-algebra map $R[x]/(h) \to S$.
We have $R[x]/(h) = R \oplus Rx \oplus \ldots \oplus Rx^{d - 1}$
as an $R$-module and by minimality of $d$ we see that
$R[x]/(h)$ maps injectively into $S$. Thus $R[x]/(h) \cong S$
is finitely presented over $R$.

\medskip\noindent
Suppose that $S$ is generated by $n > 1$ elements over $R$.
Say $x_1, \ldots, x_n \in S$ generate $S$. Denote $S' \subset S$
the subring generated by $x_1, \ldots, x_{n-1}$. By induction
hypothesis we see that there exist $f\in R$ and $g \in S'$
nonzero such that $R_f \to S'_{fg}$ is of finite presentation.
Next we apply the induction hypothesis to $S'_{fg} \to S_{fg}$
to see that there exist $f' \in S'_{fg}$ and
$g' \in S_{fg}$ such that $S'_{fgf'} \to S_{fgf'g'}$
is of finite presentation. We leave it to the reader to conclude.
\end{proof}

\begin{lemma}
\label{lemma-characterize-image-finite-type}
Let $R \to S$ be a finite type ring map.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \Spec(S)$ be a
constructible set.
If a point $\xi \in X$ is in $f(E)$, then
$\overline{\{\xi\}} \cap f(E)$ contains an open
dense subset of $\overline{\{\xi\}}$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ be a point of $f(E)$. Choose a point $\eta \in E$
mapping to $\xi$. Let $\mathfrak p \subset R$ be the prime
corresponding to $\xi$ and let $\mathfrak q \subset S$ be the
prime corresponding to $\eta$. Consider the diagram
$$
\xymatrix{
\eta \ar[r] \ar@{|->}[d] & E \cap Y' \ar[r] \ar[d] &
Y' = \Spec(S/\mathfrak q) \ar[r] \ar[d] &
Y \ar[d] \\
\xi \ar[r] & f(E) \cap X' \ar[r] &
X' = \Spec(R/\mathfrak p) \ar[r] &
X
}
$$
By Lemma \ref{lemma-affine-map-quasi-compact} the set $E \cap Y'$
is constructible in $Y'$.
It follows that we may replace $X$ by $X'$ and
$Y$ by $Y'$. Hence we may assume that $R \subset S$ is an
inclusion of domains, $\xi$ is the generic
point of $X$, and $\eta$ is the generic point of $Y$.
By Lemma \ref{lemma-generic-finite-presentation}
combined with Chevalley's theorem
(Theorem \ref{theorem-chevalley})
we see that there exist dense opens $U \subset X$,
$V \subset Y$ such that $f(V) \subset U$ and
such that $f : V \to U$ maps constructible sets
to constructible sets. Note that $E \cap V$ is
constructible in $V$, see Topology,
Lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}.
Hence $f(E \cap V)$ is constructible in $U$ and contains $\xi$.
By Topology, Lemma \ref{topology-lemma-generic-point-in-constructible}
we see that $f(E \cap V)$ contains a dense open $U' \subset U$.
\end{proof}

\noindent
At the end of this section we present a few more results on
images of maps on Spectra that have nothing to do with constructible
sets.

\begin{lemma}
\label{lemma-surjective-spec-radical-ideal}
Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The map $\Spec(S) \to \Spec(R)$ is surjective.
\item For any ideal $I \subset R$
the inverse image of $\sqrt{IS}$ in $R$ is equal to $\sqrt{I}$.
\item For any radical ideal $I \subset R$ the inverse image
of $IS$ in $R$ is equal to $I$.
\item For every prime $\mathfrak p$ of $R$ the inverse
image of $\mathfrak p S$ in $R$ is $\mathfrak p$.
\end{enumerate}
In this case the same is true after any base change: Given a ring map
$R \to R'$ the ring map $R' \to R' \otimes_R S$ has the equivalent
properties (1), (2), (3) as well.
\end{lemma}

\begin{proof}
If $J \subset S$ is an ideal, then
$\sqrt{\varphi^{-1}(J)} = \varphi^{-1}(\sqrt{J})$. This shows that (2)
and (3) are equivalent.
The implication (3) $\Rightarrow$ (4) is immediate.
If $I \subset R$ is a radical ideal, then
Lemma \ref{lemma-Zariski-topology}
guarantees that $I = \bigcap_{I \subset \mathfrak p} \mathfrak p$.
Hence (3) $\Rightarrow$ (2). By
Lemma \ref{lemma-in-image}
we have $\mathfrak p = \varphi^{-1}(\mathfrak p S)$ if and only if
$\mathfrak p$ is in the image. Hence (1) $\Leftrightarrow$ (4).
Thus (1), (2), (3), and (4) are equivalent.

\medskip\noindent
Assume (1) holds. Let $R \to R'$ be a ring map. Let
$\mathfrak p' \subset R'$ be a prime ideal lying over the prime
$\mathfrak p$ of $R$. To see that $\mathfrak p'$ is in the image
of $\Spec(R' \otimes_R S) \to \Spec(R')$ we have to show
that $(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p')$ is not zero, see
Lemma \ref{lemma-in-image}.
But we have
$$
(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p') =
S \otimes_R \kappa(\mathfrak p)
\otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')
$$
which is not zero as $S \otimes_R \kappa(\mathfrak p)$ is not zero
by assumption and $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$ is
an extension of fields.
\end{proof}

\begin{lemma}
\label{lemma-domain-image-dense-set-points-generic-point}
Let $R$ be a domain. Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The ring map $R \to S$ is injective.
\item The image $\Spec(S) \to \Spec(R)$
contains a dense set of points.
\item There exists a prime ideal $\mathfrak q \subset S$
whose inverse image in $R$ is $(0)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be the field of fractions of the domain $R$.
Assume that $R \to S$ is injective. Since localization
is exact we see that $K \to S \otimes_R K$ is injective.
Hence there is a prime mapping to $(0)$ by
Lemma \ref{lemma-in-image}.

\medskip\noindent
Note that $(0)$ is dense in $\Spec(R)$, so that the
last condition implies the second.

\medskip\noindent
Suppose the second condition holds. Let $f \in R$,
$f \not = 0$. As $R$ is a domain we see that $V(f)$
is a proper closed subset of $R$. By assumption
there exists a prime $\mathfrak q$
of $S$ such that $\varphi(f) \not \in \mathfrak q$.
Hence $\varphi(f) \not = 0$.
Hence $R \to S$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-injective-minimal-primes-in-image}
Let $R \subset S$ be an injective ring map.
Then $\Spec(S) \to \Spec(R)$
hits all the minimal primes of $\Spec(R)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a minimal prime.
In this case $R_{\mathfrak p}$ has a unique prime ideal.
Hence it suffices to show that $S_{\mathfrak p}$ is not zero.
And this follows from the fact that localization is exact,
see Proposition \ref{proposition-localization-exact}.
\end{proof}

\begin{lemma}
\label{lemma-image-dense-generic-points}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item The kernel of $R \to S$ consists of nilpotent elements.
\item The minimal primes of $R$ are in the image of
$\Spec(S) \to \Spec(R)$.
\item The image of $\Spec(S) \to \Spec(R)$ is dense
in $\Spec(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $I = \Ker(R \to S)$. Note that
$\sqrt{(0)} = \bigcap_{\mathfrak q \subset S} \mathfrak q$, see
Lemma \ref{lemma-Zariski-topology}.
Hence $\sqrt{I} = \bigcap_{\mathfrak q \subset S} R \cap \mathfrak q$.
Thus $V(I) = V(\sqrt{I})$ is the closure of the image of
$\Spec(S) \to \Spec(R)$.
This shows that (1) is equivalent to (3). It is clear that
(2) implies (3). Finally, assume (1). We may replace
$R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology
of the spectra and the map. Hence the implication (1) $\Rightarrow$ (2)
follows from Lemma \ref{lemma-injective-minimal-primes-in-image}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-prime-image-minimal-prime}
Let $R \to S$ be a ring map. If a minimal prime $\mathfrak p \subset R$
is in the image of $\Spec(S) \to \Spec(R)$, then it is the image
of a minimal prime.
\end{lemma}

\begin{proof}
Say $\mathfrak p = \mathfrak q \cap R$. Then choose a minimal
prime $\mathfrak r \subset S$ with $\mathfrak r \subset \mathfrak q$, see
Lemma \ref{lemma-Zariski-topology}.
By minimality of $\mathfrak p$ we see that
$\mathfrak p = \mathfrak r \cap R$.
\end{proof}







\section{Noetherian rings}
\label{section-Noetherian}

\noindent
A ring $R$ is {\it Noetherian} if any ideal of $R$ is finitely generated.
This is clearly equivalent to the ascending chain condition for ideals of $R$.
By
Lemma \ref{lemma-cohen}
it suffices to check that every prime ideal of $R$ is finitely generated.

\begin{lemma}
\label{lemma-Noetherian-permanence}
\begin{slogan}
Noetherian property is stable by passage to finite type extension
and localization.
\end{slogan}
Any finitely generated ring over a Noetherian ring
is Noetherian. Any localization of a Noetherian ring
is Noetherian.
\end{lemma}

\begin{proof}
The statement on localizations follows from the fact
that any ideal $J \subset S^{-1}R$ is of the form
$I \cdot S^{-1}R$. Any quotient $R/I$ of a Noetherian
ring $R$ is Noetherian because any ideal $\overline{J} \subset R/I$
is of the form $J/I$ for some ideal $I \subset J \subset R$.
Thus it suffices to show that if $R$ is Noetherian so
is $R[X]$. Suppose $J_1 \subset J_2 \subset \ldots$ is an
ascending chain of ideals in $R[X]$. Consider the ideals $I_{i, d}$
defined as the ideal of elements of $R$ which occur as leading
coefficients of degree $d$ polynomials in $J_i$.
Clearly $I_{i, d} \subset I_{i', d'}$ whenever
$i \leq i'$ and $d \leq d'$. By the ascending chain condition
in $R$ there are at most finitely many distinct ideals among all of
the $I_{i, d}$.
(Hint: Any infinite set of elements of
$\mathbf{N} \times \mathbf{N}$ contains an increasing
infinite sequence.)
Take $i_0$ so large that $I_{i, d} = I_{i_0, d}$
for all $i \geq i_0$ and all $d$. Suppose $f \in J_i$ for some $i \geq i_0$.
By induction on the degree $d = \deg(f)$ we show that $f \in J_{i_0}$.
Namely, there exists a $g\in J_{i_0}$ whose degree is $d$ and which
has the same leading coefficient as $f$. By induction
$f - g \in J_{i_0}$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power-series}
If $R$ is a Noetherian ring, then so is the formal power
series ring $R[[x_1, \ldots, x_n]]$.
\end{lemma}

\begin{proof}
Since $R[[x_1, \ldots, x_{n + 1}]] \cong R[[x_1, \ldots, x_n]][[x_{n + 1}]]$
it suffices to prove the statement that $R[[x]]$ is Noetherian if
$R$ is Noetherian. Let $I \subset R[[x]]$ be a ideal.
We have to show that $I$ is a finitely generated ideal.
For each integer
$d$ denote $I_d = \{a \in R \mid ax^d + \text{h.o.t.} \in I\}$.
Then we see that $I_0 \subset I_1 \subset \ldots$ stabilizes as $R$
is Noetherian. Choose $d_0$ such that $I_{d_0} = I_{d_0 + 1} = \ldots$.
For each $d \leq d_0$ choose elements $f_{d, j} \in I \cap (x^d)$,
$j = 1, \ldots, n_d$ such that if we write
$f_{d, j} = a_{d, j}x^d + \text{h.o.t}$ then $I_d = (a_{d, j})$.
Denote $I' = (\{f_{d, j}\}_{d = 0, \ldots, d_0, j = 1, \ldots, n_d})$.
Then it is clear that $I' \subset I$. Pick $f \in I$.
First we may choose $c_{d, i} \in R$ such that
$$
f - \sum c_{d, i} f_{d, i} \in (x^{d_0 + 1}) \cap I.
$$
Next, we can choose $c_{i, 1} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i} \in (x^{d_0 + 2}) \cap I.
$$
Next, we can choose $c_{i, 2} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i}
- \sum c_{i, 2}x^2f_{d_0, i}
\in (x^{d_0 + 3}) \cap I.
$$
And so on. In the end we see that
$$
f = \sum c_{d, i} f_{d, i} +
\sum\nolimits_i (\sum\nolimits_e c_{i, e} x^e)f_{d_0, i}
$$
is contained in $I'$ as desired.
\end{proof}

\noindent
The following lemma, although easy, is useful because
finite type $\mathbf{Z}$-algebras come up quite often in
a technique called ``absolute Noetherian reduction''.

\begin{lemma}
\label{lemma-obvious-Noetherian}
Any finite type algebra over a field is Noetherian.
Any finite type algebra over $\mathbf{Z}$ is Noetherian.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-Noetherian-permanence}
and the fact that fields are Noetherian rings and that
$\mathbf{Z}$ is Noetherian ring (because it is a
principal ideal domain).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-finite-type-is-finite-presentation}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Any finite $R$-module is of finite presentation.
\item Any finite type $R$-algebra is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $M$ be a finite $R$-module. By
Lemma \ref{lemma-trivial-filter-finite-module}
we can find a finite filtration of $M$ whose successive quotients are
of the form $R/I$. Since any ideal is finitely generated, each of
the quotients $R/I$ is finitely presented. Hence $M$ is finitely
presented by
Lemma \ref{lemma-extension}.
This proves (1).
To see (2) note that any ideal of
$R[x_1, \ldots, x_n]$ is finitely generated by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-topology}
If $R$ is a Noetherian ring then $\Spec(R)$
is a Noetherian topological space, see Topology,
Definition \ref{topology-definition-noetherian}.
\end{lemma}

\begin{proof}
This is because any closed subset of $\Spec(R)$
is uniquely of the form $V(I)$ with $I$ a radical ideal,
see Lemma \ref{lemma-Zariski-topology}.
And this correspondence is inclusion reversing.
Thus the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-irreducible-components}
\begin{slogan}
A noetherian affine scheme has finitely many generic points.
\end{slogan}
If $R$ is a Noetherian ring then $\Spec(R)$
has finitely many irreducible components. In other words
$R$ has finitely many minimal primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} and
Topology, Lemma \ref{topology-lemma-Noetherian}
we see there are finitely many irreducible components.
By Lemma \ref{lemma-irreducible} these correspond to
minimal primes of $R$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-base-change-finite-type}
Let $R \to S$ be a ring map. Let $R \to R'$ be of finite type.
If $S$ is Noetherian, then the base change $S' = R' \otimes_R S$
is Noetherian.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-finiteness} finite type is stable under
base change. Thus $S \to S'$ is of finite type. Since $S$ is Noetherian we
can apply Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-field-extension}
Let $k$ be a field and let $R$ be a Noetherian $k$-algebra.
If $K/k$ is a finitely generated field extension then
$K \otimes_k R$ is Noetherian.
\end{lemma}

\begin{proof}
Since $K/k$ is a finitely generated field extension, there exists
a finitely generated $k$-algebra $B \subset K$ such that $K$ is
the fraction field of $B$. In other words, $K = S^{-1}B$
with $S = B \setminus \{0\}$. Then $K \otimes_k R = S^{-1}(B \otimes_k R)$.
Then $B \otimes_k R$ is Noetherian by
Lemma \ref{lemma-Noetherian-base-change-finite-type}.
Finally, $K \otimes_k R = S^{-1}(B \otimes_k R)$ is Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\noindent
Here are some fun lemmas that are sometimes useful.

\begin{lemma}
\label{lemma-subring-of-local-ring}
Let $R$ be a ring and $\mathfrak p \subset R$ be a prime.
There exists an $f \in R$, $f \not \in \mathfrak p$ such
that $R_f \to R_\mathfrak p$ is injective in each of the
following cases
\begin{enumerate}
\item $R$ is a domain,
\item $R$ is Noetherian, or
\item $R$ is reduced and has finitely many minimal primes.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R$ is a domain, then $R \subset R_\mathfrak p$, hence $f = 1$ works.
If $R$ is Noetherian, then the kernel $I$ of $R \to R_\mathfrak p$
is a finitely generated ideal and we can find
$f \in R$, $f \not \in \mathfrak p$ such that $IR_f = 0$.
For this $f$ the map $R_f \to R_\mathfrak p$ is injective
and $f$ works. If $R$ is reduced with finitely
many minimal primes $\mathfrak p_1, \ldots, \mathfrak p_n$,
then we can choose
$f \in \bigcap_{\mathfrak p_i \not \subset \mathfrak p} \mathfrak p_i$,
$f \not \in \mathfrak p$. Indeed, if $\mathfrak{p}_i\not\subset
\mathfrak{p}$ then there exist $f_i \in \mathfrak{p}_i$,
$f_i \not\in \mathfrak{p}$ and $f = \prod f_i$ works.
For this $f$ we have $R_f \subset R_\mathfrak p$ because the minimal
primes of $R_f$ correspond to minimal primes of $R_\mathfrak p$
and we can apply Lemma \ref{lemma-reduced-ring-sub-product-fields}
(some details omitted).
\end{proof}

\begin{lemma}
\label{lemma-surjective-endo-noetherian-ring-is-iso}
Any surjective endomorphism of a Noetherian ring is an isomorphism.
\end{lemma}

\begin{proof}
If $f : R \to R$ were such an endomorphism but not injective, then
$$
\Ker(f) \subset \Ker(f \circ f) \subset
\Ker(f \circ f \circ f) \subset \ldots
$$
would be a strictly increasing chain of ideals.
\end{proof}







\section{Locally nilpotent ideals}
\label{section-locally-nilpotent}

\noindent
Here is the definition.

\begin{definition}
\label{definition-locally-nilpotent-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
We say $I$ is {\it locally nilpotent} if for every
$x \in I$ there exists an $n \in \mathbf{N}$ such
that $x^n = 0$. We say $I$ is {\it nilpotent} if
there exists an $n \in \mathbf{N}$ such that $I^n = 0$.
\end{definition}

\begin{lemma}
\label{lemma-locally-nilpotent}
Let $R \to R'$ be a ring map and let $I \subset R$ be a locally nilpotent
ideal. Then $IR'$ is a locally nilpotent ideal of $R'$.
\end{lemma}

\begin{proof}
This follows from the fact that if $x, y \in R'$ are nilpotent, then
$x + y$ is nilpotent too. Namely, if $x^n = 0$ and $y^m = 0$, then
$(x + y)^{n + m - 1} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-locally-nilpotent-unit}
Let $R$ be a ring and let $I \subset R$ be a locally nilpotent
ideal.
An element $x$ of $R$ is a unit if and only if the image of $x$
in $R/I$ is a unit.
\end{lemma}

\begin{proof}
If $x$ is a unit in $R$, then its image is clearly a unit in $R/I$.
It remains to prove the converse.
Assume the image of $y \in R$ in $R/I$ is the inverse of the image of $x$.
Then $xy = 1 - z$ for some $z \in I$. Then every $k \geq 1$
satisfies
$$
(1 - z)(1 + z)(1 + z^2)(1 + z^4)\ldots (1 + z^{2^{k - 1}}) =
1 - z^{2^k}
$$
(as follows by induction over $k$). But the right hand side is
is equal to $1$ for sufficiently large $k$ (since $z$ lies in the
locally nilpotent ideal $I$). Thus $1 - z$ is invertible in $R$, and
therefore so is $x$ (as $xy = 1 - z$).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power}
\begin{slogan}
An ideal in a Noetherian ring is nilpotent if each element
of the ideal is nilpotent.
\end{slogan}
Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$.
Suppose $J \subset \sqrt{I}$. Then $J^n \subset I$ for some $n$.
In particular, in a Noetherian ring the notions of
``locally nilpotent ideal''
and ``nilpotent ideal'' coincide.
\end{lemma}

\begin{proof}
Say $J = (f_1, \ldots, f_s)$.
By assumption $f_i^{d_i} \in I$.
Take $n = d_1 + d_2 + \ldots + d_s + 1$.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Then $R \to R/I$ induces a bijection on idempotents.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-lift-idempotents}]
As $I$ is locally nilpotent it is contained in every prime ideal.
Hence $\Spec(R/I) = V(I) = \Spec(R)$. Hence the
lemma follows from Lemma \ref{lemma-disjoint-decomposition}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-lift-idempotents}]
Suppose $\overline{e} \in R/I$ is an idempotent.
We have to lift $\overline{e}$ to an idempotent of $R$.

\medskip\noindent
First, choose any lift $f \in R$ of $\overline{e}$, and set
$x = f^2 - f$. Then, $x \in I$, so $x$ is nilpotent (since $I$
is locally nilpotent). Let now $J$ be the ideal of $R$ generated
by $x$. Then, $J$ is nilpotent (not just locally nilpotent),
since it is generated by the nilpotent $x$.

\medskip\noindent
Now, assume that we have found a lift $e \in R$ of $\overline{e}$
such that $e^2 - e \in J^k$ for some $k \geq 1$.
Let $e' = e - (2e - 1)(e^2 - e) = 3e^2 - 2e^3$, which is another
lift of $\overline{e}$ (since the idempotency of $\overline{e}$
yields $e^2 - e \in I$). Then
$$
(e')^2 - e' = (4e^2 - 4e - 3)(e^2 - e)^2 \in J^{2k}
$$
by a simple computation.

\medskip\noindent
We thus have started with a lift $e$ of $\overline{e}$ such
that $e^2 - e \in J^k$, and obtained a lift $e'$ of
$\overline{e}$ such that $(e')^2 - e' \in J^{2k}$.
This way we can successively improve the approximation
(starting with $e = f$, which fits the bill for $k = 1$).
Eventually, we reach a stage where $J^k = 0$, and at that
stage we have a lift $e$ of $\overline{e}$ such that
$e^2 - e \in J^k = 0$, that is, this $e$ is idempotent.

\medskip\noindent
We thus have seen that if $\overline{e} \in R/I$ is any
idempotent, then there exists a lift of $\overline{e}$
which is an idempotent of $R$.
It remains to prove that this lift is unique. Indeed, let
$e_1$ and $e_2$ be two such lifts. We
need to show that $e_1 = e_2$.

\medskip\noindent
By definition of $e_1$ and $e_2$, we have $e_1 \equiv e_2
\mod I$, and both $e_1$ and $e_2$ are idempotent. From
$e_1 \equiv e_2 \mod I$, we see that $e_1 - e_2 \in I$,
so that $e_1 - e_2$ is nilpotent (since $I$ is locally nilpotent).
A straightforward
computation (using the idempotency of $e_1$ and $e_2$)
reveals that $(e_1 - e_2)^3 = e_1 - e_2$. Using this and
induction, we obtain $(e_1 - e_2)^k = e_1 - e_2$ for any
positive integer $k$. Since all high enough $k$ satisfy
$(e_1 - e_2)^k = 0$ (since $e_1 - e_2$ is nilpotent),
this shows $e_1 - e_2 = 0$, so that $e_1 = e_2$, which
completes our proof.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents-noncommutative}
Let $A$ be a possibly noncommutative algebra.
Let $e \in A$ be an element such that $x = e^2 - e$ is nilpotent.
Then there exists an idempotent of the form
$e' = e + x(\sum a_{i, j}e^ix^j) \in A$
with $a_{i, j} \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the ring $R_n = \mathbf{Z}[e]/((e^2 - e)^n)$. It is clear that
if we can prove the result for each $R_n$ then the lemma follows.
In $R_n$ consider the ideal $I = (e^2 - e)$ and apply
Lemma \ref{lemma-lift-idempotents}.
\end{proof}

\begin{lemma}
\label{lemma-lift-nth-roots}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Let $n \geq 1$ be an integer which is invertible in $R/I$. Then
\begin{enumerate}
\item the $n$th power map $1 + I \to 1 + I$, $1 + x \mapsto (1 + x)^n$
is a bijection,
\item a unit of $R$ is a $n$th power if and only if its image in $R/I$
is an $n$th power.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $a \in R$ be a unit whose image in $R/I$ is the same as the image
of $b^n$ with $b \in R$. Then $b$ is a unit
(Lemma \ref{lemma-locally-nilpotent-unit}) and
$ab^{-n} = 1 + x$ for some $x \in I$. Hence $ab^{-n} = c^n$ by
part (1). Thus (2) follows from (1).

\medskip\noindent
Proof of (1). This is true because there is an inverse to the
map $1 + x \mapsto (1 + x)^n$. Namely, we can consider the map
which sends $1 + x$ to
\begin{align*}
(1 + x)^{1/n}
& =
1 + {1/n \choose 1}x +
{1/n \choose 2}x^2 +
{1/n \choose 3}x^3 + \ldots \\
& =
1 + \frac{1}{n} x + \frac{1 - n}{2n^2}x^2 +
\frac{(1 - n)(1 - 2n)}{6n^3}x^3 + \ldots
\end{align*}
as in elementary calculus. This makes sense because the series is finite
as $x^k = 0$ for all $k \gg 0$ and each coefficient
${1/n \choose k} \in \mathbf{Z}[1/n]$ (details omitted; observe that
$n$ is invertible in $R$ by Lemma \ref{lemma-locally-nilpotent-unit}).
\end{proof}






\section{Curiosity}
\label{section-curiosity}

\noindent
Lemma \ref{lemma-disjoint-implies-product}
explains what happens if $V(I)$ is open for some ideal $I \subset R$.
But what if $\Spec(S^{-1}R)$ is closed in $\Spec(R)$?
The next two lemmas give a partial answer. For more information see
Section \ref{section-pure-ideals}.

\begin{lemma}
\label{lemma-invert-closed-quotient}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$
is closed. Then $S^{-1}R \cong R/I$ for some ideal $I \subset R$.
\end{lemma}

\begin{proof}
Let $I = \Ker(R \to S^{-1}R)$ so that $V(I)$ contains the image.
Say the image is the closed subset $V(I') \subset \Spec(R)$ for
some ideal $I' \subset R$. So $V(I') \subset V(I)$.
For $f \in I'$ we see that $f/1 \in S^{-1}R$
is contained in every prime ideal. Hence $f^n$ maps to zero in $S^{-1}R$
for some $n \geq 1$ (Lemma \ref{lemma-Zariski-topology}).
Hence $V(I') = V(I)$.
Then this implies every $g \in S$ is invertible mod $I$.
Hence we get ring maps $R/I \to S^{-1}R$ and $S^{-1}R \to R/I$.
The first map is injective by choice of $I$.
The second is the map $S^{-1}R \to S^{-1}(R/I) = R/I$ which
has kernel $S^{-1}I$ because localization is exact.
Since $S^{-1}I = 0$ we see also the second map is injective.
Hence $S^{-1}R \cong R/I$.
\end{proof}

\begin{lemma}
\label{lemma-invert-closed-split}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$
is closed. If $R$ is Noetherian, or $\Spec(R)$ is a
Noetherian topological space, or $S$ is finitely generated as a monoid,
then $R \cong S^{-1}R \times R'$ for some ring $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-invert-closed-quotient} we have $S^{-1}R \cong R/I$
for some ideal $I \subset R$. By Lemma \ref{lemma-disjoint-implies-product}
it suffices to show that $V(I)$ is open.
If $R$ is Noetherian then $\Spec(R)$ is a Noetherian
topological space, see Lemma \ref{lemma-Noetherian-topology}.
If $\Spec(R)$ is a Noetherian topological space,
then the complement $\Spec(R) \setminus V(I)$ is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian-quasi-compact}.
Hence there exist finitely many $f_1, \ldots, f_n \in I$ such
that $V(I) = V(f_1, \ldots, f_n)$.
Since each $f_i$ maps to zero in $S^{-1}R$
there exists a $g \in S$ such that $gf_i = 0$ for
$i = 1, \ldots, n$. Hence $D(g) = V(I)$ as desired.
In case $S$ is finitely generated as a monoid, say $S$ is generated
by $g_1, \ldots, g_m$, then $S^{-1}R \cong R_{g_1 \ldots g_m}$
and we conclude that $V(I) = D(g_1 \ldots g_m)$.
\end{proof}














\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\begin{theorem}[Hilbert Nullstellensatz]
\label{theorem-nullstellensatz}
Let $k$ be a field.
\begin{enumerate}
\item
\label{item-finite-kappa}
For any maximal ideal $\mathfrak m \subset k[x_1, \ldots, x_n]$
the field extension $k \subset \kappa(\mathfrak m)$ is finite.
\item
\label{item-polynomial-ring-Jacobson}
Any radical ideal $I \subset k[x_1, \ldots, x_n]$
is the intersection of maximal ideals containing it.
\end{enumerate}
The same is true in any finite type $k$-algebra.
\end{theorem}

\begin{proof}
It is enough to prove part (\ref{item-finite-kappa}) of
the theorem for the case of a polynomial
algebra $k[x_1, \ldots, x_n]$, because any finitely generated
$k$-algebra is a quotient of such a polynomial algebra.
We prove this by induction on $n$. The case $n = 0$ is clear.
Suppose that $\mathfrak m$ is a maximal ideal in $k[x_1, \ldots, x_n]$.
Let $\mathfrak p \subset k[x_n]$ be the intersection
of $\mathfrak m$ with $k[x_n]$.

\medskip\noindent
If $\mathfrak p \not = (0)$,
then $\mathfrak p$ is maximal and generated by an irreducible
monic polynomial $P$ (because of the Euclidean algorithm
in $k[x_n]$). Then
$k' = k[x_n]/\mathfrak p$ is a finite field extension of $k$
and contained in $\kappa(\mathfrak m)$. In this case
we get a surjection
$$
k'[x_1, \ldots, x_{n-1}]
\to
k'[x_1, \ldots, x_n] =
k' \otimes_k k[x_1, \ldots, x_n]
\longrightarrow
\kappa(\mathfrak m)
$$
and hence we see that $\kappa(\mathfrak m)$ is a finite
extension  of $k'$ by induction hypothesis. Thus $\kappa(\mathfrak m)$
is finite over $k$ as well.

\medskip\noindent
If $\mathfrak p = (0)$ we consider the ring
extension $k[x_n] \subset k[x_1, \ldots, x_n]/\mathfrak m$.
This is a finitely generated ring extension, hence
of finite presentation by
Lemmas \ref{lemma-obvious-Noetherian} and
\ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of $\Spec(k[x_1, \ldots, x_n]/\mathfrak m)$
in $\Spec(k[x_n])$ is constructible by
Theorem \ref{theorem-chevalley}. Since the image
contains $(0)$ we conclude that it contains a standard
open $D(f)$ for some $f\in k[x_n]$ nonzero. Since clearly
$D(f)$ is infinite we get a contradiction with the
assumption that $k[x_1, \ldots, x_n]/\mathfrak m$ is
a field (and hence has a spectrum consisting of one point).

\medskip\noindent
To prove part (\ref{item-polynomial-ring-Jacobson}) let
$I \subset R$ be radical, with $R$ of finite type over $k$.
Let $f \in R$, $f \not \in I$. Pick a maximal ideal $\mathfrak m'$
in the nonzero ring $R_f/IR_f = (R/I)_f$. Let $\mathfrak m \subset R$
be the inverse image of $\mathfrak m'$ in $R$. We see that
$I \subset \mathfrak m$
and $f \not \in \mathfrak m$. If we show that $\mathfrak m$ is a maximal
ideal of $R$, then we are done. We clearly have
$$
k \subset R/\mathfrak m \subset \kappa(\mathfrak m').
$$
By part (\ref{item-finite-kappa}) the field extension
$k \subset \kappa(\mathfrak m')$ is finite. Hence
$R/\mathfrak m$ is a field by Fields, Lemma
\ref{fields-lemma-subalgebra-algebraic-extension-field}.
Thus $\mathfrak m$ is maximal and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-field-finite-type-over-domain}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is of finite type over $R$,
then there exists an $f \in R$ such that $R_f$ is a field,
and $R_f \subset K$ is a finite field extension.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-characterize-image-finite-type} there
exist a nonempty open $U \subset \Spec(R)$
contained in the image $\{(0)\}$ of $\Spec(K) \to \Spec(R)$.
Choose $f \in R$, $f \not = 0$ such that $D(f) \subset U$, i.e.,
$D(f) = \{(0)\}$. Then $R_f$ is a domain whose spectrum has exactly one
point and $R_f$ is a field. Then $K$ is a finitely generated algebra
over the field $R_f$ and hence a finite field extension of
$R_f$ by the Hilbert Nullstellensatz (Theorem \ref{theorem-nullstellensatz}).
\end{proof}





















\section{Jacobson rings}
\label{section-ring-jacobson}

\noindent
Let $R$ be a ring. The closed points of $\Spec(R)$ are the
maximal ideals of $R$. Often rings which occur naturally in algebraic
geometry have lots of maximal ideals. For example finite type algebras
over a field or over $\mathbf{Z}$. We will show that these
are examples of Jacobson rings.

\begin{definition}
\label{definition-ring-jacobson}
Let $R$ be a ring. We say that $R$ is a
{\it Jacobson ring} if every radical
ideal $I$ is the intersection of the
maximal ideals containing it.
\end{definition}

\begin{lemma}
\label{lemma-finite-type-field-Jacobson}
Any algebra of finite type over a field is Jacobson.
\end{lemma}

\begin{proof}
This follows from Theorem \ref{theorem-nullstellensatz}
and Definition \ref{definition-ring-jacobson}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson-prime}
Let $R$ be a ring. If every prime ideal of $R$ is the
intersection of the maximal ideals containing it,
then $R$ is Jacobson.
\end{lemma}

\begin{proof}
This is immediately clear from the fact that
every radical ideal $I \subset R$ is the
intersection of the primes containing it.
See Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson}
A ring $R$ is Jacobson if and only if $\Spec(R)$
is Jacobson, see Topology,
Definition \ref{topology-definition-space-jacobson}.
\end{lemma}

\begin{proof}
Suppose $R$ is Jacobson. Let $Z \subset \Spec(R)$
be a closed subset. We have to show that the set of closed
points in $Z$ is dense in $Z$. Let $U \subset \Spec(R)$
be an open such that $U \cap Z$ is nonempty.
We have to show $Z \cap U$ contains a closed point
of $\Spec(R)$. We may
assume $U = D(f)$ as standard opens form a basis for the
topology on $\Spec(R)$. According to
Lemma \ref{lemma-Zariski-topology} we may assume that
$Z = V(I)$, where $I$ is a radical ideal. We see also
that $f \not \in I$. By assumption, there exists a
maximal ideal $\mathfrak m \subset R$ such that
$I \subset \mathfrak m$ but $f \not\in \mathfrak m$.
Hence $\mathfrak m \in D(f) \cap V(I) = U \cap Z$ as desired.

\medskip\noindent
Conversely, suppose that $\Spec(R)$ is Jacobson.
Let $I \subset R$ be a radical ideal. Let
$J = \cap_{I \subset \mathfrak m} \mathfrak m$
be the intersection of the maximal ideals containing $I$.
Clearly $J$ is radical, $V(J) \subset V(I)$, and
$V(J)$ is the smallest closed subset of $V(I)$ containing
all the closed points of $V(I)$. By assumption we see that
$V(J) = V(I)$. But Lemma \ref{lemma-Zariski-topology}
shows there is a bijection between Zariski closed
sets and radical ideals, hence $I = J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-jacobson}
Let $R$ be a ring. If $R$ is not Jacobson there exist
a prime $\mathfrak p \subset R$, an element $f \in R$
such that the following hold
\begin{enumerate}
\item $\mathfrak p$ is not a maximal ideal,
\item $f \not \in \mathfrak p$,
\item $V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, and
\item $(R/\mathfrak p)_f$ is a field.
\end{enumerate}
On the other hand, if $R$ is Jacobson, then for any pair $(\mathfrak p, f)$
such that (1) and (2) hold the set $V(\mathfrak p) \cap D(f)$ is
infinite.
\end{lemma}

\begin{proof}
Assume $R$ is not Jacobson.
By Lemma \ref{lemma-jacobson} this means there exists an
closed subset $T \subset \Spec(R)$
whose set $T_0 \subset T$ of closed points is not dense in $T$.
Choose an $f \in R$ such that $T_0 \subset V(f)$ but
$T \not \subset V(f)$. Note that $T \cap D(f)$
is homeomorphic to $\Spec((R/I)_f)$ if $T = V(I)$, see
Lemmas \ref{lemma-spec-closed} and \ref{lemma-standard-open}.
As any ring has a maximal ideal
(Lemma \ref{lemma-Zariski-topology}) we can choose a closed point $t$ of
space $T \cap D(f)$. Then $t$ corresponds to a prime ideal
$\mathfrak p \subset R$ which is not maximal (as $t \not \in T_0$).
Thus (1) holds. By construction $f \not \in \mathfrak p$, hence (2).
As $t$ is a closed point of $T \cap D(f)$ we see that
$V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, i.e., (3) holds. Hence we
conclude that $(R/\mathfrak p)_f$ is a domain whose
spectrum has one point, hence (4) holds
(for example combine Lemmas \ref{lemma-characterize-local-ring} and
\ref{lemma-minimal-prime-reduced-ring}).

\medskip\noindent
Conversely, suppose that $R$ is Jacobson and $(\mathfrak p, f)$
satisfy (1) and (2). If
$V(\mathfrak p) \cap V(f) =
\{\mathfrak p, \mathfrak q_1, \ldots, \mathfrak q_t\}$
then $\mathfrak p \not = \mathfrak q_i$
implies there exists an element $g \in R$ such that $g \not \in \mathfrak p$
but $g \in \mathfrak q_i$ for all $i$. Hence
$V(\mathfrak p) \cap D(fg) = \{\mathfrak p\}$ which
is impossible since each locally closed subset of $\Spec(R)$
contains at least one closed point as $\Spec(R)$ is
a Jacobson topological space.
\end{proof}

\begin{lemma}
\label{lemma-pid-jacobson}
The ring $\mathbf{Z}$ is a Jacobson ring.
More generally, let $R$ be a ring such that
\begin{enumerate}
\item $R$ is a domain,
\item $R$ is Noetherian,
\item any nonzero prime ideal is a maximal ideal, and
\item $R$ has infinitely many maximal ideals.
\end{enumerate}
Then $R$ is a Jacobson ring.
\end{lemma}

\begin{proof}
Let $R$ satisfy (1), (2), (3) and (4). The statement
means that $(0) = \bigcap_{\mathfrak m \subset R} \mathfrak m$.
Since $R$ has infinitely many maximal ideals it suffices to
show that any nonzero $x \in R$ is contained in at most
finitely many maximal ideals, in other words that $V(x)$ is finite.
By Lemma \ref{lemma-spec-closed}
we see that $V(x)$ is homeomorphic to $\Spec(R/xR)$.
By assumption (3) every prime of $R/xR$ is minimal and hence
corresponds to an irreducible component of $\Spec(R)$
(Lemma \ref{lemma-irreducible}).
As $R/xR$ is Noetherian, the topological space $\Spec(R/xR)$
is Noetherian (Lemma \ref{lemma-Noetherian-topology})
and has finitely many irreducible components
(Topology, Lemma \ref{topology-lemma-Noetherian}).
Thus $V(x)$ is finite as desired.
\end{proof}

\begin{example}
\label{example-infinite-product-fields-jacobson}
Let $A$ be an infinite set.
For each $\alpha \in A$, let $k_\alpha$ be a field.
We claim that $R = \prod_{\alpha\in A} k_\alpha$ is Jacobson.
First, note that any element $f \in R$ has the form
$f = ue$, with $u \in R$ a unit and $e\in R$ an idempotent
(left to the reader).
Hence $D(f) = D(e)$, and $R_f = R_e = R/(1-e)$ is a quotient of $R$.
Actually, any ring with this property is Jacobson.
Namely, say $\mathfrak p \subset R$ is a prime ideal
and $f \in R$, $f \not \in \mathfrak p$. We have to find
a maximal ideal $\mathfrak m$ of $R$ such that
$\mathfrak p \subset \mathfrak m$ and $f \not\in \mathfrak m$.
Because $R_f$ is a quotient of $R$ we see that any maximal
ideal of $R_f$ corresponds to a maximal ideal of $R$
not containing $f$. Hence the result follows
by choosing a maximal ideal of $R_f$ containing $\mathfrak p R_f$.
\end{example}

\begin{example}
\label{example-not-jacobson}
A domain $R$ with finitely many maximal ideals
$\mathfrak m_i$, $i = 1, \ldots, n$ is not a
Jacobson ring, except when it is a field.
Namely, in this case $(0)$ is not the intersection
of the maximal ideals $(0) \not =
\mathfrak m_1 \cap \mathfrak m_2 \cap \ldots \cap \mathfrak m_n
\supset \mathfrak m_1 \cdot \mathfrak m_2 \cdot \ldots
\cdot \mathfrak m_n \not = 0$.
In particular a discrete valuation ring, or any local ring with
at least two prime ideals is not a Jacobson
ring.
\end{example}

\begin{lemma}
\label{lemma-finite-residue-extension-closed}
Let $R \to S$ be a ring map.
Let $\mathfrak m \subset R$ be a maximal ideal.
Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$ such that $\kappa(\mathfrak m)
\subset \kappa(\mathfrak q)$ is an algebraic field extension.
Then $\mathfrak q$ is a maximal ideal of $S$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\
R \ar[r] \ar[u] & R/\mathfrak m \ar[u]
}
$$
We see that $\kappa(\mathfrak m) \subset S/\mathfrak q \subset
\kappa(\mathfrak q)$. Because the field extension
$\kappa(\mathfrak m) \subset \kappa(\mathfrak q)$
is algebraic, any ring between $\kappa(\mathfrak m)$
and $\kappa(\mathfrak q)$ is a field
(Fields, Lemma \ref{fields-lemma-subalgebra-algebraic-extension-field}).
Thus $S/\mathfrak q$ is a field, and a posteriori equal
to $\kappa(\mathfrak q)$.
\end{proof}

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is a field and suppose that $V$ is a nonzero vector
space over $k$. Assume the dimension of $V$ (which is a cardinal number)
is smaller than the cardinality of $k$. Then for any linear operator
$T : V \to V$ there exists some monic polynomial $P(t) \in k[t]$ such that
$P(T)$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(t)$. But the dimension of $k(t)$ over $k$ is
at least the cardinality of $k$ for example due to the fact that the elements
$\frac{1}{t - \lambda}$ are $k$-linearly independent.
\end{proof}

\noindent
Here is another version of Hilbert's Nullstellensatz.

\begin{theorem}
\label{theorem-uncountable-nullstellensatz}
Let $k$ be a field. Let $S$ be a $k$-algebra generated over $k$
by the elements $\{x_i\}_{i \in I}$. Assume the cardinality of $I$
is smaller than the cardinality of $k$. Then
\begin{enumerate}
\item for all maximal ideals $\mathfrak m \subset S$ the field
extension $k \subset \kappa(\mathfrak m)$
is algebraic, and
\item $S$ is a Jacobson ring.
\end{enumerate}
\end{theorem}

\begin{proof}
If $I$ is finite then the result follows from the Hilbert Nullstellensatz,
Theorem \ref{theorem-nullstellensatz}. In the rest of the proof we assume
$I$ is infinite. It suffices to prove the result for
$\mathfrak m \subset k[\{x_i\}_{i \in I}]$ maximal in the polynomial
ring on variables $x_i$, since $S$ is a quotient of this.
As $I$ is infinite the set
of monomials $x_{i_1}^{e_1} \ldots x_{i_r}^{e_r}$, $i_1, \ldots, i_r \in I$
and $e_1, \ldots, e_r \geq 0$ has cardinality at most equal to the
cardinality of $I$. Because the cardinality of $I \times \ldots \times I$
is the cardinality of $I$, and also the cardinality of
$\bigcup_{n \geq 0} I^n$ has the same cardinality.
(If $I$ is finite, then this is not true and
in that case this proof only works if $k$ is uncountable.)

\medskip\noindent
To arrive at a contradiction pick $T \in \kappa(\mathfrak m)$ transcendental
over $k$. Note that the $k$-linear map
$T : \kappa(\mathfrak m) \to \kappa(\mathfrak m)$
given by multiplication by $T$ has the property that $P(T)$ is invertible
for all monic polynomials $P(t) \in k[t]$.
Also, $\kappa(\mathfrak m)$ has dimension at most the cardinality of $I$
over $k$ since it is a quotient of the vector space
$k[\{x_i\}_{i \in I}]$ over $k$ (whose dimension is $\# I$ as we saw above).
This is impossible by Lemma \ref{lemma-dimension}.

\medskip\noindent
To show that $S$ is Jacobson we argue as follows. If not then
there exists a prime $\mathfrak q \subset S$ and an element $f \in S$,
$f \not \in \mathfrak q$ such that $\mathfrak q$ is not maximal
and $(S/\mathfrak q)_f$ is a field, see
Lemma \ref{lemma-characterize-jacobson}.
But note that $(S/\mathfrak q)_f$ is generated by at most $\# I + 1$ elements.
Hence the field extension $k \subset (S/\mathfrak q)_f$ is algebraic
(by the first part of the proof).
This implies that $\kappa(\mathfrak q)$ is an algebraic extension of $k$
hence $\mathfrak q$ is maximal by
Lemma \ref{lemma-finite-residue-extension-closed}. This contradiction
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-base-change-Jacobson}
Let $k$ be a field. Let $S$ be a $k$-algebra.
For any field extension $k \subset K$ whose cardinality is larger
than the cardinality of $S$ we have
\begin{enumerate}
\item for every maximal ideal $\mathfrak m$ of $S_K$ the field
$\kappa(\mathfrak m)$ is algebraic over $K$, and
\item $S_K$ is a Jacobson ring.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $k \subset K$ such that the cardinality of $K$ is greater
than the cardinality of $S$. Since the elements of $S$ generate
the $K$-algebra $S_K$ we see that
Theorem \ref{theorem-uncountable-nullstellensatz}
applies.
\end{proof}

\begin{example}
\label{example-countable-trick-does-not-work}
The trick in the proof of
Theorem \ref{theorem-uncountable-nullstellensatz}
really does not work if $k$ is a countable field and $I$ is countable too.
Let $k$ be a countable field. Let $x$ be a variable,
and let $k(x)$ be the field of rational functions in $x$.
Consider the polynomial algebra $R = k[x, \{x_f\}_{f \in k[x]-\{0\}}]$.
Let $I = (\{fx_f - 1\}_{f\in k[x] - \{0\}})$. Note that
$I$ is a proper ideal in $R$.
Choose a maximal ideal $I \subset \mathfrak m$.
Then $k \subset R/\mathfrak m$ is isomorphic to
$k(x)$, and is not algebraic over $k$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-invert-element}
Let $R$ be a Jacobson ring. Let $f \in R$. The ring $R_f$ is Jacobson and
maximal ideals of $R_f$ correspond to maximal ideals of $R$ not containing $f$.
\end{lemma}

\begin{proof}
By Topology, Lemma \ref{topology-lemma-jacobson-inherited}
we see that $D(f) = \Spec(R_f)$ is Jacobson and
that closed points of $D(f)$
correspond to closed points in $\Spec(R)$
which happen to lie in $D(f)$. Thus $R_f$ is Jacobson by
Lemma \ref{lemma-jacobson}.
\end{proof}

\begin{example}
\label{example-localize-not-preserve-closed-points}
Here is a simple example that shows Lemma \ref{lemma-Jacobson-invert-element}
to be false if $R$ is not Jacobson.
Consider the ring $R = \mathbf{Z}_{(2)}$, i.e., the localization
of $\mathbf{Z}$ at the prime $(2)$. The localization of $R$ at
the element $2$ is isomorphic to $\mathbf{Q}$, in a formula:
$R_2 \cong \mathbf{Q}$. Clearly the map $R \to R_2$ maps the
closed point of $\Spec(\mathbf{Q})$ to the generic point
of $\Spec(R)$.
\end{example}

\begin{example}
\label{example-infinite-localize-not-preserve-closed-points}
Here is a simple example that shows
Lemma \ref{lemma-Jacobson-invert-element}
is false if $R$ is Jacobson but we localize at infinitely
many elements.
Namely, let $R = \mathbf{Z}$ and consider the localization
$(R \setminus \{0\})^{-1}R \cong \mathbf{Q}$
of $R$ at the set of all nonzero elements.
Clearly the map $\mathbf{Z} \to \mathbf{Q}$ maps the
closed point of $\Spec(\mathbf{Q})$ to the generic point
of $\Spec(\mathbf{Z})$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-mod-ideal}
Let $R$ be a Jacobson ring. Let $I \subset R$ be an ideal.
The ring $R/I$ is Jacobson and maximal ideals
of $R/I$ correspond to maximal ideals of $R$ containing $I$.
\end{lemma}

\begin{proof}
The proof is the same as the proof of
Lemma \ref{lemma-Jacobson-invert-element}.
\end{proof}

\begin{lemma}
\label{lemma-silly-jacobson}
Let $R$ be a Jacobson ring. Let $K$ be a field. Let $R \subset K$ and
$K$ is of finite type over $R$. Then $R$ is a field and $K/R$
is a finite field extension.
\end{lemma}

\begin{proof}
First note that $R$ is a domain.
By Lemma \ref{lemma-field-finite-type-over-domain}
we see that $R_f$ is a field and $K/R_f$ is a finite field extension
for some nonzero $f \in R$. Hence $(0)$ is a maximal ideal of $R_f$
and by
Lemma \ref{lemma-Jacobson-invert-element}
we conclude $(0)$ is a maximal ideal of $R$.
\end{proof}

\begin{proposition}
\label{proposition-Jacobson-permanence}
Let $R$ be a Jacobson ring. Let $R \to S$ be a
ring map of finite type. Then
\begin{enumerate}
\item The ring $S$ is Jacobson.
\item The map $\Spec(S) \to \Spec(R)$ transforms
closed points to closed points.
\item For $\mathfrak m' \subset S$ maximal lying over $\mathfrak m \subset R$
the field extension $\kappa(\mathfrak m')/\kappa(\mathfrak m)$
is finite.
\end{enumerate}
\end{proposition}

\begin{proof}
Let $\mathfrak m' \subset S$ be a maximal ideal and
$R \cap \mathfrak m' = \mathfrak m$.
Then $R/\mathfrak m \to S/\mathfrak m'$ satisfies
the conditions of Lemma \ref{lemma-silly-jacobson}
by Lemma \ref{lemma-Jacobson-mod-ideal}.
Hence $R/\mathfrak m$ is a field and
$\mathfrak m$ a maximal ideal and the induced
residue field extension is finite. This proves (2) and (3).  

\medskip\noindent
If $S$ is not Jacobson, then by Lemma \ref{lemma-characterize-jacobson} there
exists a non-maximal prime ideal $\mathfrak q$ of $S$ and an
$g \in S$, $g \not\in \mathfrak q$ such that $(S/\mathfrak q)_g$ is a field.
To arrive at a contradiction we show that $\mathfrak q$ is a maximal ideal.
Let $\mathfrak p = \mathfrak q \cap R$. Then
$R/\mathfrak p \to (S/\mathfrak q)_g$ satisfies the conditions of
Lemma \ref{lemma-silly-jacobson} by
Lemma \ref{lemma-Jacobson-mod-ideal}.
Hence $R/\mathfrak p$ is a field and the field extension
$\kappa(\mathfrak p) \to (S/\mathfrak q)_g = \kappa(\mathfrak q)$ is
finite, thus algebraic. Then $\mathfrak q$ is a maximal ideal of $S$ by
Lemma \ref{lemma-finite-residue-extension-closed}. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-corollary-jacobson}
Any finite type algebra over $\mathbf{Z}$ is Jacobson.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-pid-jacobson} and
Proposition \ref{proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-image-finite-type-map-Jacobson-rings}
Let $R \to S$ be a finite type ring map of Jacobson rings.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \Spec(S)$ be a
constructible set. Denote with a subscript ${}_0$ the set
of closed points of a topological space.
\begin{enumerate}
\item We have $f(E)_0 = f(E_0) = X_0 \cap f(E)$.
\item A point $\xi \in X$ is in $f(E)$ if and only if
$\overline{\{\xi\}} \cap f(E_0)$ is dense in $\overline{\{\xi\}}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have a commutative diagram of continuous maps
$$
\xymatrix{
E \ar[r] \ar[d] & Y \ar[d] \\
f(E) \ar[r] & X
}
$$
Suppose $x \in f(E)$ is closed in $f(E)$. Then $f^{-1}(\{x\})\cap E$
is nonempty and closed in $E$. Applying
Topology, Lemma \ref{topology-lemma-jacobson-inherited}
to both inclusions
$$
f^{-1}(\{x\}) \cap E \subset E \subset Y
$$
we find there exists a point $y \in f^{-1}(\{x\}) \cap E$ which is
closed in $Y$. In other words, there exists $y \in Y_0$ and $y \in E_0$
mapping to $x$. Hence $x \in f(E_0)$.
This proves that $f(E)_0 \subset f(E_0)$.
Proposition \ref{proposition-Jacobson-permanence} implies that
$f(E_0) \subset X_0 \cap f(E)$. The inclusion
$X_0 \cap f(E) \subset f(E)_0$ is trivial. This proves the
first assertion.

\medskip\noindent
Suppose that $\xi \in f(E)$. According to
Lemma \ref{lemma-characterize-image-finite-type}
the set $f(E) \cap \overline{\{\xi\}}$ contains a dense
open subset of $\overline{\{\xi\}}$. Since $X$ is Jacobson
we conclude that $f(E) \cap \overline{\{\xi\}}$ contains a
dense set of closed points, see Topology,
Lemma \ref{topology-lemma-jacobson-inherited}.
We conclude by part (1) of the lemma.

\medskip\noindent
On the other hand, suppose that $\overline{\{\xi\}} \cap f(E_0)$
is dense in $\overline{\{\xi\}}$. By
Lemma \ref{lemma-constructible-is-image}
there exists a ring map $S \to S'$ of finite presentation
such that $E$ is the image of $Y' := \Spec(S') \to Y$.
Then $E_0$ is the image of $Y'_0$ by the first part of the
lemma applied to the ring map $S \to S'$. Thus we may assume that
$E = Y$ by replacing $S$ by $S'$. Suppose $\xi$ corresponds
to $\mathfrak p \subset R$. Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak p S \\
R \ar[r] \ar[u] & R/\mathfrak p \ar[u]
}
$$
This diagram and the density of $f(Y_0) \cap V(\mathfrak p)$
in $V(\mathfrak p)$
shows that the morphism $R/\mathfrak p \to S/\mathfrak p S$
satisfies condition (2) of
Lemma \ref{lemma-domain-image-dense-set-points-generic-point}.
Hence we conclude
there exists a prime $\overline{\mathfrak q} \subset S/\mathfrak pS$
mapping to $(0)$. In other words the inverse image $\mathfrak q$
of $\overline{\mathfrak q}$ in $S$ maps to $\mathfrak p$ as desired.
\end{proof}

\noindent
The conclusion of the lemma above is that we can read off
the image of $f$ from the set of closed points of the image.
This is a little nicer in case the map is of finite presentation
because then we know that images of a constructible is constructible.
Before we state it we introduce some notation.
Denote $\text{Constr}(X)$ the set of constructible sets.
Let $R \to S$ be a ring map.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced map of spectra.
Denote with a subscript ${}_0$ the set
of closed points of a topological space.


\begin{lemma}
\label{lemma-conclude-jacobson-Noetherian}
With notation as above. Assume that $R$ is a Noetherian Jacobson ring.
Further assume $R \to S$ is of finite type.
There is a commutative diagram
$$
\xymatrix{
\text{Constr}(Y) \ar[r]^{E \mapsto E_0} \ar[d]^{E \mapsto f(E)} &
\text{Constr}(Y_0) \ar[d]^{E \mapsto f(E)} \\
\text{Constr}(X) \ar[r]^{E \mapsto E_0} &
\text{Constr}(X_0)
}
$$
where the horizontal arrows are the bijections from
Topology, Lemma \ref{topology-lemma-jacobson-equivalent-constructible}.
\end{lemma}

\begin{proof}
Since $R \to S$ is of finite type, it is of finite presentation,
see Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of a constructible set in $X$ is constructible
in $Y$ by Chevalley's theorem
(Theorem \ref{theorem-chevalley}).
Combined with
Lemma \ref{lemma-image-finite-type-map-Jacobson-rings}
the lemma follows.
\end{proof}

\noindent
To illustrate the use of Jacobson rings, we give the following two examples.

\begin{example}
\label{example-product-matrices-zero}
Let $k$ be a field. The space $\Spec(k[x, y]/(xy))$
has two irreducible components: namely the $x$-axis and the
$y$-axis. As a generalization, let
$$
R = k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]/
\mathfrak a,
$$
where $\mathfrak a$ is the ideal in
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]$
generated by the entries of the $2 \times 2$ product matrix
$$
\left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right)
 \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right).
$$
In this example we will describe $\Spec(R)$.

\medskip\noindent
To prove the statement about $\Spec(k[x, y]/(xy))$ we argue as follows.
If $\mathfrak p \subset k[x, y]$ is any ideal containing $xy$, then either
$x$ or $y$ would be contained in $\mathfrak p$. Hence the minimal such
prime ideals are just $(x)$ and $(y)$. In case $k$ is
algebraically closed, the $\text{max-Spec}$ of these components
can then be visualized as the point sets of $y$- and $x$-axis.

\medskip\noindent
For the generalization, note that we may identify the closed
points of the spectrum of
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}])$
with the space of matrices
$$
\left\{ (X, Y) \in \text{Mat}(2, k)\times \text{Mat}(2, k) \mid
X = \left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right),
Y= \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right)
\right\}
$$
at least if $k$ is algebraically closed.
Now define a group action of
$\text{GL}(2, k)\times \text{GL}(2, k)\times \text{GL}(2, k)$
on the space of matrices $\{(X, Y)\}$ by
$$
(g_1, g_2, g_3) \times (X, Y) \mapsto ((g_1Xg_2^{-1}, g_2Yg_3^{-1})).
$$
Here, also observe that the algebraic set
$$
\text{GL}(2, k)\times \text{GL}(2, k)\times \text{GL}(2, k) \subset
\text{Mat}(2, k)\times \text{Mat}(2, k) \times \text{Mat}(2, k)
$$
is irreducible since it is the max spectrum of the domain
$$
k[x_{11}, x_{12}, \ldots, z_{21}, z_{22}, (x_{11}x_{22}-x_{12}x_{21})^{-1}
, (y_{11}y_{22}-y_{12}y_{21})^{-1}, (z_{11}z_{22}-z_{12}z_{21})^{-1}].
$$
Since the image of irreducible an algebraic set is still
irreducible, it suffices to classify the orbits of the set
$\{(X, Y)\in \text{Mat}(2, k)\times \text{Mat}(2, k)|XY = 0\}$ and take their
closures. From standard linear algebra, we are reduced to the
following three cases:
\begin{enumerate}
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = I_{2\times 2}$.
Then $Y$ is necessarily $0$, which as an algebraic set is
invariant under the group action. It follows that this orbit is
contained in the irreducible algebraic set defined by the prime
ideal $(y_{11}, y_{12}, y_{21}, y_{22})$. Taking the closure, we see
that $(y_{11}, y_{12}, y_{21}, y_{22})$ is actually a component.
\item $\exists (g_1, g_2)$ such that
$$
g_1Xg_2^{-1} = \left(
\begin{matrix}
1 & 0 \\
0 & 0
\end{matrix}
\right).
$$
This case occurs if and only if $X$ is a rank 1 matrix,
and furthermore, $Y$ is killed by such an $X$ if and only if
$$
x_{11}y_{11}+x_{12}y_{21} = 0; \quad x_{11}y_{12}+x_{12}y_{22} = 0;
$$
$$
x_{21}y_{11}+x_{22}y_{21} = 0; \quad x_{21}y_{12}+x_{22}y_{22} = 0.
$$
Fix a rank 1 $X$, such non zero $Y$'s satisfying the above
equations form an irreducible algebraic set for the following
reason($Y = 0$ is contained the previous case):
$0 = g_1Xg_2^{-1}g_2Y$ implies that
$$
g_2Y = \left(
\begin{matrix}
0 & 0 \\
y_{21}' & y_{22}'
\end{matrix}
\right).
$$
With a further $\text{GL}(2, k)$-action on the right by $g_3$,
$g_2Y$ can be brought into
$$
g_2Yg_3^{-1} = \left(
\begin{matrix}
0 & 0 \\
0 & 1
\end{matrix}
\right),
$$
and thus such $Y$'s form an irreducible algebraic set
isomorphic to the image of $\text{GL}(2, k)$ under this action. Finally,
notice that the ``rank 1" condition for $X$'s forms an open dense
subset of the irreducible algebraic set
$\det X = x_{11}x_{22} - x_{12}x_{21} = 0$.
It now follows that all the five equations define an irreducible component
$(x_{11}y_{11}+x_{12}y_{21}, x_{11}y_{12}+x_{12}y_{22}, x_{21}y_{11}
+x_{22}y_{21}, x_{21}y_{12}+x_{22}y_{22}, x_{11}x_{22}-x_{12}x_{21})$
in the open subset of the space of pairs of nonzero matrices.
It can be shown that the pair of equations
$\det X = 0$, $\det Y = 0$ cuts $\Spec(R)$ in an irreducible component
with the above locus an open dense subset.
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = 0$, or
equivalently, $X = 0$. Then $Y$ can be arbitrary and this component
is thus defined by $(x_{11}, x_{12}, x_{21}, x_{22})$.
\end{enumerate}
\end{example}


\begin{example}
\label{example-idempotent-matrices}
For another example, consider
$R = k[\{t_{ij}\}_{i, j = 1}^{n}]/\mathfrak a$, where $\mathfrak a$ is
the ideal generated by the entries of the product matrix $T^2-T$,
$T = (t_{ij})$. From linear algebra, we know that under the
$GL(n, k)$-action defined by $g, T \mapsto gTg^{-1}$, $T$ is
classified by the its rank and each $T$ is conjugate to some
$\text{diag}(1, \ldots, 1, 0, \ldots, 0)$, which has $r$ 1's and $n-r$ 0's.
Thus each orbit of such a $\text{diag}(1, \ldots, 1, 0, \ldots, 0)$ under the
group action forms an irreducible component and every idempotent
matrix is contained in one such orbit. Next we will show that any
two different orbits are necessarily disjoint. For this purpose we
only need to cook up polynomial functions that take different
values on different orbits. In characteristic 0 cases, such a
function can be taken to be
$f(t_{ij}) = trace(T) = \sum_{i = 1}^nt_{ii}$. In positive
characteristic cases, things are slightly more tricky since we
might have $trace(T) = 0$ even if $T \neq 0$. For instance, $char = 3$
$$
trace\left(
\begin{matrix}
1 & & \\
& 1 & \\
& & 1
\end{matrix}
\right) = 3 = 0
$$
Anyway, these components can be separated using other functions.
For instance, in the characteristic 3 case, $tr(\wedge^3T)$ takes
value 1 on the components corresponding to $diag(1, 1, 1)$ and 0 on
other components.
\end{example}





































\section{Finite and integral ring extensions}
\label{section-finite-ring-extensions}

\noindent
Trivial lemmas concerning finite and integral ring maps.
We recall the definition.

\begin{definition}
\label{definition-integral-ring-map}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item An element $s \in S$
is {\it integral over $R$} if there exists a monic
polynomial $P(x) \in R[x]$ such that
$P^\varphi(s) = 0$, where $P^\varphi(x) \in S[x]$
is the image of $P$ under $\varphi : R[x] \to S[x]$.
\item  The ring map $\varphi$ is {\it integral}
if every $s \in S$ is integral over $R$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-characterize-integral-element}
Let $\varphi : R \to S$ be a ring map. Let $y \in S$. If there exists a
finite $R$-submodule $M$ of $S$ such that $1 \in M$ and $yM \subset M$,
then $y$ is integral over $R$.
\end{lemma}

\begin{proof}
Let $x_1 = 1 \in M$ and $x_i \in M$, $i = 2, \ldots, n$ be a finite set of
elements generating $M$ as an $R$-module.
Write $yx_i = \sum \varphi(a_{ij}) x_j$
for some $a_{ij} \in R$. Let $P(T) \in R[T]$ be
the characteristic polynomial of the $n \times n$ matrix
$A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
we see $P(A) = 0$. By construction the map $\pi : R^n \to M$,
$(a_1, \ldots, a_n) \mapsto \sum \varphi(a_i) x_i$
commutes with $A : R^n \to R^n$ and multiplication by $y$. In a formula
$\pi(Av) = y\pi(v)$. Thus $P(y) = P(y) \cdot 1
= P(y) \cdot x_1 = P(y) \cdot \pi((1, 0, \ldots, 0))
= \pi(P(A)(1, 0, \ldots, 0)) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-finite-is-integral}
A finite ring extension is integral.
\end{lemma}

\begin{proof}
Let $R \to S$ be finite. Let $y \in S$. Apply
Lemma \ref{lemma-characterize-integral-element}
to $M = S$ to see that $y$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-integral}
Let $\varphi : R \to S$ be a ring map. Let $s_1, \ldots, s_n$
be a finite set of elements of $S$.
In this case $s_i$ is integral over $R$ for all $i = 1, \ldots, n$
if and only if
there exists an $R$-subalgebra $S' \subset S$ finite over $R$
containing all of the $s_i$.
\end{lemma}

\begin{proof}
If each $s_i$ is integral, then the subalgebra
generated by $\varphi(R)$ and the $s_i$ is finite
over $R$. Namely, if $s_i$ satisfies a monic equation
of degree $d_i$ over $R$, then this subalgebra is generated as an
$R$-module by the elements $s_1^{e_1} \ldots s_n^{e_n}$
with $0 \leq e_i \leq d_i - 1$.
Conversely, suppose given a finite $R$-subalgebra
$S'$ containing all the $s_i$. Then all of the
$s_i$ are integral by Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite-in-terms-of-integral}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is finite,
\item $R \to S$ is integral and of finite type, and
\item there exist $x_1, \ldots, x_n \in S$ which generate $S$ as an
algebra over $R$ such that each $x_i$ is integral over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-transitive}
Suppose that $R \to S$ and $S \to T$ are integral
ring maps. Then $R \to T$ is integral.
\end{lemma}

\begin{proof}
Let $t \in T$. Let $P(x) \in S[x]$ be a
monic polynomial such that $P(t) = 0$.
Apply Lemma \ref{lemma-characterize-integral}
to the finite set of coefficients of $P$.
Hence $t$ is integral over some subalgebra
$S' \subset S$ finite over $R$. Apply Lemma
\ref{lemma-characterize-integral} again to find
a subalgebra $T' \subset T$ finite over $S'$ and
containing $t$. Lemma \ref{lemma-finite-transitive}
applied to $R \to S' \to T'$ shows that $T'$ is finite
over $R$. The integrality of $t$ over $R$
now follows from Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-is-ring}
Let $R \to S$ be a ring homomorphism.
The set
$$
S' = \{s \in S \mid s\text{ is integral over }R\}
$$
is an $R$-subalgebra of $S$.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-characterize-integral}
and \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-finite-product-integral}
Let $R_i\to S_i$ be ring maps $i = 1, \ldots, n$.
Let $R$ and $S$ denote the product of the $R_i$ and $S_i$ respectively.
Then an element $s = (s_1, \ldots, s_n) \in S$ is integral over $R$
if and only if each $s_i$ is integral over $R_i$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-integral-closure}
Let $R \to S$ be a ring map.
The ring $S' \subset S$ of elements integral over
$R$, see Lemma \ref{lemma-integral-closure-is-ring},
is called the {\it integral closure} of $R$
in $S$. If $R \subset S$ we say that $R$ is
{\it integrally closed} in $S$ if $R = S'$.
\end{definition}

\noindent
In particular, we see that $R \to S$ is integral if and only
if the integral closure of $R$ in $S$ is all of $S$.

\begin{lemma}
\label{lemma-finite-product-integral-closure}
Let $R_i\to S_i$ be ring maps $i = 1, \ldots, n$.
Denote the integral closure of $R_i$ in $S_i$ by $S'_i$.
Further let $R$ and $S$ denote the product of the $R_i$ and $S_i$ respectively.
Then the integral closure of $R$ in $S$
is the product of the $S'_i$. In particular $R \to S$ is
integrally closed if and only if each $R_i \to S_i$ is integrally closed.
\end{lemma}

\begin{proof}
This follows immediately from Lemma \ref{lemma-finite-product-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-localize}
Integral closure commutes with localization: If $A \to B$ is a ring
map, and $S \subset A$ is a multiplicative subset, then the integral
closure of $S^{-1}A$ in $S^{-1}B$ is $S^{-1}B'$, where $B' \subset B$
is the integral closure of $A$ in $B$.
\end{lemma}

\begin{proof}
Since localization is exact we see that $S^{-1}B' \subset S^{-1}B$.
Suppose $x \in B'$ and $f \in S$. Then
$x^d + \sum_{i = 1, \ldots, d} a_i x^{d - i} = 0$
in $B$ for some $a_i \in A$. Hence also
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} a_i/f^i (x/f)^{d - i} = 0
$$
in $S^{-1}B$. In this way we see that $S^{-1}B'$ is contained in
the integral closure of $S^{-1}A$ in $S^{-1}B$. Conversely, suppose
that $x/f \in S^{-1}B$ is integral over $S^{-1}A$. Then we have
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} (a_i/f_i) (x/f)^{d - i} = 0
$$
in $S^{-1}B$ for some $a_i \in A$ and $f_i \in S$. This means that
$$
(f'f_1 \ldots f_d x)^d +
\sum\nolimits_{i = 1, \ldots, d}
f^i(f')^if_1^i \ldots f_i^{i - 1} \ldots f_d^i a_i
(f'f_1 \ldots f_dx)^{d - i} = 0
$$
for a suitable $f' \in S$. Hence $f'f_1\ldots f_dx \in B'$ and thus
$x/f \in S^{-1}B'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-stalks}
\begin{slogan}
An element of an algebra over a ring is integral over the ring
if and only if it is locally integral at every prime ideal of the ring.
\end{slogan}
Let $\varphi : R \to S$ be a ring map.
Let $x \in S$. The following are equivalent:
\begin{enumerate}
\item $x$ is integral over $R$, and
\item for every prime ideal $\mathfrak p \subset R$ the element
$x \in S_{\mathfrak p}$ is integral over $R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Assume (2). Consider the $R$-algebra
$S' \subset S$ generated by $\varphi(R)$ and $x$. Let $\mathfrak p$ be
a prime ideal of $R$. Then we know that
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_{\mathfrak p}$ for some $a_i \in R_{\mathfrak p}$. Hence we see,
by looking at which denominators occur, that
for some $f \in R$, $f \not \in \mathfrak p$ we have
$a_i \in R_f$ and
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_f$. This implies that $S'_f$ is finite over $R_f$.
Since $\mathfrak p$ was arbitrary and $\Spec(R)$ is quasi-compact
(Lemma \ref{lemma-quasi-compact}) we can find finitely many elements
$f_1, \ldots, f_n \in R$
which generate the unit ideal of $R$ such that $S'_{f_i}$ is finite
over $R_{f_i}$. Hence we conclude from Lemma \ref{lemma-cover} that
$S'$ is finite over $R$. Hence $x$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-integral}
\begin{slogan}
Integrality and finiteness are preserved under base change.
\end{slogan}
Let $R \to S$ and $R \to R'$ be ring maps.
Set $S' = R' \otimes_R S$.
\begin{enumerate}
\item If $R \to S$ is integral so is $R' \to S'$.
\item If $R \to S$ is finite so is $R' \to S'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove (1).
Let $s_i \in S$ be generators for $S$ over $R$.
Each of these satisfies a monic polynomial equation $P_i$
over $R$. Hence the elements $1 \otimes s_i \in S'$ generate
$S'$ over $R'$ and satisfy the corresponding polynomial
$P_i'$ over $R'$. Since these elements generate $S'$ over $R'$
we see that $S'$ is integral over $R'$.
Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-local}
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_n \in R$ generate the unit ideal.
\begin{enumerate}
\item If each $R_{f_i} \to S_{f_i}$ is integral, so is $R \to S$.
\item If each $R_{f_i} \to S_{f_i}$ is finite, so is $R \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
Let $s \in S$. Consider the ideal $I \subset R[x]$ of
polynomials $P$ such that $P(s) = 0$. Let $J \subset R$
denote the ideal (!) of leading coefficients of elements of $I$.
By assumption and clearing denominators
we see that $f_i^{n_i} \in J$ for all $i$
and certain $n_i \geq 0$. Hence $J$ contains $1$ and we see
$s$ is integral over $R$. Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-permanence}
Let $A \to B \to C$ be ring maps.
\begin{enumerate}
\item If $A \to C$ is integral so is $B \to C$.
\item If $A \to C$ is finite so is $B \to C$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-transitive}
Let $A \to B \to C$ be ring maps.
Let $B'$ be the integral closure of $A$ in $B$,
let $C'$ be the integral closure of $B'$ in $C$. Then
$C'$ is the integral closure of $A$ in $C$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-overring-surjective}
Suppose that $R \to S$ is an integral
ring extension with $R \subset S$.
Then $\varphi : \Spec(S) \to \Spec(R)$
is surjective.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
We have to show $\mathfrak pS_{\mathfrak p} \not = S_{\mathfrak p}$, see
Lemma \ref{lemma-in-image}.
The localization $R_{\mathfrak p} \to S_{\mathfrak p}$ is injective
(as localization is exact) and integral by
Lemma \ref{lemma-integral-closure-localize} or
\ref{lemma-base-change-integral}.
Hence we may replace $R$, $S$ by $R_{\mathfrak p}$, $S_{\mathfrak p}$ and
we may assume $R$ is local with maximal ideal $\mathfrak m$ and
it suffices to show that $\mathfrak mS \not = S$.
Suppose $1 = \sum f_i s_i$ with $f_i \in \mathfrak m$
and $s_i \in S$ in order to get a contradiction.
Let $R \subset S' \subset S$
be such that $R \to S'$ is finite and $s_i \in S'$, see
Lemma \ref{lemma-characterize-integral}.
The equation $1 = \sum f_i s_i$ implies that
the finite $R$-module $S'$ satisfies $S' = \mathfrak m S'$. Hence by
Nakayama's Lemma \ref{lemma-NAK}
we see $S' = 0$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-integral-under-field}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is integral over $R$,
then $R$ is a field and $K$ is an algebraic extension.
If $R \subset K$ and $K$ is finite over $R$,
then $R$ is a field and $K$ is a finite algebraic extension.
\end{lemma}

\begin{proof}
Assume that $R \subset K$ is integral.
By Lemma \ref{lemma-integral-overring-surjective} we see that
$\Spec(R)$ has $1$ point. Since clearly $R$ is a domain we see
that $R = R_{(0)}$ is a field (Lemma \ref{lemma-minimal-prime-reduced-ring}).
The other assertions are immediate from this.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-field}
Let $k$ be a field. Let $S$ be a $k$-algebra over $k$.
\begin{enumerate}
\item If $S$ is a domain and finite dimensional over $k$,
then $S$ is a field.
\item If $S$ is integral over $k$ and a domain,
then $S$ is a field.
\item If $S$ is integral over $k$ then every prime of
$S$ is a maximal ideal (see
Lemma \ref{lemma-ring-with-only-minimal-primes}
for more consequences).
\end{enumerate}
\end{lemma}

\begin{proof}
The statement on primes follows from the statement
``integral $+$ domain $\Rightarrow$ field''.
Let $S$ integral over $k$ and assume $S$ is a domain,
Take $s \in S$. By Lemma
\ref{lemma-characterize-integral} we may find a
finite dimensional $k$-subalgebra $k \subset S' \subset S$
containing $s$. Hence $S$ is a field if we can prove the
first statement. Assume $S$ finite dimensional
over $k$ and a domain. Pick $s\in S$.
Since $S$ is a domain the multiplication
map $s : S \to S$ is surjective by dimension
reasons. Hence there exists an element $s_1 \in S$
such that $ss_1 = 1$. So $S$ is a field.
\end{proof}

\begin{lemma}
\label{lemma-integral-no-inclusion}
Suppose $R \to S$ is integral.
Let $\mathfrak q, \mathfrak q' \in \Spec(S)$
be distinct primes
having the same image in $\Spec(R)$.
Then neither $\mathfrak q \subset \mathfrak q'$
nor $\mathfrak q' \subset \mathfrak q$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be the image.
By Remark \ref{remark-fundamental-diagram}
the primes $\mathfrak q, \mathfrak q'$
correspond to ideals in
$S \otimes_R \kappa(\mathfrak p)$.
Thus the lemma follows from Lemma \ref{lemma-integral-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-finite-finite-fibres}
Suppose $R \to S$ is finite.
Then the fibres of $\Spec(S) \to \Spec(R)$ are finite.
\end{lemma}

\begin{proof}
By the discussion in
Remark \ref{remark-fundamental-diagram}
the fibres are the spectra of the rings $S \otimes_R \kappa(\mathfrak p)$.
As $R \to S$ is finite, these fibre rings are finite over
$\kappa(\mathfrak p)$ hence Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
By
Lemma \ref{lemma-integral-no-inclusion}
every prime of $S \otimes_R \kappa(\mathfrak p)$ is a minimal
prime. Hence by
Lemma \ref{lemma-Noetherian-irreducible-components}
there are at most finitely many.
\end{proof}

\begin{lemma}
\label{lemma-integral-going-up}
Let $R \to S$ be a ring map such that
$S$ is integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q$ be a prime of $S$ mapping
to $\mathfrak p$. Then there exists a prime $\mathfrak q'$
with $\mathfrak q \subset \mathfrak q'$
mapping to $\mathfrak p'$.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak p$ and $S$ by $S/\mathfrak q$.
This reduces us to the situation of having an integral
extension of domains $R \subset S$ and a prime $\mathfrak p' \subset R$.
By Lemma \ref{lemma-integral-overring-surjective} we win.
\end{proof}

\noindent
The property expressed in the lemma above is called
the ``going up property'' for the ring map $R \to S$,
see Definition \ref{definition-going-up-down}.

\begin{lemma}
\label{lemma-finite-finitely-presented-extension}
Let $R \to S$ be a finite and finitely presented ring map.
Let $M$ be an $S$-module.
Then $M$ is finitely presented as an $R$-module if and only if
$M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finitely-presented-over-subring}.
To see the other assume that $M$ is finitely presented as an $S$-module.
Pick a presentation
$$
S^{\oplus m} \longrightarrow
S^{\oplus n} \longrightarrow
M \longrightarrow 0
$$
As $S$ is finite as an $R$-module, the kernel of
$S^{\oplus n} \to M$ is a finite $R$-module. Thus from
Lemma \ref{lemma-extension}
we see that it suffices to prove that $S$ is finitely presented as an
$R$-module.

\medskip\noindent
Pick $y_1, \ldots, y_n \in S$ such that $y_1, \ldots, y_n$ generate $S$
as an $R$-module. By Lemma \ref{lemma-characterize-integral-element}
each $y_i$ is integral over $R$. Choose monic polynomials
$P_i(x) \in R[x]$ with $P_i(y_i) = 0$. Consider the ring
$$
S' = R[x_1, \ldots, x_n]/(P_1(x_1), \ldots, P_n(x_n))
$$
Then we see that $S$ is of finite presentation as an $S'$-algebra
by Lemma \ref{lemma-compose-finite-type}. Since $S' \to S$ is surjective
we see that $S$ is of finite presentation as an $S'$-module
(use Lemma \ref{lemma-finite-presentation-independent}). Hence,
arguing as in the first paragraph, it suffices to show that $S'$ is
of finite presentation as an $R$-module. To see this we write
$R \to S'$ as the composition
$$
R \to R[x_1]/(P_1(x_1)) \to R[x_1, x_2]/(P_1(x_1), P_2(x_2)) \to
\ldots \to S'
$$
of ring maps of the form $R' \to R'[x]/(x^d + a_1 x^{d - 1} + \ldots + a_d)$.
Again arguing as in the first paragraph of the proof it is enough to
show that the $i$th ring in this sequence is of finite presentation as a
module over the $(i - 1)$st one. This is true because
$R'[x]/(x^d + a_1 x^{d - 1} + \ldots + a_d)$ is free as a module over
$R'$ with basis $1, x, \ldots, x^{d - 1}$.
\end{proof}

\begin{lemma}
\label{lemma-silly-normal}
Let $R$ be a ring. Let $x, y \in R$ be nonzerodivisors.
Let $R[x/y] \subset R_{xy}$ be the $R$-subalgebra generated
by $x/y$, and similarly for the subalgebras $R[y/x]$ and $R[x/y, y/x]$.
If $R$ is integrally closed in $R_x$ or $R_y$, then the sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
is a short exact sequence of $R$-modules.
\end{lemma}

\begin{proof}
Since $x/y \cdot y/x = 1$ it is clear that the map
$R[x/y] \oplus R[y/x] \to R[x/y, y/x]$ is surjective.
Let $\alpha \in R[x/y] \cap R[y/x]$. To show exactness in the middle
we have to prove that $\alpha \in R$. By assumption we may write
$$
\alpha = a_0 + a_1 x/y + \ldots + a_n (x/y)^n =
b_0 + b_1 y/x + \ldots + b_m(y/x)^m
$$
for some $n, m \geq 0$ and $a_i, b_j \in R$.
Pick some $N > \max(n, m)$.
Consider the finite $R$-submodule $M$ of $R_{xy}$ generated by the elements
$$
(x/y)^N, (x/y)^{N - 1}, \ldots, x/y, 1, y/x, \ldots, (y/x)^{N - 1}, (y/x)^N
$$
We claim that $\alpha M \subset M$. Namely, it is clear that
$(x/y)^i (b_0 + b_1 y/x + \ldots + b_m(y/x)^m) \in M$ for
$0 \leq i \leq N$ and that
$(y/x)^i (a_0 + a_1 x/y + \ldots + a_n(x/y)^n) \in M$ for
$0 \leq i \leq N$. Hence $\alpha$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral-element}. Note that
$\alpha \in R_x$, so if $R$ is integrally closed in $R_x$
then $\alpha \in R$ as desired.
\end{proof}







\section{Normal rings}
\label{section-normal-rings}

\noindent
We first introduce the notion of a normal domain, and then we
introduce the (very general) notion of a normal ring.

\begin{definition}
\label{definition-domain-normal}
A domain $R$ is called {\it normal} if it is integrally
closed in its field of fractions.
\end{definition}

\begin{lemma}
\label{lemma-integral-closure-in-normal}
Let $R \to S$ be a ring map.
If $S$ is a normal domain, then the integral closure of $R$
in $S$ is a normal domain.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following notion is occasionally useful when
studying normality.

\begin{definition}
\label{definition-almost-integral}
Let $R$ be a domain.
\begin{enumerate}
\item An element $g$ of the fraction
field of $R$ is called {\it almost integral over $R$}
if there exists an element $r \in R$, $r\not = 0$
such that $rg^n \in R$ for all $n \geq 0$.
\item The domain $R$ is called {\it completely normal} if every
almost integral element of the fraction field of $R$ is
contained in $R$.
\end{enumerate}
\end{definition}

\noindent
The following lemma shows that a Noetherian domain is normal
if and only if it is completely normal.

\begin{lemma}
\label{lemma-almost-integral}
Let $R$ be a domain with fraction field $K$.
If $u, v \in K$ are almost integral over $R$, then so are
$u + v$ and $uv$. Any element $g \in K$ which is integral over $R$
is almost integral over $R$. If $R$ is Noetherian
then the converse holds as well.
\end{lemma}

\begin{proof}
If $ru^n \in R$ for all $n \geq 0$ and
$v^nr' \in R$ for all $n \geq 0$, then
$(uv)^nrr'$ and $(u + v)^nrr'$ are in $R$ for
all $n \geq 0$. Hence the first assertion.
Suppose $g \in K$ is integral over $R$.
In this case there exists an $d > 0$ such that
the ring $R[g]$ is generated by $1, g, \ldots, g^d$ as an $R$-module.
Let $r \in R$ be a common denominator of the elements
$1, g, \ldots, g^d \in K$. It is follows that $rR[g] \subset R$,
and hence $g$ is almost integral over $R$.

\medskip\noindent
Suppose $R$ is Noetherian and $g \in K$ is almost integral over $R$.
Let $r \in R$, $r\not = 0$ be as in the definition.
Then $R[g] \subset \frac{1}{r}R$ as an $R$-module.
Since $R$ is Noetherian this implies that $R[g]$ is
finite over $R$. Hence $g$ is integral over $R$, see
Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-localize-normal-domain}
Any localization of a normal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a normal domain, and let $S \subset R$ be
a multiplicative subset. Suppose $g$ is an element
of the fraction field of $R$ which is integral over $S^{-1}R$.
Let $P = x^d + \sum_{j < d} a_j x^j$ be a polynomial
with $a_i \in S^{-1}R$ such that $P(g) = 0$.
Choose $s \in S$ such that $sa_i \in R$ for all $i$.
Then $sg$ satisfies the monic polynomial
$x^d + \sum_{j < d} s^{d-j}a_j x^j$ which has coefficients
$s^{d-j}a_j$ in $R$. Hence $sg \in R$ because $R$ is normal.
Hence $g \in S^{-1}R$.
\end{proof}

\begin{lemma}
\label{lemma-PID-normal}
A principal ideal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a principal ideal domain.
Let $g = a/b$ be an element of the fraction field
of $R$ integral over $R$. Because $R$ is a principal ideal domain
we may divide out a common factor of $a$ and $b$
and assume $(a, b) = R$. In this case, any equation
$(a/b)^n + r_{n-1} (a/b)^{n-1} + \ldots + r_0 = 0$
with $r_i \in R$ would imply $a^n \in (b)$. This
contradicts $(a, b) = R$ unless $b$ is a unit in $R$.
\end{proof}

\begin{lemma}
\label{lemma-prepare-polynomial-ring-normal}
Let $R$ be a domain with fraction field $K$.
Suppose $f = \sum \alpha_i x^i$ is an
element of $K[x]$.
\begin{enumerate}
\item If $f$ is integral over $R[x]$
then all $\alpha_i$ are integral over $R$, and
\item If $f$ is almost integral over $R[x]$
then all $\alpha_i$ are almost integral over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the second statement.
Write $f = \alpha_0 + \alpha_1 x + \ldots + \alpha_r x^r$
with $\alpha_r \not = 0$.
By assumption there exists $h = b_0 + b_1 x + \ldots + b_s x^s \in R[x]$,
$b_s \not = 0$ such that $f^n h \in R[x]$ for all
$n \geq 0$. This implies that $b_s \alpha_r^n \in R$
for all $n \geq 0$. Hence $\alpha_r$ is almost
integral over $R$. Since the set of almost integral
elements form a subring (Lemma \ref{lemma-almost-integral}) we deduce that
$f - \alpha_r x^r = \alpha_0 + \alpha_1 x + \ldots + \alpha_{r - 1} x^{r - 1}$
is almost integral over $R[x]$. By induction on $r$ we win.

\medskip\noindent
In order to prove the first statement we will use absolute Noetherian
reduction. Namely, write $\alpha_i = a_i / b_i$ and
let $P(t) = t^d + \sum_{j < d} f_j t^j$ be a polynomial
with coefficients $f_j \in R[x]$ such that $P(f) = 0$.
Let $f_j = \sum f_{ji}x^i$. Consider the subring
$R_0 \subset R$ generated by the finite list of elements
$a_i, b_i, f_{ji}$ of $R$. It is a domain; let
$K_0$ be its field of fractions. Since $R_0$ is a finite type
$\mathbf{Z}$-algebra it is Noetherian, see
Lemma \ref{lemma-obvious-Noetherian}. It is still
the case that $f \in K_0[x]$ is integral over $R_0[x]$,
because all the identities in $R$
among the elements $a_i, b_i, f_{ji}$ also hold in $R_0$.
By Lemma \ref{lemma-almost-integral} the element
$f$ is almost integral over $R_0[x]$. By the second statement of
the lemma, the elements $\alpha_i$ are almost integral
over $R_0$. And since $R_0$ is Noetherian, they are
integral over $R_0$, see Lemma \ref{lemma-almost-integral}.
Of course, then they are integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-domain-normal}
Let $R$ be a normal domain.
Then $R[x]$ is a normal domain.
\end{lemma}

\begin{proof}
The result is true if $R$ is a field $K$ because
$K[x]$ is a euclidean domain and hence a principal ideal
domain and hence normal by Lemma \ref{lemma-PID-normal}.
Let $g$ be an element of the fraction field of
$R[x]$ which is integral over $R[x]$. Because $g$
is integral over $K[x]$ where $K$ is the fraction
field of $R$ we may write $g = \alpha_d x^d + \alpha_{d-1}x^{d-1} +
\ldots + \alpha_0$ with $\alpha_i \in K$.
By Lemma \ref{lemma-prepare-polynomial-ring-normal}
the elements $\alpha_i$ are integral over $R$ and
hence are in $R$.
\end{proof}

\begin{lemma}
\label{lemma-power-series-over-Noetherian-normal-domain}
Let $R$ be a Noetherian normal domain. Then $R[[x]]$ is
a Noetherian normal domain.
\end{lemma}

\begin{proof}
The power series ring is Noetherian by
Lemma \ref{lemma-Noetherian-power-series}.
Let $f, g \in R[[x]]$ be nonzero elements such that
$w = f/g$ is integral over $R[[x]]$.
Let $K$ be the fraction field of $R$. Since the ring of Laurent series
$K((x)) = K[[x]][1/x]$ is a field, we can write
$w = a_n x^n + a_{n + 1} x^{n + 1} + \ldots)$
for some $n \in \mathbf{Z}$, $a_i \in K$, and $a_n \not = 0$.
By Lemma \ref{lemma-almost-integral} we see there exists a
nonzero element $h = b_m x^m + b_{m + 1} x^{m + 1} + \ldots$
in $R[[x]]$ with $b_m \not = 0$ such that
$w^e h \in R[[x]]$ for all $e \geq 1$. We conclude that $n \geq 0$ and that
$b_m a_n^e \in R$ for all $e \geq 1$.
Since $R$ is Noetherian this implies that $a_n \in R$ by
the same lemma. Now, if $a_n, a_{n + 1}, \ldots, a_{N - 1} \in R$,
then we can apply the same argument to
$w - a_n x^n - \ldots - a_{N - 1} x^{N - 1} = a_N x^N + \ldots$.
In this way we see that all $a_i \in R$ and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-normality-is-local}
Let $R$ be a domain. The following are equivalent:
\begin{enumerate}
\item The domain $R$ is a normal domain,
\item for every prime $\mathfrak p \subset R$ the local ring
$R_{\mathfrak p}$ is a normal domain, and
\item for every maximal ideal $\mathfrak m$ the ring $R_{\mathfrak m}$
is a normal domain.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows easily from the fact that for any domain $R$ we have
$$
R = \bigcap\nolimits_{\mathfrak m} R_{\mathfrak m}
$$
inside the fraction field of $R$. Namely, if $g$ is an element of
the right hand side then the ideal $I = \{x \in R \mid xg \in R\}$
is not contained in any maximal ideal $\mathfrak m$, whence $I = R$.
\end{proof}

\noindent
Lemma \ref{lemma-normality-is-local} shows that the following definition
is compatible with Definition \ref{definition-domain-normal}. (It is the
definition from EGA -- see \cite[IV, 5.13.5 and 0, 4.1.4]{EGA}.)

\begin{definition}
\label{definition-ring-normal}
A ring $R$ is called {\it normal} if for every prime
$\mathfrak p \subset R$ the localization $R_{\mathfrak p}$ is
a normal domain (see Definition \ref{definition-domain-normal}).
\end{definition}

\noindent
Note that a normal ring is a reduced ring, as $R$ is a subring of the product
of its localizations at all primes (see for example
Lemma \ref{lemma-characterize-zero-local}).

\begin{lemma}
\label{lemma-normal-ring-integrally-closed}
A normal ring is integrally closed in its total ring of fractions.
\end{lemma}

\begin{proof}
Let $R$ be a normal ring. Let $x \in Q(R)$ be an element of the total ring
of fractions of $R$ integral over $R$. Set $I = \{f \in R, fx \in R\}$. Let
$\mathfrak p \subset R$ be a prime. As $R \subset R_{\mathfrak p}$ is
flat we see that $R_{\mathfrak p} \subset Q(R) \otimes_R R_{\mathfrak p}$. As
$R_{\mathfrak p}$ is a normal domain we see that $x \otimes 1$ is an element of
$R_{\mathfrak p}$. Hence we can find $a, f \in R$, $f \not \in \mathfrak p$
such that $x \otimes 1 = a \otimes 1/f$. This means that $fx - a$ maps to
zero in $Q(R) \otimes_R R_{\mathfrak p} = Q(R)_{\mathfrak p}$, which
in turn means that there exists an $f' \in R$, $f' \not \in \mathfrak p$
such that $f'fx = f'a$ in $R$. In other words, $ff' \in I$. Thus $I$
is an ideal which isn't contained in any of the prime ideals of $R$, i.e.,
$I = R$ and $x \in R$.
\end{proof}

\begin{lemma}
\label{lemma-localization-normal-ring}
A localization of a normal ring is a normal ring.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-normal}
Let $R$ be a normal ring. Then $R[x]$ is a normal ring.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $R[x]$. Set $\mathfrak p = R \cap \mathfrak q$.
Then we see that $R_{\mathfrak p}[x]$ is a normal domain by
Lemma \ref{lemma-polynomial-domain-normal}.
Hence $(R[x])_{\mathfrak q}$ is a normal domain by
Lemma \ref{lemma-localize-normal-domain}.
\end{proof}

\begin{lemma}
\label{lemma-finite-product-normal}
A finite product of normal rings is normal.
\end{lemma}

\begin{proof}
It suffices to show that the product of two normal rings, say $R$ and $S$, is
normal. By Lemma \ref{lemma-disjoint-decomposition} the prime ideals of
$R\times S$ are of the form $\mathfrak{p}\times S$ and $R\times
\mathfrak{q}$, where $\mathfrak{p}$ and $\mathfrak{q}$ are primes of $R$
and $S$ respectively. Localization yields 
$(R\times S)_{\mathfrak{p}\times S}=R_{\mathfrak{p}}$ which is a normal domain
by assumption. Similarly for $S$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-reduced-ring-normal}
Let $R$ be a ring. Assume $R$ is reduced and has finitely many
minimal primes. Then the following are equivalent:
\begin{enumerate}
\item $R$ is a normal ring,
\item $R$ is integrally closed in its total ring of fractions, and
\item $R$ is a finite product of normal domains.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) and
(3) $\Rightarrow$ (1) hold in general,
see Lemmas \ref{lemma-normal-ring-integrally-closed} and
\ref{lemma-finite-product-normal}.

\medskip\noindent
Let $\mathfrak p_1, \ldots, \mathfrak p_n$ be the minimal primes of $R$.
By Lemmas \ref{lemma-reduced-ring-sub-product-fields} and
\ref{lemma-total-ring-fractions-no-embedded-points} we have
$Q(R) = R_{\mathfrak p_1} \times \ldots \times R_{\mathfrak p_n}$, and
by Lemma \ref{lemma-minimal-prime-reduced-ring} each factor is a field.
Denote $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ the $i$th idempotent
of $Q(R)$.

\medskip\noindent
If $R$ is integrally closed in $Q(R)$, then it contains in particular
the idempotents $e_i$, and we see that $R$ is a product of $n$
domains (see Sections \ref{section-connected-components} and
\ref{section-tilde-module-sheaf}). Each factor is of the form
$R/\mathfrak p_i$ with field of fractions $R_{\mathfrak p_i}$. 
By Lemma \ref{lemma-finite-product-integral-closure} each map
$R/\mathfrak p_i \to R_{\mathfrak p_i}$ is integrally closed. 
Hence $R$ is a finite product of normal domains.
\end{proof}

\begin{lemma}
\label{lemma-colimit-normal-ring}
Let $(R_i, \varphi_{ii'})$ be a directed system
(Categories, Definition \ref{definition-directed-system})
of rings. If each $R_i$ is a normal ring so is
$R = \colim_i R_i$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
Set $\mathfrak p_i = R_i \cap \mathfrak p$ (usual abuse of notation).
Then we see that
$R_{\mathfrak p} = \colim_i (R_i)_{\mathfrak p_i}$.
Since each $(R_i)_{\mathfrak p_i}$ is a normal domain we
reduce to proving the statement of the lemma for normal
domains. If $a, b \in R$ and $a/b$ satisfies a monic polynomial
$P(T) \in R[T]$, then we can find a (sufficiently large) $i \in I$
such that $a, b$ come from objects $a_i, b_i$ over $R_i$, $P$ comes from a
monic polynomial $P_i\in R_i[T]$ and $P_i(a_i/b_i)=0$. Since $R_i$ is normal we
see $a_i/b_i \in R_i$ and hence also $a/b \in R$.
\end{proof}







\section{Going down for integral over normal}
\label{section-going-down-integral-over-normal}

\noindent
We first play around a little bit with the notion of elements
integral over an ideal, and then we prove the theorem referred
to in the section title.

\begin{definition}
\label{definition-integral-over-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
We say an element $g \in S$ is
{\it integral over $I$} if
there exists a monic
polynomial $P = x^d + \sum_{j < d} a_j x^j$
with coefficients $a_j \in I^{d-j}$ such
that $P^\varphi(g) = 0$ in $S$.
\end{definition}

\noindent
This is mostly used when $\varphi = \text{id}_R : R \to R$.
In this case the set $I'$ of elements integral over $I$ is called
the {\it integral closure of $I$}. We will see that $I'$ is
an ideal of $R$ (and of course $I \subset I'$).

\begin{lemma}
\label{lemma-characterize-integral-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $A = \sum I^nt^n \subset R[t]$ be the
subring of the polynomial ring
generated by $R \oplus It \subset R[t]$.
An element $s \in S$ is integral over $I$ if
and only if the element $st \in S[t]$
is integral over $A$.
\end{lemma}

\begin{proof}
Suppose $st$ is integral over $A$.
Let $P = x^d + \sum_{j < d} a_j x^j$
be a monic polynomial with coefficients in $A$
such that $P^\varphi(st) = 0$. Let $a_j' \in A$
be the degree $d-j$ part of $a_i$, in other
words $a_j' = a_j'' t^{d-j}$ with $a_j'' \in I^{d-j}$.
For degree reasons we still have
$(st)^d + \sum_{j < d} \varphi(a_j'') t^{d-j} (st)^j = 0$.
Hence we see that $s$ is integral over $I$.

\medskip\noindent
Suppose that $s$ is integral over $I$.
Say $P = x^d + \sum_{j < d} a_j x^j$
with $a_j \in I^{d-j}$. Then we immediately find a
polynomial $Q = x^d + \sum_{j < d} (a_j t^{d-j}) x^j$
with coefficients in $A$ which proves that
$st$ is integral over $A$.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-ideal-is-submodule}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
The set of elements of $S$ which are integral
over $I$ form a $R$-submodule of $S$.
Furthermore, if $s \in S$ is integral over
$R$, and $s'$ is integral over $I$, then
$ss'$ is integral over $I$.
\end{lemma}

\begin{proof}
Closure under addition is clear from the
characterization of Lemma \ref{lemma-characterize-integral-ideal}.
Any element $s \in S$ which is integral over
$R$ corresponds to the degree $0$ element $s$ of $S[x]$
which is integral over $A$ (because $R \subset A$).
Hence we see that multiplication by $s$ on $S[x]$
preserves the property of being integral over $A$,
by Lemma \ref{lemma-integral-closure-is-ring}.
\end{proof}

\begin{lemma}
\label{lemma-integral-integral-over-ideal}
Suppose $\varphi : R \to S$ is integral.
Suppose $I \subset R$ is an ideal.
Then every element of $IS$ is integral over $I$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-integral-over-ideal-is-submodule}.
\end{proof}

\begin{lemma}
\label{lemma-polynomials-divide}
Let $K$ be a field. Let $n, m \in \mathbf{N}$ and
$a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1} \in K$.
If the polynomial $x^n + a_{n - 1}x^{n - 1} + \ldots + a_0$
divides the polynomial $x^m + b_{m - 1} x^{m - 1} + \ldots + b_0$
in $K[x]$ then
\begin{enumerate}
\item $a_0, \ldots, a_{n - 1}$ are integral over any subring
$R_0$ of $K$ containing the elements $b_0, \ldots, b_{m - 1}$, and
\item each $a_i$ lies in $\sqrt{(b_0, \ldots, b_{m-1})R}$
for any subring $R \subset K$ containing the elements
$a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $L/K$ be a field extension such that we can write
$x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 =
\prod_{i = 1}^m (x - \beta_i)$ with $\beta_i \in L$.
See Fields, Section \ref{fields-section-splitting-fieds}.
Each $\beta_i$ is integral over $R_0$.
Since each $a_i$ is a homogeneous polynomial in $\beta_1, \ldots, \beta_m$
we deduce the same for the $a_i$
(use Lemma \ref{lemma-integral-closure-is-ring}).

\medskip\noindent
Choose $c_0, \ldots, c_{m - n - 1} \in K$ such that
$$
\begin{matrix}
x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 =  \\
(x^n + a_{n - 1}x^{n - 1} + \ldots + a_0)
(x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \ldots + c_0).
\end{matrix}
$$
By part (1) the elements $c_i$ are integral over $R$. Consider
the integral extension
$$
R \subset R' = R[c_0, \ldots, c_{m - n - 1}] \subset K
$$
By Lemmas \ref{lemma-integral-overring-surjective}
and \ref{lemma-surjective-spec-radical-ideal}
we see that $R \cap \sqrt{(b_0, \ldots, b_{m - 1})R'}
= \sqrt{(b_0, \ldots, b_{m - 1})R}$. Thus we may replace
$R$ by $R'$ and assume $c_i \in R$.
Dividing out the radical $\sqrt{(b_0, \ldots, b_{m - 1})}$
we get a reduced ring $\overline{R}$.
We have to show that the images $\overline{a}_i \in \overline{R}$
are zero. And in
$\overline{R}[x]$ we have the relation
$$
\begin{matrix}
x^m = x^m + \overline{b}_{m - 1} x^{m - 1} + \ldots + \overline{b}_0 = \\
(x^n + \overline{a}_{n - 1}x^{n - 1} + \ldots + \overline{a}_0)
(x^{m - n} + \overline{c}_{m - n - 1}x^{m - n - 1}+ \ldots + \overline{c}_0).
\end{matrix}
$$
It is easy to see that this implies $\overline{a}_i = 0$ for all $i$. Indeed
by Lemma \ref{lemma-minimal-prime-reduced-ring} the localization of
$\overline{R}$ at a minimal prime $\mathfrak{p}$ is a field and
$\overline{R}_{\mathfrak p}[x]$ a UFD. Thus
$f = x^n + \sum \overline{a}_i x^i$
is associated to $x^n$ and since $f$ is monic $f = x^n$
in $\overline{R}_{\mathfrak p}[x]$.
Then there exists an $s \in \overline{R}$, $s \not\in \mathfrak p$
such that $s(f - x^n) = 0$.  Therefore all $\overline{a}_i$ lie
in $\mathfrak p$ and we conclude by
Lemma \ref{lemma-reduced-ring-sub-product-fields}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-polynomial-normal-domain}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal. Let $g \in S$ be integral
over $R$. Then the minimal polynomial of $g$
has coefficients in $R$.
\end{lemma}

\begin{proof}
Let $P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
be a polynomial with coefficients in $R$
such that $P(g) = 0$. Let $Q = x^n + a_{n-1}x^{n-1} + \ldots + a_0$
be the minimal polynomial for $g$ over the fraction field
$K$ of $R$. Then $Q$ divides $P$ in $K[x]$. By Lemma
\ref{lemma-polynomials-divide} we see the $a_i$ are
integral over $R$. Since $R$ is normal this
means they are in $R$.
\end{proof}

\begin{proposition}
\label{proposition-going-down-normal-integral}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal and $S$ integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q'$ be a prime of $S$
with $\mathfrak p' = R \cap \mathfrak q'$.
Then there exists a prime $\mathfrak q$
with $\mathfrak q \subset \mathfrak q'$
such that $\mathfrak p = R \cap \mathfrak q$. In other words:
the going down property holds for $R \to S$, see
Definition \ref{definition-going-up-down}.
\end{proposition}

\begin{proof}
Let $\mathfrak p$, $\mathfrak p'$ and $\mathfrak q'$
be as in the statement. We have to show there is a prime
$\mathfrak q$, with $\mathfrak q \subset \mathfrak q'$ and
$R \cap \mathfrak q = \mathfrak p$. This is the same
as finding a prime of
$S_{\mathfrak q'}$ mapping to $\mathfrak p$.
According to Lemma \ref{lemma-in-image} we have to show
that $\mathfrak p S_{\mathfrak q'} \cap R
= \mathfrak p$. Pick $z \in \mathfrak p S_{\mathfrak q'} \cap R$.
We may write $z = y/g$ with $y \in \mathfrak pS$ and
$g \in S$, $g \not\in \mathfrak q'$. Written
differently we have $zg = y$.

\medskip\noindent
By Lemma \ref{lemma-integral-integral-over-ideal}
there exists a monic polynomial
$P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
with $b_i \in \mathfrak p$ such that $P(y) = 0$.

\medskip\noindent
By Lemma \ref{lemma-minimal-polynomial-normal-domain}
the minimal polynomial of $g$ over $K$ has coefficients
in $R$. Write it as $Q = x^n + a_{n-1} x^{n-1} + \ldots
+ a_0$. Note that not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ since that would imply
$g^n = \sum_{j < n} a_j g^j \in \mathfrak pS
\subset \mathfrak p'S
\subset \mathfrak q'$
which is a contradiction.

\medskip\noindent
Since $y = zg$ we see immediately from the above
that $Q' = x^n + za_{n-1} x^{n-1} + \ldots + z^{n}a_0$
is the minimal polynomial for $y$. Hence
$Q'$ divides $P$ and by Lemma \ref{lemma-polynomials-divide}
we see that $z^ja_{n - j} \in \sqrt{(b_0, \ldots, b_{m-1})}
\subset \mathfrak p$, $j =  1, \ldots, n$.
Because not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ we conclude $z \in \mathfrak p$
as desired.
\end{proof}














\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \colim_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is an $R$-module then
$$
M \otimes N
=
\colim_{i\in \mathcal{I}} M_i \otimes_R N,
$$
see Lemma \ref{lemma-tensor-products-commute-with-limits}.
This property is usually expressed by saying
that {\it $\otimes$ commutes with colimits}.
Another often used result is that if $0 \to N_1 \to N_2 \to N_3 \to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M \otimes_R N_1
\to
M \otimes_R N_2
\to
M \otimes_R N_3
\to
0
$$
is still exact, see Lemma \ref{lemma-tensor-product-exact}.
Both of these properties tell us that the functor
$N \mapsto M \otimes_R N$ {\it is right exact}.
See Categories, Section \ref{categories-section-exact-functor}
and Homology, Section \ref{homology-section-functors}.
An $R$-module $M$ is flat if $N \mapsto N \otimes_R M$ is also left exact,
i.e., if it is exact. Here is the precise definition.

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\noindent
Here is an example of how you can use the flatness condition.

\begin{lemma}
\label{lemma-flat-intersect-ideals}
Let $R$ be a ring. Let $I, J \subset R$ be ideals. Let $M$ be a flat
$R$-module. Then $IM \cap JM = (I \cap J)M$.
\end{lemma}

\begin{proof}
Consider the exact sequence $0 \to I \cap J \to R \to R/I \oplus R/J$.
Tensoring with the flat module $M$ we obtain an exact sequence
$$
0 \to (I \cap J) \otimes_R M \to M \to M/IM \oplus M/JM
$$
Since the kernel of $M \to M/IM \oplus M/JM$ is equal to
$IM \cap JM$ we conclude.
\end{proof}

\begin{lemma}
\label{lemma-colimit-flat}
Let $R$ be a ring. Let $\{M_i, \varphi_{ii'}\}$ be a directed system of
flat $R$-modules. Then $\colim_i M_i$ is a flat $R$-module.
\end{lemma}

\begin{proof}
This follows as $\otimes$ commutes with colimits and because
directed colimits are exact, see
Lemma \ref{lemma-directed-colimit-exact}.
\end{proof}

\begin{lemma}
\label{lemma-composition-flat}
A composition of (faithfully) flat ring maps is
(faithfully) flat.
If $R \to R'$ is (faithfully) flat, and $M'$ is a
(faithfully) flat $R'$-module, then $M'$ is a
(faithfully) flat $R$-module.
\end{lemma}

\begin{proof}
The first statement of the lemma is a particular case of the
second, so it is clearly enough to prove the latter. Let
$R \to R'$ be a flat ring map, and $M'$ a flat $R'$-module.
We need to prove that $M'$ is a flat $R$-module. Let
$N_1 \to N_2 \to N_3$ be an exact complex of $R$-modules.
Then, the complex $R' \otimes_R N_1 \to
R' \otimes_R N_2 \to R' \otimes_R N_3$ is exact (since $R'$
is flat as an $R$-module), and so the complex
$M' \otimes_{R'} \left(R' \otimes_R N_1\right)
\to M' \otimes_{R'} \left(R' \otimes_R N_2\right)
\to M' \otimes_{R'} \left(R' \otimes_R N_3\right)$ is
exact (since $M'$ is a flat $R'$-module). Since
$M' \otimes_{R'} \left(R' \otimes_R N\right)
\cong \left(M' \otimes_{R'} R'\right) \otimes_R N
\cong M' \otimes_R N$ for any $R$-module $N$ functorially
(by Lemmas \ref{lemma-tensor-with-bimodule} and
\ref{lemma-flip-tensor-product}), this complex is isomorphic
to the complex
$M' \otimes_R N_1 \to M' \otimes_R N_2 \to M' \otimes_R N_3$,
which is therefore also exact. This shows that $M'$ is a flat
$R$-module. Tracing this argument backwards, we can show
that if $R \to R'$ is faithfully flat, and if $M'$ is
faithfully flat as an $R'$-module, then $M'$ is faithfully
flat as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item
\label{item-flat}
$M$ is flat over $R$.
\item
\label{item-injective}
for every injection of $R$-modules $N \subset N'$
the map $N \otimes_R M \to N'\otimes_R M$ is injective.
\item
\label{item-f-ideal}
for every ideal $I \subset R$ the map
$I \otimes_R M \to R \otimes_R M = M$ is injective.
\item
\label{item-ffg-ideal}
for every finitely generated ideal $I \subset R$
the map $I \otimes_R M \to R \otimes_R M = M$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{item-flat}) implies (\ref{item-injective})
implies (\ref{item-f-ideal}) implies (\ref{item-ffg-ideal}) are all
trivial. Thus we prove (\ref{item-ffg-ideal}) implies (\ref{item-flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K = \Ker(N_2 \to N_3)$ and $Q = \Im(N_2 \to N_3)$.
Then we get maps
$$
N_1 \otimes_R M \to
K \otimes_R M \to
N_2 \otimes_R M \to
Q \otimes_R M \to
N_3 \otimes_R M
$$
Observe that the first and third arrows are surjective. Thus if we show
that the second and fourth arrows are injective, then we are
done\footnote{Here is the argument in more detail:
Assume that we know that the second and fourth arrows are
injective. Lemma \ref{lemma-tensor-product-exact} (applied
to the exact sequence $K \to N_2 \to Q \to 0$) yields that
the sequence $K \otimes_R M \to N_2 \otimes_R M \to
Q \otimes_R M \to 0$ is exact. Hence,
$\Ker \left(N_2 \otimes_R M \to Q \otimes_R M\right)
= \Im \left(K \otimes_R M \to N_2 \otimes_R M\right)$.
Since
$\Im \left(K \otimes_R M \to N_2 \otimes_R M\right)
= \Im \left(N_1 \otimes_R M \to N_2 \otimes_R M\right)$
(due to the surjectivity of $N_1 \otimes_R M \to
K \otimes_R M$) and
$\Ker \left(N_2 \otimes_R M \to Q \otimes_R M\right)
= \Ker \left(N_2 \otimes_R M \to N_3 \otimes_R M\right)$
(due to the injectivity of $Q \otimes_R M \to
N_3 \otimes_R M$), this becomes
$\Ker \left(N_2 \otimes_R M \to N_3 \otimes_R M\right)
= \Im \left(N_1 \otimes_R M \to N_2 \otimes_R M\right)$,
which shows that the functor $- \otimes_R M$ is exact,
whence $M$ is flat.}.
Hence it suffices to show that $- \otimes_R M$ transforms
injective $R$-module maps into injective $R$-module maps.

\medskip\noindent
Assume $K \to N$ is an injective $R$-module map and
let $x \in \Ker(K \otimes_R M \to N \otimes_R M)$.
We have to show that $x$ is zero.
The $R$-module $K$ is the union of its finite
$R$-submodules; hence, $K \otimes_R M$ is
the colimit of $R$-modules of the form
$K_i \otimes_R M$ where $K_i$ runs over all finite
$R$-submodules of $K$
(because tensor product commutes with colimits).
Thus, for some $i$ our $x$ comes from an element
$x_i \in K_i \otimes_R M$. Thus we may assume that $K$
is a finite $R$-module. Assume this. We regard the
injection $K \to N$ as an inclusion, so that
$K \subset N$.

\medskip\noindent
The $R$-module $N$ is the union of its finite
$R$-submodules that contain $K$. Hence, $N \otimes_R M$
is the colimit of $R$-modules of the form
$N_i \otimes_R M$ where $N_i$ runs over all finite
$R$-submodules of $N$ that contain $K$
(again since tensor product commutes with colimits).
Notice that this is a colimit over a directed system
(since the sum of two finite submodules of $N$ is
again finite).
Hence, (by Lemma \ref{lemma-zero-directed-limit})
the element $x \in K \otimes_R M$ maps to
zero in at least one of these $R$-modules
$N_i \otimes_R M$ (since $x$ maps to zero
in $N \otimes_R M$).
Thus we may assume $N$ is a finite $R$-module.

\medskip\noindent
Assume $N$ is a finite $R$-module. Write $N = R^{\oplus n}/L$ and $K = L'/L$
for some $L \subset L' \subset R^{\oplus n}$.
For any $R$-submodule $G \subset R^{\oplus n}$,
we have a canonical map $G \otimes_R M \to M^{\oplus n}$
obtained by composing
$G \otimes_R M \to R^n \otimes_R M = M^{\oplus n}$.
It suffices to prove that $L \otimes_R M \to M^{\oplus n}$
and $L' \otimes_R M \to M^{\oplus n}$ are injective.
Namely, if so, then we see that
$K \otimes_R M = L' \otimes_R M/L \otimes_R M \to M^{\oplus n}/L \otimes_R M$
is injective too\footnote{This becomes obvious if we
identify $L' \otimes_R M$ and $L \otimes_R M$ with
submodules of $M^{\oplus n}$ (which is legitimate since
the maps $L \otimes_R M \to M^{\oplus n}$
and $L' \otimes_R M \to M^{\oplus n}$ are injective and
commute with the obvious map $L' \otimes_R M \to L \otimes_R M$).}.

\medskip\noindent
Thus it suffices to show that $L \otimes_R M \to M^{\oplus n}$
is injective when $L \subset R^{\oplus n}$ is an $R$-submodule.
We do this by induction on $n$. The base case $n = 1$ we handle below.
For the induction step assume $n > 1$ and set
$L' = L \cap R \oplus 0^{\oplus n - 1}$. Then $L'' = L/L'$ is a submodule
of $R^{\oplus n - 1}$. We obtain a diagram
$$
\xymatrix{
&
L' \otimes_R M \ar[r] \ar[d] &
L \otimes_R M \ar[r] \ar[d] &
L'' \otimes_R M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M \ar[r] &
M^{\oplus n} \ar[r] &
M^{\oplus n - 1} \ar[r] & 0
}
$$
By induction hypothesis and the base case the left and right vertical
arrows are injective. The rows are exact. It follows that the middle vertical
arrow is injective too.

\medskip\noindent
The base case of the induction above is when $L \subset R$ is an ideal.
In other words, we have to show that $I \otimes_R M \to M$ is injective
for any ideal $I$ of $R$. We know this is true when $I$ is finitely
generated. However, $I = \bigcup I_\alpha$ is the union of the
finitely generated ideals $I_\alpha$ contained in it. In other words,
$I = \colim I_\alpha$. Since $\otimes$ commutes with colimits we see that
$I \otimes_R M = \colim I_\alpha \otimes_R M$ and since all
the morphisms $I_\alpha \otimes_R M \to M$ are injective by
assumption, the same is true for $I \otimes_R M \to M$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-rings-flat}
Let $\{R_i, \varphi_{ii'}\}$ be a system of rings over the directed set $I$.
Let $R = \colim_i R_i$. Let $M$ be an $R$-module such that
$M$ is flat as an $R_i$-module for all $i$. Then $M$ is flat as
an $R$-module.
\end{lemma}

\begin{proof}
Let $\mathfrak a \subset R$ be a finitely generated ideal. By
Lemma \ref{lemma-flat}
it suffices to show that $\mathfrak a \otimes_R M \to M$ is
injective. We can find an $i \in I$ and a finitely generated ideal
$\mathfrak a' \subset R_i$ such that $\mathfrak a = \mathfrak a'R$.
Then $\mathfrak a = \colim_{i' \geq i} \mathfrak a'R_{i'}$.
Hence the map $\mathfrak a \otimes_R M \to M$ is the colimit of the
maps
$$
\mathfrak a'R_{i'} \otimes_{R_{i'}} M \longrightarrow M
$$
which are all injective by assumption. Since $\otimes$ commutes with
colimits and since colimits over $I$ are exact by
Lemma \ref{lemma-directed-colimit-exact}
we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change}
Suppose that $M$ is flat over $R$, and that $R \to R'$
is a ring map. Then $M \otimes_R R'$ is flat over $R'$.
\end{lemma}

\begin{proof}
For any $R'$-module $N$ we have a canonical
isomorphism $N \otimes_{R'} (R'\otimes_R M)
= N \otimes_R M$. Hence the exactness of
$-\otimes_{R'}(R'\otimes_R M)$ follows from
the exactness of $-\otimes_R M$.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends}
Let $R \to R'$ be a faithfully flat ring map.
Let $M$ be a module over $R$, and set $M' = R' \otimes_R M$.
Then $M$ is flat over $R$ if and only if $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-base-change} we see that if $M$ is flat
then $M'$ is flat. For the converse, suppose that $M'$ is flat.
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
We want to show that $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We know that
$N_1 \otimes_R R' \to N_2 \otimes_R R' \to N_3 \otimes_R R'$ is
exact, because $R \to R'$ is flat. Flatness of $M'$ implies that
$N_1 \otimes_R R' \otimes_{R'} M'
\to N_2 \otimes_R R' \otimes_{R'} M'
\to N_3 \otimes_R R' \otimes_{R'} M'$ is exact.
We may write this as
$N_1 \otimes_R M \otimes_R R'
\to N_2 \otimes_R M \otimes_R R'
\to N_3 \otimes_R M \otimes_R R'$.
Finally, faithful flatness implies that
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends-more-general}
Let $R$ be a ring.
Let $S \to S'$ be a faithfully flat map of $R$-algebras.
Let $M$ be a module over $S$, and set $M' = S' \otimes_S M$.
Then $M$ is flat over $R$ if and only if $M'$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $N \to N'$ be an injection of $R$-modules. By the faithful flatness
of $S \to S'$ we have
$$
\Ker(N \otimes_R M \to N' \otimes_R M) \otimes_S S'
=
\Ker(N \otimes_R M' \to N' \otimes_R M')
$$
Hence the equivalence of the lemma follows from the second characterization
of flatness in
Lemma \ref{lemma-flat}.
\end{proof}

\begin{lemma}
\label{lemma-flat-permanence}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
If $M$ is flat as an $R$-module and faithfully flat as an $S$-module,
then $R \to S$ is flat.
\end{lemma}

\begin{proof}
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
By assumption $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We may write this as
$$
N_1 \otimes_R S \otimes_S M
\to
N_2 \otimes_R S \otimes_S M
\to
N_3 \otimes_R S \otimes_S M.
$$
By faithful flatness of $M$ over $S$ we conclude that
$N_1 \otimes_R S \to N_2 \otimes_R S \to N_3 \otimes_R S$ is exact.
Hence $R \to S$ is flat.
\end{proof}

\noindent
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $\sum f_i x_i = 0$ be a relation in $M$.
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j \in M$, $j = 1, \ldots, m$, and elements $a_{ij} \in R$,
$i = 1, \ldots, n$, $j = 1, \ldots, m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall i,
\quad\text{and}\quad
0 = \sum\nolimits_i f_ia_{ij}, \forall j.
$$

\begin{lemma}[Equational criterion of flatness]
\label{lemma-flat-eq}
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i = 0$ be a relation in $M$.
Let $I = (f_1, \ldots, f_n)$, and let
$K = \Ker(R^n \to I, (a_1, \dots, a_n) \mapsto \sum_i a_i f_i)$.
So we have the short exact sequence
$0 \to K \to R^n \to I \to 0$. Then $\sum f_i \otimes x_i$
is an element of $I \otimes_R M$ which maps
to zero in $R \otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I \otimes_R M$.
Thus there exists an element of $K \otimes_R M$ mapping
to $\sum e_i \otimes x_i \in R^n \otimes_R M$ where $e_i$
is the $i$th basis element of $R^n$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i \otimes x_i$
be an element of $I \otimes_R M$ mapping to zero in $R \otimes_R M = M$.
This just means exactly that $\sum f_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes \left(\sum a_{ij}y_j\right)
=
\sum \left(\sum f_i a_{ij}\right) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-flat-tor-zero}
Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$
a short exact sequence, and $N$ an $R$-module. If $M$ is flat
then $N \otimes_R M'' \to N \otimes_R M'$ is injective, i.e., the
sequence
$$
0 \to N \otimes_R M'' \to N \otimes_R M' \to N \otimes_R M \to 0
$$
is a short exact sequence.
\end{lemma}

\begin{proof}
Let $R^{(I)} \to N$ be a surjection from a free module
onto $N$ with kernel $K$. The result follows
from the snake lemma applied to the following diagram
$$
\begin{matrix}
 & & 0 & & 0 & & 0 & & \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R N & \to & M' \otimes_R N & \to & M \otimes_R N & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
0 & \to & (M'')^{(I)} & \to & (M')^{(I)} & \to & M^{(I)} & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R K & \to & M' \otimes_R K & \to & M \otimes_R K & \to & 0 \\
 & & & & & & \uparrow & & \\
 & & & & & & 0 & &
\end{matrix}
$$
with exact rows and columns. The middle row is exact because tensoring
with the free module $R^{(I)}$ is exact.
\end{proof}


\begin{lemma}
\label{lemma-flat-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$ is
a short exact sequence of $R$-modules.
If $M'$ and $M''$ are flat so is $M$.
If $M$ and $M''$ are flat so is $M'$.
\end{lemma}

\begin{proof}
We will use the criterion that a module $N$ is flat if for
every ideal $I \subset R$ the map $N \otimes_R I \to N$ is injective,
see Lemma \ref{lemma-flat}.
Consider an ideal $I \subset R$.
Consider the diagram
$$
\begin{matrix}
0 & \to & M' & \to & M & \to & M'' & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow & & \\
& & M'\otimes_R I & \to & M \otimes_R I & \to & M''\otimes_R I & \to & 0
\end{matrix}
$$
with exact rows. This immediately proves the first assertion.
The second follows because if $M''$ is flat then the lower left
horizontal arrow is injective by Lemma \ref{lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
Let $R$ be a ring.
Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is faithfully flat, and
\item $M$ is flat and for all $R$-module homomorphisms $\alpha : N \to N'$
we have $\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $M$ is faithfully flat, then
$0 \to \Ker(\alpha) \to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves (1) implies (2).
For the other, assume (2). Let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \Ker(N_2 \to N_3)$,
and consider the map $\alpha : R \to N_2/\Im(N_1)$,
$r \mapsto rx + \Im(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
\begin{slogan}
A flat module is faithfully flat if and only if it has nonzero fibers.
\end{slogan}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \Spec(R)$
the tensor product $M \otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M \otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \Ker(N_2 \to N_3)/\Im(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$.
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H \otimes_R M = 0$ by flatness of $M$.
If $I \not =  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\Spec$ is surjective, and
\item any closed point $x \in \Spec(R)$ is
in the image of the map $\Spec(S) \to \Spec(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-local-flat-ff}
A flat local ring homomorphism of local rings is faithfully flat.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ff-rings}.
\end{proof}

\begin{lemma}
\label{lemma-flat-going-down}
Let $R \to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$
be primes of $R$. Let $\mathfrak q' \subset S$ be a prime of $S$
mapping to $\mathfrak p'$. Then there exists a prime
$\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider the flat local ring map
$R_{\mathfrak p'} \to S_{\mathfrak q'}$.
By Lemma \ref{lemma-local-flat-ff} this is faithfully
flat. By Lemma \ref{lemma-ff-rings} there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\noindent
The property of $R \to S$ described in the lemma is called the
``going down property''. See Definition \ref{definition-going-up-down}.
We finish with some remarks on flatness and localization.

\begin{lemma}
\label{lemma-flat-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
\begin{enumerate}
\item The localization $S^{-1}R$ is a flat $R$-algebra.
\item If $M$ is an $S^{-1}R$-module, then $M$ is a flat $R$-module
if and only if $M$ is a flat $S^{-1}R$-module.
\item Suppose $M$ is an $R$-module. Then
$M$ is a flat $R$-module if and only if $M_{\mathfrak p}$ is a flat
$R_{\mathfrak p}$-module for all primes $\mathfrak p$ of $R$.
\item Suppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if
and only if $M_{\mathfrak m}$ is a flat
$R_{\mathfrak m}$-module for all maximal ideals $\mathfrak m$ of $R$.
\item Suppose $R \to A$ is a ring map, $M$ is an $A$-module,
and $g_1, \ldots, g_m \in A$ are elements generating the unit
ideal of $A$. Then $M$ is flat over $R$ if and only if each localization
$M_{g_i}$ is flat over $R$.
\item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Then $M$ is a flat $R$-module if and only if the localization
$M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module
(with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$)
for all primes $\mathfrak q$ of $A$.
\item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Then $M$ is a flat $R$-module if and only if the localization
$M_{\mathfrak m}$ is a flat $R_{\mathfrak p}$-module
(with $\mathfrak p = R \cap \mathfrak m$)
for all maximal ideals $\mathfrak m$ of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove the last statement of the lemma.
In the proof we will use repeatedly that localization is exact
and commutes with tensor product, see Sections \ref{section-localization}
and \ref{section-tensor-product}.

\medskip\noindent
Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Assume that $M_{\mathfrak m}$ is a flat $R_{\mathfrak p}$-module
for all maximal ideals $\mathfrak m$ of $A$ (with
$\mathfrak p = R \cap \mathfrak m$). Let $I \subset R$ be an ideal.
We have to show the map $I \otimes_R M \to M$ is injective.
We can think of this as a map of $A$-modules.
By assumption the localization
$(I \otimes_R M)_{\mathfrak m} \to M_{\mathfrak m}$ is injective
because
$(I \otimes_R M)_{\mathfrak m} =
I_{\mathfrak p} \otimes_{R_{\mathfrak p}} M_{\mathfrak m}$.
Hence the kernel of $I \otimes_R M \to M$ is zero by
Lemma \ref{lemma-characterize-zero-local}.
Hence $M$ is flat over $R$.

\medskip\noindent
Conversely, assume $M$ is flat over $R$. Pick a prime $\mathfrak q$
of $A$ lying over the prime $\mathfrak p$ of $R$. Suppose that
$I \subset R_{\mathfrak p}$ is an ideal. We have to show that
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is injective. We can write $I = J_{\mathfrak p}$ for some
ideal $J \subset R$. Then the map
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is just the localization (at $\mathfrak q$) of the map
$J \otimes_R M \to M$ which is injective. Since localization is exact
we see that $M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module.

\medskip\noindent
This proves (7) and (6). The other statements follow in a straightforward
way from the last statement (proofs omitted).
\end{proof}

\begin{lemma}
\label{lemma-colimit-faithfully-flat}
Let $R$ be a ring. Let $\{S_i, \varphi_{ii'}\}$ be a directed system of
faithfully flat $R$-algebras. Then $S = \colim_i S_i$ is a faithfully flat
$R$-algebra.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-colimit-flat} we see that $S$ is flat.
Let $\mathfrak m \subset R$ be a maximal ideal. By
Lemma \ref{lemma-ff-rings}
none of the rings $S_i/\mathfrak m S_i$ is zero.
Hence $S/\mathfrak mS = \colim S_i/\mathfrak mS_i$ is nonzero
as well because $1$ is not equal to zero. Thus the image of
$\Spec(S) \to \Spec(R)$ contains $\mathfrak m$ and we see that $R \to S$
is faithfully flat by Lemma \ref{lemma-ff-rings}.
\end{proof}





\section{Supports and annihilators}
\label{section-supp-and-ann}

\noindent
Some very basic definitions and lemmas.

\begin{definition}
\label{definition-support-module}
Let $R$ be a ring and let $M$ be an $R$-module.
The {\it support of $M$} is the set
$$
\text{Supp}(M)
=
\{
\mathfrak p \in \Spec(R)
\mid
M_{\mathfrak p} \not = 0
\}
$$
\end{definition}

\begin{lemma}
\label{lemma-support-zero}
\begin{slogan}
A module over a ring has empty support if and only if it is the trivial module.
\end{slogan}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
M = (0) \Leftrightarrow \text{Supp}(M) = \emptyset.
$$
\end{lemma}

\begin{proof}
Actually,
Lemma \ref{lemma-characterize-zero-local}
even shows that $\text{Supp}(M)$ always contains a maximal ideal
if $M$ is not zero.
\end{proof}

\begin{definition}
\label{definition-annihilator}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item Given an element $m \in M$ the {\it annihilator of $m$}
is the ideal
$$
\text{Ann}_R(m) = \text{Ann}(m) = \{f \in R \mid fm = 0\}.
$$
\item The {\it annihilator of $M$}
is the ideal
$$
\text{Ann}_R(M) = \text{Ann}(M) = \{f \in R \mid fm = 0\ \forall m \in M\}.
$$
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-annihilator-flat-base-change}
Let $R \to S$ be a flat ring map. Let $M$ be an $R$-module and
$m \in M$. Then $\text{Ann}_R(m) S = \text{Ann}_S(m \otimes 1)$.
If $M$ is a finite $R$-module, then
$\text{Ann}_R(M) S = \text{Ann}_S(M \otimes_R S)$.
\end{lemma}

\begin{proof}
Set $I = \text{Ann}_R(m)$. By definition there is an exact sequence
$0 \to I \to R \to M$ where the map $R \to M$ sends $f$ to $fm$. Using
flatness we obtain an exact sequence
$0 \to I \otimes_R S \to S \to M \otimes_R S$ which proves the first
assertion. If $m_1, \ldots, m_n$ is a set of generators of $M$
then $\text{Ann}_R(M) = \bigcap \text{Ann}_R(m_i)$. Similarly
$\text{Ann}_S(M \otimes_R S) = \bigcap \text{Ann}_S(m_i \otimes 1)$.
Set $I_i = \text{Ann}_R(m_i)$. Then it suffices to show that
$\bigcap_{i = 1, \ldots, n} (I_i S) = (\bigcap_{i = 1, \ldots, n} I_i)S$.
This is Lemma \ref{lemma-flat-intersect-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-support-closed}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is finite, then $\text{Supp}(M)$ is closed.
More precisely, if $I = \text{Ann}(M)$ is the annihilator of $M$, then
$V(I) = \text{Supp}(M)$.
\end{lemma}

\begin{proof}
We will show that $V(I) = \text{Supp}(M)$.

\medskip\noindent
Suppose $\mathfrak p \in \text{Supp}(M)$.
Then $M_{\mathfrak p} \not = 0$.
Hence by Nakayama's Lemma \ref{lemma-NAK} we have
$M \otimes_R \kappa(\mathfrak p) \not = 0$.
Hence $I \subset \mathfrak p$.

\medskip\noindent
Conversely, suppose that $\mathfrak p \not \in \text{Supp}(M)$.
Then $M_{\mathfrak p} = 0$.
Let $x_1, \ldots, x_r \in M$ be generators.
By Lemma \ref{lemma-localization-colimit} there exists
an $f \in R$, $f\not\in \mathfrak p$ such that
$x_i/1 = 0$ in $M_f$. Hence $f^{n_i} x_i = 0$ for some $n_i \geq 1$.
Hence $f^nM = 0$ for $n = \max\{n_i\}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-support-base-change}
Let $R \to R'$ be a ring map and let $M$ be a finite $R$-module.
Then $\text{Supp}(M \otimes_R R')$ is the inverse image of
$\text{Supp}(M)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \in \text{Supp}(M)$. By Nakayama's lemma
(Lemma \ref{lemma-NAK}) we see that
$$
M \otimes_R \kappa(\mathfrak p) = M_\mathfrak p/\mathfrak p M_\mathfrak p
$$
is a nonzero $\kappa(\mathfrak p)$ vector space.
Hence for every prime $\mathfrak p' \subset R'$ lying
over $\mathfrak p$ we see that
$$
(M \otimes_R R')_{\mathfrak p'}/\mathfrak p' (M \otimes_R R')_{\mathfrak p'} =
(M \otimes_R R') \otimes_{R'} \kappa(\mathfrak p') =
M \otimes_R \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p')
$$
is nonzero. This implies $\mathfrak p' \in \text{Supp}(M \otimes_R R')$.
For the converse, if $\mathfrak p' \subset R'$ is a prime lying
over an arbitrary prime $\mathfrak p \subset R$, then
$$
(M \otimes_R R')_{\mathfrak p'} =
M_\mathfrak p \otimes_{R_\mathfrak p} R'_{\mathfrak p'}.
$$
Hence if $\mathfrak p' \in \text{Supp}(M \otimes_R R')$
lies over the prime $\mathfrak p \subset R$, then
$\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-support-element}
Let $R$ be a ring, let $M$ be an $R$-module, and let $m \in M$.
Then $\mathfrak p \in V(\text{Ann}(m))$ if and only if
$m$ does not map to zero in $M_\mathfrak p$.
\end{lemma}

\begin{proof}
We may replace $M$ by $Rm \subset M$. Then (1) $\text{Ann}(m) = \text{Ann}(M)$
and (2) $x$ does not map to zero in $M_\mathfrak p$ if and only if
$\mathfrak p \in \text{Supp}(M)$.
The result now follows from Lemma \ref{lemma-support-closed}.
\end{proof}

\begin{lemma}
\label{lemma-support-finite-presentation-constructible}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is a finitely presented $R$-module, then $\text{Supp}(M)$ is a
closed subset of $\Spec(R)$ whose complement is quasi-compact.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \to 0
$$
Let $A \in \text{Mat}(n \times m, R)$ be the matrix of the first
map. By Nakayama's Lemma \ref{lemma-NAK} we see that
$$
M_{\mathfrak p} \not = 0 \Leftrightarrow
M \otimes \kappa(\mathfrak p) \not = 0 \Leftrightarrow
\text{rank}(A \bmod \mathfrak p) < n.
$$
Hence, if $I$ is the ideal of $R$ generated by the $n \times n$ minors
of $A$, then $\text{Supp}(M) = V(I)$. Since $I$
is finitely generated, say $I = (f_1, \ldots, f_t)$,
we see that $\Spec(R) \setminus V(I)$ is
a finite union of the standard opens $D(f_i)$, hence quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-support-quotient}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is finite then the support
of $M/IM$ is $\text{Supp}(M) \cap V(I)$.
\item If $N \subset M$, then $\text{Supp}(N) \subset
\text{Supp}(M)$.
\item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset
\text{Supp}(M)$.
\item If $0 \to N \to M \to Q \to 0$ is a short exact sequence
then $\text{Supp}(M) = \text{Supp}(Q) \cup \text{Supp}(N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The functors $M \mapsto M_{\mathfrak p}$ are exact. This immediately
implies all but the first assertion. For the first assertion
we need to show that $M_\mathfrak p \not = 0$ and
$I \subset \mathfrak p$ implies $(M/IM)_{\mathfrak p}
= M_\mathfrak p/IM_\mathfrak p \not = 0$. This follows
from Nakayama's Lemma \ref{lemma-NAK}.
\end{proof}





\section{Going up and going down}
\label{section-going-up}

\noindent
Suppose $\mathfrak p$, $\mathfrak p'$ are primes
of the ring $R$. Let $X = \Spec(R)$ with the Zariski
topology. Denote $x \in X$ the point corresponding
to $\mathfrak p$ and $x' \in X$ the point corresponding
to $\mathfrak p'$. Then we have:
$$
x' \leadsto x \Leftrightarrow \mathfrak p' \subset \mathfrak p.
$$
In words: $x$ is a specialization of $x'$ if and
only if $\mathfrak p' \subset \mathfrak p$.
See Topology, Section \ref{topology-section-specialization}
for terminology and notation.

\begin{definition}
\label{definition-going-up-down}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item We say a $\varphi : R \to S$ satisfies {\it going up} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q$ in $S$ lying over $\mathfrak p$
there exists a prime $\mathfrak q'$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q'$ lies over $\mathfrak p'$.
\item We say a $\varphi : R \to S$ satisfies {\it going down} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q'$ in $S$ lying over $\mathfrak p'$
there exists a prime $\mathfrak q$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q$ lies over $\mathfrak p$.
\end{enumerate}
\end{definition}

\noindent
So far we have see the following cases of this:
\begin{enumerate}
\item An integral ring map satisfies going up, see
Lemma \ref{lemma-integral-going-up}.
\item As a special case finite ring maps satisfy going up.
\item As a special case quotient maps $R \to R/I$ satisfy going up.
\item A flat ring map satisfies going down, see
Lemma \ref{lemma-flat-going-down}
\item As a special case any localization satisfies going down.
\item An extension $R \subset S$ of domains, with $R$ normal
and $S$ integral over $R$ satisfies going down, see
Proposition \ref{proposition-going-down-normal-integral}.
\end{enumerate}
Here is another case where going down holds.

\begin{lemma}
\label{lemma-open-going-down}
Let $R \to S$ be a ring map. If the induced map
$\varphi : \Spec(S) \to \Spec(R)$ is open, then
$R \to S$ satisfies going down.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak p \subset \mathfrak p' \subset R$ and
$\mathfrak q' \subset S$ lies over $\mathfrak p'$. As $\varphi$ is open,
for every $g \in S$, $g \not \in \mathfrak q'$ we see that $\mathfrak p$
is in the image of $D(g) \subset \Spec(S)$. In other words
$S_g \otimes_R \kappa(\mathfrak p)$ is not zero. Since $S_{\mathfrak q'}$
is the directed colimit of these $S_g$ this implies
that $S_{\mathfrak q'} \otimes_R \kappa(\mathfrak p)$ is not
zero, see
Lemmas \ref{lemma-localization-colimit} and
\ref{lemma-tensor-products-commute-with-limits}.
Hence $\mathfrak p$ is in the image of
$\Spec(S_{\mathfrak q'}) \to \Spec(R)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-specialization}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item $R \to S$ satisfies going down if and only if
generalizations lift along the map $\Spec(S) \to \Spec(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\item $R \to S$ satisfies going up if and only if
specializations lift along the map $\Spec(S) \to \Spec(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-composition}
Suppose $R \to S$ and $S \to T$ are ring maps satisfying
going down. Then so does $R \to T$. Similarly for going up.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-going-up-down-specialization}
this follows from
Topology, Lemma \ref{topology-lemma-lift-specialization-composition}
\end{proof}

\begin{lemma}
\label{lemma-image-stable-specialization-closed}
Let $R \to S$ be a ring map. Let $T \subset \Spec(R)$
be the image of $\Spec(S)$. If $T$ is stable under specialization,
then $T$ is closed.
\end{lemma}

\begin{proof}
We give two proofs.

\medskip\noindent
First proof. Let $\mathfrak p \subset R$ be a prime ideal such that
the corresponding point of $\Spec(R)$ is in the closure
of $T$. This means that for every $f \in R$, $f \not \in \mathfrak p$
we have $D(f) \cap T \not = \emptyset$. Note that $D(f) \cap T$
is the image of $\Spec(S_f)$ in $\Spec(R)$. Hence
we conclude that $S_f \not = 0$. In other words, $1 \not = 0$ in
the ring $S_f$. Since $S_{\mathfrak p}$ is the directed limit
of the rings $S_f$ we conclude that $1 \not = 0$ in
$S_{\mathfrak p}$. In other words, $S_{\mathfrak p} \not = 0$ and
considering the image of $\Spec(S_{\mathfrak p})
\to \Spec(S) \to \Spec(R)$ we see there exists
a $\mathfrak p' \in T$ with $\mathfrak p' \subset \mathfrak p$.
As we assumed $T$ closed under specialization we conclude $\mathfrak p$
is a point of $T$ as desired.

\medskip\noindent
Second proof. Let $I = \Ker(R \to S)$. We may replace $R$ by $R/I$.
In this case the ring map $R \to S$ is injective.
By Lemma \ref{lemma-injective-minimal-primes-in-image}
all the minimal primes of $R$ are contained in the image $T$. Hence
if $T$ is stable under specialization then it contains all primes.
\end{proof}

\begin{lemma}
\label{lemma-going-up-closed}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item Going up holds for $R \to S$, and
\item the map $\Spec(S) \to \Spec(R)$ is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
It is a general fact that specializations lift along a
closed map of topological spaces, see
Topology, Lemma \ref{topology-lemma-closed-open-map-specialization}.
Hence the second condition implies the first.

\medskip\noindent
Assume that going up holds for $R \to S$.
Let $V(I) \subset \Spec(S)$ be a closed set.
We want to show that the image of $V(I)$ in $\Spec(R)$ is closed.
The ring map $S \to S/I$ obviously satisfies going up.
Hence $R \to S \to S/I$ satisfies going up,
by Lemma \ref{lemma-going-up-down-composition}.
Replacing $S$ by $S/I$ it suffices to show the image $T$
of $\Spec(S)$ in $\Spec(R)$ is closed.
By Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images} this
image is stable under specialization. Thus the result follows
from Lemma \ref{lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-stable-specialization-closed}
Let $R$ be a ring. Let $E \subset \Spec(R)$ be a constructible subset.
\begin{enumerate}
\item If $E$ is stable under specialization, then $E$ is closed.
\item If $E$ is stable under generalization, then $E$ is open.
\end{enumerate}
\end{lemma}

\begin{proof}
First proof. The first assertion
follows from Lemma \ref{lemma-image-stable-specialization-closed}
combined with Lemma \ref{lemma-constructible-is-image}.
The second follows because the complement of a constructible
set is constructible
(see Topology, Lemma \ref{topology-lemma-constructible}),
the first part of the lemma and Topology,
Lemma \ref{topology-lemma-open-closed-specialization}.

\medskip\noindent
Second proof. Since $\Spec(R)$ is a spectral space by
Lemma \ref{lemma-spec-spectral} this is a special case of
Topology, Lemma
\ref{topology-lemma-constructible-stable-specialization-closed}.
\end{proof}

\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\Spec(S) \to \Spec(R)$ is open.
More generally this holds for any ring map $R \to S$ of
finite presentation which satisfies going down.
\end{proposition}

\begin{proof}
Assume that $R \to S$ has finite presentation and satisfies
going down.
It suffices to prove that the image of a standard open $D(f)$ is open.
Since $S \to S_f$ satisfies going down as well, we see that
$R \to S_f$ satisfies going down. Thus after replacing
$S$ by $S_f$ we see it suffices to prove the image is
open. By Chevalley's theorem
(Theorem \ref{theorem-chevalley})
the image is a constructible set $E$. And $E$ is stable
under generalization because $R \to S$ satisfies going down,
see Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images}.
Hence $E$ is open by
Lemma \ref{lemma-constructible-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-same-image}
Let $k$ be a field, and let $R$, $S$ be $k$-algebras.
Let $S' \subset S$ be a sub $k$-algebra, and let $f \in S' \otimes_k R$.
In the commutative diagram
$$
\xymatrix{
\Spec((S \otimes_k R)_f) \ar[rd] \ar[rr] & &
\Spec((S' \otimes_k R)_f) \ar[ld] \\
& \Spec(R) &
}
$$
the images of the diagonal arrows are the same.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be in the image of the south-west
arrow. This means (Lemma \ref{lemma-in-image}) that
$$
(S' \otimes_k R)_f \otimes_R \kappa(\mathfrak p)
=
(S' \otimes_k \kappa(\mathfrak p))_f
$$
is not the zero ring, i.e., $S' \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
The ring map
$S' \otimes_k \kappa(\mathfrak p) \to S \otimes_k \kappa(\mathfrak p)$
is injective. Hence also $S \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
Hence $(S \otimes_k R)_f \otimes_R \kappa(\mathfrak p)$
is not the zero ring. Thus (Lemma \ref{lemma-in-image})
we see that $\mathfrak p$ is in the image of the south-east arrow
as desired.
\end{proof}

\begin{lemma}
\label{lemma-map-into-tensor-algebra-open}
Let $k$ be a field.
Let $R$ and $S$ be $k$-algebras.
The map $\Spec(S \otimes_k R) \to \Spec(R)$
is open.
\end{lemma}

\begin{proof}
Let $f \in R \otimes_k S$.
It suffices to prove that the image of the standard open $D(f)$ is open.
Let $S' \subset S$ be a finite type $k$-subalgebra such that
$f \in S' \otimes_k R$. The map $R \to S' \otimes_k R$ is flat
and of finite presentation, hence the image $U$ of
$\Spec((S' \otimes_k R)_f) \to \Spec(R)$ is open
by Proposition \ref{proposition-fppf-open}.
By Lemma \ref{lemma-same-image} this is also the image of $D(f)$ and we win.
\end{proof}

\noindent
Here is a tricky lemma that is sometimes useful.

\begin{lemma}
\label{lemma-unique-prime-over-localize-below}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume that
\begin{enumerate}
\item there exists a unique prime $\mathfrak q \subset S$ lying over
$\mathfrak p$, and
\item either
\begin{enumerate}
\item going up holds for $R \to S$, or
\item going down holds for $R \to S$ and there is at most one prime
of $S$ above every prime of $R$.
\end{enumerate}
\end{enumerate}
Then $S_{\mathfrak p} = S_{\mathfrak q}$.
\end{lemma}

\begin{proof}
Consider any prime $\mathfrak q' \subset S$ which corresponds to
a point of $\Spec(S_{\mathfrak p})$. This means that
$\mathfrak p' = R \cap \mathfrak q'$ is contained in $\mathfrak p$.
Here is a picture
$$
\xymatrix{
\mathfrak q' \ar@{-}[d] \ar@{-}[r] & ? \ar@{-}[r] \ar@{-}[d] & S \ar@{-}[d] \\
\mathfrak p' \ar@{-}[r] & \mathfrak p \ar@{-}[r] & R
}
$$
Assume (1) and (2)(a).
By going up there exists a prime $\mathfrak q'' \subset S$
with $\mathfrak q' \subset \mathfrak q''$ and $\mathfrak q''$
lying over $\mathfrak p$. By the uniqueness of $\mathfrak q$ we
conclude that $\mathfrak q'' = \mathfrak q$. In other words
$\mathfrak q'$ defines a point of $\Spec(S_{\mathfrak q})$.

\medskip\noindent
Assume (1) and (2)(b).
By going down there exists a prime $\mathfrak q'' \subset \mathfrak q$
lying over $\mathfrak p'$. By the uniqueness of primes lying over
$\mathfrak p'$ we see that $\mathfrak q' = \mathfrak q''$.  In other words
$\mathfrak q'$ defines a point of $\Spec(S_{\mathfrak q})$.

\medskip\noindent
In both cases we conclude that the map
$\Spec(S_{\mathfrak q}) \to \Spec(S_{\mathfrak p})$
is bijective. Clearly this means all the elements of $S - \mathfrak q$
are all invertible in $S_{\mathfrak p}$, in other words
$S_{\mathfrak p} = S_{\mathfrak q}$.
\end{proof}

\noindent
The following lemma is a generalization of going down for
flat ring maps.

\begin{lemma}
\label{lemma-going-down-flat-module}
Let $R \to S$ be a ring map. Let $N$ be a finite $S$-module flat over $R$.
Endow $\text{Supp}(N) \subset \Spec(S)$ with the induced topology.
Then generalizations lift along $\text{Supp}(N) \to \Spec(R)$.
\end{lemma}

\begin{proof}
The meaning of the statement is as follows. Let
$\mathfrak p \subset \mathfrak p' \subset R$ be primes. Let
$\mathfrak q' \subset S$ be a prime $\mathfrak q' \in \text{Supp}(N)$
Then there exists a prime $\mathfrak q \subset \mathfrak q'$,
$\mathfrak q \in \text{Supp}(N)$ lying over $\mathfrak p$.
As $N$ is flat over $R$ we see that $N_{\mathfrak q'}$ is flat
over $R_{\mathfrak p'}$, see Lemma \ref{lemma-flat-localization}.
As $N_{\mathfrak q'}$ is finite over $S_{\mathfrak q'}$
and not zero since $\mathfrak q' \in \text{Supp}(N)$ we see
that $N_{\mathfrak q'} \otimes_{S_{\mathfrak q'}} \kappa(\mathfrak q')$
is nonzero by Nakayama's Lemma \ref{lemma-NAK}.
Thus $N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p')$
is also not zero. We conclude from Lemma \ref{lemma-ff}
that $N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$
is nonzero. Let
$J \subset S_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$
be the annihilator of the finite nonzero module
$N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$.
Since $J$ is a proper ideal we can choose a prime $\mathfrak q \subset S$
which corresponds to a prime of
$S_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)/J$.
This prime is in the support of $N$, lies over $\mathfrak p$, and
is contained in $\mathfrak q'$ as desired.
\end{proof}























\section{Separable extensions}
\label{section-separability}

\noindent
In this section we talk about separability for nonalgebraic field extensions.
This is closely related to the concept of geometrically reduced algebras, see
Definition \ref{definition-geometrically-reduced}.

\begin{definition}
\label{definition-separable-field-extension}
Let $k \subset K$ be a field extension.
\begin{enumerate}
\item We say $K$ is {\it separably generated over $k$} if there exists
a transcendence basis $\{x_i; i \in I\}$ of $K/k$ such that the extension
$k(x_i; i\in I) \subset K$ is a separable algebraic extension.
\item We say $K$ is {\it separable over $k$} if for every subextension
$k \subset K' \subset K$ with $K'$ finitely generated
over $k$, the extension $k \subset K'$ is separably generated.
\end{enumerate}
\end{definition}

\noindent
With this awkward definition it is not clear that
a separably generated field extension is itself separable.
It will turn out that this is the case, see
Lemma \ref{lemma-separably-generated-separable}.

\begin{lemma}
\label{lemma-subextensions-are-separable}
Let $k \subset K$ be a separable field extension.
For any subextension $k \subset K' \subset K$ the field
extension $k \subset K'$ is separable.
\end{lemma}

\begin{proof}
This is direct from the definition.
\end{proof}

\begin{lemma}
\label{lemma-generating-finitely-generated-separable-field-extensions}
Let $k \subset K$ be a separably generated, and finitely generated
field extension.
Set $r = \text{trdeg}_k(K)$. Then there exist elements
$x_1, \ldots, x_{r + 1}$ of $K$ such that
\begin{enumerate}
\item $x_1, \ldots, x_r$ is a transcendence basis of $K$ over $k$,
\item $K = k(x_1, \ldots, x_{r + 1})$, and
\item $x_{r + 1}$ is separable over $k(x_1, \ldots, x_r)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Combine the definition with Fields, Lemma \ref{fields-lemma-primitive-element}.
\end{proof}

\begin{lemma}
\label{lemma-make-separably-generated}
Let $k \subset K$ be a finitely generated field extension.
There exists a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is a separably generated field extension.
\end{lemma}

\begin{proof}
This lemma is only interesting when the characteristic of $k$ is $p > 0$.
Choose $x_1, \ldots, x_r$ a transcendence basis of $K$ over $k$.
As $K$ is finitely generated over $k$ the extension
$k(x_1, \ldots, x_r) \subset K$ is finite.
Let $k(x_1, \ldots, x_r) \subset K_{sep} \subset K$ be the subextension
found in
Fields, Lemma \ref{fields-lemma-separable-first}.
If $K = K_{sep}$ then we are done.
We will use induction on $d = [K : K_{sep}]$.

\medskip\noindent
Assume that $d > 1$. Choose a $\beta \in K$ with
$\alpha = \beta^p \in K_{sep}$ and $\beta \not \in K_{sep}$.
Let $P = T^d + a_1T^{d - 1} + \ldots + a_d$
be the minimal polynomial of $\alpha$ over $k(x_1, \ldots, x_r)$.
Let $k \subset k'$ be a finite purely inseparable extension
obtained by adjoining $p$th roots such that each $a_i$ is a
$p$th power in $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
Such an extension exists; details omitted.
Let $L$ be a field fitting into the diagram
$$
\xymatrix{
K \ar[r] & L \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u]
}
$$
We may and do assume $L$ is the compositum of $K$ and
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$. Let
$k'(x_1^{1/p}, \ldots, x_r^{1/p}) \subset L_{sep} \subset L$
be the subextension found in
Fields, Lemma \ref{fields-lemma-separable-first}.
Then $L_{sep}$ is the compositum of
$K_{sep}$ and $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
The element $\alpha \in L_{sep}$ is a zero of the polynomial
$P$ all of whose coefficients are $p$th powers in
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$ and whose roots are
pairwise distinct. By
Fields, Lemma \ref{fields-lemma-pth-root}
we see that $\alpha = (\alpha')^p$ for some $\alpha' \in L_{sep}$.
Clearly, this means that $\beta$ maps to $\alpha' \in L_{sep}$.
In other words, we get the tower of fields
$$
\xymatrix{
K \ar[r] & L \\
K_{sep}(\beta) \ar[r] \ar[u] & L_{sep} \ar[u] \\
K_{sep} \ar[r] \ar[u] & L_{sep} \ar@{=}[u] \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u] \\
k \ar[r] \ar[u] & k' \ar[u]
}
$$
Thus this construction leads to a new situation with
$[L : L_{sep}] < [K : K_{sep}]$. By induction we can find
$k' \subset k''$ and $L \subset L'$ as in the lemma for the
extension $k' \subset L$. Then the extensions $k \subset k''$ and
$K \subset L'$ work for the extension $k \subset K$.
This proves the lemma.
\end{proof}




\section{Geometrically reduced algebras}
\label{section-geometrically-reduced}

\noindent
The main result on geometrically reduced algebras is
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.
We suggest the reader skip to the lemma after reading the definition.

\begin{definition}
\label{definition-geometrically-reduced}
Let $k$ be a field. Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically reduced over $k$}
if for every field extension $k \subset K$ the
$K$-algebra $K \otimes_k S$ is reduced.
\end{definition}

\noindent
Let $k$ be a field and let $S$ be a reduced $k$ algebra.
To check that $S$ is geometrically reduced it will suffice
to check that $\overline{k} \otimes_k S$ is reduced (where
$\overline{k}$ denotes the algebraic closure of $k$).
In fact it is enough to check this for finite purely inseparable
field extensions $k \subset k'$. See
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.

\begin{lemma}
\label{lemma-subalgebra-separable}
Elementary properties of geometrically reduced algebras.
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically reduced over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically reduced, then $S$ is geometrically reduced.
\item A directed colimit of geometrically reduced $k$-algebras
is geometrically reduced.
\item If $S$ is geometrically reduced over $k$, then any localization
of $S$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. The second and third property follow from the fact that
tensor product commutes with colimits.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-permanence}
Let $k$ be a field.
If $R$ is geometrically reduced over $k$,
and $S \subset R$ is a multiplicative subset, then the localization
$S^{-1}R$ is geometrically reduced over $k$.
If $R$ is geometrically reduced over $k$, then $R[x]$ is geometrically
reduced over $k$.
\end{lemma}

\begin{proof}
Omitted. Hints: A localization of a reduced ring is reduced, and
localization commutes with tensor products.
\end{proof}

\noindent
In the proofs of the following lemmas we will repeatedly use
the following observation: Suppose that $R' \subset R$ and
$S' \subset S$ are inclusions of $k$-algebras.
Then the map $R' \otimes_k S' \to R \otimes_k S$
is injective.

\begin{lemma}
\label{lemma-limit-argument}
Let $k$ be a field. Let $R$, $S$ be $k$-algebras.
\begin{enumerate}
\item If $R \otimes_k S$ is nonreduced, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ is not reduced.
\item If $R \otimes_k S$ contains a nonzero zerodivisor, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nonzero zerodivisor.
\item If $R \otimes_k S$ contains a nontrivial idempotent, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nontrivial idempotent.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $z \in R \otimes_k S$ is nilpotent. We may write
$z = \sum_{i = 1, \ldots, n} x_i \otimes y_i$.
Thus we may take $R'$ the $k$-subalgebra generated by
the $x_i$ and $S'$ the $k$-subalgebra generated by the $y_i$.
The second and third statements are proved in the same way.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-any-reduced-base-change}
Let $k$ be a field.
Let $S$ be a geometrically reduced $k$-algebra.
Let $R$ be any reduced $k$-algebra.
Then $R \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-limit-argument}
we may assume that $R$ is of finite type over $k$.
Then $R$, as a reduced Noetherian ring, embeds into a finite
product of fields
(see Lemmas \ref{lemma-total-ring-fractions-no-embedded-points},
\ref{lemma-Noetherian-irreducible-components}, and
\ref{lemma-minimal-prime-reduced-ring}).
Hence we may assume $R$ is a finite product of
fields. In this case it follows from
Definition \ref{definition-geometrically-reduced}
that $R \otimes_k S$ is reduced.
\end{proof}

\begin{lemma}
\label{lemma-separable-extension-preserves-reducedness}
Let $k$ be a field.
Let $S$ be a reduced $k$-algebra.
Let $k \subset K$ be either a separable field extension,
or a separably generated field extension.
Then $K \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
Assume $k \subset K$ is separable.
By Lemma \ref{lemma-limit-argument}
we may assume that $S$ is of finite type over $k$
and $K$ is finitely generated over $k$.
Then $S$ embeds into a finite product of fields,
namely its total ring of fractions (see
Lemmas \ref{lemma-minimal-prime-reduced-ring} and
\ref{lemma-total-ring-fractions-no-embedded-points}).
Hence we may actually assume that $S$ is a domain.
We choose $x_1, \ldots, x_{r + 1} \in K$ as in
Lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}.
Let $P \in k(x_1, \ldots, x_r)[T]$
be the minimal polynomial of $x_{r + 1}$. It is a separable polynomial.
It is easy to see that
$k[x_1, \ldots, x_r] \otimes_k S = S[x_1, \ldots, x_r]$ is a domain.
This implies $k(x_1, \ldots, x_r) \otimes_k S$ is a domain
as it is a localization of $S[x_1, \ldots, x_r]$.
The ring extension $k(x_1, \ldots, x_r) \otimes_k S \subset K \otimes_k S$
is generated by a single element $x_{r + 1}$ with a single
equation, namely $P$. Hence $K \otimes_k S$ embeds into
$f.f.(k(x_1, \ldots, x_n) \otimes_k S)[T]/(P)$.
Since $P$ is separable this is a finite product of fields and we win.

\medskip\noindent
At this point we do not yet know that a separably generated field
extension is separable, so we have to prove the lemma in this case also.
To do this suppose that $\{x_i\}_{i \in I}$ is a separating
transcendence basis for $K$ over $k$. For any finite set of elements
$\lambda_j \in K$ there exists a finite subset $T \subset I$ such
that $k(\{x_i\}_{i\in T}) \subset k(\{x_i\}_{i \in T} \cup \{\lambda_j\})$
is finite separable. Hence we see that $K$ is a directed colimit of
finitely generated and separably generated extensions of $k$. Thus
the argument of the preceding paragraph applies to this case as well.
\end{proof}

\begin{lemma}
\label{lemma-generic-points-geometrically-reduced}
Let $k$ be a field and let $S$ be a $k$-algebra. Assume that
$S$ is reduced and that $S_{\mathfrak p}$ is geometrically
reduced for every minimal prime $\mathfrak p$ of $S$.
Then $S$ is geometrically reduced.
\end{lemma}

\begin{proof}
Since $S$ is reduced the map
$S \to \prod_{\mathfrak p\text{ minimal}} S_{\mathfrak p}$
is injective, see
Lemma \ref{lemma-reduced-ring-sub-product-fields}.
If $k \subset K$ is a field extension, then the maps
$$
S \otimes_k K \to (\prod S_\mathfrak p) \otimes_k K \to
\prod S_\mathfrak p \otimes_k K
$$
are injective: the first as $k \to K$ is flat and the second by inspection
because $K$ is a free $k$-module. As $S_\mathfrak p$ is geometrically
reduced the ring on the right is reduced. Thus we see that $S \otimes_k K$
is reduced as a subring of a reduced ring.
\end{proof}

\begin{lemma}
\label{lemma-separable-algebraic-diagonal}
Let $k'/k$ be a separable algebraic extension.
Then there exists a multiplicative subset $S \subset k' \otimes_k k'$
such that the multiplication map $k' \otimes_k k' \to k'$
is identified with $k' \otimes_k k' \to S^{-1}(k' \otimes_k k')$.
\end{lemma}

\begin{proof}
First assume $k'/k$ is finite separable. Then $k' = k(\alpha)$,
see Fields, Lemma \ref{fields-lemma-primitive-element}.
Let $P \in k[x]$ be the minimal polynomial of $\alpha$ over $k$.
Then $P$ is an irreducible, separable, monic polynomial, see
Fields, Section \ref{fields-section-separable-extensions}.
Then $k'[x]/(P) \to k' \otimes_k k'$,
$\sum \alpha_i x^i \mapsto \alpha_i \otimes \alpha^i$ is an isomorphism.
We can factor $P = (x - \alpha) Q$ in $k'[x]$ and since $P$
is separable we see that $Q(\alpha) \not = 0$.
Then it is clear that the multiplicative set $S'$ generated by
$Q$ in $k'[x]/(P)$ works, i.e., that $k' = (S')^{-1}(k'[x]/(P))$.
By transport of structure the image $S$ of $S'$ in $k' \otimes_k k'$
works.

\medskip\noindent
In the general case we write $k' = \bigcup k_i$ as the union
of its finite subfield extensions over $k$. For each $i$ there
is a multiplicative subset $S_i \subset k_i \otimes_k k_i$
such that $k_i = S_i^{-1}(k_i \otimes_k k_i)$. Then
$S = \bigcup S_i \subset k' \otimes_k k'$ works.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-over-separable-algebraic}
Let $k \subset k'$ be a separable algebraic field extension.
Let $A$ be an algebra over $k'$. Then $A$ is geometrically
reduced over $k$ if and only if it is geometrically reduced over $k'$.
\end{lemma}

\begin{proof}
Assume $A$ is geometrically reduced over $k'$.
Let $K/k$ be a field extension. Then $K \otimes_k k'$ is
a reduced ring by
Lemma \ref{lemma-separable-extension-preserves-reducedness}.
Hence by Lemma \ref{lemma-geometrically-reduced-any-reduced-base-change}
we find that $K \otimes_k A = (K \otimes_k k') \otimes_{k'} A$ is reduced.

\medskip\noindent
Assume $A$ is geometrically reduced over $k$. Let $K/k'$ be a field
extension. Then
$$
K \otimes_{k'} A = (K \otimes_k A) \otimes_{(k' \otimes_k k')} k'
$$
Since $k' \otimes_k k' \to k'$ is a localization by
Lemma \ref{lemma-separable-algebraic-diagonal},
we see that $K \otimes_{k'} A$
is a localization of a reduced algebra, hence reduced.
\end{proof}





\section{Separable extensions, continued}
\label{section-separability-continued}

\noindent
In this section we continue the discussion started in
Section \ref{section-separability}.
Let $p$ be a prime number and let $k$ be a field of characteristic $p$.
In this case we write $k^{1/p}$ for the extension of $k$ gotten by
adjoining $p$th roots of all the elements of $k$ to $k$.
(In other words it is the subfield of an algebraic closure of
$k$ generated by the $p$th roots of elements of $k$.)

\begin{lemma}
\label{lemma-characterize-separable-field-extensions}
Let $k$ be a field of characteristic $p > 0$.
Let $k \subset K$ be a field extension.
The following are equivalent:
\begin{enumerate}
\item $K$ is separable over $k$,
\item the ring $K \otimes_k k^{1/p}$ is reduced, and
\item $K$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (3) follows from
Lemma \ref{lemma-separable-extension-preserves-reducedness}.
The implication (3) $\Rightarrow$ (2) is immediate.

\medskip\noindent
Assume (2). Let $k \subset L \subset K$ be a subextension such that
$L$ is a finitely generated field extension of $k$.
We have to show that we can find a separating transcendence basis of $L$.
The assumption implies that $L \otimes_k k^{1/p}$ is reduced.
Let $x_1, \ldots, x_r$ be a transcendence basis of $L$ over $k$ such
that the degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$ is minimal.
If $L$ is separable over $k(x_1, \ldots, x_r)$ then we win.
Assume this is not the case to get a contradiction.
Then there exists an element $\alpha \in L$ which is not
separable over $k(x_1, \ldots, x_r)$. Let $P(T) \in k(x_1, \ldots, x_r)[T]$
be the minimal polynomial of $\alpha$ over $k(x_1, \ldots, x_r)$.
After replacing $\alpha$ by $f \alpha$ for some nonzero
$f \in k[x_1, \ldots, x_r]$
we may and do assume that $P$ lies in $k[x_1, \ldots, x_r, T]$.
Because $\alpha$ is not separable $P$ is a polynomial in $T^p$, see
Fields, Lemma \ref{fields-lemma-irreducible-polynomials}.
Let $dp$ be the degree of $P$ as a polynomial in $T$.
Since $P$ is the minimal polynomial of $\alpha$ the monomials
$$
x_1^{e_1} \ldots x_r^{e_r} \alpha^e
$$
for $e < dp$ are linearly independent over $k$ in $L$. We claim that
the element $\partial P/\partial x_i \in k[x_1, \ldots, x_r, T]$ is not zero
for at least one $i$.
Namely, if this was not the case, then $P$ is actually a polynomial in
$x_1^p, \ldots, x_r^p, T^p$. In that case we can consider
$P^{1/p} \in k^{1/p}[x_1, \ldots, x_r, T]$. This would map to
$P^{1/p}(x_1, \ldots, x_r, \alpha)$ which is a nilpotent element of
$k^{1/p} \otimes_k L$ and hence zero. On the other hand,
$P^{1/p}(x_1, \ldots, x_r, \alpha)$ is a $k^{1/p}$-linear combination
the monomials listed above, hence nonzero in $k^{1/p} \otimes_k L$.
This is a contradiction which proves our claim.

\medskip\noindent
Thus, after renumbering, we may assume that $\partial P/\partial x_1$
is not zero. As $P$ is an irreducible polynomial in $T$ over
$k(x_1, \ldots, x_r)$ it is irreducible as a polynomial in
$x_1, \ldots, x_r, T$, hence by Gauss's lemma it is irreducible
as a polynomial in $x_1$ over $k(x_2, \ldots, x_r, T)$.
Since the transcendence degree of $L$ is $r$ we see that
$x_2, \ldots, x_r, \alpha$ are algebraically independent.
Hence $P(X, x_2, \ldots, x_r, \alpha) \in k(x_2, \ldots, x_r, \alpha)[X]$
is irreducible. It follows that $x_1$ is separably algebraic over
$k(x_2, \ldots, x_r, \alpha)$. This means that
the degree of inseparability of the finite extension
$k(x_2, \ldots, x_r, \alpha) \subset L$ is less than the
degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$, which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-separably-generated-separable}
A separably generated field extension is separable.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-separable-extension-preserves-reducedness}
with Lemma \ref{lemma-characterize-separable-field-extensions}.
\end{proof}

\noindent
In the following lemma we will use the notion of the perfect closure
which is defined in
Definition \ref{definition-perfection}.

\begin{lemma}
\label{lemma-geometrically-reduced-finite-purely-inseparable-extension}
Let $k$ be a field. Let $S$ be a $k$-algebra.
The following are equivalent:
\begin{enumerate}
\item $k' \otimes_k S$ is reduced for every finite
purely inseparable extension $k'$ of $k$,
\item $k^{1/p} \otimes_k S$ is reduced,
\item $k^{perf} \otimes_k S$ is reduced, where $k^{perf}$ is the
perfect closure of $k$,
\item $\overline{k} \otimes_k S$ is reduced, where $\overline{k}$ is the
algebraic closure of $k$, and
\item $S$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that any finite purely inseparable extension $k \subset k'$ embeds
in $k^{perf}$. Moreover, $k^{1/p}$ embeds into $k^{perf}$ which embeds
into $\overline{k}$. Thus it is
clear that (5) $\Rightarrow$ (4) $\Rightarrow$ (3) $\Rightarrow$ (2)
and that (3) $\Rightarrow$ (1).

\medskip\noindent
We prove that (1) $\Rightarrow$ (5).
Assume $k' \otimes_k S$ is reduced for every finite
purely inseparable extension $k'$ of $k$. Let $k \subset K$ be
an extension of fields. We have to show that $K \otimes_k S$
is reduced. By Lemma \ref{lemma-limit-argument} we reduce to the case where
$k \subset K$ is a finitely generated field extension. Choose a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
as in Lemma \ref{lemma-make-separably-generated}.
By assumption $k' \otimes_k S$ is reduced.
By Lemma \ref{lemma-separable-extension-preserves-reducedness}
it follows that $K' \otimes_k S$ is reduced.
Hence we conclude that $K \otimes_k S$ is reduced as desired.

\medskip\noindent
Finally we prove that (2) $\Rightarrow$ (5).
Assume $k^{1/p} \otimes_k S$ is reduced. Then $S$ is reduced.
Moreover, for each localization $S_{\mathfrak p}$ at a minimal
prime $\mathfrak p$, the ring $k^{1/p}\otimes_k S_{\mathfrak p}$
is a localization of $k^{1/p} \otimes_k S$ hence is reduced.
But $S_{\mathfrak p}$ is a field by
Lemma \ref{lemma-minimal-prime-reduced-ring},
hence $S_{\mathfrak p}$ is geometrically reduced by
Lemma \ref{lemma-characterize-separable-field-extensions}.
It follows from Lemma \ref{lemma-generic-points-geometrically-reduced}
that $S$ is geometrically reduced.
\end{proof}



\section{Perfect fields}
\label{section-perfect-fields}

\noindent
Here is the definition.

\begin{definition}
\label{definition-perfect}
Let $k$ be a field. We say $k$ is {\it perfect}
if every field extension of $k$ is separable over $k$.
\end{definition}

\begin{lemma}
\label{lemma-perfect}
A field $k$ is perfect if and only if it is a field of characteristic $0$
or a field of characteristic $p > 0$ such that every element has a $p$th
root.
\end{lemma}

\begin{proof}
The characteristic zero case is clear.
Assume the characteristic of $k$ is $p > 0$.
If $k$ is perfect, then all the field extensions where we adjoin
a $p$th root of an element of $k$ have to be trivial, hence every
element of $k$ has a $p$th root. Conversely if every element has a $p$th
root, then $k = k^{1/p}$ and every field extension of $k$ is
separable by
Lemma \ref{lemma-characterize-separable-field-extensions}.
\end{proof}

\begin{lemma}
\label{lemma-make-separable}
Let $k \subset K$ be a finitely generated field extension.
There exists a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is a separable field extension.
In this situation we can assume that $K' = k'K$ is the compositum,
and also that $K' = (k' \otimes_k K)_{red}$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-make-separably-generated}
we can find such a diagram with $k' \subset K'$ separably generated.
By
Lemma \ref{lemma-separably-generated-separable}
this implies that $K'$ is separable over $k'$.
The compositum $k'K$ is a subextension of $k' \subset K'$ and hence
$k' \subset k'K$ is separable by
Lemma \ref{lemma-subextensions-are-separable}.
The ring $(k' \otimes_k K)_{red}$ is a domain as for some
$n \gg 0$ the map $x \mapsto x^{p^n}$ maps it into $K$.
Hence it is a field by
Lemma \ref{lemma-integral-over-field}.
Thus $(k' \otimes_k K)_{red} \to K'$ maps it isomorphically onto $k'K$.
\end{proof}

\begin{lemma}
\label{lemma-perfection}
\begin{slogan}
Every field has a unique perfect closure.
\end{slogan}
For every field $k$ there exists a purely inseparable extension
$k \subset k'$ such that $k'$ is perfect. The field extension
$k \subset k'$ is unique up to unique isomorphism.
\end{lemma}

\begin{proof}
If the characteristic of $k$ is zero, then $k' = k$ is the
unique choice. Assume the characteristic of $k$ is $p > 0$.
For every $n > 0$ there exists a unique algebraic extension
$k \subset k^{1/p^n}$ such that (a) every element $\lambda \in k$
has a $p^n$th root in $k^{1/p^n}$ and (b) for every element
$\mu \in k^{1/p^n}$ we have $\mu^{p^n} \in k$.
Namely, consider the ring map $k \to k^{1/p^n} = k$, $x \mapsto x^{p^n}$.
This is injective and satisfies (a) and (b). It is clear that
$k^{1/p^n} \subset k^{1/p^{n + 1}}$ as extensions of $k$ via
the map $y \mapsto y^p$. Then we can take $k' = \bigcup k^{1/p^n}$.
Some details omitted.
\end{proof}

\begin{definition}
\label{definition-perfection}
Let $k$ be a field. The field extension $k \subset k'$ of
Lemma \ref{lemma-perfection}
is called the {\it perfect closure} of $k$. Notation $k \subset k^{perf}$.
\end{definition}

\noindent
Note that if $k \subset k'$ is any algebraic purely inseparable extension, then
$k' \subset k^{perf}$. Namely, $(k')^{perf}$ is isomorphic to $k^{perf}$
by the uniqueness of
Lemma \ref{lemma-perfection}.

\begin{lemma}
\label{lemma-perfect-reduced}
Let $k$ be a perfect field.
Any reduced $k$ algebra is geometrically reduced over $k$.
Let $R$, $S$ be $k$-algebras.
Assume both $R$ and $S$ are reduced.
Then the $k$-algebra $R \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
The first statement follows from
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.
For the second statement use the first statement and
Lemma \ref{lemma-geometrically-reduced-any-reduced-base-change}.
\end{proof}









\section{Universal homeomorphisms}
\label{section-universal-homeomorphism}

\noindent
Let $k \subset k'$ be an algebraic purely inseparable field
extension. Then for any $k$-algebra $R$ the ring map
$R \to k' \otimes_k R$ induces a homeomorphism of spectra.
The reason for this is the slightly more general
Lemma \ref{lemma-p-ring-map} below.

\begin{lemma}
\label{lemma-surjective-locally-nilpotent-kernel}
Let $\varphi : R \to S$ be a surjective map with locally nilpotent kernel.
Then $\varphi$ induces a homeomorphism of spectra and isomorphisms
on residue fields. For any ring map $R \to R'$ the ring map
$R' \to R' \otimes_R S$ is surjective with locally nilpotent kernel.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-spec-closed} the map $\Spec(S) \to \Spec(R)$ is
a homeomorphism onto the closed subset $V(\Ker(\varphi))$. Of course
$V(\Ker(\varphi)) = \Spec(R)$ because every prime ideal of $R$ contains
every nilpotent element of $R$. This also implies the statement on
residue fields. By right exactness of tensor product we see that
$\Ker(\varphi)R'$ is the kernel of the surjective map $R' \to R' \otimes_R S$.
Hence the final statement by Lemma \ref{lemma-locally-nilpotent}.
\end{proof}

\begin{lemma}
\label{lemma-powers-field}
\begin{reference}
\cite[Lemma 3.1.6]{Alper-adequate}
\end{reference}
Let $k \subset k'$ be a field extension. The following are equivalent
\begin{enumerate}
\item for each $x \in k'$ there exists an $n > 0$ such that $x^n \in k$, and
\item $k' = k$, or $k'/k$ is a purely inseparable extension of fields, or
$k$ and $k'$ have characteristic $p > 0$ and
are algebraic extensions of $\mathbf{F}_p$.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that each of the possibilities listed in (2) satisfies (1).
Thus we assume $k'/k$ satisfies (1) and we prove that we are in
one of the cases of (2). Discarding the case $k = k'$ we may assume
$k' \not = k$. It is clear that $k'/k$ is algebraic.
Hence we may assume that $k'/k$ is a nontrivial finite extension.
Let $k \subset k'_{sep} \subset k'$ be the separable subextension
found in Fields, Lemma \ref{fields-lemma-separable-first}.
We have to show that $k = k'_{sep}$ or that $k$ is an algebraic over
$\mathbf{F}_p$. Thus we may assume that $k'/k$
is a nontrivial finite separable extension and we have to show
$k$ is algebraic over $\mathbf{F}_p$.

\medskip\noindent
Pick $x \in k'$, $x \not \in k$. Pick $n, m > 0$ such that
$x^n \in k$ and $(x + 1)^m \in k$. Let $\overline{k}$ be an
algebraic closure of $k$. We can choose embeddings
$\sigma, \tau : k' \to \overline{k}$ with $\sigma(x) \not = \tau(x)$.
This follows from the discussion in
Fields, Section \ref{fields-section-separable-extensions}
(more precisely, after replacing $k'$ by the $k$-extension
generated by $x$ it follows from
Fields, Lemma \ref{fields-lemma-count-embeddings}).
Then we see that $\sigma(x) = \zeta \tau(x)$ for some
$n$th root of unity $\zeta$ in $\overline{k}$.
Similarly, we see that $\sigma(x + 1) = \zeta' \tau(x + 1)$
for some $m$th root of unity $\zeta' \in \overline{k}$.
Since $\sigma(x + 1) \not = \tau(x + 1)$ we see $\zeta' \not = 1$.
Then
$$
\zeta' (\tau(x) + 1) =
\zeta' \tau(x + 1) =
\sigma(x + 1) =
\sigma(x) + 1 =
\zeta \tau(x) + 1
$$
implies that
$$
\tau(x) (\zeta' - \zeta) = 1 - \zeta'
$$
hence $\zeta' \not = \zeta$ and
$$
\tau(x) = (1 - \zeta')/(\zeta' - \zeta)
$$
Hence every element of $k'$ which is not in $k$ is algebraic over the prime
subfield. Since $k'$ is generated over the prime subfield by the elements
of $k'$ which are not in $k$, we conclude that $k'$ (and hence $k$)
is algebraic over the prime subfield.

\medskip\noindent
Finally, if the characteristic of $k$ is $0$, the above leads to a
contradiction as follows (we encourage the reader to find their own proof).
For every rational number $y$ we similarly get a root of unity
$\zeta_y$ such that $\sigma(x + y) = \zeta_y\tau(x + y)$.
Then we find
$$
\zeta \tau(x) + y = \zeta_y(\tau(x) + y)
$$
and by our formula for $\tau(x)$ above we conclude
$\zeta_y \in \mathbf{Q}(\zeta, \zeta')$. Since the number field
$\mathbf{Q}(\zeta, \zeta')$ contains only a finite number of roots of
unity we find two distinct rational numbers $y, y'$ with
$\zeta_y = \zeta_{y'}$. Then we conclude that
$$
y - y' =
\sigma(x + y) - \sigma(x + y') =
\zeta_y(\tau(x + y)) - \zeta_{y'}\tau(x + y') = \zeta_y(y - y')
$$
which implies $\zeta_y = 1$ a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-powers}
Let $\varphi : R \to S$ be a ring map. If
\begin{enumerate}
\item for any $x \in S$ there exists $n > 0$ such that
$x^n$ is in the image of $\varphi$, and
\item $\Ker(\varphi)$ is locally nilpotent,
\end{enumerate}
then $\varphi$ induces a homeomorphism on spectra and induces residue
field extensions satisfying the equivalent conditions of
Lemma \ref{lemma-powers-field}.
\end{lemma}

\begin{proof}
Assume (1) and (2). Let $\mathfrak q, \mathfrak q'$ be primes of $S$
lying over the same prime ideal $\mathfrak p$ of $R$. Suppose $x \in S$ with
$x \in \mathfrak q$, $x \not \in \mathfrak q'$. Then $x^n \in \mathfrak q$
and $x^n \not \in \mathfrak q'$ for all $n > 0$. If $x^n = \varphi(y)$ with
$y \in R$ for some $n > 0$ then
$$
x^n \in \mathfrak q \Rightarrow y \in \mathfrak p \Rightarrow
x^n \in \mathfrak q'
$$
which is a contradiction. Hence there does not exist an $x$ as above and
we conclude that $\mathfrak q = \mathfrak q'$, i.e., the map on spectra
is injective. By assumption (2) the kernel $I = \Ker(\varphi)$ is
contained in every prime, hence $\Spec(R) = \Spec(R/I)$ as
topological spaces. As the induced map $R/I \to S$ is integral by
assumption (1)
Lemma \ref{lemma-integral-overring-surjective}
shows that $\Spec(S) \to \Spec(R/I)$ is surjective. Combining
the above we see that $\Spec(S) \to \Spec(R)$ is bijective.
If $x \in S$ is arbitrary, and we pick $y \in R$ such that
$\varphi(y) = x^n$ for some $n > 0$, then we see that the open
$D(x) \subset \Spec(S)$ corresponds to the open
$D(y) \subset \Spec(R)$ via the bijection above. Hence we see that
the map $\Spec(S) \to \Spec(R)$ is a homeomorphism.

\medskip\noindent
To see the statement on residue fields, let $\mathfrak q \subset S$
be a prime lying over a prime ideal $\mathfrak p \subset R$. Let
$x \in \kappa(\mathfrak q)$. If we think of $\kappa(\mathfrak q)$
as the residue field of the local ring $S_\mathfrak q$, then we
see that $x$ is the image of some $y/z \in S_\mathfrak q$
with $y \in S$, $z \in S$, $z \not \in \mathfrak q$.
Choose $n, m > 0$ such that $y^n, z^m$ are in the image of $\varphi$.
Then $x^{nm}$ is the residue of $(y/z)^{nm} = (y^n)^m/(z^m)^n$
which is in the image of $R_\mathfrak p \to S_\mathfrak q$.
Hence $x^{nm}$ is in the image of
$\kappa(\mathfrak p) \to \kappa(\mathfrak q)$.
\end{proof}

\begin{lemma}
\label{lemma-help-with-powers}
Let $p$ be a prime number. Let $n, m > 0$ be two integers. There exists
an integer $a$ such that
$(x + y)^{p^a}, p^a(x + y) \in \mathbf{Z}[x^{p^n}, p^nx, y^{p^m}, p^my]$.
\end{lemma}

\begin{proof}
This is clear for $p^a(x + y)$ as soon as $a \geq n, m$.
In fact, pick $a \gg n, m$. Write
$$
(x + y)^{p^a}  = \sum\nolimits_{i, j \geq 0, i + j = p^a}
{p^a \choose i, j} x^iy^j
$$
For every $i, j \geq 0$ with $i + j = p^a$ write
$i = q p^n + r$ with $r \in \{0, \ldots, p^n - 1\}$ and
$j = q' p^m + r'$ with $r' \in \{0, \ldots, p^m - 1\}$.
The condition $(x + y)^{p^a} \in \mathbf{Z}[x^{p^n}, p^nx, y^{p^m}, p^my]$
holds if
$$
p^{nr + mr'} \text{ divides } {p^a \choose i, j}
$$
If $r = r' = 0$ then the divisibility holds. If $r \not = 0$, then
we write
$$
{p^a \choose i, j} = \frac{p^a}{i} {p^a - 1 \choose i - 1, j}
$$
Since $r \not = 0$ the rational number $p^a/i$ has $p$-adic
valuation at least $a - (n - 1)$ (because $i$ is not divisible by $p^n$).
Thus ${p^a \choose i, j}$ is divisible by $p^{a - n + 1}$ in this case.
Similarly, we see that if $r' \not = 0$, then ${p^a \choose i, j}$ is
divisible by $p^{a - m + 1}$. Picking $a = np^n + mp^m + n + m$ will work.
\end{proof}

\begin{lemma}
\label{lemma-p-ring-map-field}
Let $k \subset k'$ be a field extension. Let $p$ be a prime number.
The following are equivalent
\begin{enumerate}
\item $k'$ is generated as a field extension of $k$ by elements
$x$ such that there exists an $n > 0$ with $x^{p^n} \in k$ and
$p^nx \in k$, and
\item $k = k'$ or the characteristic of $k$
and $k'$ is $p$ and $k'/k$ is purely inseparable.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in k'$. If there exists an $n > 0$ with $x^{p^n} \in k$ and
$p^nx \in k$ and if the characteristic is not $p$, then $x \in k$.
If the characteristic is $p$, then we find $x^{p^n} \in k$
and hence $x$ is purely inseparable over $k$.
\end{proof}

\begin{lemma}
\label{lemma-p-ring-map}
Let $\varphi : R \to S$ be a ring map. Let $p$ be a prime number. Assume
\begin{enumerate}
\item[(a)] $S$ is generated as an $R$-algebra by elements $x$ such
that there exists an $n > 0$ with $x^{p^n} \in \varphi(R)$ and
$p^nx \in \varphi(R)$, and
\item[(b)] $\Ker(\varphi)$ is locally nilpotent,
\end{enumerate}
Then $\varphi$ induces a homeomorphism of spectra and induces
residue field extensions satisfying the equivalent conditions
of Lemma \ref{lemma-p-ring-map-field}. For any ring map $R \to R'$
the ring map $R' \to R' \otimes_R S$ also satisfies (a) and (b).
\end{lemma}

\begin{proof}
Assume (a) and (b). Note that (b) is equivalent to condition (2)
of Lemma \ref{lemma-powers}. Let $T \subset S$ be the set of
elements $x \in S$ such that there exists an
integer $n > 0$ such that $x^{p^n} , p^n x \in \varphi(R)$.
We claim that $T = S$. This will prove that condition (1) of
Lemma \ref{lemma-powers} holds and hence $\varphi$ induces
a homeomorphism on spectra.
By assumption (a) it suffices to show that $T \subset S$ is an $R$-sub algebra.
If $x \in T$ and $y \in R$, then it is clear that $yx \in T$.
Suppose $x, y \in T$ and $n, m > 0$ such that
$x^{p^n}, y^{p^m}, p^n x, p^m y \in \varphi(R)$.
Then $(xy)^{p^{n + m}}, p^{n + m}xy \in \varphi(R)$
hence $xy \in T$. We have $x + y \in T$ by Lemma \ref{lemma-help-with-powers}
and the claim is proved.

\medskip\noindent
Since $\varphi$ induces a homeomorphism on spectra, it is in particular
surjective on spectra which is a property preserved under any base change, see
Lemma \ref{lemma-surjective-spec-radical-ideal}.
Therefore for any $R \to R'$ the kernel of the ring map
$R' \to R' \otimes_R S$ consists of nilpotent elements, see
Lemma \ref{lemma-image-dense-generic-points},
in other words (b) holds for $R' \to R' \otimes_R S$.
It is clear that (a) is preserved under base change.
Finally, the condition on residue fields follows from (a)
as generators for $S$ as an $R$-algebra map to generators for
the residue field extensions.
\end{proof}

\begin{lemma}
\label{lemma-radicial}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ induces an injective map of spectra,
\item $\varphi$ induces purely inseparable residue field extensions.
\end{enumerate}
Then for any ring map $R \to R'$ properties (1) and (2) are true for
$R' \to R' \otimes_R S$.
\end{lemma}

\begin{proof}
Set $S' = R' \otimes_R S$ so that we have a commutative diagram
of continuous maps of spectra of rings
$$
\xymatrix{
\Spec(S') \ar[r] \ar[d] & \Spec(S) \ar[d] \\
\Spec(R') \ar[r] & \Spec(R)
}
$$
Let $\mathfrak p' \subset R'$ be a prime ideal lying over
$\mathfrak p \subset R$. If there is no prime ideal of $S$
lying over $\mathfrak p$, then there is no prime ideal of
$S'$ lying over $\mathfrak p'$. Otherwise, by
Remark \ref{remark-fundamental-diagram} there is a unique
prime ideal $\mathfrak r$ of $F = S \otimes_R \kappa(\mathfrak p)$
whose residue field is purely inseparable over $\kappa(\mathfrak p)$.
Consider the ring maps
$$
\kappa(\mathfrak p) \to F \to \kappa(\mathfrak r)
$$
By Lemma \ref{lemma-minimal-prime-reduced-ring} the ideal
$\mathfrak r \subset F$ is locally nilpotent, hence
we may apply Lemma \ref{lemma-surjective-locally-nilpotent-kernel}
to the ring map $F \to \kappa(\mathfrak r)$.
We may apply Lemma \ref{lemma-p-ring-map}
to the ring map $\kappa(\mathfrak p) \to \kappa(\mathfrak r)$.
Hence the composition and the second arrow in the maps
$$
\kappa(\mathfrak p') \to
\kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} F \to
\kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak r)
$$
induces bijections on spectra and purely inseparable residue
field extensions. This implies the same thing for the first
map. Since
$$
\kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} F =
\kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p) \otimes_R S =
\kappa(\mathfrak p') \otimes_R S =
\kappa(\mathfrak p') \otimes_{R'} R' \otimes_R S
$$
we conclude by the discussion in Remark \ref{remark-fundamental-diagram}.
\end{proof}

\begin{lemma}
\label{lemma-radicial-integral}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is integral,
\item $\varphi$ induces an injective map of spectra,
\item $\varphi$ induces purely inseparable residue field extensions.
\end{enumerate}
Then $\varphi$ induces a homeomorphism from $\Spec(S)$ onto a closed
subset of $\Spec(R)$ and for any ring map
$R \to R'$ properties (1), (2), (3) are true for $R' \to R' \otimes_R S$.
\end{lemma}

\begin{proof}
The map on spectra is closed by
Lemmas \ref{lemma-going-up-closed} and \ref{lemma-integral-going-up}.
The properties are preserved under base change by
Lemmas \ref{lemma-radicial} and \ref{lemma-base-change-integral}.
\end{proof}

\begin{lemma}
\label{lemma-radicial-integral-bijective}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is integral,
\item $\varphi$ induces an bijective map of spectra,
\item $\varphi$ induces purely inseparable residue field extensions.
\end{enumerate}
Then $\varphi$ induces a homeomorphism on spectra and for any ring map
$R \to R'$ properties (1), (2), (3) are true for $R' \to R' \otimes_R S$.
\end{lemma}

\begin{proof}
Follows from Lemmas \ref{lemma-radicial-integral} and
\ref{lemma-surjective-spec-radical-ideal}.
\end{proof}

\begin{lemma}
\label{lemma-universally-bijective}
Let $\varphi : R \to S$ be a ring map such that
\begin{enumerate}
\item the kernel of $\varphi$ is locally nilpotent, and
\item $S$ is generated as an $R$-algebra by elements $x$
such that there exist $n > 0$ and a polynomial $P(T) \in R[T]$
whose image in $S[T]$ is $(T - s)^n$.
\end{enumerate}
Then $\Spec(S) \to \Spec(R)$ is a homeomorphism and $R \to S$
induces purely inseparable extensions of residue fields.
Moreover, conditions (1) and (2) remain true on arbitrary base change.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\Ker(\varphi)$, see
Lemma \ref{lemma-surjective-locally-nilpotent-kernel}.
Assumption (2) implies $S$ is generated over $R$ by
elements which are integral over $R$.
Hence $R \subset S$ is integral
(Lemma \ref{lemma-integral-closure-is-ring}).
In particular $\Spec(S) \to \Spec(R)$ is surjective and closed
(Lemmas \ref{lemma-integral-overring-surjective},
\ref{lemma-going-up-closed}, and
\ref{lemma-integral-going-up}).

\medskip\noindent
Let $x \in S$ be one of the generators in (2), i.e., there exists an
$n > 0$ be such that $(T - x)^n \in R[T]$.
Let $\mathfrak p \subset R$ be a prime.
The $\kappa(\mathfrak p) \otimes_R S$ ring is nonzero by
the above and Lemma \ref{lemma-in-image}.
If the characteristic of $\kappa(\mathfrak p)$ is zero
then we see that $nx \in R$ implies $1 \otimes x$ is in the image
of $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_R S$.
Hence $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_R S$
is an isomorphism.
If the characteristic of $\kappa(\mathfrak p)$ is $p > 0$,
then write $n = p^k m$ with $m$ prime to $p$.
In $\kappa(\mathfrak p) \otimes_R S[T]$ we have
$$
(T - 1 \otimes x)^n = ((T - 1 \otimes x)^{p^k})^m =
(T^{p^k} - 1 \otimes x^{p^k})^m
$$
and we see that $mx^{p^k} \in R$. This implies that
$1 \otimes x^{p^k}$ is in the image of
$\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_R S$.
Hence Lemma \ref{lemma-p-ring-map} applies to
$\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_R S$.
In both cases we conclude that $\kappa(\mathfrak p) \otimes_R S$
has a unique prime ideal with residue field purely inseparable
over $\kappa(\mathfrak p)$. By Remark \ref{remark-fundamental-diagram}
we conclude that $\varphi$ is bijective on spectra.

\medskip\noindent
The statement on base change is immediate.
\end{proof}











\section{Geometrically irreducible algebras}
\label{section-algebras-over-fields}

\noindent
An algebra $S$ over a field $k$ is geometrically irreducible if
the algebra $S \otimes_k k'$ has a unique minimal prime for
every field extension $k'/k$. In this section we develop a bit
of theory relevant to this notion.

\begin{lemma}
\label{lemma-flat-fibres-irreducible}
Let $R \to S$ be a ring map. Assume
\begin{enumerate}
\item[(a)] $\Spec(R)$ is irreducible,
\item[(b)] $R \to S$ is flat,
\item[(c)] $R \to S$ is of finite presentation,
\item[(d)] the fibre rings $S \otimes_R \kappa(\mathfrak p)$
have irreducible spectra for a dense collection of primes $\mathfrak p$ of $R$.
\end{enumerate}
Then $\Spec(S)$ is irreducible.
This is true more generally with (b) $+$ (c)
replaced by ``the map $\Spec(S) \to \Spec(R)$ is open''.
\end{lemma}

\begin{proof}
The assumptions (b) and (c) imply that the map on spectra is open,
see
Proposition \ref{proposition-fppf-open}.
Hence the lemma follows from
Topology, Lemma \ref{topology-lemma-irreducible-on-top}.
\end{proof}

\begin{lemma}
\label{lemma-separably-closed-irreducible}
Let $k$ be a separably algebraically closed field.
Let $R$, $S$ be $k$-algebras. If $R$, $S$ have a unique
minimal prime, so does $R \otimes_k S$.
\end{lemma}

\begin{proof}
Let $k \subset \overline{k}$ be a perfect closure, see
Definition \ref{definition-perfection}.
By assumption $\overline{k}$ is algebraically closed.
The ring maps $R \to R \otimes_k \overline{k}$ and
$S \to S \otimes_k \overline{k}$ and
$R \otimes_k S \to (R \otimes_k S) \otimes_k \overline{k}
= (R \otimes_k \overline{k}) \otimes_{\overline{k}} (S \otimes_k \overline{k})$
satisfy the assumptions of Lemma \ref{lemma-p-ring-map}.
Hence we may assume $k$ is algebraically closed.

\medskip\noindent
We may replace $R$ and $S$ by their reductions.
Hence we may assume that $R$ and $S$ are domains.
By Lemma \ref{lemma-perfect-reduced} we see that $R \otimes_k S$ is
reduced. Hence its spectrum is reducible if and only if it contains a nonzero
zerodivisor. By Lemma \ref{lemma-limit-argument} we reduce to the case where
$R$ and $S$ are domains of finite type over $k$ algebraically closed.

\medskip\noindent
Note that the ring map $R \to R \otimes_k S$ is of finite
presentation and flat. Moreover, for every maximal ideal
$\mathfrak m$ of $R$ we have
$(R \otimes_k S) \otimes_R R/\mathfrak m \cong S$ because
$k \cong R/\mathfrak m$ by the Hilbert Nullstellensatz Theorem
\ref{theorem-nullstellensatz}. Moreover, the set of
maximal ideals is dense in the spectrum of $R$ since
$\Spec(R)$ is Jacobson, see Lemma \ref{lemma-finite-type-field-Jacobson}.
Hence we see that Lemma \ref{lemma-flat-fibres-irreducible} applies
to the ring map $R \to R \otimes_k S$ and we conclude that
the spectrum of $R \otimes_k S$ is irreducible as desired.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-irreducible}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
The following are equivalent
\begin{enumerate}
\item for every field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is irreducible, and
\item for every finite separable field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is irreducible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $k \subset k^{perf}$ be a perfect closure of $k$, see
Definition \ref{definition-perfection}.
By Lemma \ref{lemma-p-ring-map} we may replace $R$
by $(R \otimes_k k^{perf})_{reduction}$
and $k$ by $k^{perf}$ (some details omitted). Hence
we may assume that $R$ is geometrically reduced over $k$.

\medskip\noindent
Assume $R$ is geometrically reduced over $k$.
For any extension of fields $k \subset k'$ we see
irreducibility of the spectrum of $R \otimes_k k'$
is equivalent to $R \otimes_k k'$ being a domain. Assume (2).
Let $k \subset \overline{k}$ be a separable algebraic closure of $k$.
Using Lemma \ref{lemma-limit-argument}
we see that (2) is equivalent to $R \otimes_k \overline{k}$ being a domain.
For any field extension $k \subset k'$, there exists a field
extension $\overline{k} \subset \overline{k}'$ with
$k' \subset \overline{k}'$. By Lemma \ref{lemma-separably-closed-irreducible}
we see that $R \otimes_k \overline{k}'$ is a domain.
If $R \otimes_k k'$ is not a domain,
then also $R \otimes_k \overline{k}'$ is not a domain, contradiction.
\end{proof}

\begin{definition}
\label{definition-geometrically-irreducible}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically irreducible over $k$}
if for every field extension $k \subset k'$ the spectrum of
$S \otimes_k k'$ is irreducible\footnote{An irreducible space is nonempty.}.
\end{definition}

\noindent
By Lemma \ref{lemma-geometrically-irreducible} it suffices
to check this for finite separable field extensions $k \subset k'$.

\begin{lemma}
\label{lemma-separably-closed-irreducible-implies-geometric}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
If $k$ is separably algebraically closed then $R$ is
geometrically irreducible over $k$ if and only if the
spectrum of $R$ is irreducible.
\end{lemma}

\begin{proof}
Immediate from the remark following
Definition \ref{definition-geometrically-irreducible}.
\end{proof}

\begin{lemma}
\label{lemma-subalgebra-geometrically-irreducible}
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically irreducible over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically irreducible, then $S$ is geometrically irreducible.
\item A directed colimit of geometrically irreducible $k$-algebras
is geometrically irreducible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S' \subset S$ be a subalgebra. Then for any extension $k \subset k'$
the ring map $S' \otimes_k k' \to S \otimes_k k'$ is injective also.
Hence (1) follows from Lemma \ref{lemma-injective-minimal-primes-in-image}
(and the fact that the image of an irreducible space under a continuous
map is irreducible). The second and third property follow from the fact
that tensor product commutes with colimits.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-irreducible-any-base-change}
Let $k$ be a field.
Let $S$ be a geometrically irreducible $k$-algebra.
Let $R$ be any $k$-algebra.
The map
$$
\Spec(R \otimes_k S) \longrightarrow \Spec(R)
$$
induces a bijection on irreducible components.
\end{lemma}

\begin{proof}
Recall that irreducible components correspond to minimal primes
(Lemma \ref{lemma-irreducible}).
As $R \to R \otimes_k S$ is flat we see by going down
(Lemma \ref{lemma-flat-going-down}) that
any minimal prime of $R \otimes_k S$ lies over a minimal prime of $R$.
Conversely, if $\mathfrak p \subset R$ is a (minimal) prime then
$$
R \otimes_k S/\mathfrak p(R \otimes_k S)
=
(R/\mathfrak p) \otimes_k S
\subset
f.f.(R/\mathfrak p) \otimes_k S
$$
by flatness of $R \to R \otimes_k S$. The ring
$f.f.(R/\mathfrak p) \otimes_k S$ has irreducible spectrum
by assumption. It follows that
$R \otimes_k S/\mathfrak p(R \otimes_k S)$ has a single minimal
prime (Lemma \ref{lemma-injective-minimal-primes-in-image}).
In other words, the inverse image of the irreducible set
$V(\mathfrak p)$ is irreducible.
Hence the lemma follows.
\end{proof}

\noindent
Let us make some remarks on the notion of geometrically irreducible
field extensions.

\begin{lemma}
\label{lemma-field-extension-geometrically-irreducible}
Let $k \subset K$ be a field extension.
If $k$ is algebraically closed in $K$, then
$K$ is geometrically irreducible over $k$.
\end{lemma}

\begin{proof}
Let $k \subset k'$ be a finite separable extension, say
generated by $\alpha \in k'$ over $k$ (see
Fields, Lemma \ref{fields-lemma-primitive-element}). Let
$P = T^d + a_1 T^{d - 1} + \ldots + a_d \in k[T]$ be the minimal
polynomial of $\alpha$. Then $K \otimes_k k' \cong K[T]/(P)$.
The only way the spectrum of $K[T]/(P)$ can be reducible
is if $P$ is reducible in $K[T]$. Say $P = P_1P_2$ is
a nontrivial factorization of $P$ into monic polynomials.
Let $b_1, \ldots, b_t \in K$ be the coefficients of $P_1$.
Then we see that $b_i$ is algebraic over $k$ by
Lemma \ref{lemma-polynomials-divide}. Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-make-geometrically-irreducible}
Let $k \subset K$ be a field extension.
Consider the subextension $k \subset k' \subset K$
such that $k \subset k'$ is separable algebraic and
$k' \subset K$ maximal with this property.
Then $K$ is geometrically irreducible over $k'$.
If $K/k$ is a finitely generated field extension, then
$[k' : k] < \infty$.
\end{lemma}

\begin{proof}
Let $k'' \subset K$ be the algebraic closure of $k$ in $K$.
By Lemma \ref{lemma-field-extension-geometrically-irreducible}
we see that $K$ is geometrically irreducible over $k''$.
Since $k' \subset k''$ is purely inseparable
(Fields, Lemma \ref{fields-lemma-separable-first})
we see from Lemma \ref{lemma-p-ring-map} that the extension
$k' \subset K$ is also geometrically irreducible.
If $k \subset K$ is finitely generated, then $k'$ is finite
over $k$ by
Fields, Lemma \ref{fields-lemma-algebraic-closure-in-finitely-generated}.
\end{proof}

\begin{lemma}
\label{lemma-Galois-orbit}
Let $k \subset K$ be an extension of fields.
Let $k \subset \overline{k}$ be a separable algebraic closure.
Then $\text{Gal}(\overline{k}/k)$ acts transitively on the
primes of $\overline{k} \otimes_k K$.
\end{lemma}

\begin{proof}
Let $k \subset k' \subset K$ be the subextension found in
Lemma \ref{lemma-make-geometrically-irreducible}.
Note that as $k \subset \overline{k}$ is integral all the prime ideals
of $\overline{k} \otimes_k K$ and $\overline{k} \otimes_k k'$ are maximal, see
Lemma \ref{lemma-integral-no-inclusion}.
By Lemma \ref{lemma-geometrically-irreducible-any-base-change}
the map
$$
\Spec(\overline{k} \otimes_k K) \to \Spec(\overline{k} \otimes_k k')
$$
is bijective because (1) all primes are minimal primes, (1)
$\overline{k} \otimes_k K = (\overline{k} \otimes_k k') \otimes_{k'} K$,
and (3) $K$ is geometrically irreducible over $k'$.
Hence it suffices to prove the lemma for the action of
$\text{Gal}(\overline{k}/k)$ on the primes of $\overline{k} \otimes_k k'$.

\medskip\noindent
As every prime of $\overline{k} \otimes_k k'$ is maximal, the residue fields
are isomorphic to $\overline{k}$. Hence the prime ideals of
$\overline{k} \otimes_k k'$ correspond one to one to elements of
$\Hom_k(k', \overline{k})$ with $\sigma \in \Hom_k(k', \overline{k})$
corresponding to the kernel $\mathfrak p_\sigma$ of
$1 \otimes \sigma : \overline{k} \otimes_k k' \to \overline{k}$.
In particular $\text{Gal}(\overline{k}/k)$ acts transitively on
this set as desired.
\end{proof}




\section{Geometrically connected algebras}
\label{section-geometrically-connected}

\begin{lemma}
\label{lemma-separably-closed-connected}
Let $k$ be a separably algebraically closed field.
Let $R$, $S$ be $k$-algebras. If $\Spec(R)$, and
$\Spec(S)$ are connected, then so is
$\Spec(R \otimes_k S)$.
\end{lemma}

\begin{proof}
Recall that $\Spec(R)$ is connected if and only if
$R$ has no nontrivial idempotents, see
Lemma \ref{lemma-characterize-spec-connected}.
Hence, by Lemma \ref{lemma-limit-argument} we may assume $R$ and $S$ are of
finite type over $k$.
In this case $R$ and $S$ are Noetherian,
and have finitely many minimal primes, see
Lemma \ref{lemma-Noetherian-irreducible-components}.
Thus we may argue by induction on $n + m$ where $n$, resp.\ $m$
is the number of irreducible components of $\Spec(R)$,
resp.\ $\Spec(S)$. Of course the case where either $n$ or
$m$ is zero is trivial. If $n = m = 1$, i.e.,
$\Spec(R)$ and $\Spec(S)$ both have one irreducible component,
then the result holds by Lemma \ref{lemma-separably-closed-irreducible}.
Suppose that $n > 1$. Let $\mathfrak p \subset R$ be a minimal prime
corresponding to the irreducible closed subset $T \subset \Spec(R)$.
Let $I \subset R$ be such that $T' = V(I) \subset \Spec(R)$
is the closure of the complement of $T$. Note that this means
that $T' = \Spec(R/I)$ (Lemma \ref{lemma-spec-closed}) has $n - 1$
irreducible components. Then $T \cup T' = \Spec(R)$,
and $T \cap T' = V(\mathfrak p + I) = \Spec(R/(\mathfrak p + I))$
is not empty as $\Spec(R)$ is assumed connected.
The inverse image of $T$ in $\Spec(R \otimes_k S)$
is $\Spec(R/\mathfrak p \otimes_k S)$, and the inverse
of $T'$ in $\Spec(R \otimes_k S)$
is $\Spec(R/I \otimes_k S)$. By induction these are both
connected. The inverse image of $T \cap T'$ is
$\Spec(R/(\mathfrak p + I) \otimes_k S)$ which is nonempty.
Hence $\Spec(R \otimes_k S)$ is connected.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-connected}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
The following are equivalent
\begin{enumerate}
\item for every field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is connected, and
\item for every finite separable field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is connected.
\end{enumerate}
\end{lemma}

\begin{proof}
For any extension of fields $k \subset k'$ the connectivity
of the spectrum of $R \otimes_k k'$ is equivalent to $R \otimes_k k'$
having no nontrivial idempotents, see
Lemma \ref{lemma-characterize-spec-connected}. Assume (2).
Let $k \subset \overline{k}$ be a separable algebraic closure of $k$.
Using Lemma \ref{lemma-limit-argument}
we see that (2) is equivalent to $R \otimes_k \overline{k}$
having no nontrivial idempotents.
For any field extension $k \subset k'$, there exists a field
extension $\overline{k} \subset \overline{k}'$ with
$k' \subset \overline{k}'$. By Lemma \ref{lemma-separably-closed-connected}
we see that $R \otimes_k \overline{k}'$ has no nontrivial idempotents.
If $R \otimes_k k'$ has a nontrivial idempotent,
then also $R \otimes_k \overline{k}'$, contradiction.
\end{proof}

\begin{definition}
\label{definition-geometrically-connected}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically connected over $k$}
if for every field extension $k \subset k'$ the spectrum
of $S \otimes_k k'$ is connected.
\end{definition}

\noindent
By Lemma \ref{lemma-geometrically-connected} it suffices
to check this for finite separable field extensions $k \subset k'$.

\begin{lemma}
\label{lemma-separably-closed-connected-implies-geometric}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
If $k$ is separably algebraically closed then $R$ is
geometrically connected over $k$ if and only if the
spectrum of $R$ is connected.
\end{lemma}

\begin{proof}
Immediate from the remark following
Definition \ref{definition-geometrically-connected}.
\end{proof}

\begin{lemma}
\label{lemma-subalgebra-geometrically-connected}
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically connected over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically connected, then $S$ is geometrically connected.
\item A directed colimit of geometrically connected $k$-algebras
is geometrically connected.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from the characterization of connectedness in terms of the
nonexistence of nontrivial idempotents. The second and third property follow
from the fact that tensor product commutes with colimits.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Varieties, Lemma \ref{varieties-lemma-bijection-connected-components}.

\begin{lemma}
\label{lemma-geometrically-connected-any-base-change}
Let $k$ be a field.
Let $S$ be a geometrically connected $k$-algebra.
Let $R$ be any $k$-algebra.
The map
$$
R \longrightarrow R \otimes_k S
$$
induces a bijection on idempotents, and the map
$$
\Spec(R \otimes_k S) \longrightarrow \Spec(R)
$$
induces a bijection on connected components.
\end{lemma}

\begin{proof}
The second assertion follows from the first combined with
Lemma \ref{lemma-connected-component}.
By Lemmas \ref{lemma-subalgebra-geometrically-connected}
and \ref{lemma-limit-argument} we may assume that $R$ and $S$
are of finite type over $k$. Then we see that also
$R \otimes_k S$ is of finite type over $k$. Note that in this
case all the rings are Noetherian and hence their spectra
have finitely many connected components (since they have
finitely many irreducible components, see
Lemma \ref{lemma-Noetherian-irreducible-components}).
In particular, all connected components in question are open!
Hence via Lemma \ref{lemma-disjoint-implies-product}
we see that the first statement of the
lemma in this case is equivalent to the second. Let's prove this.
As the algebra $S$ is geometrically connected
and nonzero we see that all fibres of $X = \Spec(R \otimes_k S)
\to \Spec(R) = Y$ are connected and nonempty. Also, as
$R \to R \otimes_k S$ is flat of finite presentation the map
$X \to Y$ is open
(Proposition \ref{proposition-fppf-open}).
Topology, Lemma \ref{topology-lemma-connected-fibres-connected-components}
shows that $X \to Y$ induces bijection on connected components.
\end{proof}




\section{Geometrically integral algebras}
\label{section-geometrically-integral}


\begin{definition}
\label{definition-geometrically-integral}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically integral over $k$}
if for every field extension $k \subset k'$ the ring
of $S \otimes_k k'$ is a domain.
\end{definition}

\noindent
Any question about geometrically integral algebras can be translated
in a question about geometrically reduced and irreducible algebras.

\begin{lemma}
\label{lemma-geometrically-integral}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
In this case $S$ is geometrically integral over $k$ if and only if
$S$ is geometrically irreducible as well as geometrically reduced over $k$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-integral-any-integral-base-change}
Let $k$ be a field. Let $S$ be a geometrically integral $k$-algebra.
Let $R$ be a $k$-algebra and an integral domain. Then $R \otimes_k S$
is an integral domain.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-geometrically-reduced-any-reduced-base-change}
the ring $R \otimes_k S$ is reduced and by
Lemma \ref{lemma-geometrically-irreducible-any-base-change}
the ring $R \otimes_k S$ is irreducible (the spectrum
has just one irreducible component), so $R \otimes_k S$ is
an integral domain.
\end{proof}





\section{Valuation rings}
\label{section-valuation-rings}

\noindent
Here are some definitions.

\begin{definition}
\label{definition-valuation-ring}
Valuation rings.
\begin{enumerate}
\item Let $K$ be a field. Let $A$, $B$ be local rings contained
in $K$. We say that $B$ {\it dominates} $A$ if $A \subset B$
and $\mathfrak m_A = A \cap \mathfrak m_B$.
\item Let $A$ be a ring. We say $A$ is a {\it valuation ring}
if $A$ is a local domain and if $A$ is maximal
for the relation of domination among local rings contained in
the fraction field of $A$.
\item Let $A$ be a valuation ring with fraction field $K$.
If $R \subset K$ is a subring of $K$, then we say $A$
is {\it centered} on $R$ if $R \subset A$.
\end{enumerate}
\end{definition}

\noindent
With this definition a field is a valuation ring.

\begin{lemma}
\label{lemma-dominate}
Let $K$ be a field. Let $A \subset K$ be a local subring.
Then there exists a valuation ring with fraction field $K$
dominating $A$.
\end{lemma}

\begin{proof}
We consider the collection of local subrings
of $K$ as a partially ordered set using the relation of domination.
Suppose that $\{A_i\}_{i \in I}$ is a totally ordered
collection of local subrings of $K$. Then $B = \bigcup A_i$
is a local subring which dominates all of the $A_i$.
Hence by Zorn's Lemma, it suffices to show that if $A \subset K$
is a local ring whose fraction field is not $K$, then there
exists a local ring $B \subset K$, $B \not = A$ dominating $A$.

\medskip\noindent
Pick $t \in K$ which is not in the fraction field of $A$.
If $t$ is transcendental over $A$, then $A[t] \subset K$
and hence $A[t]_{(t, \mathfrak m)} \subset K$ is a local ring
distinct from $A$ dominating $A$. Suppose $t$ is algebraic over $A$.
Then for some $a \in A$ the element $at$ is integral over $A$.
In this case the subring $A' \subset K$ generated by $A$ and
$ta$ is finite over $A$.
By Lemma \ref{lemma-integral-overring-surjective} there exists
a prime ideal $\mathfrak m' \subset A'$ lying over
$\mathfrak m$. Then $A'_{\mathfrak m'}$ dominates
$A$. If $A = A'_{\mathfrak m'}$, then $t$
is in the fraction field of $A$ which we assumed not to be the case.
Thus $A \not = A'_{\mathfrak m'}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-x-or-x-inverse}
Let $A$ be a valuation ring with maximal ideal $\mathfrak m$ and
fraction field $K$.
Let $x \in K$. Then either $x \in A$ or $x^{-1} \in A$ or both.
\end{lemma}

\begin{proof}
Assume that $x$ is not in $A$.
Let $A'$ denote the subring of $K$ generated by $A$ and $x$.
Since $A$ is a valuation ring we see that there is no prime
of $A'$ lying over $\mathfrak m$. Hence we can write
$1 = \sum_{i = 0}^d t_i x^i$ with $t_i \in \mathfrak m$.
This implies that $(1 - t_0) (x^{-1})^d - \sum t_i (x^{-1})^{d - i} = 0$.
In particular we see that $x^{-1}$ is integral over $A$.
Thus the subring $A''$ of $K$ generated by $A$ and $x^{-1}$ is
finite over $A$ and we see there exists a prime ideal
$\mathfrak m'' \subset A''$ lying over $\mathfrak m$ by
Lemma \ref{lemma-integral-overring-surjective}. Since $A$
is a valuation ring we conclude that $A = (A'')_{\mathfrak m''}$
and hence $x^{-1} \in A$.
\end{proof}

\begin{lemma}
\label{lemma-x-or-x-inverse-valuation-ring}
Let $A \subset K$ be a subring of a field $K$ such that for all
$x \in K$ either $x \in A$ or $x^{-1} \in A$ or both.
Then $A$ is a valuation ring with fraction field $K$.
\end{lemma}

\begin{proof}
If $A$ is not $K$, then $A$ is not a field and there is a nonzero
maximal ideal $\mathfrak m$.
If $\mathfrak m'$ is a second maximal ideal, then choose $x, y \in A$
with $x \in \mathfrak m$, $y \not \in \mathfrak m$,
$x \not \in \mathfrak m'$, and $y \in \mathfrak m'$ (see
Lemma \ref{lemma-silly}). Then neither $x/y \in A$ nor $y/x \in A$
contradicting the assumption of the lemma. Thus we see that $A$ is
a local ring. Suppose that $A'$ is a local ring contained in $K$ which
dominates $A$. Let $x \in A'$. We have to show that $x \in A$. If not, then
$x^{-1} \in A$, and of course $x^{-1} \in \mathfrak m_A$. But then
$x^{-1} \in \mathfrak m_{A'}$ which contradicts $x \in A'$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-valuation-rings}
Let $I$ be a directed set. Let $(A_i, \varphi_{ij})$
be a system of valuation rings over $I$ whose transition maps
$\varphi_{ij}$ are local. Then $A = \colim A_i$ is a valuation ring.
\end{lemma}

\begin{proof}
It is clear that $A$ is a domain. Let $a, b \in A$.
Lemma \ref{lemma-x-or-x-inverse-valuation-ring} tells us we have
to show that either $a | b$ or $b | a$ in $A$. Choose $i$
so large that there exist $a_i, b_i \in A_i$ mapping to $a, b$.
Then Lemma \ref{lemma-valuation-ring-x-or-x-inverse}
applied to $a_i, b_i$ in $A_i$ implies the result for $a, b$ in $A$.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-cap-field}
Let $K \subset L$ be an extension of fields. If $B \subset L$
is a valuation ring, then $A = K \cap B$ is a valuation ring.
\end{lemma}

\begin{proof}
We can replace $L$ by $f.f.(B)$ and $K$ by $K \cap f.f.(B)$.
Then the lemma follows from a combination of
Lemmas \ref{lemma-valuation-ring-x-or-x-inverse} and
\ref{lemma-x-or-x-inverse-valuation-ring}.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-cap-field-finite}
Let $K \subset L$ be an algebraic extension of fields. If $B \subset L$
is a valuation ring with fraction field $L$ and not a field, then
$A = K \cap B$ is a valuation ring and not a field.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-valuation-ring-cap-field} the ring $A$ is a valuation
ring. If $A$ is a field, then $A = K$. Then $A = K \subset B$ is an integral
extension, hence there are no proper inclusions among the primes of $B$
(Lemma \ref{lemma-integral-no-inclusion}).
This contradicts the assumption that $B$ is a local domain and not a field.
\end{proof}

\begin{lemma}
\label{lemma-make-valuation-rings}
Let $A$ be a valuation ring. For any prime ideal $\mathfrak p \subset A$ the
quotient $A/\mathfrak p$ is a valuation ring. The same is true for the
localization $A_\mathfrak p$ and in fact any localization of $A$.
\end{lemma}

\begin{proof}
Use the characterization of valuation rings given
in Lemma \ref{lemma-x-or-x-inverse-valuation-ring}.
\end{proof}

\begin{lemma}
\label{lemma-stack-valuation-rings}
Let $A'$ be a valuation ring with residue field $K$.
Let $A$ be a valuation ring with fraction field $K$.
Then
$C = \{\lambda \in A' \mid \lambda \bmod \mathfrak m_{A'} \in A\}$
is a valuation ring.
\end{lemma}

\begin{proof}
Note that $\mathfrak m_{A'} \subset C$ and $C/\mathfrak m_{A'} = A$.
In particular, the fraction field of $C$ is equal to the fraction field
of $A'$. We will use the criterion of
Lemma \ref{lemma-x-or-x-inverse-valuation-ring} to prove the lemma.
Let $x$ be an element of the fraction field of $C$.
By the lemma we may assume $x \in A'$. If $x \in \mathfrak m_{A'}$,
then we see $x \in C$. If not, then $x$ is a unit of $A'$ and we
also have $x^{-1} \in A'$. Hence either $x$ or $x^{-1}$ maps to
an element of $A$ by the lemma again.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-normal}
Let $A$ be a valuation ring.
Then $A$ is a normal domain.
\end{lemma}

\begin{proof}
Suppose $x$ is in the field of fractions of $A$ and integral over $A$,
say $x^{d + 1} + \sum_{i \leq d} a_i x^i = 0$. By
Lemma \ref{lemma-x-or-x-inverse-valuation-ring}
either $x \in A$ (and we're done) or $x^{-1} \in A$. In the second case
we see that $x = - \sum a_i x^{i - d} \in A$ as well.
\end{proof}

\begin{lemma}
\label{lemma-find-valuation-rings}
Let $A$ be a normal domain with fraction field $K$.
For every $x \in K$, $x \not \in A$ there exists a
valuation ring $A \subset V \subset K$ with fraction field $K$
such that $x \not \in V$. In other words, $A$ is the intersection
of all valuation rings in $K$ containing $A$.
\end{lemma}

\begin{proof}
Suppose $x \in K$, $x \not \in A$. Consider $B = A[x^{-1}]$.
Then $x \not \in B$. Namely, if $x = a_0 + a_1x^{-1} + \ldots + a_d x^{-d}$
then $x^{d + 1} - a_0x^d - \ldots - a_d = 0$ and $x$ is integral
over $A$ in contradiction with the fact that $A$ is normal.
Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \subset \Spec(B)$
is not empty (Lemma \ref{lemma-Zariski-topology}), and we can choose a prime
$\mathfrak p \subset B$ with $x^{-1} \in \mathfrak p$.
Choose a valuation ring $V \subset K$ dominating $B_\mathfrak p$
(Lemma \ref{lemma-dominate}).
Then $x \not \in V$ as $x^{-1} \in \mathfrak m_V$.
\end{proof}

\noindent
An {\it totally ordered abelian group} is a pair $(\Gamma, \geq)$
consisting of an abelian group $\Gamma$ endowed with a total
ordering $\geq$ such that $\gamma \geq \gamma' \Rightarrow
\gamma + \gamma'' \geq \gamma' + \gamma''$ for all
$\gamma, \gamma', \gamma'' \in \Gamma$.

\begin{lemma}
\label{lemma-valuation-group}
Let $A$ be a valuation ring with field of fractions $K$.
Set $\Gamma = K^*/A^*$ (with group law written additively).
For $\gamma, \gamma' \in \Gamma$
define $\gamma \geq \gamma'$ if and only if
$\gamma - \gamma'$ is in the image of $A - \{0\} \to \Gamma$.
Then $(\Gamma, \geq)$ is a totally ordered abelian group.
\end{lemma}

\begin{proof}
Omitted, but follows easily from
Lemma \ref{lemma-valuation-ring-x-or-x-inverse}.
Note that in case $A = K$ we obtain the zero group $\Gamma = \{0\}$
endowed with its unique total ordering.
\end{proof}

\begin{definition}
\label{definition-value-group}
Let $A$ be a valuation ring.
\begin{enumerate}
\item The totally ordered abelian group $(\Gamma, \geq)$ of
Lemma \ref{lemma-valuation-group} is called the
{\it value group} of the valuation ring $A$.
\item The map $v : A - \{0\} \to \Gamma$ and also $v : K^* \to \Gamma$ is
called the {\it valuation} associated to $A$.
\item The valuation ring $A$ is called a {\it discrete valuation ring}
if $\Gamma \cong \mathbf{Z}$.
\end{enumerate}
\end{definition}

\noindent
Note that if $\Gamma \cong \mathbf{Z}$ then there is a unique such
isomorphism such that $1 \geq 0$. If the isomorphism is chosen in this
way, then the ordering becomes the usual ordering of the integers.

\begin{lemma}
\label{lemma-properties-valuation}
Let $A$ be a valuation ring. The valuation $v : A -\{0\} \to \Gamma_{\geq 0}$
has the following properties:
\begin{enumerate}
\item $v(a) = 0 \Leftrightarrow a \in A^*$,
\item $v(ab) = v(a) + v(b)$,
\item $v(a + b) \geq \text{min}(v(a), v(b))$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-valuation-ring}
Let $A$ be a ring. The following are equivalent
\begin{enumerate}
\item $A$ is a valuation ring,
\item $A$ is a local domain and every finitely generated
ideal of $A$ is principal.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $A$ is a valuation ring and let $f_1, \ldots, f_n \in A$.
Choose $i$ such that $v(f_i)$ is minimal among $v(f_j)$.
Then $(f_i) = (f_1, \ldots, f_n)$. Conversely, assume $A$ is
a local domain and every finitely generated ideal of $A$ is principal.
Pick $f, g \in A$ and write $(f, g) = (h)$. Then $f = ah$ and $g = bh$
and $h = cf + dg$ for some $a, b, c, d \in A$. Thus $ac + bd = 1$
and we see that either $a$ or $b$ is a unit, i.e., either
$g/f$ or $f/g$ is an element of $A$. This shows $A$ is a valuation ring
by Lemma \ref{lemma-x-or-x-inverse-valuation-ring}.
\end{proof}

\begin{lemma}
\label{lemma-valuation-valuation-ring}
Let $(\Gamma, \geq)$ be a totally ordered abelian group.
Let $K$ be a field. Let $v : K^* \to \Gamma$ be a homomorphism
of abelian groups such that $v(a + b) \geq \min(v(a), v(b))$ for
$a, b \in K$ with $a, b, a + b$ not zero. Then
$$
A =
\{
x \in K \mid x = 0 \text{ or } v(x) \geq 0
\}
$$
is a valuation ring with value group $\Im(v) \subset \Gamma$,
with maximal ideal
$$
\mathfrak m =
\{
x \in K \mid x = 0 \text{ or } v(x) > 0
\}
$$
and with group of units
$$
A^* =
\{
x \in K^* \mid v(x) = 0
\}.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Let $(\Gamma, \geq)$ be a totally ordered abelian group.
An {\it ideal of $\Gamma$} is a subset $I \subset \Gamma$ such
that all elements of $I$ are $\geq 0$ and $\gamma \in I$,
$\gamma' \geq \gamma$ implies $\gamma' \in I$. We say that such
an ideal is {\it prime} if $\gamma + \gamma' \in I, \gamma, \gamma' \geq 0
\Rightarrow \gamma \in I \text{ or } \gamma' \in I$.

\begin{lemma}
\label{lemma-ideals-valuation-ring}
Let $A$ be a valuation ring.
Ideals in $A$ correspond $1 - 1$ with ideals of $\Gamma$.
This bijection is inclusion preserving, and maps prime
ideals to prime ideals.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-Noetherian-discrete}
A valuation ring is Noetherian if and only if it is
a discrete valuation ring or a field.
\end{lemma}

\begin{proof}
Suppose $A$ is a discrete valuation ring
with valuation $v : A \setminus \{0\} \to \mathbf{Z}$
normalized so that $\Im(v) \subset \mathbf{Z}_{\geq 0}$.
By Lemma \ref{lemma-ideals-valuation-ring} the ideals of $A$ are the subsets
$I_n = \{0\} \cup v^{-1}(\mathbf{Z}_{\geq n})$. It is clear
that any element $x \in A$ with $v(x) = n$ generates $I_n$.
Hence $A$ is a PID so certainly Noetherian.

\medskip\noindent
Suppose $A$ is a Noetherian valuation ring with value group $\Gamma$.
By Lemma \ref{lemma-ideals-valuation-ring} we see the ascending chain
condition holds for ideals in $\Gamma$.
We may assume $A$ is not a field, i.e., there is a $\gamma \in \Gamma$
with $\gamma > 0$. Applying the ascending chain condition to the subsets
$\gamma + \Gamma_{\geq 0}$ with $\gamma > 0$ we see
there exists a smallest element $\gamma_0$ which is bigger than $0$.
Let $\gamma \in \Gamma$ be an element $\gamma > 0$. Consider the sequence
of elements $\gamma$, $\gamma - \gamma_0$, $\gamma - 2\gamma_0$,
etc. By the ascending chain condition these cannot all be $> 0$.
Let $\gamma - n \gamma_0$ be the last one $\geq 0$. By minimality
of $\gamma_0$ we see that $0 = \gamma - n \gamma_0$. Hence $\Gamma$
is a cyclic group as desired.
\end{proof}























\section{More Noetherian rings}
\label{section-Noetherian-again}


\begin{lemma}
\label{lemma-Noetherian-basic}
Let $R$ be a Noetherian ring.
Any finite $R$-module is of finite presentation.
Any submodule of a finite $R$-module is finite.
The ascending chain condition holds for $R$-submodules
of a finite $R$-module.
\end{lemma}

\begin{proof}
We first show that any submodule $N$ of a finite $R$-module
$M$ is finite. We do this by induction on the number of
generators of $M$. If this number is $1$, then $N = J/I \subset
M = R/I$ for some ideals $I \subset J \subset R$. Thus the definition
of Noetherian implies the result. If the number of generators of
$M$ is greater than $1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ where $M'$ and $M''$ have fewer
generators. Note that setting $N' = M' \cap N$ and $N'' = \Im(N \to
M'')$ gives a similar short exact sequence for $N$. Hence the result
follows from the induction hypothesis
since the number of generators of $N$ is at most the number of
generators of $N'$ plus the number of generators of $N''$.

\medskip\noindent
To show that $M$ is finitely presented just apply the previous result
to the kernel of a presentation $R^n \to M$.

\medskip\noindent
It is well known and easy to prove that the ascending chain condition for
$R$-submodules of $M$ is equivalent to the condition that every submodule
of $M$ is a finite $R$-module. We omit the proof.
\end{proof}

\begin{lemma}[Artin-Rees]
\label{lemma-Artin-Rees}
Suppose that $R$ is Noetherian, $I \subset R$ an ideal.
Let $N \subset M$ be finite $R$-modules.
There exists a constant $c > 0$ such that
$I^n M \cap N  =  I^{n-c}(I^cM \cap N)$ for all $n \geq c$.
\end{lemma}

\begin{proof}
Consider the ring $S = R \oplus I \oplus I^2 \oplus \ldots
= \bigoplus_{n \geq 0} I^n$. Convention: $I^0 = R$.
Multiplication maps $I^n \times I^m$
into $I^{n + m}$ by multiplication in $R$.
Note that if $I = (f_1, \ldots, f_t)$
then $S$ is a quotient of the Noetherian ring $R[X_1, \ldots, X_t]$.
The map just sends the monomial $X_1^{e_1}\ldots X_t^{e_t}$
to $f_1^{e_1}\ldots f_t^{e_t}$. Thus $S$ is Noetherian.
Similarly, consider the module $M \oplus IM \oplus I^2M \oplus \ldots
= \bigoplus_{n \geq 0} I^nM$. This is a finitely generated $S$-module.
Namely, if $x_1, \ldots, x_r$ generate $M$ over $R$, then they also generate
$\bigoplus_{n \geq 0} I^nM$ over $S$. Next, consider the
submodule $\bigoplus_{n \geq 0} I^nM \cap N$.
This is an $S$-submodule, as is easily verified. By
Lemma \ref{lemma-Noetherian-basic} it is finitely generated as
an $S$-module,
say by $\xi_j \in \bigoplus_{n \geq 0} I^nM \cap N$, $j = 1, \ldots, s$.
We may assume by decomposing each $\xi_j$ into its homogeneous
pieces that each $\xi_j \in I^{d_j}M \cap N$ for some $d_j$.
Set $c = \max\{d_j\}$. Then for all $n \geq c$ every element
in $I^nM \cap N$ is of the form $\sum h_j \xi_j$ with
$h_j \in I^{n - d_j}$. The lemma now follows from this and the trivial
observation that $I^{n-d_j}(I^{d_j}M \cap N) \subset I^{n-c}(I^cM \cap N)$.
\end{proof}

\begin{lemma}
\label{lemma-map-AR}
Suppose that $0 \to K \to M \xrightarrow{f} N$ is an
exact sequence of finitely generated modules
over a Noetherian ring $R$. Let $I \subset R$ be an ideal.
Then there exists a $c$ such that
$$
f^{-1}(I^nN) = K + I^{n-c}f^{-1}(I^cN)
\quad\text{and}\quad
f(M) \cap I^nN \subset f(I^{n - c}M)
$$
for all $n \geq c$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-Artin-Rees} to
$\Im(f) \subset N$ and note that
$f : I^{n-c}M \to I^{n-c}f(M)$ is surjective.
\end{proof}

\begin{lemma}[Krull's intersection theorem]
\label{lemma-intersect-powers-ideal-module-zero}
Let $R$ be a Noetherian local ring. Let $I \subset R$ be
a proper ideal. Let $M$ be a finite $R$-module.
Then $\bigcap_{n \geq 0} I^nM = 0$.
\end{lemma}

\begin{proof}
Let $N = \bigcap_{n \geq 0} I^nM$.
Then $N = I^nM \cap N$ for all $n \geq 0$.
By the Artin-Rees Lemma \ref{lemma-Artin-Rees}
we see that $N = I^nM \cap N \subset IN$ for
some suitably large $n$. By Nakayama's Lemma \ref{lemma-NAK}
we see that $N = 0$.
\end{proof}

\begin{lemma}
\label{lemma-intersection-powers-ideal-module}
Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module. Let $N = \bigcap_n I^n M$.
\begin{enumerate}
\item For every prime $\mathfrak p$, $I \subset \mathfrak p$ there
exists a $f \in R$, $f \not \in \mathfrak p$ such that $N_f = 0$.
\item If $I \subset \text{rad}(R)$ is contained in the Jacobson radical
of $R$, then $N = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $x_1, \ldots, x_n$ be generators for the module $N$,
see Lemma \ref{lemma-Noetherian-basic}. For every prime
$\mathfrak p$, $I \subset \mathfrak p$ we see that
the image of $N$ in the localization $M_{\mathfrak p}$
is zero, by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Hence we can find $g_i \in R$, $g_i \not \in \mathfrak p$
such that $x_i$ maps to zero in $N_{g_i}$. Thus
$N_{g_1g_2\ldots g_n} = 0$.

\medskip\noindent
Part (2) follows from (1) and Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{remark}
\label{remark-intersection-powers-ideal}
Lemma \ref{lemma-intersect-powers-ideal-module-zero} in particular implies
that $\bigcap_n I^n = (0)$ when $I \subset R$ is a non-unit ideal in a
Noetherian local ring $R$. More generally, let $R$ be a Noetherian ring and
$I \subset R$ an ideal. Suppose that $f \in \bigcap_{n \in \mathbf{N}} I^n$.
Then Lemma \ref{lemma-intersection-powers-ideal-module}
says that for every prime ideal $I \subset \mathfrak p$
there exists a $g \in R$, $g \not \in \mathfrak p$
such that $f$ maps to zero in $R_g$. In algebraic geometry we
express this by saying that ``$f$ is zero in an open neighbourhood
of the closed set $V(I)$ of $\Spec(R)$''.
\end{remark}

\begin{lemma}[Artin-Tate]
\label{lemma-Artin-Tate}
Let $R$ be a Noetherian ring. Let $S$ be a finitely
generated $R$-algebra. If $T \subset S$ is an $R$-subalgebra such
that $S$ is finitely generated as a $T$-module, then $T$ is a
finite type over $R$.
\end{lemma}

\begin{proof}
Choose elements $x_1, \ldots, x_n \in S$ which generate $S$ as an $R$-algebra.
Choose $y_1, \ldots, y_m$ in $S$ which generate $S$ as a $T$-module.
Thus there exist $a_{ij} \in T$ such that
$x_i = \sum a_{ij} y_j$. There also exist $b_{ijk} \in T$ such
that $y_i y_j = \sum b_{ijk} y_k$. Let $T' \subset T$ be the
sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely
generated $R$-algebra, hence Noetherian. Consider the algebra
$$
S' = T'[Y_1, \ldots, Y_m]/(Y_i Y_j - \sum b_{ijk} Y_k).
$$
Note that $S'$ is finite over $T'$, namely as a $T'$-module it is
generated by the classes of $1, Y_1, \ldots, Y_m$.
Consider the $T'$-algebra homomorphism $S' \to S$ which maps
$Y_i$ to $y_i$. Because $a_{ij} \in T'$ we see that $x_j$ is
in the image of this map. Thus $S' \to S$ is surjective.
Therefore $S$ is finite over $T'$ as well. Since $T'$ is Noetherian
and we conclude that $T \subset S$ is finite over $T'$ and
we win.
\end{proof}






















\section{Length}
\label{section-length}

\begin{definition}
\label{definition-length}
Let $R$ be a ring. For any $R$-module $M$
we define the {\it length} of $M$ over $R$ by the
formula
$$
\text{length}_R(M)
=
\sup
\{
n
\mid
\exists\ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M,
\text{ }M_i \not = M_{i + 1}
\}.
$$
\end{definition}

\noindent
In other words it is the supremum of the lengths of chains
of submodules. There is an obvious notion of when a chain
of submodules is a refinement of another. This gives a
partial ordering on the collection of all chains of submodules,
with the smallest chain having the shape $0 = M_0 \subset M_1 = M$
if $M$ is not zero.
We note the obvious fact that if the length of
$M$ is finite, then every chain can be refined to a
maximal chain. But it is not as obvious that all maximal
chains have the same length (as we will see later).

\begin{lemma}
\label{lemma-finite-length-finite}
\begin{slogan}
Modules of finite length are finite.
\end{slogan}
Let $R$ be a ring.
Let $M$ be an $R$-module.
If $\text{length}_R(M) < \infty$ then $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-length-additive}
If $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of modules over $R$ then
the length of $M$ is the sum of the
lengths of $M'$ and $M''$.
\end{lemma}

\begin{proof}
Given filtrations of $M'$ and $M''$ of lengths $n', n''$
it is easy to make a corresponding filtration of $M$
of length $n' + n''$. Thus we see that $\text{length}_R M
\geq \text{length}_R M' + \text{length}_R M''$.
Conversely, given a filtration
$M_0 \subset M_1 \subset \ldots \subset M_n$ of
$M$ consider the induced filtrations
$M_i' = M_i \cap M'$ and $M_i'' = \Im(M_i \to M'')$.
Let $n'$ (resp.\ $n''$) be the number of steps in the filtration
$\{M'_i\}$ (resp.\ $\{M''_i\}$).
If $M_i' = M_{i + 1}'$ and $M_i'' = M_{i + 1}''$ then
$M_i = M_{i + 1}$. Hence we conclude that $n' + n'' \geq n$.
Combined with the earlier result we win.
\end{proof}

\begin{lemma}
\label{lemma-length-infinite}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is a finite module and
$\mathfrak m^n M \not = 0$ for all $n\geq 0$,
then $\text{length}_R(M) = \infty$.
\item If $M$ has finite length then $\mathfrak m^nM = 0$
for some $n$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $\mathfrak m^n M \not = 0$ for all $n\geq 0$.
Choose $x \in M$ and $f_1, \ldots, f_n \in \mathfrak m$
such that $f_1f_2 \ldots f_n x \not = 0$.
By Nakayama's Lemma \ref{lemma-NAK} the first $n$ steps in the filtration
$$
0 \subset R f_1 \ldots f_n x \subset R f_1 \ldots f_{n - 1} x
\subset \ldots \subset R x \subset M
$$
are distinct. This can also be seen directly. For example, if
$R f_1 x = R f_1 f_2 x$ , then $f_1 x = g f_1 f_2 x$ for some $g$,
hence $(1 - gf_2) f_1 x = 0$ hence $f_1 x = 0$ as $1 - gf_2$ is a unit
which is a contradiction with the choice of $x$ and $f_1, \ldots, f_n$.
Hence the length is infinite, i.e., (1) holds.
Combine (1) and Lemma \ref{lemma-finite-length-finite} to see (2).
\end{proof}

\begin{lemma}
\label{lemma-length-independent}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
We always have $\text{length}_R(M) \geq \text{length}_S(M)$.
If $R \to S$ is surjective then equality holds.
\end{lemma}

\begin{proof}
A filtration of $M$ by $S$-submodules gives rise a filtration
of $M$ by $R$-submodules. This proves the inequality.
And if $R \to S$ is surjective, then any $R$-submodule
of $M$ is automatically an $S$-submodule. Hence equality
in this case.
\end{proof}

\begin{lemma}
\label{lemma-dimension-is-length}
Let $R$ be a ring with maximal ideal $\mathfrak m$.
Suppose that $M$ is an $R$-module with
$\mathfrak m M  =  0$. Then the length of $M$ as
an $R$-module agrees with the dimension of $M$ as
a $R/\mathfrak m$ vector space.
The length is finite if and only if $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
The first part is a special case of Lemma \ref{lemma-length-independent}.
Thus the length is finite if and only if $M$ has a finite basis
as a $R/\mathfrak m$-vector space if and only if $M$ has a finite
set of generators as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-length-localize}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be
a multiplicative subset. Then
$\text{length}_R(M) \geq \text{length}_{S^{-1}R}(S^{-1}M)$.
\end{lemma}

\begin{proof}
Any submodule $N' \subset S^{-1}M$ is of the form
$S^{-1}N$ for some $R$-submodule $N \subset M$, by Lemma
\ref{lemma-submodule-localization}. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-length-finite}
Let $R$ be a ring with finitely generated
maximal ideal $\mathfrak m$. (For example $R$ Noetherian.)
Suppose that $M$ is a finite $R$-module with
$\mathfrak m^n M  =  0$ for some $n$.
Then $\text{length}_R(M) < \infty$.
\end{lemma}

\begin{proof}
Consider the filtration
$0 = \mathfrak m^n M \subset
\mathfrak m^{n-1} M \subset
\ldots \subset \mathfrak m M \subset M$.
All of the subquotients are finitely generated $R$-modules
to which Lemma \ref{lemma-dimension-is-length} applies. We conclude
by additivity, see Lemma \ref{lemma-length-additive}.
\end{proof}

\begin{definition}
\label{definition-simple-module}
Let $R$ be a ring. Let $M$ be an $R$-module.
We say $M$ is {\it simple} if $M \not = 0$ and
every submodule of $M$ is either equal to $M$ or
to $0$.
\end{definition}

\begin{lemma}
\label{lemma-characterize-length-1}
Let $R$ be a ring. Let $M$ be an $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is simple,
\item $\text{length}_R(M) = 1$, and
\item $M \cong R/\mathfrak m$ for some maximal ideal
$\mathfrak m \subset R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak m$ be a maximal ideal of $R$.
By Lemma \ref{lemma-dimension-is-length} the module
$R/\mathfrak m$ has length $1$. The equivalence of
the first two assertions is tautological.
Suppose that $M$ is simple. Choose $x \in M$, $x \not = 0$.
As $M$ is simple we have $M = R \cdot x$.
Let $I \subset R$ be the annihilator of $x$, i.e.,
$I = \{f \in R \mid fx = 0\}$. The map $R/I \to M$,
$f \bmod I \mapsto fx$ is an isomorphism, hence
$R/I$ is a simple $R$-module. Since $R/I \not = 0$ we see $I \not = R$.
Let $I \subset \mathfrak m$ be a maximal ideal containing $I$.
If $I \not = \mathfrak m$, then $\mathfrak m /I \subset R/I$
is a nontrivial submodule contradicting the simplicity
of $R/I$. Hence we see $I = \mathfrak m$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-simple-pieces}
Let $R$ be a ring. Let $M$ be a finite length $R$-module.
Let $\ell = \text{length}_R(M)$. Choose any maximal chain of
submodules
$$
0 = M_0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M
$$
with $M_i \not = M_{i-1}$, $i = 1, \ldots, n$. Then
\begin{enumerate}
\item $n = \ell$,
\item each $M_i/M_{i-1}$ is simple,
\item each $M_i/M_{i-1}$ is of the form
$R/\mathfrak m_i$ for some maximal ideal $\mathfrak m_i$,
\item given a maximal ideal $\mathfrak m \subset R$
we have
$$
\# \{i \mid \mathfrak m_i = \mathfrak m\}
=
\text{length}_{R_{\mathfrak m}} (M_{\mathfrak m}).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
If $M_i/M_{i-1}$ is not simple then we can refine the filtration
and the filtration is not maximal. Thus we see that $M_i/M_{i-1}$
is simple. By Lemma \ref{lemma-characterize-length-1} the modules
$M_i/M_{i-1}$ have length $1$ and are of the form $R/\mathfrak m_i$
for some maximal ideals $\mathfrak m_i$. By additivity of length,
Lemma \ref{lemma-length-additive}, we see $n = \ell$. Since localization
is exact, we see that
$$
0 = (M_0)_{\mathfrak m}
\subset (M_1)_{\mathfrak m}
\subset (M_2)_{\mathfrak m}
\subset \ldots
\subset (M_n)_{\mathfrak m} = M_{\mathfrak m}
$$
is a filtration of $M_{\mathfrak m}$ with successive quotients
$(M_i/M_{i-1})_{\mathfrak m}$. Thus the last statement follows
directly from the fact that given maximal ideals $\mathfrak m$,
$\mathfrak m'$ of $R$ we have
$$
(R/\mathfrak m')_{\mathfrak m}
\cong
\left\{
\begin{matrix}
0 &
\text{if } \mathfrak m \not = \mathfrak m', \\
R_{\mathfrak m}/\mathfrak m R_{\mathfrak m} &
\text{if } \mathfrak m  = \mathfrak m'
\end{matrix}
\right.
$$
This we leave to the reader.
\end{proof}

\begin{lemma}
\label{lemma-pushdown-module}
Let $A$ be a local ring with maximal ideal $\mathfrak m$.
Let $B$ be a semi-local ring with maximal ideals $\mathfrak m_i$,
$i = 1, \ldots, n$.
Suppose that $A \to B$ is a homomorphism such that each $\mathfrak m_i$
lies over $\mathfrak m$ and such that
$$
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] < \infty.
$$
Let $M$ be a $B$-module of finite length.
Then
$$
\text{length}_A(M) = \sum\nolimits_{i = 1, \ldots, n}
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]
\text{length}_{B_{\mathfrak m_i}}(M_{\mathfrak m_i}),
$$
in particular $\text{length}_A(M) < \infty$.
\end{lemma}

\begin{proof}
Choose a maximal chain
$$
0 = M_0
\subset M_1
\subset M_2
\subset \ldots
\subset M_n = M
$$
by $B$-submodules as in Lemma \ref{lemma-simple-pieces}.
Then each quotient $M_i/M_{i - 1}$ is isomorphic to
$\kappa(\mathfrak m_{j(i)})$ for some $j(i) \in \{1, \ldots, n\}$.
Moreover
$\text{length}_A(\kappa(\mathfrak m_i)) =
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]$ by
Lemma \ref{lemma-dimension-is-length}. The lemma follows
by additivity of lengths (Lemma \ref{lemma-length-additive}).
\end{proof}

\begin{lemma}
\label{lemma-pullback-module}
Let $A \to B$ be a flat local homomorphism of local rings.
Then for any $A$-module $M$ we have
$$
\text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(M \otimes_A B).
$$
In particular, if $\text{length}_B(B/\mathfrak m_AB) < \infty$
then $M$ has finite length if and only if $M \otimes_A B$ has finite length.
\end{lemma}

\begin{proof}
The ring map $A \to B$ is faithfully flat by
Lemma \ref{lemma-local-flat-ff}.
Hence if $0 = M_0 \subset M_1 \subset \ldots \subset M_n = M$
is a chain of length $n$ in $M$, then the corresponding chain
$0 = M_0 \otimes_A B \subset M_1 \otimes_A B \subset
\ldots \subset M_n \otimes_A B = M \otimes_A B$ has length $n$
also. This proves
$\text{length}_A(M) = \infty \Rightarrow
\text{length}_B(M \otimes_A B) = \infty$.
Next, assume $\text{length}_A(M) < \infty$. In this case we see
that $M$ has a filtration of length $\ell = \text{length}_A(M)$
whose quotients are $A/\mathfrak m_A$. Arguing as above
we see that $M \otimes_A B$ has a filtration of length $\ell$
whose quotients are isomorphic to
$B \otimes_A A/\mathfrak m_A =  B/\mathfrak m_AB$.
Thus the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-pullback-transitive}
Let $A \to B \to C$ be flat local homomorphisms of local rings. Then
$$
\text{length}_B(B/\mathfrak m_A B)
\text{length}_C(C/\mathfrak m_B C)
=
\text{length}_C(C/\mathfrak m_A C)
$$
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pullback-module} applied to the ring map
$B \to C$ and the $B$-module $M = B/\mathfrak m_A B$
\end{proof}











\section{Artinian rings}
\label{section-artinian}

\noindent
Artinian rings, and especially local Artinian rings,
play an important role in algebraic geometry, for example
in deformation theory.

\begin{definition}
\label{definition-artinian}
A ring $R$ is {\it Artinian} if it satisfies the
descending chain condition for ideals.
\end{definition}

\begin{lemma}
\label{lemma-finite-dimensional-algebra}
Suppose $R$ is a finite dimensional algebra over a field.
Then $R$ is Artinian.
\end{lemma}

\begin{proof}
The descending chain condition for ideals obviously holds.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-nr-max}
If $R$ is Artinian then $R$ has only finitely many maximal ideals.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak m_i$, $i = 1, 2, 3, \ldots$ are maximal ideals.
Then $\mathfrak m_1 \supset \mathfrak m_1\cap \mathfrak m_2
\supset \mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 \supset \ldots$
is an infinite descending sequence (because by the Chinese
remainder theorem all the maps $R \to \oplus_{i = 1}^n R/\mathfrak m_i$
are surjective).
\end{proof}

\begin{lemma}
\label{lemma-artinian-radical-nilpotent}
Let $R$ be Artinian. The radical $\text{rad}(R)$ of $R$ is
a nilpotent ideal.
\end{lemma}

\begin{proof}
Denote the radical $I$.
Note that $I \supset I^2 \supset I^3 \supset \ldots$ is a descending
sequence. Thus $I^n = I^{n + 1}$ for some $n$.
Set $J = \{ x\in R \mid xI^n = 0\}$. We have to show $J = R$.
If not, choose an ideal $J' \not = J$, $J \subset J'$ minimal (possible
by the Artinian property). Then $J' = J + Rx$ for some $x \in R$.
By NAK, Lemma \ref{lemma-NAK}, we have $IJ' \subset J$.
Hence $xI^{n + 1} \subset xI \cdot I^n \subset J \cdot I^n = 0$.
Since $I^{n + 1} = I^n$ we conclude $x\in J$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-product-local}
Any ring with finitely many maximal ideals and
locally nilpotent radical is the product of its localizations
at its maximal ideals. Also, all primes are maximal.
\end{lemma}

\begin{proof}
Let $R$ be a ring with finitely many maximal ideals
$\mathfrak m_1, \ldots, \mathfrak m_n$.
Let $I = \bigcap_{i = 1}^n \mathfrak m_i$
be the radical of $R$. Assume $I$ is locally nilpotent.
Let $\mathfrak p$ be a prime ideal of $R$.
Since every prime contains every nilpotent
element of $R$ we see
$ \mathfrak p \supset \mathfrak m_1 \cap \ldots \cap \mathfrak m_n$.
Since $\mathfrak m_1 \cap \ldots \cap \mathfrak m_n \supset
\mathfrak m_1 \ldots \mathfrak m_n$
we conclude $\mathfrak p \supset \mathfrak m_1 \ldots \mathfrak m_n$.
Hence $\mathfrak p \supset \mathfrak m_i$ for some $i$, and so
$\mathfrak p = \mathfrak m_i$. By the Chinese remainder theorem
(Lemma \ref{lemma-chinese-remainder})
we have $R/I \cong \bigoplus R/\mathfrak m_i$
which is a product of fields.
Hence by Lemma \ref{lemma-lift-idempotents}
there are idempotents $e_i$, $i = 1, \ldots, n$
with $e_i \bmod \mathfrak m_j = \delta_{ij}$.
Hence $R = \prod Re_i$, and each $Re_i$ is a
ring with exactly one maximal ideal.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-length}
A ring $R$ is Artinian if and only if it has finite length
as a module over itself. Any such ring $R$ is both Artinian and
Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal
to the (finite) product of its localizations at its maximal ideals.
\end{lemma}

\begin{proof}
If $R$ has finite length over itself then it satisfies both
the ascending chain condition and the descending chain
condition for ideals. Hence it is both Noetherian and Artinian.
Any Artinian ring is equal to product of its localizations
at maximal ideals by Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent}, and \ref{lemma-product-local}.

\medskip\noindent
Suppose that $R$ is Artinian. We will show $R$ has finite
length over itself. It suffices to exhibit a chain of
submodules whose successive quotients have finite length.
By what we said above
we may assume that $R$ is local, with maximal ideal $\mathfrak m$.
By Lemma \ref{lemma-artinian-radical-nilpotent} we have
$\mathfrak m^n =0$ for some $n$.
Consider the sequence
$0 = \mathfrak m^n \subset \mathfrak m^{n-1} \subset
\ldots \subset \mathfrak m \subset R$. By Lemma
\ref{lemma-dimension-is-length} the length of each subquotient
$\mathfrak m^j/\mathfrak m^{j + 1}$ is the dimension of this
as a vector space over $\kappa(\mathfrak m)$. This has to be
finite since otherwise we would have an infinite descending
chain of sub vector spaces which would correspond to an
infinite descending chain of ideals in $R$.
\end{proof}









\section{Homomorphisms essentially of finite type}
\label{section-essentially-of-finite-type}

\noindent
Some simple remarks on localizations of finite type ring maps.

\begin{definition}
\label{definition-essentially-finite-p-t}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say that $R \to S$ is {\it essentially of finite type} if
$S$ is the localization of an $R$-algebra of finite type.
\item We say that $R \to S$ is {\it essentially of finite presentation} if
$S$ is the localization of an $R$-algebra of finite presentation.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-composition-essentially-of-finite-type}
The class of ring maps which are essentially of finite type is
preserved under composition. Similarly for essentially of finite
presentation.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-essentially-of-finite-type}
The class of ring maps which are essentially of finite type is
preserved by base change. Similarly for essentially of finite
presentation.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-essentially-of-finite-type-into-artinian-local}
Let $R \to S$ be a ring map. Assume $S$ is an Artinian local ring with
maximal ideal $\mathfrak m$. Then
\begin{enumerate}
\item $R \to S$ is finite if and only if $R \to S/\mathfrak m$ is finite,
\item $R \to S$ is of finite type if and only if $R \to S/\mathfrak m$
is of finite type.
\item $R \to S$ is essentially of finite type if and
only if the composition $R \to S/\mathfrak m$ is essentially
of finite type.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R \to S$ is finite, then $R \to S/\mathfrak m$
is finite by Lemma \ref{lemma-finite-transitive}.
Conversely, assume $R \to S/\mathfrak m$ is finite.
As $S$ has finite length over itself
(Lemma \ref{lemma-artinian-finite-length})
we can choose a filtration
$$
0 \subset I_1 \subset \ldots \subset I_n = S
$$
by ideals such that $I_i/I_{i - 1} \cong S/\mathfrak m$ as $S$-modules.
Thus $S$ has a filtration by $R$-submodules $I_i$ such that each
successive quotient is a finite $R$-module. Thus $S$ is a finite
$R$-module by Lemma \ref{lemma-extension}.

\medskip\noindent
If $R \to S$ is of finite type, then $R \to S/\mathfrak m$
is of finite type by Lemma \ref{lemma-compose-finite-type}.
Conversely, assume that $R \to S/\mathfrak m$ is of finite type.
Choose $f_1, \ldots, f_n \in S$ which map to generators of $S/\mathfrak m$.
Then $A = R[x_1, \ldots, x_n] \to S$, $x_i \mapsto f_i$ is a ring map such
that $A \to S/\mathfrak m$ is surjective (in particular finite).
Hence $A \to S$ is finite by part (1) and we see that $R \to S$
is of finite type by Lemma \ref{lemma-compose-finite-type}.

\medskip\noindent
If $R \to S$ is essentially of finite type, then $R \to S/\mathfrak m$
is essentially of finite type by
Lemma \ref{lemma-composition-essentially-of-finite-type}.
Conversely, assume that $R \to S/\mathfrak m$ is essentially
of finite type. Suppose $S/\mathfrak m$ is the localization
of $R[x_1, \ldots, x_n]/I$. Choose $f_1, \ldots, f_n \in S$
whose congruence classes modulo $\mathfrak m$ correspond to
the congruence classes of $x_1, \ldots, x_n$ modulo $I$.
Consider the map $R[x_1, \ldots, x_n] \to S$, $x_i \mapsto f_i$
with kernel $J$. Set $A = R[x_1, \ldots, x_n]/J \subset S$
and $\mathfrak p = A \cap \mathfrak m$. Note that
$A/\mathfrak p \subset S/\mathfrak m$ is equal to the image
of $R[x_1, \ldots, x_n]/I$ in $S/\mathfrak m$. Hence
$\kappa(\mathfrak p) = S/\mathfrak m$. Thus $A_\mathfrak p \to S$
is finite by part (1). We conclude that $S$ is essentially of finite
type by Lemma \ref{lemma-composition-essentially-of-finite-type}.
\end{proof}

\noindent
The following lemma can be proven using properness of projective
space instead of the algebraic argument we give here.

\begin{lemma}
\label{lemma-localization-at-closed-point-special-fibre}
Let $\varphi : R \to S$ be essentially of finite type with $R$ and $S$
local (but not necessarily $\varphi$ local). Then there exists
an $n$ and a maximal ideal $\mathfrak m \subset R[x_1, \ldots, x_n]$
lying over $\mathfrak m_R$ such that $S$ is a localization of a
quotient of $R[x_1, \ldots, x_n]_\mathfrak m$.
\end{lemma}

\begin{proof}
We can write $S$ as a localization of a quotient of $R[x_1, \ldots, x_n]$.
Hence it suffices to prove the lemma in case
$S = R[x_1, \ldots, x_n]_\mathfrak q$ for some prime
$\mathfrak q \subset R[x_1, \ldots, x_n]$.
If $\mathfrak q + \mathfrak m_R R[x_1, \ldots, x_n] \not = R[x_1, \ldots, x_n]$
then we can find a maximal ideal $\mathfrak m$ as in the statement
of the lemma with $\mathfrak q \subset \mathfrak m$ and the result is clear.

\medskip\noindent
Choose a valuation ring $A \subset \kappa(\mathfrak q)$
which dominates the image of $R \to \kappa(\mathfrak q)$
(Lemma \ref{lemma-dominate}). If the image $\lambda_i \in \kappa(\mathfrak q)$
of $x_i$ is contained in $A$, then $\mathfrak q$ is contained in the inverse
image of $\mathfrak m_A$ via $R[x_1, \ldots, x_n] \to A$
which means we are back in the preceding case.
Hence there exists an $i$ such that $\lambda_i^{-1} \in A$
and such that $\lambda_j/\lambda_i \in A$ for all $j = 1, \ldots, n$
(because the value group of $A$ is totally ordered, see
Lemma \ref{lemma-valuation-group}). Then we consider the map
$$
R[y_0, y_1, \ldots, \hat{y_i}, \ldots, y_n]
\to R[x_1, \ldots, x_n]_\mathfrak q,\quad
y_0 \mapsto 1/x_i,\quad y_j \mapsto x_j/x_i
$$
Let $\mathfrak q' \subset R[y_0, \ldots, \hat{y_i}, \ldots, y_n]$
be the inverse image
of $\mathfrak q$. Since $y_0 \not \in \mathfrak q'$ it is easy to see
that the displayed arrow defines an isomorphism on localizations.
On the other hand, the result of the first paragraph applies to
$R[y_0, \ldots, \hat{y_i}, \ldots, y_n]$
because $y_j$ maps to an element of $A$.
This finishes the proof.
\end{proof}






















\section{K-groups}
\label{section-K-groups}

\noindent
Let $R$ be a ring. We will introduce two abelian groups associated
to $R$. The first of the two is denoted $K'_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite $R$-module $M$ there is given an element $[M]$ in
$K'_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
we have the relation $[M] = [M'] + [M'']$,
\item the group $K'_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0'(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The actual construction is a bit more annoying since one has to take care
that the collection of all finitely generated $R$-modules is a proper class.
However, this problem can be overcome by taking as set of generators
of the group $K_0'(R)$ the elements $[R^n/K]$ where $n$ ranges over
all integers and $K$ ranges over all submodules $K \subset R^n$.
The generators for the subgroup of relations imposed on these elements
will be the relations coming from short exact sequences whose terms
are of the form $R^n/K$. The element $[M]$ is defined by
choosing $n$ and $K$ such that $M \cong R^n/K$ and putting
$[M] = [R^n/K]$. Details left to the reader.

\begin{lemma}
\label{lemma-length-K0}
If $R$ is an Artinian local ring then the length function
defines a natural abelian group homomorphism
$\text{length}_R : K_0'(R) \to \mathbf{Z}$.
\end{lemma}

\begin{proof}
The length of any finite $R$-module is finite,
because it is the quotient of $R^n$ which has finite length by
Lemma \ref{lemma-artinian-finite-length}. And the length function
is additive, see Lemma \ref{lemma-length-additive}.
\end{proof}

\noindent
The second of the two is denoted $K_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite projective $R$-module $M$ there
is given an element $[M]$ in $K_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
of finite projective $R$-modules we have the relation $[M] = [M'] + [M'']$,
\item the group $K_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The construction of this group is done as above.

\medskip\noindent
We note that there is an obvious map $K_0(R) \to K_0'(R)$
which is not an isomorphism in general.

\begin{example}
\label{example-K0-field}
Note that if $R = k$ is a field then we clearly have
$K_0(k) = K_0'(k) \cong \mathbf{Z}$ with the isomorphism
given by the dimension function (which is also the length function).
\end{example}

\begin{example}
\label{example-K0-polynomial-ring}
Let $k$ be a field. Then $K_0(k[x]) = K_0'(k[x]) = \mathbf{Z}$.

\medskip\noindent
Since $R = k[x]$ is a principal ideal domain, any finite projective
$R$-module is free. In a short exact sequence of modules
$$
0 \to M' \to M \to M'' \to 0
$$
we have $\text{rank}(M) = \text{rank}(M') + \text{rank}(M'')$,
which gives $K_0(k[x]) = \mathbf{Z}$.

\medskip\noindent
As for $K_0'$, the structure theorem for modules of a PID says that
any finitely generated $R$-module is of the form
$M = R^r \times R/(d_1) \times \ldots \times R/(d_k)$.
Consider the short exact sequence
$$
0 \to (d_i) \to R \to R/(d_i) \to 0
$$
Since the ideal $(d_i)$ is isomorphic to $R$ as a module
(it is free with generator $d_i$), in $K_0'(R)$ we have
$[(d_i)] = [R]$.  Then $[R/(d_i)] = [(d_i)]-[R] = 0$.  From this it
follows that any torsion part ``disappears'' in $K_0'$.
Again the rank of the free part determines that $K_0'(k[x]) = \mathbf{Z}$,
and the canonical homomorphism from $K_0$ to $K_0'$ is an isomorphism.
\end{example}

\begin{example}
\label{example-K0-node}
Let $k$ be a field. Let $R = \{f \in k[x] \mid f(0) = f(1)\}$,
compare Example \ref{example-affine-open-not-standard}.
In this case $K_0(R) \cong k^* \oplus \mathbf{Z}$, but
$K_0'(R) = \mathbf{Z}$.
\end{example}

\begin{lemma}
\label{lemma-K0-product}
Let $R = R_1 \times R_2$. Then $K_0(R) = K_0(R_1) \times K_0(R_2)$
and $K_0'(R) = K_0'(R_1) \times K_0'(R_2)$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0prime-Artinian}
Let $R$ be an Artinian local ring.
The map $\text{length}_R : K_0'(R) \to \mathbf{Z}$
of Lemma \ref{lemma-length-K0} is an isomorphism.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0-local}
Let $R$ be a local ring. Every finite projective $R$-module
is finite free. The map $\text{rank}_R : K_0(R) \to \mathbf{Z}$
defined by $[M] \to \text{rank}_R(M)$ is well defined
and an isomorphism.
\end{lemma}

\begin{proof}
Let $P$ be a finite projective $R$-module.
The $n$ generators of $P$ give a surjection
$R^n \to P$, and since $P$ is projective it
follows that $R^n \cong P \oplus Q$ for some
projective module $Q$.

\medskip\noindent
If $\mathfrak m \subset R$ is the maximal ideal,
then $P/\mathfrak m$ and $Q/\mathfrak m$ are $R/\mathfrak m$-vector spaces,
with $P/\mathfrak m \oplus Q/\mathfrak m \cong (R/\mathfrak m)^n$.
Say that $\dim P = p$, $\dim Q = q$, so $p + q = n$.

\medskip\noindent
Choose elements $a_1, \ldots, a_p$ in $P$ and $b_1, \ldots, b_q$ in $Q$
lying above bases for $P/\mathfrak m$ and $Q/\mathfrak m$.
The homomorphism $R^n \to P \oplus Q \cong R^n$ given by
$(r_1, \ldots, r_n) \mapsto
r_1a_1 + \ldots + r_pa_p + r_{p + 1} b_1 + \ldots + r_nb_q$
is a matrix $A$ which is invertible over $R/\mathfrak m$. Let $B$
be a matrix over $R$ lying over the inverse of $A$ in $R/\mathfrak m$.
$AB = I + M$, where $M$ is a matrix whose entries all lie in $\mathfrak m$.
Thus $\det AB = 1 + x$, for $x \in \mathfrak m$, so $AB$ is invertible,
so $A$ is invertible.

\medskip\noindent
The homomorphism $R^p \to P$ given by
$(r_1, \ldots, r_p) \mapsto r_1a_1 + \ldots + r_pa_p$ inherits injectivity and
surjectivity from A. Hence, $P \cong R^p$.

\medskip\noindent
Next we show that the rank of a finite projective module over $R$ is
well defined: if $P \cong R^\alpha \cong R^\beta$, then $\alpha = \beta$.
This is immediate in the vector space case, and so it is true in the
general module case as well, by dividing out the maximal ideal on both sides.
If $0 \to R^\alpha \to R^\beta \to R^\gamma \to 0$
is exact, the sequence splits, so $R^\beta \cong R^\alpha \oplus R^\gamma$,
so $\beta = \alpha + \gamma$.

\medskip\noindent
So far we have seen that the map $\text{rank}_R : K_0(R) \to \mathbf{Z}$
is a well-defined homomorphism. It is surjective because
$\text{rank}_R[R] = 1$. It is injective because the element
of $K_0(R)$ with rank $\pm\alpha$ is uniquely $\pm [R^\alpha]$.
\end{proof}

\begin{lemma}
\label{lemma-K0-and-K0prime-Artinian-local}
Let $R$ be a local Artinian ring. There is a commutative
diagram
$$
\xymatrix{
K_0(R) \ar[rr] \ar[d]_{\text{rank}_R} & &
K_0'(R) \ar[d]^{\text{length}_R} \\
\mathbf{Z} \ar[rr]^{\text{length}_R(R)} & &
\mathbf{Z}
}
$$
where the vertical maps are isomorphisms by
Lemmas \ref{lemma-K0prime-Artinian} and \ref{lemma-K0-local}.
\end{lemma}

\begin{proof}
By induction on the rank of $M$.
Suppose $\left[M\right] \in K_0(R)$.
Then $M$ is a finite projective $R$-module
over a local ring, so M is free;
$M \cong R^n$ for some $n$.
The claim is that
$\text{rank} (M) \text{length}_R (R) = \text{length}_R(M)$,
or equivalently that $n\text{length}_R(R) = \text{length}_R (R^n)$
for all $n \geq 1$. When $n = 1$, this is clearly true.
Suppose that $(n-1) \text{length}_R(R) =\text{ length}_R(R^{n-1})$.
Then since there is a split short exact sequence
$$
0 \to R \to R^n \to R^{n-1} \to 0
$$
by Lemma \ref{lemma-length-additive} we have
\begin{eqnarray*}
\text{length}_R(R^n) & = & \text{length}_R(R) + \text{length}_R(R^{n-1}) \\
& = & \text{length}_R(R) + (n-1) \text{length}_R(R) \\
& = & n\text{length}_R(R)
\end{eqnarray*}
as desired.
\end{proof}

















\section{Graded rings}
\label{section-graded}

\noindent
A {\it graded ring} will be for us a ring $S$ endowed
with a direct sum decomposition $S = \bigoplus_{d \geq 0} S_d$
such that $S_d \cdot S_e \subset S_{d + e}$.
Note that we do not allow nonzero elements in negative degrees.
The {\it irrelevant ideal} is the ideal $S_{+} = \bigoplus_{d > 0} S_d$.
A {\it graded module}
will be an $S$-module $M$ endowed with a direct sum decomposition
$M = \bigoplus_{n\in \mathbf{Z}} M_n$ such that $S_d \cdot M_e
\subset M_{d + e}$. Note that for modules we do allow
nonzero elements in negative degrees.
We think of $S$ as a graded $S$-module by setting $S_{-k} = (0)$
for $k > 0$. An element $x$ (resp.\ $f$) of $M$ (resp.\ $S$) is called
{\it homogeneous}
if $x \in M_d$ (resp.\ $f \in S_d$) for some $d$.
A {\it map of graded $S$-modules} is a map of $S$-modules
$\varphi : M \to M'$ such that $\varphi(M_d) \subset M'_d$.
We do not allow maps to shift degrees. Let us denote
$\text{GrHom}_0(M, N)$ the $S_0$-module of homomorphisms
of graded modules from $M$ to $N$.

\medskip\noindent
At this point there are the notions of graded ideal,
graded quotient ring, graded submodule, graded quotient module,
graded tensor product, etc. We leave it to the reader to find the
relevant definitions, and lemmas. For example: A short exact sequence
of graded modules is short exact in every degree.

\medskip\noindent
Given a graded ring $S$, a graded $S$-module $M$ and $n \in \mathbf{Z}$
we denote $M(n)$ the graded $S$-module with $M(n)_d = M_{n + d}$.
This is called the {\it twist of $M$ by $n$}. In particular we get
modules $S(n)$, $n \in \mathbf{Z}$ which will play an important
role in the study of projective schemes. There are some obvious
functorial isomorphisms such as
$(M \oplus N)(n) = M(n) \oplus N(n)$,
$(M \otimes_S N)(n) = M \otimes_S N(n) = M(n) \otimes_S N$.
In addition we can define a graded $S$-module structure on
the $S_0$-module
$$
\text{GrHom}(M, N) =
\bigoplus\nolimits_{n \in \mathbf{Z}} \text{GrHom}_n(M, N),
\quad
\text{GrHom}_n(M, N) = \text{GrHom}_0(M, N(n)).
$$
We omit the definition of the multiplication.

\medskip\noindent
Let $S$ be a graded ring. Let $d \geq 1$ be an integer.
We set $S^{(d)} = \bigoplus_{n \geq 0} S_{nd}$. We think of
$S^{(d)}$ as a graded ring with degree $n$ summand
$(S^{(d)})_n = S_{nd}$. Given a graded $S$-module $M$ we
can similarly consider $M^{(d)} = \bigoplus_{n \in \mathbf{Z}} M_{nd}$
which is a graded $S^{(d)}$-module.

\begin{lemma}
\label{lemma-integral-closure-graded}
Let $R \to S$ be a homomorphism of graded rings.
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Then
$$
S' = \bigoplus\nolimits_{d \geq 0} S' \cap S_d,
$$
i.e., $S'$ is a graded $R$-subalgebra of $S$.
\end{lemma}

\begin{proof}
We have to show the following: If
$s = s_n + s_{n + 1} + \ldots + s_m \in S'$, then each homogeneous
part $s_j \in S'$. We will prove this by induction on $m - n$ over
all homomorphisms $R \to S$ of graded rings. First note that it
is immediate that $s_0$ is integral over $R_0$ (hence over $R$) as
there is a ring map $S \to S_0$ compatible with the ring map $R \to R_0$.
Thus, after replacing $s$ by $s - s_0$, we may assume $n > 0$. Consider the
extension of graded rings $R[t, t^{-1}] \to S[t, t^{-1}]$ where
$t$ has degree $0$. There is a commutative diagram
$$
\xymatrix{
S[t, t^{-1}] \ar[rr]_{s \mapsto t^{\deg(s)}s} & & S[t, t^{-1}] \\
R[t, t^{-1}] \ar[u] \ar[rr]^{r \mapsto t^{\deg(r)}r} & &  R[t, t^{-1}] \ar[u]
}
$$
where the horizontal maps are ring automorphisms. Hence the integral
closure $C$ of $S[t, t^{-1}]$ over $R[t, t^{-1}]$ maps into itself.
Thus we see that
$$
t^m(s_n + s_{n + 1} + \ldots + s_m) -
(t^ns_n + t^{n + 1}s_{n + 1} + \ldots + t^ms_m) \in C
$$
which implies by induction hypothesis that each $(t^m - t^i)s_i \in C$
for $i = n, \ldots, m - 1$. Note that for any ring $A$ and $m > i \geq n > 0$
we have $A[t, t^{-1}]/(t^m - t^i - 1) \cong A[t]/(t^m - t^i - 1) \supset A$
because $t(t^{m - 1} - t^{i - 1}) = 1$ in $A[t]/(t^m - t^i - 1)$.
Since $t^m - t^i$ maps to $1$ we see the image of $s_i$ in the ring
$S[t]/(t^m - t^i - 1)$ is integral over $R[t]/(t^m - t^i - 1)$ for
$i = n, \ldots, m - 1$. Since $R \to R[t]/(t^m - t^i - 1)$ is finite
we see that $s_i$ is integral over $R$ by transitivity, see
Lemma \ref{lemma-integral-transitive}.
Finally, we also conclude that $s_m = s - \sum_{i = n, \ldots, m - 1} s_i$
is integral over $R$.
\end{proof}








\section{Proj of a graded ring}
\label{section-proj}

\noindent
Let $S$ be a graded ring.
A {\it homogeneous ideal} is simply an ideal
$I \subset S$ which is also a graded submodule of $S$.
Equivalently, it is an ideal generated by homogeneous elements.
Equivalently, if $f \in I$ and
$$
f = f_0 + f_1 + \ldots + f_n
$$
is the decomposition of $f$ into homogeneous parts in $S$ then $f_i \in I$
for each $i$. To check that a homogeneous ideal $\mathfrak p$
is prime it suffices to check that if $ab \in \mathfrak p$
with $a, b$ homogeneous then either $a \in \mathfrak p$ or
$b \in \mathfrak p$.

\begin{definition}
\label{definition-proj}
Let $S$ be a graded ring.
We define $\text{Proj}(S)$ to be the set of homogeneous,
prime ideals $\mathfrak p$ of $S$ such that
$S_{+} \not \subset \mathfrak p$.
As $\text{Proj}(S)$ is a subset of $\Spec(S)$
and we endow it with the induced topology.
The topological space $\text{Proj}(S)$ is called the
{\it homogeneous spectrum} of the graded ring $S$.
\end{definition}

\noindent
Note that by construction there is a continuous map
$$
\text{Proj}(S) \longrightarrow \Spec(S_0)
$$

\medskip\noindent
Let $S = \oplus_{d \geq 0} S_d$ be a graded ring.
Let $f\in S_d$ and assume that $d \geq 1$.
We define $S_{(f)}$ to be the subring of $S_f$
consisting of elements of the form $r/f^n$ with $r$ homogeneous and
$\deg(r) = nd$. If $M$ is a graded $S$-module,
then we define the $S_{(f)}$-module $M_{(f)}$ as the
sub module of $M_f$ consisting of elements of
the form $x/f^n$ with $x$ homogeneous of degree $nd$.

\begin{lemma}
\label{lemma-Z-graded}
Let $S$ be a $\mathbf{Z}$-graded ring containing a homogeneous
invertible element of positive degree. Then the set
$G \subset \Spec(S)$ of $\mathbf{Z}$-graded primes of $S$
(with induced topology) maps homeomorphically to $\Spec(S_0)$.
\end{lemma}

\begin{proof}
First we show that the map is a bijection by constructing an inverse.
Let $f \in S_d$, $d > 0$ be invertible in $S$.
If $\mathfrak p_0$ is a prime of $S_0$, then $\mathfrak p_0S$
is a $\mathbf{Z}$-graded ideal of $S$ such that
$\mathfrak p_0S \cap S_0 = \mathfrak p_0$. And if $ab \in \mathfrak p_0S$
with $a$, $b$ homogeneous, then
$a^db^d/f^{\deg(a) + \deg(b)} \in \mathfrak p_0$.
Thus either $a^d/f^{\deg(a)} \in \mathfrak p_0$ or
$b^d/f^{\deg(b)} \in \mathfrak p_0$, in other words either
$a^d \in \mathfrak p_0S$ or $b^d \in \mathfrak p_0S$.
It follows that $\sqrt{\mathfrak p_0S}$ is a $\mathbf{Z}$-graded
prime ideal of $S$ whose intersection with $S_0$ is $\mathfrak p_0$.

\medskip\noindent
To show that the map is a homeomorphism we show that
the image of $G \cap D(g)$ is open. If $g = \sum g_i$
with $g_i \in S_i$, then by the above $G \cap D(g)$
maps onto the set $\bigcup D(g_i^d/f^i)$ which is open.
\end{proof}

\noindent
For $f \in S$ homogeneous of degree $> 0$ we define
$$
D_{+}(f) = \{ \mathfrak p \in \text{Proj}(S) \mid f \not\in \mathfrak p \}.
$$
Finally, for a homogeneous ideal $I \subset S$ we define
$$
V_{+}(I) = \{ \mathfrak p \in \text{Proj}(S) \mid I \subset \mathfrak p \}.
$$
We will use more generally the notation $V_{+}(E)$ for any
set $E$ of homogeneous elements $E \subset S$.

\begin{lemma}[Topology on Proj]
\label{lemma-topology-proj}
Let $S = \oplus_{d \geq 0} S_d$ be a graded ring.
\begin{enumerate}
\item The sets $D_{+}(f)$ are open in $\text{Proj}(S)$.
\item We have $D_{+}(ff') = D_{+}(f) \cap D_{+}(f')$.
\item Let $g = g_0 + \ldots + g_m$ be an element
of $S$ with $g_i \in S_i$. Then
$$
D(g) \cap \text{Proj}(S) =
(D(g_0) \cap \text{Proj}(S))
\cup
\bigcup\nolimits_{i \geq 1} D_{+}(g_i).
$$
\item
Let $g_0\in S_0$ be a homogeneous element of degree $0$. Then
$$
D(g_0) \cap \text{Proj}(S)
=
\bigcup\nolimits_{f \in S_d, \ d\geq 1} D_{+}(g_0 f).
$$
\item The open sets $D_{+}(f)$ form a
basis for the topology of $\text{Proj}(S)$.
\item Let $f \in S$ be homogeneous of positive degree.
The ring $S_f$ has a natural $\mathbf{Z}$-grading.
The ring maps $S \to S_f \leftarrow S_{(f)}$ induce
homeomorphisms
$$
D_{+}(f)
\leftarrow
\{\mathbf{Z}\text{-graded primes of }S_f\}
\to
\Spec(S_{(f)}).
$$
\item There exists an $S$ such that $\text{Proj}(S)$ is not
quasi-compact.
\item The sets $V_{+}(I)$ are closed.
\item Any closed subset $T \subset \text{Proj}(S)$ is of
the form $V_{+}(I)$ for some homogeneous ideal $I \subset S$.
\item For any graded ideal $I \subset S$ we have
$V_{+}(I) = \emptyset$ if and only if $S_{+} \subset \sqrt{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $D_{+}(f) = \text{Proj}(S) \cap D(f)$, these sets are open.
Similarly the sets $V_{+}(I) = \text{Proj}(S) \cap V(E)$ are
closed.

\medskip\noindent
Suppose that $T \subset \text{Proj}(S)$ is closed.
Then we can write $T = \text{Proj}(S) \cap V(J)$ for some
ideal $J \subset S$. By definition of a homogeneous ideal
if $g \in J$, $g = g_0 + \ldots + g_m$
with $g_d \in S_d$ then $g_d \in \mathfrak p$ for all
$\mathfrak p \in T$. Thus, letting $I \subset S$
be the ideal generated by the homogeneous parts of the elements
of $J$ we have $T = V_{+}(I)$.

\medskip\noindent
The formula for $\text{Proj}(S) \cap D(g)$, with $g \in S$ is direct
from the definitions. Consider the formula for $\text{Proj}(S) \cap D(g_0)$.
The inclusion of the right hand side in the left hand side is
obvious. For the other inclusion, suppose $g_0 \not \in \mathfrak p$
with $\mathfrak p \in \text{Proj}(S)$. If all $g_0f \in \mathfrak p$
for all homogeneous $f$ of positive degree, then we see that
$S_{+} \subset \mathfrak p$ which is a contradiction. This gives
the other inclusion.

\medskip\noindent
The collection of opens $D(g) \cap \text{Proj}(S)$
forms a basis for the topology since the standard opens
$D(g) \subset \Spec(S)$ form a basis for the topology on
$\Spec(S)$. By the formulas above we can express
$D(g) \cap \text{proj}(S)$ as a union of opens $D_{+}(f)$.
Hence the collection of opens $D_{+}(f)$ forms a basis for the topology
also.

\medskip\noindent
First we note that $D_{+}(f)$ may be identified
with a subset (with induced topology) of $D(f) = \Spec(S_f)$
via Lemma \ref{lemma-standard-open}. Note that the ring
$S_f$ has a $\mathbf{Z}$-grading. The homogeneous elements are
of the form $r/f^n$ with $r \in S$ homogeneous and have
degree $\deg(r/f^n) = \deg(r) - n\deg(f)$. The subset
$D_{+}(f)$ corresponds exactly to those prime ideals
$\mathfrak p \subset S_f$ which are $\mathbf{Z}$-graded ideals
(i.e., generated by homogeneous elements). Hence we have to show that
the set of $\mathbf{Z}$-graded prime ideals of $S_f$ maps homeomorphically
to $\Spec(S_{(f)})$. This follows from Lemma \ref{lemma-Z-graded}.

\medskip\noindent
Let $S = \mathbf{Z}[X_1, X_2, X_3, \ldots]$ with grading such that
each $X_i$ has degree $1$. Then it is easy to see that
$$
\text{Proj}(S) = \bigcup\nolimits_{i = 1}^\infty D_{+}(X_i)
$$
does not have a finite refinement.

\medskip\noindent
Let $I \subset S$ be a graded ideal.
If $\sqrt{I} \supset S_{+}$ then $V_{+}(I) = \emptyset$ since
every prime $\mathfrak p \in \text{Proj}(S)$ does not contain
$S_{+}$ by definition. Conversely, suppose that
$S_{+} \not \subset \sqrt{I}$. Then we can find an element
$f \in S_{+}$ such that $f$ is not nilpotent modulo $I$.
Clearly this means that one of the homogeneous parts of $f$
is not nilpotent modulo $I$, in other words we may (and do)
assume that $f$ is homogeneous. This implies that
$I S_f \not = 0$, in other words that $(S/I)_f$ is not
zero. Hence $(S/I)_{(f)} \not = 0$ since it is a ring
which maps into $(S/I)_f$. Pick a prime
$\mathfrak q \subset (S/I)_{(f)}$. This corresponds to
a graded prime of $S/I$, not containing the irrelevant ideal
$(S/I)_{+}$. And this in turn corresponds to a graded prime
ideal $\mathfrak p$ of $S$, containing $I$ but not containing $S_{+}$
as desired.
\end{proof}

\begin{example}
\label{example-proj-polynomial-ring-1-variable}
Let $R$ be a ring. If $S = R[X]$ with $\deg(X) = 1$, then the natural map
$\text{Proj}(S) \to \Spec(R)$ is a bijection and in fact a homeomorphism.
Namely, suppose $\mathfrak p \in \text{Proj}(S)$. Since
$S_{+} \not \subset \mathfrak p$ we see that $X \not \in \mathfrak p$.
Thus if $aX^n \in \mathfrak p$ with $a \in R$ and $n > 0$, then
$a \in \mathfrak p$. It follows that $\mathfrak p = \mathfrak p_0S$
with $\mathfrak p_0 = \mathfrak p \cap R$.
\end{example}

\noindent
If $\mathfrak p \in \text{Proj}(S)$, then we
define $S_{(\mathfrak p)}$ to be the ring whose
elements are fractions $r/f$ where $r, f \in S$ are homogeneous
elements of the same degree such that $f \not\in \mathfrak p$.
As usual we say $r/f = r'/f'$ if and only if there exists
some $f'' \in S$ homogeneous, $f'' \not \in \mathfrak p$ such
that $f''(rf' - r'f) = 0$.
Given a graded $S$-module $M$ we let
$M_{(\mathfrak p)}$ be the $S_{(\mathfrak p)}$-module
whose elements are fractions $x/f$ with $x \in M$
and $f \in S$ homogeneous of the same degree such that
$f \not \in \mathfrak p$. We say $x/f = x'/f'$
if and only if there exists some $f'' \in S$ homogeneous,
$f'' \not \in \mathfrak p$ such that $f''(xf' - x'f) = 0$.

\begin{lemma}
\label{lemma-proj-prime}
Let $S$ be a graded ring. Let $M$ be a graded $S$-module.
Let $\mathfrak p$ be an element of $\text{Proj}(S)$.
Let $f \in S$ be a homogeneous element of positive degree
such that $f \not \in \mathfrak p$, i.e., $\mathfrak p \in D_{+}(f)$.
Let $\mathfrak p' \subset S_{(f)}$ be the element of
$\Spec(S_{(f)})$ corresponding to $\mathfrak p$ as in
Lemma \ref{lemma-topology-proj}. Then
$S_{(\mathfrak p)} = (S_{(f)})_{\mathfrak p'}$
and compatibly
$M_{(\mathfrak p)} = (M_{(f)})_{\mathfrak p'}$.
\end{lemma}

\begin{proof}
We define a map $\psi : M_{(\mathfrak p)} \to (M_{(f)})_{\mathfrak p'}$.
Let $x/g \in M_{(\mathfrak p)}$. We set
$$
\psi(x/g) = (x g^{\deg(f) - 1}/f^{\deg(x)})/(g^{\deg(f)}/f^{\deg(g)}).
$$
This makes sense since $\deg(x) = \deg(g)$ and since
$g^{\deg(f)}/f^{\deg(g)} \not \in \mathfrak p'$.
We omit the verification that $\psi$ is well defined, a module map
and an isomorphism. Hint: the inverse sends $(x/f^n)/(g/f^m)$ to
$(xf^m)/(g f^n)$.
\end{proof}

\noindent
Here is a graded variant of Lemma \ref{lemma-silly}.

\begin{lemma}
\label{lemma-graded-silly}
Suppose $S$ is a graded ring, $\mathfrak p_i$, $i = 1, \ldots, r$
homogeneous prime ideals and $I \subset S_{+}$ a graded ideal.
Assume $I \not\subset \mathfrak p_i$ for all $i$. Then there
exists a homogeneous element $x\in I$ of positive degree such
that $x\not\in \mathfrak p_i$ for all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
The result is true for $r = 1$. Suppose the result holds for $r - 1$.
Pick $x \in I$ homogeneous of positive degree such that
$x \not \in \mathfrak p_i$ for all $i = 1, \ldots, r - 1$.
If $x \not\in \mathfrak p_r$ we are done. So assume $x \in \mathfrak p_r$.
If $I \mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$
then $I \subset \mathfrak p_r$ a contradiction.
Pick $y \in I\mathfrak p_1 \ldots \mathfrak p_{r-1}$ homogeneous
and $y \not \in \mathfrak p_r$. Then $x^{\deg(y)} + y^{\deg(x)}$ works.
\end{proof}

\begin{lemma}
\label{lemma-smear-out}
Let $S$ be a graded ring.
Let $\mathfrak p \subset S$ be a prime.
Let $\mathfrak q$ be the homogeneous ideal of $S$ generated by the
homogeneous elements of $\mathfrak p$. Then $\mathfrak q$ is a
prime ideal of $S$.
\end{lemma}

\begin{proof}
Suppose $f, g \in S$ are such that $fg \in \mathfrak q$.
Let $f_d$ (resp.\ $g_e$) be the homogeneous part of
$f$ (resp.\ $g$) of degree $d$ (resp.\ $e$). Assume $d, e$ are
maxima such that $f_d \not = 0$ and $g_e \not = 0$.
By assumption we can write $fg = \sum a_i f_i$ with
$f_i \in \mathfrak p$ homogeneous. Say $\deg(f_i) = d_i$.
Then $f_d g_e = \sum a_i' f_i$ with $a_i'$ to homogeneous
par of degree $d + e - d_i$ of $a_i$ (or $0$ if $d + e -d_i < 0$).
Hence $f_d \in \mathfrak p$ or $g_e \in \mathfrak p$. Hence
$f_d \in \mathfrak q$ or $g_e \in \mathfrak q$. In the first
case replace $f$ by $f - f_d$, in the second case replace
$g$ by $g - g_e$. Then still $fg \in \mathfrak q$ but the discrete
invariant $d + e$ has been decreased. Thus we may continue in this
fashion until either $f$ or $g$ is zero. This clearly shows that
$fg \in \mathfrak q$ implies either $f \in \mathfrak q$ or $g \in \mathfrak q$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-graded-ring-minimal-prime}
Let $S$ be a graded ring.
\begin{enumerate}
\item Any minimal prime of $S$ is a homogeneous ideal of $S$.
\item Given a homogeneous ideal $I \subset S$ any minimal
prime over $I$ is homogeneous.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion holds because the prime $\mathfrak q$ constructed in
Lemma \ref{lemma-smear-out} satisfies $\mathfrak q \subset \mathfrak p$.
The second because we may consider $S/I$ and apply the first part.
\end{proof}

\begin{lemma}
\label{lemma-dehomogenize-finite-type}
Let $R$ be a ring. Let $S$ be a graded $R$-algebra. Assume that
$S$ is of finite type over $R$. Then for every homogeneous $f \in S_{+}$
the ring $S_{(f)}$ is of finite type over $R$.
\end{lemma}

\begin{proof}
Choose $f_1, \ldots, f_n \in S$ which generate $S$ as an $R$-algebra.
We may assume that each $f_i$ is homogeneous (by decomposing each $f_i$
into its homogeneous components). An element of $S_{(f)}$ is a sum
of the form
$$
\sum\nolimits_{e\deg(f) =
\sum e_i\deg(f_i)} \lambda_{e_1 \ldots e_n} f_1^{e_1} \ldots f_n^{e_n}/f^e
$$
with $\lambda_{e_1 \ldots e_n} \in R$. Thus $S_{(f)}$ is generated
as an $R$-algebra by the $f_1^{e_1} \ldots f_n^{e_n} /f^e$ with the
property that $e\deg(f) = \sum e_i\deg(f_i)$. If $e_i \geq \deg(f)$
then we can write this as
$$
f_1^{e_1} \ldots f_n^{e_n}/f^e =
f_i^{\deg(f)}/f^{\deg(f_i)} \cdot
f_1^{e_1} \ldots f_i^{e_i - \deg(f)} \ldots f_n^{e_n}/f^{e - \deg(f_i)}
$$
Thus we only need the elements $f_i^{\deg(f)}/f^{\deg(f_i)}$ as well
as the elements $f_1^{e_1} \ldots f_n^{e_n} /f^e$ with
$e\deg(f) = \sum e_i\deg(f_i)$ and $e_i\leq \deg(f)$.
This is a finite list and we win.
\end{proof}

\begin{lemma}
\label{lemma-homogenize}
Let $R$ be a ring.
Let $R'$ be a finite type $R$-algebra, and let $M$ be a finite $R'$-module.
There exists a graded $R$-algebra $S$, a graded $S$-module $N$ and
an element $f \in S$ homogeneous of degree $1$ such that
\begin{enumerate}
\item $R' \cong S_{(f)}$ and $M \cong N_{(f)}$ (as modules),
\item $S_0 = R$ and $S$ is generated by finitely many elements
of degree $1$ over $R$, and
\item $N$ is a finite $S$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We may write $R' = R[x_1, \ldots, x_n]/I$ for some ideal $I$.
For an element $g \in R[x_1, \ldots, x_n]$ denote
$\tilde g \in R[x_0, \ldots, x_n]$ the element homogeneous of minimal
degree such that $g = \tilde g(1, x_1, \ldots, x_n)$.
Let $\tilde I \subset R[X_0, \ldots, X_n]$ generated by all
elements $\tilde g$, $g \in I$.
Set $S = R[X_0, \ldots, X_n]/\tilde I$ and denote $f$ the image
of $X_0$ in $S$. By construction we have an isomorphism
$$
S_{(f)} \longrightarrow R', \quad
X_i/X_0 \longmapsto x_i.
$$
To do the same thing with the module $M$ we choose a presentation
$$
M = (R')^{\oplus r}/\sum\nolimits_{j \in J} R'k_j
$$
with $k_j = (k_{1j}, \ldots, k_{rj})$. Let $d_{ij} = \deg(\tilde k_{ij})$.
Set $d_j = \max\{d_{ij}\}$. Set $K_{ij} = X_0^{d_j - d_{ij}}\tilde k_{ij}$
which is homogeneous of degree $d_j$. With this notation we set
$$
N = \Coker\Big(
\bigoplus\nolimits_{j \in J} S(-d_j) \xrightarrow{(K_{ij})} S^{\oplus r}
\Big)
$$
which works. Some details omitted.
\end{proof}




\section{Noetherian graded rings}
\label{section-noetherian-graded}

\noindent
A bit of theory on Noetherian graded rings including some material on
Hilbert polynomials.

\begin{lemma}
\label{lemma-S-plus-generated}
Let $S$ be a graded ring. A set of homogeneous elements
$f_i \in S_{+}$ generates $S$ as an algebra over $S_0$ if
and only if they generate $S_{+}$ as an ideal of $S$.
\end{lemma}

\begin{proof}
If the $f_i$ generate $S$ as an algebra over $S_0$ then every element
in $S_{+}$ is a polynomial without constant term in the $f_i$ and hence
$S_{+}$ is generated by the $f_i$ as an ideal. Conversely, suppose that
$S_{+} = \sum Sf_i$. We will prove that any element $f$ of $S$ can be written
as a polynomial in the $f_i$ with coefficients in $S_0$. It suffices
to do this for homogeneous elements. Say $f$ has degree $d$. Then we may
perform induction on $d$. The case $d = 0$ is immediate. If $d > 0$
then $f \in S_{+}$ hence we can write $f = \sum g_i f_i$
for some $g_i \in S$. As $S$ is graded we can replace $g_i$ by its
homogeneous component of degree $d - \deg(f_i)$. By induction we
see that each $g_i$ is a polynomial in the $f_i$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-graded-Noetherian}
A graded ring $S$ is Noetherian if and only if $S_0$ is
Noetherian and $S_{+}$ is finitely generated as an ideal of $S$.
\end{lemma}

\begin{proof}
It is clear that if $S$ is Noetherian then $S_0 = S/S_{+}$ is Noetherian
and $S_{+}$ is finitely generated. Conversely, assume $S_0$ is Noetherian
and $S_{+}$ finitely generated as an ideal of $S$. Pick generators
$S_{+} = (f_1, \ldots, f_n)$. By decomposing the $f_i$ into homogeneous
pieces we may assume each $f_i$ is homogeneous. By
Lemma \ref{lemma-S-plus-generated}
we see that $S_0[X_1, \ldots X_n] \to S$ sending $X_i$ to $f_i$
is surjective. Thus $S$ is Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{definition}
\label{definition-numerical-polynomial}
Let $A$ be an abelian group.
We say that a function $f : n \mapsto f(n) \in A$
defined for all sufficient large integers $n$ is a
{\it numerical polynomial} if there exists $r \geq 0$,
elements $a_0, \ldots, a_r\in A$ such that
$$
f(n) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i
$$
for all $n \gg 0$.
\end{definition}

\noindent
The reason for using the binomial coefficients is the
elementary fact that any polynomial $P \in \mathbf{Q}[T]$
all of whose values at integer points are integers, is
equal to a sum $P(T) = \sum a_i \binom{T}{i}$ with
$a_i \in \mathbf{Z}$. Note that in particular the
expressions $\binom{T + 1}{i + 1}$ are of this form.

\begin{lemma}
\label{lemma-numerical-polynomial-functorial}
If $A \to A'$ is a homomorphism of abelian groups and if
$f : n \mapsto f(n) \in A$ is a numerical polynomial,
then so is the composition.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-numerical-polynomial}
Suppose that $f: n \mapsto f(n) \in A$
is defined for all $n$ sufficiently large
and suppose that $n \mapsto f(n) - f(n-1)$
is a numerical polynomial. Then $f$ is a
numerical polynomial.
\end{lemma}

\begin{proof}
Let $f(n) - f(n-1) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i$
for all $n \gg 0$. Set
$g(n) = f(n) - \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$.
Then $g(n) - g(n-1) = 0$ for all $n \gg 0$. Hence $g$ is
eventually constant, say equal to $a_{-1}$. We leave it
to the reader to show that
$a_{-1} + \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$
has the required shape (see remark above the lemma).
\end{proof}

\begin{lemma}
\label{lemma-graded-module-fg}
If $M$ is a finitely generated graded $S$-module,
and if $S$ is finitely generated over $S_0$, then
each $M_n$ is a finite $S_0$-module.
\end{lemma}

\begin{proof}
Suppose the generators of $M$ are $m_i$ and the generators
of $S$ are $f_i$. By taking homogeneous components we may
assume that the $m_i$ and the $f_i$ are homogeneous
and we may assume $f_i \in S_{+}$. In this case it is
clear that each $M_n$ is generated over $S_0$
by the ``monomials'' $\prod f_i^{e_i} m_j$ whose
degree is $n$.
\end{proof}

\begin{proposition}
\label{proposition-graded-hilbert-polynomial}
Suppose that $S$ is a Noetherian graded ring
and $M$ a finite graded $S$-module. Consider the
function
$$
\mathbf{Z} \longrightarrow K_0'(S_0), \quad
n \longmapsto [M_n]
$$
see Lemma \ref{lemma-graded-module-fg}.
If $S_{+}$ is generated by elements of degree $1$,
then this function is a numerical polynomial.
\end{proposition}

\begin{proof}
We prove this by induction on the minimal number of
generators of $S_1$. If this number is $0$, then
$M_n = 0$ for all $n \gg 0$ and the result holds.
To prove the induction step, let $x\in S_1$
be one of a minimal set of generators, such that
the induction hypothesis applies to the
graded ring $S/(x)$.

\medskip\noindent
First we show the result holds if $x$ is nilpotent on $M$.
This we do by induction on the minimal integer $r$ such that
$x^r M  = 0$. If $r = 1$, then $M$ is a module over $S/xS$
and the result holds (by the other induction hypothesis).
If $r > 1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ such that the integers
$r', r''$ are strictly smaller than $r$. Thus we know
the result for $M''$ and $M'$. Hence
we get the result for $M$ because of the relation
$
[M_d]  = [M'_d] + [M''_d]
$
in $K_0'(S_0)$.

\medskip\noindent
If $x$ is not nilpotent on $M$, let $M' \subset M$ be
the largest submodule on which $x$ is nilpotent.
Consider the exact sequence $0 \to M' \to M \to M/M' \to 0$
we see again it suffices to prove the result for $M/M'$. In other
words we may assume that multiplication by $x$ is injective.

\medskip\noindent
Let $\overline{M} = M/xM$. Note that the map $x : M \to M$
is {\it not} a map of graded $S$-modules, since it does
not map $M_d$ into $M_d$. Namely, for each $d$ we have the
following short exact sequence
$$
0 \to M_d \xrightarrow{x} M_{d + 1} \to \overline{M}_{d + 1} \to 0
$$
This proves that $[M_{d + 1}] - [M_d] = [\overline{M}_{d + 1}]$.
Hence we win by Lemma \ref{lemma-numerical-polynomial}.
\end{proof}

\begin{remark}
\label{remark-period-polynomial}
If $S$ is still Noetherian but $S$ is not generated in degree $1$,
then the function associated to a graded $S$-module is a periodic
polynomial (i.e., it is a numerical polynomial on the
congruence classes of integers modulo $n$ for some $n$).
\end{remark}

\begin{example}
\label{example-hilbert-function}
Suppose that $S = k[X_1, \ldots, X_d]$.
By Example \ref{example-K0-field} we may identify
$K_0(k) = K_0'(k) = \mathbf{Z}$. Hence any finitely
generated graded $k[X_1, \ldots, X_d]$-module
gives rise to a numerical polynomial
$n \mapsto \dim_k(M_n)$.
\end{example}

\begin{lemma}
\label{lemma-quotient-smaller-d}
Let $k$ be a field. Suppose that $I \subset k[X_1, \ldots, X_d]$
is a nonzero graded ideal. Let $M = k[X_1, \ldots, X_d]/I$.
Then the numerical polynomial $n \mapsto \dim_k(M_n)$ (see
Example \ref{example-hilbert-function})
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{lemma}

\begin{proof}
The numerical polynomial associated to the graded module
$k[X_1, \ldots, X_d]$ is $n \mapsto \binom{n - 1 + d}{d - 1}$.
For any nonzero homogeneous $f \in I$ of degree $e$
and any degree $n >> e$ we have $I_n \supset f \cdot k[X_1, \ldots, X_d]_{n-e}$
and hence $\dim_k(I_n) \geq \binom{n - e - 1 + d}{d - 1}$. Hence
$\dim_k(M_n) \leq \binom{n - 1 + d}{d - 1} - \binom{n - e - 1 + d}{d - 1}$.
We win because the last expression
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{proof}








\section{Noetherian local rings}
\label{section-Noetherian-local}

\noindent
In all of this section $(R, \mathfrak m, \kappa)$ is a Noetherian local ring.
We develop some theory on Hilbert functions of modules in this section.
Let $M$ be a finite $R$-module. We define the {\it Hilbert function}
of $M$ to be the function
$$
\varphi_M : n
\longmapsto
\text{length}_R(\mathfrak m^nM/{\mathfrak m}^{n + 1}M)
$$
defined for all integers $n \geq 0$. Another important invariant is the
function
$$
\chi_M : n
\longmapsto
\text{length}_R(M/{\mathfrak m}^{n + 1}M)
$$
defined for all integers $n \geq 0$.
Note that we have by Lemma \ref{lemma-length-additive}
that
$$
\chi_M(n) = \sum\nolimits_{i = 0}^n \varphi_M(i).
$$
There is a variant of this construction which uses an ideal of definition.

\begin{definition}
\label{definition-ideal-definition}
Let $(R, \mathfrak m)$ be a local Noetherian ring.
An ideal $I \subset R$ such that $\sqrt{I} = \mathfrak m$ is called
{\it an ideal of definition of $R$}.
\end{definition}

\noindent
Let $I \subset R$ be an ideal of definition.
Because $R$ is Noetherian this means that
$\mathfrak m^r \subset I$ for some $r$, see Lemma
\ref{lemma-Noetherian-power}. Hence any finite $R$-module
annihilated by a power of $I$ has a finite length, see Lemma
\ref{lemma-length-finite}.
Thus it makes sense to define
$$
\varphi_{I, M}(n) = \text{length}_R(I^nM/I^{n + 1}M)
\quad\text{and}\quad
\chi_{I, M}(n) = \text{length}_R(M/I^{n + 1}M)
$$
for all $n \geq 0$. Again we have that
$$
\chi_{I, M}(n) = \sum\nolimits_{i = 0}^n \varphi_{I, M}(i).
$$

\begin{lemma}
\label{lemma-differ-finite}
Suppose that $M' \subset M$ are finite $R$-modules
with finite length quotient. Then there exists a
constants $c_1, c_2$ such that for all $n \geq c_2$ we have
$$
c_1 + \chi_{I, M'}(n - c_2) \leq \chi_{I, M}(n) \leq
c_1 + \chi_{I, M'}(n)
$$
\end{lemma}

\begin{proof}
Since $M/M'$ has finite length there is a $c_2 \geq 0$ such that
$I^{c_2}M \subset M'$. Let $c_1 = \text{length}_R(M/M')$.
For $n \geq c_2$ we have
\begin{eqnarray*}
\chi_{I, M}(n)
& = &
\text{length}_R(M/I^{n + 1}M) \\
& = &
c_1 + \text{length}_R(M'/I^{n + 1}M) \\
& \leq &
c_1 + \text{length}_R(M'/I^{n + 1}M') \\
& = &
c_1 + \chi_{I, M'}(n)
\end{eqnarray*}
On the other hand, since $I^{c_2}M \subset M'$,
we have $I^nM \subset I^{n - c_2}M'$ for $n \geq c_2$.
Thus for $n \geq c_2$ we get
\begin{eqnarray*}
\chi_{I, M}(n)
& = &
\text{length}_R(M/I^{n + 1}M) \\
& = &
c_1 + \text{length}_R(M'/I^{n + 1}M) \\
& \geq &
c_1 + \text{length}_R(M'/I^{n + 1 - c_2}M') \\
& = &
c_1 + \chi_{I, M'}(n - c_2)
\end{eqnarray*}
which finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
Then there exists a submodule $N \subset M'$ with
finite colength $l$ and $c \geq 0$ such that
$$
\chi_{I, M}(n) = \chi_{I, M''}(n) + \chi_{I, N}(n - c) + l
$$
and
$$
\varphi_{I, M}(n) = \varphi_{I, M''}(n) + \varphi_{I, N}(n - c)
$$
for all $n \geq c$.
\end{lemma}

\begin{proof}
Note that $M/I^nM \to M''/I^nM''$ is surjective
with kernel $M' / M' \cap I^nM$. By the Artin-Rees
Lemma \ref{lemma-Artin-Rees} there exists a
constant $c$ such that $M' \cap I^nM =
I^{n - c}(M' \cap I^cM)$. Denote $N = M' \cap I^cM$.
Note that $I^c M' \subset N \subset M'$.
Hence $\text{length}_R(M' / M' \cap I^nM)
= \text{length}_R(M'/N) + \text{length}_R(N/I^{n - c}N)$ for $n \geq c$.
From the short exact sequence
$$
0 \to M' / M' \cap I^nM \to M/I^nM \to M''/I^nM'' \to 0
$$
and additivity of lengths (Lemma \ref{lemma-length-additive})
we obtain the equality
$$
\chi_{I, M}(n - 1)
=
\chi_{I, M''}(n - 1)
+
\chi_{I, N}(n - c - 1)
+
\text{length}_R(M'/N)
$$
for $n \geq c$. We have
$\varphi_{I, M}(n) = \chi_{I, M}(n) - \chi_{I, M}(n - 1)$
and similarly for the modules $M''$ and $N$. Hence
we get $\varphi_{I, M}(n) = \varphi_{I, M''}(n) + \varphi_{I, N}(n-c)$ for
$n \geq c$.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-change-I}
Suppose that $I$, $I'$ are two ideals of definition
for the Noetherian local ring $R$. Let $M$ be a
finite $R$-module. There exists a constant $a$ such that
$\chi_{I, M}(n) \leq \chi_{I', M}(an)$ for $n \geq 1$.
\end{lemma}

\begin{proof}
There exists an integer $c$ such that $(I')^c \subset I$.
Hence we get a surjection $M/(I')^{c(n + 1)}M \to M/I^{n + 1}M$.
Whence the result with $a = c + 1$.
\end{proof}

\begin{proposition}
\label{proposition-hilbert-function-polynomial}
Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module.
Let $I \subset R$ be an ideal of definition.
The Hilbert function $\varphi_{I, M}$ and the function
$\chi_{I, M}$ are numerical polynomials.
\end{proposition}

\begin{proof}
Consider the graded ring $S = R/I \oplus I/I^2 \oplus I^2/I^3 \oplus
\ldots = \bigoplus_{d \geq 0} I^d/I^{d + 1}$. Consider the graded
$S$-module $N = M/IM \oplus IM/I^2M \oplus \ldots =
\bigoplus_{d \geq 0} I^dM/I^{d + 1}M$. This pair $(S, N)$ satisfies
the hypotheses of Proposition \ref{proposition-graded-hilbert-polynomial}.
Hence the result for $\varphi_{I, M}$ follows from that proposition and
Lemma \ref{lemma-length-K0}. The result for $\chi_{I, M}$ follows
from this and Lemma \ref{lemma-numerical-polynomial}.
\end{proof}

\begin{definition}
\label{definition-hilbert-polynomial}
Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module.
The {\it Hilbert polynomial} of $M$ over $R$ is the element
$P(t) \in \mathbf{Q}[t]$ such that $P(n) = \varphi_M(n)$ for $n \gg 0$.
\end{definition}

\noindent
By Proposition \ref{proposition-hilbert-function-polynomial}
we see that the Hilbert polynomial exists.

\begin{lemma}
\label{lemma-d-independent}
Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module.
\begin{enumerate}
\item The degree of the numerical polynomial $\varphi_{I, M}$ is independent
of the ideal of definition $I$.
\item The degree of the numerical polynomial $\chi_{I, M}$ is independent
of the ideal of definition $I$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows immediately from Lemma \ref{lemma-hilbert-change-I}.
Part (1) follows from (2) because
$\varphi_{I, M}(n) = \chi_{I, M}(n) - \chi_{I, M}(n - 1)$
for $n \geq 1$.
\end{proof}

\begin{definition}
\label{definition-d}
Let $R$ be a local Noetherian ring and $M$ a finite $R$-module.
We denote {\it $d(M)$} the element of $\{-\infty, 0, 1, 2, \ldots \}$
defined as follows:
\begin{enumerate}
\item If $M = 0$ we set $d(M) = -\infty$,
\item if $M \not = 0$ then $d(M)$ is the degree of the numerical
polynomial $\chi_M$.
\end{enumerate}
\end{definition}

\noindent
If $\mathfrak m^nM \not = 0$ for all $n$, then we see that
$d(M)$ is the degree $+1$ of the Hilbert polynomial of $M$.

\begin{lemma}
\label{lemma-differ-finite-chi}
Let $R$ be a Noetherian local ring. Let $I \subset R$ be an ideal
of definition. Let $M$ be a finite $R$-module
which does not have finite length. If $M' \subset M$ is a submodule
with finite colength, then $\chi_{I, M} - \chi_{I, M'}$
is a polynomial of degree $<$ degree of either polynomial.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-differ-finite} by elementary calculus.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses-chi}
Let $R$ be a Noetherian local ring. Let $I \subset R$ be an ideal of
definition. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence
of finite $R$-modules. Then
\begin{enumerate}
\item if $M'$ does not have finite length, then
$\chi_{I, M} - \chi_{I, M''} - \chi_{I, M'}$
is a numerical polynomial of degree $<$ the degree of
$\chi_{I, M'}$,
\item $\max\{ \deg(\chi_{I, M'}), \deg(\chi_{I, M''}) \} = \deg(\chi_{I, M})$,
and
\item $\max\{d(M'), d(M'')\} = d(M)$,
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove (1). Let $N \subset M'$ be as in Lemma \ref{lemma-hilbert-ses}.
By Lemma \ref{lemma-differ-finite-chi} the numerical polynomial
$\chi_{I, M'} - \chi_{I, N}$ has degree $<$ the common degree of
$\chi_{I, M'}$ and $\chi_{I, N}$. By Lemma \ref{lemma-hilbert-ses}
the difference
$$
\chi_{I, M}(n) - \chi_{I, M''}(n) - \chi_{I, N}(n - c)
$$
is constant for $n \gg 0$. By elementary calculus the difference
$\chi_{I, N}(n) - \chi_{I, N}(n - c)$ has degree $<$ the degree of
$\chi_{I, N}$ which is bigger than zero (see above). Putting everything
together we obtain (1).

\medskip\noindent
Note that the leading coefficients of $\chi_{I, M'}$ and $\chi_{I, M''}$ are
nonnegative. Thus the degree of $\chi_{I, M'} + \chi_{I, M''}$ is equal
to the maximum of the degrees. Thus if $M'$ does not have finite
length, then (2) follows from (1). If $M'$ does have finite length, then
$I^nM \to I^nM''$ is an isomorphism for all $n \gg 0$ by Artin-Rees
(Lemma \ref{lemma-Artin-Rees}). Thus $M/I^nM \to M''/I^nM''$ is a
surjection with kernel $M'$ for $n \gg 0$ and we see that
$\chi_{I, M}(n) - \chi_{I, M''}(n) = \text{length}(M')$
for all $n \gg 0$. Thus (2) holds in this case also.

\medskip\noindent
Proof of (3). This follows from (2) except if one of $M$, $M'$, or $M''$
is zero. We omit the proof in these special cases.
\end{proof}



































\section{Dimension}
\label{section-dimension}

\begin{definition}
\label{definition-Krull}
The {\it Krull dimension} of the ring $R$ is the
Krull dimension of the topological space $\Spec(R)$, see
Topology, Definition \ref{topology-definition-Krull}.
In other words it is the supremum of the integers $n\geq 0$
such that there exists a chain of prime ideals of length $n$:
$$
\mathfrak p_0
\subset
\mathfrak p_1
\subset
\ldots
\subset
\mathfrak p_n, \quad
\mathfrak p_i \not = \mathfrak p_{i + 1}.
$$
\end{definition}

\begin{definition}
\label{definition-height}
The {\it height} of a prime ideal $\mathfrak p$ of
a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.
\end{definition}

\begin{lemma}
\label{lemma-dimension-height}
The Krull dimension of $R$ is the supremum of the
heights of its (maximal) primes.
\end{lemma}

\begin{proof}
This is so because we can always add a maximal ideal at the end of a chain
of prime ideals.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-dimension-0}
A Noetherian ring of dimension $0$ is Artinian.
Conversely, any Artinian ring is Noetherian of dimension zero.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} the space $\Spec(R)$
is Noetherian. By Topology, Lemma \ref{topology-lemma-Noetherian} we see
that $\Spec(R)$ has finitely many irreducible
components, say $\Spec(R) = Z_1 \cup \ldots Z_r$.
According to Lemma \ref{lemma-irreducible}, each $Z_i = V(\mathfrak p_i)$
with $\mathfrak p_i$ a minimal ideal. Since the dimension is $0$
these $\mathfrak p_i$ are also maximal. Thus $\Spec(R)$
is the discrete topological space with elements $\mathfrak p_i$.
All elements $f$ of the radical $I = \cap \mathfrak p_i$
are nilpotent since otherwise $R_f$ would not be the zero ring
and we would have another prime. Since $I$ is finitely generated
we conclude that $I$ is nilpotent, Lemma \ref{lemma-Noetherian-power}.
By Lemma \ref{lemma-product-local} $R$ is the product of its
local rings. By Lemma \ref{lemma-length-finite} each of these
has finite length over $R$. Hence we conclude that $R$
is Artinian by Lemma \ref{lemma-artinian-finite-length}.

\medskip\noindent
If $R$ is Artinian then by Lemma \ref{lemma-artinian-finite-length}
it is Noetherian. All of its primes are maximal by a combination
of Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent} and \ref{lemma-product-local}.
\end{proof}

\noindent
In the following we will use the invariant $d(-)$ defined
in Definition \ref{definition-d}. Here is a warm up lemma.

\begin{lemma}
\label{lemma-dimension-0-d-0}
Let $R$ be a Noetherian local ring.
Then $\dim(R) = 0 \Leftrightarrow d(R) = 0$.
\end{lemma}

\begin{proof}
This is because $d(R) = 0$ if and only if $R$ has finite
length as an $R$-module. See Lemma \ref{lemma-artinian-finite-length}.
\end{proof}

\begin{proposition}
\label{proposition-dimension-zero-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is Artinian,
\item $R$ is Noetherian and $\dim(R) = 0$,
\item $R$ has finite length as a module over itself,
\item $R$ is a finite product of Artinian local rings,
\item $R$ is Noetherian and $\Spec(R)$ is a
finite discrete topological space,
\item $R$ is a finite product of Noetherian local rings
of dimension $0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ with $d(R_i) = 0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ whose maximal ideals are nilpotent,
\item $R$ is Noetherian, has finitely many maximal
ideals and its radical ideal is nilpotent, and
\item $R$ is Noetherian and there are no strict inclusions
among its primes.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-product-local},
\ref{lemma-artinian-finite-length},
\ref{lemma-Noetherian-dimension-0}, and
\ref{lemma-dimension-0-d-0}.
\end{proof}

\begin{lemma}
\label{lemma-height-1}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item
\label{item-dim-1}
$\dim(R) = 1$,
\item
\label{item-d-1}
$d(R) = 1$,
\item
\label{item-Vx}
there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $V(x) = \{\mathfrak m\}$,
\item
\label{item-x}
there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $\mathfrak m = \sqrt{(x)}$, and
\item
\label{item-ideal-1}
there exists an ideal of definition generated by $1$ element,
and no ideal of definition is generated by $0$ elements.
\end{enumerate}
\end{lemma}

\begin{proof}
First, assume that $\dim(R) = 1$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
Because the dimension is $1$ the only other prime of $R$
is $\mathfrak m$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Thus the only prime containing $x$ is $\mathfrak m$ and
hence (\ref{item-Vx}).

\medskip\noindent
If (\ref{item-Vx}) then $\mathfrak m = \sqrt{(x)}$ by
Lemma \ref{lemma-Zariski-topology}, and hence (\ref{item-x}).
The converse is clear as well.
The equivalence of (\ref{item-x}) and (\ref{item-ideal-1}) follows
from directly the definitions.

\medskip\noindent
Assume (\ref{item-ideal-1}).
Let $I = (x)$ be an ideal of definition.
Note that $I^n/I^{n + 1}$ is a quotient of $R/I$ via multiplication
by $x^n$ and hence $\text{length}_R(I^n/I^{n + 1})$ is bounded.
Thus $d(R) = 0$ or $d(R) = 1$, but $d(R) = 0$ is excluded
by the assumption that $0$ is not an ideal of definition.

\medskip\noindent
Assume (\ref{item-d-1}). To get a contradiction, assume there
exist primes $\mathfrak p \subset \mathfrak q \subset \mathfrak m$,
with both inclusions strict. Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq 1$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I, R/\mathfrak p} - \chi_{I, R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < 1$. In other words, $d(R/(xR + \mathfrak p) = 0$,
and hence $\dim(R/(xR + \mathfrak p)) = 0$, by
Lemma \ref{lemma-dimension-0-d-0}. But $R/(xR + \mathfrak p)$
has the distinct primes $\mathfrak q/(xR + \mathfrak p)$ and
$\mathfrak m/(xR + \mathfrak p)$ which gives the desired contradiction.
\end{proof}

\begin{proposition}
\label{proposition-dimension}
Let $R$ be a local Noetherian ring. Let $d \geq 0$ be an integer.
The following are equivalent:
\begin{enumerate}
\item
\label{item-dim-d}
$\dim(R) = d$,
\item
\label{item-d-d}
$d(R) = d$,
\item
\label{item-ideal-d}
there exists an ideal of definition generated by $d$ elements,
and no ideal of definition is generated by fewer than $d$ elements.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is really just the same as the proof of Lemma
\ref{lemma-height-1}. We will prove the proposition by induction
on $d$. By Lemmas \ref{lemma-dimension-0-d-0} and \ref{lemma-height-1}
we may assume that $d > 1$. Denote the minimal number of
generators for an ideal of definition of $R$ by $d'(R)$.
We will prove that the inequalities
$\dim(R) \geq d'(R) \geq d(R) \geq \dim(R)$,
and hence they are all equal.

\medskip\noindent
First, assume that $\dim(R) = d$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Note that every maximal chain of primes starts with some $\mathfrak p_i$,
hence the dimension of $R/xR$ is at most $d-1$. By induction
there are $x_2, \ldots, x_d$ which generate an ideal of definition
in $R/xR$. Hence $R$ has an ideal of definition generated
by (at most) $d$ elements.

\medskip\noindent
Assume $d'(R) = d$. Let $I = (x_1, \ldots, x_d)$ be an ideal
of definition. Note that $I^n/I^{n + 1}$ is a quotient of a direct
sum of $\binom{d + n - 1}{d - 1}$ copies $R/I$ via multiplication
by all degree $n$ monomials in $x_1, \ldots, x_n$.
Hence $\text{length}_R(I^n/I^{n + 1})$ is bounded by a polynomial
of degree $d-1$. Thus $d(R) \leq d$.

\medskip\noindent
Assume $d(R) = d$. Consider a chain of primes
$\mathfrak p \subset \mathfrak q \subset
\mathfrak q_2 \subset \ldots \subset \mathfrak p_e = \mathfrak m$,
with all inclusions strict, and $e \geq 2$.
Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq d$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I, R/\mathfrak p} - \chi_{I, R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < d$. In other words, $d(R/(xR + \mathfrak p)) \leq d - 1$,
and hence $\dim(R/(xR + \mathfrak p)) \leq d - 1$, by
induction. Now $R/(xR + \mathfrak p)$ has the chain of prime ideals
$\mathfrak q/(xR + \mathfrak p) \subset \mathfrak q_2/(xR + \mathfrak p)
\subset \ldots \subset \mathfrak q_e/(xR + \mathfrak p)$ which gives
$e - 1 \leq d - 1$. Since we started with an arbitrary chain of
primes this proves that $\dim(R) \leq d(R)$.

\medskip\noindent
Reading back the reader will see we proved the circular
inequalities as desired.
\end{proof}

\noindent
Let $(R, \mathfrak m)$ be a Noetherian local ring.
From the above it is clear that $\mathfrak m$ cannot be
generated by fewer than $\dim(R)$ variables.
By Nakayama's Lemma \ref{lemma-NAK} the minimal number
of generators of $\mathfrak m$ equals $\dim_{\kappa(\mathfrak m)}
\mathfrak m/\mathfrak m^2$. Hence we have the following
fundamental inequality
$$
\dim(R) \leq \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
It turns out that the rings where equality holds
have a lot of good properties. They are called
regular local rings.

\begin{definition}
\label{definition-regular-local}
Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $d$.
\begin{enumerate}
\item A {\it system of parameters of $R$} is a sequence of elements
$x_1, \ldots, x_d \in \mathfrak m$ which generates an ideal of
definition of $R$,
\item if there exist $x_1, \ldots, x_d \in \mathfrak m$
such that $\mathfrak m = (x_1, \ldots, x_d)$ then we call
$R$ a {\it regular local ring} and $x_1, \ldots, x_d$ a {\it regular
system of parameters}.
\end{enumerate}
\end{definition}

\noindent
The following lemmas are clear from the proofs of the
lemmas and proposition above, but we spell them out so we have
convenient references.

\begin{lemma}
\label{lemma-minimal-over-1}
Let $R$ be a Noetherian ring. Let $x \in R$.
\begin{enumerate}
\item If $\mathfrak p$ is minimal over $(x)$
then the height of $\mathfrak p$ is $0$ or $1$.
\item If $\mathfrak p, \mathfrak q \in \Spec(R)$ and $\mathfrak q$
is minimal over $(\mathfrak p, x)$, then there is no prime strictly
between $\mathfrak p$ and $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $\mathfrak p$ is minimal over $x$, then the only
prime ideal of $R_\mathfrak p$ containing $x$ is the maximal ideal
$\mathfrak p R_\mathfrak p$. This is true because the primes of
$R_\mathfrak p$ correspond $1$-to-$1$ with the primes of $R$ contained
in $\mathfrak p$, see Lemma \ref{lemma-spec-localization}.
Hence Lemma \ref{lemma-height-1} shows $\dim(R_\mathfrak p) = 1$
if $x$ is not nilpotent in $R_\mathfrak p$. Of course, if
$x$ is nilpotent in $R_\mathfrak p$ the argument gives that
$\mathfrak pR_\mathfrak p$ is the only prime ideal and we see
that the height is $0$.

\medskip\noindent
Proof of (2). By part (1) we see that $\mathfrak p/\mathfrak q$
is a prime of height $1$ or $0$ in $R/\mathfrak q$. This immediately
implies there cannot be a prime strictly between $\mathfrak p$
and $\mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-minimal-over-r}
Let $R$ be a Noetherian ring. Let $f_1, \ldots, f_r \in R$.
\begin{enumerate}
\item If $\mathfrak p$ is minimal over $(f_1, \ldots, f_r)$
then the height of $\mathfrak p$ is $\leq r$.
\item If $\mathfrak p, \mathfrak q \in \Spec(R)$ and
$\mathfrak q$ is minimal over $(\mathfrak p, f_1, \ldots, f_r)$,
then every chain of primes between $\mathfrak p$ and $\mathfrak q$
has length at most $r$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $\mathfrak p$ is minimal over $f_1, \ldots, f_r$,
then the only prime ideal of $R_\mathfrak p$ containing $f_1, \ldots, f_r$
is the maximal ideal $\mathfrak p R_\mathfrak p$. This is true because
the primes of $R_\mathfrak p$ correspond $1$-to-$1$ with the primes of
$R$ contained in $\mathfrak p$, see Lemma \ref{lemma-spec-localization}.
Hence Proposition \ref{proposition-dimension} shows
$\dim(R_\mathfrak p) \leq r$.

\medskip\noindent
Proof of (2). By part (1) we see that $\mathfrak p/\mathfrak q$
is a prime of height $\leq r$. This immediately
implies the statement about chains of primes between $\mathfrak p$
and $\mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-one-equation}
Suppose that $R$ is a Noetherian local ring and $x\in \mathfrak m$ an
element of its maximal ideal. Then $\dim R \leq \dim R/xR + 1$.
If $x$ is not contained in any of the minimal primes of $R$
then equality holds. (For example if $x$ is a nonzerodivisor.)
\end{lemma}

\begin{proof}
If $x_1, \ldots, x_{\dim R/xR} \in R$ map to elements of $R/xR$ which
generate an ideal of definition for $R/xR$, then $x, x_1, \ldots,
x_{\dim R/xR}$ generate an ideal of definition for $R$. Hence
the inequality by Proposition \ref{proposition-dimension}.
On the other hand, if $x$ is not contained in any minimal
prime of $R$, then the chains of primes in $R/xR$ all give
rise to chains in $R$ which are at least one step away
from being maximal.
\end{proof}

\begin{lemma}
\label{lemma-elements-generate-ideal-definition}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
Suppose $x_1, \ldots, x_d \in \mathfrak m$ generate an
ideal of definition and $d = \dim(R)$. Then
$\dim(R/(x_1, \ldots, x_i)) = d - i$ for all $i = 1, \ldots, d$.
\end{lemma}

\begin{proof}
Follows either from the proof of Proposition \ref{proposition-dimension},
or by using induction on $d$ and Lemma \ref{lemma-one-equation}.
\end{proof}







\section{Applications of dimension theory}
\label{section-applications-dimension-theory}

\noindent
We can use the results on dimension to prove certain rings
have infinite spectra and to produce more Jacobson rings.

\begin{lemma}
\label{lemma-Noetherian-local-domain-dim-2-infinite-opens}
Let $R$ be a Noetherian local domain of dimension $\geq 2$.
A nonempty open subset $U \subset \Spec(R)$ is
infinite.
\end{lemma}

\begin{proof}
To get a contradiction, assume that $U \subset \Spec(R)$ is finite.
In this case $(0) \in U$ and $\{(0)\}$ is an open subset of $U$ (because
the complement of $\{(0)\}$ is the union of the closures of the other points).
Thus we may assume $U = \{(0)\}$.
Let $\mathfrak m \subset R$ be the maximal ideal.
We can find an $x \in \mathfrak m$, $x \not = 0$ such that
$V(x) \cup U = \Spec(R)$. In other words we see that
$D(x) = \{(0)\}$. In particular we see
that $\dim(R/xR) = \dim(R) - 1 \geq 1$, see Lemma \ref{lemma-one-equation}.
Let $\overline{y}_2, \ldots, \overline{y}_{\dim(R)} \in R/xR$ generate
an ideal of definition of $R/xR$, see Proposition \ref{proposition-dimension}.
Choose lifts $y_2, \ldots, y_{\dim(R)} \in R$, so that
$x, y_2, \ldots, y_{\dim(R)}$ generate an ideal of definition in $R$.
This implies that $\dim(R/(y_2)) = \dim(R) - 1$ and
$\dim(R/(y_2, x)) = \dim(R) - 2$, see
Lemma \ref{lemma-elements-generate-ideal-definition}.
Hence there exists a prime
$\mathfrak p$ containing $y_2$ but not $x$. This contradicts
the fact that $D(x) = \{(0)\}$.
\end{proof}

\noindent
The rings $k[[t]]$ where $k$ is a field, or the ring of $p$-adic
numbers are Noetherian rings of dimension $1$ with finitely many primes.
This is the maximum dimension for which this can happen.

\begin{lemma}
\label{lemma-Noetherian-finite-nr-primes}
A Noetherian ring with finitely many primes has dimension $\leq 1$.
\end{lemma}

\begin{proof}
Let $R$ be a Noetherian ring with finitely many primes.
If $R$ is a local domain, then the lemma follows from
Lemma \ref{lemma-Noetherian-local-domain-dim-2-infinite-opens}.
If $R$ is a domain, then $R_\mathfrak m$ has dimension $\leq 1$
for all maximal ideals $\mathfrak m$ by the local case.
Hence $\dim(R) \leq 1$ by Lemma \ref{lemma-dimension-height}.
If $R$ is general, then $\dim(R/\mathfrak q) \leq 1$
for every minimal prime $\mathfrak q$ of $R$.
Since every prime contains a minimal prime
(Lemma \ref{lemma-Zariski-topology}), this implies $\dim(R) \leq 1$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-algebra-finite-nr-primes}
Let $S$ be a nonzero finite type algebra over a field $k$.
Then $\dim(S) = 0$ if and only if $S$ has
finitely many primes.
\end{lemma}

\begin{proof}
Recall that $\Spec(S)$ is sober, Noetherian, and Jacobson, see
Lemmas \ref{lemma-spec-spectral}, \ref{lemma-Noetherian-topology},
\ref{lemma-finite-type-field-Jacobson}, and \ref{lemma-jacobson}.
If it has dimension $0$, then every point defines an
irreducible component and there are only a finite number
of irreducible components (Topology, Lemma \ref{topology-lemma-Noetherian}).
Conversely, if $\Spec(S)$ is finite, then it is discrete
by Topology, Lemma \ref{topology-lemma-finite-jacobson}
and hence the dimension is $0$.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-dim-1-Jacobson}
Noetherian Jacobson rings.
\begin{enumerate}
\item Any Noetherian domain $R$ of dimension $1$
with infinitely many primes is Jacobson.
\item Any Noetherian ring such that every prime
$\mathfrak p$ is either maximal or contained in
infinitely many prime ideals is Jacobson.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a reformulation of Lemma \ref{lemma-pid-jacobson}.

\medskip\noindent
Let $R$ be a Noetherian ring such that
every non-maximal prime $\mathfrak p$ is contained
in infinitely many prime ideals.
Assume $\Spec(R)$ is not Jacobson to get
a contradiction.
By Lemmas \ref{lemma-irreducible}
and \ref{lemma-Noetherian-topology}
we see that $\Spec(R)$ is a sober, Noetherian topological space.
By Topology, Lemma \ref{topology-lemma-non-jacobson-Noetherian-characterize}
we see that there exists a non-maximal ideal $\mathfrak p \subset R$
such that $\{\mathfrak p\}$ is a locally closed subset of
$\Spec(R)$. In other words, $\mathfrak p$ is not maximal
and $\{\mathfrak p\}$ is an open subset of $V(\mathfrak p)$.
Consider a prime $\mathfrak q \subset R$ with
$\mathfrak p \subset \mathfrak q$. Recall that the topology on the spectrum of
$(R/\mathfrak p)_{\mathfrak q} = R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$
is induced from that of $\Spec(R)$, see Lemmas
\ref{lemma-spec-localization} and \ref{lemma-spec-closed}.
Hence we see that $\{(0)\}$ is a locally closed subset of
$\Spec((R/\mathfrak p)_{\mathfrak q})$. By
Lemma \ref{lemma-Noetherian-local-domain-dim-2-infinite-opens}
we conclude that $\dim((R/\mathfrak p)_{\mathfrak q}) = 1$.
Since this holds for every $\mathfrak q \supset \mathfrak p$
we conclude that $\dim(R/\mathfrak p) = 1$. At this point we use
the assumption that $\mathfrak p$ is contained in infinitely many
primes to see that $\Spec(R/\mathfrak p)$ is infinite.
Hence by part (1) of the lemma we see that
$V(\mathfrak p) \cong \Spec(R/\mathfrak p)$
is the closure of its closed points.
This is the desired contradiction since it means that
$\{\mathfrak p\} \subset V(\mathfrak p)$ cannot be open.
\end{proof}




















\section{Support and dimension of modules}
\label{section-support}

\begin{lemma}
\label{lemma-filter-Noetherian-module}
Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-trivial-filter-finite-module}
it suffices to do the case $M = R/I$ for some ideal $I$.
Consider the set $S$ of ideals $J$ such that the lemma
does not hold for the module $R/J$, and order it by
inclusion. To arrive at a
contradiction, assume that $S$ is not empty. Because
$R$ is Noetherian, $S$ has a maximal element $J$.
By definition of $S$, the ideal $J$ cannot be prime.
Pick $a, b\in R$ such that $ab \in J$, but neither
$a \in J$ nor $b\in J$. Consider the filtration
$0 \subset aR/(J \cap aR) \subset R/J$.
Note that $aR/(J \cap aR)$ is a quotient of $R/(J + bR)$
and the second quotient equals $R/(aR + J)$. Hence by
maximality of $J$, each of these has a filtration as
above and hence so does $R/J$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-filter-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
Then $\text{Supp}(M) = \bigcup V(\mathfrak p_i)$
and in particular $\mathfrak p_i \in \text{Supp}(M)$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-support-closed} and
\ref{lemma-support-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-support-point}
Suppose that $R$ is a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $M$ be a nonzero finite
$R$-module. Then $\text{Supp}(M) = \{ \mathfrak m\}$
if and only if $M$ has finite length over $R$.
\end{lemma}

\begin{proof}
Assume that $\text{Supp}(M) = \{ \mathfrak m\}$.
It suffices to show that all the primes $\mathfrak p_i$
in the filtration of Lemma \ref{lemma-filter-Noetherian-module}
are the maximal ideal. This is clear by
Lemma \ref{lemma-filter-primes-in-support}.

\medskip\noindent
Suppose that $M$ has finite length over $R$.
Then $\mathfrak m^n M = 0$ by Lemma \ref{lemma-length-infinite}.
Since some element of $\mathfrak m$ maps to a unit
in $R_{\mathfrak p}$ for any prime
$\mathfrak p \not = \mathfrak m$ in $R$ we see $M_{\mathfrak p} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power-ideal-kills-module}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Then $I^nM = 0$ for some $n \geq 0$ if and only if
$\text{Supp}(M) \subset V(I)$.
\end{lemma}

\begin{proof}
It is clear that $I^nM = 0$ for some $n \geq 0$ implies
$\text{Supp}(M) \subset V(I)$. Suppose that $\text{Supp}(M) \subset V(I)$.
Choose a filtration $0 = M_0 \subset M_1 \subset \ldots \subset M_n = M$
as in Lemma \ref{lemma-filter-Noetherian-module}. Each of the primes
$\mathfrak p_i$ is contained in $V(I)$ by
Lemma \ref{lemma-filter-primes-in-support}.
Hence $I \subset \mathfrak p_i$ and $I$ annihilates $M_i/M_{i - 1}$.
Hence $I^n$ annihilates $M$.
\end{proof}

\begin{lemma}
\label{lemma-filter-minimal-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
The minimal elements of the set $\{\mathfrak p_i\}$
are the minimal elements of $\text{Supp}(M)$.
The number of times a minimal prime $\mathfrak p$
occurs is
$$
\#\{i \mid \mathfrak p_i = \mathfrak p\}
=
\text{length}_{R_\mathfrak p} M_{\mathfrak p}.
$$
\end{lemma}

\begin{proof}
The first statement follows because
$\text{Supp}(M) = \bigcup V(\mathfrak p_i)$, see
Lemma \ref{lemma-filter-primes-in-support}.
Let $\mathfrak p \in \text{Supp}(M)$ be minimal.
The support of $M_{\mathfrak p}$ is the set
consisting of the maximal ideal $\mathfrak p R_{\mathfrak p}$.
Hence by Lemma \ref{lemma-support-point} the length
of $M_{\mathfrak p}$ is finite and $>0$. Next we
note that $M_{\mathfrak p}$ has a filtration with subquotients
$
(R/\mathfrak p_i)_{\mathfrak p}
=
R_{\mathfrak p}/{\mathfrak p_i}R_{\mathfrak p}
$
These are zero if $\mathfrak p_i \not \subset \mathfrak p$
and equal to $\kappa(\mathfrak p)$ if $\mathfrak p_i \subset
\mathfrak p$ because by minimality of $\mathfrak p$
we have $\mathfrak p_i = \mathfrak p$ in this case.
The result follows since $\kappa(\mathfrak p)$ has length $1$.
\end{proof}

\begin{lemma}
\label{lemma-support-dimension-d}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $d(M) = \dim(\text{Supp}(M))$.
\end{lemma}

\begin{proof}
Let $M_i, \mathfrak p_i$ be as in Lemma \ref{lemma-filter-Noetherian-module}.
By Lemma \ref{lemma-hilbert-ses-chi} we obtain the equality
$d(M) = \max \{ d(R/\mathfrak p_i) \}$. By
Proposition \ref{proposition-dimension} we have
$d(R/\mathfrak p_i) = \dim(R/\mathfrak p_i)$.
Trivially $\dim(R/\mathfrak p_i) = \dim V(\mathfrak p_i)$.
Since all minimal primes of $\text{Supp}(M)$ occur among
the $\mathfrak p_i$ (Lemma \ref{lemma-filter-minimal-primes-in-support}) we win.
\end{proof}

\begin{lemma}
\label{lemma-ses-dimension}
Let $R$ be a Noetherian ring. Let $0 \to M' \to M \to M'' \to 0$
be a short exact sequence of finite $R$-modules. Then
$\max\{\dim(\text{Supp}(M')), \dim(\text{Supp}(M''))\} =
\dim(\text{Supp}(M))$.
\end{lemma}

\begin{proof}
If $R$ is local, this follows immediately from
Lemmas \ref{lemma-support-dimension-d} and \ref{lemma-hilbert-ses-chi}.
A more elementary argument, which works also if $R$ is not local,
is to use that $\text{Supp}(M')$, $\text{Supp}(M'')$, and
$\text{Supp}(M)$ are closed (Lemma \ref{lemma-support-closed})
and that $\text{Supp}(M) = \text{Supp}(M') \cup \text{Supp}(M'')$
(Lemma \ref{lemma-support-quotient}).
\end{proof}










\section{Associated primes}
\label{section-ass}

\noindent
Here is the standard definition. For non-Noetherian rings and non-finite
modules it may be more appropriate to use the definition in
Section \ref{section-weakly-ass}.

\begin{definition}
\label{definition-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it associated} to $M$
if there exists an element $m \in M$ whose annihilator
is $\mathfrak p$.
The set of all such primes is denoted $\text{Ass}_R(M)$
or $\text{Ass}(M)$.
\end{definition}

\begin{lemma}
\label{lemma-ass-support}
Let $R$ be a ring. Let $M$ be an $R$-module.
Then $\text{Ass}(M) \subset \text{Supp}(M)$.
\end{lemma}

\begin{proof}
If $m \in M$ has annihilator $\mathfrak p$, then in particular
no element of $R \setminus \mathfrak p$ annihilates $m$.
Hence $m$ is a nonzero element of $M_{\mathfrak p}$, i.e.,
$\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-ass}
Let $R$ be a ring.
Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence
of $R$-modules.
Then $\text{Ass}(M') \subset \text{Ass}(M)$ and
$\text{Ass}(M) \subset \text{Ass}(M') \cup \text{Ass}(M'')$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-ass-filter}
Let $R$ be a ring, and $M$ an $R$-module.
Suppose there exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic to $R/\mathfrak p_i$
for some prime ideal $\mathfrak p_i$ of $R$.
Then $\text{Ass}(M) \subset \{\mathfrak p_1, \ldots, \mathfrak p_n\}$.
\end{lemma}

\begin{proof}
By induction on the length $n$ of the filtration $\{ M_i \}$.
Pick $m \in M$ whose annihilator is a prime $\mathfrak p$.
If $m \in M_{n-1}$ we are done by induction. If not,
then $m$ maps to a nonzero element of $M/M_{n-1} \cong
R/\mathfrak p_n$. Hence we have $\mathfrak p \subset \mathfrak p_n$.
If equality does not hold, then we can find $f \in \mathfrak p_n$,
$f \not\in \mathfrak p$. In this case the annihilator of $fm$ is still
$\mathfrak p$ and $fm \in M_{n-1}$. Thus we win by induction.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Then $\text{Ass}(M)$ is finite.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ass-filter} and
Lemma \ref{lemma-filter-Noetherian-module}.
\end{proof}

\begin{proposition}
\label{proposition-minimal-primes-associated-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following sets of primes are the same:
\begin{enumerate}
\item The minimal primes in the support of $M$.
\item The minimal primes in $\text{Ass}(M)$.
\item For any filtration $0 = M_0 \subset M_1 \subset \ldots
\subset M_{n-1} \subset M_n = M$ with $M_i/M_{i-1} \cong R/\mathfrak p_i$
the minimal primes of the set $\{\mathfrak p_i\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
Choose a filtration as in (3).
In Lemma \ref{lemma-filter-minimal-primes-in-support}
we have seen that the sets in (1) and (3) are equal.

\medskip\noindent
Let $\mathfrak p$ be a minimal element of the set $\{\mathfrak p_i\}$.
Let $i$ be minimal such that $\mathfrak p = \mathfrak p_i$.
Pick $m \in M_i$, $m \not \in M_{i-1}$. The annihilator of $m$
is contained in $\mathfrak p_i = \mathfrak p$ and contains
$\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_i$. By our choice of
$i$ and $\mathfrak p$ we have $\mathfrak p_j \not \subset \mathfrak p$
for $j < i$ and hence we have
$\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i - 1}
\not \subset \mathfrak p_i$. Pick
$f \in \mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i - 1}$,
$f \not \in \mathfrak p$. Then $fm$ has annihilator $\mathfrak p$.
In this way we see that $\mathfrak p$ is an associated prime of $M$.
By Lemma \ref{lemma-ass-support} we have $\text{Ass}(M) \subset \text{Supp}(M)$
and hence $\mathfrak p$ is minimal in $\text{Ass}(M)$.
Thus the set of primes in (1) is contained in the set of primes of (2).

\medskip\noindent
Let $\mathfrak p$ be a minimal element of $\text{Ass}(M)$.
Since $\text{Ass}(M) \subset \text{Supp}(M)$ there is a minimal
element $\mathfrak q$ of $\text{Supp}(M)$ with
$\mathfrak q \subset \mathfrak p$. We have just shown that
$\mathfrak q \in \text{Ass}(M)$. Hence $\mathfrak q = \mathfrak p$
by minimality of $\mathfrak p$. Thus the set of primes in (2) is
contained in the set of primes of (1).
\end{proof}

\begin{lemma}
\label{lemma-ass-zero}
\begin{slogan}
Over a Noetherian ring each nonzero module has an associated prime.
\end{slogan}
Let $R$ be a Noetherian ring. Let $M$ be an $R$-module.
Then
$$
M = (0) \Leftrightarrow \text{Ass}(M) = \emptyset.
$$
\end{lemma}

\begin{proof}
If $M = (0)$, then $\text{Ass}(M) = \emptyset$ by definition.
If $M \not = 0$, pick any nonzero finitely generated submodule
$M' \subset M$, for example a submodule generated by a single nonzero
element. By
Lemma \ref{lemma-support-zero}
we see that $\text{Supp}(M')$ is nonempty. By
Proposition \ref{proposition-minimal-primes-associated-primes}
this implies that $\text{Ass}(M')$ is nonempty.
By
Lemma \ref{lemma-ass}
this implies $\text{Ass}(M) \not = \emptyset$.
\end{proof}

\begin{lemma}
\label{lemma-ass-minimal-prime-support}
Let $R$ be a Noetherian ring.
Let $M$ be an $R$-module.
Any $\mathfrak p \in \text{Supp}(M)$ which is minimal among the elements
of $\text{Supp}(M)$ is an element of $\text{Ass}(M)$.
\end{lemma}

\begin{proof}
If $M$ is a finite $R$-module, then this is a consequence of
Proposition \ref{proposition-minimal-primes-associated-primes}.
In general write $M = \bigcup M_\lambda$ as the union of its
finite submodules, and use that
$\text{Supp}(M) = \bigcup \text{Supp}(M_\lambda)$
and
$\text{Ass}(M) = \bigcup \text{Ass}(M_\lambda)$.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero-divisors}
Let $R$ be a Noetherian ring.
Let $M$ be an $R$-module.
The union $\bigcup_{\mathfrak q \in \text{Ass}(M)} \mathfrak q$
is the set of elements of $R$ which are zerodivisors on $M$.
\end{lemma}

\begin{proof}
Any element in any associated prime clearly is a zerodivisor on $M$.
Conversely, suppose $x \in R$ is a zerodivisor on $M$.
Consider the submodule $N = \{m \in M \mid xm = 0\}$.
Since $N$ is not zero it has an associated prime $\mathfrak q$ by
Lemma \ref{lemma-ass-zero}.
Then $x \in \mathfrak q$ and $\mathfrak q$
is an associated prime of $M$ by
Lemma \ref{lemma-ass}.
\end{proof}

\begin{lemma}
\label{lemma-one-equation-module}
Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and
$f \in \mathfrak m$ an element of the maximal ideal of $R$. Then
$$
\dim(\text{Supp}(M/fM)) \leq
\dim(\text{Supp}(M)) \leq
\dim(\text{Supp}(M/fM)) + 1
$$
If $f$ is not in any of the minimal primes of the support of $M$
(for example if $f$ is a nonzerodivisor on $M$), then equality
holds for the right inequality.
\end{lemma}

\begin{proof}
(The parenthetical statement follows from Lemma \ref{lemma-ass-zero-divisors}.)
The first inequality follows from $\text{Supp}(M/fM) \subset \text{Supp}(M)$,
see Lemma \ref{lemma-support-quotient}. For the second inequality, note
that $\text{Supp}(M/fM) = \text{Supp}(M) \cap V(f)$, see
Lemma \ref{lemma-support-quotient}. It follows, for example by
Lemma \ref{lemma-filter-primes-in-support} and elementary properties
of dimension, that it suffices to show
$\dim V(\mathfrak p) \leq \dim (V(\mathfrak p) \cap V(f)) + 1$
for primes $\mathfrak p$ of $R$. This is a consequence of
Lemma \ref{lemma-one-equation}.
Finally, if $f$ is not contained in any minimal
prime of the support of $M$, then the chains of primes in
$\text{Supp}(M/fM)$ all give
rise to chains in $\text{Supp}(M)$ which are at least one step away
from being maximal.
\end{proof}

\begin{lemma}
\label{lemma-ass-functorial}
Let $\varphi : R \to S$ be a ring map.
Let $M$ be an $S$-module.
Then $\Spec(\varphi)(\text{Ass}_S(M)) \subset \text{Ass}_R(M)$.
\end{lemma}

\begin{proof}
If $\mathfrak q \in \text{Ass}_S(M)$, then there exists an $m$ in $M$
such that the annihilator of $m$ in $S$ is $\mathfrak q$. Then the annihilator
of $m$ in $R$ is $\mathfrak q \cap R$.
\end{proof}

\begin{remark}
\label{remark-ass-reverse-functorial}
Let $\varphi : R \to S$ be a ring map.
Let $M$ be an $S$-module.
Then it is not always the case that
$\Spec(\varphi)(\text{Ass}_S(M)) \supset \text{Ass}_R(M)$.
For example, consider the ring map
$R = k \to S = k[x_1, x_2, x_3, \ldots]/(x_i^2)$ and $M = S$.
Then $\text{Ass}_R(M)$ is not empty, but $\text{Ass}_S(S)$ is empty.
\end{remark}

\begin{lemma}
\label{lemma-ass-functorial-Noetherian}
Let $\varphi : R \to S$ be a ring map.
Let $M$ be an $S$-module. If $S$ is Noetherian, then
$\Spec(\varphi)(\text{Ass}_S(M)) = \text{Ass}_R(M)$.
\end{lemma}

\begin{proof}
We have already seen in
Lemma \ref{lemma-ass-functorial}
that
$\Spec(\varphi)(\text{Ass}_S(M)) \subset \text{Ass}_R(M)$.
For the converse, choose a prime $\mathfrak p \in \text{Ass}_R(M)$.
Let $m \in M$ be an element such that the annihilator of $m$ in $R$
is $\mathfrak p$. Let $I = \{g \in S \mid gm = 0\}$ be the annihilator
of $m$ in $S$. Then $R/\mathfrak p \subset S/I$ is injective, hence
there exists a prime $\mathfrak q \subset S$ lying over $\mathfrak p$, see
Lemma \ref{lemma-injective-minimal-primes-in-image}.
By
Proposition \ref{proposition-minimal-primes-associated-primes}
we see that $\mathfrak q$ is an associated prime of $S/I$, hence
an associated prime of $M$ by
Lemma \ref{lemma-ass}
and we win.
\end{proof}

\begin{lemma}
\label{lemma-ass-quotient-ring}
Let $R$ be a ring.
Let $I$ be an ideal.
Let $M$ be an $R/I$-module.
Via the canonical injection
$\Spec(R/I) \to \Spec(R)$
we have $\text{Ass}_{R/I}(M) = \text{Ass}_R(M)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-associated-primes-localize}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $\mathfrak p \subset R$ be a prime.
\begin{enumerate}
\item If $\mathfrak p \in \text{Ass}(M)$ then
$\mathfrak pR_{\mathfrak p} \in \text{Ass}(M_{\mathfrak p})$.
\item If $\mathfrak p$ is finitely generated then the converse holds
as well.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak p \in \text{Ass}(M)$ there exists an element $m \in M$
whose annihilator is $\mathfrak p$. As localization is exact
(Proposition \ref{proposition-localization-exact})
we see that the annihilator of $m/1$ in
$M_{\mathfrak p}$ is $\mathfrak pR_{\mathfrak p}$ hence (1) holds.
Assume $\mathfrak pR_{\mathfrak p} \in \text{Ass}(M_{\mathfrak p})$
and $\mathfrak p = (f_1, \ldots, f_n)$. Let $m/g$ be an element of
$M_{\mathfrak p}$ whose annihilator is $\mathfrak pR_{\mathfrak p}$.
This implies that the annihilator of $m$ is contained in $\mathfrak p$.
As $f_i m/g = 0$ in $M_{\mathfrak p}$ we see there exists a
$g_i \in R$, $g_i \not \in \mathfrak p$ such that $g_i f_i m = 0$ in $M$.
Combined we see the annihilator of $g_1\ldots g_nm$ is $\mathfrak p$. Hence
$\mathfrak p \in \text{Ass}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-localize-ass}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $S \subset R$ be a multiplicative subset.
Via the canonical injection $\Spec(S^{-1}R) \to \Spec(R)$
we have
\begin{enumerate}
\item $\text{Ass}_R(S^{-1}M) = \text{Ass}_{S^{-1}R}(S^{-1}M)$,
\item
$\text{Ass}_R(M) \cap \Spec(S^{-1}R) \subset \text{Ass}_R(S^{-1}M)$, and
\item if $R$ is Noetherian this inclusion is an equality.
\end{enumerate}
\end{lemma}

\begin{proof}
The first equality follows, since if $m \in S^{-1}M$, then the annihilator
of $m$ in $R$ is the intersection of the annihilator of $m$ in $S^{-1}R$
with $R$.
The displayed inclusion and equality in the Noetherian case follows from
Lemma \ref{lemma-associated-primes-localize}
since for $\mathfrak p \in R$, $S \cap \mathfrak p = \emptyset$ we have
$M_{\mathfrak p} = (S^{-1}M)_{S^{-1}\mathfrak p}$.
\end{proof}

\begin{lemma}
\label{lemma-localize-ass-nonzero-divisors}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $S \subset R$ be a multiplicative subset.
Assume that every $s \in S$ is a nonzerodivisor on $M$.
Then
$$
\text{Ass}_R(M) = \text{Ass}_R(S^{-1}M).
$$
\end{lemma}

\begin{proof}
As $M \subset S^{-1}M$ by assumption we get the inclusion
$\text{Ass}(M) = \text{Ass}(S^{-1}M)$ from
Lemma \ref{lemma-ass}.
Conversely, suppose that $n/s \in S^{-1}M$ is an element whose
annihilator is a prime ideal $\mathfrak p$. Then the annihilator
of $n \in M$ is also $\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-ideal-nonzerodivisor}
Let $R$ be a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $I \subset \mathfrak m$
be an ideal. Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item There exists an $x \in I$ which is not a zerodivisor on $M$.
\item We have $I \not \subset \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
If there exists a nonzerodivisor $x$ in $I$,
then $x$ clearly cannot be in any associated
prime of $M$. Conversely, suppose $I \not \subset \mathfrak q$
for all $\mathfrak q \in \text{Ass}(M)$. In this case we can
choose $x \in I$, $x \not \in \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$ by Lemmas
\ref{lemma-finite-ass} and \ref{lemma-silly}.
By Lemma \ref{lemma-ass-zero-divisors} the element $x$
is not a zerodivisor on $M$.
\end{proof}

\begin{lemma}
\label{lemma-zero-at-ass-zero}
Let $R$ be a ring. Let $M$ be an $R$-module. If $R$ is Noetherian
the map
$$
M
\longrightarrow
\prod\nolimits_{\mathfrak p \in \text{Ass}(M)} M_{\mathfrak p}
$$
is injective.
\end{lemma}

\begin{proof}
Let $x \in M$ be an element of the kernel of the map.
Then if $\mathfrak p$ is an associated prime of $Rx \subset M$
we see on the one hand that $\mathfrak p \in \text{Ass}(M)$
(Lemma \ref{lemma-ass}) and
on the other hand that $(Rx)_{\mathfrak p} \subset M_{\mathfrak p}$
is not zero. This contradiction shows that $\text{Ass}(Rx) = \emptyset$.
Hence $Rx = 0$ by
Lemma \ref{lemma-ass-zero}.
\end{proof}


\section{Symbolic powers}
\label{section-symbolic-power}

\noindent
Here is the definition.

\begin{definition}
\label{definition-symbolic-power}
Let $R$ be a ring. Let $\mathfrak p$ be a prime ideal. For $n \geq 0$ the
$n$th {\it symbolic power} of $\mathfrak p$ is the ideal
$\mathfrak p^{(n)} = \Ker(R \to R_\mathfrak p/\mathfrak p^nR_\mathfrak p)$.
\end{definition}

\noindent
Note that $\mathfrak p^n \subset \mathfrak p^{(n)}$ but equality does
not always hold.

\begin{lemma}
\label{lemma-symbolic-power-associated}
Let $R$ be a Noetherian ring.
Let $\mathfrak p$ be a prime ideal.
Let $n > 0$. Then $\text{Ass}(R/\mathfrak p^{(n)}) = \{\mathfrak p\}$.
\end{lemma}

\begin{proof}
If $\mathfrak q$ is an associated prime of $R/\mathfrak p^{(n)}$
then clearly $\mathfrak p \subset \mathfrak q$.
On the other hand, any element $x \in R$, $x \not \in \mathfrak p$
is a nonzerodivisor on $R/\mathfrak p^{(n)}$.
Namely, if $y \in R$ and
$xy \in \mathfrak p^{(n)} = R \cap \mathfrak p^nR_{\mathfrak p}$
then $y \in \mathfrak p^nR_{\mathfrak p}$, hence $y \in \mathfrak p^{(n)}$.
Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-symbolic-power-flat-extension}
Let $R \to S$ be flat ring map. Let $\mathfrak p \subset R$ be a prime
such that $\mathfrak q = \mathfrak p S$ is a prime of $S$.
Then $\mathfrak p^{(n)} S = \mathfrak q^{(n)}$.
\end{lemma}

\begin{proof}
Since
$\mathfrak p^{(n)} = \Ker(R \to R_\mathfrak p/\mathfrak p^nR_\mathfrak p)$
we see using flatness that $\mathfrak p^{(n)} S$ is the kernel of the map
$S \to S_\mathfrak p/\mathfrak p^nS_\mathfrak p$. On the other hand
$\mathfrak q^{(n)}$ is the kernel of the map
$S \to S_\mathfrak q/\mathfrak q^nS_\mathfrak q =
S_\mathfrak q/\mathfrak p^nS_\mathfrak q$. Hence it suffices
to show that
$$
S_\mathfrak p/\mathfrak p^nS_\mathfrak p
\longrightarrow
S_\mathfrak q/\mathfrak p^nS_\mathfrak q
$$
is injective. Observe that the right hand module is the localization
of the left hand module by elements $f \in S$, $f \not \in \mathfrak q$.
Thus it suffices to show these elements are nonzerodivisors on
$S_\mathfrak p/\mathfrak p^nS_\mathfrak p$. By flatness, the module
$S_\mathfrak p/\mathfrak p^nS_\mathfrak p$ has a finite filtration whose
subquotients are
$$
\mathfrak p^iS_\mathfrak p/\mathfrak p^{i + 1}S_\mathfrak p
\cong \mathfrak p^iR_\mathfrak p/\mathfrak p^{i + 1}R_\mathfrak p
\otimes_{R_\mathfrak p} S_\mathfrak p \cong
V \otimes_{\kappa(\mathfrak p)} (S/\mathfrak q)_\mathfrak p
$$
where $V$ is a $\kappa(\mathfrak p)$ vector space. Thus $f$
acts invertibly as desired.
\end{proof}



\section{Relative assassin}
\label{section-relative-assassin}

\noindent
Discussion of relative assassins. Let $R \to S$ be a ring map.
Let $N$ be an $S$-module. In this situation we can introduce the following
sets of primes $\mathfrak q$ of $S$:
\begin{enumerate}
\item[$A$] with $\mathfrak p = R \cap \mathfrak q$ we have that
$\mathfrak q \in \text{Ass}_S(N \otimes_R \kappa(\mathfrak p))$,
\item[$A'$] with $\mathfrak p = R \cap \mathfrak q$ we have that
$\mathfrak q$ is in the image of
$\text{Ass}_{S \otimes \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p))$
under the canonical map
$\Spec(S \otimes_R \kappa(\mathfrak p)) \to \Spec(S)$,
\item[$A_{fin}$] with $\mathfrak p = R \cap \mathfrak q$ we have that
$\mathfrak q \in \text{Ass}_S(N/\mathfrak pN)$,
\item[$A'_{fin}$] for some prime $\mathfrak p' \subset R$ we have
$\mathfrak q \in \text{Ass}_S(N/\mathfrak p'N)$,
\item[$B$] for some $R$-module $M$ we have
$\mathfrak q \in \text{Ass}_S(N \otimes_R M)$, and
\item[$B_{fin}$] for some finite $R$-module $M$ we have
$\mathfrak q \in \text{Ass}_S(N \otimes_R M)$.
\end{enumerate}
Let us determine some of the relations between theses sets.

\begin{lemma}
\label{lemma-compare-relative-assassins}
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Let $A$, $A'$, $A_{fin}$, $B$, and $B_{fin}$ be the subsets of
$\Spec(S)$ introduced above.
\begin{enumerate}
\item We always have $A = A'$.
\item We always have $A_{fin} \subset A$,
$B_{fin} \subset B$, $A_{fin} \subset A'_{fin} \subset B_{fin}$
and $A \subset B$.
\item If $S$ is Noetherian, then $A = A_{fin}$ and $B = B_{fin}$.
\item If $N$ is flat over $R$, then $A = A_{fin} = A'_{fin}$ and $B = B_{fin}$.
\item If $R$ is Noetherian and $N$ is flat over $R$, then all of the sets
are equal, i.e., $A = A' = A_{fin} = A'_{fin} = B = B_{fin}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Some of the arguments in the proof will be repeated in the proofs of
later lemmas which are more precise than this one (because they deal
with a given module $M$ or a given prime $\mathfrak p$ and not with
the collection of all of them).

\medskip\noindent
Proof of (1). Let $\mathfrak p$ be a prime of $R$. Then we have
$$
\text{Ass}_S(N \otimes_R \kappa(\mathfrak p)) =
\text{Ass}_{S/\mathfrak pS}(N \otimes_R \kappa(\mathfrak p)) =
\text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p))
$$
the first equality by
Lemma \ref{lemma-ass-quotient-ring}
and the second by
Lemma \ref{lemma-localize-ass} part (1). This prove that $A = A'$.
The inclusion $A_{fin} \subset A'_{fin}$ is clear.

\medskip\noindent
Proof of (2). Each of the inclusions is immediate from the definitions
except perhaps $A_{fin} \subset A$ which follows from
Lemma \ref{lemma-localize-ass}
and the fact that we require $\mathfrak p = R \cap \mathfrak q$ in
the formulation of $A_{fin}$.

\medskip\noindent
Proof of (3). The equality $A = A_{fin}$ follows from
Lemma \ref{lemma-localize-ass} part (3)
if $S$ is Noetherian. Let $\mathfrak q = (g_1, \ldots, g_m)$ be a finitely
generated prime ideal of $S$.
Say $z \in N \otimes_R M$ is an element whose annihilator is $\mathfrak q$.
We may pick a finite submodule $M' \subset M$ such that $z$ is the
image of $z' \in N \otimes_R M'$. Then
$\text{Ann}_S(z') \subset \mathfrak q = \text{Ann}_S(z)$.
Since $N \otimes_R -$ commutes with colimits and since $M$ is the
directed colimit of finite $R$-modules we can find $M' \subset M'' \subset M$
such that the image $z'' \in N \otimes_R M''$ is annihilated by
$g_1, \ldots, g_m$. Hence $\text{Ann}_S(z'') = \mathfrak q$. This proves
that $B = B_{fin}$ if $S$ is Noetherian.

\medskip\noindent
Proof of (4). If $N$ is flat, then the functor $N \otimes_R -$ is exact.
In particular, if $M' \subset M$, then $N \otimes_R M' \subset N \otimes_R M$.
Hence if $z \in N \otimes_R M$ is an element whose annihilator
$\mathfrak q = \text{Ann}_S(z)$ is a prime, then we can pick any
finite $R$-submodule $M' \subset M$ such that $z \in N \otimes_R M'$
and we see that the annihilator of $z$ as an element of $N \otimes_R M'$
is equal to $\mathfrak q$. Hence $B = B_{fin}$. Let $\mathfrak p'$ be a
prime of $R$ and let $\mathfrak q$ be a prime of $S$ which is
an associated prime of $N/\mathfrak p'N$. This implies that
$\mathfrak p'S \subset \mathfrak q$. As $N$ is flat over $R$ we
see that $N/\mathfrak p'N$ is flat over the integral domain $R/\mathfrak p'$.
Hence every nonzero element of $R/\mathfrak p'$ is a nonzerodivisor on
$N/\mathfrak p'$. Hence none of these elements can map to an element of
$\mathfrak q$ and we conclude that $\mathfrak p' = R \cap \mathfrak q$.
Hence $A_{fin} = A'_{fin}$. Finally, by
Lemma \ref{lemma-localize-ass-nonzero-divisors}
we see that
$\text{Ass}_S(N/\mathfrak p'N) =
\text{Ass}_S(N \otimes_R \kappa(\mathfrak p'))$, i.e., $A'_{fin} = A$.

\medskip\noindent
Proof of (5). We only need to prove $A'_{fin} = B_{fin}$ as the other
equalities have been proved in (4). To see this let $M$ be a finite
$R$-module. By
Lemma \ref{lemma-filter-Noetherian-module}
there exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$. Since $N$ is flat we obtain a filtration by $S$-submodules
$$
0 = N \otimes_R M_0 \subset N \otimes_R M_1 \subset \ldots \subset
N \otimes_R M_n = N \otimes_R M
$$
such that each subquotient is isomorphic to $N/\mathfrak p_iN$. By
Lemma \ref{lemma-ass}
we conclude that
$\text{Ass}_S(N \otimes_R M) \subset \bigcup \text{Ass}_S(N/\mathfrak p_iN)$.
Hence we see that $B_{fin} \subset A'_{fin}$. Since the other inclusion is part
of (2) we win.
\end{proof}

\noindent
We define the relative assassin of $N$ over $S/R$ to be the
set $A = A'$ above. As a motivation we point out that it depends
only on the fibre modules $N \otimes_R \kappa(\mathfrak p)$
over the fibre rings. As in the case of the assassin of a module we
warn the reader that this notion makes most sense when the fibre
rings $S \otimes_R \kappa(\mathfrak p)$ are Noetherian, for example
if $R \to S$ is of finite type.

\begin{definition}
\label{definition-relative-assassin}
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
The {\it relative assassin of $N$ over $S/R$} is the set
$$
\text{Ass}_{S/R}(N)
=
\{ \mathfrak q \subset S \mid
\mathfrak q \in \text{Ass}_S(N \otimes_R \kappa(\mathfrak p))
\text{ with }\mathfrak p = R \cap \mathfrak q\}.
$$
This is the set named $A$ in
Lemma \ref{lemma-compare-relative-assassins}.
\end{definition}

\noindent
The spirit of the next few results is that they are about the relative
assassin, even though this may not be apparent.

\begin{lemma}
\label{lemma-bourbaki}
Let $R \to S$ be a ring map.
Let $M$ be an $R$-module, and let $N$ be an $S$-module.
If $N$ is flat as $R$-module, then
$$
\text{Ass}_S(M \otimes_R N)
\supset
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(M)} \text{Ass}_S(N/\mathfrak pN)
$$
and if $R$ is Noetherian then we have equality.
\end{lemma}

\begin{proof}
If $\mathfrak p \in \text{Ass}_R(M)$ then there exists an injection
$R/\mathfrak p \to M$. As $N$ is flat over $R$ we obtain an injection
$R/\mathfrak p \otimes_R N \to M \otimes_R N$. Since
$R/\mathfrak p \otimes_R N = N/\mathfrak pN$ we conclude that
$\text{Ass}_S(N/\mathfrak pN) \subset \text{Ass}_S(M \otimes_R N)$, see
Lemma \ref{lemma-ass}. Hence the right hand side is
contained in the left hand side.

\medskip\noindent
Write $M = \bigcup M_\lambda$ as the union of its finitely generated
$R$-submodules. Then also $N \otimes_R M = \bigcup N \otimes_R M_\lambda$
(as $N$ is $R$-flat). By definition of associated primes we see that
$\text{Ass}_S(N \otimes_R M) = \bigcup \text{Ass}_S(N \otimes_R M_\lambda)$
and $\text{Ass}_R(M) = \bigcup \text{Ass}(M_\lambda)$. Hence we may assume
$M$ is finitely generated.

\medskip\noindent
Let $\mathfrak q \in \text{Ass}_S(M \otimes_R N)$, and assume $R$ is
Noetherian and $M$
is a finite $R$-module. To finish the proof we have to show that
$\mathfrak q$ is an element of the right hand side. First we observe that
$\mathfrak qS_{\mathfrak q} \in
\text{Ass}_{S_{\mathfrak q}}((M \otimes_R N)_{\mathfrak q})$,
see Lemma \ref{lemma-associated-primes-localize}.
Let $\mathfrak p$ be the corresponding prime of $R$.
Note that
$$
(M \otimes_R N)_{\mathfrak q} = M \otimes_R N_{\mathfrak q}
= M_{\mathfrak p} \otimes_{R_{\mathfrak p}} N_{\mathfrak q}
$$
If
$\mathfrak pR_{\mathfrak p} \not \in
\text{Ass}_{R_{\mathfrak p}}(M_{\mathfrak p})$
then there exists an element $x \in \mathfrak pR_{\mathfrak p}$ which
is a nonzerodivisor in $M_{\mathfrak p}$ (see
Lemma \ref{lemma-ideal-nonzerodivisor}). Since
$N_{\mathfrak q}$ is flat over $R_{\mathfrak p}$ we see that
the image of $x$ in $\mathfrak qS_{\mathfrak q}$ is a nonzerodivisor on
$(M \otimes_R N)_{\mathfrak q}$. This is a contradiction
with the assumption that
$\mathfrak qS_{\mathfrak q} \in \text{Ass}_S((M \otimes_R N)_{\mathfrak q})$.
Hence we conclude that $\mathfrak p$ is one of the associated
primes of $M$.

\medskip\noindent
Continuing the argument we choose a filtration
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$, see Lemma \ref{lemma-filter-Noetherian-module}.
(By Lemma \ref{lemma-ass-filter} we have $\mathfrak p_i = \mathfrak p$ for
at least one $i$.) This gives a filtration
$$
0 = M_0 \otimes_R N \subset M_1 \otimes_R N \subset \ldots
\subset M_n \otimes_R N = M \otimes_R N
$$
with subquotients isomorphic to $N/\mathfrak p_iN$. If
$\mathfrak p_i \not = \mathfrak p$ then $\mathfrak q$ cannot be
associated to the module $N/\mathfrak p_iN$ by the result of the
preceding paragraph (as $\text{Ass}_R(R/\mathfrak p_i) = \{\mathfrak p_i\}$).
Hence we conclude that $\mathfrak q$ is associated to
$N/\mathfrak pN$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-post-bourbaki}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Assume $N$ is flat as an $R$-module and
$R$ is a domain with fraction field $K$.
Then
$$
\text{Ass}_S(N) =
\text{Ass}_S(N \otimes_R K) =
\text{Ass}_{S \otimes_R K}(N \otimes_R K)
$$
via the canonical inclusion
$\Spec(S \otimes_R K) \subset \Spec(S)$.
\end{lemma}

\begin{proof}
Note that $S \otimes_R K = (R \setminus \{0\})^{-1}S$ and
$N \otimes_R K = (R \setminus \{0\})^{-1}N$.
For any nonzero $x \in R$ multiplication by $x$ on $N$ is injective as
$N$ is flat over $R$. Hence the lemma follows from
Lemma \ref{lemma-localize-ass-nonzero-divisors}
combined with
Lemma \ref{lemma-localize-ass} part (1).
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-fibres}
Let $R \to S$ be a ring map.
Let $M$ be an $R$-module, and let $N$ be an $S$-module.
Assume $N$ is flat as $R$-module. Then
$$
\text{Ass}_S(M \otimes_R N)
\supset
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(M)}
\text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p))
$$
where we use
Remark \ref{remark-fundamental-diagram}
to think of the spectra of fibre rings as subsets of $\Spec(S)$.
If $R$ is Noetherian then this inclusion is an equality.
\end{lemma}

\begin{proof}
This is equivalent to
Lemma \ref{lemma-bourbaki}
by
Lemmas \ref{lemma-ass-quotient-ring},
\ref{lemma-flat-base-change}, and
\ref{lemma-post-bourbaki}.
\end{proof}

\begin{remark}
\label{remark-bourbaki}
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Let $\mathfrak p$ be a prime of $R$. Then
$$
\text{Ass}_S(N \otimes_R \kappa(\mathfrak p)) =
\text{Ass}_{S/\mathfrak pS}(N \otimes_R \kappa(\mathfrak p)) =
\text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p)).
$$
The first equality by
Lemma \ref{lemma-ass-quotient-ring}
and the second by
Lemma \ref{lemma-localize-ass} part (1).
\end{remark}






\section{Weakly associated primes}
\label{section-weakly-ass}

\noindent
This is a variant on the notion of an associated prime that is useful
for non-Noetherian ring and non-finite modules.

\begin{definition}
\label{definition-weakly-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it weakly associated} to $M$
if there exists an element $m \in M$ such that $\mathfrak p$ is minimal
among the prime ideals containing the annihilator
$\text{Ann}(m) = \{f \in R \mid fm = 0\}$.
The set of all such primes is denoted $\text{WeakAss}_R(M)$
or $\text{WeakAss}(M)$.
\end{definition}

\noindent
Thus an associated prime is a weakly associated prime.
Here is a characterization in terms of the localization at the prime.

\begin{lemma}
\label{lemma-weakly-ass-local}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\mathfrak p$ be a prime of $R$.
The following are equivalent:
\begin{enumerate}
\item $\mathfrak p$ is weakly associated to $M$,
\item $\mathfrak pR_{\mathfrak p}$ is weakly associated to $M_{\mathfrak p}$,
and
\item $M_{\mathfrak p}$ contains an element whose
annihilator has radical equal to $\mathfrak pR_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). Then there exists an element $m \in M$ such that
$\mathfrak p$ is minimal among the primes containing the annihilator
$I = \{x \in R \mid xm = 0\}$ of $m$. As localization is exact, the
annihilator of $m$ in $M_{\mathfrak p}$ is $I_{\mathfrak p}$.
Hence $\mathfrak pR_{\mathfrak p}$ is a minimal prime of
$R_{\mathfrak p}$ containing the annihilator $I_{\mathfrak p}$
of $m$ in $M_{\mathfrak p}$. This implies (2) holds, and also (3)
as it implies that $\sqrt{I_{\mathfrak p}} = \mathfrak pR_{\mathfrak p}$.

\medskip\noindent
Applying the implication (1) $\Rightarrow$ (3) to $M_{\mathfrak p}$
over $R_{\mathfrak p}$ we see that (2) $\Rightarrow$ (3).

\medskip\noindent
Finally, assume (3). This means there exists an element
$m/f \in M_{\mathfrak p}$ whose annihilator has radical equal
to $\mathfrak pR_{\mathfrak p}$. Then the annihilator
$I = \{x \in R \mid xm = 0\}$ of $m$ in $M$ is such that
$\sqrt{I_{\mathfrak p}} = \mathfrak pR_{\mathfrak p}$. Clearly
this means that $\mathfrak p$ contains $I$ and is minimal among the
primes containing $I$, i.e., (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass}
Let $R$ be a ring.
Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence
of $R$-modules.
Then $\text{WeakAss}(M') \subset \text{WeakAss}(M)$ and
$\text{WeakAss}(M) \subset \text{WeakAss}(M') \cup \text{WeakAss}(M'')$.
\end{lemma}

\begin{proof}
We will use the characterization of weakly associated primes of
Lemma \ref{lemma-weakly-ass-local}.
Let $\mathfrak p$ be a prime of $R$. As localization is exact we obtain
the short exact sequence
$0 \to M'_{\mathfrak p} \to M_{\mathfrak p} \to M''_{\mathfrak p} \to 0$.
Suppose that $m \in M_{\mathfrak p}$ is an element whose annihilator
has radical $\mathfrak pR_{\mathfrak p}$. Then either the image $\overline{m}$
of $m$ in $M''_{\mathfrak p}$ is zero and $m \in M'_{\mathfrak p}$, or
the annihilator of $\overline{m}$ is $\mathfrak pR_{\mathfrak p}$.
This proves that
$\text{WeakAss}(M) \subset \text{WeakAss}(M') \cup \text{WeakAss}(M'')$.
The inclusion $\text{WeakAss}(M') \subset \text{WeakAss}(M)$ is immediate
from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-zero}
\begin{slogan}
Every nonzero module has a weakly associated prime.
\end{slogan}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
M = (0) \Leftrightarrow \text{WeakAss}(M) = \emptyset
$$
\end{lemma}

\begin{proof}
If $M = (0)$ then $\text{WeakAss}(M) = \emptyset$ by definition.
Conversely, suppose that $M \not = 0$. Pick a nonzero element $m \in M$.
Write $I = \{x \in R \mid xm = 0\}$ the annihilator of $m$.
Then $R/I \subset M$. Hence $\text{WeakAss}(R/I) \subset \text{WeakAss}(M)$ by
Lemma \ref{lemma-weakly-ass}.
But as $I \not = R$ we have $V(I) = \Spec(R/I)$ contains a minimal
prime, see
Lemmas \ref{lemma-Zariski-topology} and
\ref{lemma-spec-closed},
and we win.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-support}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
\text{Ass}(M) \subset \text{WeakAss}(M) \subset \text{Supp}(M).
$$
\end{lemma}

\begin{proof}
The first inclusion is immediate from the definitions.
If $\mathfrak p \in \text{WeakAss}(M)$, then by
Lemma \ref{lemma-weakly-ass-local}
we have $M_{\mathfrak p} \not = 0$, hence $\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-zero-divisors}
Let $R$ be a ring.
Let $M$ be an $R$-module.
The union $\bigcup_{\mathfrak q \in \text{WeakAss}(M)} \mathfrak q$
is the set elements of $R$ which are zerodivisors on $M$.
\end{lemma}

\begin{proof}
Suppose $f \in \mathfrak q \in \text{WeakAss}(M)$.
Then there exists an element $m \in M$ such that
$\mathfrak q$ is minimal over $I = \{x \in R \mid xm = 0\}$.
Hence there exists a $g \in R$, $g \not \in \mathfrak q$ and $n > 0$
such that $f^ngm = 0$. Note that $gm \not = 0$ as $g \not \in I$.
If we take $n$ minimal as above, then $f (f^{n - 1}gm) = 0$
and $f^{n - 1}gm \not = 0$, so $f$ is a zerodivisor on $M$.
Conversely, suppose $f \in R$ is a zerodivisor on $M$.
Consider the submodule $N = \{m \in M \mid fm = 0\}$.
Since $N$ is not zero it has a weakly associated prime $\mathfrak q$ by
Lemma \ref{lemma-weakly-ass-zero}.
Clearly $f \in \mathfrak q$ and by
Lemma \ref{lemma-weakly-ass}
$\mathfrak q$ is a weakly associated prime of $M$.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-minimal-prime-support}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Any $\mathfrak p \in \text{Supp}(M)$ which is minimal among the elements
of $\text{Supp}(M)$ is an element of $\text{WeakAss}(M)$.
\end{lemma}

\begin{proof}
Note that $\text{Supp}(M_{\mathfrak p}) = \{\mathfrak pR_{\mathfrak p}\}$
in $\Spec(R_{\mathfrak p})$. In particular $M_{\mathfrak p}$
is nonzero, and hence $\text{WeakAss}(M_{\mathfrak p}) \not = \emptyset$ by
Lemma \ref{lemma-weakly-ass-zero}.
Since $\text{WeakAss}(M_{\mathfrak p}) \subset \text{Supp}(M_{\mathfrak p})$
by
Lemma \ref{lemma-weakly-ass-support}
we conclude that
$\text{WeakAss}(M_{\mathfrak p}) = \{\mathfrak pR_{\mathfrak p}\}$,
whence $\mathfrak p \in \text{WeakAss}(M)$ by
Lemma \ref{lemma-weakly-ass-local}.
\end{proof}

\begin{lemma}
\label{lemma-ass-weakly-ass}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\mathfrak p$ be a prime ideal of $R$ which is finitely generated.
Then
$$
\mathfrak p \in \text{Ass}(M) \Leftrightarrow
\mathfrak p \in \text{WeakAss}(M).
$$
In particular, if $R$ is Noetherian, then $\text{Ass}(M) = \text{WeakAss}(M)$.
\end{lemma}

\begin{proof}
Write $\mathfrak p = (g_1, \ldots, g_n)$ for some $g_i \in R$.
It is enough the prove the implication ``$\Leftarrow$'' as the other
implication holds in general, see
Lemma \ref{lemma-weakly-ass-support}.
Assume $\mathfrak p \in \text{WeakAss}(M)$.
By
Lemma \ref{lemma-weakly-ass-local}
there exists an element $m \in M_{\mathfrak p}$ such that
$I = \{x \in R_{\mathfrak p} \mid xm = 0\}$ has radical
$\mathfrak pR_{\mathfrak p}$. Hence for each $i$ there exists
a smallest $e_i > 0$ such that $g_i^{e_i}m = 0$ in $M_{\mathfrak p}$.
If $e_i > 1$ for some $i$, then we can replace $m$ by
$g_i^{e_i - 1} m \not = 0$ and decrease $\sum e_i$.
Hence we may assume that the annihilator of $m \in M_{\mathfrak p}$ is
$(g_1, \ldots, g_n)R_{\mathfrak p} = \mathfrak p R_{\mathfrak p}$. By
Lemma \ref{lemma-associated-primes-localize}
we see that $\mathfrak p \in \text{Ass}(M)$.
\end{proof}

\begin{remark}
\label{remark-weakly-ass-not-functorial}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Then it is not always the case that
$\Spec(\varphi)(\text{WeakAss}_S(M)) \subset \text{WeakAss}_R(M)$
contrary to the case of associated primes (see
Lemma \ref{lemma-ass-functorial}).
An example is to consider the ring map
$$
R = k[x_1, x_2, x_3, \ldots] \to
S = k[x_1, x_2, x_3, \ldots, y_1, y_2, y_3, \ldots]/
(x_1y_1, x_2y_2, x_3y_3, \ldots)
$$
and $M = S$. In this case $\mathfrak q = \sum x_iS$ is a minimal prime of
$S$, hence a weakly associated prime of $M = S$ (see
Lemma \ref{lemma-weakly-ass-minimal-prime-support}).
But on the other hand, for any nonzero element of $S$ the annihilator
in $R$ is finitely generated, and hence does not
have radical equal to $R \cap \mathfrak q = (x_1, x_2, x_3, \ldots)$
(details omitted).
\end{remark}

\begin{lemma}
\label{lemma-weakly-ass-reverse-functorial}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Then we have
$\Spec(\varphi)(\text{WeakAss}_S(M)) \supset \text{WeakAss}_R(M)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be an element of $\text{WeakAss}_R(M)$.
Then there exists an $m \in M_{\mathfrak p}$ whose annihilator
$I = \{x \in R_{\mathfrak p} \mid xm = 0\}$ has radical
$\mathfrak pR_{\mathfrak p}$. Consider the annihilator
$J = \{x \in S_{\mathfrak p} \mid xm = 0 \}$ of $m$ in $S_{\mathfrak p}$.
As $IS_{\mathfrak p} \subset J$ we see that any minimal prime
$\mathfrak q \subset S_{\mathfrak p}$ over $J$ lies over $\mathfrak p$.
Moreover such a $\mathfrak q$ corresponds to a weakly associated prime
of $M$ for example by
Lemma \ref{lemma-weakly-ass-local}.
\end{proof}

\begin{remark}
\label{remark-ass-functorial}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Denote $f : \Spec(S) \to \Spec(R)$ the associated map on spectra.
Then we have
$$
f(\text{Ass}_S(M)) \subset
\text{Ass}_R(M) \subset
\text{WeakAss}_R(M) \subset
f(\text{WeakAss}_S(M))
$$
see
Lemmas \ref{lemma-ass-functorial},
\ref{lemma-weakly-ass-reverse-functorial}, and
\ref{lemma-weakly-ass-support}.
In general all of the inclusions may be strict, see
Remarks \ref{remark-ass-reverse-functorial} and
\ref{remark-weakly-ass-not-functorial}.
If $S$ is Noetherian, then all the inclusions are equalities as
the outer two are equal by
Lemma \ref{lemma-ass-weakly-ass}.
\end{remark}

\begin{lemma}
\label{lemma-weakly-ass-finite-ring-map}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Denote $f : \Spec(S) \to \Spec(R)$ the associated map on spectra.
If $\varphi$ is a finite ring map, then
$$
\text{WeakAss}_R(M) = f(\text{WeakAss}_S(M)).
$$
\end{lemma}

\begin{proof}
One of the inclusions has already been proved, see
Remark \ref{remark-ass-functorial}.
To prove the other assume $\mathfrak q \in \text{WeakAss}_S(M)$
and let $\mathfrak p$ be the corresponding prime of $R$. Let $m \in M$
be an element such that $\mathfrak q$ is a minimal prime over
$J = \{g \in S \mid gm = 0\}$. Thus the radical of
$JS_{\mathfrak q}$ is $\mathfrak qS_{\mathfrak q}$.
As $R \to S$ is finite there are
finitely many primes
$\mathfrak q = \mathfrak q_1, \mathfrak q_2, \ldots, \mathfrak q_l$
over $\mathfrak p$, see
Lemma \ref{lemma-finite-finite-fibres}.
Pick $x \in \mathfrak q$ with $x \not \in \mathfrak q_i$ for $i > 1$, see
Lemma \ref{lemma-silly}.
By the above there exists an element $y \in S$, $y \not \in \mathfrak q$
and an integer $t > 0$ such that $y x^t m = 0$. Thus the element
$ym \in M$ is annihilated by $x^t$, hence $ym$ maps to zero in
$M_{\mathfrak q_i}$, $i = 2, \ldots, l$. To be sure, $ym$ does not
map to zero in $S_{\mathfrak q}$.

\medskip\noindent
The ring $S_{\mathfrak p}$ is semi-local with maximal ideals
$\mathfrak q_i S_{\mathfrak p}$ by going up for finite ring maps, see
Lemma \ref{lemma-integral-going-up}.
If $f \in \mathfrak pR_{\mathfrak p}$ then some power of $f$ ends
up in $JS_{\mathfrak q}$ hence for some $n > 0$ we see that
$f^t ym$ maps to zero in $M_{\mathfrak q}$. As $ym$ vanishes at the
other maximal ideals of $S_{\mathfrak p}$ we conclude that $f^t ym$ is zero
in $M_{\mathfrak p}$, see
Lemma \ref{lemma-characterize-zero-local}.
In this way we see that $\mathfrak p$ is a minimal prime over
the annihilator of $ym$ in $R$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-quotient-ring}
Let $R$ be a ring.
Let $I$ be an ideal.
Let $M$ be an $R/I$-module.
Via the canonical injection
$\Spec(R/I) \to \Spec(R)$
we have $\text{WeakAss}_{R/I}(M) = \text{WeakAss}_R(M)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-localize-weakly-ass}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $S \subset R$ be a multiplicative subset.
Via the canonical injection $\Spec(S^{-1}R) \to \Spec(R)$
we have $\text{WeakAss}_R(S^{-1}M) = \text{WeakAss}_{S^{-1}R}(S^{-1}M)$
and
$$
\text{WeakAss}(M) \cap \Spec(S^{-1}R) = \text{WeakAss}(S^{-1}M).
$$
\end{lemma}

\begin{proof}
Suppose that $m \in S^{-1}M$. Let $I = \{x \in R \mid xm = 0\}$
and $I' = \{x' \in S^{-1}R \mid x'm = 0\}$. Then $I' = S^{-1}I$
and $I \cap S = \emptyset$ unless $I = R$ (verifications omitted).
Thus primes in $S^{-1}R$ minimal over $I'$ correspond bijectively
to primes in $R$ minimal over $I$ and avoiding $S$. This proves the
equality $\text{WeakAss}_R(S^{-1}M) = \text{WeakAss}_{S^{-1}R}(S^{-1}M)$.
The second equality follows from
Lemma \ref{lemma-associated-primes-localize}
since for $\mathfrak p \in R$, $S \cap \mathfrak p = \emptyset$ we have
$M_{\mathfrak p} = (S^{-1}M)_{S^{-1}\mathfrak p}$.
\end{proof}

\begin{lemma}
\label{lemma-localize-weakly-ass-nonzero-divisors}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $S \subset R$ be a multiplicative subset.
Assume that every $s \in S$ is a nonzerodivisor on $M$.
Then
$$
\text{WeakAss}(M) = \text{WeakAss}(S^{-1}M).
$$
\end{lemma}

\begin{proof}
As $M \subset S^{-1}M$ by assumption we obtain
$\text{WeakAss}(M) \subset \text{WeakAss}(S^{-1}M)$ from
Lemma \ref{lemma-weakly-ass}.
Conversely, suppose that $n/s \in S^{-1}M$ is an element with annihilator
$I$ and $\mathfrak p$ a prime which is minimal over $I$.
Then the annihilator of $n \in M$ is $I$ and $\mathfrak p$ is a prime
minimal over $I$.
\end{proof}

\begin{lemma}
\label{lemma-zero-at-weakly-ass-zero}
Let $R$ be a ring. Let $M$ be an $R$-module. The map
$$
M
\longrightarrow
\prod\nolimits_{\mathfrak p \in \text{WeakAss}(M)} M_{\mathfrak p}
$$
is injective.
\end{lemma}

\begin{proof}
Let $x \in M$ be an element of the kernel of the map. Set
$N = Rx \subset M$. If $\mathfrak p$ is a weakly associated prime of $N$
we see on the one hand that $\mathfrak p \in \text{WeakAss}(M)$
(Lemma \ref{lemma-weakly-ass})
and on the other hand that $N_{\mathfrak p} \subset M_{\mathfrak p}$
is not zero. This contradiction shows that $\text{WeakAss}(N) = \emptyset$.
Hence $N = 0$, i.e., $x = 0$ by
Lemma \ref{lemma-weakly-ass-zero}.
\end{proof}

\begin{lemma}
\label{lemma-weak-post-bourbaki}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Assume $N$ is flat as an $R$-module and
$R$ is a domain with fraction field $K$.
Then
$$
\text{WeakAss}_S(N) = \text{WeakAss}_{S \otimes_R K}(N \otimes_R K)
$$
via the canonical inclusion
$\Spec(S \otimes_R K) \subset \Spec(S)$.
\end{lemma}

\begin{proof}
Note that $S \otimes_R K = (R \setminus \{0\})^{-1}S$ and
$N \otimes_R K = (R \setminus \{0\})^{-1}N$.
For any nonzero $x \in R$ multiplication by $x$ on $N$ is injective as
$N$ is flat over $R$. Hence the lemma follows from
Lemma \ref{lemma-localize-weakly-ass-nonzero-divisors}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-change-fields}
Let $K/k$ be a field extension. Let $R$ be a $k$-algebra.
Let $M$ be an $R$-module. Let $\mathfrak q \subset R \otimes_k K$
be a prime lying over $\mathfrak p \subset R$. If
$\mathfrak q$ is weakly associated to $M \otimes_k K$,
then $\mathfrak p$ is weakly associated to $M$.
\end{lemma}

\begin{proof}
Let $z \in M \otimes_k K$ be an element such that $\mathfrak q$
is minimal over the annihilator $J \subset R \otimes_k K$ of $z$.
Choose a finitely generated subextension $K/L/k$ such that
$z \in M \otimes_k L$. Since $R \otimes_k L \to R \otimes_k K$
is flat we see that $J = I(R \otimes_k K)$ where $I \subset R \otimes_k L$
is the annihilator of $z$ in the smaller ring
(Lemma \ref{lemma-annihilator-flat-base-change}).
Thus $\mathfrak q \cap (R \otimes_k L)$ is minimal over $I$ by
going down (Lemma \ref{lemma-flat-going-down}).
In this way we reduce to the case described in the next paragraph.

\medskip\noindent
Assume $K/k$ is a finitely generated field extension.
Let $x_1, \ldots, x_r \in K$ be a transcendence basis
of $K$ over $k$, see Fields, Section \ref{fields-section-transcendence}.
Set $L = k(x_1, \ldots, x_r)$. Say $[K : L] = n$. Then
$R \otimes_k L \to R \otimes_k K$ is a finite ring map.
Hence $\mathfrak q \cap (R \otimes_k L)$
is a weakly associated prime of $M \otimes_k K$
viewed as a $R \otimes_k L$-module by
Lemma \ref{lemma-weakly-ass-finite-ring-map}.
Since $M \otimes_k K \cong (M \otimes_k L)^{\oplus n}$
as a $R \otimes_k L$-module, we see that
$\mathfrak q \cap (R \otimes_k L)$
is a weakly associated prime of $M \otimes_k L$
(for example by using Lemma \ref{lemma-weakly-ass} and induction).
In this way we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $K = k(x_1, \ldots, x_r)$ is a purely transcendental field extension.
We may replace $R$ by $R_\mathfrak p$, $M$ by $M_\mathfrak p$
and $\mathfrak q$ by $\mathfrak q(R_\mathfrak p \otimes_k K)$.
See Lemma \ref{lemma-localize-weakly-ass}.
In this way we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $K = k(x_1, \ldots, x_r)$ is a purely transcendental field extension
and $R$ is local with maximal ideal $\mathfrak p$. We claim that any
$f \in R \otimes_k K$, $f \not \in \mathfrak p(R \otimes_k K)$
is a nonzerodivisor on $M \otimes_k K$. Namely, let
$z \in M \otimes_k K$ be an element.
There is a finite $R$-submodule $M' \subset M$ such that
$z \in M' \otimes_k K$ and such that $M'$ is minimal with
this property: choose a basis $\{t_\alpha\}$ of $K$ as a
$k$-vector space, write $z = \sum m_\alpha \otimes t_\alpha$ and let
$M'$ be the $R$-submodule generated by the $m_\alpha$.
If $z \in \mathfrak p(M' \otimes_k K) = \mathfrak p M' \otimes_k K$,
then $\mathfrak pM' = M'$ and $M' = 0$ by Lemma \ref{lemma-NAK}
a contradiction.
Thus $z$ has nonzero image $\overline{z}$ in $M'/\mathfrak p M' \otimes_k K$
But $R/\mathfrak p \otimes_k K$ is a domain as a localization
of $\kappa(\mathfrak p)[x_1, \ldots, x_n]$ and
$M'/\mathfrak p M' \otimes_k K$ is a free module, hence
$f\overline{z} \not = 0$. This proves the claim.

\medskip\noindent
Finally, pick $z \in M \otimes_k K$ such that $\mathfrak q$
is minimal over the annihilator $J \subset R \otimes_k K$ of $z$.
For $f \in \mathfrak p$ there exists an $n \geq 1$ and a
$g \in R \otimes_k K$, $g \not \in \mathfrak q$ such that
$g f^n z \in J$, i.e., $g f^n z = 0$.
(This holds because $\mathfrak q$ lies over $\mathfrak p$
and $\mathfrak q$ is minimal over $J$.)
Above we have seen that $g$ is a nonzerodivisor hence $f^n z = 0$.
This means that $\mathfrak p$ is a weakly associated prime
of $M \otimes_k K$ viewed as an $R$-module.
Since $M \otimes_k K$ is a direct sum of copies of $M$
we conclude that $\mathfrak p$ is a weakly associated
prime of $M$ as before.
\end{proof}





\section{Embedded primes}
\label{section-embedded-primes}

\noindent
Here is the definition.

\begin{definition}
\label{definition-embedded-primes}
Let $R$ be a ring.
Let $M$ be an $R$-module.
\begin{enumerate}
\item  The associated primes of $M$ which are
not minimal among the associated primes of $M$ are called the
{\it embedded associated primes} of $M$.
\item The {\it embedded primes of $R$}
are the embedded associated primes of $R$ as an $R$-module.
\end{enumerate}
\end{definition}

\noindent
Here is a way to get rid of these.

\begin{lemma}
\label{lemma-remove-embedded-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Consider the set of $R$-submodules
$$
\{
K \subset M
\mid
\text{Supp}(K)
\text{ nowhere dense in }
\text{Supp}(M)
\}.
$$
This set has a maximal element $K$ and the quotient
$M' = M/K$ has the following properties
\begin{enumerate}
\item $\text{Supp}(M) = \text{Supp}(M')$,
\item $M'$ has no embedded associated primes,
\item for any $f \in R$ which is contained in all
embedded associated primes of $M$ we have $M_f \cong M'_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ denote the
minimal primes in the support of $M$. Let
$\mathfrak p_1, \ldots, \mathfrak p_s$ denote the
embedded associated primes of $M$. Then
$\text{Ass}(M) = \{\mathfrak q_j, \mathfrak p_i\}$.
There are finitely many of these,
see Lemma \ref{lemma-finite-ass}.
Set $I = \prod_{i = 1, \ldots, s} \mathfrak p_i$.
Then $I \not \subset \mathfrak q_j$ for
any $j$. Hence by Lemma \ref{lemma-silly} we can find an
$f \in I$ such that $f \not \in \mathfrak q_j$ for
all $j = 1, \ldots, t$. Set $M' = \Im(M \to M_f)$.
This implies that $M_f \cong M'_f$. Since
$M' \subset M_f$ we see that
$\text{Ass}(M') \subset \text{Ass}(M_f) = \{\mathfrak q_j\}$.
Thus $M'$ has no embedded associated primes.

\medskip\noindent
Moreover, the support of $K = \Ker(M \to M')$
is contained in $V(\mathfrak p_1) \cup \ldots \cup V(\mathfrak p_s)$,
because $\text{Ass}(K) \subset \text{Ass}(M)$
(see Lemma \ref{lemma-ass}) and $\text{Ass}(K)$ contains none
of the $\mathfrak q_i$ by construction.
Clearly, $K$ is in fact the largest submodule of $M$ whose support is
contained in $V(\mathfrak p_1) \cup \ldots \cup V(\mathfrak p_t)$.
This implies that $K$ is the maximal element of the set displayed
in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-remove-embedded-primes-localize}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
For any $f \in R$ we have $(M')_f = (M_f)'$ where
$M \to M'$ and $M_f \to (M_f)'$ are the quotients
constructed in Lemma \ref{lemma-remove-embedded-primes}.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-primes-endos}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module without embedded associated primes.
Let $I = \{x \in R \mid xM = 0\}$. Then the ring $R/I$ has no
embedded primes.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/I$.
Hence we may assume every nonzero element
of $R$ acts nontrivially on $M$.
By Lemma \ref{lemma-support-closed} this implies that
$\Spec(R)$ equals the support of $M$.
Suppose that $\mathfrak p$ is an embedded prime of $R$.
Let $x \in R$ be an element whose annihilator is $\mathfrak p$.
Consider the nonzero module $N = xM \subset M$. It is annihilated
by $\mathfrak p$. Hence any associated prime $\mathfrak q$ of $N$
contains $\mathfrak p$ and is also an associated prime of $M$.
Then $\mathfrak q$ would be an embedded associated prime of
$M$ which contradicts the assumption of the lemma.
\end{proof}

















\section{Regular sequences}
\label{section-regular-sequences}

\noindent
In this section we develop some basic properties of regular sequences.

\begin{definition}
\label{definition-regular-sequence}
Let $R$ be a ring. Let $M$ be an $R$-module. A sequence of elements
$f_1, \ldots, f_r$ of $R$ is called an {\it $M$-regular sequence}
if the following conditions hold:
\begin{enumerate}
\item $f_i$ is a nonzerodivisor on
$M/(f_1, \ldots, f_{i - 1})M$
for each $i = 1, \ldots, r$, and
\item the module $M/(f_1, \ldots, f_r)M$ is not zero.
\end{enumerate}
If $I$ is an ideal of $R$ and $f_1, \ldots, f_r \in I$
then we call $f_1, \ldots, f_r$ a {\it $M$-regular sequence
in $I$}. If $M = R$, we call $f_1, \ldots, f_r$ simply a
{\it regular sequence} (in $I$).
\end{definition}

\noindent
Please pay attention to the fact that the definition depends on the order
of the elements $f_1, \ldots, f_r$ (see examples below). Some papers/books
drop the requirement that the module $M/(f_1, \ldots, f_r)M$ is nonzero.
This has the advantage that being a regular sequence is preserved under
localization. However, we will use this definition mainly to define the
depth of a module in case $R$ is local; in that case the $f_i$ are required
to be in the maximal ideal -- a condition which is not preserved under going
from $R$ to a localization $R_\mathfrak p$.

\begin{example}
\label{example-global-regular}
Let $k$ be a field. In the ring $k[x, y, z]$
the sequence $x, y(1-x), z(1-x)$ is regular
but the sequence $y(1-x), z(1-x), x$ is not.
\end{example}

\begin{example}
\label{example-local-regular}
Let $k$ be a field. Consider the ring
$k[x, y, w_0, w_1, w_2, \ldots]/I$
where $I$ is generated by $yw_i$, $i = 0, 1, 2, \ldots$ and
$w_i - xw_{i + 1}$, $i = 0, 1, 2, \ldots$.
The sequence $x, y$ is regular, but $y$ is a zerodivisor.
Moreover you can localize at the maximal ideal
$(x, y, w_i)$ and still get an example.
\end{example}

\begin{lemma}
\label{lemma-permute-xi}
Let $R$ be a local Noetherian ring.
Let $M$ be a finite $R$-module.
Let $x_1, \ldots, x_c$ be an $M$-regular sequence.
Then any permutation of the $x_i$ is a regular
sequence as well.
\end{lemma}

\begin{proof}
First we do the case $c = 2$.
Consider $K \subset M$ the kernel of $x_2 : M \to M$.
For any $z \in K$ we know that $z = x_1 z'$
for some $z' \in M$ because
$x_2$ is a nonzerodivisor on $M/x_1M$.
Because $x_1$ is a nonzerodivisor on $M$ we see that $x_2 z' = 0$
as well. Hence $x_1 : K \to K$ is surjective.
Thus $K = 0$ by Nakayama's Lemma \ref{lemma-NAK}.
Next, consider multiplication by $x_1$ on $M/x_2M$.
If $z \in M$ maps to an element $\overline{z} \in M/x_2M$
in the kernel of this map, then $x_1 z = x_2 y$ for some $y \in M$.
But then since $x_1, x_2$ is a regular sequence we see that
$y = x_1 y'$ for some $y' \in M$. Hence $x_1 ( z - x_2 y' ) =0$
and hence $z = x_2 y'$ and hence $\overline{z} = 0$ as desired.

\medskip\noindent
For the general case, observe that any permutation is
a composition of transpositions of adjacent indices.
Hence it suffices to prove that
$$
x_1, \ldots, x_{i-2}, x_i, x_{i-1}, x_{i + 1}, \ldots, x_c
$$
is an $M$-regular sequence. This follows from the case we
just did applied to the module $M/(x_1, \ldots, x_{i-2})$
and the length $2$ regular sequence $x_{i-1}, x_i$.
\end{proof}

\begin{lemma}
\label{lemma-flat-increases-depth}
Let $R, S$ be local rings. Let $R \to S$ be a flat local ring homomorphism.
Let $x_1, \ldots, x_r$ be a sequence in $R$. Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $x_1, \ldots, x_r$ is an $M$-regular sequence in $R$, and
\item the images of $x_1, \ldots, x_r$ in $S$ form a $M \otimes_R S$-regular
sequence.
\end{enumerate}
\end{lemma}

\begin{proof}
This is so because $R \to S$ is faithfully flat
by Lemma \ref{lemma-local-flat-ff}.
\end{proof}

\begin{lemma}
\label{lemma-regular-sequence-in-neighbourhood}
Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module.
Let $\mathfrak p$ be a prime. Let $x_1, \ldots, x_r$ be a sequence
in $R$ whose image in $R_{\mathfrak p}$ forms an $M_{\mathfrak p}$-regular
sequence. Then there exists a $g \in R$, $g \not \in \mathfrak p$
such that the image of $x_1, \ldots, x_r$ in $R_g$ forms
an $M_g$-regular sequence.
\end{lemma}

\begin{proof}
Set
$$
K_i = \Ker\left(x_i : M/(x_1, \ldots, x_{i - 1})M \to
M/(x_1, \ldots, x_{i - 1})M\right).
$$
This is a finite $R$-module whose localization at $\mathfrak p$ is
zero by assumption. Hence there exists a $g \in R$, $g \not \in \mathfrak p$
such that $(K_i)_g = 0$ for all $i = 1, \ldots, r$. This $g$ works.
\end{proof}

\begin{lemma}
\label{lemma-join-regular-sequences}
Let $A$ be a ring. Let $I$ be an ideal generated by a regular
sequence $f_1, \ldots, f_n$ in $A$. Let $g_1, \ldots, g_m \in A$ be
elements whose images $\overline{g}_1, \ldots, \overline{g}_m$ form a
regular sequence in $A/I$. Then $f_1, \ldots, f_n, g_1, \ldots, g_m$
is a regular sequence in $A$.
\end{lemma}

\begin{proof}
This follows immediately from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-regular-sequence-powers}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $f_1, \ldots, f_r \in R$ be an $M$-regular sequence.
Then for $e_1, \ldots, e_r > 0$ the sequence
$f_1^{e_1}, \ldots, f_r^{e_r}$
is $M$-regular too.
\end{lemma}

\begin{proof}
We will prove this by induction on $r$.
If $r = 1$ this follows from the fact that a power of a nonzerodivisor
on $M$ is a nonzerodivisor on $M$. If $r > 1$, then by induction
applied to $M/f_1M$ we have that $f_1, f_2^{e_2}, \ldots, f_r^{e_r}$
is an $M$-regular sequence. Thus it suffices to show that
$f_1^e, f_2, \ldots, f_r$ is an $M$-regular sequence if $f_1, \ldots, f_r$
is an $M$-regular sequence. We will prove this
by induction on $e$. The case $e = 1$ is trivial. Since $f_1$ is a
nonzerodivisor we have a short exact sequence
$$
0 \to M/f_1M \xrightarrow{f_1^{e - 1}} M/f_1^eM \to M/f_1^{e - 1}M \to 0
$$
By induction the elements $f_2, \ldots, f_r$ are $M/f_1M$ and
$M/f_1^{e - 1}M$-regular sequences. It follows from the snake lemma
that they are also $M/f_1^eM$-regular sequences.
\end{proof}

\begin{lemma}
\label{lemma-regular-sequence-in-polynomial-ring}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ which do not generate
the unit ideal. The following are equivalent:
\begin{enumerate}
\item any permutation of $f_1, \ldots, f_r$ is a regular sequence,
\item any subsequence of $f_1, \ldots, f_r$ (in the given order) is
a regular sequence, and
\item $f_1x_1, \ldots, f_rx_r$ is a regular sequence in the polynomial
ring $R[x_1, \ldots, x_r]$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). We prove (2) implies (1) by induction
on $r$. The case $r = 1$ is trivial. The case $r = 2$ says that if
$a, b \in R$ are a regular sequence and $b$ is a nonzerodivisor, then
$b, a$ is a regular sequence. This is clear because the kernel of
$a : R/(b) \to R/(b)$ is isomorphic to the kernel of $b : R/(a) \to R/(a)$
if both $a$ and $b$ are nonzerodivisors. The case $r > 2$. Assume
(2) holds and say we want to prove $f_{\sigma(1)}, \ldots, f_{\sigma(r)}$
is a regular sequence for some permutation $\sigma$. We already know
that $f_{\sigma(1)}, \ldots, f_{\sigma(r - 1)}$ is a regular sequence
by induction. Hence it suffices to show that $f_s$ where $s = \sigma(r)$
is a nonzerodivisor modulo $f_1, \ldots, \hat f_s, \ldots, f_r$.
If $s = r$ we are done. If $s < r$, then note that $f_s$ and $f_r$
are both nonzerodivisors in the ring
$R/(f_1, \ldots, \hat f_s, \ldots, f_{r - 1})$
(by induction hypothesis again). Since we know $f_s, f_r$ is a
regular sequence in that ring we conclude by the case of sequence of length
$2$ that $f_r, f_s$ is too.

\medskip\noindent
Note that $R[x_1, \ldots, x_r]/(f_1x_1, \ldots, f_ix_i)$ as an $R$-module
is a direct sum of the modules
$$
R/I_E \cdot x_1^{e_1} \ldots x_r^{e_r}
$$
indexed by multi-indices $E = (e_1, \ldots, e_r)$ where
$I_E$ is the ideal generated by $f_j$ for $1 \leq j \leq i$
with $e_j > 0$. Hence $f_{i + 1}x_i$ is a nonzerodivisor on this if
and only if $f_{i + 1}$ is a nonzerodivisor on $R/I_E$ for all $E$.
Taking $E$ with all positive entries, we see that $f_{i + 1}$
is a nonzerodivisor on $R/(f_1, \ldots, f_i)$. Thus (3) implies (2).
Conversely, if (2) holds, then any subsequence of
$f_1, \ldots, f_i, f_{i + 1}$
is a regular sequence by Lemma \ref{lemma-regular-sequence-powers},
i.e., hence $f_{i + 1}$ is a nonzerodivisor on all $R/I_E$.
In this way we see that (2) implies (3).
\end{proof}










\section{Quasi-regular sequences}
\label{section-quasi-regular}

\noindent
There is a notion of regular sequence which is slightly weaker
than that of a regular sequence and easier to use.
Let $R$ be a ring and let $f_1, \ldots, f_c \in R$.
Set $J = (f_1, \ldots, f_c)$. Let $M$ be an $R$-module.
Then there is a canonical map
\begin{equation}
\label{equation-quasi-regular}
M/JM \otimes_{R/J} R/J[X_1, \ldots, X_c]
\longrightarrow
\bigoplus\nolimits_{n \geq 0} J^nM/J^{n + 1}M
\end{equation}
of graded $R/J[X_1, \ldots, X_c]$-modules defined by the rule
$$
\overline{m} \otimes X_1^{e_1} \ldots X_c^{e_c} \longmapsto
f_1^{e_1} \ldots f_c^{e_c} m \bmod J^{e_1 + \ldots + e_c + 1}M.
$$
Note that (\ref{equation-quasi-regular}) is always surjective.

\begin{definition}
\label{definition-quasi-regular-sequence}
Let $R$ be a ring.
Let $M$ be an $R$-module.
A sequence of elements $f_1, \ldots, f_c$ of $R$ is called
{\it $M$-quasi-regular} if (\ref{equation-quasi-regular})
is an isomorphism. If $M = R$, we call $f_1, \ldots, f_c$ simply a
{\it quasi-regular sequence}.
\end{definition}

\noindent
So if $f_1, \ldots, f_c$ is a quasi-regular sequence, then
$$
R/J[X_1, \ldots, X_c] = \bigoplus\nolimits_{n \geq 0} J^n/J^{n + 1}
$$
where $J = (f_1, \ldots, f_c)$. It is clear that being a quasi-regular
sequence is independent of the order of $f_1, \ldots, f_c$.

\begin{lemma}
\label{lemma-regular-quasi-regular}
Let $R$ be a ring.
\begin{enumerate}
\item A regular sequence $f_1, \ldots, f_c$ of $R$ is a quasi-regular
sequence.
\item Suppose that $M$ is an $R$-module and that $f_1, \ldots, f_c$
is an $M$-regular sequence. Then $f_1, \ldots, f_c$ is an
$M$-quasi-regular sequence.
\end{enumerate}
\end{lemma}

\begin{proof}
Set $J = (f_1, \ldots, f_c)$.
We prove the first assertion by induction on $c$.
We have to show that given any relation
$\sum_{|I| = n} a_I f^I \in J^{n + 1}$ with $a_I \in R$ we
actually have $a_I \in J$ for all multi-indices $I$. Since
any element of $J^{n + 1}$ is of the form $\sum_{|I| = n} b_I f^I$
with $b_I \in J$ we may assume, after replacing $a_I$ by $a_I - b_I$,
the relation reads $\sum_{|I| = n} a_I f^I = 0$. We can rewrite
this as
$$
\sum\nolimits_{e = 0}^n
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
Here and below the ``primed'' multi-indices $I'$ are required to be of the form
$I' = (i_1, \ldots, i_{c - 1}, 0)$. We will show by descending
induction on $l \in \{0, \ldots, n\}$
that if we have a relation
$$
\sum\nolimits_{e = 0}^l
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
then $a_{I', e} \in J$ for all $I', e$.
Namely, set $J' = (f_1, \ldots, f_{c-1})$.
Observe that $\sum\nolimits_{|I'| = n - l} a_{I', l} f^{I'}$
is mapped into $(J')^{n - l + 1}$ by $f_c^{l}$.
By induction hypothesis (for the induction on $c$)
we see that $f_c^l a_{I', l} \in J'$.
Because $f_c$ is not a zerodivisor on $R/J'$ (as $f_1, \ldots, f_c$
is a regular sequence) we conclude that $a_{I', l} \in J'$.
This allows us to rewrite the term
$(\sum\nolimits_{|I'| = n - l} a_{I', l} f^{I'})f_c^l$
in the form $(\sum\nolimits_{|I'| = n - l + 1} f_c b_{I', l - 1}
f^{I'})f_c^{l-1}$. This gives a new relation of the form
$$
\sum\nolimits_{|I'| = n - l + 1}
(a_{I', l-1} + f_c b_{I', l - 1}) f^{I'})f_c^{l-1}
+
\sum\nolimits_{e = 0}^{l - 2}
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
Now by the induction hypothesis (on $l$ this time) we see that
all $a_{I', l-1} + f_c b_{I', l - 1} \in J$ and
all $a_{I', e} \in J$ for $e \leq l - 2$. This, combined with
$a_{I', l} \in J' \subset J$ seen above, finishes the proof of the
induction step.

\medskip\noindent
The second assertion means that given any formal expression
$F = \sum_{|I| = n} m_I X^I$, $m_I \in M$ with $\sum m_I f^I
\in J^{n + 1}M$, then all the coefficients $m_I$ are in $J$.
This is proved in exactly the same way as we prove the corresponding
result for the first assertion above.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-quasi-regular}
Let $R \to R'$ be a flat ring map. Let $M$ be an $R$-module.
Suppose that $f_1, \ldots, f_r \in R$ form an $M$-quasi-regular sequence.
Then the images of $f_1, \ldots, f_r$ in
$R'$ form a $M \otimes_R R'$-quasi-regular sequence.
\end{lemma}

\begin{proof}
Set $J = (f_1, \ldots, f_r)$, $J' = JR'$ and $M' = M \otimes_R R'$.
We have to show the canonical map
$\mu : R'/J'[X_1, \ldots X_n] \otimes_{R'/J'} M'/J'M' \to
\bigoplus (J')^nM'/(J')^{n + 1}M'$ is an isomorphism.
Because $R \to R'$ is flat the sequences
$0 \to J^nM \to M$ and
$0 \to J^{n + 1}M \to J^nM \to J^nM/J^{n + 1}M \to 0$
remain exact on tensoring with $R'$. This first implies that
$J^nM \otimes_R R' = (J')^nM'$ and then that
$(J')^nM'/(J')^{n + 1}M' = J^nM/J^{n + 1}M \otimes_R R'$.
Thus $\mu$ is the tensor product of (\ref{equation-quasi-regular}),
which is an isomorphism by assumption,
with $\text{id}_{R'}$ and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-sequence-in-neighbourhood}
Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module.
Let $\mathfrak p$ be a prime. Let $x_1, \ldots, x_c$ be a sequence
in $R$ whose image in $R_{\mathfrak p}$ forms an
$M_{\mathfrak p}$-quasi-regular sequence. Then there exists a
$g \in R$, $g \not \in \mathfrak p$
such that the image of $x_1, \ldots, x_c$ in $R_g$ forms
an $M_g$-quasi-regular sequence.
\end{lemma}

\begin{proof}
Consider the kernel $K$ of the map (\ref{equation-quasi-regular}).
As $M/JM \otimes_{R/J} R/J[X_1, \ldots, X_c]$ is a finite
$R/J[X_1, \ldots, X_c]$-module and as $R/J[X_1, \ldots, X_c]$ is
Noetherian, we see that $K$ is also a finite $R/J[X_1, \ldots, X_c]$-module.
Pick homogeneous generators $k_1, \ldots, k_t \in K$.
By assumption for each $i = 1, \ldots, t$ there exists a $g_i \in R$,
$g_i \not \in \mathfrak p$ such that $g_i k_i = 0$.
Hence $g = g_1 \ldots g_t$ works.
\end{proof}

\begin{lemma}
\label{lemma-truncate-quasi-regular}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $f_1, \ldots, f_c \in R$ be an $M$-quasi-regular sequence.
For any $i$ the sequence
$\overline{f}_{i + 1}, \ldots, \overline{f}_c$
of $\overline{R} = R/(f_1, \ldots, f_i)$ is an
$\overline{M} = M/(f_1, \ldots, f_i)M$-quasi-regular sequence.
\end{lemma}

\begin{proof}
It suffices to prove this for $i = 1$. Set
$\overline{J} = (\overline{f}_2, \ldots, \overline{f}_c) \subset \overline{R}$.
Then
\begin{align*}
\overline{J}^n\overline{M}/\overline{J}^{n + 1}\overline{M}
& =
(J^nM + f_1M)/(J^{n + 1}M + f_1M) \\
& = J^nM / (J^{n + 1}M + J^nM \cap f_1M).
\end{align*}
Thus, in order to prove the lemma it suffices to show that
$J^{n + 1}M + J^nM \cap f_1M = J^{n + 1}M + f_1J^{n - 1}M$
because that will show that
$\bigoplus_{n \geq 0}
\overline{J}^n\overline{M}/\overline{J}^{n + 1}\overline{M}$
is the quotient of
$\bigoplus_{n \geq 0} J^nM/J^{n + 1} \cong M/JM[X_1, \ldots, X_c]$
by $X_1$. Actually, we have $J^nM \cap f_1M = f_1J^{n - 1}M$.
Namely, if $m \not \in J^{n - 1}M$, then $f_1m \not \in J^nM$
because $\bigoplus J^nM/J^{n + 1}M$ is the polynomial algebra
$M/J[X_1, \ldots, X_c]$ by assumption.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-regular}
Let $(R, \mathfrak m)$ be a local Noetherian ring.
Let $M$ be a nonzero finite $R$-module.
Let $f_1, \ldots, f_c \in \mathfrak m$ be an $M$-quasi-regular sequence.
Then $f_1, \ldots, f_c$ is an $M$-regular sequence.
\end{lemma}

\begin{proof}
Set $J = (f_1, \ldots, f_c)$.
Let us show that $f_1$ is a nonzerodivisor on $M$.
Suppose $x \in M$ is not zero.
By the Artin-Rees lemma there exists an integer $r$
such that $x \in J^rM$ but $x \not \in J^{r + 1}M$, see
Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Then $f_1 x \in J^{r + 1}M$ is an element whose class in
$J^{r + 1}M/J^{r + 2}M$ is nonzero by the assumed structure of
$\bigoplus J^nM/J^{n + 1}M$. Whence $f_1x \not = 0$.

\medskip\noindent
Now we can finish the proof by induction on $c$ using
Lemma \ref{lemma-truncate-quasi-regular}.
\end{proof}

\begin{remark}[Koszul regular sequences]
\label{remark-koszul-regular}
In the paper \cite{Kabele} the author introduces two more
regularity conditions for sequences $x_1, \ldots, x_r$ of elements
of a ring $R$. Namely, we say the sequence is {\it Koszul-regular}
if $H_i(K_{\bullet}(R, x_{\bullet})) = 0$ for $i \geq 1$ where
$K_{\bullet}(R, x_{\bullet})$ is the Koszul complex. The sequence is
called {\it $H_1$-regular} if $H_1(K_{\bullet}(R, x_{\bullet})) = 0$.
If $R$ is a local ring (possibly nonnoetherian) and the sequence consists
of elements of the maximal ideal, then one has the implications
regular $\Rightarrow$ Koszul-regular $\Rightarrow$ $H_1$-regular
$\Rightarrow$ quasi-regular. By examples the author shows that
these implications cannot be reversed in general. We introduce
these notions in more detail in
More on Algebra, Section \ref{more-algebra-section-koszul-regular}.
\end{remark}

\begin{remark}
\label{remark-join-quasi-regular-sequences}
Let $k$ be a field. Consider the ring
$$
A = k[x, y, w, z_0, z_1, z_2, \ldots]/
(y^2z_0 - wx, z_0 - yz_1, z_1 - yz_2, \ldots)
$$
In this ring $x$ is a nonzerodivisor and the image of $y$ in
$A/xA$ gives a quasi-regular sequence. But it is not true that
$x, y$ is a quasi-regular sequence in $A$ because $(x, y)/(x, y)^2$
isn't free of rank two over $A/(x, y)$ due to the fact that
$wx = 0$ in $(x, y)/(x, y)^2$ but $w$ isn't zero in $A/(x, y)$.
Hence the analogue of
Lemma \ref{lemma-join-regular-sequences}
does not hold for quasi-regular sequences.
\end{remark}

\begin{lemma}
\label{lemma-quasi-regular-on-quotient}
Let $R$ be a ring. Let $J = (f_1, \ldots, f_r)$ be an ideal of $R$.
Let $M$ be an $R$-module. Set $\overline{R} = R/\bigcap_{n \geq 0} J^n$,
$\overline{M} = M/\bigcap_{n \geq 0} J^nM$, and denote
$\overline{f}_i$ the image of $f_i$ in $\overline{R}$.
Then $f_1, \ldots, f_r$ is $M$-quasi-regular if and only if
$\overline{f}_1, \ldots, \overline{f}_r$ is $\overline{M}$-quasi-regular.
\end{lemma}

\begin{proof}
This is true because
$J^nM/J^{n + 1}M \cong
\overline{J}^n\overline{M}/\overline{J}^{n + 1}\overline{M}$.
\end{proof}





\section{Blow up algebras}
\label{section-blow-up}

\noindent
In this section we make some elementary observations about blowing up.

\begin{definition}
\label{definition-blow-up}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
\begin{enumerate}
\item The {\it blowup algebra}, or the {\it Rees algebra}, associated to
the pair $(R, I)$ is the graded $R$-algebra
$$
\text{Bl}_I(R) =
\bigoplus\nolimits_{n \geq 0} I^n =
R \oplus I \oplus I^2 \oplus \ldots
$$
where the summand $I^n$ is placed in degree $n$.
\item Let $a \in I$ be an element. Denote $a^{(1)}$ the element $a$
seen as an element of degree $1$ in the Rees algebra. Then the
{\it affine blowup algebra} $R[\frac{I}{a}]$ is the algebra
$(\text{Bl}_I(R))_{(a^{(1)})}$ constructed in Section \ref{section-proj}.
\end{enumerate}
\end{definition}

\noindent
In other words, an element of $R[\frac{I}{a}]$ is represented by
an expression of the form $x/a^n$ with $x \in I^n$. Two representatives
$x/a^n$ and $y/a^m$ define the same element if and only if
$a^k(a^mx - a^ny) = 0$ for some $k \geq 0$.

\begin{lemma}
\label{lemma-affine-blowup}
Let $R$ be a ring, $I \subset R$ an ideal, and $a \in I$.
The image of $a$ in the blowup algebra $R' = R[\frac{I}{a}]$
is a nonzerodivisor and $IR' = aR'$.
\end{lemma}

\begin{proof}
Immediate from the description of $R[\frac{I}{a}]$ above.
\end{proof}

\begin{lemma}
\label{lemma-blowup-base-change}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal
and $a \in I$. Set $J = IS$ and let $b \in J$ be the image of $a$.
Then $S[\frac{J}{b}]$ is the quotient of $S \otimes_R R[\frac{I}{a}]$
by the ideal of elements annihilated by some power of $b$.
\end{lemma}

\begin{proof}
Let $S'$ be the quotient of $S \otimes_R R[\frac{I}{a}]$ by its
$b$-power torsion elements. The ring map
$$
S \otimes_R R[\textstyle{\frac{I}{a}}]
\longrightarrow
S[\textstyle{\frac{J}{b}}]
$$
is surjective and annihilates $a$-power torsion as $b$ is a nonzerodivisor
in $S[\frac{J}{b}]$. Hence we obtain a surjective map $S' \to S[\frac{J}{b}]$.
To see that the kernel is trivial, we construct an inverse map. Namely, let
$z = y/b^n$ be an element of $S[\frac{J}{b}]$, i.e., $y \in J^n$.
Write $y = \sum x_is_i$ with $x_i \in I^n$ and $s_i \in S$.
We map $z$ to the class of $\sum s_i \otimes x_i/a^n$ in
$S'$. This is well defined because an element of the kernel of the map
$S \otimes_R I^n \to J^n$ is annihilated by $a^n$, hence maps to zero in $S'$.
\end{proof}

\begin{lemma}
\label{lemma-blowup-in-principal}
Let $R$ be a ring, $I \subset R$ an ideal, and $a \in I$.
Set $R' = R[\frac{I}{a}]$. If $f \in R$ is such that $V(f) = V(I)$,
then $f$ maps to a nonzerodivisor in $R'$ and $R'_f = R'_a = R_f$.
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-affine-blowup}
without further mention.
The assumption $V(f) = V(I)$ implies $V(fR') = V(IR') = V(aR')$.
Hence $a^n = fb$ and $f^m = ac$ for some $b, c \in R'$.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-blowup-add-principal}
Let $R$ be a ring, $I \subset R$ an ideal, $a \in I$, and $f \in R$.
Set $R' = R[\frac{I}{a}]$ and $R'' = R[\frac{fI}{fa}]$. Then
there is a surjective $R$-algebra map $R' \to R''$ whose kernel
is the set of $f$-power torsion elements of $R'$.
\end{lemma}

\begin{proof}
The map is given by sending $x/a^n$ for $x \in I^n$ to $f^nx/(fa)^n$.
It is straightforward to check this map is well defined and surjective.
Since $af$ is a nonzero divisor in $R''$
(Lemma \ref{lemma-affine-blowup}) we see that the set of $f$-power
torsion elements are mapped to zero. Conversely, if $x \in R'$
and $f^n x \not = 0$ for all $n > 0$, then $(af)^n x \not = 0$
for all $n$ as $a$ is a nonzero divisor in $R'$. It follows
that the image of $x$ in $R''$ is not zero by the description of
$R''$ following Definition \ref{definition-blow-up}.
\end{proof}

\begin{lemma}
\label{lemma-blowup-reduced}
If $R$ is reduced then every (affine) blowup algebra of $R$ is reduced.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal and $a \in I$. Suppose $x/a^n$ with
$x \in I^n$ is a nilpotent element of $R[\frac{I}{a}]$. Then
$(x/a^n)^m = 0$. Hence $a^N x^m = 0$ in $R$ for some $N \geq 0$.
After increasing $N$ if necessary we may assume $N = me$ for some
$e \geq 0$. Then $(a^e x)^m = 0$ and since $R$ is reduced we find
$a^e x = 0$. This means that $x/a^n = 0$ in $R[\frac{I}{a}]$.
\end{proof}

\begin{lemma}
\label{lemma-blowup-domain}
If $R$ is a domain then every (affine) blowup algebra of $R$ is a domain.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal and $a \in I$ nonzero.
Suppose $x/a^n$, $y/a^m$ with $x \in I^n$, $y \in I^m$
are elements of $R[\frac{I}{a}]$ whose product is zero.
Then $a^N x y = 0$ in $R$. Since $R$ is a domain we conclude
that either $x = 0$ or $y = 0$.
\end{proof}

\begin{lemma}
\label{lemma-blowup-dominant}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $a \in I$.
If $a$ is not contained in any minimal prime of $R$, then
$\Spec(R[\frac{I}{a}]) \to \Spec(R)$ has dense image.
\end{lemma}

\begin{proof}
If $a^k x = 0$ for $x \in R$, then $x$ is contained in all the
minimal primes of $R$ and hence nilpotent, see
Lemma \ref{lemma-Zariski-topology}.
Thus the kernel of $R \to R[\frac{I}{a}]$ consists of nilpotent
elements. Hence the result follows from
Lemma \ref{lemma-image-dense-generic-points}.
\end{proof}

\begin{lemma}
\label{lemma-blowup-regular-sequence}
Let $R$ be a Noetherian ring. Let $a, a_2, \ldots, a_r$ be a
regular sequence in $R$. With $I = (a, a_2, \ldots, a_r)$ the
blowup algebra $R' = R[\frac{I}{a}]$ is isomorphic to
$R'' = R[y_2, \ldots, y_r]/(a y_i - a_i)$.
\end{lemma}

\begin{proof}
There is a canonical map $R'' \to R'$ sending $y_i$ to the class
of $a_i/a$. Since every element $x$ of $I$ can be written
as $ra + \sum r_i a_i$ we see that
$x/a = r + \sum r_i a_i/a$ is in the image of the map. Hence
our map is surjective. Suppose that $z = \sum r_E y^E \in R''$
maps to zero in $R'$. Here we use the multi-index notation
$E = (e_2, \ldots, e_r)$ and $y^E = y_2^{e_2} \ldots y_r^{e_r}$.
Let $d$ be the maximum of the degrees $|E| = \sum e_i$ of the
multi-indices which occur with a nonzero coefficient $r_E$ in $z$.
Then we see that
$$
a^d z = \sum r_E a^{d - |E|} a_2^{e_2} \ldots a_r^{e_r}
$$
is zero in $R$; here we use that $a$ is a nonzerodivisor on $R$.
Since a regular sequence is quasi-regular
by Lemma \ref{lemma-regular-quasi-regular}
we conclude that $r_E \in I$ for all $E$.
This means that $z$ is divisible by $a$ in $R''$.
Say $z = az'$. Then $z'$ is in the kernel of $R'' \to R'$
and we see that $z'$ is divisible by $a$ and so on.
In other words, $z$ is an element of $\bigcap a^n R''$.
Since $R''$ is Noetherian by Krull's intersection theorem
$z$ maps to zero in $R''_\mathfrak p$ for every prime ideal
$\mathfrak p$ containing $aR''$, see
Remark \ref{remark-intersection-powers-ideal}.
On the other hand, if $\mathfrak p \subset R''$ does
not contain $a$, then $R''_a \cong R_a \cong R'_a$ and
we find that $z$ maps to zero in $R''_\mathfrak p$ as well.
We conclude that $z$ is zero by Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-colimit-affine-blowups}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $R \subset A \subset K$ be a valuation ring which dominates $R$.
Then
$$
A = \colim R[\textstyle{\frac{I}{a}}]
$$
is a directed colimit of affine blowups $R \to R[\frac{I}{a}]$ with
the following properties
\begin{enumerate}
\item $a \in I \subset \mathfrak m$,
\item $I$ is finitely generated, and
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider a finite subset $E \subset A$. Say $E = \{e_1, \ldots, e_n\}$.
Choose a nonzero $a \in R$ such that we can write $e_i = f_i/a$ for
all $i = 1, \ldots, n$. Set $I = (f_1, \ldots, f_n, a)$.
We claim that $R[\frac{I}{a}] \subset A$. This is clear as an element
of $R[\frac{I}{a}]$ can be represented as a polynomial in the elements
$e_i$. The lemma follows immediately from this observation.
\end{proof}










\section{Ext groups}
\label{section-ext}

\noindent
In this section we do a tiny bit of homological algebra,
in order to establish some fundamental properties of
depth over Noetherian local rings.

\begin{lemma}
\label{lemma-resolution-by-finite-free}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item There exists an exact complex
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0.
$$
with $F_i$ free $R$-modules.
\item If $R$ is Noetherian and $M$ finite over $R$, then we
can choose the complex such that $F_i$ is finite free.
In other words, we can find an exact complex
$$
\ldots \to R^{\oplus n_2} \to R^{\oplus n_1} \to R^{\oplus n_0} \to M \to 0.
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let us explain only the Noetherian case.
As a first step choose a surjection $R^{n_0} \to M$.
Then having constructed an exact complex of length
$e$ we simply choose a surjection $R^{n_{e + 1}} \to
\Ker(R^{n_e} \to R^{n_{e-1}})$ which is possible
because $R$ is Noetherian.
\end{proof}

\begin{definition}
\label{definition-finite-free-resolution}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item A (left) {\it resolution} $F_\bullet \to M$ of $M$ is an exact complex
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0
$$
of $R$-modules.
\item A {\it resolution of $M$ by free $R$-modules} is a resolution
$F_\bullet \to M$ where each $F_i$ is a free $R$-module.
\item A {\it resolution of $M$ by finite free $R$-modules} is a resolution
$F_\bullet \to M$ where each $F_i$ is a finite free $R$-module.
\end{enumerate}
\end{definition}

\noindent
We often use the notation $F_{\bullet}$ to denote a complex
of $R$-modules
$$
\ldots \to F_i \to F_{i-1} \to \ldots
$$
In this case we often use $d_i$ or $d_{F, i}$ to denote the map
$F_i \to F_{i-1}$. In this section we are always going to
assume that $F_0$ is the last nonzero term in the complex.
The {\it $i$th homology group of the complex} $F_{\bullet}$
is the group $H_i = \Ker(d_{F, i})/\Im(d_{F, i + 1})$.
A {\it map of complexes $\alpha : F_{\bullet} \to G_{\bullet}$}
is given by maps $\alpha_i : F_i \to G_i$ such that
$\alpha_{i-1} \circ d_{F, i} = d_{G, i-1} \circ \alpha_i$.
Such a map induces a map on homology $H_i(\alpha) :
H_i(F_{\bullet}) \to H_i(G_{\bullet})$. If $\alpha, \beta
:  F_{\bullet} \to G_{\bullet}$ are maps of complexes, then
a {\it homotopy} between $\alpha$ and $\beta$ is given by
a collection of maps $h_i : F_i \to G_{i + 1}$ such that
$\alpha_i - \beta_i = d_{G, i + 1} \circ h_i +
h_{i-1} \circ d_{F, i}$.

\medskip\noindent
We will use a very similar notation regarding complexes
of the form $F^{\bullet}$ which look like
$$
\ldots \to F^i \xrightarrow{d^i} F^{i + 1} \to \ldots
$$
There are maps of complexes, homotopies, etc.
In this case we set $H^i(F^{\bullet}) =
\Ker(d^i)/\Im(d^{i - 1})$ and we call it
the {\it $i$th cohomology group}.

\begin{lemma}
\label{lemma-homotopic-equal-homology}
Any two homotopic maps of complexes induce the same maps on
(co)homology groups.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-compare-resolutions}
Let $R$ be a ring. Let $M \to N$ be a map of $R$-modules.
Let $F_\bullet \to M$ be a resolution by free $R$-modules and
let $N_\bullet \to N$ be an arbitrary resolution. Then
\begin{enumerate}
\item there exists a map of complexes $F_\bullet \to N_\bullet$
inducing the given map
$$
M = \Coker(F_1 \to F_0) \to \Coker(N_1 \to N_0) = N
$$
\item two maps $\alpha, \beta : F_\bullet \to N_\bullet$
inducing the same map $M \to N$ are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Because $F_0$ is free we can find a map $F_0 \to N_0$
lifting the map $F_0 \to M \to N$. We obtain an induced
map $F_1 \to F_0 \to N_0$ which ends up in the image
of $N_1 \to N_0$. Since $F_1$ is free we may lift this
to a map $F_1 \to N_1$. This in turn induces a map
$F_2 \to F_1 \to N_1$ which maps to zero into
$N_0$. Since $N_\bullet$ is exact we see that
the image of this map is contained in the image
of $N_2 \to N_1$. Hence we may lift to get a map
$F_2 \to N_2$. Repeat.

\medskip\noindent
Proof of (2). To show that $\alpha, \beta$ are homotopic it suffices
to show the difference $\gamma = \alpha - \beta$ is homotopic
to zero. Note that the image of $\gamma_0 : F_0 \to N_0$
is contained in the image of $N_1 \to N_0$. Hence we may lift
$\gamma_0$ to a map $h_0 : F_0 \to N_1$. Consider the map
$\gamma_1' = \gamma_1 - h_0 \circ d_{F, 1}$. By our choice of $h_0$
we see that the image of $\gamma_1'$ is contained in
the kernel of $N_1 \to N_0$. Since $N_\bullet$ is exact
we may lift $\gamma_1'$ to a map $h_1 : F_1 \to N_2$.
At this point we have $\gamma_1 = h_0 \circ d_{F, 1}
+ d_{N, 2} \circ h_1$. Repeat.
\end{proof}

\noindent
At this point we are ready to define the groups
$\text{Ext}^i_R(M, N)$. Namely, choose a resolution
$F_{\bullet}$ of $M$ by free $R$-modules, see Lemma
\ref{lemma-resolution-by-finite-free}. Consider
the (cohomological) complex
$$
\Hom_R(F_\bullet, N) :
\Hom_R(F_0, N) \to
\Hom_R(F_1, N) \to
\Hom_R(F_2, N) \to \ldots
$$
We define $\text{Ext}^i_R(M, N)$ for $i \geq 0$ to be the $i$th
cohomology group of this complex\footnote{At this point
it would perhaps be more appropriate to say ``an'' in stead
of ``the'' Ext-group.}. For $i < 0$ we set $\text{Ext}^i_R(M, N) = 0$.
Before we continue we point out that
$$
\text{Ext}^0_R(M, N) = \Ker(\Hom_R(F_0, N) \to \Hom_R(F_1, N)) =
\Hom_R(M, N)
$$
because we can apply part (1) of Lemma \ref{lemma-hom-exact} to
the exact sequence $F_1 \to F_0 \to M \to 0$.
The following lemma explains
in what sense this is well defined.

\begin{lemma}
\label{lemma-ext-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_{\bullet}$ is a free resolution of the module $M_1$,
and $G_{\bullet}$ is a free resolution of the module $M_2$.
Let $\varphi : M_1 \to M_2$ be a module map.
Let $\alpha : F_{\bullet} \to G_{\bullet}$ be
a map of complexes inducing $\varphi$ on
$M_1 = \Coker(d_{F, 1}) \to M_2 = \Coker(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H^i(\alpha) :
H^i(\Hom_R(F_{\bullet}, N))
\longrightarrow
H^i(\Hom_R(G_{\bullet}, N))
$$
are independent of the choice of $\alpha$.
If $\varphi$ is an isomorphism, so are all the maps
$H^i(\alpha)$. If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
Another map $\beta : F_{\bullet} \to G_{\bullet}$
inducing $\varphi$ is homotopic to $\alpha$ by
Lemma \ref{lemma-compare-resolutions}. Hence the
maps $\Hom_R(F_\bullet, N) \to
\Hom_R(G_\bullet, N)$ are homotopic.
Hence the independence result follows from
Lemma \ref{lemma-homotopic-equal-homology}.

\medskip\noindent
Suppose that $\varphi$ is an isomorphism.
Let $\psi : M_2 \to M_1$ be an inverse.
Choose $\beta : G_{\bullet} \to F_{\bullet}$
be a map inducing $\psi :
M_2 = \Coker(d_{G, 1}) \to M_1 = \Coker(d_{F, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
OK, and now consider the map
$H^i(\alpha) \circ H^i(\beta) =
H^i(\alpha \circ \beta)$. By the above the
map $H^i(\alpha \circ \beta)$ is the {\it same}
as the map $H^i(\text{id}_{G_{\bullet}}) = \text{id}$.
Similarly for the composition $H^i(\beta) \circ H^i(\alpha)$.
Hence $H^i(\alpha)$ and $H^i(\beta)$ are inverses of each other.
\end{proof}

\begin{lemma}
\label{lemma-long-exact-seq-ext}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $0 \to N' \to N \to N'' \to 0$ be a
short exact sequence. Then we get a long exact
sequence
$$
\begin{matrix}
0
\to \Hom_R(M, N')
\to \Hom_R(M, N)
\to \Hom_R(M, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(M, N')
\to \text{Ext}^1_R(M, N)
\to \text{Ext}^1_R(M, N'')
\to \ldots
\end{matrix}
$$
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet} \to M$.
Since each of the $F_i$ are free we see that
we get a short exact sequence of complexes
$$
0 \to
\Hom_R(F_{\bullet}, N') \to
\Hom_R(F_{\bullet}, N) \to
\Hom_R(F_{\bullet}, N'') \to
0
$$
Thus we get the long exact sequence from
the snake lemma applied to this.
\end{proof}

\begin{lemma}
\label{lemma-reverse-long-exact-seq-ext}
Let $R$ be a ring. Let $N$ be an $R$-module.
Let $0 \to M' \to M \to M'' \to 0$ be a
short exact sequence. Then we get a long exact
sequence
$$
\begin{matrix}
0
\to \Hom_R(M'', N)
\to \Hom_R(M, N)
\to \Hom_R(M', N)
\\
\phantom{0\ }
\to \text{Ext}^1_R(M'', N)
\to \text{Ext}^1_R(M, N)
\to \text{Ext}^1_R(M', N)
\to \ldots
\end{matrix}
$$
\end{lemma}

\begin{proof}
Pick sets of generators $\{m'_{i'}\}_{i' \in I'}$ and
$\{m''_{i''}\}_{i'' \in I''}$ of $M'$ and $M''$.
For each $i'' \in I''$ choose a lift $\tilde m''_{i''} \in M$
of the element $m''_{i''} \in M''$. Set $F' = \bigoplus_{i' \in I'} R$,
$F'' = \bigoplus_{i'' \in I''} R$ and $F = F' \oplus F''$.
Mapping the generators of these free modules to the corresponding
chosen generators gives surjective $R$-module maps $F' \to M'$,
$F'' \to M''$, and $F \to M$. We obtain a map of short exact sequences
$$
\begin{matrix}
0 & \to & M' & \to & M & \to & M'' & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow \\
0 & \to & F' & \to & F & \to & F'' & \to & 0 \\
\end{matrix}
$$
By the snake lemma we see that the sequence of kernels
$0 \to K' \to K \to K'' \to 0$ is short exact sequence of $R$-modules.
Hence we can continue this process indefinitely. In other words
we obtain a short exact sequence of resolutions fitting into the diagram
$$
\begin{matrix}
0 & \to & M' & \to & M & \to & M'' & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow \\
0 & \to & F_\bullet' & \to & F_\bullet & \to & F_\bullet'' & \to & 0 \\
\end{matrix}
$$
Because each of the sequences $0 \to F'_n \to F_n \to F''_n \to 0$
is split exact (by construction) we obtain a short exact sequence of
complexes
$$
0 \to
\Hom_R(F''_{\bullet}, N) \to
\Hom_R(F_{\bullet}, N) \to
\Hom_R(F'_{\bullet}, N) \to
0
$$
by applying the $\Hom_R(-, N)$ functor.
Thus we get the long exact sequence from
the snake lemma applied to this.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-ext}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules.
Any $x\in R$ such that either $xN = 0$, or $xM = 0$
annihilates each of the modules $\text{Ext}^i_R(M, N)$.
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet}$ of $M$.
Since $\text{Ext}^i_R(M, N)$
is defined as the cohomology of the complex
$\Hom_R(F_{\bullet}, N)$ the lemma is
clear when $xN = 0$. If $xM = 0$, then
we see that multiplication by $x$ on $F_{\bullet}$
lifts the zero map on $M$. Hence by Lemma
\ref{lemma-ext-welldefined} we see that it
induces the same map on Ext groups as the
zero map.
\end{proof}

\begin{lemma}
\label{lemma-ext-noetherian}
Let $R$ be a Noetherian ring. Let $M$, $N$ be finite $R$-modules.
Then $\text{Ext}^i_R(M, N)$ is a finite $R$-module for all $i$.
\end{lemma}

\begin{proof}
This holds because $\text{Ext}^i_R(M, N)$ is computed as the
cohomology groups of a complex $\Hom_R(F_\bullet, N)$
with each $F_n$ a finite free $R$-module, see
Lemma \ref{lemma-resolution-by-finite-free}.
\end{proof}




\section{Depth}
\label{section-depth}

\noindent
Here is our definition.

\begin{definition}
\label{definition-depth}
Let $R$ be a ring, and $I \subset R$ an ideal. Let $M$ be a finite $R$-module.
The {\it $I$-depth} of $M$, denoted $\text{depth}_I(M)$, is defined as follows:
\begin{enumerate}
\item if $IM \not = M$, then $\text{depth}_I(M)$ is the supremum in
$\{0, 1, 2, \ldots, \infty\}$ of the lengths of $M$-regular sequences in $I$,
\item if $IM = M$ we set $\text{depth}_I(M) = \infty$.
\end{enumerate}
If $(R, \mathfrak m)$ is local we call $\text{depth}_{\mathfrak m}(M)$ simply
the {\it depth} of $M$.
\end{definition}

\noindent
Explanation. By Definition \ref{definition-regular-sequence} the empty
sequence is not a regular sequence on the zero module, but for practical
purposes it turns out to be convenient to set the depth of the $0$ module
equal to $+\infty$. Note that if $I = R$, then $\text{depth}_I(M) = \infty$
for all finite $R$-modules $M$. If $I$ is contained in the radical ideal
of $R$ (e.g., if $R$ is local and $I \subset \mathfrak m_R$), then
$M \not = 0 \Rightarrow IM \not = M$ by Nakayama's lemma.
A module $M$ has $I$-depth $0$ if and only if $M$ is nonzero and $I$ does
not contain a nonzerodivisor on $M$.

\medskip\noindent
Example \ref{example-global-regular} shows depth does not
behave well even if the ring is Noetherian, and Example
\ref{example-local-regular} shows that it does not
behave well if the ring is local but non-Noetherian.
We will see depth behaves well if the ring is local Noetherian.

\begin{lemma}
\label{lemma-depth-weak-sequence}
Let $R$ be a ring, $I \subset R$ an ideal, and $M$ a finite $R$-module.
Then $\text{depth}_I(M)$ is equal to the supremum of the lengths of
sequences $f_1, \ldots, f_r \in I$ such that $f_i$ is a nonzerodivisor
on $M/(f_1, \ldots, f_{i - 1})M$.
\end{lemma}

\begin{proof}
Suppose that $IM = M$. Then Lemma \ref{lemma-NAK} shows there exists
an $f \in I$ such that $f : M \to M$ is $\text{id}_M$. Hence
$f, 0, 0, 0, \ldots$ is an infinite sequence of successive
nonzerodivisors and we see agreement holds in this case.
If $IM \not =  M$, then we see that a sequence as in the lemma
is an $M$-regular sequence and we conclude that agreement holds as well.
\end{proof}

\begin{lemma}
\label{lemma-bound-depth}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
Let $M$ be a nonzero finite $R$-module.
Then $\dim(\text{Supp}(M)) \geq \text{depth}(M)$.
\end{lemma}

\begin{proof}
The proof is by induction on $\dim(\text{Supp}(M))$.
If $\dim(\text{Supp}(M)) = 0$, then
$\text{Supp}(M) = \{\mathfrak m\}$, whence $\text{Ass}(M) = \{\mathfrak m\}$
(by Lemmas \ref{lemma-ass-support} and \ref{lemma-ass-zero}), and hence
and the depth of $M$ is zero for example by
Lemma \ref{lemma-ideal-nonzerodivisor}.
For the induction step we assume $\dim(\text{Supp}(M)) > 0$.
Let $f_1, \ldots, f_d$ be a sequence of elements of $\mathfrak m$
such that $f_i$ is a nonzerodivisor on $M/(f_1, \ldots, f_{i - 1})$.
According to Lemma \ref{lemma-depth-weak-sequence} it suffices to prove
$\dim(\text{Supp}(M)) \geq d$. We may assume
$d > 0$ otherwise the lemma holds. By
Lemma \ref{lemma-one-equation-module}
we have $\dim(\text{Supp}(M/f_1M)) \leq \dim(\text{Supp}(M)) - 1$.
By induction we conclude $\dim(\text{Supp}(M/f_1M)) - 1 \geq d - 1$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-depth-finite-noetherian}
Let $R$ be a Noetherian ring, $I \subset R$ an ideal, and $M$ a
finite nonzero $R$-module such that $IM \not = M$. Then
$\text{depth}_I(M) < \infty$.
\end{lemma}

\begin{proof}
Since $M/IM$ is a nonzero we can choose $\mathfrak p \in \text{Supp}(M/IM)$
by Lemma \ref{lemma-support-zero}. Then $(M/IM)_\mathfrak p \not = 0$
which implies $I \subset \mathfrak p$ and moreover implies
$M_\mathfrak p \not = IM_\mathfrak p$ as localization is exact.
Let $f_1, \ldots, f_r \in I$ be an $M$-regular sequence.
Then $M_\mathfrak p/(f_1, \ldots, f_r)M_\mathfrak p$ is
nonzero as $(f_1, \ldots, f_r) \subset I$. As localization is
flat we see that the images of $f_1, \ldots, f_r$ form a
$M_\mathfrak p$-regular sequence in $I_\mathfrak p$. Since this
works for every $M$-regular sequence in $I$ we conclude that
$\text{depth}_I(M) \leq \text{depth}_{I_\mathfrak p}(M_\mathfrak p)$.
The latter is $\leq \text{depth}(M_\mathfrak p)$ which is
$< \infty$ by Lemma \ref{lemma-bound-depth}.
\end{proof}

\begin{lemma}
\label{lemma-depth-ext}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a nonzero finite $R$-module. Then $\text{depth}(M)$
is equal to the smallest integer $i$ such that
$\text{Ext}^i_R(R/\mathfrak m, M)$ is nonzero.
\end{lemma}

\begin{proof}
Let $\delta(M)$ denote the depth of $M$ and let $i(M)$ denote
the smallest integer $i$ such that $\text{Ext}^i_R(R/\mathfrak m, M)$
is nonzero. We will see in a moment that $i(M) < \infty$.
By Lemma \ref{lemma-ideal-nonzerodivisor} we have
$\delta(M) = 0$ if and only if $i(M) = 0$, because
$\mathfrak m \in \text{Ass}(M)$ exactly means
that $i(M) = 0$. Hence if $\delta(M)$ or $i(M)$ is $> 0$, then we may
choose $x \in \mathfrak m$ such that (a) $x$ is a nonzerodivisor
on $M$, and (b) $\text{depth}(M/xM) = \delta(M) - 1$.
Consider the long exact sequence
of Ext-groups associated to the short exact sequence
$0 \to M \to M \to M/xM \to 0$ by Lemma \ref{lemma-long-exact-seq-ext}:
$$
\begin{matrix}
0
\to \Hom_R(\kappa, M)
\to \Hom_R(\kappa, M)
\to \Hom_R(\kappa, M/xM)
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M/xM)
\to \ldots
\end{matrix}
$$
Since $x \in \mathfrak m$ all the maps $\text{Ext}^i_R(\kappa, M)
\to \text{Ext}^i_R(\kappa, M)$ are zero, see
Lemma \ref{lemma-annihilate-ext}.
Thus it is clear that $i(M/xM) = i(M) - 1$. Induction on
$\delta(M)$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-depth-in-ses}
Let $R$ be a local Noetherian ring. Let $0 \to N' \to N \to N'' \to 0$
be a short exact sequence of finite $R$-modules.
\begin{enumerate}
\item
$\text{depth}(N) \geq \min\{\text{depth}(N'), \text{depth}(N'')\}$
\item
$\text{depth}(N'') \geq \min\{\text{depth}(N), \text{depth}(N') - 1\}$
\item
$\text{depth}(N') \geq \min\{\text{depth}(N), \text{depth}(N'') + 1\}$
\end{enumerate}
\end{lemma}

\begin{proof}
Use the characterization of depth using the Ext groups
$\text{Ext}^i(\kappa, N)$, see Lemma \ref{lemma-depth-ext},
and use the long exact cohomology sequence
$$
\begin{matrix}
0
\to \Hom_R(\kappa, N')
\to \Hom_R(\kappa, N)
\to \Hom_R(\kappa, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, N')
\to \text{Ext}^1_R(\kappa, N)
\to \text{Ext}^1_R(\kappa, N'')
\to \ldots
\end{matrix}
$$
from Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}

\begin{lemma}
\label{lemma-depth-drops-by-one}
Let $R$ be a local Noetherian ring and $M$ a nonzero finite $R$-module.
\begin{enumerate}
\item If $x \in \mathfrak m$ is a nonzerodivisor on $M$, then
$\text{depth}(M/xM) = \text{depth}(M) - 1$.
\item Any $M$-regular sequence $x_1, \ldots, x_r$ can be extended to an
$M$-regular sequence of length $\text{depth}(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) is a formal consequence of part (1). Let $x \in R$ be as in (1).
By the short exact sequence $0 \to M \to M \to M/xM \to 0$
and Lemma \ref{lemma-depth-in-ses} we see that the depth drops by at most 1.
On the other hand, if $x_1, \ldots, x_r \in \mathfrak m$
is a regular sequence for $M/xM$, then $x, x_1, \ldots, x_r$
is a regular sequence for $M$. Hence we see that the depth drops by
at least 1.
\end{proof}

\begin{lemma}
\label{lemma-inherit-minimal-primes}
Let $(R, \mathfrak m)$ be a local Noetherian ring and $M$ a finite $R$-module.
Let $x \in \mathfrak m$, $\mathfrak p \in \text{Ass}(M)$, and $\mathfrak q$
minimal over $\mathfrak p + (x)$. Then $\mathfrak q \in \text{Ass}(M/x^nM)$
for some $n \geq 1$.
\end{lemma}

\begin{proof}
Pick a submodule $N \subset M$ with $N \cong R/\mathfrak p$.
By the Artin-Rees lemma (Lemma \ref{lemma-Artin-Rees})
we can pick $n > 0$ such that $N \cap x^nM \subset xN$.
Let $\overline{N} \subset M/x^nM$ be the image of $N \to M \to M/x^nM$.
By Lemma \ref{lemma-ass} it suffices to show
$\mathfrak q \in \text{Ass}(\overline{N})$.
By our choice of $n$ there is a surjection
$\overline{N} \to N/xN = R/\mathfrak p + (x)$
and hence $\mathfrak q$ is in the support of $\overline{N}$.
Since $\overline{N}$ is annihilated by $x^n$ and $\mathfrak p$ we see that
$\mathfrak q$ is minimal among the primes in the support of $\overline{N}$.
Thus $\mathfrak q$ is an associated prime of $\overline{N}$ by
Lemma \ref{lemma-ass-minimal-prime-support}.
\end{proof}

\begin{lemma}
\label{lemma-depth-dim-associated-primes}
Let $(R, \mathfrak m)$ be a local Noetherian ring and $M$ a finite $R$-module.
For $\mathfrak p \in \text{Ass}(M)$ we have
$\dim(R/\mathfrak p) \geq \text{depth}(M)$.
\end{lemma}

\begin{proof}
If $\mathfrak m \in \text{Ass}(M)$ then there is a nonzero element
$x \in M$ which is annihilated by all elements of $\mathfrak m$.
Thus $\text{depth}(M) = 0$. In particular the lemma holds in this case.

\medskip\noindent
If $\text{depth}(M) = 1$, then by the first paragraph
we find that $\mathfrak m \not \in \text{Ass}(M)$.
Hence $\dim(R/\mathfrak p) \geq 1$ for all $\mathfrak p \in \text{Ass}(M)$
and the lemma is true in this case as well.

\medskip\noindent
We will prove the lemma in general by induction on $\text{depth}(M)$
which we may and do assume to be $> 1$. Pick $x \in \mathfrak m$ which
is a nonzerodivisor on $M$. Note $x \not \in \mathfrak p$
(Lemma \ref{lemma-ass-zero-divisors}).
By Lemma \ref{lemma-one-equation} we have
$\dim(R/\mathfrak p + (x)) = \dim(R/\mathfrak p) - 1$.
Thus there exists a prime $\mathfrak q$ minimal over $\mathfrak p + (x)$ with
$\dim(R/\mathfrak q) = \dim(R/\mathfrak p) - 1$ (small argument omitted;
hint: the dimension of a Noetherian local ring $A$ is the maximum
of the dimensions of $A/\mathfrak r$ taken over the minimal
primes $\mathfrak r$ of $A$). Pick $n$ as in
Lemma \ref{lemma-inherit-minimal-primes} so that
$\mathfrak q$ is an associated prime of $M/x^nM$.
We may apply induction hypothesis to $M/x^nM$ and $\mathfrak q$
because $\text{depth}(M/x^nM) = \text{depth}(M) - 1$ by
Lemma \ref{lemma-depth-drops-by-one}. We find
$\dim(R/\mathfrak q) \geq \text{depth}(M/x^nM)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-depth-goes-down-finite}
Let $(R, \mathfrak m)$ be a Noetherian local ring. Let $R \to S$
be a finite ring map. Let $\mathfrak m_1, \ldots, \mathfrak m_n$
be the maximal ideals of $S$. Let $N$ be a finite $S$-module.
Then
$$
\min\nolimits_{i = 1, \ldots, n} \text{depth}(N_{\mathfrak m_i}) =
\text{depth}(N)
$$
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-integral-no-inclusion}, \ref{lemma-integral-going-up},
and Lemma \ref{lemma-finite-finite-fibres} the maximal ideals of
$S$ are exactly the primes of $S$ lying over $\mathfrak m$ and
there are finitely many of them. Hence the statement of the lemma
makes sense. We will prove the lemma by induction on
$k = \min\nolimits_{i = 1, \ldots, n} \text{depth}(N_{\mathfrak m_i})$.
If $k = 0$, then $\text{depth}(N_{\mathfrak m_i}) = 0$ for some $i$.
By Lemma \ref{lemma-depth-ext} this means
$\mathfrak m_i S_{\mathfrak m_i}$ is an associated prime
of $N_{\mathfrak m_i}$ and hence $\mathfrak m_i$ is an
associated prime of $N$ (Lemma \ref{lemma-localize-ass}).
By Lemma \ref{lemma-ass-functorial-Noetherian} we see that
$\mathfrak m$ is an associated prime of $N$ as an $R$-module.
Whence $\text{depth}(N) = 0$. This proves the base case.
If $k > 0$, then we see that $\mathfrak m_i \not \in \text{Ass}_S(N)$.
Hence $\mathfrak m \not \in \text{Ass}_R(N)$, again by
Lemma \ref{lemma-ass-functorial-Noetherian}.
Thus we can find $f \in \mathfrak m$ which is not a zerodivisor on
$N$, see Lemma \ref{lemma-ideal-nonzerodivisor}. By
Lemma \ref{lemma-depth-drops-by-one}
all the depths drop exactly by $1$ when passing from $N$ to
$N/fN$ and the induction hypothesis does the rest.
\end{proof}




\section{Functorialities for Ext}
\label{section-functoriality-ext}

\noindent
In this section we briefly discuss the functoriality
of $\text{Ext}$ with respect to change of ring, etc.
Here is a list of items to work out.
\begin{enumerate}
\item Given $R \to R'$, an $R$-module
$M$ and an $R'$-module $N'$
the $R$-module $\text{Ext}^i_R(M, N')$
has a natural $R'$-module structure. Moreover, there is a
canonical $R'$-linear map $\text{Ext}^i_{R'}(M \otimes_R R', N') \to
\text{Ext}^i_R(M, N')$.
\item Given $R \to R'$ and $R$-modules $M$, $N$ there is a natural
$R$-module map
$\text{Ext}^i_R(M, N) \to \text{Ext}^i_R(M, N \otimes_R R')$.
\end{enumerate}

\begin{lemma}
\label{lemma-flat-base-change-ext}
Given a flat ring map $R \to R'$, an $R$-module $M$, and an
$R'$-module $N'$ the natural map
$$
\text{Ext}^i_{R'}(M \otimes_R R', N') \to \text{Ext}^i_R(M, N')
$$
is an isomorphism for $i \geq 0$.
\end{lemma}

\begin{proof}
Choose a free resolution $F_\bullet$ of $M$.
Since $R \to R'$ is flat we see that $F_\bullet \otimes_R R'$ is
a free resolution of $M \otimes_R R'$ over $R'$.
The statement is that the map
$$
\Hom_{R'}(F_\bullet \otimes_R R', N') \to
\Hom_R(F_\bullet, N')
$$
induces an isomorphism on homology groups, which is true because
it is an isomorphism of complexes by
Lemma \ref{lemma-adjoint-tensor-restrict}.
\end{proof}






\section{An application of Ext groups}
\label{section-ext-application}

\noindent
Here it is.

\begin{lemma}
\label{lemma-split-injection-after-completion}
Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal
contained in the Jacobson radical of $R$.
Let $N \to M$ be a homomorphism of finite $R$-modules.
Suppose that there exists arbitrarily large $n$ such that
$N/I^nN \to M/I^nM$ is a split injection.
Then $N \to M$ is a split injection.
\end{lemma}

\begin{proof}
Assume $\varphi : N \to M$ satisfies the assumptions of the lemma.
Note that this implies that $\Ker(\varphi) \subset I^nN$
for arbitrarily large $n$. Hence by
Lemma \ref{lemma-intersection-powers-ideal-module} we see that $\varphi$
is injection. Let $Q = M/N$ so that we have a short exact sequence
$$
0 \to N \to M \to Q \to 0.
$$
Let
$$
F_2 \xrightarrow{d_2} F_1 \xrightarrow{d_1} F_0 \to Q \to 0
$$
be a finite free resolution of $Q$. We can choose a map
$\alpha : F_0 \to M$ lifting the map $F_0 \to Q$. This induces a map
$\beta : F_1 \to N$ such that $\beta \circ d_2 = 0$. The extension
above is split if and only if there exists a map $\gamma : F_0 \to N$
such that $\beta = \gamma \circ d_1$. In other words, the class of
$\beta$ in $\text{Ext}^1_R(Q, N)$ is the obstruction to splitting
the short exact sequence above.

\medskip\noindent
Suppose $n$ is a large integer such that $N/I^nN \to M/I^nM$ is a
split injection. This implies
$$
0 \to N/I^nN \to M/I^nM \to Q/I^nQ \to 0.
$$
is still short exact. Also, the sequence
$$
F_1/I^nF_1 \xrightarrow{d_1} F_0/I^nF_0 \to Q/I^nQ \to 0
$$
is still exact. Arguing as above we see that the map
$\overline{\beta} : F_1/I^nF_1 \to N/I^nN$
induced by $\beta$ is equal to $\gamma_n \circ d_1$ for some
map $\overline{\gamma_n} : F_0/I^nF_0 \to N/I^n$.
Since $F_0$ is free we can lift $\overline{\gamma_n}$ to a map
$\gamma_n : F_0 \to N$ and then we see that
$\beta - \gamma_n \circ d_1$ is a map from $F_1$ into $I^nN$.
In other words we conclude that
$$
\beta \in
\Im\Big(\Hom_R(F_0, N) \to \Hom_R(F_1, N)\Big) + I^n\Hom_R(F_1, N).
$$
for this $n$.

\medskip\noindent
Since we have this property for arbitrarily large $n$ by assumption
we conclude that the image of $\beta$ in the cokernel of
$\Hom_R(F_0, N) \to \Hom_R(F_1, N)$ is zero by 
Lemma \ref{lemma-intersection-powers-ideal-module}. Hence
$\beta$ is in the image of the map $\Hom_R(F_0, N) \to \Hom_R(F_1, N)$ as
desired.
\end{proof}











\section{Tor groups and flatness}
\label{section-tor}

\noindent
In this section we use some of the homological algebra
developed in the previous section to explain what
Tor groups are. Namely, suppose that $R$ is a ring
and that $M$, $N$ are two $R$-modules. Choose
a resolution $F_\bullet$ of $M$ by free $R$-modules.
See Lemma \ref{lemma-resolution-by-finite-free}.
Consider the homological complex
$$
F_\bullet \otimes_R N
:
\ldots
\to F_2 \otimes_R N
\to F_1 \otimes_R N
\to F_0 \otimes_R N
$$
We define $\text{Tor}^R_i(M, N)$ to be the $i$th homology
group of this complex. The following lemma explains in
what sense this is well defined.

\begin{lemma}
\label{lemma-tor-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_\bullet$ is a free resolution of
the module $M_1$ and that $G_\bullet$ is a free
resolution of the module $M_2$. Let $\varphi : M_1 \to M_2$
be a module map. Let $\alpha : F_\bullet \to G_\bullet$
be a map of complexes inducing $\varphi$ on
$M_1 = \Coker(d_{F, 1}) \to M_2 = \Coker(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H_i(\alpha) :
H_i(F_\bullet \otimes_R N)
\longrightarrow
H_i(G_\bullet \otimes_R N)
$$
are independent of the choice of $\alpha$. If $\varphi$
is an isomorphism, so are all the maps $H_i(\alpha)$.
If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
The proof of this lemma is identical to the proof of Lemma
\ref{lemma-ext-welldefined}.
\end{proof}

\noindent
Not only does this lemma imply that the Tor modules are well defined,
but it also provides for the functoriality of the constructions
$(M, N) \mapsto \text{Tor}_i^R(M, N)$ in the first variable. Of course
the functoriality in the second variable is evident. We leave it to
the reader to see that each of the $\text{Tor}_i^R$ is in fact
a functor
$$
\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R.
$$
Here $\text{Mod}_R$ denotes the category of $R$-modules, and
for the definition of the product category
see Categories, Definition \ref{categories-definition-product-category}.
Namely, given morphisms of $R$-modules $M_1 \to M_2$
and $N_1 \to N_2$ we get a commutative diagram
$$
\xymatrix{
\text{Tor}_i^R(M_1, N_1) \ar[r] \ar[d] &
\text{Tor}_i^R(M_1, N_2) \ar[d] \\
\text{Tor}_i^R(M_2, N_1) \ar[r] &
\text{Tor}_i^R(M_2, N_2) \\
}
$$

\begin{lemma}
\label{lemma-long-exact-sequence-tor}
Let $R$ be a ring and let $M$ be an $R$-module.
Suppose that $0 \to N' \to N \to N'' \to 0$ is a short
exact sequence of $R$-modules. There exists a long
exact sequence
$$
\begin{matrix}
M \otimes_R N'
\to M \otimes_R N
\to M \otimes_R N''
\to 0
\\
\text{Tor}_1^R(M, N')
\to \text{Tor}_1^R(M, N)
\to \text{Tor}_1^R(M, N'')
\to
\end{matrix}
$$
\end{lemma}

\begin{proof}
The proof of this is the same as the proof of
Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}

\noindent
Consider a homological double complex of $R$-modules
$$
\xymatrix{
\ldots \ar[r]^d &
A_{2, 0} \ar[r]^d &
A_{1, 0} \ar[r]^d &
A_{0, 0} \\
\ldots \ar[r]^d &
A_{2, 1} \ar[r]^d \ar[u]^\delta &
A_{1, 1} \ar[r]^d \ar[u]^\delta &
A_{0, 1} \ar[u]^\delta \\
\ldots \ar[r]^d &
A_{2, 2} \ar[r]^d \ar[u]^\delta &
A_{1, 2} \ar[r]^d \ar[u]^\delta &
A_{0, 2} \ar[u]^\delta \\
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \\
}
$$
This means that $d_{i, j} : A_{i, j} \to A_{i-1, j}$
and $\delta_{i, j} : A_{i, j} \to A_{i, j-1}$ have the following
properties
\begin{enumerate}
\item Any composition of two $d_{i, j}$ is zero. In other words
the rows of the double complex are complexes.
\item Any composition of two $\delta_{i, j}$ is zero. In other words
the columns of the double complex are complexes.
\item For any pair $(i, j)$ we have $\delta_{i-1, j} \circ d_{i, j}
= d_{i, j-1} \circ \delta_{i, j}$. In other words, all the squares
commute.
\end{enumerate}
The correct thing to do is to associate a spectral sequence to
any such double complex. However, for the moment we can get away with
doing something slightly easier.

\medskip\noindent
Namely, for the purposes of this section only, given a double
complex $(A_{\bullet, \bullet}, d, \delta)$ set
$R(A)_j = \Coker(A_{1, j} \to A_{0, j})$ and
$U(A)_i = \Coker(A_{i, 1} \to A_{i, 0})$. (The letters
$R$ and $U$ are meant to suggest Right and Up.)
We endow $R(A)_\bullet$ with the structure of a complex
using the maps $\delta$. Similarly we endow $U(A)_\bullet$
with the structure of a complex using the maps $d$.
In other words we obtain the following huge commutative diagram
$$
\xymatrix{
\ldots \ar[r]^d &
U(A)_2 \ar[r]^d &
U(A)_1 \ar[r]^d &
U(A)_0 &
\\
\ldots \ar[r]^d &
A_{2, 0} \ar[r]^d \ar[u] &
A_{1, 0} \ar[r]^d \ar[u] &
A_{0, 0} \ar[r] \ar[u] &
R(A)_0 \\
\ldots \ar[r]^d &
A_{2, 1} \ar[r]^d \ar[u]^\delta &
A_{1, 1} \ar[r]^d \ar[u]^\delta &
A_{0, 1} \ar[r] \ar[u]^\delta &
R(A)_1 \ar[u]^\delta \\
\ldots \ar[r]^d &
A_{2, 2} \ar[r]^d \ar[u]^\delta &
A_{1, 2} \ar[r]^d \ar[u]^\delta &
A_{0, 2} \ar[r] \ar[u]^\delta &
R(A)_2 \ar[u]^\delta \\
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \\
}
$$
(This is no longer a double complex of course.)
It is clear what a morphism $\Phi : (A_{\bullet, \bullet}, d, \delta)
\to (B_{\bullet, \bullet}, d, \delta)$ of double complexes
is, and it is clear that this induces morphisms of complexes
$R(\Phi) : R(A)_\bullet \to R(B)_\bullet$ and
$U(\Phi) : U(A)_\bullet \to U(B)_\bullet$.

\begin{lemma}
\label{lemma-no-spectral-sequence}
Let $(A_{\bullet, \bullet}, d, \delta)$ be a double complex such
that
\begin{enumerate}
\item Each row $A_{\bullet, j}$ is a resolution of $R(A)_j$.
\item Each column $A_{i, \bullet}$ is a resolution of $U(A)_i$.
\end{enumerate}
Then there are canonical isomorphisms
$$
H_i(R(A)_\bullet)
\cong
H_i(U(A)_\bullet).
$$
The isomorphisms are functorial with respect to morphisms
of double complexes with the properties above.
\end{lemma}

\begin{proof}
We will show that $H_i(R(A)_\bullet))$
and $H_i(U(A)_\bullet)$ are canonically
isomorphic to a third group. Namely
$$
\mathbf{H}_i(A) :=
\frac{
\{
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i})
\mid
d(a_{i, 0}) = \delta(a_{i-1, 1}), \ldots,
d(a_{1, i-1}) = \delta(a_{0, i})
\}}
{
\{
d(a_{i + 1, 0}) - \delta(a_{i, 1}),
d(a_{i, 1}) - \delta(a_{i-1, 2}),
\ldots,
d(a_{1, i}) - \delta(a_{0, i + 1})
\}
}
$$
Here we use the notational convention that $a_{i, j}$ denotes
an element of $A_{i, j}$. In other words, an element of $\mathbf{H}_i$
is represented by a zig-zag, represented as follows for $i = 2$
$$
\xymatrix{
a_{2, 0} \ar@{|->}[r] & d(a_{2, 0}) = \delta(a_{1, 1}) & \\
& a_{1, 1} \ar@{|->}[u] \ar@{|->}[r] & d(a_{1, 1}) = \delta(a_{0, 2}) \\
& & a_{0, 2} \ar@{|->}[u] \\
}
$$
Naturally, we divide out by ``trivial'' zig-zags, namely the submodule
generated by elements of the form $(0, \ldots, 0, -\delta(a_{t + 1, t-i}),
d(a_{t + 1, t-i}), 0, \ldots, 0)$. Note that there are canonical
homomorphisms
$$
\mathbf{H}_i(A) \to H_i(R(A)_\bullet), \quad
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto
\text{class of image of }a_{0, i}
$$
and
$$
\mathbf{H}_i(A) \to H_i(U(A)_\bullet), \quad
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto
\text{class of image of }a_{i, 0}
$$

\medskip\noindent
First we show that these maps are surjective.
Suppose that $\overline{r} \in H_i(R(A)_\bullet)$.
Let $r \in R(A)_i$ be a cocycle representing the
class of $\overline{r}$.
Let $a_{0, i} \in A_{0, i}$ be an element which
maps to $r$. Because $\delta(r) = 0$,
we see that $\delta(a_{0, i})$ is in the
image of $d$. Hence there exists an element
$a_{1, i-1} \in A_{1, i-1}$ such that
$d(a_{1, i-1}) = \delta(a_{0, i})$. This in turn
implies that $\delta(a_{1, i-1})$ is in the kernel
of $d$ (because $d(\delta(a_{1, i-1})) = \delta(d(a_{1, i-1}))
= \delta(\delta(a_{0, i})) = 0$. By exactness of the
rows we find an element $a_{2, i-2}$ such that
$d(a_{2, i-2}) = \delta(a_{1, i-1})$. And so on
until a full zig-zag is found. Of course surjectivity
of $\mathbf{H}_i \to H_i(U(A))$ is shown similarly.

\medskip\noindent
To prove injectivity we argue in exactly the same way.
Namely, suppose we are given a zig-zag
$(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i})$
which maps to zero in $H_i(R(A)_\bullet)$.
This means that $a_{0, i}$ maps to an element
of $\Coker(A_{i, 1} \to A_{i, 0})$
which is in the image of
$\delta : \Coker(A_{i + 1, 1} \to A_{i + 1, 0}) \to
\Coker(A_{i, 1} \to A_{i, 0})$.
In other words, $a_{0, i}$ is in the image of
$\delta \oplus d : A_{0, i + 1} \oplus A_{1, i} \to A_{0, i}$.
From the definition of trivial zig-zags we see that
we may modify our zig-zag by a trivial one and
assume that $a_{0, i} = 0$. This immediately
implies that $d(a_{1, i-1}) = 0$. As the rows
are exact this implies that $a_{1, i-1}$ is
in the image of $d : A_{2, i-1} \to A_{1, i-1}$.
Thus we may modify our zig-zag once again by a
trivial zig-zag and assume that our zig-zag looks
like $(a_{i, 0}, a_{i-1, 1}, \ldots, a_{2, i-2}, 0, 0)$.
Continuing like this we obtain the desired injectivity.

\medskip\noindent
If $\Phi : (A_{\bullet, \bullet}, d, \delta)
\to (B_{\bullet, \bullet}, d, \delta)$ is a morphism
of double complexes both of which satisfy the conditions
of the lemma, then we clearly obtain a commutative
diagram
$$
\xymatrix{
H_i(U(A)_\bullet) \ar[d] &
\mathbf{H}_i(A) \ar[r] \ar[l] \ar[d] &
H_i(R(A)_\bullet) \ar[d] \\
H_i(U(B)_\bullet) &
\mathbf{H}_i(B) \ar[r] \ar[l] &
H_i(R(B)_\bullet) \\
}
$$
This proves the functoriality.
\end{proof}

\begin{remark}
\label{remark-signs-double-complex}
The isomorphism constructed above is the ``correct'' one only up to signs.
A good part of homological algebra is concerned with choosing signs for
various maps and showing commutativity of diagrams with intervention
of suitable signs. For the moment we will simply use the isomorphism
as given in the proof above, and worry about signs later.
\end{remark}

\begin{lemma}
\label{lemma-tor-left-right}
Let $R$ be a ring. For any $i \geq 0$ the functors
$\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R$,
$(M, N) \mapsto \text{Tor}_i^R(M, N)$ and
$(M, N) \mapsto \text{Tor}_i^R(N, M)$ are
canonically isomorphic.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of the module $M$ and
let $G_\bullet$ be a free resolution of the module $N$.
Consider the double complex $(A_{i, j}, d, \delta)$ defined
as follows:
\begin{enumerate}
\item set $A_{i, j} = F_i \otimes_R G_j$,
\item set $d_{i, j} : F_i \otimes_R G_j \to F_{i-1} \otimes G_j$
equal to $d_{F, i} \otimes \text{id}$, and
\item set $\delta_{i, j} : F_i \otimes_R G_j \to F_i \otimes G_{j-1}$
equal to $\text{id} \otimes d_{G, j}$.
\end{enumerate}
This double complex is usually simply denoted $F_\bullet \otimes_R G_\bullet$.

\medskip\noindent
Since each $G_j$ is free, and hence flat we see that each
row of the double complex is exact except in homological
degree $0$. Since each $F_i$ is free and hence flat we see that each
column of the double complex is exact except in homological
degree $0$. Hence the double complex satisfies the conditions
of Lemma \ref{lemma-no-spectral-sequence}.

\medskip\noindent
To see what the lemma says we compute $R(A)_\bullet$ and $U(A)_\bullet$.
Namely,
\begin{eqnarray*}
R(A)_i & = & \Coker(A_{1, i} \to A_{0, i}) \\
& = & \Coker(F_1 \otimes_R G_i \to F_0 \otimes_R G_i) \\
& = & \Coker(F_1 \to F_0) \otimes_R G_i \\
& = & M \otimes_R G_i
\end{eqnarray*}
In fact these isomorphisms are compatible with the differentials
$\delta$ and we see that $R(A)_\bullet = M \otimes_R G_\bullet$
as homological complexes. In exactly the same way we see that
$U(A)_\bullet = F_\bullet \otimes_R N$. We get
\begin{eqnarray*}
\text{Tor}_i^R(M, N)
& = & H_i(F_\bullet \otimes_R N) \\
& = & H_i(U(A)_\bullet) \\
& = & H_i(R(A)_\bullet) \\
& = & H_i(M \otimes_R G_\bullet) \\
& = & H_i(G_\bullet \otimes_R M) \\
& = & \text{Tor}_i^R(N, M)
\end{eqnarray*}
Here the third equality is Lemma \ref{lemma-no-spectral-sequence}, and
the fifth equality uses the isomorphism $V \otimes W = W \otimes V$
of the tensor product.

\medskip\noindent
Functoriality. Suppose that we have $R$-modules $M_\nu$, $N_\nu$,
$\nu = 1, 2$. Let $\varphi : M_1 \to M_2$ and $\psi : N_1 \to N_2$
be morphisms of $R$-modules.
Suppose that we have free resolutions $F_{\nu, \bullet}$
for $M_\nu$ and free resolutions $G_{\nu, \bullet}$ for $N_\nu$.
By Lemma \ref{lemma-compare-resolutions} we may choose
maps of complexes $\alpha : F_{1, \bullet} \to F_{2, \bullet}$
and $\beta : G_{1, \bullet} \to G_{2, \bullet}$ compatible
with $\varphi$ and $\psi$. We claim that
the pair $(\alpha, \beta)$ induces a morphism of double
complexes
$$
\alpha \otimes \beta :
F_{1, \bullet} \otimes_R G_{1, \bullet}
\longrightarrow
F_{2, \bullet} \otimes_R G_{2, \bullet}
$$
This is really a very straightforward check using the rule
that $F_{1, i} \otimes_R G_{1, j} \to F_{2, i} \otimes_R G_{2, j}$
is given by $\alpha_i \otimes \beta_j$ where $\alpha_i$,
resp.\ $\beta_j$ is the degree $i$, resp.\ $j$ component of $\alpha$,
resp.\ $\beta$. The reader also readily verifies that the
induced maps $R(F_{1, \bullet} \otimes_R G_{1, \bullet})_\bullet
\to R(F_{2, \bullet} \otimes_R G_{2, \bullet})_\bullet$
agrees with the map $M_1 \otimes_R G_{1, \bullet}
\to M_2 \otimes_R G_{2, \bullet}$ induced by $\varphi \otimes \beta$.
Similarly for the map induced on the $U(-)_\bullet$ complexes.
Thus the statement on functoriality follows from the statement
on functoriality in Lemma \ref{lemma-no-spectral-sequence}.
\end{proof}

\begin{remark}
\label{remark-curiosity-signs-swap}
An interesting case occurs when $M = N$ in the above.
In this case we get a canonical map $\text{Tor}_i^R(M, M)
\to \text{Tor}_i^R(M, M)$. Note that this map is not the
identity, because even when $i = 0$ this map is not the
identity! For example, if $V$ is a vector space of dimension
$n$ over a field, then the switch map $V \otimes_k V \to V \otimes_k V$
has $(n^2 + n)/2$ eigenvalues $+1$ and $(n^2-n)/2$ eigenvalues
$-1$. In characteristic $2$ it is not even diagonalizable.
Note that even changing the sign of the map will not get rid
of this.
\end{remark}

\begin{lemma}
\label{lemma-tor-noetherian}
Let $R$ be a Noetherian ring. Let $M$, $N$ be finite $R$-modules.
Then $\text{Tor}_p^R(M, N)$ is a finite $R$-module for all $p$.
\end{lemma}

\begin{proof}
This holds because $\text{Tor}_p^R(M, N)$ is computed as the
cohomology groups of a complex $F_\bullet \otimes_R N$
with each $F_n$ a finite free $R$-module, see
Lemma \ref{lemma-resolution-by-finite-free}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-flat}
Let $R$ be a ring. Let $M$ be an $R$-module.
The following are equivalent:
\begin{enumerate}
\item The module $M$ is flat over $R$.
\item For all $i>0$ the functor $\text{Tor}_i^R(M, -)$ is zero.
\item The functor $\text{Tor}_1^R(M, -)$ is zero.
\item For all ideals $I \subset R$ we have $\text{Tor}_1^R(M, R/I) = 0$.
\item For all finitely generated ideals $I \subset R$ we have
$\text{Tor}_1^R(M, R/I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $M$ is flat. Let $N$ be an $R$-module.
Let $F_\bullet$ be a free resolution of $N$.
Then $F_\bullet \otimes_R M$ is a resolution of $N \otimes_R M$,
by flatness of $M$. Hence all higher Tor groups vanish.

\medskip\noindent
It now suffices to show that the last condition implies that
$M$ is flat. Let $I \subset R$ be an ideal.
Consider the short exact sequence
$0 \to I \to R \to R/I \to 0$. Apply
Lemma \ref{lemma-long-exact-sequence-tor}. We get an
exact sequence
$$
\text{Tor}_1^R(M, R/I) \to
M \otimes_R I \to
M \otimes_R R \to
M \otimes_R R/I \to
0
$$
Since obviously $M \otimes_R R = M$ we conclude that the
last hypothesis implies that $M \otimes_R I \to M$ is
injective for every finitely generated ideal $I$.
Thus $M$ is flat by Lemma \ref{lemma-flat}.
\end{proof}

\begin{remark}
\label{remark-Tor-ring-mod-ideal}
The proof of Lemma \ref{lemma-characterize-flat} actually shows
that
$$
\text{Tor}_1^R(M, R/I)
=
\Ker(I \otimes_R M \to M).
$$
\end{remark}














\section{Functorialities for Tor}
\label{section-functoriality-tor}

\noindent
In this section we briefly discuss the functoriality
of $\text{Tor}$ with respect to change of ring, etc.
Here is a list of items to work out.
\begin{enumerate}
\item Given a ring map $R \to R'$, an $R$-module
$M$ and an $R'$-module $N'$
the $R$-modules $\text{Tor}_i^R(M, N')$ have
a natural $R'$-module structure.
\item Given a ring map $R \to R'$ and $R$-modules
$M$, $N$ there is a natural $R$-module map
$\text{Tor}_i^R(M, N) \to \text{Tor}_i^{R'}(M \otimes_R R', N \otimes_R R')$.
\item Given a ring map $R \to R'$ an $R$-module $M$ and
an $R'$-module $N'$ there exists a natural
$R'$-module map
$\text{Tor}_i^R(M, N') \to \text{Tor}_i^{R'}(M \otimes_R R', N')$.
\end{enumerate}

\begin{lemma}
\label{lemma-flat-base-change-tor}
Given a flat ring map $R \to R'$ and $R$-modules
$M$, $N$ the natural $R$-module map
$\text{Tor}_i^R(M, N)\otimes_R R'
\to \text{Tor}_i^{R'}(M \otimes_R R', N \otimes_R R')$
is an isomorphism for all $i$.
\end{lemma}

\begin{proof}
Omitted. This is true because a free resolution $F_\bullet$ of $M$ over
$R$ stays exact when tensoring with $R'$ over $R$ and hence
$(F_\bullet \otimes_R N)\otimes_R R'$ computes the Tor groups
over $R'$.
\end{proof}

\noindent
The following lemma does not seem to fit anywhere else.

\begin{lemma}
\label{lemma-tor-commutes-filtered-colimits}
Let $R$ be a ring. Let $M = \colim M_i$ be a filtered colimit of
$R$-modules. Let $N$ be an $R$-module. Then
$\text{Tor}_n^R(M, N) = \colim \text{Tor}_n^R(M_i, N)$ for all $n$.
\end{lemma}

\begin{proof}
Choose a free resolution $F_\bullet$ of $N$. Then
$F_\bullet \otimes_R M = \colim F_\bullet \otimes_R M_i$
as complexes by Lemma \ref{lemma-tensor-products-commute-with-limits}.
Thus the result by Lemma \ref{lemma-directed-colimit-exact}.
\end{proof}








\section{Projective modules}
\label{section-projective}

\noindent
Some lemmas on projective modules.

\begin{definition}
\label{definition-projective}
Let $R$ be a ring. An $R$-module $P$ is {\it projective} if and only if
the functor $\Hom_R(P, -) : \text{Mod}_R \to \text{Mod}_R$ is
an exact functor.
\end{definition}

\noindent
The functor $\Hom_R(M, - )$ is left exact for any $R$-module $M$, see
Lemma \ref{lemma-hom-exact}.
Hence the condition for $P$ to be projective really signifies that given
a surjection of $R$-modules $N \to N'$ the map
$\Hom_R(P, N) \to \Hom_R(P, N')$ is surjective.

\begin{lemma}
\label{lemma-characterize-projective}
Let $R$ be a ring. Let $P$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $P$ is projective,
\item $P$ is a direct summand of a free $R$-module, and
\item $\text{Ext}^1_R(P, M) = 0$ for every $R$-module $M$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $P$ is projective. Choose a surjection $\pi : F \to P$ where $F$
is a free $R$-module. As $P$ is projective there exists a
$i \in \Hom_R(P, F)$ such that $i \circ \pi = \text{id}_P$.
In other words $F \cong \Ker(\pi) \oplus i(P)$ and we see
that $P$ is a direct summand of $F$.

\medskip\noindent
Conversely, assume that $P \oplus Q = F$ is a free $R$-module.
Note that the free module $F = \bigoplus_{i \in I} R$ is projective
as $\Hom_R(F, M) = \prod_{i \in I} M$ and the functor
$M \mapsto \prod_{i \in I} M$ is exact.
Then $\Hom_R(F, -) = \Hom_R(P, -) \times \Hom_R(Q, -)$
as functors, hence both $P$ and $Q$ are projective.

\medskip\noindent
Assume $P \oplus Q = F$ is a free $R$-module. Then we have a
free resolution $F_\bullet$ of the form
$$
\ldots F \xrightarrow{a} F \xrightarrow{b} F \to P \to 0
$$
where the maps $a, b$ alternate and are equal to the projector onto
$P$ and $Q$. Hence the complex $\Hom_R(F_\bullet, M)$ is split
exact in degrees $\geq 1$, whence we see the vanishing in (3).

\medskip\noindent
Assume $\text{Ext}^1_R(P, M) = 0$ for every $R$-module $M$.
Pick a free resolution $F_\bullet \to P$. Set
$M = \Im(F_1 \to F_0) = \Ker(F_0 \to P)$.
Consider the element $\xi \in \text{Ext}^1_R(P, M)$ given by
the class of the quotient map $\pi : F_1 \to M$. Since $\xi$ is zero
there exists a map $s : F_0 \to M$ such that $\pi = s \circ (F_1 \to F_0)$.
Clearly, this means that
$$
F_0 = \Ker(s) \oplus \Ker(F_0 \to P) =
P \oplus \Ker(F_0 \to P)
$$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-direct-sum-projective}
A direct sum of projective modules is projective.
\end{lemma}

\begin{proof}
This is true by the characterization of projectives as direct
summands of free modules in
Lemma \ref{lemma-characterize-projective}.
\end{proof}

\begin{lemma}
\label{lemma-lift-projective-module}
Let $R$ be a ring. Let $I \subset R$ be a nilpotent ideal. Let
$\overline{P}$ be a projective $R/I$-module. Then there exists a
projective $R$-module $P$ such that $P/IP \cong \overline{P}$.
\end{lemma}

\begin{proof}
We can choose a set $A$ and a direct sum decomposition
$\bigoplus_{\alpha \in A} R/I = \overline{P} \oplus \overline{K}$
for some $R/I$-module $\overline{K}$. Write $F = \bigoplus_{\alpha \in A} R$
for the free $R$-module on $A$. Choose a lift
$p : F \to F$ of the projector $\overline{p}$ associated to
the direct summand $\overline{P}$ of $\bigoplus_{\alpha \in A} R/I$.
Note that $p^2 - p \in \text{End}_R(F)$ is a nilpotent
endomorphism of $F$ (as $I$ is nilpotent and the matrix entries of
$p^2 - p$ are in $I$; more precisely, if $I^n = 0$, then $(p^2 - p)^n = 0$).
Hence by Lemma \ref{lemma-lift-idempotents-noncommutative}
we can modify our choice of $p$ and assume that $p$ is a projector.
Set $P = \Im(p)$.
\end{proof}

\begin{lemma}
\label{lemma-lift-projective}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $I$ is nilpotent,
\item $M/IM$ is a projective $R/I$-module,
\item $M$ is a flat $R$-module.
\end{enumerate}
Then $M$ is a projective $R$-module.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-lift-projective-module} we can find a projective
$R$-module $P$ and an isomorphism $P/IP \to M/IM$. We are going to show
that $M$ is isomorphic to $P$ which will finish the proof. Because $P$
is projective we can lift the map $P \to P/IP \to M/IM$ to an $R$-module
map $P \to M$ which is an isomorphism modulo $I$. By
Nakayama's Lemma \ref{lemma-NAK}
the map $P \to M$ is surjective. It remains to show that $P \to M$
is injective. Since $I^n = 0$ for some $n$, we can use the filtrations
\begin{align*}
0 = I^nM \subset I^{n - 1}M \subset \ldots \subset IM \subset M \\
0 = I^nP \subset I^{n - 1}P \subset \ldots \subset IP \subset P
\end{align*}
to see that it suffices to show that the induced maps
$I^aP/I^{a + 1}P \to I^aM/I^{a + 1}M$ are injective. Since both $P$
and $M$ are flat $R$-modules we can identify this with the map
$$
I^a/I^{a + 1} \otimes_{R/I} P/IP
\longrightarrow
I^a/I^{a + 1} \otimes_{R/I} M/IM
$$
induced by $P \to M$. Since we chose $P \to M$ such that the induced
map $P/IP \to M/IM$ is an isomorphism, we win.
\end{proof}









\section{Finite projective modules}
\label{section-finite-projective-modules}

\begin{definition}
\label{definition-locally-free}
Let $R$ be a ring and $M$ an $R$-module.
\begin{enumerate}
\item We say that $M$ is {\it locally free} if we can cover $\Spec(R)$ by
standard opens $D(f_i)$, $i \in I$ such that $M_{f_i}$ is a free
$R_{f_i}$-module for all $i \in I$.
\item We say that $M$ is {\it finite locally free} if we can choose
the covering such that each $M_{f_i}$ is finite free.
\item We say that $M$ is {\it finite locally free of rank $r$}
if we can choose the covering such that each $M_{f_i}$ is isomorphic
to $R_{f_i}^{\oplus r}$.
\end{enumerate}
\end{definition}

\noindent
Note that a finite locally free $R$-module is
automatically finitely presented by
Lemma \ref{lemma-cover}.

\begin{lemma}
\label{lemma-finite-projective}
Let $R$ be a ring and let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is finitely presented and $R$-flat,
\item $M$ is finite projective,
\item $M$ is a direct summand of a finite free $R$-module,
\item $M$ is finitely presented and
for all $\mathfrak p \in \Spec(R)$ the
localization $M_{\mathfrak p}$ is free,
\item $M$ is finitely presented and
for all maximal ideals $\mathfrak m \subset R$ the
localization $M_{\mathfrak m}$ is free,
\item $M$ is finite and locally free,
\item $M$ is finite locally free, and
\item $M$ is finite, for every prime $\mathfrak p$ the module
$M_{\mathfrak p}$ is free, and the function
$$
\rho_M : \Spec(R) \to \mathbf{Z}, \quad
\mathfrak p
\longmapsto
\dim_{\kappa(\mathfrak p)} M \otimes_R \kappa(\mathfrak p)
$$
is locally constant in the Zariski topology.
\end{enumerate}
\end{lemma}

\begin{proof}
First suppose $M$ is finite projective, i.e., (2) holds.
Take a surjection $R^n \to M$ and let $K$ be the kernel.
Since $M$ is projective,
$0 \to K \to R^n \to M \to 0$ splits.
Hence (2) $\Rightarrow$ (3).
The implication (3) $\Rightarrow$ (2) follows from the fact that
a direct summand of a projective is projective, see
Lemma \ref{lemma-characterize-projective}.

\medskip\noindent
Assume (3), so we can write $K \oplus M \cong R^{\oplus n}$.
So $K$ is a  direct summand of $R^n$ and thus finitely generated.
This shows $M = R^{\oplus n}/K$ is finitely presented.
In other words, (3) $\Rightarrow$ (1).

\medskip\noindent
Assume $M$ is finitely presented and flat, i.e., (1) holds.
We will prove that (7) holds. Pick any prime $\mathfrak p$ and
$x_1, \ldots, x_r \in M$ which map to a basis of
$M \otimes_R \kappa(\mathfrak p)$. By
Nakayama's Lemma \ref{lemma-NAK}
these elements generate $M_g$ for some $g \in R$, $g \not \in \mathfrak p$.
The corresponding surjection $\varphi : R_g^{\oplus r} \to M_g$
has the following two properties: (a) $\Ker(\varphi)$ is a finite
$R_g$-module (see Lemma \ref{lemma-extension})
and (b) $\Ker(\varphi) \otimes \kappa(\mathfrak p) = 0$
by flatness of $M_g$ over $R_g$ (see
Lemma \ref{lemma-flat-tor-zero}).
Hence by Nakayama's lemma again there exists a $g' \in R_g$ such that
$\Ker(\varphi)_{g'} = 0$. In other words, $M_{gg'}$ is free.

\medskip\noindent
A finite locally free module is a finite module, see
Lemma \ref{lemma-cover},
hence (7) $\Rightarrow$ (6).
It is clear that (6) $\Rightarrow$ (7) and that (7) $\Rightarrow$ (8).

\medskip\noindent
A finite locally free module is a finitely presented module, see
Lemma \ref{lemma-cover},
hence (7) $\Rightarrow$ (4).
Of course (4) implies (5).
Since we may check flatness locally (see
Lemma \ref{lemma-flat-localization})
we conclude that (5) implies (1).
At this point we have
$$
\xymatrix{
(2) \ar@{<=>}[r] & (3) \ar@{=>}[r] & (1) \ar@{=>}[r] &
(7)  \ar@{<=>}[r] \ar@{=>}[rd] \ar@{=>}[d] & (6) \\
& & (5) \ar@{=>}[u] & (4) \ar@{=>}[l] & (8)
}
$$

\medskip\noindent
Suppose that $M$ satisfies (1), (4), (5), (6), and (7).
We will prove that (3) holds. It suffices
to show that $M$ is projective. We have to show that $\Hom_R(M, -)$
is exact. Let $0 \to N'' \to N \to N'\to 0$ be a short exact sequence of
$R$-module. We have to show that
$0 \to \Hom_R(M, N'') \to \Hom_R(M, N) \to
\Hom_R(M, N') \to 0$ is exact.
As $M$ is finite locally free there exist a covering
$\Spec(R) = \bigcup D(f_i)$ such that $M_{f_i}$ is finite free.
By
Lemma \ref{lemma-hom-from-finitely-presented}
we see that
$$
0 \to \Hom_R(M, N'')_{f_i} \to \Hom_R(M, N)_{f_i} \to
\Hom_R(M, N')_{f_i} \to 0
$$
is equal to
$0 \to \Hom_{R_{f_i}}(M_{f_i}, N''_{f_i}) \to
\Hom_{R_{f_i}}(M_{f_i}, N_{f_i}) \to
\Hom_{R_{f_i}}(M_{f_i}, N'_{f_i}) \to 0$
which is exact as $M_{f_i}$ is free and as the localization
$0 \to N''_{f_i} \to N_{f_i} \to N'_{f_i} \to 0$
is exact (as localization is exact). Whence we see that
$0 \to \Hom_R(M, N'') \to \Hom_R(M, N) \to
\Hom_R(M, N') \to 0$ is exact by
Lemma \ref{lemma-cover}.

\medskip\noindent
Finally, assume that (8) holds. Pick a maximal ideal $\mathfrak m \subset R$.
Pick $x_1, \ldots, x_r \in M$ which map to a $\kappa(\mathfrak m)$-basis of
$M \otimes_R \kappa(\mathfrak m) = M/\mathfrak mM$. In particular
$\rho_M(\mathfrak m) = r$. By
Nakayama's Lemma \ref{lemma-NAK}
there exists an $f \in R$, $f \not \in \mathfrak m$ such that
$x_1, \ldots, x_r$ generate $M_f$ over $R_f$. By the assumption that
$\rho_M$ is locally constant there exists a $g \in R$, $g \not \in \mathfrak m$
such that $\rho_M$ is constant equal to $r$ on $D(g)$. We claim that
$$
\Psi : R_{fg}^{\oplus r} \longrightarrow M_{fg}, \quad
(a_1, \ldots, a_r) \longmapsto \sum a_i x_i
$$
is an isomorphism. This claim will show that $M$ is finite locally
free, i.e., that (7) holds. To see the claim
it suffices to show that the induced map on localizations
$\Psi_{\mathfrak p} : R_{\mathfrak p}^{\oplus r} \to M_{\mathfrak p}$
is an isomorphism for all $\mathfrak p \in D(fg)$, see
Lemma \ref{lemma-characterize-zero-local}.
By our choice of $f$ the map $\Psi_{\mathfrak p}$
is surjective. By assumption (8) we have
$M_{\mathfrak p} \cong R_{\mathfrak p}^{\oplus \rho_M(\mathfrak p)}$
and by our choice of $g$ we have $\rho_M(\mathfrak p) = r$.
Hence $\Psi_{\mathfrak p}$ determines a surjection
$R_{\mathfrak p}^{\oplus r} \to
M_{\mathfrak p} \cong R_{\mathfrak p}^{\oplus r}$
whence is an isomorphism by
Lemma \ref{lemma-fun}.
(Of course this last fact follows from a simple matrix argument also.)
\end{proof}

\begin{remark}
\label{remark-warning}
It is not true that a finite $R$-module which is
$R$-flat is automatically projective. A counter
example is where $R = \mathcal{C}^\infty(\mathbf{R})$
is the ring of infinitely differentiable functions on
$\mathbf{R}$, and $M = R_{\mathfrak m} = R/I$ where
$\mathfrak m = \{f \in R \mid f(0) = 0\}$ and
$I = \{f \in R \mid \exists \epsilon, \epsilon > 0 :
f(x) = 0\ \forall x, |x| < \epsilon\}$.
\end{remark}

\begin{lemma}
\label{lemma-finite-flat-local}
(Warning: see Remark \ref{remark-warning}.)
Suppose $R$ is a local ring, and $M$ is a finite
flat $R$-module. Then $M$ is finite free.
\end{lemma}

\begin{proof}
Follows from the equational criterion of flatness, see
Lemma \ref{lemma-flat-eq}. Namely, suppose that
$x_1, \ldots, x_r \in M$ map to a basis of
$M/\mathfrak mM$. By Nakayama's Lemma \ref{lemma-NAK}
these elements generate $M$. We want to show there
is no relation among the $x_i$. Instead, we will show
by induction on $n$ that if $x_1, \ldots, x_n \in M$
are linearly independent in the vector space
$M/\mathfrak mM$ then they are independent over $R$.

\medskip\noindent
The base case of the induction is where we have
$x \in M$, $x \not\in \mathfrak mM$ and a relation
$fx = 0$. By the equational criterion there
exist $y_j \in M$ and $a_j \in R$ such that
$x = \sum a_j y_j$ and $fa_j = 0$ for all $j$.
Since $x \not\in \mathfrak mM$ we see that
at least one $a_j$ is a unit and hence $f = 0 $.

\medskip\noindent
Suppose that $\sum f_i x_i$ is a relation among $x_1, \ldots, x_n$.
By our choice of $x_i$ we have $f_i \in \mathfrak m$.
According to the equational criterion of flatness there exist
$a_{ij} \in R$ and $y_j \in M$ such that
$x_i = \sum a_{ij} y_j$ and $\sum f_i a_{ij} = 0$.
Since $x_n \not \in \mathfrak mM$ we see that
$a_{nj}\not\in \mathfrak m$ for at least one $j$.
Since $\sum f_i a_{ij} = 0$ we get
$f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
The relation $\sum f_i x_i = 0$ now can be rewritten
as $\sum_{i = 1}^{n-1} f_i( x_i + (-a_{ij}/a_{nj}) x_n) = 0$.
Note that the elements $x_i + (-a_{ij}/a_{nj}) x_n$ map
to $n-1$ linearly independent elements of $M/\mathfrak mM$.
By induction assumption we get that all the $f_i$, $i \leq n-1$
have to be zero, and also $f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
This proves the induction step.
\end{proof}

\begin{lemma}
\label{lemma-finite-projective-descends}
Let $R \to S$ be a flat local homomorphism of local rings.
Let $M$ be a finite $R$-module. Then $M$ is finite projective
over $R$ if and only if $M \otimes_R S$ is finite projective
over $S$.
\end{lemma}

\begin{proof}
Suppose that $M \otimes_R S$ is finite projective
over $S$. By Lemma \ref{lemma-finite-projective}
it is finite free. Pick $x_1, \ldots, x_r \in M$ whose
residue classes generate $M/\mathfrak m_RM$. Clearly
we see that $x_1 \otimes 1, \ldots, x_r \otimes 1$
are a basis for $M \otimes_R S$. This implies that
the map $R^{\oplus r} \to M, (a_i) \mapsto \sum a_i x_i$
becomes an isomorphism after tensoring with $S$.
By faithful flatness of $R \to S$, see Lemma \ref{lemma-local-flat-ff}
we see that it is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-locally-free-semi-local-free}
Let $R$ be a semi-local ring.
Let $M$ be a finite locally free module.
If $M$ has constant rank, then $M$ is free. In particular, if $R$ has
connected spectrum, then $M$ is free.
\end{lemma}

\begin{proof}
Omitted. Hints: First show that $M/\mathfrak m_iM$ has the
same dimension $d$ for all maximal ideal $\mathfrak m_1, \ldots, \mathfrak m_n$
of $R$ using the spectrum is connected.
Next, show that there exist elements $x_1, \ldots, x_d \in M$
which form a basis for each $M/\mathfrak m_iM$ by the Chinese
remainder theorem. Finally show that $x_1, \ldots, x_d$ is a basis for $M$.
\end{proof}

\noindent
Here is a technical lemma that is used in the chapter on groupoids.

\begin{lemma}
\label{lemma-semi-local-module-basis-in-submodule}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
infinite residue field.
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module and let $N \subset M$ be an $R$-submodule.
Assume
\begin{enumerate}
\item $S$ is semi-local and $\mathfrak mS$ is contained in the radical
of $S$,
\item $M$ is a finite free $S$-module, and
\item $N$ generates $M$ as an $S$-module.
\end{enumerate}
Then $N$ contains an $S$-basis of $M$.
\end{lemma}

\begin{proof}
Assume $M$ is free of rank $n$. Let $I = \text{rad}(S)$.
By Nakayama's Lemma \ref{lemma-NAK} a sequence of elements
$m_1, \ldots, m_n$ is a basis for $M$ if and only if
$\overline{m}_i \in M/IM$ generate $M/IM$. Hence we may replace
$M$ by $M/IM$, $N$ by $N/(N \cap IM)$, $R$ by $R/\mathfrak m$,
and $S$ by $S/IS$. In this case we see that $S$ is a finite product
of fields $S = k_1 \times \ldots \times k_r$ and
$M = k_1^{\oplus n} \times \ldots \times k_r^{\oplus n}$.
The fact that $N \subset M$ generates $M$ as an $S$-module
means that there exist $x_j \in N$ such that a linear combination
$\sum a_j x_j$ with $a_j \in S$ has a nonzero component in each
factor $k_i^{\oplus n}$.
Because $R = k$ is an infinite field, this means that also
some linear combination $y = \sum c_j x_j$ with $c_j \in k$ has a
nonzero component in each factor. Hence $y \in N$ generates a
free direct summand $Sy \subset M$. By induction on $n$ the result
holds for $M/Sy$ and the submodule $\overline{N} = N/(N \cap Sy)$.
In other words there exist $\overline{y}_2, \ldots, \overline{y}_n$
in $\overline{N}$ which (freely) generate $M/Sy$. Then
$y, y_2, \ldots, y_n$ (freely) generate $M$ and we win.
\end{proof}




\section{Open loci defined by module maps}
\label{section-loci-maps}

\noindent
The set of primes where a given module map is surjective, or an isomorphism
is sometimes open. In the case of finite projective modules we can look
at the rank of the map.

\begin{lemma}
\label{lemma-map-between-finite}
Let $R$ be a ring. Let $\varphi : M \to N$ be a map of $R$-modules
with $N$ a finite $R$-module. Then we have the equality
\begin{align*}
U & = \{\mathfrak p \subset R \mid
\varphi_{\mathfrak p} : M_{\mathfrak p} \to N_{\mathfrak p}
\text{ is surjective}\} \\
& = \{\mathfrak p \subset R \mid
\varphi \otimes \kappa(\mathfrak p) :
M \otimes \kappa(\mathfrak p) \to N \otimes \kappa(\mathfrak p)
\text{ is surjective}\}
\end{align*}
and $U$ is an open subset of $\Spec(R)$. Moreover, for any $f \in R$
such that $D(f) \subset U$ the map $M_f \to N_f$ is surjective.
\end{lemma}

\begin{proof}
The equality in the displayed formula follows from Nakayama's lemma.
Nakayama's lemma also implies that $U$ is open. See
Lemma \ref{lemma-NAK} especially part (3). If $D(f) \subset U$, then
$M_f \to N_f$ is surjective on all localizations at primes of
$R_f$, and hence it is surjective by Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-map-between-finitely-presented}
Let $R$ be a ring. Let $\varphi : M \to N$ be a map of finitely presented
$R$-modules. Then
$$
U = \{\mathfrak p \subset R \mid
\varphi_{\mathfrak p} : M_{\mathfrak p} \to N_{\mathfrak p}
\text{ is an isomorphism}\}
$$
is an open subset of $\Spec(R)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \in U$. Pick a presentation
$N = R^{\oplus n}/\sum_{j = 1, \ldots, m} R k_j$.
Denote $e_i$ the image in $N$ of the $i$th basis vector of $R^{\oplus n}$.
For each $i \in \{1, \ldots, n\}$ choose an element
$m_i \in M_{\mathfrak p}$ such that $\varphi(m_i) = f_i e_i$
for some $f_i \in R$, $f_i \not \in \mathfrak p$. This is possible
as $\varphi_{\mathfrak p}$ is an isomorphism. Set $f = f_1 \ldots f_n$
and let $\psi : R_f^{\oplus n} \to M$ be the map which maps
the $i$th basis vector to $m_i/f_i$. Note that
$\varphi_f \circ \psi$ is the localization
at $f$ of the given map $R^{\oplus n} \to N$.
As $\varphi_{\mathfrak p}$ is an isomorphism we
see that $\psi(k_j)$ is an element of $M$ which maps to zero
in $M_{\mathfrak p}$. Hence we see that there exist
$g_j \in R$, $g_j \not \in \mathfrak p$ such that $g_j \psi(k_j) = 0$.
Setting $g = g_1 \ldots g_m$, we see that $\psi_g$ factors through
$N_{fg}$ to give a map $N_{fg} \to M_{fg}$. By construction
this map is inverse to $\varphi_{fg}$. Hence $\varphi_{fg}$ is an
isomorphism, which implies that $D(fg) \subset U$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-cokernel-flat}
Let $R$ be a ring. Let $\varphi : P_1 \to P_2$ be a map of
finite projective modules. Then
\begin{enumerate}
\item The set $U$ of primes $\mathfrak p \in \Spec(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is injective is open and
for any $f\in R$ such that $D(f) \subset U$ we have
\begin{enumerate}
\item $P_{1, f} \to P_{2, f}$ is injective, and
\item the module $\Coker(\varphi)_f$ is finite projective over $R_f$.
\end{enumerate}
\item The set $W$ of primes $\mathfrak p \in \Spec(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is surjective is open and
for any $f\in R$ such that $D(f) \subset W$ we have
\begin{enumerate}
\item $P_{1, f} \to P_{2, f}$ is surjective, and
\item the module $\Ker(\varphi)_f$ is finite projective over $R_f$.
\end{enumerate}
\item The set $V$ of primes $\mathfrak p \in \Spec(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is an isomorphism is open and
for any $f\in R$ such that $D(f) \subset V$ the map
$\varphi : P_{1, f} \to P_{2, f}$ is an isomorphism of modules over $R_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the set $U$ is open we may work locally on
$\Spec(R)$. Thus we may replace $R$ by a suitable localization
and assume that $P_1 = R^{n_1}$ and $P_2 = R^{n_2}$, see Lemma
\ref{lemma-finite-projective}. In this case injectivity of
$\varphi \otimes \kappa(\mathfrak p)$ is equivalent to $n_1 \leq n_2$
and some $n_1 \times n_1$ minor $f$ of the matrix of $\varphi$ being
invertible in $\kappa(\mathfrak p)$. Thus $D(f) \subset U$.
This argument also shows that $P_{1, \mathfrak p} \to P_{2, \mathfrak p}$
is injective for $\mathfrak p \in U$.

\medskip\noindent
Now suppose $D(f) \subset U$. By the remark in the previous paragraph
and Lemma \ref{lemma-characterize-zero-local} we see that
$P_{1, f} \to P_{2, f}$ is injective, i.e., (1)(a) holds.
By Lemma \ref{lemma-finite-projective} to prove (1)(b)
it suffices to prove that $\Coker(\varphi)$ is finite projective
locally on $D(f)$. Thus, as we saw above, we may
assume that $P_1 = R^{n_1}$ and $P_2 = R^{n_2}$
and that some minor of the matrix of $\varphi$ is invertible in $R$.
If the minor in question corresponds to the first $n_1$
basis vectors of $R^{n_2}$, then using the last $n_2 - n_1$ basis
vectors we get a map $R^{n_2 - n_1} \to R^{n_2} \to \Coker(\varphi)$
which is easily seen to be an isomorphism.

\medskip\noindent
Openness of $W$ and (2)(a) for $d(f) \subset W$ follow from
Lemma \ref{lemma-map-between-finite}. Since $P_{2, f}$ is projective
over $R_f$ we see that $\varphi_f : P_{1, f} \to P_{2, f}$ has a section
and it follows that $\Ker(\varphi)_f$ is a direct summand of $P_{2, f}$.
Therefore $\Ker(\varphi)_f$ is finite projective. Thus (2)(b) holds as well.

\medskip\noindent
It is clear that $V = U \cap W$ is open and the other statement in (3)
follows from (1)(a) and (2)(a).
\end{proof}






\section{Faithfully flat descent for projectivity of modules}
\label{section-ffdescent-projectivity-introduction}

\medskip\noindent
In the next few sections we prove, following
Raynaud and Gruson \cite{GruRay}, that the
projectivity of modules descends along faithfully flat ring maps.  The idea of
the proof is to use d\'evissage \`a la Kaplansky \cite{Kaplansky} to reduce
to the
case of countably generated modules.  Given a well-behaved filtration of a
module $M$, d\'evissage allows us to express $M$ as a direct sum of successive
quotients of the filtering submodules (see
Section \ref{section-transfinite-devissage}).
Using this technique, we prove that a projective module is a direct sum of
countably generated modules (Theorem \ref{theorem-projective-direct-sum}).  To
prove descent of projectivity for countably generated modules, we introduce a
``Mittag-Leffler'' condition on modules, prove that a countably generated
module is projective if and only if it is flat and Mittag-Leffler (Theorem
\ref{theorem-projectivity-characterization}), and then show that the property
of being a Mittag-Leffler module descends (Lemma
\ref{lemma-ffdescent-ML}).  Finally, given an arbitrary module $M$ whose
base change by a faithfully flat ring map is projective, we filter $M$ by
submodules whose successive quotients are countably generated projective
modules, and then by d\'evissage conclude $M$ is a direct sum of projectives,
hence projective itself (Theorem \ref{theorem-ffdescent-projectivity}).

\medskip\noindent
We note that there is an error in the  proof of faithfully flat descent
of projectivity in \cite{GruRay}.  There, descent
of projectivity along faithfully flat ring maps is deduced from descent of
projectivity along a more general type of ring map
(\cite[Example 3.1.4(1) of Part II]{GruRay}).
However, the proof of descent along this more general type of
map is incorrect. In \cite{G}, Gruson explains what went wrong,
although he does not provide a fix for the case of interest.
Patching this hole in the proof of faithfully flat descent of projectivity
comes down to proving that the property of being a Mittag-Leffler module
descends along faithfully flat ring maps. We do this in
Lemma \ref{lemma-ffdescent-ML}.





\section{Characterizing flatness}
\label{section-characterize-flatness}

\noindent
In this section we discuss criteria for flatness. The main result in
this section is Lazard's theorem (Theorem \ref{theorem-lazard}
below), which says that a flat module is the colimit of a directed system of
free finite modules.
We remind the reader of the ``equational criterion for flatness'', see
Lemma \ref{lemma-flat-eq}.
It turns out that this can be massaged into a seemingly much stronger property.

\begin{lemma}
\label{lemma-flat-factors-free}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is flat.
\item If $f: R^n \to M$ is a module map and $x \in \Ker(f)$, then there
are module maps $h: R^n \to R^m$ and $g: R^m \to M$ such that
$f = g \circ h$ and $x \in \Ker(h)$.
\item Suppose $f: R^n \to M$ is a module map, $N \subset \Ker(f)$ any
submodule, and $h: R^n \to R^{m}$ a map such that $N \subset \Ker(h)$
and $f$ factors through $h$.  Then given any $x \in \Ker(f)$ we can find a map
$h': R^n \to R^{m'}$ such that $N + Rx \subset \Ker(h')$ and $f$
factors through $h'$.
\item If $f: R^n \to M$ is a module map and $N \subset \Ker(f)$ is a
finitely generated submodule, then there are module maps $h: R^n \to
R^m$ and $g: R^m \to M$ such that $f = g \circ h$ and $N \subset
\Ker(h)$.
\end{enumerate}
\end{lemma}

\begin{proof}
That (1) is equivalent to (2) is just a reformulation of the equational
criterion for flatness\footnote{In fact, a module map $f : R^n \to M$
corresponds to a choice of elements $x_1, x_2, \ldots, x_n$ of $M$
(namely, the images of the standard basis elements $e_1, e_2, \ldots,
e_n$); furthermore, an element $x \in \Ker(f)$ corresponds to a
relation between these $x_1, x_2, \ldots, x_n$ (namely, the relation
$\sum_i f_i x_i = 0$, where the $f_i$ are the coordinates of $x$).
The module map $h$ (represented as an $m \times n$-matrix)
corresponds to the matrix $(a_{ij})$ from Lemma \ref{lemma-flat-eq},
and the $y_j$ of Lemma \ref{lemma-flat-eq} are the images of the
standard basis vectors of $R^m$ under $g$.}.   To show
(2) implies (3), let $g: R^m \to M$
be the map such that $f$ factors as $f = g \circ h$.  By (2) find $h'': R^m
\to R^{m'}$ such that $h''$ kills $h(x)$ and $g: R^m \to M$
factors through $h''$.  Then taking $h' = h'' \circ h$ works.  (3) implies (4)
by induction on the number of generators of $N \subset \Ker(f)$ in (4).
Clearly (4) implies (2).
\end{proof}

\begin{lemma}
\label{lemma-flat-factors-fp}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following
condition holds: if $P$ is a finitely presented $R$-module and $f: P
\to M$ a module map, then there is a free finite $R$-module $F$ and
module maps $h: P \to F$ and $g: F \to M$ such that $f = g
\circ h$.
\end{lemma}

\begin{proof}
This is just a reformulation of condition (4) from
Lemma \ref{lemma-flat-factors-free}.
\end{proof}

\begin{lemma}
\label{lemma-flat-surjective-hom}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following
condition holds: for every finitely presented $R$-module $P$, if $N \to
M$ is a surjective $R$-module map, then the induced map $\Hom_R(P, N)
\to \Hom_R(P, M)$ is surjective.
\end{lemma}

\begin{proof}
First suppose $M$ is flat.  We must show that if $P$ is finitely presented,
then given a map $f: P \to M$, it factors through the map $N
\to M$.  By
Lemma \ref{lemma-flat-factors-fp}
the map $f$ factors through a map $F \to M$ where $F$ is free and finite.
Since $F$ is free, this map factors through
$N \to M$.  Thus $f$ factors through $N \to M$.

\medskip\noindent
Conversely, suppose the condition of the lemma holds.  Let $f: P \to M$
be a map from a finitely presented module $P$.  Choose a free module $N$ with a
surjection $N \to M$ onto $M$.  Then $f$ factors through $N \to
M$, and since $P$ is finitely generated, $f$ factors through a free finite
submodule of $N$.  Thus $M$ satisfies the condition of Lemma
\ref{lemma-flat-factors-fp}, hence is flat.
\end{proof}

\begin{theorem}[Lazard's theorem]
\label{theorem-lazard}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if it is the colimit of
a directed system of free finite $R$-modules.
\end{theorem}

\begin{proof}
A colimit of a directed system of flat modules is flat, as taking directed
colimits is exact and commutes with tensor product. Hence if $M$ is the colimit
of a directed system of free finite modules then $M$ is flat.

\medskip\noindent
For the converse, first recall that any module $M$ can be written as the
colimit of a directed system of finitely presented modules, in the following
way.  Choose a surjection $f: R^I \to M$ for some set $I$, and let $K$
be the kernel.  Let $E$ be the set of ordered pairs $(J, N)$ where $J$ is a
finite subset of $I$ and $N$ is a finitely generated submodule of $R^J \cap K$.
Then $E$ is made into a directed partially ordered set by defining $(J, N) \leq
(J', N')$ if and only if $J \subset J'$ and $N \subset N'$.  Define $M_e =
R^J/N$ for $e = (J, N)$, and define $f_{ee'}: M_e \to M_{e'}$ to be
the natural map for $e \leq e'$.  Then $(M_e, f_{ee'})$ is a directed system and
the natural maps $f_e: M_e \to M$ induce an isomorphism
$\colim_{e
\in E} M_e \xrightarrow{\cong} M$.

\medskip\noindent
Now suppose $M$ is flat.  Let $I = M \times \mathbf{Z}$, write $(x_i)$ for
the canonical basis of $R^{I}$, and take in the above discussion $f: R^I
\to M$ to be the map sending $x_i$ to the projection of $i$ onto $M$.
To prove the theorem it suffices to show that the $e \in E$ such that $M_e$
is free form a cofinal subset of $E$.  So let $e = (J, N) \in E$ be arbitrary.
By Lemma \ref{lemma-flat-factors-fp} there is a free finite module $F$ and maps
$h: R^J/N \to F$ and $g: F \to M$ such that the natural map
$f_e: R^J/N \to M$ factors as $R^J/N \xrightarrow{h} F
\xrightarrow{g} M$.  We are going to realize $F$ as $M_{e'}$ for some $e' \geq
e$.

\medskip\noindent
Let $\{ b_1, \ldots, b_n \}$ be a finite basis of $F$.  Choose $n$ distinct
elements $i_1, \ldots, i_n \in I$ such that $i_{\ell} \notin J$ for all $\ell$,
and such that the image of $x_{i_{\ell}}$ under $f: R^I \to M$ equals
the image of $b_{\ell}$ under $g: F \to M$.  This is possible since
every element of $M$ can be written as $f(x_i)$ for infinitely many
distinct $i \in I$ (by our choice of $I$).  Now let
$J' = J \cup \{i_1, \ldots , i_n \}$, and define $R^{J'}
\to F$ by $x_i \mapsto h(x_i)$ for $i \in J$ and $x_{i_{\ell}} \mapsto
b_{\ell}$ for $\ell = 1, \ldots, n$.  Let $N' = \Ker(R^{J'} \to F)$.
Observe:
\begin{enumerate}
\item The square
$$
\xymatrix{
R^{J'} \ar[r] \ar@{^{(}->}[d] & F \ar[d]^{g} \\
R^{I} \ar[r]_{f} & M
}
$$
is commutative,
%$R^{J'} \to F$ factors $f: R^I \to M$,
hence $N' \subset K = \Ker(f)$;
\item $R^{J'} \to F$ is a surjection onto a free finite module, hence
it splits and so $N'$ is finitely generated;
\item $J \subset J'$ and $N \subset N'$.
\end{enumerate}
By (1) and (2) $e' = (J', N')$ is in $E$, by (3) $e' \geq e$, and by
construction $M_{e'} = R^{J'}/N' \cong F$ is free.
\end{proof}

\section{Universally injective module maps}
\label{section-universally-injective}

\noindent
Next we discuss universally injective module maps, which
are in a sense complementary to flat modules (see Lemma
\ref{lemma-flat-universally-injective}).  We follow Lazard's thesis
\cite{Autour};  also see \cite{Lam}.

\begin{definition}
\label{definition-universally-injective}
Let $f: M \to N$ be a map of $R$-modules.  Then $f$ is called
{\it universally injective} if for every $R$-module $Q$, the map $f
\otimes_R \text{id}_Q: M \otimes_R Q \to N \otimes_R Q$
is injective.  A sequence $0 \to M_1 \to M_2 \to M_3
\to 0$ of $R$-modules is called {\it universally exact} if it is exact
and $M_1 \to M_2$ is universally injective.
\end{definition}

\begin{example}
\label{example-universally-exact}
Examples of universally exact sequences.
\begin{enumerate}
\item A split short exact sequence is universally exact since tensoring
commutes with taking direct sums.
\item The colimit of a directed system of universally exact sequences is
universally exact.  This follows from the fact that taking directed colimits is
exact and that tensoring commutes with taking colimits.  In particular the
colimit of a directed system of split exact sequences is universally exact.  We
will see below that, conversely, any universally exact sequence arises in this
way.
\end{enumerate}
\end{example}

\noindent
Next we give a list of criteria for a short exact sequence to be universally
exact.  They are analogues of criteria for flatness given above.  Parts (3)-(6)
below correspond, respectively, to the criteria for flatness given in
Lemmas \ref{lemma-flat-eq}, \ref{lemma-flat-factors-free},
\ref{lemma-flat-surjective-hom}, and
Theorem \ref{theorem-lazard}.

\begin{theorem}
\label{theorem-universally-exact-criteria}
Let
$$
0 \to M_1 \xrightarrow{f_1} M_2 \xrightarrow{f_2} M_3 \to 0
$$
be an exact sequence of $R$-modules.  The following are equivalent:
\begin{enumerate}
\item The sequence $0 \to M_1 \to M_2 \to M_3
\to 0$ is universally exact.
\item For every finitely presented $R$-module $Q$, the sequence
$$
0 \to M_1 \otimes_R Q \to M_2 \otimes_R Q \to
M_3 \otimes_R Q \to 0
$$
is exact.
\item Given elements $x_i \in M_1$ $(i = 1, \ldots, n)$, $y_j \in M_2$ $(j = 1,
\ldots, m)$, and $a_{ij} \in R$ $(i = 1, \ldots, n, j = 1, \ldots, m)$ such that
for all $i$
$$
f_1(x_i) = \sum\nolimits_j a_{ij} y_j,
$$
there exists $z_j \in M_1$ $(j =1, \ldots, m)$ such that for all $i$,
$$
x_i = \sum\nolimits_j a_{ij} z_j .
$$
\item Given a commutative diagram of $R$-module maps
$$
\xymatrix{
R^n \ar[r] \ar[d] &  R^m \ar[d] \\
M_1 \ar[r]^{f_1}        &  M_2
}
$$
where $m$ and $n$ are integers, there exists a map $R^m \to M_1$ making
the top triangle commute.
\item For every finitely presented $R$-module $P$, the $R$-module
map $\Hom_R(P, M_2) \to \Hom_R(P, M_3)$ is surjective.
\item The sequence $0 \to M_1 \to M_2 \to M_3
\to 0$ is the colimit of a directed system of split exact sequences of
the form
$$
0 \to M_{1} \to M_{2, i} \to M_{3, i} \to 0
$$
where the $M_{3, i}$ are finitely presented.
\end{enumerate}
\end{theorem}

\begin{proof}
Obviously (1) implies (2).

\medskip\noindent
Next we show (2) implies (3).  Let $f_1(x_i) = \sum_j a_{ij} y_j$ be relations
as in (3).  Let $(d_j)$ be a basis for $R^m$, $(e_i)$ a basis for $R^n$, and
$R^m \to R^n$ the map given by $d_j \mapsto \sum_i a_{ij} e_i$.
Let $Q$ be the cokernel of $R^m \to R^n$.  Then tensoring
$R^m \to R^n \to Q \to 0$ by the map $f_1: M_1 \to M_2$, we get a
commutative diagram
$$
\xymatrix{
M_1^{\oplus m} \ar[r] \ar[d] & M_1^{\oplus n} \ar[r] \ar[d] & M_1 \otimes_R Q
\ar[r] \ar[d] & 0 \\
M_2^{\oplus m} \ar[r] & M_2^{\oplus n} \ar[r] & M_2 \otimes_R Q \ar[r] & 0
}
$$
where $M_1^{\oplus m} \to M_1^{\oplus n}$ is given by
$$
(z_1, \ldots, z_m) \mapsto
(\sum\nolimits_j a_{1j} z_j, \ldots, \sum\nolimits_j a_{nj} z_j),
$$
and $M_2^{\oplus m} \to M_2^{\oplus n}$ is given similarly.  We want to
show $x = (x_1, \ldots, x_n) \in M_1^{\oplus n}$ is in the image of $M_1^{\oplus
m} \to M_1^{\oplus n}$.  By (2) the map $M_1 \otimes Q \to M_2
\otimes Q$ is injective, hence by exactness of the top row it is enough to show
$x$ maps to $0$ in $M_2 \otimes Q$, and so by exactness of the bottom row it is
enough to show the image of $x$ in $M_2^{\oplus n}$ is in the image of
$M_2^{\oplus m} \to M_2^{\oplus n}$.  This is true by assumption.

\medskip\noindent
Condition (4) is just a translation of (3) into diagram form.

\medskip\noindent
Next we show (4) implies (5). Let $\varphi : P \to M_3$ be a map from a
finitely presented $R$-module $P$.  We must show that $\varphi$ lifts to a map
$P \to M_2$.  Choose a presentation of $P$,
$$
R^n \xrightarrow{g_1} R^m \xrightarrow{g_2} P \to 0.
$$
Using freeness of $R^n$ and $R^m$, we can construct $h_2: R^m \to M_2$
and then $h_1: R^n \to M_1$ such that the following diagram commutes
$$
\xymatrix{
         & R^n \ar[r]^{g_1} \ar[d]^{h_1} & R^m \ar[r]^{g_2} \ar[d]^{h_2} & P
\ar[r] \ar[d]^{\varphi} & 0 \\
0 \ar[r] & M_1 \ar[r]^{f_1} & M_2 \ar[r]^{f_2} & M_3 \ar[r] & 0 .
}
$$
By (4) there is a map $k_1: R^m \to M_1$ such that $k_1 \circ g_1 =
h_1$.  Now define $h'_2: R^m \to M_2$ by $h_2' = h_2 - f_1 \circ k_1$.
Then
$$
h'_2 \circ g_1 = h_2 \circ g_1 - f_1 \circ k_1 \circ g_1 =
h_2 \circ g_1 - f_1 \circ h_1 = 0 .
$$
Hence by passing to the quotient $h'_2$ defines a map $\varphi': P \to
M_2$ such that $\varphi' \circ g_2 = h_2'$.  In a diagram, we have
$$
\xymatrix{
R^m \ar[r]^{g_2} \ar[d]_{h'_2} & P \ar[d]^{\varphi} \ar[dl]_{\varphi'} \\
M_2 \ar[r]^{f_2} & M_3.
}
$$
where the top triangle commutes.  We claim that $\varphi'$ is the desired lift,
i.e.\ that $f_2 \circ \varphi' = \varphi$.  From the definitions we have
$$
f_2 \circ \varphi' \circ g_2 = f_2 \circ h'_2 =
f_2 \circ h_2 - f_2 \circ f_1 \circ k_1 = f_2 \circ h_2 =
\varphi \circ g_2.
$$
Since $g_2$ is surjective, this finishes the proof.

\medskip\noindent
Now we show (5) implies (6). Write $M_{3}$ as the colimit of a directed system
of finitely presented modules $M_{3, i}$, see
Lemma \ref{lemma-module-colimit-fp}. Let $M_{2, i}$ be the fiber product
of $M_{3, i}$ and $M_{2}$ over $M_{3}$---by definition this is the submodule of
$M_2 \times M_{3, i}$ consisting of elements whose two projections onto $M_3$
are equal. Let $M_{1, i}$ be the kernel of the projection
$M_{2, i} \to M_{3, i}$. Then we have a directed system of exact sequences
$$
0 \to M_{1, i} \to M_{2, i} \to M_{3, i} \to 0,
$$
and for each $i$ a map of exact sequences
$$
\xymatrix{
0  \ar[r] & M_{1, i} \ar[d] \ar[r]  &  M_{2, i}  \ar[r] \ar[d] & M_{3, i} \ar[d]
\ar[r] & 0 \\
0  \ar[r] & M_{1} \ar[r]  &  M_{2}  \ar[r] & M_{3} \ar[r] & 0
}
$$
compatible with the directed system.  From the definition of the fiber product
$M_{2, i}$, it follows that the map $M_{1, i} \to M_1$ is an isomorphism.
 By (5) there is a map $M_{3, i} \to M_{2}$ lifting $M_{3, i} \to
M_3$, and by the universal property of the fiber product this gives rise to a
section of $M_{2, i} \to M_{3, i}$.  Hence the sequences
$$
0 \to M_{1, i} \to M_{2, i} \to M_{3, i} \to 0
$$
split.  Passing to the colimit, we have a commutative diagram
$$
\xymatrix{
0  \ar[r] & \colim M_{1, i} \ar[d]^{\cong} \ar[r]  &  \colim M_{2, i}
 \ar[r]
\ar[d] & \colim M_{3, i} \ar[d]^{\cong} \ar[r] & 0 \\
0  \ar[r] & M_{1} \ar[r]  &  M_{2}  \ar[r] & M_{3} \ar[r] & 0
}
$$
with exact rows and outer vertical maps isomorphisms.  Hence $\colim
M_{2, i}
\to M_2$ is also an isomorphism and (6) holds.

\medskip\noindent
Condition (6) implies (1) by
Example \ref{example-universally-exact} (2).
\end{proof}

\noindent
The previous theorem shows that a universally exact sequence is always a
colimit of split short exact sequences.  If the cokernel of a universally
injective map is finitely presented, then in fact the map itself splits:

\begin{lemma}
\label{lemma-universally-exact-split}
Let
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
be an exact sequence of $R$-modules.  Suppose $M_3$ is of finite presentation.
Then
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
is universally exact if and only if it is split.
\end{lemma}

\begin{proof}
A split short exact sequence is always universally exact, see
Example \ref{example-universally-exact}.
Conversely, if the sequence is universally exact, then by
Theorem \ref{theorem-universally-exact-criteria} (5)
applied to $P = M_3$, the map $M_2 \to M_3$ admits a section.
\end{proof}

\noindent
The following lemma shows how universally injective maps are complementary to
flat modules.

\begin{lemma}
\label{lemma-flat-universally-injective}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if any exact sequence
of $R$-modules
$$
0 \to M_1 \to M_2 \to M \to 0
$$
is universally exact.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-flat-surjective-hom} and
Theorem \ref{theorem-universally-exact-criteria} (5).
\end{proof}

\begin{example}
\label{example-universally-exact-non-split-non-flat}
Non-split and non-flat universally exact sequences.
\begin{enumerate}
\item In spite of
Lemma \ref{lemma-universally-exact-split},
it is possible to  have a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact but non-split.  For instance, take $R = \mathbf{Z}$,
let $M_1 = \bigoplus_{n=1}^{\infty} \mathbf{Z}$, let $M_{2} = \prod_{n =
1}^{\infty} \mathbf{Z}$, and let $M_{3}$ be the cokernel of the inclusion $M_1
\to M_2$.  Then $M_1, M_2, M_3$ are all flat since they are torsion-free
(More on Algebra, Lemma \ref{more-algebra-lemma-dedekind-torsion-free-flat}),
so by Lemma \ref{lemma-flat-universally-injective},
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
is universally exact.  However there can be no section $s: M_3 \to
M_2$.  In fact, if $x$ is the image of $(2, 2^2, 2^3, \ldots) \in M_2$ in $M_3$,
then any module map $s: M_3 \to M_2$ must kill $x$.  This is because $x
\in 2^n M_3$ for any $n \geq 1$, hence $s(x)$ is divisible by $2^n$ for all $n
\geq 1$ and so must be $0$.
\item In spite of Lemma \ref{lemma-flat-universally-injective}, it is possible
to have a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact but with $M_1, M_2, M_3$ all non-flat.  In fact if $M$
is any non-flat module, just take the split exact sequence
$$
0 \to M \to M \oplus M \to M \to 0.
$$
For instance over $R = \mathbf{Z}$, take $M$ to be any torsion module.
\item Taking the direct sum of an exact sequence as in (1) with one as in (2),
we get a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact, non-split, and such that
$M_1, M_2, M_3$ are all non-flat.
\end{enumerate}
\end{example}

\begin{lemma}
\label{lemma-ui-flat-domain}
Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a universally exact sequence
of $R$-modules, and suppose $M_2$ is flat.
Then $M_1$ and $M_3$ are flat.
\end{lemma}

\begin{proof}
Let $0 \to N \to N' \to N'' \to 0$ be a short exact sequence of
$R$-modules. Consider the commutative diagram
$$
\xymatrix{
M_1 \otimes_R N \ar[r] \ar[d] &
M_2 \otimes_R N \ar[r] \ar[d] &
M_3 \otimes_R N \ar[d] \\
M_1 \otimes_R N' \ar[r] \ar[d] &
M_2 \otimes_R N' \ar[r] \ar[d] &
M_3 \otimes_R N' \ar[d] \\
M_1 \otimes_R N'' \ar[r] &
M_2 \otimes_R N'' \ar[r] &
M_3 \otimes_R N''
}
$$
(we have dropped the $0$'s on the boundary).
By assumption the rows give short exact sequences and the arrow
$M_2 \otimes N \to M_2 \otimes N'$ is injective. Clearly this implies
that $M_1 \otimes N \to M_1 \otimes N'$ is injective and we see that $M_1$
is flat. In particular the left and middle columns give rise to short
exact sequences. It follows from a diagram chase that the arrow
$M_3 \otimes N \to M_3 \otimes N'$ is injective. Hence $M_3$ is flat.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-tensor}
Let $R$ be a ring.
Let $M \to M'$ be a universally injective $R$-module map.
Then for any $R$-module $N$ the map $M \otimes_R N \to M' \otimes_R N$
is universally injective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-universally-injective}
Let $R$ be a ring. A composition of universally injective
$R$-module maps is universally injective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-permanence}
Let $R$ be a ring. Let $M \to M'$ and $M' \to M''$ be $R$-module maps.
If their composition $M \to M''$ is universally injective, then
$M \to M'$ is universally injective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-faithfully-flat-universally-injective}
Let $R \to S$ be a faithfully flat ring map.
Then $R \to S$ is universally injective as a map of $R$-modules.
In particular $R \cap IS = I$ for any ideal $I \subset R$.
\end{lemma}

\begin{proof}
Let $N$ be an $R$-module. We have to show that $N \to N \otimes_R S$ is
injective. As $S$ is faithfully flat as an $R$-module, it suffices to prove
this after tensoring with $S$. Hence it suffices to show that
$N \otimes_R S \to N \otimes_R S \otimes_R S$,
$n \otimes s \mapsto n \otimes 1 \otimes s$ is injective. This is true
because there is a section, namely,
$n \otimes s \otimes s' \mapsto n \otimes ss'$.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-check-stalks}
Let $R \to S$ be a ring map.
Let $M \to M'$ be a map of $S$-modules.
The following are equivalent
\begin{enumerate}
\item $M \to M'$ is universally injective as a map of $R$-modules,
\item for each prime $\mathfrak q$ of $S$ the map
$M_{\mathfrak q} \to M'_{\mathfrak q}$ is universally injective
as a map of $R$-modules,
\item for each maximal ideal $\mathfrak m$ of $S$ the map
$M_{\mathfrak m} \to M'_{\mathfrak m}$ is universally injective
as a map of $R$-modules,
\item for each prime $\mathfrak q$ of $S$ the map
$M_{\mathfrak q} \to M'_{\mathfrak q}$ is universally injective
as a map of $R_{\mathfrak p}$-modules, where $\mathfrak p$ is the
inverse image of $\mathfrak q$ in $R$, and
\item for each maximal ideal $\mathfrak m$ of $S$ the map
$M_{\mathfrak m} \to M'_{\mathfrak m}$ is universally injective
as a map of $R_{\mathfrak p}$-modules, where $\mathfrak p$ is the
inverse image of $\mathfrak m$ in $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $N$ be an $R$-module. Let $\mathfrak q$ be a prime of $S$ lying over
the prime $\mathfrak p$ of $R$. Then we have
$$
(M \otimes_R N)_{\mathfrak q} =
M_{\mathfrak q} \otimes_R N =
M_{\mathfrak q} \otimes_{R_{\mathfrak p}} N_{\mathfrak p}.
$$
Moreover, the same thing holds for $M'$ and localization is exact.
Also, if $N$ is an $R_{\mathfrak p}$-module, then $N_{\mathfrak p} = N$.
Using this the equivalences can be proved in a straightforward manner.

\medskip\noindent
For example, suppose that (5) holds. Let
$K = \Ker(M \otimes_R N \to M' \otimes_R N)$. By the remarks
above we see that $K_{\mathfrak m} = 0$ for each maximal ideal $\mathfrak m$
of $S$. Hence $K = 0$ by
Lemma \ref{lemma-characterize-zero-local}.
Thus (1) holds. Conversely, suppose that (1) holds. Take any
$\mathfrak q \subset S$ lying over $\mathfrak p \subset R$.
Take any module $N$ over $R_{\mathfrak p}$. Then
by assumption $\Ker(M \otimes_R N \to M' \otimes_R N) = 0$.
Hence by the formulae above and the fact that $N = N_{\mathfrak p}$
we see that
$\Ker(M_{\mathfrak q} \otimes_{R_{\mathfrak p}} N \to
M'_{\mathfrak q} \otimes_{R_{\mathfrak p}} N) = 0$. In other words
(4) holds. Of course (4) $\Rightarrow$ (5) is immediate. Hence
(1), (4) and (5) are all equivalent.
We omit the proof of the other equivalences.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-localize}
Let $\varphi : A \to B$ be a ring map. Let $S \subset A$ and
$S' \subset B$ be multiplicative subsets such that $\varphi(S) \subset S'$.
Let $M \to M'$ be a map of $B$-modules.
\begin{enumerate}
\item If $M \to M'$ is universally injective as a map of $A$-modules,
then $(S')^{-1}M \to (S')^{-1}M'$ is universally injective as a map of
$A$-modules and as a map of $S^{-1}A$-modules.
\item If $M$ and $M'$ are $(S')^{-1}B$-modules, then $M \to M'$
is universally injective as a map of $A$-modules if and only if
it is universally injective as a map of $S^{-1}A$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
You can prove this using
Lemma \ref{lemma-universally-injective-check-stalks}
but you can also prove it directly as follows.
Assume $M \to M'$ is $A$-universally injective.
Let $Q$ be an $A$-module. Then $Q \otimes_A M \to Q \otimes_A M'$
is injective. Since localization is exact we see that
$(S')^{-1}(Q \otimes_A M) \to (S')^{-1}(Q \otimes_A M')$ is injective.
As $(S')^{-1}(Q \otimes_A M) = Q \otimes_A (S')^{-1}M$ and similarly for $M'$
we see that
$Q \otimes_A (S')^{-1}M \to Q \otimes_A (S')^{-1}M'$ is injective, hence
$(S')^{-1}M \to (S')^{-1}M'$ is universally injective as a map of
$A$-modules. This proves the first part of (1).
To see (2) we can use the following two facts: (a) if $Q$ is an
$S^{-1}A$-module, then $Q \otimes_A S^{-1}A = Q$, i.e., tensoring
with $Q$ over $A$ is the same thing as tensoring with $Q$ over $S^{-1}A$,
(b) if $M$ is any $A$-module on which the elements of $S$ are invertible,
then $M \otimes_A Q = M \otimes_{S^{-1}A} S^{-1}Q$.
Part (2) follows from this immediately.
\end{proof}

\begin{lemma}
\label{lemma-check-universally-injective-into-flat}
Let $R$ be a ring and let $M \to M'$ be a map of $R$-modules.
If $M'$ is flat, then $M \to M'$ is universally injective if
and only if $M/IM \to M'/IM'$ is injective for every finitely
generated ideal $I$ of $R$.
\end{lemma}

\begin{proof}
It suffices to show that $M \otimes_R Q \to M' \otimes_R Q$ is
injective for every finite $R$-module $Q$, see
Theorem \ref{theorem-universally-exact-criteria}.
Then $Q$ has a finite filtration
$0 = Q_0 \subset Q_1 \subset \ldots \subset Q_n = Q$
by submodules whose subquotients
are isomorphic to cyclic modules $R/I_i$, see
Lemma \ref{lemma-trivial-filter-finite-module}.
Since $M'$ is flat, we obtain a filtration
$$
\xymatrix{
M \otimes Q_1 \ar[r] \ar[d] &
M \otimes Q_2 \ar[r] \ar[d] &
\ldots \ar[r] &
M \otimes Q \ar[d] \\
M' \otimes Q_1 \ar@{^{(}->}[r] &
M' \otimes Q_2 \ar@{^{(}->}[r] &
\ldots \ar@{^{(}->}[r] &
M' \otimes Q
}
$$
of $M' \otimes_R Q$ by submodules $M' \otimes_R Q_i$ whose successive
quotients are $M' \otimes_R R/I_i = M'/I_iM'$. A simple induction argument
shows that it suffices to check $M/I_i M \to M'/I_i M'$ is injective.
Note that the collection of finitely generated ideals $I'_i \subset I_i$
is a directed set. Thus $M/I_iM = \colim M/I'_iM$ is a filtered
colimit, similarly for $M'$, the maps $M/I'_iM \to M'/I'_i M'$ are
injective by assumption, and since filtered colimits are exact
(Lemma \ref{lemma-directed-colimit-exact}) we conclude.
\end{proof}



\section{Descent for finite projective modules}
\label{section-finite-projective}

\noindent
In this section we give an elementary proof of the fact that the property of
being a {\it finite} projective module descends along faithfully flat ring
maps.  The proof does not apply when we drop the finiteness condition.
However, the method is indicative of the one we shall use to prove descent
for the property of being a {\it countably generated} projective module---see
the comments at the end of this section.

\begin{lemma}
\label{lemma-finite-projective-again}
Let $M$ be an $R$-module.  Then $M$ is finite projective if and only if $M$ is
finitely presented and flat.
\end{lemma}

\begin{proof}
This is part of
Lemma \ref{lemma-finite-projective}.
However, at this point we can give a more elegant proof of the implication
(1) $\Rightarrow$ (2) of that lemma as follows.
If $M$ is finitely presented and flat, then take a surjection
$R^n \to M$.  By
Lemma \ref{lemma-flat-surjective-hom}
applied to $P = M$, the map $R^n \to M$ admits a section.
So $M$ is a direct summand of a  free module and hence projective.
\end{proof}

\noindent
Here are some properties of modules that descend.

\begin{lemma}
\label{lemma-descend-properties-modules}
Let $R \to S$ be a faithfully flat ring map.
Let $M$ be an $R$-module. Then
\begin{enumerate}
\item if the $S$-module $M \otimes_R S$ is of finite type, then
$M$ is of finite type,
\item if the $S$-module $M \otimes_R S$ is of finite presentation, then
$M$ is of finite presentation,
\item if the $S$-module $M \otimes_R S$ is flat, then
$M$ is flat, and
\item add more here as needed.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M \otimes_R S$ is of finite type. Let $y_1, \ldots, y_m$ be generators
of $M \otimes_R S$ over $S$. Write $y_j = \sum x_i \otimes f_i$ for some
$x_1, \ldots, x_n \in M$. Then we see that the map
$\varphi : R^{\oplus n} \to M$
has the property that
$\varphi \otimes \text{id}_S : S^{\oplus n} \to M \otimes_R S$
is surjective. Since $R \to S$ is faithfully flat we see that
$\varphi$ is surjective, and $M$ is finitely generated.

\medskip\noindent
Assume $M \otimes_R S$ is of finite presentation. By (1) we see that
$M$ is of finite type. Choose a surjection $R^{\oplus n} \to M$ and
denote $K$ the kernel. As $R \to S$ is flat we see that $K \otimes_R S$
is the kernel of the base change $S^{\oplus n} \to M \otimes_R S$.
As $M \otimes_R S$ is of finite presentation we conclude that $K \otimes_R S$
is of finite type. Hence by (1) we see that $K$ is of finite type
and hence $M$ is of finite presentation.

\medskip\noindent
Part (3) is
Lemma \ref{lemma-flatness-descends}.
\end{proof}

\begin{proposition}
\label{proposition-ffdescent-finite-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module.
If the $S$-module $M \otimes_R S$ is finite projective, then $M$ is finite
projective.
\end{proposition}

\begin{proof}
Follows from
Lemmas \ref{lemma-finite-projective-again} and
\ref{lemma-descend-properties-modules}.
\end{proof}

\noindent
The next few sections are about removing the finiteness assumption by using
d\'evissage to reduce to the countably generated case.  In the countably
generated case, the strategy is to find a characterization of countably
generated projective modules analogous to
Lemma \ref{lemma-finite-projective-again},
and then to prove directly that this characterization descends. We do this by
introducing the notion of a Mittag-Leffler module and proving that if a module
$M$ is countably generated, then it is projective if and only if it is flat and
Mittag-Leffler (Theorem \ref{theorem-projectivity-characterization}).  When $M$
is finitely generated, this statement reduces to Lemma
\ref{lemma-finite-projective-again} (since, according to
Example \ref{example-ML} (1),
a finitely generated module is Mittag-Leffler if and only if it is
finitely presented).

\section{Transfinite d\'evissage of modules}
\label{section-transfinite-devissage}

\noindent
In this section we introduce a d\'evissage technique for decomposing a module
into a direct sum. The main result is that a projective module is a direct sum
of countably generated modules (Theorem \ref{theorem-projective-direct-sum}
below). We follow \cite{Kaplansky}.


\begin{definition}
\label{definition-devissage}
Let $M$ be an $R$-module.  A {\it direct sum d\'evissage} of $M$ is a family
of submodules $(M_{\alpha})_{\alpha \in S}$, indexed by an ordinal $S$ and
increasing (with respect to inclusion), such that:
\begin{enumerate}
\item[(0)] $M_0 = 0$;
\item[(1)] $M = \bigcup_{\alpha} M_{\alpha}$;
\item[(2)] if $\alpha \in S$ is a limit ordinal, then $M_{\alpha} =
\bigcup_{\beta < \alpha} M_{\beta}$;
\item[(3)] if $\alpha + 1 \in S$, then $M_{\alpha}$ is a direct summand of
$M_{\alpha + 1}$.
\end{enumerate}
If moreover
\begin{enumerate}
\item[(4)] $M_{\alpha + 1}/M_{\alpha}$ is countably generated for
$\alpha + 1 \in S$,
\end{enumerate}
then $(M_{\alpha})_{\alpha \in S}$ is called a {\it Kaplansky d\'evissage}
of $M$.
\end{definition}

\noindent
The terminology is justified by the following lemma.

\begin{lemma}
\label{lemma-direct-sum-devissage}
Let $M$ be an $R$-module.  If $(M_{\alpha})_{\alpha \in S}$ is a direct sum
d\'evissage of $M$, then
$M \cong \bigoplus_{\alpha + 1 \in S} M_{\alpha + 1}/M_{\alpha}$.
\end{lemma}

\begin{proof}
By property (3) of a direct sum d\'evissage, there is an inclusion
$M_{\alpha + 1}/M_{\alpha} \to M$ for each $\alpha \in S$.  Consider the
map
$$
f: \bigoplus_{\alpha + 1\in S} M_{\alpha + 1}/M_{\alpha} \to M
$$
given by the sum of these inclusions.  Transfinite induction on $S$ shows that
the image contains $M_{\alpha}$ for every $\alpha \in S$: for $\alpha = 0$ this
is true by (0); if $\alpha + 1$ is a successor ordinal then it is clearly true;
and if $\alpha$ is a limit ordinal and it is true for $\beta < \alpha$, then it
is true for $\alpha$ by (2). Hence $f$ is surjective by (1).

\medskip\noindent
Transfinite induction on $S$ also shows that for every $\beta \in S$ the
restriction
$$
f_{\beta} :
\bigoplus\nolimits_{\alpha + 1 \leq \beta} M_{\alpha + 1}/M_{\alpha}
\longrightarrow
M
$$
of $f$ is injective: For $\beta = 0$ it is true.  If it is true for all
$\beta' < \beta$, then let $x$ be in the kernel and write
$x = (x_{\alpha + 1})_{\alpha + 1 \leq \beta}$ in terms of its components
$x_{\alpha + 1} \in M_{\alpha + 1}/M_{\alpha}$.  By property (3) both
$(x_{\alpha + 1})_{\alpha + 1 < \beta}$ and $x_{\beta + 1}$ map to $0$.
Hence $x_{\beta + 1} = 0$ and, by the assumption that the restriction
$f_{\beta'}$ is injective for all $\beta' < \beta$, also $x_{\alpha + 1} = 0$
for every $\alpha + 1 < \beta$.  So $x = 0$ and $f_{\beta}$ is injective,
which finishes the induction.  We conclude that $f$
is injective since $f_{\beta}$ is for each $\beta \in S$.
\end{proof}

\begin{lemma}
\label{lemma-Kaplansky-devissage}
Let $M$ be an $R$-module.  Then $M$ is a direct sum of countably generated
$R$-modules if and only if it admits a Kaplansky d\'evissage.
\end{lemma}

\begin{proof}
The lemma takes care of the ``if'' direction.  Conversely, suppose $M =
\bigoplus_{i \in I} N_i$ where each $N_i$ is a countably generated $R$-module.
Well-order $I$ so that we can think of it as an ordinal.  Then setting $M_i =
\bigoplus_{j < i} N_j$ gives a Kaplansky d\'evissage $(M_i)_{i \in I}$ of
$M$.
\end{proof}

\begin{theorem}
\label{theorem-kaplansky-direct-sum}
Suppose $M$ is a direct sum of countably generated $R$-modules.  If $P$ is a
direct summand of $M$, then $P$ is also a direct sum of countably generated
$R$-modules.
\end{theorem}

\begin{proof}
Write $M = P \oplus Q$.  We are going to construct a Kaplansky d\'evissage
$(M_{\alpha})_{\alpha \in S}$ of $M$ which, in addition to the defining
properties (0)-(4), satisfies:
\begin{enumerate}
\item[(5)] Each $M_{\alpha}$ is a direct summand of $M$;
\item[(6)] $M_{\alpha} = P_{\alpha} \oplus Q_{\alpha}$, where $P_{\alpha} =P
\cap M_{\alpha}$ and $Q = Q \cap M_{\alpha}$.
\end{enumerate}
(Note: if properties (0)-(2) hold, then in fact property (3) is equivalent to
property (5).)

\medskip\noindent
To see how this implies the theorem, it is enough to show that
$(P_{\alpha})_{\alpha \in S}$ forms a Kaplansky d\'evissage of $P$.  Properties
(0), (1), and (2) are clear.  By (5) and (6) for $(M_{\alpha})$, each
$P_{\alpha}$ is a direct summand of $M$.  Since $P_{\alpha} \subset P_{\alpha +
1}$, this implies $P_{\alpha}$ is a direct summand of $P_{\alpha + 1}$; hence
(3) holds for $(P_{\alpha})$.  For (4), note that
$$
M_{\alpha + 1}/M_{\alpha} \cong P_{\alpha + 1}/P_{\alpha} \oplus
Q_{\alpha + 1}/Q_{\alpha},
$$
so $P_{\alpha + 1}/P_{\alpha}$ is countably generated because this is true of
$M_{\alpha + 1}/M_{\alpha}$.

\medskip\noindent
It remains to construct the $M_{\alpha}$.  Write $M = \bigoplus_{i \in I} N_i$
where each $N_i$ is a countably generated $R$-module.  Choose a well-ordering
of $I$.  By transfinite induction we are going to define an increasing family
of submodules $M_{\alpha}$ of $M$, one for each ordinal $\alpha$, such that
$M_{\alpha}$ is a direct sum of some subset of the $N_i$.

\medskip\noindent
For $\alpha = 0$ let $M_{0} = 0$.  If $\alpha$ is a limit ordinal and
$M_{\beta}$ has been defined for all $\beta < \alpha$, then define $M_{\alpha}
= \bigcup_{\beta < \alpha} M_{\beta}$.  Since each $M_{\beta}$ for $\beta <
\alpha$ is a direct sum of a subset of the $N_i$, the same will be true of
$M_{\alpha}$.  If $\alpha + 1$ is a successor ordinal and $M_{\alpha}$ has been
defined, then define $M_{\alpha + 1}$ as follows.  If $M_{\alpha} = M$, then let
$M_{\alpha + 1} = M$.  If not, choose the smallest $j \in I$ such that $N_j$ is
not contained in $M_{\alpha}$.  We will construct an infinite matrix $(x_{mn}),
m, n = 1, 2, 3, \ldots$ such that:
\begin{enumerate}
\item $N_j$ is contained in the submodule of $M$ generated by the entries
$x_{mn}$;
\item if we write any entry $x_{k\ell}$ in terms of its $P$- and
$Q$-components, $x_{k\ell} = y_{k\ell} + z_{k\ell}$, then the matrix $(x_{mn})$
contains a set of generators for each $N_i$ for which $y_{k\ell}$ or
$z_{k\ell}$ has nonzero component.
\end{enumerate}
Then we define $M_{\alpha + 1}$ to be the submodule of $M$ generated by
$M_{\alpha}$ and all $x_{mn}$; by property (2) of the matrix $(x_{mn})$,
$M_{\alpha + 1}$ will be a direct sum of some subset of the $N_i$.
To construct the matrix $(x_{mn})$, let $x_{11}, x_{12}, x_{13}, \ldots$
be a countable set of generators for $N_j$. Then if
$x_{11} = y_{11} + z_{11}$ is the decomposition into $P$- and
$Q$-components, let $x_{21}, x_{22}, x_{23}, \ldots$ be a countable
set of generators for the sum of the $N_i$ for which $y_{11}$ or $z_{11}$ have
nonzero component.  Repeat this process on $x_{12}$ to get elements $x_{31},
x_{32}, \ldots$, the third row of our matrix.  Repeat on $x_{21}$ to get the
fourth row, on $x_{13}$ to get the fifth, and so on, going down along
successive anti-diagonals as indicated below:
$$
\left(
\vcenter{
\xymatrix@R=2mm@C=2mm{
x_{11} & x_{12} \ar[dl] & x_{13} \ar[dl] & x_{14} \ar[dl] & \ldots  \\
x_{21} & x_{22} \ar[dl] & x_{23} \ar[dl] & \ldots  \\
x_{31} & x_{32} \ar[dl] & \ldots \\
x_{41} & \ldots \\
\ldots
}
}
\right).
$$

\medskip\noindent
Transfinite induction on $I$ (using the fact that we constructed
$M_{\alpha + 1}$
to contain $N_j$ for the smallest $j$ such that $N_j$ is not contained in
$M_{\alpha}$) shows that for each $i \in I$, $N_i$ is contained in some
$M_{\alpha}$.  Thus, there is some large enough ordinal $S$ satisfying: for
each $i \in I$ there is $\alpha \in S$ such that $N_i$ is contained in
$M_{\alpha}$.  This means $(M_{\alpha})_{\alpha \in S}$ satisfies property (1)
of a Kaplansky d\'evissage of $M$.  The family $(M_{\alpha})_{\alpha \in S}$
moreover satisfies the other defining properties, and also (5) and (6) above:
properties (0), (2), (4), and (6) are clear by construction;  property (5) is
true because each $M_{\alpha}$ is by construction a direct sum of some $N_i$;
and (3) is implied by (5) and the fact that $M_{\alpha} \subset M_{\alpha + 1}$.
\end{proof}

\noindent
As a corollary we get the result for projective modules stated at the beginning
of the section.

\begin{theorem}
\label{theorem-projective-direct-sum}
\begin{slogan}
Any projective module is a direct sum of countably generated
projective modules.
\end{slogan}
If $P$ is a projective $R$-module, then $P$ is a direct sum of countably
generated projective $R$-modules.
\end{theorem}

\begin{proof}
A module is projective if and only if it is a direct summand of a free module,
so this follows from Theorem \ref{theorem-kaplansky-direct-sum}.
\end{proof}



\section{Projective modules over a local ring}
\label{section-projective-local-ring}

\noindent
In this section we prove a very cute result:
a projective module $M$ over a local ring is free
(Theorem \ref{theorem-projective-free-over-local-ring} below).
Note that with  the additional assumption that $M$ is finite, this result is
Lemma \ref{lemma-finite-flat-local}.
In general we have:

\begin{lemma}
\label{lemma-projective-free}
Let $R$ be a ring.  Then every projective $R$-module is free if and only if
every countably generated projective $R$-module is free.
\end{lemma}

\begin{proof}
Follows immediately from
Theorem \ref{theorem-projective-direct-sum}.
\end{proof}

\noindent
Here is a criterion for a countably generated module to be free.

\begin{lemma}
\label{lemma-freeness-criteria}
Let $M$ be a countably generated $R$-module.  Suppose any direct summand $N$ of
$M$ satisfies: any element of $N$ is contained in a free direct summand of $N$.
 Then $M$ is free.
\end{lemma}

\begin{proof}
Let $x_1, x_2, \ldots$ be a countable set of generators for $M$.  By the
assumption on $M$, we can construct by induction free $R$-modules $F_1, F_2,
\ldots$ such that for every positive integer $n$, $\bigoplus_{i=1}^{n} F_i$ is a
direct summand of $M$ and contains $x_1, \ldots, x_n$.  Then $M = \bigoplus_{i =
1}^{\infty} F_i$.
\end{proof}

\begin{lemma}
\label{lemma-projective-freeness-criteria}
Let $P$ be a projective module over a local ring $R$.  Then any element of $P$
is contained in a free direct summand of $P$.
\end{lemma}

\begin{proof}
Since $P$ is projective it is a direct summand of some free $R$-module $F$, say
$F = P \oplus Q$.  Let $x \in P$ be the element that we wish to show is
contained in a free direct summand of $P$.  Let $B$ be a basis of $F$ such that
the number of basis elements needed in the expression of $x$ is minimal, say $x
= \sum_{i=1}^n a_i e_i$ for some $e_i \in B$ and $a_i \in R$.  Then no $a_j$
can be expressed as a linear combination of the other $a_i$; for if $a_j =
\sum_{i \neq  j} a_i b_i$ for some $b_i \in R$, then replacing $e_i$ by $e_i +
b_ie_j$ for $i \neq j$ and leaving unchanged the other elements of $B$, we get
a new basis for $F$ in terms of which $x$ has a shorter expression.

\medskip\noindent
Let $e_i = y_i + z_i, y_i \in P, z_i \in Q$ be the decomposition of $e_i$ into
its $P$- and $Q$-components.  Write $y_i = \sum_{j=1}^{n} b_{ij} e_j + t_i$,
where $t_i$ is a linear combination of elements in $B$ other than $e_1, \ldots,
e_n$.  To finish the proof it suffices to show that the matrix $(b_{ij})$ is
invertible.  For then the map $F \to F$ sending $e_i \mapsto y_i$ for
$i=1, \ldots, n$ and fixing $B \setminus \{e_1, \ldots, e_n\}$ is an
isomorphism,
so that $y_1, \ldots, y_n$ together with $B \setminus \{e_1, \ldots, e_n\}$
form a basis for $F$.  Then the submodule $N$ spanned by $y_1, \ldots, y_n$
is a free submodule of $P$; $N$ is a direct summand of $P$ since $N \subset P$
and both $N$ and $P$ are direct summands of $F$; and $x \in N$ since $x \in P$
implies $x = \sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$.

\medskip\noindent
Now we prove that $(b_{ij})$ is invertible. Plugging $y_i = \sum_{j=1}^{n}
b_{ij} e_j + t_i$ into $\sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$ and
equating the coefficients of $e_j$ gives $a_j = \sum_{i=1}^n a_i b_{ij}$.  But
as noted above, our choice of $B$ guarantees that no $a_j$ can be written as a
linear combination of the other $a_i$.  Thus $b_{ij}$ is a non-unit for $i \neq
j$, and $1-b_{ii}$ is a non-unit---so in particular $b_{ii}$ is a unit---for
all $i$.  But a matrix over a local ring having units along the diagonal and
non-units elsewhere is invertible, as its determinant is a unit.
\end{proof}

\begin{theorem}
\label{theorem-projective-free-over-local-ring}
\begin{slogan}
Projective modules over local rings are free.
\end{slogan}
If $P$ is a projective module over a local ring $R$, then $P$ is free.
\end{theorem}

\begin{proof}
Follows from Lemmas \ref{lemma-projective-free}, \ref{lemma-freeness-criteria},
and \ref{lemma-projective-freeness-criteria}.
\end{proof}



\section{Mittag-Leffler systems}
\label{section-mittag-leffler}

\noindent
The purpose of this section is to define Mittag-Leffler systems
and why it is a useful property.

\medskip\noindent
In the following, $I$ will be a directed set, see
Categories, Definition \ref{categories-definition-directed-set}.
Let $(A_i, \varphi_{ji}: A_j \to A_i)$ be an inverse
system of sets or of modules indexed by $I$, see
Categories, Definition \ref{categories-definition-directed-system}.
This is a directed inverse system as we assumed $I$ directed
(Categories, Definition \ref{categories-definition-directed-system}).
For each $i \in I$, the
images $\varphi_{ji}(A_j) \subset A_i$ for $j \geq i$ form a decreasing
family.  Let $A'_i = \bigcap_{j \geq i} \varphi_{ji}(A_j)$.
Then $\varphi_{ji}(A'_j) \subset A'_i$ for $j \geq i$, hence by restricting
we get a directed inverse system $(A'_i, \varphi_{ji}|_{A'_j})$.
From the construction of the limit of an inverse system in the category
of sets or modules, we have $\lim A_i = \lim A'_i$.  The Mittag-Leffler
condition on $(A_i, \varphi_{ji})$ is that $A'_i$ equals
$\varphi_{ji}(A_j)$ for some $j \geq i$ (and hence equals
$\varphi_{ki}(A_k)$ for all $k \geq j$):

\begin{definition}
\label{definition-ML-system}
Let $(A_i, \varphi_{ji})$ be a directed inverse system of sets over $I$.  Then
we say  $(A_i, \varphi_{ji})$ is {\it Mittag-Leffler inverse system} if for
each $i \in I$, the decreasing family $\varphi_{ji}(A_j) \subset A_i$ for $j
\geq i$ stabilizes.  Explicitly, this means that for each $i \in I$, there
exists $j \geq i$ such that for $k \geq j$ we have $\varphi_{ki}(A_k) =
\varphi_{ji}( A_j)$.  If $(A_i, \varphi_{ji})$ is a directed inverse system
of modules over a ring $R$, we say that it is Mittag-Leffler if the underlying
inverse system of sets is Mittag-Leffler.
\end{definition}

\begin{example}
\label{example-ML-surjective-maps}
If $(A_i, \varphi_{ji})$ is a directed inverse system of sets or of modules and
the maps $\varphi_{ji}$ are surjective, then clearly the system is
Mittag-Leffler.  Conversely, suppose $(A_i, \varphi_{ji})$ is Mittag-Leffler.
Let $A'_i \subset A_i$ be the stable image of $\varphi_{ji}(A_j)$ for $j \geq
i$.  Then $\varphi_{ji}|_{A'_j}: A'_j \to A'_i$ is surjective for
$j \geq i$ and $\lim A_i = \lim A'_i$.  Hence the limit of the Mittag-Leffler
system $(A_i, \varphi_{ji})$ can also be written as the limit of a directed
inverse system over $I$ with surjective maps.
\end{example}

\begin{lemma}
\label{lemma-ML-limit-nonempty}
Let $(A_i, \varphi_{ji})$ be a directed inverse system over $I$.  Suppose $I$
is countable.  If $(A_i, \varphi_{ji})$ is Mittag-Leffler and the $A_i$ are
nonempty, then $\lim A_i$ is nonempty.
\end{lemma}

\begin{proof}
Let $i_1, i_2, i_3, \ldots$ be an enumeration of the elements of $I$.  Define
inductively a sequence of elements $j_n \in I$ for $n = 1, 2, 3, \ldots$ by the
conditions: $j_1 = i_1$, and $j_n \geq i_n$ and $j_n \geq j_m$ for $m < n$.
 Then the sequence $j_n$ is increasing and forms a cofinal subset of $I$.
Hence we may assume $I =\{1, 2, 3, \ldots \}$.  So by Example
\ref{example-ML-surjective-maps} we are reduced to showing that the limit of an
inverse system of nonempty sets with surjective maps indexed by the positive
integers is nonempty.  This is obvious.
\end{proof}

\noindent
The Mittag-Leffler condition will be important for us because of the following
exactness property.

\begin{lemma}
\label{lemma-ML-exact-sequence}
Let
$$
0 \to A_i \xrightarrow{f_i} B_i \xrightarrow{g_i} C_i \to 0
$$
be an exact sequence of directed inverse systems of abelian groups over $I$.
Suppose $I$ is countable.  If $(A_i)$ is Mittag-Leffler, then
$$
0 \to \lim A_i \to \lim B_i \to \lim C_i\to 0
$$
is exact.
\end{lemma}

\begin{proof}
Taking limits of directed inverse systems is left exact, hence we only need to
prove surjectivity of $\lim B_i \to \lim C_i$.  So let $(c_i) \in \lim
C_i$.  For each $i \in I$, let $E_i = g_i^{-1}(c_i)$, which is nonempty since
$g_i: B_i \to C_i$ is surjective. The system of maps $\varphi_{ji}: B_j
\to B_i$ for $(B_i)$ restrict to maps $E_j \to E_i$ which
make $(E_i)$ into an inverse system of nonempty sets.  It is enough to show
that $(E_i)$ is Mittag-Leffler. For then Lemma \ref{lemma-ML-limit-nonempty}
would show $\lim E_i$ is nonempty, and taking any element of $\lim E_i$ would
give an element of $\lim B_i$ mapping to $(c_i)$.

\medskip\noindent
By the injection $f_i: A_i \to B_i$ we will regard $A_i$ as a subset of
$B_i$.  Since $(A_i)$ is Mittag-Leffler, if $i \in I$ then there exists $j \geq
i$ such that $\varphi_{ki}(A_k) = \varphi_{ji}(A_j)$ for $k \geq j$.  We claim
that also $\varphi_{ki}(E_k) = \varphi_{ji}(E_j)$ for $k \geq j$.  Always
$\varphi_{ki}(E_k) \subset \varphi_{ji}(E_j)$ for $k \geq j$.  For the reverse
inclusion let $e_j \in E_j$, and we need to find $x_k \in E_k$ such that
$\varphi_{ki}(x_k) = \varphi_{ji}(e_j)$.  Let $e'_k \in E_k$ be any element,
and set $e'_j = \varphi_{kj}(e'_k)$.  Then $g_j(e_j - e'_j) = c_j - c_j = 0$,
hence $e_j - e'_j = a_j \in A_j$.  Since $\varphi_{ki}(A_k) =
\varphi_{ji}(A_j)$, there exists $a_k \in A_k$ such that $\varphi_{ki}(a_k) =
\varphi_{ji}(a_j)$.  Hence
$$
\varphi_{ki}(e'_k + a_k) = \varphi_{ji}(e'_j) + \varphi_{ji}(a_j) =
\varphi_{ji}(e_j),
$$
so we can take $x_k = e'_k + a_k$.
\end{proof}




\section{Inverse systems}
\label{section-inverse-systems}

\noindent
In many papers (and in this section) the term {\it inverse system} is
used to indicate an inverse system over the partially ordered set
$(\mathbf{N}, \geq)$. We briefly discuss such systems in this section.
This material will be discussed more broadly in
Homology, Section \ref{homology-section-inverse-systems}.
Suppose we are given a ring $R$ and a sequence of $R$-modules
$$
M_1 \xleftarrow{\varphi_2} M_2 \xleftarrow{\varphi_3} M_3 \leftarrow \ldots
$$
with maps as indicated. By composing successive maps we obtain maps
$\varphi_{ii'} : M_i \to M_{i'}$ whenever $i \geq i'$ such that moreover
$\varphi_{ii''} = \varphi_{i'i''} \circ \varphi_{i i'}$ whenever
$i \geq i' \geq i''$. Conversely, given the system of maps $\varphi_{ii'}$
we can set $\varphi_i = \varphi_{i(i-1)}$ and recover the maps displayed
above. In this case
$$
\lim M_i
=
\{(x_i) \in \prod M_i \mid \varphi_i(x_i) = x_{i - 1}, \ i = 2, 3, \ldots\}
$$
compare with
Categories, Section \ref{categories-section-limit-sets}.
As explained in
Homology, Section \ref{homology-section-inverse-systems}
this is actually a limit in the category of $R$-modules, as defined in
Categories, Section \ref{categories-section-limits}.

\begin{lemma}
\label{lemma-Mittag-Leffler}
Let $R$ be a ring.
Let $0 \to K_i \to L_i \to M_i \to 0$ be short exact sequences of
$R$-modules, $i \geq 1$ which fit into maps of short exact sequences
$$
\xymatrix{
0 \ar[r] &
K_i \ar[r] &
L_i \ar[r] &
M_i \ar[r] &
0 \\
0 \ar[r] &
K_{i + 1} \ar[r] \ar[u] &
L_{i + 1} \ar[r] \ar[u] &
M_{i + 1} \ar[r] \ar[u] &
0}
$$
If for every $i$ there exists a $c = c(i) \geq i$ such that
$\Im(K_c \to K_i) = \Im(K_j \to K_i)$
for all $j \geq c$, then the sequence
$$
0 \to \lim K_i \to \lim L_i \to \lim M_i \to 0
$$
is exact.
\end{lemma}

\begin{proof}
This is a special case of the more general
Lemma \ref{lemma-ML-exact-sequence}.
\end{proof}



\section{Mittag-Leffler modules}
\label{section-mittag-leffler-modules}

\noindent
A Mittag-Leffler module is (very roughly) a module which can be written
as a directed limit whose dual is a Mittag-Leffler system. To be able
to give a precise definition we need to do a bit of work.

\begin{definition}
\label{definition-ML-inductive-system}
Let $(M_i, f_{ij})$ be a directed system of $R$-modules.  We say that
$(M_i, f_{ij})$ is a {\it Mittag-Leffler directed system of modules} if each
$M_i$ is an $R$-module of finite presentation and if for every $R$-module $N$,
the inverse system
$$
(\Hom_R(M_i, N), \Hom_R(f_{ij}, N))
$$
is Mittag-Leffler.
\end{definition}

\noindent
We are going to characterize those $R$-modules that are colimits of
Mittag-Leffler directed systems of modules.

\begin{definition}
\label{definition-domination}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.
Then we say $g$ {\it dominates} $f$ if for any $R$-module $Q$, we have $\Ker(f
\otimes_R \text{id}_Q) \subset \Ker(g \otimes_R \text{id}_Q)$.
\end{definition}

\noindent
It is enough to check this condition for finitely presented modules.

\begin{lemma}
\label{lemma-domination-fp}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.
Then $g$ dominates $f$ if and only if for any finitely presented $R$-module
$Q$, we have $\Ker(f \otimes_R \text{id}_Q) \subset \Ker(g \otimes_R
\text{id}_Q)$.
\end{lemma}

\begin{proof}
Suppose $\Ker(f \otimes_R \text{id}_Q) \subset \Ker(g \otimes_R
\text{id}_Q)$ for all finitely presented modules $Q$.  If $Q$ is an
arbitrary module, write $Q = \colim_{i \in I} Q_i$ as a colimit of a
directed
system of finitely presented modules $Q_i$.  Then $\Ker(f \otimes_R
\text{id}_{Q_i}) \subset \Ker(g \otimes_R \text{id}_{Q_i})$ for
all $i$.  Since taking directed colimits is exact and commutes with tensor
product, it follows that $\Ker(f \otimes_R \text{id}_Q) \subset \Ker(g
\otimes_R \text{id}_Q)$.
\end{proof}

\begin{lemma}
\label{lemma-domination-universally-injective}
Let $f : M \to N$ and $g : M \to M'$ be maps of $R$-modules.
Consider the pushout of $f$ and $g$,
$$
\xymatrix{
M  \ar[r]_f \ar[d]_g & N \ar[d]^{g'} \\
M' \ar[r]^{f'} & N'
}
$$
Then $g$ dominates $f$ if and only if $f'$ is universally injective.
\end{lemma}

\begin{proof}
Recall that $N'$ is $M' \oplus N$ modulo the submodule consisting of elements
$(g(x), -f(x))$ for $x \in M$.
From the construction of $N'$ we have a short exact sequence
$$
0 \to \Ker(f) \cap \Ker(g) \to \Ker(f) \to \Ker(f')
\to 0.
$$
Since tensoring commutes with taking pushouts, we have such a short exact
sequence
$$
0 \to \Ker(f \otimes \text{id}_Q ) \cap \Ker(g \otimes
\text{id}_Q) \to \Ker(f \otimes \text{id}_Q)
\to \Ker(f' \otimes \text{id}_Q) \to 0
$$
for every $R$-module $Q$.  So $f'$ is universally injective if and only if
$\Ker(f \otimes \text{id}_Q ) \subset \Ker(g \otimes
\text{id}_Q)$ for every $Q$, if and only if $g$ dominates $f$.
\end{proof}

\noindent
The above definition of domination is sometimes related to the usual notion
of domination of maps as the following lemma shows.

\begin{lemma}
\label{lemma-domination}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.
Suppose $\Coker(f)$ is of finite presentation.  Then $g$ dominates $f$ if
and
only if $g$ factors through $f$, i.e.\ there exists a module map $h: N
\to M'$ such that $g = h \circ f$.
\end{lemma}

\begin{proof}
Consider the pushout of $f$ and $g$ as in the statement of
Lemma \ref{lemma-domination-universally-injective}.
From the construction of the pushout it follows that
$\Coker(f') = \Coker(f)$, so $\Coker(f')$ is of finite
presentation.  Then by
Lemma \ref{lemma-universally-exact-split}, $f'$ is universally injective if and
only if
$$
0 \to M' \xrightarrow{f'} N' \to \Coker(f') \to 0
$$
splits. This is the case if and only if there is a map $h' : N' \to M'$
such that $h' \circ f' = \text{id}_{M'}$.  From the universal
property of the pushout, the existence of such an $h'$ is equivalent to $g$
factoring through $f$.
\end{proof}


\begin{proposition}
\label{proposition-ML-characterization}
Let $M$ be an $R$-module.  Let $(M_i, f_{ij})$ be a directed system of finitely
presented $R$-modules, indexed by $I$, such that $M = \colim M_i$.  Let
$f_i:
M_i \to M$ be the canonical map.  The following are equivalent:
\begin{enumerate}
\item For every finitely presented $R$-module $P$ and module map $f: P
\to M$, there exists a finitely presented $R$-module $Q$ and a module
map $g: P \to Q$ such that $g$ and $f$ dominate each other, i.e.,
$\Ker(f \otimes_R \text{id}_N) = \Ker(g \otimes_R \text{id}_N)$
for every $R$-module $N$.
\item For each $i \in I$, there exists $j \geq i$ such that $f_{ij}: M_i
\to M_j$ dominates $f_i: M_i \to M$.
\item For each $i \in I$, there exists $j \geq i$ such that $f_{ij}: M_i
\to M_j$ factors through $f_{ik}: M_i \to M_k$ for all $k \geq
i$.
\item For every $R$-module $N$, the inverse system
$(\Hom_R(M_i, N), \Hom_R(f_{ij}, N))$ is Mittag-Leffler.
\item For $N = \prod_{s \in I} M_s$, the inverse system
$(\Hom_R(M_i, N), \Hom_R(f_{ij}, N))$ is Mittag-Leffler.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove the equivalence of (1) and (2).  Suppose (1) holds and let $i
\in I$. Corresponding to the map $f_i: M_i \to M$, we can choose $g:
M_i \to Q$ as in (1).  Since $M_i$ and $Q$ are of finite presentation,
so is $\Coker(g)$.  Then by Lemma \ref{lemma-domination}, $f_i : M_i
\to M$ factors through $g: M_i \to Q$, say $f_i = h \circ g$
for some $h: Q \to M$.  Then since $Q$ is finitely presented, $h$
factors through $M_j \to M$ for some $j \geq i$, say $h = f_j \circ h'$
for some $h': Q \to M_j$.  In total we have a commutative diagram
$$
\xymatrix{
  &  M  & \\
M_i \ar[dr]_g \ar[ur]^{f_i} \ar[rr]^{f_{ij}} &
& M_j \ar[ul]_{f_j} \\
  & Q  \ar[ur]_{h'} &
}
$$
Thus $f_{ij}$ dominates $g$.  But $g$ dominates $f_i$, so $f_{ij}$ dominates
$f_i$.

\medskip\noindent
Conversely, suppose (2) holds.  Let $P$ be of finite presentation and $f: P
\to M$ a module map.  Then $f$ factors through $f_i: M_i \to M$
for some $i \in I$, say $f = f_i \circ g'$ for some $g': P \to M_i$.
Choose by (2) a $j \geq i$ such that $f_{ij}$ dominates $f_i$.  We have a
commutative diagram
$$
\xymatrix{
P \ar[d]_{g'} \ar[r]^{f}           & M  \\
M_i \ar[ur]^{f_i} \ar[r]_{f_{ij}} & M_j \ar[u]_{f_j}
}
$$
From the diagram and the fact that $f_{ij}$ dominates $f_i$, we find that $f$
and $f_{ij} \circ g'$ dominate each other.  Hence taking $g = f_{ij} \circ g' :
P \to M_j$ works.

\medskip\noindent
Next we prove (2) is equivalent to (3).  Let $i \in I$.  It is always true that
$f_i$ dominates $f_{ik}$ for $k \geq i$, since $f_i$ factors through
$f_{ik}$.  If (2) holds, choose $j \geq i$ such that $f_{ij}$ dominates
$f_i$.  Then since domination is a transitive relation, $f_{ij}$ dominates
$f_{ik}$ for $k \geq i$. All $M_i$ are of finite presentation, so
$\Coker(f_{ik})$ is of finite presentation for $k \geq i$.  By Lemma
\ref{lemma-domination}, $f_{ij}$ factors through $f_{ik}$ for all $k \geq i$.
Thus (2) implies (3).  On the other hand, if (3) holds then for any $R$-module
$N$, $f_{ij} \otimes_R \text{id}_N$ factors through $f_{ik}
\otimes_R \text{id}_N$ for $k \geq i$.  So $\Ker(f_{ik} \otimes_R
\text{id}_N) \subset \Ker(f_{ij} \otimes_R \text{id}_N)$ for $k
\geq i$.  But $\Ker(f_i \otimes_R \text{id}_N: M_i \otimes_R N
\to M \otimes_R N)$ is the union of $\Ker(f_{ik} \otimes_R
\text{id}_N)$ for $k \geq i$.  Thus $\Ker(f_i \otimes_R
\text{id}_N) \subset \Ker(f_{ij} \otimes_R \text{id}_N)$ for
any $R$-module $N$, which by definition means $f_{ij}$ dominates $f_i$.

\medskip\noindent
It is trivial that (3) implies (4) implies (5).  We show (5) implies (3).  Let
$N = \prod_{s \in I} M_s$. If (5) holds, then given $i \in I$ choose $j \geq i$
such that
$$
\Im( \Hom(M_j, N) \to  \Hom(M_i, N)) =
\Im( \Hom(M_k, N) \to  \Hom(M_i, N))
$$
for all $k \geq j$.  Passing the product over $s \in I$ outside of the
$\Hom$'s
and looking at the maps on each component of the product, this says
$$
\Im( \Hom(M_j, M_s) \to  \Hom(M_i, M_s)) =
\Im( \Hom(M_k, M_s) \to   \Hom(M_i, M_s))
$$
for all $k \geq j$ and $s \in I$.  Taking $s = j$ we have
$$
\Im( \Hom(M_j, M_j) \to  \Hom(M_i, M_j)) =
\Im( \Hom(M_k, M_j) \to   \Hom(M_i, M_j))
$$
for all $k \geq j$.  Since $f_{ij}$ is the image of
$\text{id} \in  \Hom(M_j, M_j)$ under
$\Hom(M_j, M_j) \to  \Hom(M_i, M_j)$,
this shows  that for any $k \geq j$ there is $h \in \Hom(M_k, M_j)$
such that $f_{ij} = h \circ f_{ik}$.  If $j \geq k$ then we can take
$h = f_{kj}$. Hence (3) holds.
\end{proof}

\begin{definition}
\label{definition-mittag-leffler-module}
Let $M$ be an $R$-module.  We say that $M$ is {\it Mittag-Leffler} if the
equivalent conditions of
Proposition \ref{proposition-ML-characterization}
hold.
\end{definition}

\noindent
In particular a finitely presented module is Mittag-Leffler.

\begin{remark}
\label{remark-flat-ML}
Let $M$ be a flat $R$-module. By Lazard's theorem
(Theorem \ref{theorem-lazard})
we can write $M = \colim M_i$ as the colimit of a
directed system $(M_i, f_{ij})$ where the $M_i$ are free
finite $R$-modules. For $M$ to be Mittag-Leffler, it is enough for the inverse
system of duals $(\Hom_R(M_i, R), \Hom_R(f_{ij}, R))$ to be
Mittag-Leffler. This follows from criterion (4) of
Proposition \ref{proposition-ML-characterization}
and the fact that for a free finite $R$-module $F$,
there is a functorial isomorphism
$\Hom_R(F, R) \otimes_R N \cong \Hom_R(F, N)$
for any $R$-module $N$.
\end{remark}

\begin{lemma}
\label{lemma-tensor-ML-modules}
If $R$ is a ring and $M$, $N$ are Mittag-Leffler modules over $R$,
then $M \otimes_R N$ is a Mittag-Leffler module.
\end{lemma}

\begin{proof}
Write $M = \colim_{i \in I} M_i$ and $N = \colim_{j \in J} N_j$
as directed colimits of finitely presented $R$-modules.
Denote $f_{ii'} : M_i \to M_{i'}$ and $g_{jj'} : N_j \to N_{j'}$ the
transition maps. Then $M_i \otimes_R N_j$ is a finitely presented
$R$-module (see
Lemma \ref{lemma-tensor-finiteness}),
and $M \otimes_R N = \colim_{(i, j) \in I \times J} M_i \otimes_R M_j$.
Pick $(i, j) \in I \times J$. By the definition of a Mittag-Leffler module
we have
Proposition \ref{proposition-ML-characterization} (3)
for both systems. In other words there exist $i' \geq i$ and $j' \geq j$
such that for every choice of $i'' \geq i$ and $j'' \geq j$ there exist
maps $a : M_{i''} \to M_{i'}$ and $b : M_{j''} \to M_{j'}$ such that
$f_{ii'} = a \circ f_{ii''}$ and $g_{jj'} = b \circ g_{jj''}$.
Then it is clear that
$a \otimes b : M_{i''} \otimes_R N_{j''} \to M_{i'} \otimes_R N_{j'}$
serves the same purpose for the system
$(M_i \otimes_R N_j, f_{ii'} \otimes g_{jj'})$.
Thus by the characterization
Proposition \ref{proposition-ML-characterization} (3)
we conclude that $M \otimes_R N$ is Mittag-Leffler.
\end{proof}

\begin{lemma}
\label{lemma-ML-also}
Let $R$ be a ring and $M$ an $R$-module. Then $M$ is Mittag-Leffler if and
only if for every finite free $R$-module $F$ and module map
$f: F \to M$, there exists a finitely presented $R$-module $Q$
and a module map $g : F \to Q$ such that $g$ and $f$ dominate each other, i.e.,
$\Ker(f \otimes_R \text{id}_N) = \Ker(g \otimes_R \text{id}_N)$
for every $R$-module $N$.
\end{lemma}

\begin{proof}
Since the condition is clear weaker than condition (1) of
Proposition \ref{proposition-ML-characterization}
we see that a Mittag-Leffler module satisfies the condition.
Conversely, suppose that $M$ satisfies the condition and that
$f : P \to M$ is an $R$-module map from a finitely presented
$R$-module $P$ into $M$. Choose a surjection $F \to P$ where
$F$ is a finite free $R$-module. By assumption we can find a map
$F \to Q$ where $Q$ is a finitely presented $R$-module such that
$F \to Q$ and $F \to M$ dominate each other. In particular, the kernel
of $F \to Q$ contains the kernel of $F \to P$, hence we obtain an
$R$-module map $g : P \to Q$ such that $F \to Q$ is equal to
the composition $F \to P \to Q$. Let $N$ be any $R$-module and
consider the commutative diagram
$$
\xymatrix{
F \otimes_R N \ar[d] \ar[r] & Q \otimes_R N \\
P \otimes_R N \ar[ru] \ar[r] & M \otimes_R N
}
$$
By assumption the kernels of $F \otimes_R N \to Q \otimes_R N$
and $F \otimes_R N \to M \otimes_R N$ are equal. Hence, as
$F \otimes_R N \to P \otimes_R N$ is surjective, also the kernels
of $P \otimes_R N \to Q \otimes_R N$
and $P \otimes_R N \to M \otimes_R N$ are equal.
\end{proof}

\begin{lemma}
\label{lemma-restrict-ML-modules}
Let $R \to S$ be a finite and finitely presented ring map.
Let $M$ be an $S$-module.
If $M$ is a Mittag-Leffler module over $S$ then
$M$ is a Mittag-Leffler module over $R$.
\end{lemma}

\begin{proof}
Assume $M$ is a Mittag-Leffler module over $S$.
Write $M = \colim M_i$ as a directed colimit of finitely presented
$S$-modules $M_i$. As $M$ is Mittag-Leffler over $S$ there exists for each
$i$ an index $j \geq i$ such that for all $k \geq j$ there is a factorization
$f_{ij} = h \circ f_{ik}$ (where $h$ depends on $i$, the choice of $j$ and
$k$). Note that by
Lemma \ref{lemma-finite-finitely-presented-extension}
the modules $M_i$ are also finitely presented as $R$-modules. Moreover, all
the maps $f_{ij}, f_{ik}, h$ are maps of $R$-modules. Thus we see that the
system $(M_i, f_{ij})$ satisfies the same condition when viewed as a system
of $R$-modules. Thus $M$ is Mittag-Leffler as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-mod-ideal-ML-modules}
Let $R$ be a ring.
Let $S = R/I$ for some finitely generated ideal $I$.
Let $M$ be an $S$-module.
Then $M$ is a Mittag-Leffler module over $R$ if and only if
$M$ is a Mittag-Leffler module over $S$.
\end{lemma}

\begin{proof}
One implication follows from
Lemma \ref{lemma-restrict-ML-modules}.
To prove the other, assume $M$ is Mittag-Leffler as an $R$-module.
Write $M = \colim M_i$ as a directed colimit of finitely presented
$S$-modules. As $I$ is finitely generated, the ring $S$ is finite and finitely
presented as an $R$-algebra, hence the modules $M_i$ are finitely
presented as $R$-modules, see
Lemma \ref{lemma-finite-finitely-presented-extension}.
Next, let $N$ be any $S$-module. Note that for each $i$ we have
$\Hom_R(M_i, N) = \Hom_S(M_i, N)$ as $R \to S$ is surjective.
Hence the condition that the inverse system
$(\Hom_R(M_i, N))_i$ satisfies Mittag-Leffler, implies that the system
$(\Hom_S(M_i, N))_i$ satisfies Mittag-Leffler. Thus $M$ is
Mittag-Leffler over $S$ by definition.
\end{proof}

\begin{remark}
\label{remark-go-up-ML-modules}
Let $R \to S$ be a finite and finitely presented ring map.
Let $M$ be an $S$-module which is Mittag-Leffler as an $R$-module.
Then it is in general not the case that $M$ is Mittag-Leffler as
an $S$-module. For example suppose that $S$ is the ring of dual numbers
over $R$, i.e., $S = R \oplus R\epsilon$ with $\epsilon^2 = 0$. Then an
$S$-module consists of an $R$-module $M$ endowed with a square zero
$R$-linear endomorphism $\epsilon : M \to M$. Now suppose that $M_0$
is an $R$-module which is not Mittag-Leffler. Choose a presentation
$F_1 \xrightarrow{u} F_0 \to M_0 \to 0$ with $F_1$ and $F_0$ free $R$-modules.
Set $M = F_1 \oplus F_0$ with
$$
\epsilon =
\left(
\begin{matrix}
0 & 0 \\
u & 0
\end{matrix}
\right) : M \longrightarrow M.
$$
Then $M/\epsilon M \cong F_1 \oplus M_0$ is not Mittag-Leffler over
$R = S/\epsilon S$, hence not Mittag-Leffler over $S$ (see
Lemma \ref{lemma-mod-ideal-ML-modules}).
On the other hand, $M/\epsilon M = M \otimes_S S/\epsilon S$ which would
be Mittag-Leffler over $S$ if $M$ was, see
Lemma \ref{lemma-tensor-ML-modules}.
\end{remark}


\section{Interchanging direct products with tensor}
\label{section-products-tensor}

\noindent
Let $M$ be an $R$-module and let $(Q_{\alpha})_{\alpha \in A}$ be a family of
$R$-modules.  Then there is a canonical map $M \otimes_R \left( \prod_{\alpha
\in A} Q_{\alpha} \right) \to \prod_{\alpha \in A} ( M \otimes_R
Q_{\alpha})$ given on pure tensors by $x \otimes (q_{\alpha}) \mapsto (x
\otimes q_{\alpha})$.  This map is not necessarily injective or surjective, as
the following example shows.

\begin{example}
\label{example-Q-not-ML}
Take $R = \mathbf{Z}$, $M = \mathbf{Q}$, and consider the family $Q_n =
\mathbf{Z}/n$ for $n \geq 1$.  Then $\prod_n (M \otimes Q_n) = 0$.  However
there is an injection $\mathbf{Q} \to M \otimes (\prod_n Q_n)$
obtained by tensoring the injection $\mathbf{Z} \to \prod_n Q_n$ by
$M$, so $M \otimes (\prod_n Q_n)$ is nonzero.  Thus $M \otimes (\prod_n
Q_n) \to \prod_n (M \otimes Q_n)$ is not injective.

\medskip\noindent
On the other hand, take again $R = \mathbf{Z}$, $M = \mathbf{Q}$, and let $Q_n
= \mathbf{Z}$ for $n \geq 1$.  The image of $M \otimes (\prod_n Q_n)
\to \prod_n (M \otimes Q_n) = \prod_n M$ consists precisely of
sequences of the form $(a_n/m)_{n \geq 1}$ with $a_n \in \mathbf{Z}$ and $m$
some nonzero integer.  Hence the map is not surjective.
\end{example}

\noindent
We determine below the precise conditions needed on $M$ for the map $M
\otimes_R \left( \prod_{\alpha} Q_{\alpha} \right) \to \prod_{\alpha}
(M \otimes_R Q_{\alpha})$ to be surjective, bijective, or injective for all
choices of $(Q_{\alpha})_{\alpha \in A}$.  This is relevant because the modules
for which it is injective turn out to be exactly Mittag-Leffler modules
(Proposition \ref{proposition-ML-tensor}).  In what follows, if $M$ is an
$R$-module and $A$ a set, we write $M^A$ for the product $\prod_{\alpha \in A}
M$.

\begin{proposition}
\label{proposition-fg-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is finitely generated.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the
canonical map $M \otimes_R \left( \prod_{\alpha} Q_{\alpha} \right)
\to \prod_{\alpha} (M \otimes_R Q_{\alpha})$ is surjective.
\item For every $R$-module $Q$ and every set $A$, the canonical map $M
\otimes_R Q^{A} \to (M \otimes_R Q)^{A}$ is surjective.
\item For every set $A$, the canonical map $M \otimes_R R^{A} \to
M^{A}$ is surjective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Choose a surjection $R^n \to M$ and
consider the commutative diagram
$$
\xymatrix{
R^n \otimes_R (\prod_{\alpha} Q_{\alpha})  \ar[r]^{\cong} \ar[d] &
\prod_{\alpha} (R^n \otimes_R Q_{\alpha}) \ar[d] \\
M \otimes_R (\prod_{\alpha} Q_{\alpha})  \ar[r] & \prod_{\alpha} ( M
\otimes_R Q_{\alpha}).
}
$$
The top arrow is an isomorphism and the vertical arrows are surjections.  We
conclude that the bottom arrow is a surjection.

\medskip\noindent
Obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1).
In fact for (1) to hold it suffices that the element $d = (x)_{x \in M}$ of
$M^M$ is in the image of the map $f: M \otimes_R R^{M} \to M^M$.  In
this case $d = \sum_{i = 1}^{n} f(x_i \otimes a_i)$ for some $x_i \in M$ and
$a_i \in R^M$.  If for $x \in M$ we write $p_x: M^M \to M$ for the
projection onto the $x$-th factor, then
$$
x = p_x(d) = \sum\nolimits_{i = 1}^{n} p_x(f(x_i \otimes a_i)) =
\sum\nolimits_{i=1}^{n} p_x(a_i) x_i.
$$
Thus $x_1, \ldots, x_n$ generate $M$.
\end{proof}

\begin{proposition}
\label{proposition-fp-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is finitely presented.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the
canonical map $M \otimes_R \left( \prod_{\alpha} Q_{\alpha} \right)
\to \prod_{\alpha} (M \otimes_R Q_{\alpha})$ is bijective.
\item For every $R$-module $Q$ and every set $A$, the canonical map $M
\otimes_R Q^{A} \to (M \otimes_R Q)^{A}$ is bijective.
\item For every set $A$, the canonical map $M \otimes_R R^{A} \to
M^{A}$ is bijective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Choose a presentation $R^m \to R^n
\to M$ and consider the commutative diagram
$$
\xymatrix{
R^m \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d]^{\cong} & R^m
\otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d]^{\cong} & M \otimes_R
(\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & 0 \\
\prod_{\alpha} (R^m \otimes_R Q_{\alpha}) \ar[r] & \prod_{\alpha} (R^n
\otimes_R Q_{\alpha}) \ar[r] & \prod_{\alpha} (M \otimes_R Q_{\alpha})
\ar[r] & 0.
}
$$
The first two vertical arrows are isomorphisms and the rows are exact.  This
implies that the map
$M \otimes_R (\prod_{\alpha} Q_{\alpha}) \to
\prod_{\alpha} ( M \otimes_R Q_{\alpha})$
is surjective and, by a diagram chase, also injective.  Hence (2) holds.

\medskip\noindent
Obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1).
From Proposition \ref{proposition-fg-tensor}, if (4) holds we already know that
$M$ is finitely generated.  So we can choose a surjection $F \to M$
where $F$ is free and finite.  Let $K$ be the kernel.  We must show $K$ is
finitely generated.  For any set $A$, we have a commutative diagram
$$
\xymatrix{
& K \otimes_R R^A \ar[r] \ar[d]_{f_3} & F \otimes_R R^A \ar[r]
\ar[d]_{f_2}^{\cong} & M \otimes_R R^A \ar[r] \ar[d]_{f_1}^{\cong} & 0 \\
0 \ar[r] & K^A \ar[r] & F^A \ar[r] & M^A \ar[r] & 0 .
}
$$
The map $f_1$ is an isomorphism by assumption, the map $f_2$ is a isomorphism
since $F$ is free and finite, and the rows are exact.  A diagram chase shows
that $f_3$ is surjective, hence by Proposition \ref{proposition-fg-tensor} we
get that $K$ is finitely generated.
\end{proof}

\noindent
We need the following lemma for the next proposition.

\begin{lemma}
\label{lemma-kernel-tensored-fp}
Let $M$ be an $R$-module, $P$ a finitely presented $R$-module, and $f: P
\to M$ a map.  Let $Q$ be an $R$-module and suppose $x \in \Ker(P
\otimes Q \to M \otimes Q)$.  Then there exists a finitely presented
$R$-module $P'$ and a map $f': P \to P'$ such that $f$ factors through
$f'$ and $x \in \Ker(P \otimes Q \to P' \otimes Q)$.
\end{lemma}

\begin{proof}
Write $M$ as a colimit $M = \colim_{i \in I} M_i$ of a directed system of
finitely presented modules $M_i$.  Since $P$ is finitely presented, the map $f:
P \to M$ factors through $M_j \to M$ for some $j \in I$.  Upon
tensoring by $Q$ we have a commutative diagram
$$
\xymatrix{
& M_j \otimes Q \ar[dr] & \\
P \otimes Q \ar[ur] \ar[rr] & & M \otimes Q .
}
$$
The image $y$ of $x$ in $M_j \otimes Q$ is in the kernel of $M_j \otimes Q
\to M \otimes Q$.  Since $M \otimes Q = \colim_{i \in I} (M_i
\otimes
Q)$, this means $y$ maps to $0$ in $M_{j'} \otimes Q$ for some $j' \geq j$.
Thus we may take $P' = M_{j'}$ and $f'$ to be the composite $P \to M_j
\to M_{j'}$.
\end{proof}

\begin{proposition}
\label{proposition-ML-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is Mittag-Leffler.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the
canonical map $M \otimes_R \left( \prod_{\alpha} Q_{\alpha} \right)
\to \prod_{\alpha} (M \otimes_R Q_{\alpha})$ is injective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Suppose $M$ is Mittag-Leffler and let $x$ be
in the kernel of $M \otimes_R (\prod_{\alpha} Q_{\alpha}) \to
\prod_{\alpha} (M \otimes_R Q_{\alpha})$.  Write $M$ as a colimit $M =
\colim_{i \in I} M_i$ of a directed system of finitely presented modules
$M_i$.
 Then $M \otimes_R (\prod_{\alpha} Q_{\alpha})$ is the colimit of $M_i
\otimes_R (\prod_{\alpha} Q_{\alpha})$.  So $x$ is the image of an element
$x_i \in M_i \otimes_R (\prod_{\alpha} Q_{\alpha})$.  We must show that $x_i$
maps to $0$ in $M_j \otimes_R (\prod_{\alpha} Q_{\alpha})$ for some $j \geq
i$.  Since $M$ is Mittag-Leffler, we may choose $j \geq i$ such that $M_i
\to M_j$ and $M_i \to M$ dominate each other.  Then consider
the commutative diagram
$$
\xymatrix{
M \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] & \prod_{\alpha} (M
\otimes_R Q_{\alpha}) \\
M_i \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[d] \ar[u] &
\prod_{\alpha} (M_i \otimes_R Q_{\alpha}) \ar[d] \ar[u] \\
M_j \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} & \prod_{\alpha}
(M_j \otimes_R Q_{\alpha})
}
$$
whose bottom two horizontal maps are isomorphisms, according to Proposition
\ref{proposition-fp-tensor}.  Since $x_i$ maps to $0$ in $\prod_{\alpha} (M
\otimes_R Q_{\alpha})$, its image in $\prod_{\alpha} (M_i \otimes_R
Q_{\alpha})$ is in the kernel of the map $\prod_{\alpha} (M_i \otimes_R
Q_{\alpha}) \to \prod_{\alpha} (M \otimes_R Q_{\alpha})$.  But this
kernel equals the kernel of $\prod_{\alpha} (M_i \otimes_R Q_{\alpha})
\to \prod_{\alpha} (M_j \otimes_R Q_{\alpha})$ according to the
choice of $j$.  Thus $x_i$ maps to $0$ in $\prod_{\alpha} (M_j \otimes_R
Q_{\alpha})$ and hence to $0$ in $M_j \otimes_R (\prod_{\alpha} Q_{\alpha})$.

\medskip\noindent
Now suppose (2) holds. We prove $M$ satisfies formulation (1) of being
Mittag-Leffler from Proposition \ref{proposition-ML-characterization}.  Let $f:
P \to M$ be a map from a finitely presented module $P$ to $M$.  Choose
a set $B$ of representatives of the isomorphism classes of finitely presented
$R$-modules. Let $A$ be the set of pairs $(Q, x)$ where $Q \in B$ and $x \in
\Ker(P \otimes Q \to M \otimes Q)$.  For $\alpha = (Q, x) \in A$, we
write $Q_{\alpha}$ for $Q$ and $x_{\alpha}$ for $x$.  Consider the commutative
diagram
$$
\xymatrix{
M \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] &
\prod_{\alpha} (M \otimes_R Q_{\alpha}) \\
P \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[u] &
\prod_{\alpha} (P \otimes_R Q_{\alpha}) \ar[u] .
}
$$
The top arrow is an injection by assumption, and the bottom arrow is an
isomorphism by Proposition \ref{proposition-fp-tensor}.  Let $x \in P
\otimes_R (\prod_{\alpha} Q_{\alpha})$ be the element corresponding to
$(x_{\alpha}) \in \prod_{\alpha} (P \otimes_R Q_{\alpha})$ under this
isomorphism.  Then $x \in \Ker( P \otimes_R (\prod_{\alpha} Q_{\alpha})
\to M \otimes_R (\prod_{\alpha} Q_{\alpha}))$ since the top arrow in
the diagram is injective.  By Lemma \ref{lemma-kernel-tensored-fp}, we get a
finitely presented module $P'$ and a map $f': P \to P'$ such that $f: P
\to M$ factors through $f'$ and $x \in \Ker(P \otimes_R
(\prod_{\alpha} Q_{\alpha}) \to P' \otimes_R (\prod_{\alpha}
Q_{\alpha}))$.  We have a commutative diagram
$$
\xymatrix{
P' \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} &
\prod_{\alpha} (P' \otimes_R Q_{\alpha}) \\
P \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[u] &
\prod_{\alpha} (P \otimes_R Q_{\alpha}) \ar[u] .
}
$$
where both the top and bottom arrows are isomorphisms by Proposition
\ref{proposition-fp-tensor}.  Thus since $x$ is in the kernel of the left
vertical map, $(x_{\alpha})$ is in the kernel of the right vertical map.  This
means $x_{\alpha} \in \Ker(P \otimes_R Q_{\alpha} \to P' \otimes_R
Q_{\alpha})$ for every $\alpha \in A$.  By the definition of $A$ this means
$\Ker(P \otimes_R Q \to P' \otimes_R Q) \supset \Ker(P \otimes_R
Q \to M \otimes_R Q)$ for all finitely presented $Q$ and, since $f: P
\to M$ factors through $f': P \to P'$, actually equality holds.
 By Lemma \ref{lemma-domination-fp}, $f$ and $f'$ dominate each other.
\end{proof}

\begin{lemma}
\label{lemma-minimal-contains}
Let $M$ be a flat Mittag-Leffler module over $R$. Let $F$ be an $R$-module
and let $x \in F \otimes_R M$. Then there exists a smallest submodule
$F' \subset F$ such that $x \in F' \otimes_R M$.
\end{lemma}

\begin{proof}
Since $M$ is flat we have $F' \otimes_R M \subset F \otimes_R M$
if $F' \subset F$ is a submodule, hence the statement makes sense.
Let $I = \{F' \subset F \mid x \in F' \otimes_R M\}$ and for
$i \in I$ denote $F_i \subset F$ the corresponding submodule.
Then $x$ maps to zero under the map
$$
F \otimes_R M \longrightarrow \prod (F/F_i \otimes_R M)
$$
whence by Proposition \ref{proposition-ML-tensor}
$x$ maps to zero under the map
$$
F \otimes_R M \longrightarrow \left(\prod F/F_i\right) \otimes_R M
$$
Since $M$ is flat the kernel of this arrow is
$(\bigcap F_i) \otimes_R M$ which proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-pure-submodule-ML}
Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a
universally exact sequence of $R$-modules.  Then:
\begin{enumerate}
\item If $M_2$ is Mittag-Leffler, then $M_1$ is Mittag-Leffler.
\item If $M_1$ and $M_3$ are Mittag-Leffler, then $M_2$ is Mittag-Leffler.
\end{enumerate}
\end{lemma}

\begin{proof}
For any family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules we have a
commutative diagram
$$
\xymatrix{
0 \ar[r] & M_1 \otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & M_2
\otimes_R (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & M_3 \otimes_R
(\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & 0 \\
0 \ar[r] & \prod_{\alpha}(M_1 \otimes Q_{\alpha}) \ar[r] & \prod_{\alpha}(M_2
\otimes Q_{\alpha}) \ar[r] & \prod_{\alpha}(M_3 \otimes Q_{\alpha})\ar[r] & 0
}
$$
with exact rows. Thus (1) and (2) follow from
Proposition \ref{proposition-ML-tensor}.
\end{proof}

\begin{lemma}
\label{lemma-colimit-universally-injective-ML}
If $M = \colim M_i$ is the colimit of a directed system of Mittag-Leffler
$R$-modules $M_i$ with universally injective transition maps, then $M$ is
Mittag-Leffler.
\end{lemma}

\begin{proof}
Let $(Q_{\alpha})_{\alpha \in A}$ be a family of $R$-modules. We have to
show that $M \otimes_R (\prod Q_\alpha) \to \prod M \otimes_R Q_\alpha$
is injective and we know that
$M_i \otimes_R (\prod Q_\alpha) \to \prod M_i \otimes_R Q_\alpha$
is injective for each $i$, see Proposition \ref{proposition-ML-tensor}.
Since $\otimes$ commutes with filtered colimits, it suffices to show that
$\prod M_i \otimes_R Q_\alpha \to \prod M \otimes_R Q_\alpha$
is injective. This is clear as each of the maps
$M_i \otimes_R Q_\alpha \to M \otimes_R Q_\alpha$ is injective
by our assumption that the transition maps are universally injective.
\end{proof}

\begin{lemma}
\label{lemma-direct-sum-ML}
If $M = \bigoplus_{i \in I} M_i$ is a direct sum of $R$-modules, then $M$ is
Mittag-Leffler if and only if each $M_i$ is Mittag-Leffler.
\end{lemma}

\begin{proof}
The ``only if'' direction follows from Lemma \ref{lemma-pure-submodule-ML} (1)
and the fact that a split short exact sequence is universally exact. The
converse follows from Lemma \ref{lemma-colimit-universally-injective-ML}
but we can also argue it directly as follows. First note that if $I$ is
finite then this follows from Lemma
\ref{lemma-pure-submodule-ML} (2).  For general $I$, if all $M_i$ are
Mittag-Leffler then we prove the same of $M$ by verifying condition (1) of
Proposition \ref{proposition-ML-characterization}.
Let $f: P \to M$ be a map from a finitely presented module $P$.
Then $f$ factors as
$P \xrightarrow{f'} \bigoplus_{i' \in I'} M_{i'} \hookrightarrow
\bigoplus_{i \in I} M_i$
for some finite subset $I'$ of $I$.  By the finite case
$\bigoplus_{i' \in I'} M_{i'}$ is Mittag-Leffler and hence there exists
a finitely presented  module $Q$ and a map $g: P \to Q$ such that $g$
and $f'$ dominate each other.  Then also $g$ and $f$ dominate each other.
\end{proof}

\begin{lemma}
\label{lemma-flat-ML-over-ML-ring}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
If $S$ is Mittag-Leffler as an $R$-module, and $M$ is flat and Mittag-Leffler
as an $S$-module, then $M$ is Mittag-Leffler as an $R$-module.
\end{lemma}

\begin{proof}
We deduce this from the characterization of
Proposition \ref{proposition-ML-tensor}.
Namely, suppose that $Q_\alpha$ is a family of $R$-modules.
Consider the composition
$$
\xymatrix{
M \otimes_R \prod_\alpha Q_\alpha =
M \otimes_S S \otimes_R \prod_\alpha Q_\alpha \ar[d] \\
M \otimes_S \prod_\alpha (S \otimes_R Q_\alpha) \ar[d] \\
\prod_\alpha (M \otimes_S \otimes_R Q_\alpha) =
\prod_\alpha (M \otimes_R Q_\alpha)
}
$$
The first arrows is injective as $M$ is flat over $S$ and $S$ is
Mittag-Leffler over $R$ and the second arrow is injective as
$M$ is Mittag-Leffler over $S$. Hence $M$ is Mittag-Leffler over $R$.
\end{proof}


\section{Coherent rings}
\label{section-coherent}

\noindent
We use the discussion on interchanging $\prod$ and $\otimes$ to determine
for which rings products of flat modules are flat. It turns out that these
are the so-called coherent rings. You may be more familiar with the notion
of a coherent $\mathcal{O}_X$-module on a ringed space, see
Modules, Section \ref{modules-section-coherent}.

\begin{definition}
\label{definition-coherent}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say $M$ is a {\it coherent module} if it is finitely generated
and every finitely generated submodule of $M$ is finitely presented over
$R$.
\item We say $R$ is a {\it coherent ring} if it is coherent as a module
over itself.
\end{enumerate}
\end{definition}

\noindent
Thus a ring is coherent if and only if every finitely generated ideal is
finitely presented as a module.
The category of coherent modules is abelian.

\begin{lemma}
\label{lemma-coherent}
Let $R$ be a ring.
\begin{enumerate}
\item A finite submodule of a coherent module is coherent.
\item Let $\varphi : N \to M$ be a homomorphism from a finite
module to a coherent module. Then $\Ker(\varphi)$ is finite.
\item Let $\varphi : N \to M$ be a homomorphism of coherent modules.
Then $\Ker(\varphi)$ and $\Coker(\varphi)$ are coherent
modules.
\item Given a short exact sequence of $R$-modules
$0 \to M_1 \to M_2 \to M_3 \to 0$ if two out of three are coherent
so is the third.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement is immediate from the definition.
During the rest of the proof we will use the results of
Lemma \ref{lemma-extension}
without further mention.

\medskip\noindent
Let $\varphi : N \to M$ satisfy the assumptions of (2).
Suppose that $N$ is generated by $x_1, \ldots, x_n$. By
Definition \ref{definition-coherent}
the kernel $K$ of the induced map $\bigoplus_{i = 1}^n R \to M$,
$e_i \mapsto \varphi(x_i)$ is of finite type.
Hence $\Ker(\varphi)$ which is the image of the
composition $K \to \bigoplus_{i = 1}^n R \to N$
is of finite type. This proves (2).

\medskip\noindent
Let $\varphi : N \to M$ satisfy the assumptions of (3).
By (2) the kernel of $\varphi$ is of finite type and
hence by (1) it is coherent.

\medskip\noindent
With the same hypotheses
let us show that $\Coker(\varphi)$ is coherent.
Since $M$ is finite so is $\Coker(\varphi)$.
Let $\overline{x}_i \in \Coker(\varphi)$.
We have to show that the kernel of the associated morphism
$\overline{\Psi} : \bigoplus_{i = 1}^n R \to \Coker(\varphi)$
is finite. Choose $x_i \in M$ lifting $\overline{x}_i$.
Thus $\overline{\Psi}$ lifts to $\Psi : \bigoplus_{i = 1}^n R \to M$.
Consider the following diagram
$$
\xymatrix{
0 \ar[r] &
\Ker(\Psi) \ar[r] \ar[d] &
\bigoplus_{i = 1}^n R \ar[r] \ar@{=}[d] &
M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\Ker(\overline{\Psi}) \ar[r] &
\bigoplus_{i = 1}^n R \ar[r] &
\Coker(\varphi) \ar[r] &
0
}
$$
By the snake lemma we get a short exact sequence
$0 \to \Ker(\Psi) \to \Ker(\overline{\Psi})
\to \Im(\varphi) \to 0$. Hence we see that
$\Ker(\overline{\Psi})$ is finite.

\medskip\noindent
Statement (4) follows from (3).

\medskip\noindent
Let $0 \to M_1 \to M_2 \to M_3 \to 0$
be a short exact sequence of $R$-modules. It suffices
to prove that if $M_1$ and $M_3$ are coherent
so is $M_2$. By
Lemma \ref{lemma-extension}
we see that $M_2$ is finite. Let $x_1, \ldots, x_n$ be finitely many
elements of $M_2$.
We have to show that the module of relations $K$
between them is finite.
Consider the following commutative diagram
$$
\xymatrix{
0 \ar[r] &
0 \ar[r] \ar[d] &
\bigoplus_{i = 1}^{n} R \ar[r] \ar[d] &
\bigoplus_{i = 1}^{n} R \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] &
M_2 \ar[r] &
M_3 \ar[r] &
0
}
$$
with obvious notation. By the snake lemma we get an exact sequence
$0 \to K \to K_3 \to M_1$
where $K_3$ is the module of relations among
the images of the $x_i$ in $M_3$.
Since $M_3$ is coherent we see that
$K_3$ is a finite module. Since $M_1$
is coherent we see that the image $I$
of $K_3 \to M_1$
is coherent. Hence $K$
is the kernel of the map $K_3 \to I$
between a finite module and a coherent module and hence
finite by (2).
\end{proof}

\begin{lemma}
\label{lemma-coherent-ring}
Let $R$ be a ring. If $R$ is coherent, then a module is coherent
if and only if it is finitely presented.
\end{lemma}

\begin{proof}
It is clear that a coherent module is finitely presented (over any ring).
Conversely, if $R$ is coherent, then $R^{\oplus n}$ is coherent and so is
the cokernel of any map $R^{\oplus m} \to R^{\oplus n}$, see
Lemma \ref{lemma-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-coherent}
A Noetherian ring is a coherent ring.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}
any finite $R$-module is finitely presented. In particular any ideal of $R$
is finitely presented.
\end{proof}

\begin{proposition}
\label{proposition-characterize-coherent}
\begin{reference}
This is \cite[Theorem 2.1]{Chase}.
\end{reference}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ is coherent,
\item any product of flat $R$-modules is flat, and
\item for every set $A$ the module $R^A$ is flat.
\end{enumerate}
\end{proposition}

\begin{proof}
Assume $R$ coherent, and let $Q_\alpha$, $\alpha \in A$ be a set of flat
$R$-modules. We have to show that
$I \otimes_R \prod_\alpha Q_\alpha \to \prod Q_\alpha$ is injective
for every finitely generated ideal $I$ of $R$, see
Lemma \ref{lemma-flat}.
Since $R$ is coherent $I$ is an $R$-module of finite presentation.
Hence $I \otimes_R \prod_\alpha Q_\alpha = \prod I \otimes_R Q_\alpha$ by
Proposition \ref{proposition-fp-tensor}.
The desired injectivity follows as $I \otimes_R Q_\alpha \to Q_\alpha$
is injective by flatness of $Q_\alpha$.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is trivial.

\medskip\noindent
Assume that the $R$-module $R^A$ is flat for every set $A$. Let $I$
be a finitely generated ideal in $R$. Then $I \otimes_R R^A \to R^A$
is injective by assumption. By
Proposition \ref{proposition-fg-tensor}
and the finiteness of $I$ the image is equal to $I^A$. Hence
$I \otimes_R R^A = I^A$ for every set $A$ and we conclude that $I$
is finitely presented by
Proposition \ref{proposition-fp-tensor}.
\end{proof}







\section{Examples and non-examples of Mittag-Leffler modules}
\label{section-examples}

\noindent
We end this section with some examples and non-examples of Mittag-Leffler
modules.

\begin{example}
\label{example-ML}
Mittag-Leffler modules.
\begin{enumerate}
\item Any finitely presented module is Mittag-Leffler.  This follows, for
instance, from Proposition \ref{proposition-ML-characterization} (1).  In
general, it is true that a finitely generated module is Mittag-Leffler if and
only it is finitely presented.  This follows from Propositions
\ref{proposition-fg-tensor}, \ref{proposition-fp-tensor}, and
\ref{proposition-ML-tensor}.
\item A free module is Mittag-Leffler since it satisfies condition (1) of
Proposition \ref{proposition-ML-characterization}.
\item By the previous example together with Lemma \ref{lemma-direct-sum-ML},
projective modules are Mittag-Leffler.
\end{enumerate}
\end{example}

\noindent
We also want to add to our list of examples power series rings over a
Noetherian ring $R$.  This will be a consequence the following lemma.

\begin{lemma}
\label{lemma-flat-ML-criterion}
Let $M$ be a flat $R$-module. The following are equivalent
\begin{enumerate}
\item $M$ is Mittag-Leffler, and
\item if $F$ is a finite free $R$-module and
$x \in F \otimes_R M$, then there exists a smallest submodule $F'$ of $F$
such that $x \in F' \otimes_R M$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is a special case of
Lemma \ref{lemma-minimal-contains}. Assume (2).
By Theorem \ref{theorem-lazard} we can write $M$ as the colimit
$M = \colim_{i \in I} M_i$ of a directed system $(M_i, f_{ij})$ of
finite free $R$-modules.
By Remark \ref{remark-flat-ML}, it suffices to show that the inverse system
$(\Hom_R(M_i, R), \Hom_R(f_{ij}, R))$ is Mittag-Leffler.  In
other words,
fix $i \in I$ and for $j \geq i$ let $Q_j$ be the image of
$\Hom_R(M_j, R)
\to \Hom_R(M_i, R)$; we must show that the $Q_j$ stabilize.

\medskip\noindent
Since $M_i$ is free and finite, we can make the identification
$\Hom_R(M_i, M_j) = \Hom_R(M_i, R) \otimes_R  M_j$ for all $j$.
 Using the
fact that the $M_j$ are free, it follows that for $j \geq i$, $Q_j$ is the
smallest submodule of $\Hom_R(M_i, R)$ such that $f_{ij} \in Q_j
\otimes_R
M_j$.  Under the identification $\Hom_R(M_i, M) = \Hom_R(M_i, R)
\otimes_R
M$, the canonical map $f_i: M_i \to M$ is in $\Hom_R(M_i, R)
\otimes_R M$.  By the assumption on $M$, there exists a smallest submodule
$Q$ of $\Hom_R(M_i, R)$ such that $f_i \in Q \otimes_R M$.  We are
going to
show that the $Q_j$ stabilize to $Q$.

\medskip\noindent
For $j \geq i$ we have a commutative diagram
$$
\xymatrix{
Q_j \otimes_R M_j \ar[r] \ar[d] & \Hom_R(M_i, R) \otimes_R M_j
\ar[d] \\
Q_j \otimes_R M \ar[r] & \Hom_R(M_i, R) \otimes_R M.
}
$$
Since $f_{ij} \in Q_j \otimes_R M_j$ maps to $f_i \in \Hom_R(M_i, R)
\otimes_R M$, it follows that $f_i \in Q_j \otimes_R M$.  Hence, by the
choice of $Q$, we have $Q \subset Q_j$ for all $j \geq i$.

\medskip\noindent
Since the $Q_j$ are decreasing and $Q \subset Q_j$ for all $j \geq i$, to show
that the $Q_j$ stabilize to $Q$ it suffices to find a $j \geq i$ such that $Q_j
\subset Q$.  As an element of
$$
\Hom_R(M_i, R) \otimes_R M = \colim_{j \in J}
(\Hom_R(M_i, R) \otimes_R
M_j),
$$
$f_i$ is the colimit of $f_{ij}$ for $j \geq i$, and $f_i$ also lies in the
submodule
$$
\colim_{j \in J} (Q \otimes_R M_j) \subset \colim_{j \in J}
(\Hom_R(M_i, R)
\otimes_R M_j).
$$
It follows that for some $j \geq i$, $f_{ij}$ lies in $Q \otimes_R M_j$.
Since $Q_j$ is the smallest submodule of $\Hom_R(M_i, R)$ with $f_{ij}
\in
Q_j \otimes_R M_j$, we conclude $Q_j\subset Q$.
\end{proof}

\begin{lemma}
\label{lemma-product-over-Noetherian-ring}
Let $R$ be a Noetherian ring and $A$ a set.
Then $M = R^A$ is a flat and Mittag-Leffler $R$-module.
\end{lemma}

\begin{proof}
Combining
Lemma \ref{lemma-Noetherian-coherent}
and
Proposition \ref{proposition-characterize-coherent}
we see that $M$ is flat over $R$. We show that $M$ satisfies the condition of
Lemma \ref{lemma-flat-ML-criterion}.
Let $F$ be a free finite $R$-module. If $F'$ is any submodule of $F$ then it
is finitely presented since $R$ is Noetherian. So by
Proposition \ref{proposition-fp-tensor}
we have a commutative diagram
$$
\xymatrix{
F' \otimes_R M \ar[r] \ar[d]^{\cong} & F \otimes_R M \ar[d]^{\cong} \\
(F')^A \ar[r] & F^A
}
$$
by which we can identify the map $F' \otimes_R M \to F \otimes_R M$
with $(F')^A \to F^A$.  Hence if $x \in F \otimes_R M$ corresponds to
$(x_\alpha) \in F^A$, then the submodule of $F'$ of $F$ generated by the
$x_\alpha$ is the smallest submodule of $F$ such that $x \in F' \otimes_R M$.
\end{proof}

\begin{lemma}
\label{lemma-power-series-ML}
Let $R$ be a Noetherian ring and $n$ a positive integer.  Then the $R$-module
$M = R[[t_1, \ldots, t_n]]$ is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
As an $R$-module, we have $M = R^A$ for a (countable) set $A$.
Hence this lemma is a special case of
Lemma \ref{lemma-product-over-Noetherian-ring}.
\end{proof}

\begin{example}
\label{example-not-ML}
Non Mittag-Leffler modules.
\begin{enumerate}
\item By Example \ref{example-Q-not-ML} and
Proposition \ref{proposition-ML-tensor}, $\mathbf{Q}$ is not a Mittag-Leffler
$\mathbf{Z}$-module.
\item We prove below (Theorem \ref{theorem-projectivity-characterization}) that
for a flat and countably generated module, projectivity is equivalent to being
Mittag-Leffler.  Thus any flat, countably generated, non-projective module $M$
is an example of a non-Mittag-Leffler module.  For such an example, see
Remark \ref{remark-warning}.
\item Let $k$ be a field. Let $R = k[[x]]$. The $R$-module
$M = \prod_{n \in \mathbf{N}} R/(x^n)$ is not Mittag-Leffler.
Namely, consider the element $\xi = (\xi_1, \xi_2, \xi_3, \ldots)$
defined by $\xi_{2^m} = x^{2^{m - 1}}$ and $\xi_n = 0$ else, so
$$
\xi = (0, x, 0, x^2, 0, 0, 0, x^4, 0, 0, 0, 0, 0, 0, 0, x^8, \ldots)
$$
Then the annihilator of $\xi$ in $M/x^{2^m}M$ is generated $x^{2^{m - 1}}$
for $m \gg 0$. But if $M$ was Mittag-Leffler, then there would exist a finite
$R$-module $Q$ and an element $\xi' \in Q$ such that the annihilator
of $\xi'$ in $Q/x^l Q$ agrees with the annihilator of $\xi$ in $M/x^l M$
for all $l \geq 1$, see
Proposition \ref{proposition-ML-characterization} (1).
Now you can prove there exists an integer $a \geq 0$ such that
the annihilator of $\xi'$ in $Q/x^l Q$ is generated
by either $x^a$ or $x^{l - a}$ for all $l \gg 0$ (depending on
whether $\xi' \in Q$ is torsion or not). The combination of the above
would give for all $l = 2^m >> 0$ the equality $a = l/2$ or $l - a = l/2$
which is nonsensical.
\item The same argument shows that $(x)$-adic completion of
$\bigoplus_{n \in \mathbf{N}} R/(x^n)$ is not Mittag-Leffler over
$R = k[[x]]$ (hint: $\xi$ is actually an element of this completion).
\item Let $R = k[a, b]/(a^2, ab, b^2)$. Let $S$ be the finitely presented
$R$-algebra with presentation $S = R[t]/(at - b)$. Then as an $R$-module
$S$ is countably generated and indecomposable (details omitted).
On the other hand, $R$ is Artinian local, hence complete local,
hence a henselian local ring, see
Lemma \ref{lemma-complete-henselian}.
If $S$ was Mittag-Leffler as an $R$-module, then it would be a
direct sum of finite $R$-modules by
Lemma \ref{lemma-split-ML-henselian}.
Thus we conclude that $S$ is not Mittag-Leffler as an $R$-module.
\end{enumerate}
\end{example}




\section{Countably generated Mittag-Leffler modules}
\label{section-ML-countable}

\noindent
It turns out that countably generated Mittag-Leffler modules have a
particularly simple structure.

\begin{lemma}
\label{lemma-ML-countable-colimit}
Let $M$ be an $R$-module.  Write $M = \colim_{i \in I} M_i$ where $(M_i,
f_{ij})$ is a directed system of finitely presented $R$-modules.  If $M$ is
Mittag-Leffler and countably generated, then there is a directed countable
subset $I' \subset I$ such that $M \cong \colim_{i \in I'} M_i$.
\end{lemma}

\begin{proof}
Let $x_1, x_2, \ldots$ be a countable set of generators for $M$.  For each $x_n$
choose $i \in I$ such that $x_n$ is in the image of the canonical map $f_i:
M_i \to M$; let $I'_{0} \subset I$ be the set of all these $i$.  Now
since $M$ is Mittag-Leffler, for each $i \in I'_{0}$ we can choose $j \in I$
such that $j \geq i$ and $f_{ij}: M_i \to M_j$ factors through
$f_{ik}: M_i \to M_k$ for all $k \geq i$  (condition (3) of Proposition
\ref{proposition-ML-characterization}); let $I'_1$ be the union of $I'_0$ with
all of these $j$.  Since $I'_1$ is a countable, we can enlarge it to a
countable directed set $I'_{2} \subset I$.  Now we can apply the same procedure
to $I'_{2}$ as we did to $I'_{0}$ to get a new countable set $I'_{3} \subset
I$.  Then we enlarge $I'_{3}$ to a countable directed set $I'_{4}$.  Continuing
in this way---adding in a $j$ as in Proposition
\ref{proposition-ML-characterization} (3) for each $ i \in I'_{\ell}$ if $\ell$
is odd and enlarging $I'_{\ell}$ to a directed set if $\ell$ is even---we get a
sequence of subsets $I'_{\ell} \subset I$ for $\ell \geq 0$.  The union $I' =
\bigcup I'_{\ell}$ satisfies:
\begin{enumerate}
\item $I'$ is countable and directed;
\item each $x_n$ is in the image of $f_i: M_i \to M$ for some $i
\in I'$;
\item if $i \in I'$, then there is $j \in I'$ such that $j \geq i$ and $f_{ij}:
M_i \to M_j$ factors through $f_{ik}: M_i \to M_k$ for all
$k \in I$ with $k \geq i$.  In particular $\Ker(f_{ik}) \subset \Ker(f_{ij})$
for $k \geq i$.
\end{enumerate}
We claim that the canonical map $\colim_{i \in I'} M_i \to
\colim_{i
\in I} M_i = M$ is an isomorphism.  By (2) it is surjective.  For injectivity,
suppose $x \in \colim_{i \in I'} M_i$ maps to $0$ in $\colim_{i \in
I} M_i$.
Representing $x$ by an element $\tilde{x} \in M_i$ for some $i \in I'$, this
means that $f_{ik}(\tilde{x}) = 0$ for some $k \in I, k \geq i$.  But then by
(3) there is $j \in I', j \geq i,$ such that $f_{ij}(\tilde{x}) = 0$.  Hence $x
= 0$ in $\colim_{i \in I'} M_i$.
\end{proof}

\noindent
Lemma \ref{lemma-ML-countable-colimit}
implies that a countably generated Mittag-Leffler module $M$ over
$R$ is the colimit of a system
$$
M_1 \to M_2 \to M_3 \to M_4 \to \ldots
$$
with each $M_n$ a finitely presented $R$-module. To see this argue as in the
proof of
Lemma \ref{lemma-ML-limit-nonempty}
to see that a countable directed set has a cofinal
subset isomorphic to $(\mathbf{N}, \geq)$. Suppose
$R = k[x_1, x_2, x_3, \ldots]$ and $M = R/(x_i)$. Then $M$ is finitely
generated but not finitely presented, hence not Mittag-Leffler (see
Example \ref{example-ML} part (1)).
But of course you can write $M = \colim_n M_n$ by taking
$M_n = R/(x_1, \ldots, x_n)$, hence the condition that you can write
$M$ as such a limit does not imply that $M$ is Mittag-Leffler.

\begin{lemma}
\label{lemma-ML-countable}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Assume $M$ is Mittag-Leffler and countably generated.
For any $R$-module map $f : P \to M$ with $P$ finitely generated there
exists an endomorphism $\alpha : M \to M$ such that
\begin{enumerate}
\item $\alpha : M \to M$ factors through a finitely presented $R$-module, and
\item $\alpha \circ f = f$.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $M = \colim_{i \in I} M_i$ as a directed colimit of finitely
presented $R$-modules with $I$ countable, see
Lemma \ref{lemma-ML-countable-colimit}.
The transition maps are denoted $f_{ij}$ and we use $f_i : M_i \to M$
to denote the canonical maps into $M$. Set $N = \prod_{s \in I} M_s$. Denote
$$
M_i^* = \Hom_R(M_i, N) = \prod\nolimits_{s \in I} \Hom_R(M_i, M_s)
$$
so that $(M_i^*)$ is an inverse system of $R$-modules over $I$.
Note that $\Hom_R(M, N) = \lim M_i^*$.
As $M$ is Mittag-Leffler, we find for every
$i \in I$ an index $k(i) \geq i$ such that
$$
E_i := \bigcap\nolimits_{i' \geq i} \Im(M_{i'}^* \to M_i^*)
=
\Im(M_{k(i)}^* \to M_i^*)
$$
Choose and fix $j \in I$ such that $\Im(P \to M) \subset \Im(M_j \to M)$.
This is possible as $P$ is finitely generated. Set $k = k(j)$.
Let
$x = (0, \ldots, 0, \text{id}_{M_k}, 0, \ldots, 0) \in M_k^*$ and
note that this maps to $y = (0, \ldots, 0, f_{jk}, 0, \ldots, 0) \in M_j^*$.
By our choice of $k$ we see that $y \in E_j$. By
Example \ref{example-ML-surjective-maps}
the transition maps $E_i \to E_j$ are surjective for each $i \geq j$
and $\lim E_i = \lim M_i^* = \Hom_R(M, N)$. Hence
Lemma \ref{lemma-ML-limit-nonempty}
guarantees there exists an element $z \in \Hom_R(M, N)$
which maps to $y$ in $E_j \subset M_j^*$. Let $z_k$ be the $k$th component
of $z$. Then $z_k : M \to M_k$ is a homomorphism such that
$$
\xymatrix{
M \ar[r]_{z_k} & M_k \\
M_j \ar[ru]_{f_{jk}} \ar[u]^{f_j}
}
$$
commutes. Let $\alpha : M \to M$ be the composition
$f_k \circ z_k : M \to M_k \to M$.
Then $\alpha$ factors through a finitely presented module by construction and
$\alpha \circ f_j = f_j$. Since the image of $f$ is contained in the image of
$f_j$ this also implies that $\alpha \circ f = f$.
\end{proof}

\noindent
We will see later (see
Lemma \ref{lemma-split-ML-henselian})
that
Lemma \ref{lemma-ML-countable}
means that a countably generated Mittag-Leffler module over a henselian local
ring is a direct sum of finitely presented modules.




\section{Characterizing projective modules}
\label{section-characterize-projective}

\noindent
The goal of this section is to prove that a module is projective if and only if
it is flat, Mittag-Leffler, and a direct sum of countably generated modules
(Theorem \ref{theorem-projectivity-characterization} below).

\begin{lemma}
\label{lemma-countgen-projective}
Let $M$ be an $R$-module.  If $M$ is flat, Mittag-Leffler, and countably
generated, then $M$ is projective.
\end{lemma}

\begin{proof}
By Lazard's theorem (Theorem \ref{theorem-lazard}), we can write $M =
\colim_{i
\in I} M_i$ for a directed system of finite free $R$-modules $(M_i, f_{ij})$
indexed by a set $I$.  By Lemma \ref{lemma-ML-countable-colimit}, we may assume
$I$ is countable.  Now let
$$
0 \to N_1 \to N_2 \to N_3 \to 0
$$
be an exact sequence of $R$-modules.  We must show that applying
$\Hom_R(M, -)$
preserves exactness.  Since $M_i$ is finite free,
$$
0 \to \Hom_R(M_i, N_1) \to \Hom_R(M_i, N_2) \to
\Hom_R(M_i, N_3) \to 0
$$
is exact for each $i$.  Since $M$ is Mittag-Leffler, $(\Hom_R(M_i,
N_{1}))$ is
a Mittag-Leffler inverse system.  So by Lemma \ref{lemma-ML-exact-sequence},
$$
0 \to \lim_{i \in I} \Hom_R(M_i, N_1) \to
\lim_{i \in I} \Hom_R(M_i, N_2) \to
\lim_{i \in I} \Hom_R(M_i, N_3) \to 0
$$
is exact.  But for any $R$-module $N$ there is a functorial isomorphism
$\Hom_R(M, N) \cong \lim_{i \in I} \Hom_R(M_i, N)$, so
$$
0 \to \Hom_R(M, N_1) \to \Hom_R(M, N_2) \to
\Hom_R(M, N_3) \to 0
$$
is exact.
\end{proof}

\begin{remark}
\label{remark-characterize-projective}
Lemma \ref{lemma-countgen-projective} does not hold without the countable
generation assumption.  For example, the $\mathbf Z$-module $M =
\mathbf{Z}[[x]]$ is flat and Mittag-Leffler but not projective.  It is
Mittag-Leffler by Lemma \ref{lemma-power-series-ML}.  Subgroups of free abelian
groups are free, hence a projective $\mathbf Z$-module is in fact free and so
are its submodules.  Thus to show $M$ is not projective it suffices to produce
a non-free submodule.  Fix a prime $p$ and consider the submodule $N$
consisting of power series $f(x) = \sum a_i x^i$ such that for every integer $m
\geq 1$, $p^m$ divides $a_i$ for all but finitely many $i$.  Then $\sum a_i p^i
x^i$ is in $N$ for all $a_i \in \mathbf{Z}$, so $N$ is uncountable.  Thus if
$N$ were free it would have uncountable rank and the dimension of $N/pN$ over
$\mathbf{Z}/p$ would be uncountable.  This is not true as the elements $x^i \in
N/pN$ for $i \geq 0$ span $N/pN$.
\end{remark}

\begin{theorem}
\label{theorem-projectivity-characterization}
Let $M$ be an $R$-module.  Then $M$ is projective if and only it satisfies:
\begin{enumerate}
\item $M$ is flat,
\item $M$ is Mittag-Leffler,
\item $M$ is a direct sum of countably generated $R$-modules.
\end{enumerate}
\end{theorem}

\begin{proof}
First suppose $M$ is projective.  Then $M$ is a direct summand of a free
module, so $M$ is flat and Mittag-Leffler since these properties pass to direct
summands. By Kaplansky's theorem (Theorem \ref{theorem-projective-direct-sum}),
$M$ satisfies (3).

\medskip\noindent
Conversely, suppose $M$ satisfies (1)-(3).  Since being flat and Mittag-Leffler
passes to direct summands, $M$ is a direct sum of flat, Mittag-Leffler,
countably generated $R$-modules.
Lemma \ref{lemma-countgen-projective}
implies $M$ is a direct sum of projective modules. Hence $M$ is projective.
\end{proof}

\begin{lemma}
\label{lemma-ML-ui-descent}
Let $f: M \to N$ be universally injective map of $R$-modules.  Suppose
$M$ is a direct sum of countably generated $R$-modules, and suppose $N$ is flat
and Mittag-Leffler.  Then $M$ is projective.
\end{lemma}

\begin{proof}
By
Lemmas \ref{lemma-ui-flat-domain} and
\ref{lemma-pure-submodule-ML},
$M$ is flat and Mittag-Leffler, so the conclusion follows from Theorem
\ref{theorem-projectivity-characterization}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-submodule-powerseries}
Let $R$ be a Noetherian ring and let $M$ be a $R$-module.  Suppose $M$ is a
direct sum of countably generated $R$-modules, and suppose there is a
universally injective map $M \to R[[t_1, \ldots, t_n]]$ for some $n$.
Then $M$ is projective.
\end{lemma}

\begin{proof}
Follows from
Lemmas \ref{lemma-ML-ui-descent} and
\ref{lemma-power-series-ML}.
\end{proof}



\section{Ascending properties of modules}
\label{section-ascent}

\noindent
All of the properties of a module in Theorem
\ref{theorem-projectivity-characterization} ascend along arbitrary ring maps:

\begin{lemma}
\label{lemma-ascend-properties-modules}
Let $R \to S$ be a ring map.  Let $M$ be an $R$-module.  Then:
\begin{enumerate}
\item If $M$ is flat, then the $S$-module $M \otimes_R S$ is flat.
\item If $M$ is Mittag-Leffler, then the $S$-module $M \otimes_R S$ is
Mittag-Leffler.
\item If $M$ is a direct sum of countably generated $R$-modules, then the
$S$-module $M \otimes_R S$ is a direct sum of countably generated $S$-modules.
\item If $M$ is projective, then the $S$-module $M \otimes_R S$ is projective.
\end{enumerate}
\end{lemma}

\begin{proof}
All are obvious except (2).  For this, use formulation (3) of being
Mittag-Leffler from Proposition \ref{proposition-ML-characterization} and the
fact that tensoring commutes with taking colimits.
\end{proof}



\section{Descending properties of modules}
\label{section-descent}

\noindent
We address the faithfully flat descent of the properties from Theorem
\ref{theorem-projectivity-characterization} that characterize projectivity.
In the presence of flatness, the property of being a Mittag-Leffler module
descends:

\begin{lemma}
\label{lemma-ffdescent-ML}
\begin{reference}
Email from Juan Pablo Acosta Lopez dated 12/20/14.
\end{reference}
Let $R \to S$ be a faithfully flat ring map. Let $M$ be an $R$-module. If the
$S$-module $M \otimes_R S$ is Mittag-Leffler, then $M$ is Mittag-Leffler.
\end{lemma}

\begin{proof}
Write $M=\text{colim}_{i\in I} M_i$ as a directed colimit
of finitely presented $R$-modules $M_i$.
Using Proposition \ref{proposition-ML-characterization}, we see that we
have to prove that for each $i \in I$ there exists $i \leq j$, $j\in I$
such that $M_i\rightarrow M_j$ dominates $M_i\rightarrow M$.

\medskip\noindent
Take $N$ the pushout
$$
\xymatrix{
M_i  \ar[r] \ar[d] & M_j \ar[d] \\
M \ar[r] & N
}
$$
Then the lemma is equivalent to the existence of $j$ such that
$M_j\rightarrow N$ is universally injective, see
Lemma \ref{lemma-domination-universally-injective}.
Observe that the tensorization by $S$
$$
\xymatrix{
M_i\otimes_R S  \ar[r] \ar[d] & M_j\otimes_R S \ar[d] \\
M\otimes_R S \ar[r] & N\otimes_R S
}
$$
Is a pushout diagram.  So because
$M \otimes_R S = \text{colim}_{i\in I} M_i \otimes_R S$
expresses $M\otimes_R S$ as a colimit of $S$-modules of
finite presentation, and $M\otimes_R S$ is Mittag-Leffler,
there exists $j \geq i$ such that $M_j\otimes_R S\rightarrow N\otimes_R S$
is universally injective. So using that $R\rightarrow S$ is faithfully flat
we conclude that $M_j\rightarrow N$ is universally injective too.
\end{proof}

\noindent
At this point the faithfully flat descent of countably generated projective
modules follows easily.

\begin{lemma}
\label{lemma-ffdescent-countable-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module.
 If the $S$-module $M \otimes_R S$ is countably generated and projective,
then $M$ is countably generated and projective.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-descend-properties-modules},
Lemma \ref{lemma-ffdescent-ML}, the fact that countable
generation descends, and
Theorem \ref{theorem-projectivity-characterization}.
\end{proof}

\noindent
All that remains is to use d\'evissage to reduce descent of projectivity in the
general case to the countably generated case.  First, two simple lemmas.

\begin{lemma}
\label{lemma-lift-countably-generated-submodule}
Let $R \to S$ be a ring map, let $M$ be an $R$-module, and let $Q$ be a
countably generated $S$-submodule of $M \otimes_R S$.  Then there exists a
countably generated $R$-submodule $P$ of $M$ such that
$\Im(P \otimes_R S \to M \otimes_R S)$ contains $Q$.
\end{lemma}

\begin{proof}
Let $y_1, y_2, \ldots$ be generators for $Q$ and write $y_j = \sum_k x_{jk}
\otimes s_{jk}$ for some $x_{jk} \in M$ and $s_{jk} \in S$. Then take $P$ be
the submodule of $M$ generated by the $x_{jk}$.
\end{proof}

\begin{lemma}
\label{lemma-adapted-submodule}
Let $R \to S$ be a ring map, and let $M$ be an $R$-module.  Suppose $M
\otimes_R S = \bigoplus_{i \in I} Q_i$ is a direct sum of countably generated
$S$-modules $Q_i$.  If $N$ is a countably generated submodule of $M$, then
there is a countably generated submodule $N'$ of $M$ such that $N' \supset N$
and $\Im(N' \otimes_R S \to M \otimes_R S) =
\bigoplus_{i \in I'} Q_i$ for some subset $I' \subset I$.
\end{lemma}

\begin{proof}
Let $N'_0 = N$.  We construct by induction an increasing sequence of countably
generated submodules $N'_{\ell} \subset M$ for $\ell = 0, 1, 2, \ldots$
such that: if $I'_{\ell}$ is the set of $i \in I$ such that the projection of
$\Im(N'_{\ell} \otimes_R S \to M \otimes_R S)$ onto $Q_i$ is
nonzero, then $\Im(N'_{\ell + 1} \otimes_R S \to M \otimes_R
S)$ contains $Q_i$ for all $i \in I'_{\ell}$.  To construct $N'_{\ell + 1}$
from $N'_\ell$, let $Q$ be the sum of (the countably many) $Q_i$ for
$i \in I'_{\ell}$, choose $P$ as in Lemma
\ref{lemma-lift-countably-generated-submodule}, and then let $N'_{\ell + 1} =
N'_{\ell} + P$.  Having constructed the $N'_{\ell}$, just take $N' =
\bigcup_{\ell} N'_{\ell}$ and $I' = \bigcup_{\ell} I'_{\ell}$.
\end{proof}

\begin{theorem}
\label{theorem-ffdescent-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module.
 If the $S$-module $M \otimes_R S$ is projective, then $M$ is projective.
\end{theorem}

\begin{proof}
We are going to construct a Kaplansky d\'evissage of $M$ to show that it is a
direct sum of projective modules and hence projective.  By Theorem
\ref{theorem-projective-direct-sum} we can write $M \otimes_R S =
\bigoplus_{i \in I} Q_i$ as a direct sum of countably generated $S$-modules
$Q_i$.  Choose a well-ordering on $M$.  By transfinite induction we are going
to define an increasing family of submodules $M_{\alpha}$ of $M$, one for each
ordinal $\alpha$, such that $M_{\alpha} \otimes_R S$ is a direct sum of some
subset of the $Q_i$.

\medskip\noindent
For $\alpha = 0$ let $M_0 = 0$.  If $\alpha$ is a limit ordinal and $M_{\beta}$
has been defined for all $\beta < \alpha$, then define $M_{\beta} =
\bigcup_{\beta < \alpha} M_{\beta}$.  Since each $M_{\beta} \otimes_R S$ for
$\beta < \alpha$ is a direct sum of a subset of the $Q_i$, the same will be
true of $M_{\alpha} \otimes_R S$.  If $\alpha + 1$ is a successor ordinal and
$M_{\alpha}$ has been defined, then define $M_{\alpha + 1}$ as follows.  If
$M_{\alpha} = M$, then let $M_{\alpha +1} = M$.  Otherwise choose the smallest
$x \in M$ (with respect to the fixed well-ordering) such that $x \notin
M_{\alpha}$. Since $S$ is flat over $R$, $(M/M_{\alpha}) \otimes_R S = M
\otimes_R S/M_{\alpha} \otimes_R S$, so since $M_{\alpha} \otimes_R S$ is
a direct sum of some $Q_i$, the same is true of $(M/M_{\alpha}) \otimes_R
S$.   By Lemma \ref{lemma-adapted-submodule}, we can find a countably generated
$R$-submodule $P$ of $M/M_{\alpha}$ containing the image of $x$ in
$M/M_{\alpha}$ and such that $P \otimes_R S$ (which equals $\Im(P
\otimes_R S \to M \otimes_R S)$ since $S$ is flat over $R$) is a
direct sum of some $Q_i$. Since $M \otimes_R S = \bigoplus_{i \in I} Q_i$
is projective and projectivity passes to direct summands, $P \otimes_R S$ is
also projective.  Thus by Lemma \ref{lemma-ffdescent-countable-projectivity},
$P$ is projective.  Finally we define $M_{\alpha + 1}$ to be the preimage of $P$
in $M$, so that $M_{\alpha + 1}/M_{\alpha} = P$ is countably generated and
projective.  In particular $M_{\alpha}$ is a direct summand of $M_{\alpha + 1}$
since projectivity of $M_{\alpha + 1}/M_{\alpha}$ implies the sequence $0
\to M_{\alpha} \to M_{\alpha + 1} \to
M_{\alpha + 1}/M_{\alpha} \to 0$ splits.

\medskip\noindent
Transfinite induction on $M$ (using the fact that we constructed
$M_{\alpha + 1}$ to contain the smallest $x \in M$ not contained in
$M_{\alpha}$) shows that
each $x \in M$ is contained in some $M_{\alpha}$.  Thus, there is some large
enough ordinal $S$ satisfying: for each $x \in M$ there is $\alpha \in S$ such
that $x \in M_{\alpha}$.  This means $(M_{\alpha})_{\alpha \in S}$ satisfies
property (1) of a Kaplansky d\'evissage of $M$.  The other properties are clear
by construction.  We conclude
$M = \bigoplus_{\alpha + 1 \in S} M_{\alpha + 1}/M_{\alpha}$.
Since each $M_{\alpha + 1}/M_{\alpha}$ is projective
by construction, $M$ is projective.
\end{proof}












\section{Completion}
\label{section-completion}

\noindent
Suppose that $R$ is a ring and $I$ is an ideal.
We define the {\it completion of $R$ with respect to $I$}
to be the limit
$$
R^\wedge = \lim_n R/I^n.
$$
An element of $R^\wedge$ is given by a sequence
of elements $f_n \in R/I^n$ such that $f_n \equiv f_{n + 1} \bmod I^n$
for all $n$. We will view $R^\wedge$ as an $R$-algebra.
Similarly, if $M$ is an $R$-module then we define the
{\it completion of $M$ with respect to $I$}
to be the limit
$$
M^\wedge = \lim_n M/I^nM.
$$
An element of $M^\wedge$ is given by a sequence of
elements $m_n \in M/I^nM$ such that $m_n \equiv m_{n + 1} \bmod I^nM$
for all $n$. We will view $M^\wedge$ as an $R^\wedge$-module.
From this description it is clear that there
are always canonical maps
$$
M \longrightarrow M^\wedge
\quad\text{and}\quad
M \otimes_R R^\wedge \longrightarrow M^\wedge.
$$
Moreover, given a map $\varphi : M \to N$ of modules we get an induced
map $\varphi^\wedge : M^\wedge \to N^\wedge$ on completions making the
diagram
$$
\xymatrix{
M \ar[r] \ar[d] & N \ar[d] \\
M^\wedge \ar[r] & N^\wedge
}
$$
commute. In general completion is not an exact functor, see
Examples, Section \ref{examples-section-completion-not-exact}.
Here are some initial positive results.

\begin{lemma}
\label{lemma-completion-generalities}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $\varphi : M \to N$ be a map of $R$-modules.
\begin{enumerate}
\item If $M/IM \to N/IN$ is surjective, then $M^\wedge \to N^\wedge$
is surjective.
\item If $M \to N$ is surjective, then $M^\wedge \to N^\wedge$ is surjective.
\item If $0 \to K \to M \to N \to 0$ is a short exact sequence of
$R$-modules and $N$ is flat, then
$0 \to K^\wedge \to M^\wedge \to N^\wedge \to 0$ is a short exact sequence.
\item The map $M \otimes_R R^\wedge \to M^\wedge$ is
surjective for any finite $R$-module $M$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M/IM \to N/IN$ is surjective. Then the map $M/I^nM \to N/I^nN$
is surjective for each $n \geq 1$ by Nakayama's lemma. More precisely,
apply Lemma \ref{lemma-NAK} part (11) to the
map $M/I^nM \to N/I^nN$ over the ring $R/I^n$ and the nilpotent
ideal $I/I^n$ to see this. Set $K_n = \{x \in M \mid \varphi(x) \in I^nN\}$.
Thus we get short exact sequences
$$
0 \to K_n/I^nM \to M/I^nM \to N/I^nN \to 0
$$
We claim that the canonical map $K_{n + 1}/I^{n + 1}M \to K_n/I^nM$
is surjective. Namely, if $x \in K_n$ write
$\varphi(x) = \sum z_j n_j$ with $z_j \in I^n$, $n_j \in N$.
By assumption we can write $n_j = \varphi(m_j) + \sum z_{jk}n_{jk}$
with $m_j \in M$, $z_{jk} \in I$ and $n_{jk} \in N$. Hence
$$
\varphi(x - \sum z_j m_j) = \sum z_jz_{jk} n_{jk}.
$$
This means that $x' = x - \sum z_j m_j \in K_{n + 1}$ maps
to $x$ which proves the claim. Now we may apply
Lemma \ref{lemma-Mittag-Leffler}
to the inverse system of short exact sequences above to see (1).
Part (2) is a special case of (1).
If the assumptions of (3) hold, then for each $n$ the sequence
$$
0 \to K/I^nK \to M/I^nM \to N/I^nN \to 0
$$
is short exact by
Lemma \ref{lemma-flat-tor-zero}.
Hence we can directly apply
Lemma \ref{lemma-Mittag-Leffler}
to conclude (3) is true.
To see (4) choose generators $x_i \in M$, $i = 1, \ldots, n$.
Then the map $R^{\oplus n} \to M$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$
is surjective. Hence by (2) we see
$(R^\wedge)^{\oplus n} \to M^\wedge$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$
is surjective. Assertion (4) follows from this.
\end{proof}

\begin{definition}
\label{definition-complete}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module. We say $M$ is {\it $I$-adically complete}
if the map
$$
M \longrightarrow M^\wedge = \lim_n M/I^nM
$$
is an isomorphism\footnote{This includes the condition that
$\bigcap I^nM = (0)$.}. We say $R$ is {\it $I$-adically complete}
if $R$ is $I$-adically complete as an $R$-module.
\end{definition}

\noindent
It is not true that the completion of an $R$-module $M$ with respect
to $I$ is $I$-adically complete. For an example see
Examples, Section \ref{examples-section-noncomplete-completion}.
If the ideal is finitely generated, then the completion is complete.

\begin{lemma}
\label{lemma-hathat-finitely-generated}
\begin{reference}
\cite[Theorem 15]{Matlis}. The slick proof given here is from
an email of Bjorn Poonen dated Nov 5, 2016.
\end{reference}
Let $R$ be a ring. Let $I$ be a finitely generated ideal of $R$.
Let $M$ be an $R$-module. Then
\begin{enumerate}
\item the completion $M^\wedge$ is $I$-adically complete, and
\item $I^nM^\wedge = \Ker(M^\wedge \to M/I^nM) = (I^nM)^\wedge$ for all
$n \geq 1$.
\end{enumerate}
In particular $R^\wedge$ is $I$-adically complete,
$I^nR^\wedge = (I^n)^\wedge$, and
$R^\wedge/I^nR^\wedge = R/I^n$.
\end{lemma}

\begin{proof}
Since $I$ is finitely generated,
$I^n$ is finitely generated, say by $f_1, \ldots, f_r$.
Applying Lemma \ref{lemma-completion-generalities} part (2)
to the surjection $(f_1, \ldots, f_r) : M^{\oplus r} \to I^n M$
yields a surjection
$$
(M^\wedge)^{\oplus r} \xrightarrow{(f_1, \ldots, f_r)} (I^n M)^\wedge =
\lim_{m \geq n} I^n M/I^m M = \Ker(M^\wedge \to M/I^n M).
$$
On the other hand, the image of
$(f_1, \ldots, f_r) : (M^\wedge)^{\oplus r} \to M^\wedge$
is $I^n M^\wedge$.
Thus $M^\wedge / I^n M^\wedge \simeq M/I^n M$.
Taking inverse limits yields $(M^\wedge)^\wedge \simeq M^\wedge$;
that is, $M^\wedge$ is $I$-adically complete.
\end{proof}

\begin{lemma}
\label{lemma-completion-differ-by-torsion}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let
$0 \to M \to N \to Q \to 0$ be an exact sequence of
$R$-modules such that $Q$ is annihilated by a power of $I$.
Then completion produces an exact sequence
$0 \to M^\wedge \to N^\wedge \to Q \to 0$.
\end{lemma}

\begin{proof}
Say $I^c Q = 0$. Then $Q/I^nQ = Q$ for $n \geq c$.
On the other hand, it is clear that
$I^nM \subset M \cap I^nN \subset I^{n - c}M$ for $n \geq c$.
Thus $M^\wedge = \lim M/(M \cap I^n N)$. Apply Lemma \ref{lemma-Mittag-Leffler}
to the system of exact sequences
$$
0 \to M/(M \cap I^n N) \to N/I^n N \to Q \to 0
$$
for $n \geq c$ to conclude.
\end{proof}

\begin{lemma}
\label{lemma-hathat}
\begin{reference}
Taken from an unpublished note of Lenstra and de Smit.
\end{reference}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module.
Denote $K_n = \Ker(M^\wedge \to M/I^nM)$. Then $M^\wedge$ is $I$-adically
complete if and only if $K_n$ is equal to $I^nM^\wedge$ for all $n \geq 1$.
\end{lemma}

\begin{proof}
The module $I^n M^\wedge$ is contained in $K_n$.
Thus for each $n \geq 1$ there is a canonical exact sequence
$$
0 \to K_n/I^nM^\wedge \to M^\wedge/I^nM^\wedge \to M/I^nM \to 0.
$$
As $I^nM^\wedge$ maps onto $I^nM/I^{n + 1}M$ we see that
$K_{n + 1} + I^n M^\wedge = K_n$. Thus the inverse system
$\{K_n/I^n M^\wedge\}_{n \geq 1}$ has surjective transition maps.
By
Lemma \ref{lemma-Mittag-Leffler}
we see that there is a short exact sequence
$$
0 \to
\lim_n K_n/I^n M^\wedge \to
(M^\wedge)^\wedge \to
M^\wedge \to 0
$$
Hence $M^\wedge$ is complete if and only if $K_n/I^n M^\wedge = 0$
for all $n \geq 1$.
\end{proof}

\begin{lemma}
\label{lemma-radical-completion}
Let $R$ be a ring, let $I \subset R$ be an ideal, and let
$R^\wedge = \lim R/I^n$.
\begin{enumerate}
\item any element of $R^\wedge$ which maps to a unit of $R/I$ is a unit,
\item any element of $1 + I$ maps to an invertible element of $R^\wedge$,
\item any element of $1 + IR^\wedge$ is invertible in $R^\wedge$, and
\item the ideals $IR^\wedge$ and $\Ker(R^\wedge \to R/I)$ are contained
in the radical of $R^\wedge$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in R^\wedge$ map to a unit $x_1$ in $R/I$.
Then $x$ maps to a unit $x_n$ in $R/I^n$ for every $n$ by
Lemma \ref{lemma-locally-nilpotent-unit}.
Hence $y = (x_n^{-1}) \in \lim R/I^n = R^\wedge$ is an inverse to $x$.
Parts (2) and (3) follow immediately from (1).
Part (4) follows from (1) and Lemma \ref{lemma-contained-in-radical}.
\end{proof}

\begin{lemma}
\label{lemma-when-surjective-to-completion}
Let $A$ be a ring. Let $I = (f_1, \ldots, f_r)$ be a finitely
generated ideal. If $M \to \lim M/f_i^nM$ is surjective for
each $i$, then $M \to \lim M/I^nM$ is surjective.
\end{lemma}

\begin{proof}
Note that $\lim M/I^nM = \lim M/(f_1^n, \ldots, f_r^n)M$ as
$I^n \supset (f_1^n, \ldots, f_r^n) \supset I^{rn}$.
An element $\xi$ of $\lim M/(f_1^n, \ldots, f_r^n)M$ can be symbolically
written as
$$
\xi = \sum\nolimits_{n \geq 0} \sum\nolimits_i f_i^n x_{n, i}
$$
with $x_{n, i} \in M$. If $M \to \lim M/f_i^nM$ is surjective, then there is
an $x_i \in M$ mapping to $\sum x_{n, i} f_i^n$ in $\lim M/f_i^nM$.
Then $x = \sum x_i$ maps to $\xi$ in $\lim M/I^nM$.
\end{proof}

\begin{lemma}
\label{lemma-complete-by-sub}
Let $A$ be a ring. Let $I \subset J \subset A$ be ideals.
If $M$ is $J$-adically complete and $I$ is finitely generated, then
$M$ is $I$-adically complete.
\end{lemma}

\begin{proof}
Assume $M$ is $J$-adically complete and $I$ is finitely generated.
We have $\bigcap I^nM = 0$ because $\bigcap J^nM = 0$. By
Lemma \ref{lemma-when-surjective-to-completion}
it suffices to prove the surjectivity of $M \to \lim M/I^nM$ in case
$I$ is generated by a single element. Say $I = (f)$.
Let $x_n \in M$ with $x_{n + 1} - x_n \in f^nM$. We have to show there exists
an $x \in M$ such that $x_n - x \in f^nM$ for all $n$.
As $x_{n + 1} - x_n \in J^nM$ and as $M$ is $J$-adically complete,
there exists an element $x \in M$ such that $x_n - x \in J^nM$.
Replacing $x_n$ by $x_n - x$ we may assume that $x_n \in J^nM$.
To finish the proof we will show that this implies $x_n \in I^nM$.
Namely, write $x_n - x_{n + 1} = f^nz_n$.
Then
$$
x_n = f^n(z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots)
$$
The sum $z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots$ converges in $M$
as $f^c \in J^c$. The sum $f^n(z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots)$
converges in $M$ to $x_n$ because
the partial sums equal $x_n - x_{n + c}$ and $x_{n + c} \in J^{n + c}M$.
\end{proof}

\begin{lemma}
\label{lemma-change-ideal-completion}
Let $R$ be a ring.
Let $I$, $J$ be ideals of $R$.
Assume there exist integers $c, d > 0$ such that
$I^c \subset J$ and $J^d \subset I$.
Then completion with respect to $I$ agrees with completion
with respect to $J$ for any $R$-module.
In particular an $R$-module $M$ is $I$-adically complete
if and only if it is $J$-adically complete.
\end{lemma}

\begin{proof}
Consider the system of maps
$M/I^nM \to M/J^{\lfloor n/d \rfloor}M$ and
the system of maps $M/J^mM \to M/I^{\lfloor m/c \rfloor}M$
to get mutually inverse maps between the completions.
\end{proof}

\begin{lemma}
\label{lemma-quotient-complete}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
Let $M$ be an $I$-adically complete $R$-module,
and let $K \subset M$ be an $R$-submodule.
The following are equivalent
\begin{enumerate}
\item $K = \bigcap (K + I^nM)$ and
\item $M/K$ is $I$-adically complete.
\end{enumerate}
\end{lemma}

\begin{proof}
Set $N = M/K$. By
Lemma \ref{lemma-completion-generalities}
the map $M = M^\wedge \to N^\wedge$ is surjective.
Hence $N \to N^\wedge$ is surjective. It is easy to see that the
kernel of $N \to N^\wedge$ is the module $\bigcap (K + I^nM) / K$.
\end{proof}

\begin{lemma}
\label{lemma-when-finite-module-complete-over-complete-ring}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
Let $M$ be an $R$-module.
If (a) $R$ is $I$-adically complete, (b) $M$ is a finite $R$-module,
and (c) $\bigcap I^nM = (0)$, then $M$ is $I$-adically complete.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-generalities}
the map $M = M \otimes_R R = M \otimes_R R^\wedge \to M^\wedge$
is surjective. The kernel of this map is $\bigcap I^nM$ hence zero
by assumption. Hence $M \cong M^\wedge$ and $M$ is complete.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-complete-ring}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is $I$-adically complete,
\item $\bigcap_{n \geq 1} I^nM = (0)$, and
\item $M/IM$ is a finite $R/I$-module.
\end{enumerate}
Then $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in M$ be elements whose images in $M/IM$ generate
$M/IM$ as a $R/I$-module. Denote $M' \subset M$ the $R$-submodule
generated by $x_1, \ldots, x_n$. By Lemma \ref{lemma-completion-generalities}
the map $(M')^\wedge \to M^\wedge$ is surjective.
Since $\bigcap I^nM = 0$ we see in particular that $\bigcap I^nM' = (0)$.
Hence by Lemma \ref{lemma-when-finite-module-complete-over-complete-ring}
we see that $M'$ is complete, and we conclude that $M' \to M^\wedge$
is surjective. Finally, the kernel of $M \to M^\wedge$ is
zero since it is equal to $\bigcap I^nM = (0)$.
Hence we conclude that $M \cong M' \cong M^\wedge$
is finitely generated.
\end{proof}









\section{Completion for Noetherian rings}
\label{section-completion-noetherian}

\noindent
In this section we discuss completion with respect to ideals in
Noetherian rings.

\begin{lemma}
\label{lemma-completion-tensor}
Suppose $R$ is Noetherian.
\begin{enumerate}
\item If $N \to M$ is an injective map of finite $R$-modules,
then the map on completions $N^\wedge \to M^\wedge$ is injective.
\item If $M$ is a finite $R$-module, then $M^\wedge = M \otimes_R R^\wedge$.
\end{enumerate}
\end{lemma}

\begin{proof}
For the first statement, by the Artin-Rees Lemma \ref{lemma-Artin-Rees},
we have a constant $c$ such that $I^nM \cap N$
equals $I^{n-c}(I^cM \cap N) \subset I^{n-c}N$.
Thus if $(n_i) \in N^\wedge$ maps to zero in
$M^\wedge$, then each $n_i$ maps to zero in $N/I^{i-c}N$.
And hence $n_{i-c} = 0$. Thus $N^\wedge \to M^\wedge$ is injective.

\medskip\noindent
For the second statement let $0 \to K \to R^t \to M \to 0$
be the presentation of $M$ corresponding to the generators
$x_1, \ldots, x_t$ of $M$. By Lemma \ref{lemma-completion-generalities}
$(R^t)^\wedge \to M^\wedge$ is surjective,
and for any finitely generated $R$-module the
canonical map $M \otimes_R R^\wedge \to M^\wedge$ is surjective.
Hence to prove the second statement it suffices
to prove the kernel of $(R^t)^\wedge \to M^\wedge$ is
exactly $K^\wedge$.

\medskip\noindent
Let $(x_n) \in (R^t)^\wedge$ be in the kernel. Note that
each $x_n$ is in the image of the map $K/I^nK \to (R/I^n)^t$.
Choose $c$ such that $(I^n)^t \cap K \subset I^{n-c} K$,
which is possible by Artin-Rees (Lemma \ref{lemma-Artin-Rees}).
For each $n \geq 0$ choose $y_n \in K/I^{n + c}K$ mapping to $x_{n + c}$,
and set $z_n = y_n \bmod I^nK$. The elements $z_n$ satisfy
$z_{n + 1} - z_n \bmod I^nK = y_{n + 1} - y_n \bmod I^nK$,
and $y_{n + 1} - y_n \in I^{n + c}R^t$ by construction. Hence
$z_{n + 1} = z_n \bmod I^nK$ by the choice of $c$ above. In other
words $(z_n) \in K^\wedge$ maps to $(x_n)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-completion-flat}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
\begin{enumerate}
\item The ring map $R \to R^\wedge$ is flat.
\item The functor $M \mapsto M^\wedge$ is exact on the category of
finitely generated $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider $I \otimes_R R^\wedge \to R \otimes_R R^\wedge = R^\wedge$.
According to Lemma \ref{lemma-completion-tensor} this
is identified with $I^\wedge \to R^\wedge$ and $I^\wedge \to R^\wedge$
is injective. Part (1) follows from Lemma \ref{lemma-flat}.
Part (2) follows from part (1) and
Lemma \ref{lemma-completion-tensor} part (2).
\end{proof}

\begin{lemma}
\label{lemma-completion-faithfully-flat}
Let $R$ be a Noetherian local ring.
Let $\mathfrak m \subset R$ be the maximal ideal.
Let $I \subset \mathfrak m$ be an ideal.
The ring map $R \to R^\wedge$ is faithfully flat.
In particular the completion with respect to $\mathfrak m$,
namely $\lim_n R/\mathfrak m^n$ is faithfully flat.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-flat} it is flat.
The composition $R \to R^\wedge \to R/\mathfrak m$ where
the last map is the projection map $R^\wedge \to R/I$
combined with $R/I \to R/\mathfrak m$ shows that
$\mathfrak m$ is in the image of $\Spec(R^\wedge)
\to \Spec(R)$. Hence the map is faithfully
flat by Lemma \ref{lemma-ff}.
\end{proof}

\begin{lemma}
\label{lemma-completion-complete}
Let $R$ be a Noetherian ring.
Let $I$ be an ideal of $R$.
Let $M$ be an $R$-module.
Then the completion $M^\wedge$
of $M$ with respect to $I$ is $I$-adically complete,
$I^n M^\wedge = (I^nM)^\wedge$, and $M^\wedge/I^nM^\wedge = M/I^nM$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-hathat-finitely-generated}
because $I$ is a finitely generated ideal.
\end{proof}

\begin{lemma}
\label{lemma-completion-Noetherian}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Assume
\begin{enumerate}
\item $R/I$ is a Noetherian ring,
\item $I$ is finitely generated.
\end{enumerate}
Then $R^\wedge$ is a Noetherian ring complete with respect to $IR^\wedge$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-hathat-finitely-generated}
we see that $R^\wedge$ is $I$-adically complete. Hence it is also
$IR^\wedge$-adically complete. Since $R^\wedge/IR^\wedge = R/I$ is
Noetherian we see that after replacing $R$ by $R^\wedge$ we may in
addition to assumptions (1) and (2) assume that also $R$ is $I$-adically
complete.

\medskip\noindent
Let $f_1, \ldots, f_t$ be generators of $I$.
Then there is a surjection of rings
$R/I[T_1, \ldots, T_t] \to \bigoplus I^n/I^{n + 1}$
mapping $T_i$ to the element $\overline{f}_i \in I/I^2$.
Hence $\bigoplus I^n/I^{n + 1}$ is a Noetherian ring.
Let $J \subset R$ be an ideal. Consider the ideal
$$
\bigoplus J \cap I^n/J \cap I^{n + 1} \subset \bigoplus I^n/I^{n + 1}.
$$
Let $\overline{g}_1, \ldots, \overline{g}_m$ be generators of this
ideal. We may choose $\overline{g}_j$ to be a homogeneous element
of degree $d_j$ and we may pick $g_j \in J \cap I^{d_j}$ mapping to
$\overline{g}_j \in J \cap I^{d_j}/J \cap I^{d_j + 1}$. We claim
that $g_1, \ldots, g_m$ generate $J$.

\medskip\noindent
Let $x \in J \cap I^n$. There exist $a_j \in I^{\max(0, n - d_j)}$ such that
$x - \sum a_j g_j \in J \cap I^{n + 1}$.
The reason is that $J \cap I^n/J \cap I^{n + 1}$ is equal to
$\sum \overline{g}_j I^{n - d_j}/I^{n - d_j + 1}$ by our choice
of $g_1, \ldots, g_m$. Hence starting with $x \in J$ we can find
a sequence of vectors $(a_{1, n}, \ldots, a_{m, n})_{n \geq 0}$
with $a_{j, n} \in I^{\max(0, n - d_j)}$ such that
$$
x =
\sum\nolimits_{n = 0, \ldots, N}
\sum\nolimits_{j = 1, \ldots, m} a_{j, n} g_j \bmod I^{N + 1}
$$
Setting $A_j = \sum_{n \geq 0} a_{j, n}$ we see that
$x = \sum A_j g_j$ as $R$ is complete. Hence $J$ is finitely generated and
we win.
\end{proof}

\begin{lemma}
\label{lemma-completion-Noetherian-Noetherian}
Let $R$ be a Noetherian ring.
Let $I$ be an ideal of $R$.
The completion $R^\wedge$ of $R$ with respect to $I$ is
Noetherian.
\end{lemma}

\begin{proof}
This is a consequence of
Lemma \ref{lemma-completion-Noetherian}.
It can also be seen directly as follows.
Choose generators $f_1, \ldots, f_n$ of $I$.
Consider the map
$$
R[[x_1, \ldots, x_n]] \longrightarrow R^\wedge,
\quad
x_i \longmapsto f_i.
$$
This is a well defined and surjective ring map
(details omitted).
Since $R[[x_1, \ldots, x_n]]$ is Noetherian (see
Lemma \ref{lemma-Noetherian-power-series}) we win.
\end{proof}

\noindent
Suppose $R \to S$ is a local homomorphism of local rings $(R, \mathfrak m)$
and $(S, \mathfrak n)$. Let $S^\wedge$ be the completion
of $S$ with respect to $\mathfrak n$. In general $S^\wedge$ is not
the $\mathfrak m$-adic completion of $S$. If
$\mathfrak n^t \subset \mathfrak mS$ for some $t \geq 1$
then we do have $S^\wedge = \lim S/\mathfrak m^nS$ by
Lemma \ref{lemma-change-ideal-completion}. In some cases this even
implies that $S^\wedge$ is finite over $R^\wedge$.

\begin{lemma}
\label{lemma-finite-after-completion}
Let $R \to S$ be a local homomorphism of local rings $(R, \mathfrak m)$
and $(S, \mathfrak n)$. Let $R^\wedge$, resp.\ $S^\wedge$ be the completion
of $R$, resp.\ $S$ with respect to $\mathfrak m$, resp.\ $\mathfrak n$.
If $\mathfrak m$ and $\mathfrak n$ are finitely generated and
$\dim_{\kappa(\mathfrak m)} S/\mathfrak mS < \infty$, then
\begin{enumerate}
\item $S^\wedge$ is equal to the $\mathfrak m$-adic completion of $S$, and
\item $S^\wedge$ is a finite $R^\wedge$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We have $\mathfrak mS \subset \mathfrak n$ because $R \to S$ is a local
ring map.
The assumption $\dim_{\kappa(\mathfrak m)} S/\mathfrak mS < \infty$
implies that $S/\mathfrak mS$ is an Artinian ring, see
Lemma \ref{lemma-finite-dimensional-algebra}.
Hence has dimension $0$, see
Lemma \ref{lemma-Noetherian-dimension-0},
hence $\mathfrak n = \sqrt{\mathfrak mS}$.
This and the fact that $\mathfrak n$ is finitely generated
implies that $\mathfrak n^t \subset \mathfrak mS$ for
some $t \geq 1$. By
Lemma \ref{lemma-change-ideal-completion}
we see that $S^\wedge$ can be identified with the $\mathfrak m$-adic
completion of $S$. As $\mathfrak m$ is finitely generated we see from
Lemma \ref{lemma-hathat-finitely-generated}
that $S^\wedge$ and $R^\wedge$ are $\mathfrak m$-adically complete.
At this point we may apply
Lemma \ref{lemma-finite-over-complete-ring}
to $S^\wedge$ as an $R^\wedge$-module to conclude.
\end{proof}

\begin{lemma}
\label{lemma-completion-finite-extension}
Let $R$ be a Noetherian ring. Let $R \to S$ be a finite ring map.
Let $\mathfrak p \subset R$ be a prime and let
$\mathfrak q_1, \ldots, \mathfrak q_m$ be the primes of $S$
lying over $\mathfrak p$
(Lemma \ref{lemma-finite-finite-fibres}).
Then
$$
R_\mathfrak p^\wedge \otimes_R S =
(S_\mathfrak p)^\wedge =
S_{\mathfrak q_1}^\wedge \times \ldots \times S_{\mathfrak q_m}^\wedge
$$
where the $(S_\mathfrak p)^\wedge$ is the completion with respect to
$\mathfrak p$ and the local rings $R_\mathfrak p$ and
$S_{\mathfrak q_i}$ are completed with respect to their maximal ideals.
\end{lemma}

\begin{proof}
The first equality follows from Lemma \ref{lemma-completion-tensor}.
We may replace $R$ by the localization $R_\mathfrak p$ and
$S$ by $S_\mathfrak p = S \otimes_R R_\mathfrak p$.
Hence we may assume that $R$ is a local Noetherian ring and
that $\mathfrak p = \mathfrak m$ is its maximal ideal.
The $\mathfrak q_iS_{\mathfrak q_i}$-adic completion
$S_{\mathfrak q_i}^\wedge$ is equal to the $\mathfrak m$-adic
completion by Lemma \ref{lemma-finite-after-completion}.
For every $n \geq 1$ prime ideals of $S/\mathfrak m^nS$ are in 1-to-1
correspondence with the maximal ideals
$\mathfrak q_1, \ldots, \mathfrak q_m$ of $S$
(by going up for $S$ over $R$, see
Lemma \ref{lemma-integral-going-up}).
Hence
$S/\mathfrak m^nS = \prod S_{\mathfrak q_i}/\mathfrak m^nS_{\mathfrak q_i}$
by Lemma \ref{lemma-artinian-finite-length}
(using for example
Proposition \ref{proposition-dimension-zero-ring}
to see that $S/\mathfrak m^nS$ is Artinian).
Hence the $\mathfrak m$-adic completion $S^\wedge$ of $S$ is equal to
$\prod S_{\mathfrak q_i}^\wedge$. Finally, we have
$R^\wedge \otimes_R S = S^\wedge$ by Lemma \ref{lemma-completion-tensor}.
\end{proof}

\begin{lemma}
\label{lemma-split-completed-sequence}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $0 \to K \to P \to M \to 0$ be a short exact sequence of
$R$-modules. If $M$ is flat over $R$ and $M/IM$ is a projective
$R/I$-module, then the sequence of $I$-adic completions
$$
0 \to K^\wedge \to P^\wedge \to M^\wedge \to 0
$$
is a split exact sequence.
\end{lemma}

\begin{proof}
As $M$ is flat, each of the sequences
$$
0 \to K/I^nK \to P/I^nP \to M/I^nM \to 0
$$
is short exact, see
Lemma \ref{lemma-flat-tor-zero}
and the sequence $0 \to K^\wedge \to P^\wedge \to M^\wedge \to 0$
is a short exact sequence, see
Lemma \ref{lemma-completion-generalities}.
It suffices to show that we can find splittings
$s_n : M/I^nM \to P/I^nP$ such that $s_{n + 1} \bmod I^n = s_n$.
We will construct these $s_n$ by induction on $n$.
Pick any splitting $s_1$, which exists as $M/IM$ is a projective $R/I$-module.
Assume given $s_n$ for some $n > 0$. Set
$P_{n + 1} = \{x \in P \mid x \bmod I^nP \in \Im(s_n)\}$.
The map $\pi : P_{n + 1}/I^{n + 1}P_{n + 1} \to M/I^{n + 1}M$ is surjective
(details omitted). As $M/I^{n + 1}M$ is projective as a $R/I^{n + 1}$-module
by
Lemma \ref{lemma-lift-projective}
we may choose a section
$t : M/I^{n + 1}M \to P_{n + 1}/I^{n + 1}P_{n + 1}$
of $\pi$. Setting $s_{n + 1}$ equal to the composition of
$t$ with the canonical map $P_{n + 1}/I^{n + 1}P_{n + 1} \to P/I^{n + 1}P$
works.
\end{proof}










\section{Taking limits of modules}
\label{section-limits}

\noindent
In this section we discuss what happens when we take a limit of modules.

\begin{lemma}
\label{lemma-limit-complete}
Let $A$ be a ring. Let $I \subset A$ be an ideal. Let $(M_n)$ be an inverse
system of $A$-modules. Set $M = \lim M_n$. If $M_n = M_{n + 1}/I^nM_{n + 1}$
and $I$ is finitely generated then $M/I^nM = M_n$ and $M$ is
$I$-adically complete.
\end{lemma}

\begin{proof}
As $M_{n + 1} \to M_n$ is surjective, the map $M \to M_1$ is surjective.
Pick $x_t \in M$, $t \in T$ mapping to generators of $M_1$. This gives a map
$\bigoplus_{t \in T} A \to M$. Note that the images of $x_t$ in $M_n$
generate $M_n$ for all $n$ too. Consider the exact sequences
$$
0 \to K_n \to \bigoplus\nolimits_{t \in T} A/I^n \to M_n \to 0
$$
We claim the map $K_{n + 1} \to K_n$ is surjective. Namely, if $y \in K_n$
choose a lift $y' \in \bigoplus_{t \in T} A/I^{n + 1}$. Then $y'$
maps to an element of $I^n M_{n + 1}$ by our assumption
$M_n = M_{n + 1}/I^nM_{n + 1}$. Hence we can modify our
choice of $y'$ by an element of $\bigoplus_{t \in T} I^n/I^{n + 1}$
so that $y'$ maps to zero in $M_{n + 1}$. Then $y' \in K_{n +1}$
maps to $y$. Hence $(K_n)$ is a sequence of modules with surjective
transition maps and we obtain an exact sequence
$$
0 \to \lim K_n \to
\left(\bigoplus\nolimits_{t \in T} A\right)^\wedge \to M \to 0
$$
by Lemma \ref{lemma-Mittag-Leffler}. Fix an integer $m$. As $I$ is finitely
generated, the completion with respect to $I$ is complete and
$(\bigoplus_{t \in T} A)^\wedge / I^m(\bigoplus_{t \in T} A)^\wedge =
\bigoplus_{t \in T} A/I^m$
(Lemma \ref{lemma-hathat-finitely-generated}).
We obtain a short exact sequence
$$
(\lim K_n)/I^m(\lim K_n) \to
\bigoplus\nolimits_{t \in T} A/I^m \to
M/I^mM \to 0
$$
Since $\lim K_n \to K_m$ is surjective we conclude that $M/I^mM = M_m$.
It follows in particular that $M$ is $I$-adically complete.
\end{proof}












\section{Criteria for flatness}
\label{section-criteria-flatness}

\noindent
In this section we prove some important technical lemmas in the Noetherian
case. We will (partially) generalize these to the non-Noetherian case
in Section \ref{section-more-flatness-criteria}.

\begin{lemma}
\label{lemma-mod-injective}
Suppose that $R \to S$ is a local homomorphism of Noetherian local rings.
Denote $\mathfrak m$ the maximal ideal of $R$. Let $M$ be a flat $R$-module
and $N$ a finite $S$-module. Let $u : N \to M$ be a map of $R$-modules.
If $\overline{u} : N/\mathfrak m N \to M/\mathfrak m M$
is injective then $u$ is injective.
In this case $M/u(N)$ is flat over $R$.
\end{lemma}

\begin{proof}
First we claim that $u_n : N/{\mathfrak m}^nN \to M/{\mathfrak m}^nM$
is injective for all $n \geq 1$. We proceed by induction, the base
case is that $\overline{u} = u_1$ is injective. By our assumption that $M$
is flat over $R$ we have  a short exact sequence
$0 \to M \otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
\to M/{\mathfrak m}^{n + 1}M \to M/{\mathfrak m}^n M \to 0$.
Also, $M \otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
= M/{\mathfrak m}M \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n + 1}$. We have
a similar exact sequence $N \otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
\to N/{\mathfrak m}^{n + 1}N \to N/{\mathfrak m}^n N \to 0$
for $N$ except we do not have the zero on the left. We also
have $N \otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
= N/{\mathfrak m}N \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n + 1}$. Thus the map $u_{n + 1}$ is
injective as both $u_n$ and the map
$\overline{u} \otimes \text{id}_{{\mathfrak m}^n/{\mathfrak m}^{n + 1}}$ are.

\medskip\noindent
By Krull's intersection theorem
(Lemma \ref{lemma-intersect-powers-ideal-module-zero})
applied to $N$ over the ring $S$ and the ideal $\mathfrak mS$
we have $\bigcap \mathfrak m^nN = 0$. Thus the injectivity
of $u_n$ for all $n$ implies $u$ is injective.

\medskip\noindent
To show that $M/u(N)$ is flat over $R$, it suffices to show that
$I \otimes_R M/u(N) \to M/u(N)$ is injective for every ideal $I \subset R$,
see Lemma \ref{lemma-flat}. Consider the diagram
$$
\begin{matrix}
& & 0 & & 0 & & 0 & & \\
& & \uparrow & & \uparrow & & \uparrow & & \\
& & N/IN & \to & M/IM & \to & M/(IN + u(N)) & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow & & \\
0 & \to & N & \to & M & \to & M/u(N) & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow & & \\
& & N \otimes_R I & \to & M \otimes_R I & \to & M/u(N)\otimes_R I & \to & 0
\end{matrix}
$$
The arrow $M \otimes_R I \to M$ is injective. By the snake lemma
(Lemma \ref{lemma-snake}) we see that it suffices to prove that
$N/IN$ injects into $M/IM$. Note that $R/I \to S/IS$ is a local
homomorphism of Noetherian local rings, $N/IN \to M/IM$ is a map
of $R/I$-modules, $N/IN$ is finite over $S/IS$, and $M/IM$ is flat over
$R/I$ and $u \bmod I : N/IN \to M/IM$ is injective modulo $\mathfrak m$.
Thus we may apply the first part of the proof to $u \bmod I$ and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f \in S$ is a nonzerodivisor in $S/{\mathfrak m}S$.
Then $S/fS$ is flat over $R$, and $f$ is a nonzerodivisor in $S$.
\end{lemma}

\begin{proof}
Follows directly from Lemma \ref{lemma-mod-injective}.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-regular-sequence}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f_1, \ldots, f_c$ is a sequence of elements of
$S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$
form a regular sequence in $S/{\mathfrak m}S$.
Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each
of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.
\end{lemma}

\begin{proof}
Induction and Lemma \ref{lemma-grothendieck}.
\end{proof}

\begin{lemma}
\label{lemma-free-fibre-flat-free}
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $\mathfrak m$ be the maximal
ideal of $R$. Let $M$ be a finite $S$-modules.
Suppose that (a) $M/\mathfrak mM$
is a free $S/\mathfrak mS$-module, and (b) $M$ is flat over $R$.
Then $M$ is free and $S$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\overline{x}_1, \ldots, \overline{x}_n$ be a basis
for the free module $M/\mathfrak mM$. Choose
$x_1, \ldots, x_n \in M$ with $x_i$ mapping to $\overline{x}_i$. Let
$u : S^{\oplus n} \to M$ be the map which maps the $i$th
standard basis vector to $x_i$. By Lemma \ref{lemma-mod-injective}
we see that $u$ is injective. On the other hand, by
Nakayama's Lemma \ref{lemma-NAK} the map is surjective. The
lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-complex-exact-mod}
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$.
Let $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
be a finite complex of finite $S$-modules. Assume that
each $F_i$ is $R$-flat, and that the complex
$0 \to F_e/\mathfrak m F_e \to F_{e-1}/\mathfrak m F_{e-1}
\to \ldots \to F_0 / \mathfrak m F_0$ is exact.
Then $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
is exact, and moreover the module
$\Coker(F_1 \to F_0)$ is $R$-flat.
\end{lemma}

\begin{proof}
By induction on $e$. If $e = 1$, then this is exactly
Lemma \ref{lemma-mod-injective}. If $e > 1$, we see
by Lemma \ref{lemma-mod-injective} that $F_e \to F_{e-1}$
is injective and that $C = \Coker(F_e \to F_{e-1})$
is a finite $S$-module flat over $R$. Hence we can
apply the induction hypothesis to the complex
$0 \to C \to F_{e-2} \to \ldots \to F_0$.
We deduce that $C \to F_{e-2}$ is injective
and the exactness of the complex follows, as well
as the flatness of the cokernel of $F_1 \to F_0$.
\end{proof}

\noindent
In the rest of this section we prove two versions of what is called the
``{\it local criterion of flatness}''. Note also the interesting
Lemma \ref{lemma-CM-over-regular-flat} below.

\begin{lemma}
\label{lemma-prepare-local-criterion-flatness}
Let $R$ be a local ring with maximal ideal $\mathfrak m$
and residue field $\kappa = R/\mathfrak m$.
Let $M$ be an $R$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then for every finite length $R$-module $N$ we have
$\text{Tor}_1^R(N, M) = 0$.
\end{lemma}

\begin{proof}
By descending induction on the length of $N$.
If the length of $N$ is $1$, then $N \cong \kappa$
and we are done. If the length of $N$ is more than
$1$, then we can fit $N$ into a short exact sequence
$0 \to N' \to N \to N'' \to 0$ where $N'$, $N''$ are
finite length $R$-modules of smaller length.
The vanishing of $\text{Tor}_1^R(N, M)$ follows
from the vanishing of $\text{Tor}_1^R(N', M)$
and $\text{Tor}_1^R(N'', M)$ (induction hypothesis)
and the long exact sequence of Tor groups, see Lemma
\ref{lemma-long-exact-sequence-tor}.
\end{proof}

\begin{lemma}[Local criterion for flatness]
\label{lemma-local-criterion-flatness}
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$,
and let $\kappa = R/\mathfrak m$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal. By Lemma \ref{lemma-flat} it suffices
to show that $I \otimes_R M \to M$ is injective. By Remark
\ref{remark-Tor-ring-mod-ideal} we see that this kernel is
equal to $\text{Tor}_1^R(M, R/I)$. By
Lemma \ref{lemma-prepare-local-criterion-flatness}
we see that $J \otimes_R M \to M$ is injective for all ideals
of finite colength.

\medskip\noindent
Choose $n >> 0$ and consider the following short exact
sequence
$$
0
\to I \cap \mathfrak m^n
\to I \oplus \mathfrak m^n
\to I + \mathfrak m^n
\to 0
$$
This is a sub sequence of the short exact sequence
$0 \to R \to R^{\oplus 2} \to R \to 0$. Thus we get the diagram
$$
\xymatrix{
(I\cap \mathfrak m^n) \otimes_R M \ar[r] \ar[d] &
I \otimes_R M \oplus \mathfrak m^n \otimes_R M \ar[r] \ar[d] &
(I + \mathfrak m^n) \otimes_R M \ar[d] \\
M \ar[r] &
M \oplus M \ar[r] &
M
}
$$
Note that $I + \mathfrak m^n$ and $\mathfrak m^n$
are ideals of finite colength.
Thus a diagram chase shows that
$\Ker((I \cap \mathfrak m^n)\otimes_R M \to M)
\to \Ker(I \otimes_R M \to M)$
is surjective. We conclude in particular that
$K = \Ker(I \otimes_R M \to M)$ is contained
in the image of $(I \cap \mathfrak m^n) \otimes_R M$
in $I \otimes_R M$. By Artin-Rees, Lemma \ref{lemma-Artin-Rees}
we see that $K$ is contained
in $\mathfrak m^{n-c}(I \otimes_R M)$ for some $c > 0$
and all $n >> 0$. Since $I \otimes_R M$ is a finite
$S$-module (!) and since $S$ is Noetherian, we see
that this implies $K = 0$. Namely, the above implies
$K$ maps to zero in the $\mathfrak mS$-adic completion
of $I \otimes_R M$. But the map from $S$
to its $\mathfrak mS$-adic completion is faithfully flat
by Lemma \ref{lemma-completion-faithfully-flat}.
Hence $K = 0$, as desired.
\end{proof}

\noindent
In the following we often encounter the conditions
``$M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$''.
The following lemma gives some consequences of these conditions
(it is a generalization of
Lemma \ref{lemma-prepare-local-criterion-flatness}).

\begin{lemma}
\label{lemma-what-does-it-mean}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
If $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$ then
\begin{enumerate}
\item $M/I^nM$ is flat over $R/I^n$ for all $n \geq 1$, and
\item for any module $N$ which is annihilated by $I^m$ for some $m \geq 0$
we have $\text{Tor}_1^R(N, M) = 0$.
\end{enumerate}
In particular, if $I$ is nilpotent, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Assume $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$.
Let $N$ be an $R/I$-module. Choose a short exact sequence
$$
0 \to K \to \bigoplus\nolimits_{i \in I} R/I \to N \to 0
$$
By the long exact sequence of $\text{Tor}$ and the vanishing of
$\text{Tor}_1^R(R/I, M)$ we get
$$
0 \to \text{Tor}_1^R(N, M) \to K \otimes_R M \to
(\bigoplus\nolimits_{i \in I} R/I) \otimes_R M \to N \otimes_R M \to 0
$$
But since $K$, $\bigoplus_{i \in I} R/I$, and $N$ are all annihilated
by $I$ we see that
\begin{align*}
K \otimes_R M & = K \otimes_{R/I} M/IM, \\
(\bigoplus\nolimits_{i \in I} R/I) \otimes_R M & =
(\bigoplus\nolimits_{i \in I} R/I) \otimes_{R/I} M/IM, \\
N \otimes_R M & = N \otimes_{R/I} M/IM.
\end{align*}
As $M/IM$ is flat over $R/I$ we conclude that
$$
0 \to K \otimes_{R/I} M/IM \to
(\bigoplus\nolimits_{i \in I} R/I) \otimes_{R/I} M/IM \to
N \otimes_{R/} M/IM \to 0
$$
is exact. Combining this with the above we conclude that
$\text{Tor}_1^R(N, M) = 0$ for any $R$-module $N$ annihilated by $I$.

\medskip\noindent
In particular, if we apply this to the
module $I/I^2$, then we conclude that the sequence
$$
0 \to I^2 \otimes_R M \to I \otimes_R M  \to I/I^2 \otimes_R M \to 0
$$
is short exact. This implies that $I^2 \otimes_R M \to M$ is injective
and it implies that $I/I^2 \otimes_{R/I} M/IM = IM/I^2M$.

\medskip\noindent
Let us prove that $M/I^2M$ is flat over $R/I^2$. Let $I^2 \subset J$
be an ideal. We have to show that
$J/I^2 \otimes_{R/I^2} M/I^2M \to M/I^2M$ is injective, see
Lemma \ref{lemma-flat}.
As $M/IM$ is flat over $R/I$ we know that the map
$(I + J)/I \otimes_{R/I} M/IM \to M/IM$ is injective.
The sequence
$$
(I \cap J)/I^2 \otimes_{R/I^2} M/I^2M \to
J/I^2 \otimes_{R/I^2} M/I^2M \to
(I + J)/I \otimes_{R/I} M/IM \to 0
$$
is exact, as you get it by tensoring the exact sequence
$0 \to (I \cap J) \to J \to (I + J)/I \to 0$ by $M/I^2M$.
Hence suffices to prove the injectivity of the map
$(I \cap J)/I^2 \otimes_{R/I} M/IM \to IM/I^2M$. However, the map
$(I \cap J)/I^2 \to I/I^2$ is injective and as $M/IM$
is flat over $R/I$ the map
$(I \cap J)/I^2 \otimes_{R/I} M/IM \to I/I^2 \otimes_{R/I} M/IM$
is injective. Since we have previously seen that
$I/I^2 \otimes_{R/I} M/IM = IM/I^2M$ we obtain the desired injectivity.

\medskip\noindent
Hence we have proven that the assumptions imply:
(a) $\text{Tor}_1^R(N, M) = 0$ for all $N$ annihilated by $I$,
(b) $I^2 \otimes_R M \to M$ is injective, and (c) $M/I^2M$ is flat
over $R/I^2$. Thus we can continue by induction to get the
same results for $I^n$ for all $n \geq 1$.
\end{proof}

\begin{lemma}
\label{lemma-what-does-it-mean-again}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
\begin{enumerate}
\item If $M/IM$ is flat over $R/I$ and $M \otimes_R I/I^2 \to IM/I^2M$
is injective, then $M/I^2M$ is flat over $R/I^2$.
\item If $M/IM$ is flat over $R/I$ and $M \otimes_R I^n/I^{n + 1}
\to I^nM/I^{n + 1}M$ is injective for $n = 1, \ldots, k$,
then $M/I^{k + 1}M$ is flat over $R/I^{k + 1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement is a consequence of
Lemma \ref{lemma-what-does-it-mean} applied with $R$ replaced by $R/I^2$
and $M$ replaced by $M/I^2M$ using that
$$
\text{Tor}_1^{R/I^2}(M/I^2M, R/I) =
\Ker(M \otimes_R I/I^2 \to IM/I^2M),
$$
see Remark \ref{remark-Tor-ring-mod-ideal}.
The second statement follows in the same manner using induction
on $n$ to show that $M/I^{n + 1}M$ is flat over $R/I^{n + 1}$ for
$n = 1, \ldots, k$. Here we use that
$$
\text{Tor}_1^{R/I^{n + 1}}(M/I^{n + 1}M, R/I) =
\Ker(M \otimes_R I^n/I^{n + 1} \to I^nM/I^{n + 1}M)
$$
for every $n$.
\end{proof}

\begin{lemma}[Variant of the local criterion]
\label{lemma-variant-local-criterion-flatness}
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $I \not = R$ be an ideal in $R$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(M, R/I) = 0$
and $M/IM$ is flat over $R/I$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
First proof: By
Lemma \ref{lemma-what-does-it-mean}
we see that $\text{Tor}_1^R(\kappa, M)$ is zero where $\kappa$
is the residue field of $R$. Hence we see that $M$
is flat over $R$ by
Lemma \ref{lemma-local-criterion-flatness}.

\medskip\noindent
Second proof: Let $\mathfrak m$ be the maximal ideal of $R$.
We will show that $\mathfrak m \otimes_R M \to M$ is injective,
and then apply
Lemma \ref{lemma-local-criterion-flatness}.
Suppose that $\sum f_i \otimes x_i \in \mathfrak m \otimes_R M$
and that $\sum f_i x_i = 0$ in $M$. By the equational criterion
for flatness Lemma \ref{lemma-flat-eq} applied to $M/IM$
over $R/I$ we see there exist $\overline{a}_{ij} \in R/I$
and $\overline{y}_j \in M/IM$ such that
$x_i \bmod IM = \sum_j \overline{a}_{ij} \overline{y}_j $
and $0 = \sum_i (f_i \bmod I) \overline{a}_{ij}$.
Let $a_{ij} \in R$ be a lift of $\overline{a}_{ij}$ and
similarly let $y_j \in M$ be a lift of $\overline{y}_j$.
Then we see that
\begin{eqnarray*}
\sum f_i \otimes x_i
& = &
\sum f_i \otimes x_i +
\sum f_ia_{ij} \otimes y_j -
\sum f_i \otimes a_{ij} y_j
\\
& = &
\sum f_i \otimes (x_i - \sum a_{ij} y_j) +
\sum (\sum f_i a_{ij}) \otimes y_j
\end{eqnarray*}
Since $x_i - \sum a_{ij} y_j \in IM$ and
$\sum f_i a_{ij} \in I$ we see that there exists
an element in $I \otimes_R M$ which maps to our given
element $\sum f_i \otimes x_i$ in $\mathfrak m \otimes_R M$.
But $I \otimes_R M \to M$ is injective by assumption (see
Remark \ref{remark-Tor-ring-mod-ideal}) and we win.
\end{proof}

\noindent
In particular, in the situation of
Lemma \ref{lemma-variant-local-criterion-flatness}, suppose that
$I = (x)$ is generated by a single element $x$ which is
a nonzerodivisor in $R$. Then $\text{Tor}_1^R(M, R/(x)) = (0)$
if and only if $x$ is a nonzerodivisor on $M$.

\begin{lemma}
\label{lemma-flat-module-powers}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ the module $M/I^n M$ is flat over
$R/I^n$.
\end{enumerate}
Then for every $\mathfrak q \in V(IS)$
the localization $M_{\mathfrak q}$ is flat over $R$.
In particular, if $S$ is local and $IS$ is contained
in its maximal ideal, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
We are going to use
Lemma \ref{lemma-variant-local-criterion-flatness}.
By assumption $M/IM$ is flat over $R/I$. Hence it suffices to check
that $\text{Tor}_1^R(M, R/I)$ is zero on localization at $\mathfrak q$. By
Remark \ref{remark-Tor-ring-mod-ideal}
this Tor group is equal to $K = \Ker(I \otimes_R M \to M)$.
We know for each $n \geq 1$ that the kernel
$\Ker(I/I^n \otimes_{R/I^n} M/I^nM \to M/I^nM)$ is zero.
Since there is a module map
$I/I^n \otimes_{R/I^n} M/I^nM \to (I \otimes_R M)/I^{n - 1}(I \otimes_R M)$
we conclude that $K \subset I^{n - 1}(I \otimes_R M)$ for each $n$.
By the Artin-Rees lemma, and more precisely
Lemma \ref{lemma-intersection-powers-ideal-module}
we conclude that $K_{\mathfrak q} = 0$, as desired.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-tor-one}
Let $R \to R' \to R''$ be ring maps.
Let $M$ be an $R$-module. Suppose that $M \otimes_R R'$
is flat over $R'$. Then the natural map
$\text{Tor}_1^R(M, R') \otimes_{R'} R'' \to
\text{Tor}_1^R(M, R'')$ is onto.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of $M$ over $R$.
The complex $F_2 \otimes_R R' \to F_1\otimes_R R' \to F_0 \otimes_R R'$
computes $\text{Tor}_1^R(M, R')$.
The complex $F_2 \otimes_R R'' \to F_1\otimes_R R'' \to F_0 \otimes_R R''$
computes $\text{Tor}_1^R(M, R'')$. Note that
$F_i \otimes_R R' \otimes_{R'} R'' = F_i \otimes_R R''$. Let
$K' = \Ker(F_1\otimes_R R' \to F_0 \otimes_R R')$ and
similarly $K'' = \Ker(F_1\otimes_R R'' \to F_0 \otimes_R R'')$.
Thus we have an exact sequence
$$
0 \to K' \to F_1\otimes_R R' \to F_0 \otimes_R R' \to M \otimes_R R' \to 0.
$$
By the assumption that $M \otimes_R R'$ is flat over $R'$,
the sequence $0 \to K' \otimes_{R'} R''
\to F_1 \otimes_R R'' \to F_0 \otimes_R R'' \to M \otimes_R R'' \to 0$
is still exact. This means that $K'' = K' \otimes_{R'} R''$.
Since $\text{Tor}_1^R(M, R')$ is a quotient of $K'$ and
$\text{Tor}_1^R(M, R'')$ is a quotient of $K''$ we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-tor-one-trivial}
Let $R \to R'$ be a ring map. Let $I \subset R$ be
an ideal and $I' = IR'$. Let $M$ be an $R$-module
and set $M' = M \otimes_R R'$. The natural map
$\text{Tor}_1^R(R'/I', M) \to \text{Tor}_1^{R'}(R'/I', M')$
is surjective.
\end{lemma}

\begin{proof}
Let $F_2 \to F_1 \to F_0 \to M \to 0$ be a free resolution of
$M$ over $R$. Set $F_i' = F_i \otimes_R R'$. The sequence
$F_2' \to F_1' \to F_0' \to M' \to 0$ may no longer be exact
at $F_1'$. A free resolution of $M'$ over $R'$ therefore looks
like
$$
F_2' \oplus F_2'' \to F_1' \to F_0' \to M' \to 0
$$
for a suitable free module $F_2''$ over $R'$. Next, note that
$F_i \otimes_R R'/I' = F_i' / IF_i' = F_i'/I'F_i'$.
So the complex $F_2'/I'F_2' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^R(M, R'/I')$. On the other hand
$F_i' \otimes_{R'} R'/I' = F_i'/I'F_i'$ and similarly
for $F_2''$. Thus the complex
$F_2'/I'F_2' \oplus F_2''/I'F_2'' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^{R'}(M', R'/I')$. Since the vertical
map on complexes
$$
\xymatrix{
F_2'/I'F_2' \ar[r] \ar[d] &
F_1'/I'F_1' \ar[r] \ar[d] &
F_0'/I'F_0' \ar[d] \\
F_2'/I'F_2' \oplus F_2''/I'F_2'' \ar[r] &
F_1'/I'F_1' \ar[r] &
F_0'/I'F_0'
}
$$
clearly induces a surjection on cohomology we win.
\end{proof}

\begin{lemma}
\label{lemma-another-variant-local-criterion-flatness}
Let
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
be a commutative diagram of local homomorphisms of local Noetherian rings.
Let $I \subset R$ be a proper ideal.
Let $M$ be a finite $S$-module.
Denote $I' = IR'$ and $M' = M \otimes_S S'$.
Assume that
\begin{enumerate}
\item $S'$ is a localization of the tensor product
$S \otimes_R R'$,
\item $M/IM$ is flat over $R/I$,
\item $\text{Tor}_1^R(M, R/I) \to \text{Tor}_1^{R'}(M', R'/I')$
is zero.
\end{enumerate}
Then $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
Since $S'$ is a localization of $S \otimes_R R'$ we see that
$M'$ is a localization of $M \otimes_R R'$. Note that
by Lemma \ref{lemma-flat-base-change} the module $M/IM \otimes_{R/I} R'/I'
= M \otimes_R R' /I'(M \otimes_R R')$ is flat over $R'/I'$. Hence also
$M'/I'M'$ is flat over $R'/I'$ as the localization of a flat module
is flat. By Lemma \ref{lemma-variant-local-criterion-flatness}
it suffices to show that $\text{Tor}_1^{R'}(M', R'/I')$ is zero.
Since $M'$ is a localization of $M \otimes_R R'$, the last assumption
implies that it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^{R'}(M \otimes_R R', R'/I')$
is surjective.

\medskip\noindent
By Lemma \ref{lemma-surjective-on-tor-one-trivial} we see that
$\text{Tor}_1^R(M, R'/I') \to \text{Tor}_1^{R'}(M \otimes_R R', R'/I')$
is surjective. So now it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^R(M, R'/I')$
is surjective. This follows from Lemma \ref{lemma-surjective-on-tor-one}
by looking at the ring maps $R \to R/I \to R'/I'$ and the module $M$.
\end{proof}

\noindent
Please compare the lemma below to
Lemma \ref{lemma-criterion-flatness-fibre-nilpotent}
(the case of a nilpotent ideal) and
Lemma \ref{lemma-criterion-flatness-fibre}
(the case of finitely presented algebras).

\begin{lemma}[Crit\`ere de platitude par fibres; Noetherian case]
\label{lemma-criterion-flatness-fibre-Noetherian}
Let $R$, $S$, $S'$ be Noetherian local rings and let $R \to S \to S'$
be local ring homomorphisms. Let $\mathfrak m \subset R$ be the
maximal ideal. Let $M$ be an $S'$-module. Assume
\begin{enumerate}
\item The module $M$ is finite over $S'$.
\item The module $M$ is not zero.
\item The module $M/\mathfrak m M$
is a flat $S/\mathfrak m S$-module.
\item The module $M$ is a flat $R$-module.
\end{enumerate}
Then $S$ is flat over $R$ and $M$ is a flat $S$-module.
\end{lemma}

\begin{proof}
Set $I = \mathfrak mS \subset S$. Then we see that $M/IM$ is a flat
$S/I$-module because of (3). Since
$\mathfrak m \otimes_R S' \to I \otimes_S S'$ is surjective we see
that also $\mathfrak m \otimes_R M \to I \otimes_S M$ is surjective.
Consider
$$
\mathfrak m \otimes_R M \to I \otimes_S M \to M.
$$
As $M$ is flat over $R$ the composition is injective
and so both arrows are injective.
In particular $\text{Tor}_1^S(S/I, M) = 0$ see
Remark \ref{remark-Tor-ring-mod-ideal}. By
Lemma \ref{lemma-variant-local-criterion-flatness} we conclude
that $M$ is flat over $S$. Note that since $M/\mathfrak m_{S'}M$
is not zero by Nakayama's Lemma \ref{lemma-NAK}
we see that actually $M$ is faithfully flat over $S$ by
Lemma \ref{lemma-ff} (since it forces $M/\mathfrak m_SM \not = 0$).

\medskip\noindent
Consider the exact sequence
$0 \to \mathfrak m \to R \to \kappa \to 0$.
This gives an exact sequence
$0 \to \text{Tor}_1^R(\kappa, S) \to \mathfrak m \otimes_R S \to I \to 0$.
Since $M$ is flat over $S$ this gives an exact sequence
$0 \to \text{Tor}_1^R(\kappa, S)\otimes_S M \to
\mathfrak m \otimes_R M \to I \otimes_S M \to 0$.
By the above this implies that $\text{Tor}_1^R(\kappa, S)\otimes_S M = 0$.
Since $M$ is faithfully flat over $S$ this implies that
$\text{Tor}_1^R(\kappa, S) = 0$ and we conclude that
$S$ is flat over $R$ by Lemma \ref{lemma-local-criterion-flatness}.
\end{proof}






\section{Base change and flatness}
\label{section-base-change-flat}

\noindent
Some lemmas which deal with what happens with flatness when
doing a base change.

\begin{lemma}
\label{lemma-base-change-flat-up-down}
Let
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
be a commutative diagram of local homomorphisms of local rings.
Assume that $S'$ is a localization of the tensor product $S \otimes_R R'$.
Let $M$ be an $S$-module and set $M' = S' \otimes_S M$.
\begin{enumerate}
\item If $M$ is flat over $R$ then $M'$ is flat over $R'$.
\item If $M'$ is flat over $R'$ and $R \to R'$ is flat then
$M$ is flat over $R$.
\end{enumerate}
In particular we have
\begin{enumerate}
\item[(3)] If $S$ is flat over $R$ then $S'$ is flat over $R'$.
\item[(4)] If $R' \to S'$ and $R \to R'$ are flat then $S$ is flat over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $M$ is flat over $R$, then $M \otimes_R R'$
is flat over $R'$ by
Lemma \ref{lemma-flat-base-change}.
If $W \subset S \otimes_R R'$ is the multiplicative subset such that
$W^{-1}(S \otimes_R R') = S'$ then $M' = W^{-1}(M \otimes_R R')$.
Hence $M'$ is flat over $R'$ as the localization of a flat module, see
Lemma \ref{lemma-flat-localization} part (5). This proves (1) and in
particular, we see that (3) holds.

\medskip\noindent
Proof of (2). Suppose that $M'$ is flat over $R'$ and $R \to R'$ is flat.
By (3) applied to the diagram reflected in the northwest diagonal
we see that $S \to S'$ is flat. Thus $S \to S'$ is faithfully flat by
Lemma \ref{lemma-local-flat-ff}.
We are going to use the criterion of
Lemma \ref{lemma-flat} (\ref{item-f-ideal})
to show that $M$ is flat.
Let $I \subset R$ be an ideal. If $I \otimes_R M \to M$ has a kernel,
so does $(I \otimes_R M) \otimes_S S' \to M \otimes_S S' = M'$.
Note that $I \otimes_R R' = IR'$ as $R \to R'$ is flat, and that
$$
(I \otimes_R M) \otimes_S S' =
(I \otimes_R R') \otimes_{R'} (M \otimes_S S') =
IR' \otimes_{R'} M'.
$$
From flatness of $M'$ over $R'$
we conclude that this maps injectively into $M'$.
This concludes the proof of (2), and hence (4) is true as well.
\end{proof}








\section{Flatness criteria over Artinian rings}
\label{section-flatness-artinian}

\noindent
We discuss some flatness criteria for modules over Artinian rings.
Note that an Artinian local ring has a nilpotent maximal ideal
so that the following two lemmas apply to Artinian local rings.

\begin{lemma}
\label{lemma-local-artinian-basis-when-flat}
Let $(R, \mathfrak m)$ be a local ring with nilpotent maximal ideal
$\mathfrak m$. Let $M$ be a flat $R$-module.
If $A$ is a set and $x_\alpha \in M$, $\alpha \in A$ is a collection
of elements of $M$, then the following are equivalent:
\begin{enumerate}
\item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis
for the vector space $M/\mathfrak mM$ over $R/\mathfrak m$, and
\item $\{x_\alpha\}_{\alpha \in A}$ forms a basis for $M$ over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is immediate.
We will prove the other implication by using induction on $n$ to show that
$\{x_\alpha\}_{\alpha \in A}$ forms a basis for
$M/\mathfrak m^nM$ over $R/\mathfrak m^n$. The case $n = 1$ holds by
assumption (1). Assume the statement holds for some $n \geq 1$. By
Nakayama's Lemma \ref{lemma-NAK}
the elements $x_\alpha$ generate $M$, in particular $M/\mathfrak m^{n + 1}M$.
The exact sequence
$0 \to \mathfrak m^n/\mathfrak m^{n + 1} \to R/\mathfrak m^{n + 1} \to
R/\mathfrak m^n \to 0$
gives on tensoring with $M$ the exact sequence
$$
0 \to \mathfrak m^nM/\mathfrak m^{n + 1}M \to
M/\mathfrak m^{n + 1}M \to
M/\mathfrak m^nM \to 0
$$
Here we are using that $M$ is flat.
Moreover, we have $\mathfrak m^nM/\mathfrak m^{n + 1}M =
M/\mathfrak mM \otimes_{R/\mathfrak m} \mathfrak m^n/\mathfrak m^{n + 1}$
by flatness of $M$ again.
Now suppose that $\sum f_\alpha x_\alpha = 0$ in $M/\mathfrak m^{n + 1}M$.
Then by induction hypothesis $f_\alpha \in \mathfrak m^n$ for each $\alpha$.
By the short exact sequence above we then conclude that
$\sum \overline{f}_\alpha \otimes \overline{x}_\alpha$ is zero in
$\mathfrak m^n/\mathfrak m^{n + 1} \otimes_{R/\mathfrak m} M/\mathfrak mM$.
Since $\overline{x}_\alpha$ forms a basis we conclude that each of the
congruence classes $\overline{f}_\alpha \in \mathfrak m^n/\mathfrak m^{n + 1}$
is zero and we win.
\end{proof}

\begin{lemma}
\label{lemma-local-artinian-characterize-flat}
Let $R$ be a local ring with nilpotent maximal ideal. Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is flat over $R$,
\item $M$ is a free $R$-module, and
\item $M$ is a projective $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Since any projective module is flat (as a direct summand of a free module)
and every free module is projective, it suffices to prove that a flat module
is free. Let $M$ be a flat module. Let $A$ be a set and let $x_\alpha \in M$,
$\alpha \in A$ be elements such that
$\overline{x_\alpha} \in M/\mathfrak m M$ forms a basis over the residue
field of $R$. By
Lemma \ref{lemma-local-artinian-basis-when-flat}
the $x_\alpha$ are a basis for $M$ over $R$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-lift-basis}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Let $A$ be a set and let $x_\alpha \in M$, $\alpha \in A$ be a collection
of elements of $M$.
Assume
\begin{enumerate}
\item $I$ is nilpotent,
\item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis for $M/IM$ over
$R/I$, and
\item $\text{Tor}_1^R(R/I, M) = 0$.
\end{enumerate}
Then $M$ is free on $\{x_\alpha\}_{\alpha \in A}$ over $R$.
\end{lemma}

\begin{proof}
Let $R$, $I$, $M$, $\{x_\alpha\}_{\alpha \in A}$ be as in the lemma
and satisfy assumptions (1), (2), and (3). By
Nakayama's Lemma \ref{lemma-NAK}
the elements $x_\alpha$ generate $M$ over $R$.
The assumption $\text{Tor}_1^R(R/I, M) = 0$ implies that we have a short
exact sequence
$$
0 \to I \otimes_R M \to M \to M/IM \to 0.
$$
Let $\sum f_\alpha x_\alpha = 0$ be a relation in $M$.
By choice of $x_\alpha$ we see that $f_\alpha \in I$.
Hence we conclude that $\sum f_\alpha \otimes x_\alpha = 0$ in
$I \otimes_R M$. The map $I \otimes_R M \to I/I^2 \otimes_{R/I} M/IM$
and the fact that $\{x_\alpha\}_{\alpha \in A}$ forms a basis
for $M/IM$ implies that $f_\alpha \in I^2$! Hence we conclude that
there are no relations among the images of the $x_\alpha$ in
$M/I^2M$. In other words, we see that $M/I^2M$ is free with basis
the images of the $x_\alpha$. Using the map
$I \otimes_R M \to I/I^3 \otimes_{R/I^2} M/I^2M$
we then conclude that $f_\alpha \in I^3$!
And so on. Since $I^n = 0$ for some $n$ by assumption (1) we win.
\end{proof}

\begin{lemma}
\label{lemma-prepare-lift-flatness}
Let $\varphi : R \to R'$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $M/IM$ is flat over $R/I$, and
\item $R' \otimes_R M$ is flat over $R'$.
\end{enumerate}
Set $I_2 = \varphi^{-1}(\varphi(I^2)R')$.
Then $M/I_2M$ is flat over $R/I_2$.
\end{lemma}

\begin{proof}
We may replace $R$, $M$, and $R'$ by $R/I_2$, $M/I_2M$, and
$R'/\varphi(I)^2R'$. Then $I^2 = 0$ and $\varphi$ is injective. By
Lemma \ref{lemma-what-does-it-mean}
and the fact that $I^2 = 0$ it suffices to prove that
$\text{Tor}^R_1(R/I, M) = K = \Ker(I \otimes_R M \to M)$ is zero.
Set $M' = M \otimes_R R'$ and $I' = IR'$.
By assumption the map $I' \otimes_{R'} M' \to M'$ is injective.
Hence $K$ maps to zero in
$$
I' \otimes_{R'} M' = I' \otimes_R M = I' \otimes_{R/I} M/IM.
$$
Then $I \to I'$ is an injective map of $R/I$-modules.
Since $M/IM$ is flat over $R/I$ the map
$$
I \otimes_{R/I} M/IM \longrightarrow I' \otimes_{R/I} M/IM
$$
is injective. This implies that $K$ is zero in
$I \otimes_R M = I \otimes_{R/I} M/IM$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-lift-flatness}
Let $\varphi : R \to R'$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $I$ is nilpotent,
\item $R \to R'$ is injective,
\item $M/IM$ is flat over $R/I$, and
\item $R' \otimes_R M$ is flat over $R'$.
\end{enumerate}
Then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Define inductively $I_1 = I$ and $I_{n + 1} = \varphi^{-1}(\varphi(I_n)^2R')$
for $n \geq 1$. Note that by
Lemma \ref{lemma-prepare-lift-flatness}
we find that $M/I_nM$ is flat over $R/I_n$ for each $n \geq 1$.
It is clear that $\varphi(I_n) \subset \varphi(I)^{2^n}R'$. Since
$I$ is nilpotent we see that $\varphi(I_n) = 0$ for some $n$. As
$\varphi$ is injective we conclude that $I_n = 0$ for some $n$ and
we win.
\end{proof}

\noindent
Here is the local Artinian version of the local criterion for flatness.

\begin{lemma}
\label{lemma-artinian-variant-local-criterion-flatness}
Let $R$ be an Artinian local ring. Let $M$ be an $R$-module.
Let $I \subset R$ be a proper ideal. The following are
equivalent
\begin{enumerate}
\item $M$ is flat over $R$, and
\item $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows immediately from the
definitions. Assume $M/IM$ is flat over $R/I$ and
$\text{Tor}_1^R(R/I, M) = 0$. By
Lemma \ref{lemma-local-artinian-characterize-flat}
this implies that $M/IM$ is free over $R/I$. Pick a set $A$
and elements $x_\alpha \in M$ such that the images in $M/IM$ form
a basis. By
Lemma \ref{lemma-lift-basis}
we conclude that $M$ is free and in particular flat.
\end{proof}

\noindent
It turns out that flatness descends along injective homomorphism
whose source is an Artinian ring.

\begin{lemma}
\label{lemma-descent-flatness-injective-map-artinian-rings}
Let $R \to S$ be a ring map. Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is Artinian
\item $R \to S$ is injective, and
\item $M \otimes_R S$ is a flat $S$-module.
\end{enumerate}
Then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
First proof: Let $I \subset R$ be the radical of $R$.
Then $I$ is nilpotent and $M/IM$ is flat over $R/I$ as $R/I$
is a product of fields, see
Section \ref{section-artinian}.
Hence $M$ is flat by an application of
Lemma \ref{lemma-lift-flatness}.

\medskip\noindent
Second proof: By
Lemma \ref{lemma-artinian-finite-length}
we may write $R = \prod R_i$ as a finite product of local Artinian
rings. This induces similar product decompositions for both $R$ and $S$.
Hence we reduce to the case where $R$ is local Artinian (details omitted).

\medskip\noindent
Assume that $R \to S$, $M$ are as in the lemma satisfying (1), (2), and (3)
and in addition that $R$ is local with maximal ideal $\mathfrak m$.
Let $A$ be a set and $x_\alpha \in A$ be elements such that
$\overline{x}_\alpha$ forms a basis for $M/\mathfrak mM$
over $R/\mathfrak m$. By
Nakayama's Lemma \ref{lemma-NAK}
we see that the elements $x_\alpha$ generate $M$ as an $R$-module.
Set $N = S \otimes_R M$ and $I = \mathfrak mS$.
Then $\{1 \otimes x_\alpha\}_{\alpha \in A}$ is a family of elements
of $N$ which form a basis for $N/IN$. Moreover, since $N$ is flat over
$S$ we have $\text{Tor}_1^S(S/I, N) = 0$. Thus we conclude from
Lemma \ref{lemma-lift-basis}
that $N$ is free on $\{1 \otimes x_\alpha\}_{\alpha \in A}$.
The injectivity of $R \to S$ then guarantees that there cannot be a
nontrivial relation among the $x_\alpha$ with coefficients in $R$.
\end{proof}

\noindent
Please compare the lemma below to
Lemma \ref{lemma-criterion-flatness-fibre-Noetherian}
(the case of Noetherian local rings),
Lemma \ref{lemma-criterion-flatness-fibre}
(the case of finitely presented algebras), and
Lemma \ref{lemma-criterion-flatness-fibre-locally-nilpotent}
(the case of locally nilpotent ideals).

\begin{lemma}[Crit\`ere de platitude par fibres: Nilpotent case]
\label{lemma-criterion-flatness-fibre-nilpotent}
Let
$$
\xymatrix{
S \ar[rr] & & S' \\
& R \ar[lu] \ar[ru]
}
$$
be a commutative diagram in the category of rings.
Let $I \subset R$ be a nilpotent ideal and $M$ an $S'$-module. Assume
\begin{enumerate}
\item The module $M/IM$ is a flat $S/IS$-module.
\item The module $M$ is a flat $R$-module.
\end{enumerate}
Then $M$ is a flat $S$-module and $S_{\mathfrak q}$ is flat over $R$
for every $\mathfrak q \subset S$ such that $M \otimes_S \kappa(\mathfrak q)$
is nonzero.
\end{lemma}

\begin{proof}
As $M$ is flat over $R$ tensoring with the short exact
sequence $0 \to I \to R \to R/I \to 0$ gives a short exact sequence
$$
0 \to I \otimes_R M \to M \to M/IM \to 0.
$$
Note that $I \otimes_R M \to IS \otimes_S M$ is surjective. Combined with
the above this means both maps in
$$
I \otimes_R M \to IS \otimes_S M \to M
$$
are injective. Hence $\text{Tor}_1^S(IS, M) = 0$ (see
Remark \ref{remark-Tor-ring-mod-ideal})
and we conclude that $M$ is a flat $S$-module by
Lemma \ref{lemma-what-does-it-mean}.
To finish we need to show that $S_{\mathfrak q}$ is flat over
$R$ for any prime $\mathfrak q \subset S$ such that
$M \otimes_S \kappa(\mathfrak q)$ is nonzero. This follows from
Lemma \ref{lemma-ff} and \ref{lemma-flat-permanence}.
\end{proof}








\section{What makes a complex exact?}
\label{section-complex-exact}

\noindent
Some of this material can be found in the paper \cite{WhatExact}
by Buchsbaum and Eisenbud.

\begin{situation}
\label{situation-complex}
Here $R$ is a ring, and we have a complex
$$
0
\to
R^{n_e}
\xrightarrow{\varphi_e}
R^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i + 1}}
R^{n_i}
\xrightarrow{\varphi_i}
R^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
R^{n_0}
$$
In other words we require $\varphi_i \circ \varphi_{i + 1} = 0$
for $i = 1, \ldots, e - 1$.
\end{situation}

\begin{lemma}
\label{lemma-add-trivial-complex}
In Situation \ref{situation-complex}.
Suppose $R$ is a local ring with maximal ideal $\mathfrak m$.
Suppose that for some $i$, $e \leq i \leq 1$
some matrix coefficient of the map $\varphi_i$ is invertible.
Then the complex $0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$
is isomorphic to the direct sum of a complex
$0 \to R^{n_e} \to \ldots \to R^{n_i - 1} \to
R^{n_{i-1} - 1} \to \ldots \to R^{n_0}$
and the complex $0 \to 0 \to \ldots \to R \to R \to 0 \to \ldots \to 0$
where the map $R \to R$ is the identity map.
\end{lemma}

\begin{proof}
The assumption means, after a change of basis of
$R^{n_i}$ and $R^{n_{i-1}}$ that the first basis
vector of $R^{n_i}$ is mapped via $\varphi_i$ to the first basis
vector of $R^{n_{i-1}}$. Let $e_j$ denote the
$j$th basis vector of $R^{n_i}$ and $f_k$ the $k$th
basis vector of $R^{n_{i-1}}$. Write $\varphi_i(e_j)
= \sum a_{jk} f_k$. So $a_{1k} = 0$ unless $k = 1$
and $a_{11} = 1$. Change basis on $R^{n_i}$ again
by setting $e'_j = e_j - a_{j1} e_1$ for $j > 1$.
After this change of coordinates we have $a_{j1} = 0$
for $j > 1$. Note the image
of $R^{n_{i + 1}} \to R^{n_i}$ is contained in the
subspace spanned by $e_j$, $j > 1$. Note also
that $R^{n_{i-1}} \to R^{n_{i-2}}$ has to annihilate
$f_1$ since it is in the image. These conditions
and the shape of the matrix $(a_{jk})$ for $\varphi_i$
imply the lemma.
\end{proof}

\noindent
Let us say that an acyclic complex of the form
$\ldots \to 0 \to R \to R \to 0 \to \ldots $
is {\it trivial}. The lemma above clearly says that
any finite complex of finite free modules over a local ring is up to direct
sums with trivial complexes the same as a complex
all of whose maps have all matrix coefficients in
the maximal ideal.

\begin{lemma}
\label{lemma-exact-artinian-local}
In Situation \ref{situation-complex}.
Let $R$ be a Artinian local ring.
Suppose that $0 \to R^{n_e} \to R^{n_{e-1}}
\to \ldots \to R^{n_0}$ is an exact complex.
Then the complex is isomorphic to a direct sum of
trivial complexes.
\end{lemma}

\begin{proof}
By induction on the integer $\sum n_i$.
Clearly $\text{Ass}(R) = \{\mathfrak m\}$.
Pick $x \in R$, $x \not = 0$, $\mathfrak m x = 0$.
Pick a basis vector $e_i \in R^{n_e}$.
Since $xe_i$ is not mapped to zero by
exactness of the complex we deduce that some matrix
coefficient of the map $R^{n_e} \to R^{n_{e-1}}$
is not in $\mathfrak m$.
Lemma \ref{lemma-add-trivial-complex} then allows
us to decrease $\sum n_i$.
\end{proof}

\noindent
Below we define the rank of a map of finite free modules.
This is just one possible definition of rank. It
is just the definition that works in this section; there
are others that may be more convenient in other settings.

\begin{definition}
\label{definition-rank}
Let $R$ be a ring. Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules.
\begin{enumerate}
\item The {\it rank} of $\varphi$ is the maximal $r$ such that
$\wedge^r \varphi : \wedge^r R^m \to \wedge^r R^n$ is nonzero.
\item We let $I(\varphi) \subset R$ be the ideal generated by
the $r \times r$ minors of the matrix of $\varphi$, where $r$
is the rank as defined above.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-trivial-case-exact}
In Situation \ref{situation-complex}, suppose the complex is
isomorphic to a direct sum of trivial complexes. Then
we have
\begin{enumerate}
\item the maps $\varphi_i$ have rank
$r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$,
\item for all $i$, $1 \leq i \leq e$ we have
$\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i) = n_i$,
\item each $I(\varphi_i) = R$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may assume the complex is the direct sum of trivial
complexes. Then for each $i$ we can split the standard basis
elements of $R^{n_i}$ into those that map to a basis element
of $R^{n_{i-1}}$ and those that are mapped to zero (and these
are mapped onto by basis elements of $R^{n_{i + 1}}$).
Using descending
induction starting with $i = e$ it is easy to prove that there
are $r_{i + 1}$-basis elements of $R^{n_i}$ which are mapped
to zero and $r_i$ which are mapped to basis elements of
$R^{n_{i-1}}$. From this the result follows.
\end{proof}

\begin{lemma}
\label{lemma-exact-length-1}
Let $R$ be a local Noetherian ring.
Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules. The following are equivalent
\begin{enumerate}
\item $\varphi$ is injective.
\item the rank of $\varphi$ is $m$ and
either $I(\varphi) = R$ or it contains a nonzerodivisor.
\end{enumerate}
\end{lemma}

\begin{proof}
If any matrix coefficient of $\varphi$ is not in $\mathfrak m$, then we apply
Lemma \ref{lemma-add-trivial-complex}
to write $\varphi$ as the sum of $1 : R \to R$ and a map
$\varphi' : R^{m-1} \to R^{n-1}$. It is easy to see that
the lemma for $\varphi'$ implies the lemma for $\varphi$.
Thus we may assume from the outset that all the matrix
coefficients of $\varphi$ are in $\mathfrak m$.

\medskip\noindent
Suppose $\varphi$ is injective. We may assume $m > 0$.
Let $\mathfrak q \in \text{Ass}(R)$. Let $x \in R$ be an element
whose annihilator is $\mathfrak q$. Note that $\varphi$
induces a injective map $xR^m \to xR^n$ which is isomorphic
to the map $\varphi_{\mathfrak q} : (R/\mathfrak q)^m \to (R/\mathfrak q)^n$
induced by $\varphi$. Since $R/\mathfrak q$ is a domain
we deduce immediately by localizing to its fraction field
that the rank of $\varphi_{\mathfrak q}$ is $m$ and that
$I(\varphi_{\mathfrak q})$ is not the zero ideal. Hence we
conclude by Lemma \ref{lemma-ideal-nonzerodivisor}.

\medskip\noindent
Conversely, assume that the rank of $\varphi$ is $m$
and that $I(\varphi)$ contains a nonzerodivisor $x$.
The rank being $m$ implies $n \geq m$. By
Lemma \ref{lemma-matrix-left-inverse}
we can find a map $\psi : R^n \to R^m$ such that
$\psi \circ \varphi = x \text{id}_{R^m}$. Thus $\varphi$
is injective.
\end{proof}

\begin{lemma}
\label{lemma-exact-depth-zero-local}
In Situation \ref{situation-complex}. Suppose $R$ is
a local Noetherian ring with maximal ideal $\mathfrak m$.
Assume $\mathfrak m \in \text{Ass}(R)$, in other words
$R$ has depth $0$. Suppose that the complex is exact.
In this case the complex is isomorphic to a direct sum of trivial
complexes.
\end{lemma}

\begin{proof}
The proof is the same as in Lemma \ref{lemma-exact-artinian-local}.
\end{proof}

\begin{lemma}
\label{lemma-div-x-exact-one-less}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring, and suppose that the complex
is exact. Let $x$ be an element of the maximal ideal
which is a nonzerodivisor. The complex
$0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$
is still exact.
\end{lemma}

\begin{proof}
Follows easily from the snake lemma.
\end{proof}

\begin{lemma}[Acyclicity lemma]
\label{lemma-acyclic}
Let $R$ be a local Noetherian ring.
Let $0 \to M_e \to M_{e-1} \to \ldots \to M_0$
be a complex of finite $R$-modules.
Assume $\text{depth}(M_i) \geq i$.
Let $i$ be the largest index such that the complex is
not exact at $M_i$. If $i > 0$ then
$\Ker(M_i \to M_{i-1})/\Im(M_{i + 1} \to M_i)$
has depth $\geq 1$.
\end{lemma}

\begin{proof}
Let $H = \Ker(M_i \to M_{i-1})/\Im(M_{i + 1} \to M_i)$ be the
cohomology group in question.
We may break the complex into short exact sequences
$0 \to M_e \to M_{e-1} \to K_{e-2} \to 0$,
$0 \to K_j \to M_j \to K_{j-1} \to 0$, for $i + 2 \leq j \leq e-2 $,
$0 \to K_{i + 1} \to M_{i + 1} \to B_i \to 0$,
$0 \to K_i \to M_i \to M_{i-1}$, and
$0 \to B_i \to K_i \to H \to 0$.
We proceed up through these complexes to
prove the statements about depths, repeatedly using
Lemma \ref{lemma-depth-in-ses}.
First of all, since $\text{depth}(M_e) \geq e$,
and $\text{depth}(M_{e-1}) \geq e-1$ we deduce
that $\text{depth}(K_{e-2}) \geq e - 1$. At this point the
sequences $0 \to K_j \to M_j \to K_{j-1} \to 0$ for $i + 2 \leq j \leq e-2 $
imply similarly that $\text{depth}(K_{j-1}) \geq j$ for
$i + 2 \leq j \leq e-2$. The sequence
$0 \to K_{i + 1} \to M_{i + 1} \to B_i \to 0$
then shows that $\text{depth}(B_i) \geq i + 1$. The sequence
$0 \to K_i \to M_i \to M_{i-1}$ shows that $\text{depth}(K_i) \geq 1$
since $M_i$ has depth $\geq i \geq 1$ by assumption.
The sequence $0 \to B_i \to K_i \to H \to 0$ then
implies the result.
\end{proof}

\begin{proposition}
\label{proposition-what-exact}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring. The complex is exact if and
only if for all $i$, $1 \leq i \leq e$
the following two conditions are satisfied:
\begin{enumerate}
\item we have $\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i)
= n_i$, and
\item $I(\varphi_i) = R$, or $I(\varphi_i)$ contains a
regular sequence of length $i$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is very similar to the proof of Lemma
\ref{lemma-exact-length-1}.
As in the proof of Lemma \ref{lemma-exact-length-1} we may assume
that all matrix entries of each $\varphi_i$ are elements of
the maximal ideal. We may also assume that $e \geq 1$.
Set $r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$.

\medskip\noindent
Assume the complex is exact. Let $\mathfrak q \in \text{Ass}(R)$.
Note that the ring $R_{\mathfrak q}$ has depth $0$
and that the complex remains exact after localization at $\mathfrak q$.
We apply Lemmas \ref{lemma-exact-depth-zero-local} and
\ref{lemma-trivial-case-exact} to the localized complex
over $R_{\mathfrak q}$. We conclude that
$\varphi_{i, \mathfrak q}$ has rank $r_i$ for all $i$.
Since $R \to \bigoplus_{\mathfrak q \in \text{Ass}(R)} R_\mathfrak q$
is injective (Lemma \ref{lemma-zero-at-ass-zero}), we conclude that
$\varphi_i$ has rank $r_i$ over $R$ by the definition of rank as given
in Definition \ref{definition-rank}. Therefore we see that
$I(\varphi_i)_\mathfrak q = I(\varphi_{i, \mathfrak q})$
as the ranks do not change. Since all of the ideals
$I(\varphi_i)_{\mathfrak q}$, $e \geq i \geq 1$
are equal to $R_{\mathfrak q}$ (by the lemmas referenced above)
we conclude none of the ideals $I(\varphi_i)$ is contained in $\mathfrak q$.
This implies that $I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$
is not contained in any of the associated primes
of $R$. By Lemma \ref{lemma-silly} we may choose
$x \in I(\varphi_e)I(\varphi_{e - 1})\ldots I(\varphi_1)$,
$x \not \in \mathfrak q$ for all $\mathfrak q \in \text{Ass}(R)$.
Observe that $x$ is a nonzerodivisor (Lemma \ref{lemma-ass-zero-divisors}).
According to Lemma \ref{lemma-div-x-exact-one-less}
the complex $0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$ is exact.
By induction
on $e$ all the ideals $I(\varphi_i)/xR$ have a regular
sequence of length $i - 1$. This proves that $I(\varphi_i)$
contains a regular sequence of length $i$.

\medskip\noindent
Assume the two conditions on the ranks of $\varphi_i$
and the ideals $I(\varphi_i)$ is satisfied. Note that
$I(\varphi_i) \subset \mathfrak m$ for all $i$ because
of what was said in the first paragraph of the proof.
Hence the assumption in particular implies that
$\text{depth}(R) \geq e$. By induction
on the dimension of $R$ we may assume the complex
is exact when localized at any nonmaximal prime of $R$.
Thus $\Ker(\varphi_i)/\Im(\varphi_{i + 1})$
has support $\{\mathfrak m\}$ and hence (if nonzero)
depth $0$. By Lemma \ref{lemma-acyclic} we see
that the complex is exact.
\end{proof}











\section{Cohen-Macaulay modules}
\label{section-CM}

\noindent
Here we show that Cohen-Macaulay modules have good properties. We postpone
using Ext groups to establish the connection with duality and so on.

\begin{definition}
\label{definition-CM}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
We say $M$ is {\it Cohen-Macaulay}
if $\dim(\text{Supp}(M)) = \text{depth}(M)$.
\end{definition}

\noindent
A first goal will be to establish Proposition \ref{proposition-CM-module}.
We do this by a (perhaps nonstandard) sequence of elementary lemmas
involving almost none of the earlier results on depth. Let us introduce
some notation.

\medskip\noindent
Let $R$ be a local Noetherian ring. Let $M$ be
a Cohen-Macaulay module, and let $f_1, \ldots, f_d$
be an $M$-regular sequence with $d = \dim(\text{Supp}(M))$.
We say that $g \in \mathfrak m$ is {\it good with respect to
$(M, f_1, \ldots, f_d)$} if for all $i = 0, 1, \ldots, d-1$
we have $\dim (\text{Supp}(M) \cap V(g, f_1, \ldots, f_i))
= d - i - 1$. This is equivalent to the condition that
$\dim(\text{Supp}(M/(f_1, \ldots, f_i)M) \cap V(g)) =
d - i - 1$ for $i = 0, 1, \ldots, d - 1$.

\begin{lemma}
\label{lemma-good-element}
Notation and assumptions as above. If $g$ is good with respect to
$(M, f_1, \ldots, f_d)$, then (a) $g$ is a nonzerodivisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay with maximal regular
sequence $f_1, \ldots, f_{d - 1}$.
\end{lemma}

\begin{proof}
We prove the lemma by induction on $d$.
If $d = 0$, then $M$ is finite and there is no case
to which the lemma applies.
If $d = 1$, then we have to show that $g : M \to M$ is
injective. The kernel $K$ has support $\{\mathfrak m\}$
because by assumption $\dim \text{Supp}(M) \cap V(g) = 0$.
Hence $K$ has finite length. Hence $f_1 : K \to K$ injective
implies the length of the image is the length of $K$, and hence
$f_1 K = K$, which by Nakayama's Lemma \ref{lemma-NAK} implies $K = 0$.
Also, $\dim \text{Supp}(M/gM) = 0$ and so $M/gM$ is Cohen-Macaulay
of depth $0$.

\medskip\noindent
Assume $d > 1$. Observe that $g$ is good for $(M/f_1M, f_2, \ldots, f_d)$,
as is easily seen from the definition. By induction, we have that
(a) $g$ is a nonzerodivisor on $M/f_1M$ and
(b) $M/(g, f_1)M$ is Cohen-Macaulay with maximal regular sequence
$f_2, \ldots, f_{d - 1}$. By
Lemma \ref{lemma-permute-xi}
we see that $g, f_1$ is an $M$-regular sequence.
Hence $g$ is a nonzerodivisor on $M$ and
$f_1, \ldots, f_{d - 1}$ is an $M/gM$-regular sequence.
\end{proof}

\begin{lemma}
\label{lemma-CM-one-g}
Let $R$ be a Noetherian local ring.
Let $M$ be a Cohen-Macaulay module over $R$.
Suppose $g \in \mathfrak m$ is such that $\dim(\text{Supp}(M) \cap V(g))
= \dim(\text{Supp}(M)) - 1$. Then (a) $g$ is a nonzerodivisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay of depth one less.
\end{lemma}

\begin{proof}
Choose a $M$-regular sequence $f_1, \ldots, f_d$ with
$d = \dim(\text{Supp}(M))$. If $g$ is is good with respect to
$(M, f_1, \ldots, f_d)$ we win by Lemma \ref{lemma-good-element}.
In particular the lemma holds if $d = 1$. (The case $d = 0$ does
not occur.) Assume $d > 1$. Choose an element $h \in R$ such that
(\romannumeral1) $h$ is good with respect to $(M, f_1, \ldots, f_d)$,
and (\romannumeral2) $\dim(\text{Supp}(M) \cap V(h, g)) = d - 2$.
To see $h$ exists, let $\{\mathfrak q_j\}$ be the (finite) set of
minimal primes of the closed sets $\text{Supp}(M)$,
$\text{Supp}(M)\cap V(f_1, \ldots, f_i)$, $i = 1, \ldots, d - 1$,
and $\text{Supp}(M) \cap V(g)$. None of these $\mathfrak q_j$
is equal to $\mathfrak m$ and hence we may find $h \in \mathfrak m$,
$h \not \in \mathfrak q_j$ by Lemma \ref{lemma-silly}. It is clear
that $h$ satisfies (\romannumeral1) and (\romannumeral2). From
Lemma \ref{lemma-good-element} we conclude that
$M/hM$ is Cohen-Macaulay. By (\romannumeral2) we see that the pair
$(M/hM, g)$ satisfies the induction hypothesis. Hence
$M/(h, g)M$ is Cohen-Macaulay and $g : M/hM \to M/hM$
is injective. By Lemma \ref{lemma-permute-xi} we see
that $g : M \to M$ and $h : M/gM \to M/gM$
are injective. Combined with the fact that $M/(g, h)M$
is Cohen-Macaulay this finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-CM-module}
Let $R$ be a Noetherian local ring, with maximal ideal $\mathfrak m$.
Let $M$ be a Cohen-Macaulay module over $R$ whose support has dimension $d$.
Suppose that $g_1, \ldots, g_c$ are elements of
$\mathfrak m$ such that $\dim(\text{Supp}(M/(g_1, \ldots, g_c)M))
= d - c$. Then $g_1, \ldots, g_c$ is an $M$-regular sequence,
and can be extended to a maximal $M$-regular sequence.
\end{proposition}

\begin{proof}
Let $Z = \text{Supp}(M) \subset \Spec(R)$.
By Lemma \ref{lemma-one-equation} in the chain
$Z \supset Z \cap V(g_1) \supset \ldots \supset Z \cap V(g_1, \ldots, g_c)$
each step decreases the dimension at most by $1$. Hence by assumption
each step decreases the dimension by exactly $1$ each time. Thus we
may successively apply Lemma \ref{lemma-CM-one-g} to the modules
$M/(g_1, \ldots, g_i)$ and the element $g_{i + 1}$.

\medskip\noindent
To extend $g_1, \ldots, g_c$ by one element if $c < d$ we simply
choose an element $g_{c + 1} \in \mathfrak m$ which is not
in any of the finitely many minimal primes of $Z \cap V(g_1, \ldots, g_c)$,
using Lemma \ref{lemma-silly}.
\end{proof}

\noindent
Having proved Proposition \ref{proposition-CM-module} we continue the
development of standard theory.

\begin{lemma}
\label{lemma-nonzerodivisor-on-CM}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module. Let $x \in \mathfrak m$ be a
nonzerodivisor on $M$. Then $M$ is Cohen-Macaulay if and only
if $M/xM$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-depth-drops-by-one} we have
$\text{depth}(M/xM) = \text{depth}(M)-1$.
By Lemma \ref{lemma-one-equation-module}
we have $\dim(\text{Supp}(M/xM)) = \dim(\text{Supp}(M)) - 1$.
\end{proof}

\begin{lemma}
\label{lemma-CM-over-quotient}
Let $R \to S$ be a surjective homomorphism of Noetherian local rings.
Let $N$ be a finite $S$-module. Then $N$ is Cohen-Macaulay as an $S$-module
if and only if $N$ is Cohen-Macaulay as an $R$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-CM-ass-minimal-support}
Let $R$ be a Noetherian local ring. Let $M$ be a finite Cohen-Macaulay
$R$-module. If $\mathfrak p \in \text{Ass}(M)$, then
$\dim(R/\mathfrak p) = \dim(\text{Supp}(M))$ and $\mathfrak p$
is a minimal prime in the support of $M$.
In particular, $M$ has no embedded associated primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-depth-dim-associated-primes} we have
$\text{depth}(M) \leq \dim(R/\mathfrak p)$.
Of course $\dim(R/\mathfrak p) \leq \dim(\text{Supp}(M))$
as $\mathfrak p \in \text{Supp}(M)$ (Lemma \ref{lemma-ass-support}).
Thus we have equality in both inequalities as $M$ is Cohen-Macaulay.
Then $\mathfrak p$ must be minimal in $\text{Supp}(M)$ otherwise
we would have $\dim(R/\mathfrak p) < \dim(\text{Supp}(M))$.
Finally, minimal primes in the support of $M$ are equal to
the minimal elements of $\text{Ass}(M)$
(Proposition \ref{proposition-minimal-primes-associated-primes})
hence $M$ has no embedded associated primes
(Definition \ref{definition-embedded-primes}).
\end{proof}

\begin{definition}
\label{definition-maximal-CM}
Let $R$ be a Noetherian local ring.
A finite module $M$ over $R$ is called a {\it maximal Cohen-Macaulay}
module if $\text{depth}(M) = \dim(R)$.
\end{definition}

\noindent
In other words, a maximal Cohen-Macaulay module over a Noetherian local
ring is a finite module with the largest possible depth over that ring.
Equivalently, a maximal Cohen-Macaulay module over a Noetherian local
ring $R$ is a Cohen-Macaulay module of dimension equal to the dimension
of the ring. In particular, if $M$ is a Cohen-Macaulay $R$-module with
$\Spec(R) = \text{Supp}(M)$, then $M$ is maximal Cohen-Macaulay.
Thus the following two lemmas are on maximal Cohen-Macaulay modules.

\begin{lemma}
\label{lemma-maximal-chain-maximal-CM}
Let $R$ be a Noetherian local ring. Assume there exists a
Cohen-Macaulay module $M$ with $\Spec(R) = \text{Supp}(M)$.
Then any maximal chain of ideals $\mathfrak p_0 \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
has length $n = \dim(R)$.
\end{lemma}

\begin{proof}
We will prove this by induction on $\dim(R)$. If $\dim(R) = 0$,
then the statement is clear. Assume $\dim(R) > 0$. Then $n > 0$.
Choose an element $x \in \mathfrak p_1$, with $x$ not in
any of the minimal primes of $R$, and in particular
$x \not \in \mathfrak p_0$. (See Lemma \ref{lemma-silly}.)
Then $\dim(R/xR) = \dim(R) - 1$ by Lemma \ref{lemma-one-equation}.
The module $M/xM$ is Cohen-Macaulay over $R/xR$ by
Proposition \ref{proposition-CM-module} and
Lemma \ref{lemma-CM-over-quotient}.
The support of $M/xM$ is $\Spec(R/xR)$ by
Lemma \ref{lemma-support-quotient}.
After replacing $x$ by $x^n$ for some $n$,
we may assume that $\mathfrak p_1$ is an associated prime of $M/xM$, see
Lemma \ref{lemma-inherit-minimal-primes}.
By Lemma \ref{lemma-CM-ass-minimal-support}
we conclude that $\mathfrak p_1/(x)$ is a minimal prime of $R/xR$.
It follows that  the chain
$\mathfrak p_1/(x) \subset \ldots \subset \mathfrak p_n/(x)$
is a maximal chain of primes in $R/xR$.
By induction we find that this chain
has length $\dim(R/xR) = \dim(R) - 1$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-dim-formula-maximal-CM}
Suppose $R$ is a Noetherian local ring. Assume there exists a
Cohen-Macaulay module $M$ with $\Spec(R) = \text{Supp}(M)$. Then for
a prime $\mathfrak p \subset R$ we have
$$
\dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p).
$$
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-maximal-chain-maximal-CM}.
\end{proof}

\begin{lemma}
\label{lemma-localize-CM-module}
Suppose $R$ is a Noetherian local ring. Let $M$ be a Cohen-Macaulay
module over $R$. For any prime $\mathfrak p \subset R$ the
module $M_{\mathfrak p}$ is Cohen-Macaulay over $R_\mathfrak p$.
\end{lemma}

\begin{proof}
Choose a maximal chain of primes $\mathfrak p = \mathfrak p_c \subset
\mathfrak p_{c - 1} \subset \ldots \subset \mathfrak p_1 \subset \mathfrak m$.
If we prove the result for $M_{\mathfrak p_1}$ over $R_{\mathfrak p_1}$,
then the lemma will follow by induction on $c$. Thus we may assume that
there is no prime strictly between $\mathfrak p$ and $\mathfrak m$.

\medskip\noindent
If $M_\mathfrak p = 0$, then the lemma holds. Assume
$M_\mathfrak p \not = 0$.
We have $\dim(\text{Supp}(M_\mathfrak p)) \leq \dim(\text{Supp}(M)) - 1$
as a chain of primes in the support of $M_\mathfrak p$ is a chain a primes in
the support of $M$ not including $\mathfrak m$. Thus it suffices to
show that the depth of $M_\mathfrak p$ is at least the depth of
$M$ minus $1$. We will prove by induction on the depth of $M$
that there exists an $M$-regular sequence
$f_1, \ldots, f_{\text{depth}(M) - 1}$ in $\mathfrak p$.
This will prove the lemma since localization at $\mathfrak p$ is exact.
Since $\text{depth}(M) = \dim((\text{Supp}(M))
\geq \dim(\text{Supp}(M_\mathfrak p)) + 1 \geq 1$
we see that the base case happens when the depth of $M$ is $1$
and this case is trivial. Assume the depth
of $M$ is at least $2$.

\medskip\noindent
Let $I \subset R$ be the annihilator of $M$ such that
$\Spec(R/I) = V(I) = \text{Supp}(M)$ (Lemma \ref{lemma-support-closed}).
By Lemmas \ref{lemma-CM-over-quotient} and
\ref{lemma-maximal-chain-maximal-CM}
every maximal chain of primes in $V(I)$ has length $\geq 2$.
Hence none of the minimal primes of $V(I)$ are equal to $\mathfrak p$.
Thus we can use Lemma \ref{lemma-silly}
to find a $f_1 \in \mathfrak p$ which is not contained in any
of the minimal primes of $V(I)$. Then $f_1$ is a nonzerodivisor
on $M$ and $M/f_1M$ has depth exactly one less by Lemma \ref{lemma-CM-one-g}.
By induction we can extend to an $M$-regular sequence
$f_1, \ldots, f_r \in \mathfrak p$ with $r = \text{depth}(M) - 1$
as desired.
\end{proof}

\begin{definition}
\label{definition-module-CM}
Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module.
We say $M$ is {\it Cohen-Macaulay} if $M_\mathfrak p$ is a Cohen-Macaulay
module over $R_\mathfrak p$ for all primes $\mathfrak p$ of $R$.
\end{definition}

\noindent
By Lemma \ref{lemma-localize-CM-module} it suffices to check this
in the maximal ideals of $R$.

\begin{lemma}
\label{lemma-maximal-CM-polynomial-algebra}
Let $R$ be a Noetherian ring. Let $M$ be a Cohen-Macaulay module
over $R$. Then $M \otimes_R R[x_1, \ldots, x_n]$ is a
Cohen-Macaulay module over $R[x_1, \ldots, x_n]$.
\end{lemma}

\begin{proof}
By induction on the number of variables it suffices to prove this for
$M[x] = M \otimes_R R[x]$ over $R[x]$. Let $\mathfrak m \subset R[x]$
be a maximal ideal, and let $\mathfrak p = R \cap \mathfrak m$.
Let $f_1, \ldots, f_d$ be a $M_\mathfrak p$-regular sequence in the maximal
ideal of $R_{\mathfrak p}$ of length $d = \dim(\text{Supp}(M_{\mathfrak p}))$.
Note that since $R[x]$ is flat over $R$ the localization
$R[x]_{\mathfrak m}$ is flat over $R_{\mathfrak p}$.
Hence, by Lemma \ref{lemma-flat-increases-depth}, the sequence
$f_1, \ldots, f_d$ is a $M[x]_{\mathfrak m}$-regular sequence of length $d$
in $R[x]_{\mathfrak m}$. The quotient
$$
Q = M[x]_{\mathfrak m}/(f_1, \ldots, f_d)M[x]_{\mathfrak m} =
M_{\mathfrak p}/(f_1, \ldots, f_d)M_{\mathfrak p}
\otimes_{R_\mathfrak p} R[x]_{\mathfrak m}
$$
has support equal to the primes lying over $\mathfrak p$
because $R_\mathfrak p \to R[x]_\mathfrak m$ is flat and
the support of $M_{\mathfrak p}/(f_1, \ldots, f_d)M_{\mathfrak p}$
is equal to $\{\mathfrak p\}$ (details omitted; hint: follows from
Lemmas \ref{lemma-annihilator-flat-base-change} and
\ref{lemma-support-closed}). Hence the dimension is $1$.
To finish the proof it suffices to find an $f \in \mathfrak m$
which is a nonzerodivisor on $Q$. Since $\mathfrak m$ is
a maximal ideal, the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak m)$
is finite (Theorem \ref{theorem-nullstellensatz}).
Hence we can find $f \in \mathfrak m$ which
viewed as a polynomial in $x$ has leading
coefficient not in $\mathfrak p$. Such an $f$ acts as
a nonzerodivisor on
$$
M_{\mathfrak p}/(f_1, \ldots, f_d)M_{\mathfrak p} \otimes_R R[x] =
\bigoplus\nolimits_{n \geq 0}
M_{\mathfrak p}/(f_1, \ldots, f_d)M_{\mathfrak p} \cdot x^n
$$
and hence acts as a nonzerodivisor on $Q$.
\end{proof}















\section{Cohen-Macaulay rings}
\label{section-CM-ring}

\noindent
Most of the results of this section are special cases of the results
in Section \ref{section-CM}.

\begin{definition}
\label{definition-local-ring-CM}
A Noetherian local ring $R$ is called {\it Cohen-Macaulay}
if it is Cohen-Macaulay as a module over itself.
\end{definition}

\noindent
Note that this is equivalent to requiring the existence
of a $R$-regular sequence $x_1, \ldots, x_d$ of the maximal
ideal such that $R/(x_1, \ldots, x_d)$ has dimension $0$.
We will usually just say ``regular sequence'' and not
``$R$-regular sequence''.

\begin{lemma}
\label{lemma-reformulate-CM}
\begin{slogan}
Regular sequences in Cohen-Macaulay local rings are characterized
by cutting out something of the correct dimension.
\end{slogan}
Let $R$ be a Noetherian local Cohen-Macaulay ring with maximal
ideal $\mathfrak m $. Let $x_1, \ldots, x_c \in \mathfrak m$ be
elements. Then
$$
x_1, \ldots, x_c
\text{ is a regular sequence }
\Leftrightarrow
\dim(R/(x_1, \ldots, x_c)) = \dim(R) - c
$$
If so
$x_1, \ldots, x_c$ can be extended to
a regular sequence of length $\dim(R)$ and each quotient
$R/(x_1, \ldots, x_i)$ is a Cohen-Macaulay ring of dimension
$\dim(R) - i$.
\end{lemma}

\begin{proof}
Special case of Proposition \ref{proposition-CM-module}.
\end{proof}

\begin{lemma}
\label{lemma-maximal-chain-CM}
Let $R$ be Noetherian local.
Suppose $R$ is Cohen-Macaulay of dimension $d$.
Any maximal chain of ideals $\mathfrak p_0 \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
has length $n = d$.
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-maximal-chain-maximal-CM}.
\end{proof}

\begin{lemma}
\label{lemma-CM-dim-formula}
Suppose $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
For any prime $\mathfrak p \subset R$ we have
$$
\dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p).
$$
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-maximal-chain-CM}.
(Also, this is a special case of Lemma \ref{lemma-dim-formula-maximal-CM}.)
\end{proof}

\begin{lemma}
\label{lemma-localize-CM}
Suppose $R$ is a Cohen-Macaulay local ring.
For any prime $\mathfrak p \subset R$ the
ring $R_{\mathfrak p}$ is Cohen-Macaulay as well.
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-localize-CM-module}.
\end{proof}

\begin{definition}
\label{definition-ring-CM}
A Noetherian ring $R$ is called {\it Cohen-Macaulay} if all
its local rings are Cohen-Macaulay.
\end{definition}

\begin{lemma}
\label{lemma-CM-polynomial-algebra}
Suppose $R$ is a Cohen-Macaulay ring.
Any polynomial algebra over $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-maximal-CM-polynomial-algebra}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-shift}
Let $R$ be a Noetherian local Cohen-Macaulay ring of dimension $d$.
Let $0 \to K \to R^{\oplus n} \to M \to 0$ be an exact sequence of
$R$-modules. Then either $\text{depth}(K) > \text{depth}(M)$
or $\text{depth}(K) = \text{depth}(M) = d$.
\end{lemma}

\begin{proof}
If $\text{depth}(M) = 0$ the lemma is clear.
Let $x \in \mathfrak m$ be a nonzerodivisor on $M$ and
on $R$. Then $x$ is a nonzerodivisor on $M$ and on $K$
and it follows by an easy diagram chase that
$0 \to K/xK \to (R/xR)^n \to M/xM \to 0$ is exact.
Thus the result follows from the result for $K/xK$
over $R/xR$ which has smaller dimension.
\end{proof}

\begin{lemma}
\label{lemma-mcm-resolution}
Let $R$ be a local Noetherian Cohen-Macaulay ring of dimension $d$.
Let $M$ be a finite $R$ module of depth $e$.
There exists an exact complex
$$
0 \to K \to F_{d-e-1} \to \ldots \to F_0 \to M \to 0
$$
with each $F_i$ finite free and $K$ maximal Cohen-Macaulay.
\end{lemma}

\begin{proof}
Immediate from the definition and Lemma \ref{lemma-dimension-shift}.
\end{proof}

\begin{lemma}
\label{lemma-find-sequence-image-regular}
Let $\varphi : A \to B$ be a map of local rings.
Assume that $B$ is Noetherian and Cohen-Macaulay and that
$\mathfrak m_B = \sqrt{\varphi(\mathfrak m_A) B}$. Then there exists
a sequence of elements $f_1, \ldots, f_{\dim(B)}$ in $A$
such that $\varphi(f_1), \ldots, \varphi(f_{\dim(B)})$ is a
regular sequence in $B$.
\end{lemma}

\begin{proof}
By induction on $\dim(B)$ it suffices to prove: If $\dim(B) \geq 1$, then we
can find an element $f$ of $A$ which maps to a nonzerodivisor in $B$.
By
Lemma \ref{lemma-reformulate-CM}
it suffices to find $f \in A$ whose image in $B$ is not contained in any
of the finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_r$
of $B$. By the assumption that
$\mathfrak m_B = \sqrt{\varphi(\mathfrak m_A) B}$
we see that $\mathfrak m_A \not \subset \varphi^{-1}(\mathfrak q_i)$.
Hence we can find $f$ by
Lemma \ref{lemma-silly}.
\end{proof}








\section{Catenary rings}
\label{section-catenary}

\begin{definition}
\label{definition-catenary}
A ring $R$ is said to be {\it catenary} if for any pair of prime ideals
$\mathfrak p \subset \mathfrak q$, all maximal chains of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset
\mathfrak p_e = \mathfrak q$ have the same (finite) length.
\end{definition}

\begin{lemma}
\label{lemma-catenary}
A ring $R$ is catenary if and only if the topological space
$\Spec(R)$ is catenary (see
Topology, Definition \ref{topology-definition-catenary}).
\end{lemma}

\begin{proof}
Immediate from the definition and the characterization of
irreducible closed subsets in Lemma \ref{lemma-irreducible}.
\end{proof}

\noindent
In general it is not the case that a finitely generated
$R$-algebra is catenary if $R$ is. Thus we make the following
definition.

\begin{definition}
\label{definition-universally-catenary}
A ring $R$ is said to be {\it universally catenary}
if $R$ is Noetherian and every $R$ algebra of finite
type is catenary.
\end{definition}

\noindent
By Lemma \ref{lemma-quotient-catenary}
this just means that $R$ is Noetherian
and that each polynomial algebra $R[x_1, \ldots, x_n]$
is catenary.

\begin{lemma}
\label{lemma-localization-catenary}
Any localization of a (universally) catenary ring is (universally) catenary.
\end{lemma}

\begin{proof}
Let $A$ be a ring and let $S \subset A$ be a multiplicative subset.
The description of $\Spec(S^{-1}A)$ in Lemma \ref{lemma-spec-localization}
shows that if $A$ is catenary, then so is $S^{-1}A$. If $S^{-1}A \to C$
is of finite type, then $C = S^{-1}B$ for some finite type ring map
$A \to B$. Hence if $A$ is universally catenary, then $B$ is catenary
and we see that $C$ is catenary too. Combined with
Lemma \ref{lemma-Noetherian-permanence} this proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-catenary-check-local}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ is catenary,
\item $R_\mathfrak p$ is catenary for all prime ideals $\mathfrak p$,
\item $R_\mathfrak m$ is catenary for all maximal ideals $\mathfrak m$.
\end{enumerate}
Assume $R$ is Noetherian. The following are equivalent
\begin{enumerate}
\item $R$ is universally catenary,
\item $R_\mathfrak p$ is universally catenary for all prime ideals
$\mathfrak p$,
\item $R_\mathfrak m$ is universally catenary for all maximal ideals
$\mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows from
Lemma \ref{lemma-localization-catenary} in both cases.
The implication (2) $\Rightarrow$ (3) is immediate in both cases.
Assume $R\mathfrak m$ is catenary for all maximal ideals
$\mathfrak m$ of $R$. If $\mathfrak p \subset \mathfrak q$ are primes
in $R$, then choose a maximal ideal $\mathfrak q \subset \mathfrak m$.
Chains of primes ideals between $\mathfrak p$ and $\mathfrak q$ are
in 1-to-1 correspondence with chains of prime ideals between
$\mathfrak pR_\mathfrak m$ and $\mathfrak qR_\mathfrak m$ hence we
see $R$ is catenary. Assume $R$ is Noetherian and $R_\mathfrak m$ is
universally catenary for all maximal ideals $\mathfrak m$ of $R$.
Let $R \to S$ be a finite type ring map. Let $\mathfrak q$ be a prime
ideal of $S$ lying over the prime $\mathfrak p \subset R$.
Choose a maximal ideal $\mathfrak p \subset \mathfrak m$ in $R$.
Then $R_\mathfrak p$ is a localization of $R_\mathfrak m$ hence
universally catenary by Lemma \ref{lemma-localization-catenary}.
Then $S_\mathfrak p$ is catenary as a finite type ring over $R_\mathfrak p$.
Hence $S_\mathfrak q$ is catenary as a localization. Thus $S$ is catenary
by the first case treated above.
\end{proof}

\begin{lemma}
\label{lemma-quotient-catenary}
Any quotient of a (universally) catenary ring is (universally) catenary.
\end{lemma}

\begin{proof}
Let $A$ be a ring and let $I \subset A$ be an ideal.
The description of $\Spec(A/I)$ in Lemma \ref{lemma-spec-closed}
shows that if $A$ is catenary, then so is $A/I$. If $A/I \to B$
is of finite type, then $A \to B$ is of finite type. Hence if $A$
is universally catenary, then $B$ is catenary. Combined with
Lemma \ref{lemma-Noetherian-permanence} this proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-catenary-check-irreducible}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item $R$ is catenary if and only if $R/\mathfrak p$ is catenary
for every minimal prime $\mathfrak p$.
\item $R$ is universally catenary if and only if $R/\mathfrak p$ is
universally catenary for every minimal prime $\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak a \subset \mathfrak b$ is an inclusion of primes of $R$,
then we can find a minimal prime $\mathfrak p \subset \mathfrak a$
and the first assertion is clear. We omit the proof of the second.
\end{proof}

\begin{lemma}
\label{lemma-CM-ring-catenary}
A Cohen-Macaulay ring is universally catenary.
More generally, if $R$ is a Noetherian ring and $M$ is
a Cohen-Macaulay $R$-module with $\text{Supp}(M) = \Spec(R)$,
then $R$ is universally catenary.
\end{lemma}

\begin{proof}
Since a polynomial algebra over $R$ is Cohen-Macaulay,
by Lemma \ref{lemma-CM-polynomial-algebra},
it suffices to show that a Cohen-Macaulay ring is
catenary.
Let $R$ be Cohen-Macaulay and $\mathfrak p \subset \mathfrak q$
primes of $R$. By definition $R_{\mathfrak q}$ and
$R_{\mathfrak p}$ are Cohen-Macaulay.
Take a maximal chain of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset
\ldots \subset \mathfrak p_n = \mathfrak q$.
Next choose a maximal chain of primes
$\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset
\mathfrak q_m = \mathfrak p$. By
Lemma \ref{lemma-maximal-chain-CM}
we have $n + m = \dim(R_{\mathfrak q})$. And we have
$m = \dim(R_{\mathfrak p})$ by the same lemma.
Hence $n = \dim(R_{\mathfrak q}) - \dim(R_{\mathfrak p})$
is independent of choices.

\medskip\noindent
To prove the more general statement, argue exactly as above but
using Lemmas \ref{lemma-maximal-CM-polynomial-algebra}
and \ref{lemma-maximal-chain-maximal-CM}.
\end{proof}















\section{Regular local rings}
\label{section-regular}

\noindent
It is not that easy to show that all prime localizations of a regular local
ring are regular. In fact, quite a bit of the material developed so far is
geared towards a proof of this fact. See
Proposition \ref{proposition-finite-gl-dim-regular}, and
trace back the references.

\begin{lemma}
\label{lemma-regular-graded}
Let $R$ be a regular local ring with maximal ideal $\mathfrak m$.
The graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n + 1}$
is isomorphic to the graded polynomial algebra
$\kappa(\mathfrak m)[X_1, \ldots, X_d]$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$. By
Definition \ref{definition-regular-local} this implies that
$\dim (R) = d$. Write $\kappa = \kappa(\mathfrak m)$.
There is a surjection $\kappa[X_1, \ldots, X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$,
which maps the class of $x_i$ in $\mathfrak m/\mathfrak m^2$
to $X_i$. Since $d(R) = d$ by
Proposition \ref{proposition-dimension}
we know that the numerical
polynomial $n \mapsto \dim_\kappa \mathfrak m^n/\mathfrak m^{n + 1}$
has degree $d - 1$. By Lemma \ref{lemma-quotient-smaller-d} we
conclude that the surjection $\kappa[X_1, \ldots, X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-regular-domain}
Any regular local ring is a domain.
\end{lemma}

\begin{proof}
We will use that $\bigcap \mathfrak m^n = 0$
by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Let $f, g \in R$ such that $fg = 0$.
Suppose that $f \in \mathfrak m^a$ and
$g \in \mathfrak m^b$, with $a, b$ maximal.
Since $fg = 0 \in \mathfrak m^{a + b + 1}$
we see from the result of Lemma \ref{lemma-regular-graded}
that either $f \in \mathfrak m^{a + 1}$ or
$g \in \mathfrak m^{b + 1}$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-regular-ring-CM}
Let $R$ be a regular local ring and let
$x_1, \ldots, x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$. Then
$x_1, \ldots, x_d$ is a regular sequence, and
each $R/(x_1, \ldots, x_c)$ is a regular local ring
of dimension $d - c$. In particular $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
Note that $R/x_1R$ is a Noetherian local ring of dimension $\geq d - 1$
by Lemma \ref{lemma-one-equation} with $x_2, \ldots, x_d$
generating the maximal ideal. Hence it is a regular local ring by definition.
Since $R$ is a domain by Lemma \ref{lemma-regular-domain}
$x_1$ is a nonzerodivisor.
\end{proof}

\begin{lemma}
\label{lemma-regular-quotient-regular}
Let $R$ be a regular local ring. Let $I \subset R$ be an ideal
such that $R/I$ is a regular local ring as well. Then
there exists a minimal set of generators $x_1, \ldots, x_d$
for the maximal ideal $\mathfrak m$ of $R$ such that
$I = (x_1, \ldots, x_c)$ for some $0 \leq c \leq d$.
\end{lemma}

\begin{proof}
Say $\dim(R) = d$ and $\dim(R/I) = d - c$.
Denote $\overline{\mathfrak m} = \mathfrak m/I$ the
maximal ideal of $R/I$. Let $\kappa = R/\mathfrak m$. We have
$$
\dim_\kappa((I + \mathfrak m^2)/\mathfrak m^2) =
\dim_\kappa(\mathfrak m/\mathfrak m^2)
- \dim(\overline{\mathfrak m}/\overline{\mathfrak m}^2) = d - (d - c) = c
$$
by the definition of a regular local ring. Hence we can choose
$x_1, \ldots, x_c \in I$ whose images in $\mathfrak m/\mathfrak m^2$
are linearly independent and supplement with
$x_{c + 1}, \ldots, x_d$ to get a minimal system of generators of
$\mathfrak m$. The induced map $R/(x_1, \ldots, x_c) \to R/I$ is a
surjection between regular local rings of the same dimension
(Lemma \ref{lemma-regular-ring-CM}). It follows that
the kernel is zero, i.e., $I = (x_1, \ldots, x_c)$. Namely, if not
then we would have $\dim(R/I) < \dim(R/(x_1, \ldots, x_c))$ by
Lemmas \ref{lemma-regular-domain} and \ref{lemma-one-equation}.
\end{proof}

\begin{lemma}
\label{lemma-free-mod-x}
Let $R$ be a Noetherian local ring.
Let $x \in \mathfrak m$.
Let $M$ be a finite $R$-module such that
$x$ is a nonzerodivisor on $M$ and
$M/xM$ is free over $R/xR$.
Then $M$ is free over $R$.
\end{lemma}

\begin{proof}
Let $m_1, \ldots, m_r$ be elements of $M$ which map to
a $R/xR$-basis of $M/xM$. By Nakayama's Lemma \ref{lemma-NAK}
$m_1, \ldots, m_r$ generate $M$. If $\sum a_i m_i = 0$
is a relation, then $a_i \in xR$ for all $i$. Hence
$a_i = b_i x$ for some $b_i \in R$. Hence
the kernel $K$ of $R^r \to M$ satisfies $xK = K$
and hence is zero by Nakayama's lemma.
\end{proof}

\begin{lemma}
\label{lemma-regular-mcm-free}
Let $R$ be a regular local ring.
Any maximal Cohen-Macaulay module over $R$ is free.
\end{lemma}

\begin{proof}
Let $M$ be a maximal Cohen-Macaulay module over $R$.
Let $x \in \mathfrak m$ be part of a regular sequence
generating $\mathfrak m$. Then $x$ is a nonzerodivisor
on $M$ by Proposition \ref{proposition-CM-module}, and
$M/xM$ is a maximal Cohen-Macaulay module over $R/xR$.
By induction on $\dim(R)$ we see that $M/xM$ is free.
We win by Lemma \ref{lemma-free-mod-x}.
\end{proof}

\begin{lemma}
\label{lemma-regular-mod-x}
Suppose $R$ is a Noetherian local ring.
Let $x \in \mathfrak m$ be a nonzerodivisor
such that $R/xR$ is a regular local ring. Then $R$ is a regular local ring.
More generally, if $x_1, \ldots, x_r$ is a regular sequence in $R$
such that $R/(x_1, \ldots, x_r)$ is a regular local ring, then
$R$ is a regular local ring.
\end{lemma}

\begin{proof}
This is true because $x$ together with the lifts of a system
of minimal generators of the maximal ideal of $R/xR$ will give
$\dim(R)$ generators of $\mathfrak m$.
Use Lemma \ref{lemma-one-equation}.
The last statement follows from the first and induction.
\end{proof}

\begin{lemma}
\label{lemma-colimit-regular}
Let $(R_i, \varphi_{ii'})$ be a directed system of local rings whose
transition maps are local ring maps. If each $R_i$ is a regular local ring and
$R = \colim R_i$ is Noetherian, then $R$ is a regular local ring.
\end{lemma}

\begin{proof}
Let $\mathfrak m \subset R$ be the maximal ideal; it is the colimit
of the maximal ideal $\mathfrak m_i \subset R_i$.
We prove the lemma by induction on $d = \dim \mathfrak m/\mathfrak m^2$.
If $d = 0$, then $R = R/\mathfrak m$ is a field and $R$ is a regular local ring.
If $d > 0$ pick an $x \in \mathfrak m$, $x \not \in \mathfrak m^2$.
For some $i$ we can find an $x_i \in \mathfrak m_i$ mapping to $x$.
Note that $R/xR = \colim_{i' \geq i} R_{i'}/x_iR_{i'}$ is a Noetherian
local ring. By
Lemma \ref{lemma-regular-ring-CM}
we see that $R_{i'}/x_iR_{i'}$ is a regular local ring.
Hence by induction we see
that $R/xR$ is a regular local ring. Since each $R_i$ is a domain
(Lemma \ref{lemma-regular-graded}) we see that $R$ is a domain.
Hence $x$ is a nonzerodivisor and we conclude that $R$ is
a regular local ring by Lemma \ref{lemma-regular-mod-x}.
\end{proof}





\section{Epimorphisms of rings}
\label{section-epimorphism}

\noindent
In any category there is a notion of an {\it epimorphism}.
Some of this material is taken from \cite{Autour} and \cite{Mazet}.

\begin{lemma}
\label{lemma-epimorphism}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is an epimorphism,
\item the two ring maps $S \to S \otimes_R S$ are equal,
\item either of the ring maps $S \to S \otimes_R S$ is an isomorphism, and
\item the ring map $S \otimes_R S \to S$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-epimorphism}
The composition of two epimorphisms of rings is an epimorphism.
\end{lemma}

\begin{proof}
Omitted. Hint: This is true in any category.
\end{proof}

\begin{lemma}
\label{lemma-base-change-epimorphism}
If $R \to S$ is an epimorphism of rings and $R \to R'$ is any ring map,
then $R' \to R' \otimes_R S$ is an epimorphism.
\end{lemma}

\begin{proof}
Omitted. Hint: True in any category with pushouts.
\end{proof}

\begin{lemma}
\label{lemma-permanence-epimorphism}
If $A \to B \to C$ are ring maps and $A \to C$ is an epimorphism, so is
$B \to C$.
\end{lemma}

\begin{proof}
Omitted. Hint: This is true in any category.
\end{proof}

\noindent
This means in particular, that if $R \to S$ is an epimorphism with
image $\overline{R} \subset S$, then $\overline{R} \to S$ is an epimorphism.
Hence while proving results for epimorphisms we may often assume
the map is injective. The following lemma means in particular that
every localization is an epimorphism.

\begin{lemma}
\label{lemma-epimorphism-local}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item $R \to S$ is an epimorphism, and
\item $R_{\mathfrak p} \to S_{\mathfrak p}$ is an epimorphism for
each prime $\mathfrak p$ of $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $S_{\mathfrak p} = R_{\mathfrak p} \otimes_R S$ (see
Lemma \ref{lemma-tensor-localization})
we see that (1) implies (2) by
Lemma \ref{lemma-base-change-epimorphism}.
Conversely, assume that (2) holds. Let $a, b : S \to A$ be two ring maps
from $S$ to a ring $A$ equalizing the map $R \to S$. By assumption we see
that for every prime $\mathfrak p$ of $R$ the induced maps
$a_{\mathfrak p}, b_{\mathfrak p} : S_{\mathfrak p} \to A_{\mathfrak p}$ are
the same. Hence $a = b$ as $A \subset \prod_{\mathfrak p} A_{\mathfrak p}$, see
Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-finite-epimorphism-surjective}
\begin{slogan}
A ring map is surjective if and only if it is a finite epimorphism.
\end{slogan}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is an epimorphism and finite, and
\item $R \to S$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
(This lemma seems to have been reproved many times in the literature, and
has many different proofs.)
It is clear that a surjective ring map is an epimorphism.
Suppose that $R \to S$ is a finite ring map such that
$S \otimes_R S \to S$ is an isomorphism. Our goal is to show that
$R \to S$ is surjective. Assume $S/R$ is not zero.
The exact sequence $R \to S \to S/R \to 0$
leads to an exact sequence
$$
R \otimes_R S \to S \otimes_R S \to S/R \otimes_R S \to 0.
$$
Our assumption implies that the first arrow is an isomorphism, hence
we conclude that $S/R \otimes_R S = 0$. Hence also $S/R \otimes_R S/R = 0$. By
Lemma \ref{lemma-trivial-filter-finite-module}
there exists a surjection of $R$-modules $S/R \to R/I$ for some proper
ideal $I \subset R$. Hence there exists a
surjection $S/R \otimes_R S/R \to R/I \otimes_R R/I = R/I \not = 0$,
contradiction.
\end{proof}

\begin{lemma}
\label{lemma-faithfully-flat-epimorphism}
A faithfully flat epimorphism is an isomorphism.
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-epimorphism} part (3)
as the map $S \to S \otimes_R S$ is the map $R \to S$ tensored with $S$.
\end{proof}

\begin{lemma}
\label{lemma-epimorphism-over-field}
If $k \to S$ is an epimorphism and $k$ is a field, then $S = k$ or $S = 0$.
\end{lemma}

\begin{proof}
This is clear from the result of
Lemma \ref{lemma-faithfully-flat-epimorphism}
(as any nonzero algebra over $k$ is faithfully flat), or
by arguing directly that $R \to R \otimes_k R$ cannot be
surjective unless $\dim_k(R) \leq 1$.
\end{proof}

\begin{lemma}
\label{lemma-epimorphism-injective-spec}
Let $R \to S$ be an epimorphism of rings. Then
\begin{enumerate}
\item $\Spec(S) \to \Spec(R)$ is injective, and
\item for $\mathfrak q \subset S$ lying over $\mathfrak p \subset R$
we have $\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $R$. The fibre of the map is the spectrum
of the fibre ring $S \otimes_R \kappa(\mathfrak p)$. By
Lemma \ref{lemma-base-change-epimorphism}
the map $\kappa(\mathfrak p) \to S \otimes_R \kappa(\mathfrak p)$
is an epimorphism, and hence by
Lemma \ref{lemma-epimorphism-over-field}
we have either $S \otimes_R \kappa(\mathfrak p) = 0$
or $S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)$
which proves (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-relations}
Let $R$ be a ring.
Let $M$, $N$ be $R$-modules.
Let $\{x_i\}_{i \in I}$ be a set of generators of $M$.
Let $\{y_j\}_{j \in J}$ be a set of generators of $N$.
Let $\{m_j\}_{j \in J}$ be a family of elements of $M$ with $m_j = 0$
for all but finitely many $j$.
Then
$$
\sum\nolimits_{j \in J} m_j \otimes y_j = 0 \text{ in } M \otimes_R N
$$
is equivalent to the following:
There exist $a_{i, j} \in R$ with $a_{i, j} = 0$ for all but finitely many
pairs $(i, j)$ such that
\begin{align*}
m_j & = \sum\nolimits_{i \in I} a_{i, j} x_i \quad\text{for all } j \in J, \\
0 & = \sum\nolimits_{j \in J} a_{i, j} y_j \quad\text{for all } i \in I.
\end{align*}
\end{lemma}

\begin{proof}
The sufficiency is immediate. Suppose that
$\sum_{j \in J} m_j \otimes y_j = 0$.
Consider the short exact sequence
$$
0 \to K \to \bigoplus\nolimits_{j \in J} R \to N \to 0
$$
where the $j$th basis vector of $\bigoplus\nolimits_{j \in J} R$ maps
to $y_j$. Tensor this with $M$ to get the exact sequence
$$
K \otimes_R M \to \bigoplus\nolimits_{j \in J} M \to N \otimes_R M \to 0.
$$
The assumption implies that there exist elements $k_i \in K$ such that
$\sum k_i \otimes x_i$ maps to the element $(m_j)_{j \in J}$ of the middle.
Writing $k_i = (a_{i, j})_{j \in J}$ and we obtain what we want.
\end{proof}

\begin{lemma}
\label{lemma-kernel-difference-projections}
Let $\varphi : R \to S$ be a ring map.
Let $g \in S$. The following are equivalent:
\begin{enumerate}
\item $g \otimes 1 = 1 \otimes g$ in $S \otimes_R S$, and
\item there exist $n \geq 0$ and elements $y_i, z_j \in S$
and $x_{i, j} \in R$ for $1 \leq i, j \leq n$ such that
\begin{enumerate}
\item $g = \sum_{i, j \leq n} x_{i, j} y_i z_j$,
\item for each $j$ we have $\sum x_{i, j}y_i \in \varphi(R)$, and
\item for each $i$ we have $\sum x_{i, j}z_j \in \varphi(R)$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1). Conversely, suppose that
$g \otimes 1 = 1 \otimes g$. Choose generators $\{s_i\}_{i \in I}$
of $S$ as an $R$-module with $0, 1 \in I$ and $s_0 = 1$ and $s_1 = g$.
Apply
Lemma \ref{lemma-relations}
to the relation $g \otimes s_0 + (-1) \otimes s_1 = 0$.
We see that there exist $a_{i, j} \in R$ such that
$g = \sum_i a_{i, 0} s_i$, $-1 = \sum_i a_{i, 1} s_i$, and for
$j \not = 0, 1$ we have $0 = \sum_i a_{i, j} s_i$, and moreover
for all $i$ we have $\sum_j a_{i, j}s_j = 0$.
Then we have
$$
\sum\nolimits_{i, j \not = 0} a_{i, j} s_i s_j = -g + a_{0, 0}
$$
and for each $j \not = 0$ we have
$\sum_{i \not = 0} a_{i, j}s_i \in R$. This proves that $-g + a_{0, 0}$
can be written as in (2). It follows that $g$ can be written as
in (2). Details omitted.
Hint: Show that the set of elements of $S$ which have an
expression as in (2) form an $R$-subalgebra of $S$.
\end{proof}

\begin{remark}
\label{remark-matrices-associated-to-elements-epicenter}
Let $R \to S$ be a ring map. Sometimes the set of elements
$g \in S$ such that $g \otimes 1 = 1 \otimes g$ is called the
{\it epicenter} of $S$. It is an $R$-algebra. By the construction of
Lemma \ref{lemma-kernel-difference-projections}
we get for each $g$ in the epicenter a matrix factorization
$$
(g) = Y X Z
$$
with $X \in \text{Mat}(n \times n, R)$,
$Y \in \text{Mat}(1 \times n, S)$, and
$Z \in \text{Mat}(n \times 1, S)$. Namely, let $x_{i, j}, y_i, z_j$
be as in part (2) of the lemma. Set $X = (x_{i, j})$, let $y$ be the
row vector whose entries are the $y_i$ and let $z$ be the column vector
whose entries are the $z_j$. With this notation conditions (b) and (c) of
Lemma \ref{lemma-kernel-difference-projections}
mean exactly that $Y X \in \text{Mat}(1 \times n, R)$,
$X Z \in \text{Mat}(n \times 1, R)$.
It turns out to be very convenient to consider the triple of
matrices $(X, YX, XZ)$. Given $n \in \mathbf{N}$ and a triple
$(P, U, V)$ we say that $(P, U, V)$ is a {\it $n$-triple associated to $g$}
if there exists a matrix factorization as above such that
$P = X$, $U = YX$ and $V = XZ$.
\end{remark}

\begin{lemma}
\label{lemma-epimorphism-cardinality}
Let $R \to S$ be an epimorphism of rings.
Then the cardinality of $S$ is at most the cardinality of $R$.
In a formula: $|S| \leq |R|$.
\end{lemma}

\begin{proof}
The condition that $R \to S$ is an epimorphism means that each $g \in S$
satisfies $g \otimes 1 = 1 \otimes g$, see
Lemma \ref{lemma-epimorphism}.
We are going to use the notation introduced in
Remark \ref{remark-matrices-associated-to-elements-epicenter}.
Suppose that $g, g' \in S$ and suppose that $(P, U, V)$ is an $n$-triple
which is associated to both $g$ and $g'$. Then we claim that
$g = g'$. Namely, write $(P, U, V) = (X, YX, XZ)$ for a matrix
factorization $(g) = YXZ$ of $g$ and write $(P, U, V) = (X', Y'X', X'Z')$
for a matrix factorization $(g') = Y'X'Z'$ of $g'$.
Then we see that
$$
(g) = YXZ = UZ = Y'X'Z = Y'PZ = Y'XZ = Y'V = Y'X'Z' = (g')
$$
and hence $g = g'$. This implies that the cardinality of $S$ is bounded
by the number of possible triples, which has cardinality at most
$\sup_{n \in \mathbf{N}} |R|^n$. If $R$ is infinite then this is
at most $|R|$, see \cite[Ch. I, 10.13]{Kunen}.

\medskip\noindent
If $R$ is a finite ring then the argument above only proves that $S$
is at worst countable. In fact in this case $R$ is Artinian and the
map $R \to S$ is surjective. We omit the proof of this case.
\end{proof}

\begin{lemma}
\label{lemma-epimorphism-modules}
Let $R \to S$ be an epimorphism of rings. Let $N_1, N_2$ be $S$-modules.
Then $\Hom_S(N_1, N_2) = \Hom_R(N_1, N_2)$. In other words, the
restriction functor $\text{Mod}_S \to \text{Mod}_R$ is fully faithful.
\end{lemma}

\begin{proof}
Let $\varphi : N_1 \to N_2$ be an $R$-linear map. For any $x \in N_1$
consider the map $S \otimes_R S \to N_2$ defined by the rule
$g \otimes g' \mapsto g\varphi(g'x)$. Since both maps $S \to S \otimes_R S$
are isomorphisms (Lemma \ref{lemma-epimorphism}), we conclude that
$g \varphi(g'x) = gg'\varphi(x) = \varphi(gg' x)$. Thus $\varphi$
is $S$-linear.
\end{proof}



\section{Pure ideals}
\label{section-pure-ideals}

\noindent
The material in this section is discussed in many papers, see for example
\cite{Lazard}, \cite{Bkouche}, and \cite{DeMarco}.

\begin{definition}
\label{definition-pure-ideal}
Let $R$ be a ring. We say that $I \subset R$ is {\it pure}
if the quotient ring $R/I$ is flat over $R$.
\end{definition}

\begin{lemma}
\label{lemma-pure}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
The following are equivalent:
\begin{enumerate}
\item $I$ is pure,
\item for every ideal $J \subset R$ we have $J \cap I = IJ$,
\item for every finitely generated ideal $J \subset R$ we have
$J \cap I = JI$,
\item for every $x \in R$ we have $(x) \cap I = xI$,
\item for every $x \in I$ we have $x = yx$ for some $y \in I$,
\item for every $x_1, \ldots, x_n \in I$ there exists a
$y \in I$ such that $x_i = yx_i$ for all $i = 1, \ldots, n$,
\item for every prime $\mathfrak p$ of $R$ we have
$IR_{\mathfrak p} = 0$ or $IR_{\mathfrak p} = R_{\mathfrak p}$,
\item $\text{Supp}(I) = \Spec(R) \setminus V(I)$,
\item $I$ is the kernel of the map $R \to (1 + I)^{-1}R$,
\item $R/I \cong S^{-1}R$ as $R$-algebras for some multiplicative
subset $S$ of $R$, and
\item $R/I \cong (1 + I)^{-1}R$ as $R$-algebras.
\end{enumerate}
\end{lemma}

\begin{proof}
For any ideal $J$ of $R$ we have the short exact sequence
$0 \to J \to R \to R/J \to 0$. Tensoring with $R/I$ we get
an exact sequence $J \otimes_R R/I \to R/I \to R/I + J \to 0$
and $J \otimes_R R/I = R/JI$. Thus the
equivalence of (1), (2), and (3) follows from
Lemma \ref{lemma-flat}. Moreover, these imply (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (5) is trivial.
Assume (5) and let $x_1, \ldots, x_n \in I$.
Choose $y_i \in I$ such that $x_i = y_ix_i$.
Let $y \in I$ be the element such that
$1 - y = \prod_{i = 1, \ldots, n} (1 - y_i)$.
Then $x_i = yx_i$ for all $i = 1, \ldots, n$.
Hence (6) holds, and it follows that (5) $\Leftrightarrow$ (6).

\medskip\noindent
Assume (5). Let $x \in I$. Then $x = yx$ for some $y \in I$.
Hence $x(1 - y) = 0$, which shows that $x$ maps to zero in
$(1 + I)^{-1}R$. Of course the kernel of the map
$R \to (1 + I)^{-1}R$ is always contained in $I$. Hence we
see that (5) implies (9). Assume (9). Then for any $x \in I$
we see that $x(1 - y) = 0$ for some $y \in I$.
In other words, $x = yx$. We conclude that (5) is equivalent to (9).

\medskip\noindent
Assume (5). Let $\mathfrak p$ be a prime of $R$.
If $\mathfrak p \not \in V(I)$, then $IR_{\mathfrak p} = R_{\mathfrak p}$.
If $\mathfrak p \in V(I)$, in other words, if $I \subset \mathfrak p$,
then $x \in I$ implies $x(1 - y) = 0$ for some $y \in I$, implies
$x$ maps to zero in $R_{\mathfrak p}$, i.e., $IR_{\mathfrak p} = 0$.
Thus we see that (7) holds.

\medskip\noindent
Assume (7). Then $(R/I)_{\mathfrak p}$ is either $0$ or $R_{\mathfrak p}$
for any prime $\mathfrak p$ of $R$. Hence by
Lemma \ref{lemma-flat-localization}
we see that (1) holds. At this point we see that all of
(1) -- (7) and (9) are equivalent.

\medskip\noindent
As $IR_{\mathfrak p} = I_{\mathfrak p}$ we see that (7) implies (8).
Finally, if (8) holds, then this means exactly that $I_{\mathfrak p}$
is the zero module if and only if $\mathfrak p \in V(I)$, which
is clearly saying that (7) holds. Now (1) -- (9) are equivalent.

\medskip\noindent
Assume (1) -- (9) hold. Then $R/I \subset (1 + I)^{-1}R$ by (9) and
the map $R/I \to (1 + I)^{-1}R$ is also surjective by the description
of localizations at primes afforded by (7). Hence (11) holds.

\medskip\noindent
The implication (11) $\Rightarrow$ (10) is trivial.
And (10) implies that (1) holds because a localization of
$R$ is flat over $R$, see
Lemma \ref{lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-pure-ideal-determined-by-zero-set}
\begin{slogan}
Pure ideals are determined by their vanishing locus.
\end{slogan}
Let $R$ be a ring.
If $I, J \subset R$ are pure ideals, then $V(I) = V(J)$
implies $I = J$.
\end{lemma}

\begin{proof}
For example, by property (7) of
Lemma \ref{lemma-pure}
we see that
$I = \Ker(R \to \prod_{\mathfrak p \in V(I)} R_{\mathfrak p})$
can be recovered from the closed subset associated to it.
\end{proof}

\begin{lemma}
\label{lemma-pure-open-closed-specializations}
Let $R$ be a ring. The rule
$I \mapsto V(I)$
determines a bijection
$$
\{I \subset R \text{ pure}\}
\leftrightarrow
\{Z \subset \Spec(R)\text{ closed and closed under generalizations}\}
$$
\end{lemma}

\begin{proof}
Let $I$ be a pure ideal. Then since $R \to R/I$ is flat, by going up
generalizations lift along the map $\Spec(R/I) \to \Spec(R)$.
Hence $V(I)$ is closed under generalizations. This shows that the map
is well defined. By
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}
the map is injective. Suppose that
$Z \subset \Spec(R)$ is closed and closed under generalizations.
Let $J \subset R$ be the radical ideal such that $Z = V(J)$.
Let $I = \{x \in R : x \in xJ\}$. Note that $I$ is an ideal.
We claim that $I$ is pure and that $V(I) = V(J)$.
If the claim is true then the map of the lemma is surjective and
the lemma holds.

\medskip\noindent
Note that $I \subset J$, so that $V(J) \subset V(I)$.
Let $I \subset \mathfrak p$ be a prime. Consider the multiplicative
subset $S = (R \setminus \mathfrak p)(1 + J)$. By definition of
$I$ and $I \subset \mathfrak p$ we see that $0 \not \in S$.
Hence we can find a prime $\mathfrak q$ of $R$ which is disjoint
from $S$, see
Lemmas \ref{lemma-localization-zero} and
\ref{lemma-spec-localization}.
Hence $\mathfrak q \subset \mathfrak p$ and
$\mathfrak q \cap (1 + J) = \emptyset$.
This implies that $\mathfrak q + J$ is a proper ideal of $R$.
Let $\mathfrak m$ be a maximal ideal containing $\mathfrak q + J$.
Then we get
$\mathfrak m \in V(J)$ and hence $\mathfrak q \in V(J) = Z$
as $Z$ was assumed to be closed under generalization.
This in turn implies $\mathfrak p \in V(J)$ as
$\mathfrak q \subset \mathfrak p$. Thus we see that $V(I) = V(J)$.

\medskip\noindent
Finally, since $V(I) = V(J)$ (and $J$ radical) we see that $J = \sqrt{I}$.
Pick $x \in I$, so that $x = xy$ for some $y \in J$ by definition.
Then $x = xy = xy^2 = \ldots = xy^n$. Since $y^n \in I$ for some $n > 0$
we conclude that property (5) of
Lemma \ref{lemma-pure}
holds and we see that $I$ is indeed pure.
\end{proof}

\begin{lemma}
\label{lemma-finitely-generated-pure-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The following are equivalent
\begin{enumerate}
\item $I$ is pure and finitely generated,
\item $I$ is generated by an idempotent,
\item $I$ is pure and $V(I)$ is open, and
\item $R/I$ is a projective $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
If (1) holds, then $I = I \cap I = I^2$ by
Lemma \ref{lemma-pure}.
Hence $I$ is generated by an idempotent by
Lemma \ref{lemma-ideal-is-squared-union-connected}.
Thus (1) $\Rightarrow$ (2).
If (2) holds, then $I = (e)$ and $R = (1 - e) \oplus (e)$ as
an $R$-module hence $R/I$ is flat and $I$ is pure and $V(I) = D(1 - e)$
is open. Thus (2) $\Rightarrow$ (1) $+$ (3).
Finally, assume (3). Then $V(I)$ is open and closed, hence
$V(I) = D(1 - e)$ for some idempotent $e$ of $R$, see
Lemma \ref{lemma-disjoint-decomposition}.
The ideal $J = (e)$ is a pure ideal such that $V(J) = V(I)$ hence
$I = J$ by
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}.
In this way we see that (3) $\Rightarrow$ (2). By
Lemma \ref{lemma-finite-projective}
we see that (4) is equivalent to the assertion that $I$ is pure
and $R/I$ finitely presented. Moreover, $R/I$ is finitely presented
if and only if $I$ is finitely generated, see Lemma \ref{lemma-extension}.
Hence (4) is equivalent to (1).
\end{proof}

\noindent
We can use the above to characterize those rings for which every finite
flat module is finitely presented.

\begin{lemma}
\label{lemma-finite-flat-module-finitely-presented}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item every $Z \subset \Spec(R)$ which is closed and closed under
generalizations is also open, and
\item any finite flat $R$-module is finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
If any finite flat $R$-module is finite locally free then the support
of $R/I$ where $I$ is a pure ideal is open. Hence the implication
(2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}.

\medskip\noindent
For the converse assume that $R$ satisfies (1).
Let $M$ be a finite flat $R$-module.
The support $Z = \text{Supp}(M)$ of $M$ is closed, see
Lemma \ref{lemma-support-closed}.
On the other hand, if $\mathfrak p \subset \mathfrak p'$, then by
Lemma \ref{lemma-finite-flat-local}
the module $M_{\mathfrak p'}$ is free, and
$M_{\mathfrak p} = M_{\mathfrak p'} \otimes_{R_{\mathfrak p'}} R_{\mathfrak p}$
Hence
$\mathfrak p' \in \text{Supp}(M) \Rightarrow \mathfrak p \in \text{Supp}(M)$,
in other words, the support is closed under generalization.
As $R$ satisfies (1) we see that the support of $M$ is open and closed.
Suppose that $M$ is generated by $r$ elements $m_1, \ldots, m_r$.
The modules $\wedge^i(M)$, $i = 1, \ldots, r$ are finite flat $R$-modules
also, because $\wedge^i(M)_{\mathfrak p} = \wedge^i(M_{\mathfrak p})$
is free over $R_{\mathfrak p}$. Note that
$\text{Supp}(\wedge^{i + 1}(M)) \subset \text{Supp}(\wedge^i(M))$.
Thus we see that there exists a decomposition
$$
\Spec(R) = U_0 \amalg U_1 \amalg \ldots \amalg U_r
$$
by open and closed subsets such that the support of
$\wedge^i(M)$ is $U_r \cup \ldots \cup U_i$ for all $i = 0, \ldots, r$.
Let $\mathfrak p$ be a prime of $R$, and say $\mathfrak p \in U_i$.
Note that
$\wedge^i(M) \otimes_R \kappa(\mathfrak p) =
\wedge^i(M \otimes_R \kappa(\mathfrak p))$.
Hence, after possibly renumbering $m_1, \ldots, m_r$ we may assume that
$m_1, \ldots, m_i$ generate $M \otimes_R \kappa(\mathfrak p)$. By
Nakayama's Lemma \ref{lemma-NAK}
we get a surjection
$$
R_f^{\oplus i} \longrightarrow M_f, \quad
(a_1, \ldots, a_i) \longmapsto \sum a_im_i
$$
for some $f \in R$, $f \not \in \mathfrak p$. We may also assume that
$D(f) \subset U_i$. This means that $\wedge^i(M_f) = \wedge^i(M)_f$
is a flat $R_f$ module whose support is all of $\Spec(R_f)$.
By the above it is generated by a single element, namely
$m_1 \wedge \ldots \wedge m_i$. Hence $\wedge^i(M)_f \cong R_f/J$
for some pure ideal $J \subset R_f$ with $V(J) = \Spec(R_f)$.
Clearly this means that $J = (0)$, see
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}.
Thus $m_1 \wedge \ldots \wedge m_i$ is a basis for
$\wedge^i(M_f)$ and it follows that the displayed map is injective
as well as surjective. This proves that $M$ is finite locally free
as desired.
\end{proof}







\section{Rings of finite global dimension}
\label{section-ring-finite-gl-dim}

\noindent
The following lemma is often used to compare different
projective resolutions of a given module.

\begin{lemma}[Schanuel's lemma]
\label{lemma-Schanuel}
Let $R$ be a ring. Let $M$ be an $R$-module.
Suppose that $0 \to K \to P_1 \to M \to 0$
and $0 \to L \to P_2 \to M \to 0$ are two short exact
sequences, with $P_i$ projective.
Then $K \oplus P_2 \cong L \oplus P_1$.
\end{lemma}

\begin{proof}
Consider the module
$N$ defined by the short exact sequence
$0 \to N \to P_1 \oplus P_2 \to M \to 0$,
where the last map is the sum of the two maps
$P_i \to M$. It is easy to see that the projection
$N \to P_1$ is surjective with kernel $L$, and that
$N \to P_2$ is surjective with kernel $K$.
Since $P_i$ are projective we have $N \cong K \oplus P_2
\cong L \oplus P_1$.
\end{proof}

\begin{definition}
\label{definition-finite-proj-dim}
Let $R$ be a ring. Let $M$ be an $R$-module. We say $M$ has
{\it finite projective dimension} if it has a finite length
resolution by projective $R$-modules. The minimal length of such a
resolution is called the {\it projective dimension}
of $M$.
\end{definition}

\noindent
It is clear that the projective dimension of $M$ is $0$ if and
only if $M$ is a projective module.
The following lemma explains to what extent the projective
dimension is independent of the choice of a projective
resolution.

\begin{lemma}
\label{lemma-independent-resolution}
Let $R$ be a ring. Suppose that $M$ is an $R$-module of projective
dimension $d$. Suppose that $F_e \to F_{e-1} \to \ldots \to F_0 \to M \to 0$
is exact with $F_i$ projective and $e \geq d - 1$.
Then the kernel of $F_e \to F_{e-1}$ is projective
(or the kernel of $F_0 \to M$ is projective in case
$e = 0$).
\end{lemma}

\begin{proof}
We prove this by induction on $d$. If $d = 0$, then
$M$ is projective. In this case there is a splitting
$F_0 = \Ker(F_0 \to M) \oplus M$, and hence
$\Ker(F_0 \to M)$ is projective. This finishes
the proof if $e = 0$, and if $e > 0$, then replacing
$M$ by $\Ker(F_0 \to M)$ we decrease $e$.

\medskip\noindent
Next assume $d > 0$.
Let $0 \to P_d \to P_{d-1} \to \ldots \to P_0 \to M \to 0$
be a minimal length finite resolution with $P_i$ projective.
According to
Schanuel's Lemma \ref{lemma-Schanuel}
we have
$P_0 \oplus \Ker(F_0 \to M) \cong F_0 \oplus \Ker(P_0 \to M)$.
This proves the case $d = 1$, $e = 0$, because then the right
hand side is $F_0 \oplus P_1$ which is projective. Hence now we may
assume $e > 0$. The module $F_0 \oplus \Ker(P_0 \to M)$ has the
finite projective resolution
$$
0 \to P_d \to P_{d-1} \to \ldots \to
P_2 \to P_1 \oplus F_0 \to \Ker(P_0 \to M) \oplus F_0 \to 0
$$
of length $d - 1$. By induction applied to the exact sequence
$$
F_e \to F_{e-1} \to \ldots \to F_2 \to P_0 \oplus F_1 \to
P_0 \oplus \Ker(F_0 \to M) \to 0
$$
of length $e - 1$ we conclude $\Ker(F_e \to F_{e - 1})$
is projective (if $e \geq 2$)
or that $\Ker(F_1 \oplus P_0 \to F_0 \oplus P_0)$ is projective.
This implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-what-kind-of-resolutions}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $d \geq 0$.
The following are equivalent
\begin{enumerate}
\item $M$ has projective dimension $\leq d$,
\item there exists a resolution
$0 \to P_d \to P_{d - 1} \to \ldots \to P_0 \to M \to 0$
with $P_i$ projective,
\item for some resolution
$\ldots \to P_2 \to P_1 \to P_0 \to M \to 0$ with
$P_i$ projective we have $\Ker(P_{d - 1} \to P_{d - 2})$
is projective if $d \geq 2$, or $\Ker(P_0 \to M)$ is projective if
$d = 1$, or $M$ is projective if $d = 0$,
\item for any resolution
$\ldots \to P_2 \to P_1 \to P_0 \to M \to 0$ with
$P_i$ projective we have $\Ker(P_{d - 1} \to P_{d - 2})$
is projective if $d \geq 2$, or $\Ker(P_0 \to M)$ is projective if
$d = 1$, or $M$ is projective if $d = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is the definition of projective
dimension, see Definition \ref{definition-finite-proj-dim}.
We have (2) $\Rightarrow$ (4) by Lemma \ref{lemma-independent-resolution}.
The implications (4) $\Rightarrow$ (3) and (3) $\Rightarrow$ (2) are
immediate.
\end{proof}

\begin{lemma}
\label{lemma-what-kind-of-resolutions-local}
Let $R$ be a local ring. Let $M$ be an $R$-module. Let $d \geq 0$.
The equivalent conditions (1) -- (4) of
Lemma \ref{lemma-what-kind-of-resolutions}
are also equivalent to
\begin{enumerate}
\item[(5)] there exists a resolution
$0 \to P_d \to P_{d - 1} \to \ldots \to P_0 \to M \to 0$
with $P_i$ free.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-what-kind-of-resolutions} and
Theorem \ref{theorem-projective-free-over-local-ring}.
\end{proof}

\begin{lemma}
\label{lemma-what-kind-of-resolutions-Noetherian}
Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module.
Let $d \geq 0$. The equivalent conditions (1) -- (4) of
Lemma \ref{lemma-what-kind-of-resolutions}
are also equivalent to
\begin{enumerate}
\item[(6)] there exists a resolution
$0 \to P_d \to P_{d - 1} \to \ldots \to P_0 \to M \to 0$
with $P_i$ finite projective.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a resolution $\ldots \to F_2 \to F_1 \to F_0 \to M \to 0$
with $F_i$ finite free (Lemma \ref{lemma-resolution-by-finite-free}).
By Lemma \ref{lemma-what-kind-of-resolutions} we see that
$P_d = \Ker(F_{d - 1} \to F_{d - 2})$ is projective at least if $d \geq 2$.
Then $P_d$ is a finite $R$-module as $R$ is Noetherian and
$P_d \subset F_{d - 1}$ which is finite free.
Whence $0 \to P_d \to F_{d - 1} \to \ldots \to F_1 \to F_0 \to M \to 0$
is the desired resolution.
\end{proof}

\begin{lemma}
\label{lemma-what-kind-of-resolutions-Noetherian-local}
Let $R$ be a local Noetherian ring. Let $M$ be a finite $R$-module.
Let $d \geq 0$. The equivalent conditions (1) -- (4) of
Lemma \ref{lemma-what-kind-of-resolutions},
condition (5) of Lemma \ref{lemma-what-kind-of-resolutions-local},
and condition (6) of Lemma \ref{lemma-what-kind-of-resolutions-Noetherian}
are also equivalent to
\begin{enumerate}
\item[(7)] there exists a resolution
$0 \to F_d \to F_{d - 1} \to \ldots \to F_0 \to M \to 0$
with $P_i$ finite free.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-what-kind-of-resolutions},
\ref{lemma-what-kind-of-resolutions-local}, and
\ref{lemma-what-kind-of-resolutions-Noetherian}
and because a finite projective module over a local ring
is finite free, see Lemma \ref{lemma-finite-projective}.
\end{proof}

\begin{lemma}
\label{lemma-projective-dimension-ext}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $n \geq 0$.
The following are equivalent
\begin{enumerate}
\item $M$ has projective dimension $\leq n$,
\item $\text{Ext}^i_R(M, N) = 0$ for all $R$-modules $N$ and all
$i \geq n + 1$, and
\item $\text{Ext}^{n + 1}_R(M, N) = 0$ for all $R$-modules $N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). Choose a free resolution $F_\bullet \to M$ of $M$. Denote
$d_e : F_e \to F_{e - 1}$. By
Lemma \ref{lemma-independent-resolution}
we see that $P_e = \Ker(d_e)$ is projective for $e \geq n - 1$.
This implies that $F_e \cong P_e \oplus P_{e - 1}$ for $e \geq n$
where $d_e$ maps the summand $P_{e - 1}$ isomorphically to $P_{e - 1}$
in $F_{e - 1}$. Hence, for any $R$-module $N$ the complex
$\Hom_R(F_\bullet, N)$ is split exact in degrees $\geq n + 1$.
Whence (2) holds. The implication (2) $\Rightarrow$ (3) is trivial.

\medskip\noindent
Assume (3) holds. If $n = 0$ then $M$ is projective by
Lemma \ref{lemma-characterize-projective}
and we see that (1) holds. If $n > 0$ choose a free $R$-module $F$
and a surjection $F \to M$ with kernel $K$. By
Lemma \ref{lemma-reverse-long-exact-seq-ext}
and the vanishing of $\text{Ext}_R^i(F, N)$ for all $i > 0$ by part (1)
we see that $\text{Ext}_R^n(K, N) = 0$ for all $R$-modules $N$.
Hence by induction we see that $K$ has projective dimension $\leq n - 1$.
Then $M$ has projective dimension $\leq n$ as any finite projective
resolution of $K$ gives a projective resolution of length one more
for $M$ by adding $F$ to the front.
\end{proof}

\begin{lemma}
\label{lemma-exact-sequence-projective-dimension}
Let $R$ be a ring. Let $0 \to M' \to M \to M'' \to 0$ be a short
exact sequence of $R$-modules.
\begin{enumerate}
\item If $M$ has projective dimension $\leq n$ and $M''$
has projective dimension $\leq n + 1$, then $M'$ has projective
dimension $\leq n$.
\item If $M'$ and $M''$ have projective dimension
$\leq n$ then $M$ has projective dimension $\leq n$.
\item If $M'$ has projective dimension $\leq n$ and
$M$ has projective dimension $\leq n + 1$ then
$M''$ has projective dimension $\leq n + 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Combine the characterization of projective dimension in
Lemma \ref{lemma-projective-dimension-ext}
with the long exact sequence of ext groups in
Lemma \ref{lemma-reverse-long-exact-seq-ext}.
\end{proof}

\begin{definition}
\label{definition-finite-gl-dim}
Let $R$ be a ring. The ring
$R$ is said to have {\it finite global dimension}
if there exists an integer $n$ such that
every $R$-module has a resolution by
projective $R$-modules of length at most $n$.
The minimal such $n$ is then called the {\it global dimension}
of $R$.
\end{definition}

\noindent
The argument in the proof of the following lemma can be found
in the paper \cite{Auslander} by Auslander.

\begin{lemma}
\label{lemma-finite-gl-dim}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ has finite global dimension $\leq n$,
\item every finite $R$-module has projective dimension $\leq n$, and
\item every cyclic $R$-module $R/I$ has projective dimension $\leq n$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) $\Rightarrow$ (3).
Assume (3). Since every finite $R$-module has a finite filtration by
cyclic modules, see
Lemma \ref{lemma-trivial-filter-finite-module}
we see that (2) follows by
Lemma \ref{lemma-exact-sequence-projective-dimension}.

\medskip\noindent
Assume (2). Let $M$ be an arbitrary $R$-module.
Choose a set $E \subset M$ of generators of $M$.
Choose a well ordering on $E$. For $e \in E$ denote
$M_e$ the submodule of $M$ generated by the elements $e' \in E$
with $e' \leq e$. Then $M = \bigcup_{e \in E} M_e$.
Note that for each $e \in E$ the quotient
$$
M_e/\bigcup\nolimits_{e' < e} M_{e'}
$$
is either zero or generated by one element, hence has projective
dimension $\leq n$. To finish the proof we claim that any time
we have a well-ordered set $E$ and a module $M = \bigcup_{e \in E} M_e$
such that the quotients $M_e/\bigcup\nolimits_{e' < e} M_{e'}$
have projective dimension $\leq n$, then
$M$ has projective dimension $\leq n$.

\medskip\noindent
We may prove this statement by induction on $n$. If $n = 0$, then
we will show, by transfinite induction that $M$ is projective.
Namely, for each $e \in E$ we may choose a splitting
$M_e = \bigcup_{e' < e} M_{e'} \oplus P_e$ because
$P_e = M_e/\bigcup_{e' < e} M_{e'}$ is projective. Hence it follows
that $M = \bigoplus_{e \in E} P_e$ and we conclude that $M$ is
projective, see
Lemma \ref{lemma-direct-sum-projective}.

\medskip\noindent
If $n > 0$, then for $e \in E$ we denote $F_e$ the free $R$-module
on the set of elements of $M_e$. Then we have a system of
short exact sequences
$$
0 \to K_e \to F_e \to M_e \to 0
$$
over the well-ordered set $E$. Note that the transition maps
$F_{e'} \to F_e$ and $K_{e'} \to K_e$ are injective too.
Set $F = \bigcup F_e$ and $K = \bigcup K_e$. Then
$$
0 \to
K_e/\bigcup\nolimits_{e' < e} K_{e'} \to
F_e/\bigcup\nolimits_{e' < e} F_{e'} \to
M_e/\bigcup\nolimits_{e' < e} M_{e'} \to 0
$$
is a short exact sequence of $R$-modules too and
$F_e/\bigcup_{e' < e} F_{e'}$ is the free $R$-module on the
set of elements in $M_e$ which are not contained in $\bigcup_{e' < e} M_{e'}$.
Hence by
Lemma \ref{lemma-exact-sequence-projective-dimension}
we see that the projective dimension of $K_e/\bigcup_{e' < e} K_{e'}$
is at most $n - 1$. By induction we conclude that $K$ has projective
dimension at most $n - 1$. Whence $M$ has projective dimension at most
$n$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-localize-finite-gl-dim}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $S \subset R$ be a multiplicative subset.
\begin{enumerate}
\item If $M$ has projective dimension $\leq n$, then $S^{-1}M$ has
projective dimension $\leq n$ over $S^{-1}R$.
\item If $R$ has finite global dimension $\leq n$, then
$S^{-1}R$ has finite global dimension $\leq n$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $0 \to P_n \to P_{n - 1} \to \ldots \to P_0 \to M \to 0$
be a projective resolution. As localization is exact, see
Proposition \ref{proposition-localization-exact},
and as each $S^{-1}P_i$ is a projective $S^{-1}R$-module, see
Lemma \ref{lemma-ascend-properties-modules},
we see that $0 \to S^{-1}P_n \to \ldots \to S^{-1}P_0 \to S^{-1}M \to 0$
is a projective resolution of $S^{-1}M$. This proves (1).
Let $M'$ be an $S^{-1}R$-module.
Note that $M' = S^{-1}M'$.
Hence we see that (2) follows from (1).
\end{proof}










\section{Regular rings and global dimension}
\label{section-regular-finite-gl-dim}

\noindent
We can use the material on rings of finite global dimension
to give another characterization of regular local rings.

\begin{proposition}
\label{proposition-regular-finite-gl-dim}
Let $R$ be a regular local ring of dimension $d$.
Every finite $R$-module $M$ of depth $e$ has a finite free
resolution
$$
0 \to F_{d-e} \to \ldots \to F_0 \to M \to 0.
$$
In particular a regular local ring has global dimension $\leq d$.
\end{proposition}

\begin{proof}
The first part holds in view of Lemma \ref{lemma-regular-mcm-free}
and Lemma \ref{lemma-mcm-resolution}. The last part follows from this
and Lemma \ref{lemma-finite-gl-dim}.
\end{proof}

\begin{lemma}
\label{lemma-finite-gl-dim-primes}
Let $R$ be a Noetherian ring.
Then $R$ has finite global dimension if and
only if there exists an integer $n$ such that
for all maximal ideals $\mathfrak m$ of $R$
the ring $R_{\mathfrak m}$ has global dimension
$\leq n$.
\end{lemma}

\begin{proof}
We saw, Lemma \ref{lemma-localize-finite-gl-dim}
that if $R$ has finite global dimension $n$,
then all the localizations $R_{\mathfrak m}$
have finite global dimension at most $n$.
Conversely, suppose that all the $R_{\mathfrak m}$
have global dimension $n$. Let $M$ be a finite
$R$-module. Let
$0 \to K_n \to F_{n-1} \to \ldots \to F_0 \to M \to 0$
be a resolution with $F_i$ finite free.
Then $K_n$ is a finite $R$-module.
According to
Lemma \ref{lemma-independent-resolution}
and the assumption all the modules $K_n \otimes_R R_{\mathfrak m}$
are projective. Hence by
Lemma \ref{lemma-finite-projective}
the module $K_n$ is finite projective.
\end{proof}

\begin{lemma}
\label{lemma-length-resolution-residue-field}
Suppose that $R$ is a Noetherian local ring
with maximal ideal $\mathfrak m$ and
residue field $\kappa$. In this case
the projective dimension of $\kappa$ is
$\geq \dim_\kappa \mathfrak m / \mathfrak m^2$.
\end{lemma}

\begin{proof}
Let $x_1 , \ldots x_n$ be elements of $\mathfrak m$
whose images in $\mathfrak m / \mathfrak m^2$ form a basis.
Consider the {\it Koszul complex} on $x_1, \ldots, x_n$.
This is the complex
$$
0 \to \wedge^n R^n \to \wedge^{n-1} R^n \to \wedge^{n-2} R^n \to
\ldots \to \wedge^i R^n \to \ldots \to R^n \to R
$$
with maps given by
$$
e_{j_1} \wedge \ldots \wedge e_{j_i}
\longmapsto
\sum_{a = 1}^i (-1)^{i + 1} x_{j_a} e_{j_1} \wedge \ldots
\wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i}
$$
It is easy to see that this is a complex $K_{\bullet}(R, x_{\bullet})$.
Note that the cokernel of the last map of $K_{\bullet}(R, x_{\bullet})$
is clearly $\kappa$.

\medskip\noindent
If $\kappa$ has finite projective dimension $d$, then we can find
a resolution $F_{\bullet} \to \kappa$ by finite free $R$-modules
of length $d$
(Lemma \ref{lemma-what-kind-of-resolutions-Noetherian-local}).
By Lemma \ref{lemma-add-trivial-complex}
we may assume all the maps in the complex $F_{\bullet}$
have the property that $\Im(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
By Lemma \ref{lemma-compare-resolutions} we can find a map
of complexes $\alpha : K_{\bullet}(R, x_{\bullet}) \to F_{\bullet}$
inducing the identity on $\kappa$. We will prove by induction
that the maps $\alpha_i : \wedge^i R^n = K_i(R, x_{\bullet}) \to F_i$
have the property that
$\alpha_i \otimes \kappa : \wedge^i \kappa^n \to F_i \otimes \kappa$
are injective. This shows that $F_n \not = 0$ and hence $d \geq n$
as desired.

\medskip\noindent
The result is clear for $i = 0$ because the composition
$R \xrightarrow{\alpha_0} F_0 \to \kappa$ is nonzero.
Note that $F_0$ must have rank $1$ since
otherwise the map $F_1 \to F_0$ whose cokernel is a single
copy of $\kappa$ cannot have image contained in $\mathfrak m F_0$.

\medskip\noindent
Next we check the case $i = 1$ as we feel that it is instructive;
the reader can skip this as the induction step will deduce the $i = 1$
case from the case $i = 0$. We saw above that
$F_0 = R$ and $F_1 \to F_0 = R$ has image $\mathfrak m$.
We have a commutative diagram
$$
\begin{matrix}
R^n & = & K_1(R, x_{\bullet}) & \to & K_0(R, x_{\bullet}) & = & R \\
& & \downarrow & & \downarrow & & \downarrow \\
& & F_1 & \to & F_0 & = & R
\end{matrix}
$$
where the rightmost vertical arrow is given by multiplication
by a unit. Hence we see that the image of the composition
$R^n \to F_1 \to F_0 = R$ is also equal to $\mathfrak m$.
Thus the map $R^n \otimes \kappa \to F_1 \otimes \kappa$
has to be injective since $\dim_\kappa (\mathfrak m / \mathfrak m^2) = n$.

\medskip\noindent
Let $i \geq 1$ and assume injectivity of $\alpha_j \otimes \kappa$ has been
proved for all $j \leq i - 1$. Consider the commutative diagram
$$
\begin{matrix}
\wedge^i R^n & = & K_i(R, x_{\bullet}) & \to & K_{i-1}(R, x_{\bullet})
& = & \wedge^{i-1} R^n \\
& & \downarrow & & \downarrow & & \\
& & F_i & \to & F_{i-1} & &
\end{matrix}
$$
We know that $\wedge^{i-1} \kappa^n \to F_{i-1} \otimes \kappa$
is injective. This proves that
$\wedge^{i-1} \kappa^n \otimes_{\kappa} \mathfrak m/\mathfrak m^2
\to F_{i-1} \otimes \mathfrak m/\mathfrak m^2$ is injective.
Also, by our choice of the complex, $F_i$ maps into
$\mathfrak mF_{i-1}$, and similarly for the Koszul complex.
Hence we get a commutative diagram
$$
\begin{matrix}
\wedge^i \kappa^n & \to &
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^2 \\
\downarrow & & \downarrow \\
F_i \otimes \kappa & \to & F_{i-1} \otimes \mathfrak m/\mathfrak m^2
\end{matrix}
$$
At this point it suffices to verify the map
$\wedge^i \kappa^n \to
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^2$
is injective, which can be done by hand.
\end{proof}

\begin{lemma}
\label{lemma-dim-gl-dim}
Let $R$ be a Noetherian local ring.
Suppose that the residue field $\kappa$ has finite
projective dimension $n$ over $R$.
In this case $\dim(R) \geq n$.
\end{lemma}

\begin{proof}
Let $F_{\bullet}$ be a finite resolution of $\kappa$ by finite free
$R$-modules (Lemma \ref{lemma-what-kind-of-resolutions-Noetherian-local}).
By Lemma \ref{lemma-add-trivial-complex}
we may assume all the maps in the complex $F_{\bullet}$
have to property that $\Im(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
Say $F_n \not = 0$ and $F_i = 0$ for $i > n$, so that
the projective dimension of $\kappa$ is $n$.
By Proposition \ref{proposition-what-exact} we see that
$\text{depth}_{I(\varphi_n)}(R) \geq n$ since $I(\varphi_n)$
cannot equal $R$ by our choice of the complex.
Thus by Lemma \ref{lemma-bound-depth} also $\dim(R) \geq n$.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-regular}
A Noetherian local ring whose residue field
has finite projective dimension is a regular local ring.
In particular a Noetherian local ring of
finite global dimension is a regular local ring.
\end{proposition}

\begin{proof}
By Lemmas \ref{lemma-length-resolution-residue-field}
and \ref{lemma-dim-gl-dim} we see that
$\dim(R) \geq \dim_\kappa(\mathfrak m /\mathfrak m^2)$.
Thus the result follows immediately from Definition
\ref{definition-regular-local}.
\end{proof}

\begin{lemma}
\label{lemma-localization-of-regular-local-is-regular}
A Noetherian local ring $R$ is a regular local ring if and only if
it has finite global dimension. In this case
$R_{\mathfrak p}$ is a regular local ring for all primes $\mathfrak p$.
\end{lemma}

\begin{proof}
By Propositions \ref{proposition-finite-gl-dim-regular} and
\ref{proposition-regular-finite-gl-dim}
we see that a Noetherian local ring is a regular local ring if and only if
it has finite global dimension. Furthermore, any localization
$R_{\mathfrak p}$ has finite global dimension,
see Lemma \ref{lemma-localize-finite-gl-dim},
and hence is a regular local ring.
\end{proof}

\noindent
By Lemma \ref{lemma-localization-of-regular-local-is-regular}
it makes sense to make the following definition,
because it does not conflict with the earlier
definition of a regular local ring.

\begin{definition}
\label{definition-regular}
A Noetherian ring $R$ is said to be {\it regular}
if all the localizations $R_{\mathfrak p}$ at primes are
regular local rings.
\end{definition}

\noindent
It is enough to require the local rings at maximal ideals to be regular.
Note that this is not the same as asking $R$ to have finite
global dimension, even assuming $R$ is Noetherian. This is
because there is an example of a regular Noetherian ring
which does not have finite global dimension, namely because
it does not have finite dimension.

\begin{lemma}
\label{lemma-finite-gl-dim-finite-dim-regular}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ has finite global dimension $n$,
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak m}$ at maximal ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak m$, and
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak p}$ at prime ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a reformulation of Lemma \ref{lemma-finite-gl-dim-primes}
in view of the discussion surrounding Definition \ref{definition-regular}.
See especially Propositions
\ref{proposition-regular-finite-gl-dim} and
\ref{proposition-finite-gl-dim-regular}.
\end{proof}

\begin{lemma}
\label{lemma-flat-under-regular}
Let $R \to S$ be a local homomorphism of local Noetherian rings.
Assume that $R \to S$ is flat and that $S$ is regular.
Then $R$ is regular.
\end{lemma}

\begin{proof}
Let $\mathfrak m \subset R$ be the maximal ideal
and let $\kappa = R/\mathfrak m$ be the residue field.
Let $d = \dim S$.
Choose any resolution $F_\bullet \to \kappa$
with each $F_i$ a finite free $R$-module. Set
$K_d = \Ker(F_{d - 1} \to F_{d - 2})$.
By flatness of $R \to S$ the complex
$0 \to K_d \otimes_R S \to F_{d - 1} \otimes_R S \to \ldots
\to F_0 \otimes_R S \to \kappa \otimes_R S \to 0$
is still exact. Because the global dimension of $S$
is $d$, see Proposition \ref{proposition-regular-finite-gl-dim},
we see that $K_d \otimes_R S$ is a finite free $S$-module
(see also Lemma \ref{lemma-independent-resolution}).
By Lemma \ref{lemma-finite-projective-descends} we see
that $K_d$ is a finite free $R$-module.
Hence $\kappa$ has finite projective dimension and $R$ is regular by
Proposition \ref{proposition-finite-gl-dim-regular}.
\end{proof}








\section{Auslander-Buchsbaum}
\label{section-Auslander-Buchsbaum}

\noindent
The following result can be found in \cite{Auslander-Buchsbaum}.

\begin{proposition}
\label{proposition-Auslander-Buchsbaum}
Let $R$ be a Noetherian local ring. Let $M$ be a nonzero finite $R$-module
which has finite projective dimension $\text{pd}_R(M)$. Then we have
$$
\text{depth}(R) = \text{pd}_R(M) + \text{depth}(M)
$$
\end{proposition}

\begin{proof}
We prove this by induction on $\text{depth}(M)$. The most interesting
case is the case $\text{depth}(M) = 0$. In this case, let
$$
0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0} \to M \to 0
$$
be a minimal finite free resolution, so $e = \text{pd}_R(M)$.
By Lemma \ref{lemma-add-trivial-complex} we may assume all matrix
coefficients of the maps in the complex are contained in the maximal
ideal of $R$. Then on the one hand, by
Proposition \ref{proposition-what-exact} we see that
$\text{depth}(R) \geq e$. On the other hand, breaking the long
exact sequence into short exact sequences
\begin{align*}
0 \to R^{n_e} \to R^{n_{e - 1}} \to K_{e - 2} \to 0,\\
0 \to K_{e - 2} \to R^{n_{e - 2}} \to K_{e - 3} \to 0,\\
\ldots,\\
0 \to K_0 \to R^{n_0} \to M \to 0
\end{align*}
we see, using Lemma \ref{lemma-depth-in-ses}, that
\begin{align*}
\text{depth}(K_{e - 2}) \geq \text{depth}(R) - 1,\\
\text{depth}(K_{e - 3}) \geq \text{depth}(R) - 2,\\
\ldots,\\
\text{depth}(K_0) \geq \text{depth}(R) - (e - 1),\\
\text{depth}(M) \geq \text{depth}(R) - e
\end{align*}
and since $\text{depth}(M) = 0$ we conclude $\text{depth}(R) \leq e$.
This finishes the proof of the case $\text{depth}(M) = 0$.

\medskip\noindent
Induction step. If $\text{depth}(M) > 0$, then we pick $x \in \mathfrak m$
which is a nonzerodivisor on both $M$ and $R$. This is possible, because
either $\text{pd}_R(M) > 0$ and $\text{depth}(R) > 0$ by the aforementioned
Proposition \ref{proposition-what-exact} or $\text{pd}_R(M) = 0$ in which
case $M$ is finite free hence also $\text{depth}(R) = \text{depth}(M) > 0$.
Thus $\text{depth}(R \oplus M) > 0$ by Lemma \ref{lemma-depth-in-ses}
(for example) and we can find an $x \in \mathfrak m$ which is a nonzerodivisor
on both $R$ and $M$. Let
$$
0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0} \to M \to 0
$$
be a minimal resolution as above. An application of the snake lemma
shows that
$$
0 \to (R/xR)^{n_e} \to (R/xR)^{n_{e-1}} \to \ldots \to (R/xR)^{n_0} \to
M/xM \to 0
$$
is a minimal resolution too. Thus $\text{pd}_R(M) = \text{pd}_{R/xR}(M/xM)$.
By Lemma \ref{lemma-depth-drops-by-one} we have
$\text{depth}(R/xR) = \text{depth}(R) - 1$ and
$\text{depth}(M/xM) = \text{depth}(M) - 1$.
Till now depths have all been depths as $R$ modules, but we observe that
$\text{depth}_R(M/xM) = \text{depth}_{R/xR}(M/xM)$ and similarly for $R/xR$.
By induction hypothesis we see that the
Auslander-Buchsbaum formula holds for $M/xM$ over $R/xR$. Since the
depths of both $R/xR$ and $M/xM$ have decreased by one and the projective
dimension has not changed we conclude.
\end{proof}









\section{Homomorphisms and dimension}
\label{section-homomorphism-dimension}

\noindent
This section contains a collection of easy results relating
dimensions of rings when there are maps between them.

\begin{lemma}
\label{lemma-dimension-going-up}
Suppose $R \to S$ is a ring map satisfying either going up, see
Definition \ref{definition-going-up-down}, or going down
see Definition \ref{definition-going-up-down}.
Assume in addition that $\Spec(S) \to \Spec(R)$
is surjective. Then $\dim(R) \leq \dim(S)$.
\end{lemma}

\begin{proof}
Assume going up.
Take any chain $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots
\subset \mathfrak p_e$ of prime ideals in $R$.
By surjectivity we may choose a prime $\mathfrak q_0$ mapping
to $\mathfrak p_0$. By going up we may extend this to a chain
of length $e$ of primes $\mathfrak q_i$ lying over
$\mathfrak p_i$. Thus $\dim(S) \geq \dim(R)$.
The case of going down is exactly the same.
See also Topology, Lemma \ref{topology-lemma-dimension-specializations-lift}
for a purely topological version.
\end{proof}

\begin{lemma}
\label{lemma-going-up-maximal-on-top}
Suppose that $R \to S$ is a ring map with the going up property,
see Definition \ref{definition-going-up-down}. If
$\mathfrak q \subset S$ is a maximal ideal.
Then the inverse image of $\mathfrak q$ in $R$
is a maximal ideal too.
\end{lemma}

\begin{proof}
Trivial.
\end{proof}

\begin{lemma}
\label{lemma-integral-dim-up}
Suppose that $R \to S$ is a ring map such that $S$ is integral over $R$.
Then $\dim (R) \geq \dim(S)$, and every closed point of $\Spec(S)$
maps to a closed point of $\Spec(R)$.
\end{lemma}

\begin{proof}
Immediate from Lemmas \ref{lemma-integral-no-inclusion} and
\ref{lemma-going-up-maximal-on-top}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-integral-sub-dim-equal}
Suppose $R \subset S$ and $S$ integral over $R$.
Then $\dim(R) = \dim(S)$.
\end{lemma}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-integral-going-up},
\ref{lemma-integral-overring-surjective},
\ref{lemma-dimension-going-up}, and
\ref{lemma-integral-dim-up}.
\end{proof}

\begin{definition}
\label{definition-fibre}
Suppose that $R \to S$ is a ring map.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$ of $R$.
The {\it local ring of the fibre at $\mathfrak q$}
is the local ring
$$
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
=
(S/\mathfrak pS)_{\mathfrak q}
=
(S \otimes_R \kappa(\mathfrak p))_{\mathfrak q}
$$
\end{definition}

\begin{lemma}
\label{lemma-dimension-base-fibre-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Then
$$
\dim(S_{\mathfrak q})
\leq
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
We use the characterization of dimension of
Proposition \ref{proposition-dimension}.
Let $x_1, \ldots, x_d$ be elements of $\mathfrak p$
generating an ideal of definition of $R_{\mathfrak p}$ with
$d = \dim(R_{\mathfrak p})$.
Let $y_1, \ldots, y_e$ be elements of $\mathfrak q$
generating an ideal of definition of
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
with $e = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
It is clear that $S_{\mathfrak q}/(x_1, \ldots, x_d, y_1, \ldots, y_e)$
has a nilpotent maximal ideal. Hence
$x_1, \ldots, x_d, y_1, \ldots, y_e$ generate an ideal of definition
if $S_{\mathfrak q}$.
\end{proof}

\begin{lemma}
\label{lemma-dimension-base-fibre-equals-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Assume the going down property holds
for $R \to S$ (for example if $R \to S$ is flat, see
Lemma \ref{lemma-flat-going-down}). Then
$$
\dim(S_{\mathfrak q})
=
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-base-fibre-total}
we have an inequality
$\dim(S_{\mathfrak q}) \leq
\dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
To get equality, choose a chain of primes
$\mathfrak pS \subset \mathfrak q_0 \subset \mathfrak q_1 \subset \ldots
\subset \mathfrak q_d = \mathfrak q$ with
$d = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
On the other hand, choose a chain of primes
$\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e
= \mathfrak p$ with $e = \dim(R_{\mathfrak p})$.
By the going down theorem we may choose
$\mathfrak q_{-1} \subset \mathfrak q_0$ lying over
$\mathfrak p_{e-1}$. And then we may choose
$\mathfrak q_{-2} \subset \mathfrak q_{e-1}$ lying over
$\mathfrak p_{e-2}$. Inductively we keep going until we
get a chain
$\mathfrak q_{-e} \subset \ldots \subset \mathfrak q_d$
of length $e + d$.
\end{proof}

\begin{lemma}
\label{lemma-flat-over-regular-with-regular-fibre}
Let $R \to S$ be a local homomorphism of local Noetherian rings.
Assume
\begin{enumerate}
\item $R$ is regular,
\item $S/\mathfrak m_RS$ is regular, and
\item $R \to S$ is flat.
\end{enumerate}
Then $S$ is regular.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-base-fibre-equals-total}
we have
$\dim(S) = \dim(R) + \dim(S/\mathfrak m_RS)$.
Pick generators $x_1, \ldots, x_d \in \mathfrak m_R$ with $d = \dim(R)$,
and pick $y_1, \ldots, y_e \in \mathfrak m_S$
which generate the maximal ideal of $S/\mathfrak m_RS$ with
$e = \dim(S/\mathfrak m_RS)$. Then we see that
$x_1, \ldots, x_d, y_1, \ldots, y_e$ are elements which generate
the maximal ideal of $S$ and $e + d = \dim(S)$.
\end{proof}

\noindent
The lemma below will later be used to show that rings of finite type over
a field are Cohen-Macaulay if and only if they are quasi-finite flat over
a polynomial ring. It is a partial converse to
Lemma \ref{lemma-CM-over-regular-flat}.

\begin{lemma}
\label{lemma-finite-flat-over-regular-CM}
Let $R \to S$ be a local homomorphism of Noetherian local rings.
Assume $R$ Cohen-Macaulay.
If $S$ is finite flat over $R$, or if $S$ is flat over $R$ and
$\dim(S) \leq \dim(R)$, then $S$ is Cohen-Macaulay and $\dim(R) = \dim(S)$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_d \in \mathfrak m_R$ be a regular sequence
of length $d = \dim(R)$. By Lemma \ref{lemma-flat-increases-depth}
this maps to a regular sequence in $S$.
Hence $S$ is Cohen-Macaulay if $\dim(S) \leq d$. This is true
if $S$ is finite flat over $R$ by Lemma \ref{lemma-integral-sub-dim-equal}.
And in the second case we assumed it.
\end{proof}








\section{The dimension formula}
\label{section-dimension-formula}

\noindent
Recall the definitions of catenary (Definition \ref{definition-catenary})
and universally catenary (Definition \ref{definition-universally-catenary}).

\begin{lemma}
\label{lemma-dimension-formula}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over the prime $\mathfrak p$ of $R$.
Assume that
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $R$, $S$ are domains, and
\item $R \subset S$.
\end{enumerate}
Then we have
$$
\text{height}(\mathfrak q)
\leq
\text{height}(\mathfrak p) + \text{trdeg}_R(S)
- \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q)
$$
with equality if $R$ is universally catenary.
\end{lemma}

\begin{proof}
Suppose that $R \subset S' \subset S$ is a finitely generated $R$-subalgebra
of $S$. In this case set $\mathfrak q' = S' \cap \mathfrak q$.
The lemma for the ring maps $R \to S'$ and $S' \to S$ implies the
lemma for $R \to S$ by additivity of transcendence degree in towers
of fields (Fields, Lemma \ref{fields-lemma-transcendence-degree-tower}).
Hence we can use induction on the number of generators
of $S$ over $R$ and reduce to the case where $S$ is generated by
one element over $R$.

\medskip\noindent
Case I: $S = R[x]$ is a polynomial algebra over $R$.
In this case we have $\text{trdeg}_R(S) = 1$.
Also $R \to S$ is flat and hence
$$
\dim(S_{\mathfrak q}) =
\dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})
$$
see Lemma \ref{lemma-dimension-base-fibre-equals-total}.
Let $\mathfrak r = \mathfrak pS$. Then
$\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 1$
is equivalent to $\mathfrak q = \mathfrak r$, and implies that
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$.
In the same vein $\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$
is equivalent to having a strict inclusion
$\mathfrak r \subset \mathfrak q$, which implies that
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 1$.
Thus we are done with case I with equality in every instance.

\medskip\noindent
Case II: $S = R[x]/\mathfrak n$ with $\mathfrak n \not = 0$.
In this case we have $\text{trdeg}_R(S) = 0$.
Denote $\mathfrak q' \subset R[x]$ the prime corresponding to $\mathfrak q$.
Thus we have
$$
S_{\mathfrak q} = (R[x])_{\mathfrak q'}/\mathfrak n(R[x])_{\mathfrak q'}
$$
By the previous case we have
$\dim((R[x])_{\mathfrak q'}) =
\dim(R_{\mathfrak p}) + 1
- \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q)$.
Since $\mathfrak n \not = 0$ we see that the dimension of
$S_{\mathfrak q}$ decreases by at least one, see
Lemma \ref{lemma-one-equation},
which proves the inequality of the lemma.
To see the equality in case $R$ is universally catenary note that
$\mathfrak n \subset R[x]$ is a height one prime as it corresponds
to a nonzero prime in $f.f.(R)[x]$. Hence any maximal chain of primes
in $R[x]_{\mathfrak q'}/\mathfrak n$ corresponds to a maximal chain of primes
with length 1 greater between $\mathfrak q'$ and $(0)$ in $R[x]$.
If $R$ is universally catenary these all have the same length equal to
the height of $\mathfrak q'$. This proves that
$\dim(R[x]_{\mathfrak q'}/\mathfrak n) = \dim(R[x]_{\mathfrak q'}) - 1$
as desired.
\end{proof}

\noindent
The following lemma says that generically finite maps
tend to be quasi-finite in codimension $1$.

\begin{lemma}
\label{lemma-finite-in-codim-1}
Let $A \to B$ be a ring map.
Assume
\begin{enumerate}
\item $A \subset B$ is an extension of domains.
\item $A$ is Noetherian,
\item $A \to B$ is of finite type, and
\item the extension $f.f.(A) \subset f.f.(B)$ is finite.
\end{enumerate}
Let $\mathfrak p \subset A$ be a prime of height $1$.
Then there are at most finitely many primes of $B$
lying over $\mathfrak p$ and they all have height $1$.
\end{lemma}

\begin{proof}
By the dimension formula (Lemma \ref{lemma-dimension-formula})
for any prime $\mathfrak q$ lying over $\mathfrak p$ we have
$$
\dim(B_{\mathfrak q}) \leq
\dim(A_{\mathfrak p}) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q).
$$
As the domain $B_\mathfrak q$ has at least $2$ prime ideals we see that
$\dim(B_{\mathfrak q}) \geq 1$. We conclude that
$\dim(B_{\mathfrak q}) = 1$ and that the extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is algebraic.
Hence $\mathfrak q$ defines a closed point of its fibre
$\Spec(B \otimes_A \kappa(\mathfrak p))$, see
Lemma \ref{lemma-finite-residue-extension-closed}.
Since $B \otimes_A \kappa(\mathfrak p)$ is a Noetherian ring
the fibre $\Spec(B \otimes_A \kappa(\mathfrak p))$
is a Noetherian topological space, see
Lemma \ref{lemma-Noetherian-topology}.
A Noetherian topological space consisting of closed points
is finite, see for example
Topology, Lemma \ref{topology-lemma-Noetherian}.
\end{proof}









\section{Dimension of finite type algebras over fields}
\label{section-dimension-finite-type-algebras}

\noindent
In this section we compute the dimension of a polynomial ring over
a field. We also prove that the dimension of a finite type
domain over a field is the dimension of its local rings at maximal
ideals. We will establish the connection with the transcendence
degree over the ground field in
Section \ref{section-dimension-finite-type-algebras-reprise}.

\begin{lemma}
\label{lemma-dim-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1, \ldots, x_n]$.
The ideal $\mathfrak m$ is generated by $n$ elements.
The dimension of $k[x_1, \ldots, x_n]_{\mathfrak m}$ is $n$.
Hence $k[x_1, \ldots, x_n]_{\mathfrak m}$ is a regular local
ring of dimension $n$.
\end{lemma}

\begin{proof}
By the Hilbert Nullstellensatz
(Theorem \ref{theorem-nullstellensatz})
we know the residue field $\kappa = \kappa(\mathfrak m)$ is
a finite extension of $k$. Denote $\alpha_i \in \kappa$ the
image of $x_i$. Denote $\kappa_i = k(\alpha_1, \ldots, \alpha_i)
\subset \kappa$, $i = 1, \ldots, n$ and $\kappa_0 = k$.
Note that $\kappa_i = k[\alpha_1, \ldots, \alpha_i]$
by field theory. Define inductively elements
$f_i \in \mathfrak m \cap k[x_1, \ldots, x_i]$
as follows: Let $P_i(T) \in \kappa_{i-1}[T]$
be the monic minimal polynomial of $\alpha_i $ over $\kappa_{i-1}$.
Let $Q_i(T) \in k[x_1, \ldots, x_{i-1}][T]$ be a monic lift of $P_i(T)$
(of the same degree). Set $f_i = Q_i(x_i)$.
Note that if $d_i = \deg_T(P_i) = \deg_T(Q_i) = \deg_{x_i}(f_i)$
then $d_1d_2\ldots d_i = [\kappa_i : k]$ by
Fields, Lemmas \ref{fields-lemma-multiplicativity-degrees} and
\ref{fields-lemma-degree-minimal-polynomial}.

\medskip\noindent
We claim that for all $i = 0, 1, \ldots, n$ there is an
isomorphism
$$
\psi_i : k[x_1, \ldots, x_i] /(f_1, \ldots, f_i) \cong \kappa_i.
$$
By construction the composition
$k[x_1, \ldots, x_i] \to k[x_1, \ldots, x_n] \to \kappa$
is surjective onto $\kappa_i$ and $f_1, \ldots, f_i$ are
in the kernel. This gives a surjective homomorphism.
We prove $\psi_i$ is injective by induction. It is clear for $i = 0$.
Given the statement for $i$ we prove it for $i + 1$.
The ring extension $k[x_1, \ldots, x_i]/(f_1, \ldots, f_i) \to
k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$
is generated by $1$ element over a field and one
irreducible equation. By elementary field theory
$k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$
is a field, and hence $\psi_i$ is injective.

\medskip\noindent
This implies that $\mathfrak m = (f_1, \ldots, f_n)$.
Moreover, we also conclude that
$$
k[x_1, \ldots, x_n]/(f_1, \ldots, f_i)
\cong
\kappa_i[x_{i + 1}, \ldots, x_n].
$$
Hence $(f_1, \ldots, f_i)$ is a prime ideal. Thus
$$
(0) \subset (f_1) \subset (f_1, f_2) \subset \ldots \subset
(f_1, \ldots, f_n) = \mathfrak m
$$
is a chain of primes of length $n$. The lemma follows.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-polynomial-ring}
A polynomial algebra in $n$ variables over a field is a regular ring.
It has global dimension $n$. All localizations at maximal ideals
are regular local rings of dimension $n$.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-dim-affine-space}
all localizations $k[x_1, \ldots, x_n]_{\mathfrak m}$
at maximal ideals are regular local rings of dimension $n$. Hence
we conclude by Lemma \ref{lemma-finite-gl-dim-finite-dim-regular}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-height-polynomial-ring}
Let $k$ be a field.
Let $\mathfrak p \subset \mathfrak q \subset k[x_1, \ldots, x_n]$
be a pair of primes.
Any maximal chain of primes between $\mathfrak p$ and $\mathfrak q$
has length $\text{height}(\mathfrak q) - \text{height}(\mathfrak p)$.
\end{lemma}

\begin{proof}
By
Proposition \ref{proposition-finite-gl-dim-polynomial-ring}
any local ring of $k[x_1, \ldots, x_n]$ is regular.
Hence all local rings are Cohen-Macaulay, see
Lemma \ref{lemma-regular-ring-CM}.
The local rings at maximal ideals have dimension $n$ hence
every maximal chain of primes in $k[x_1, \ldots, x_n]$
has length $n$, see
Lemma \ref{lemma-maximal-chain-CM}.
Hence every maximal chain of primes between $(0)$ and $\mathfrak p$
has length $\text{height}(\mathfrak p)$, see
Lemma \ref{lemma-CM-dim-formula}
for example.
Putting these together leads to the assertion of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dimension-spell-it-out}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra which is an integral domain.
Then $\dim(S) = \dim(S_{\mathfrak m})$ for any maximal
ideal $\mathfrak m$ of $S$. In words: every maximal chain
of primes has length equal to the dimension of $S$.
\end{lemma}

\begin{proof}
Write $S = k[x_1, \ldots, x_n]/\mathfrak p$.
By Proposition \ref{proposition-finite-gl-dim-polynomial-ring} and
Lemma \ref{lemma-dimension-height-polynomial-ring}
all the maximal chains of primes in $S$ (which necessarily end
with a maximal ideal) have length $n - \text{height}(\mathfrak p)$.
Thus this number is the dimension of $S$ and of $S_{\mathfrak m}$
for any maximal ideal $\mathfrak m$ of $S$.
\end{proof}

\noindent
Recall that we defined the
dimension $\dim_x(X)$ of a topological space $X$ at a point $x$
in Topology, Definition \ref{topology-definition-Krull}.

\begin{lemma}
\label{lemma-dimension-at-a-point-finite-type-over-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $X = \Spec(S)$.
Let $\mathfrak p \subset S$ be a prime ideal and let
$x \in X$ be the corresponding point.
The following numbers are equal
\begin{enumerate}
\item $\dim_x(X)$,
\item $\max \dim(Z)$ where the maximum is over those
irreducible components $Z$ of $X$ passing through $x$, and
\item $\min \dim(S_{\mathfrak m})$ where the minimum
is over maximal ideals $\mathfrak m$ with
$\mathfrak p \subset \mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X = \bigcup_{i \in I} Z_i$ be the decomposition of $X$ into
its irreducible components. There are finitely many of
them (see
Lemmas \ref{lemma-obvious-Noetherian} and \ref{lemma-Noetherian-topology}).
Let $I' = \{i \mid x \in Z_i\}$, and let
$T = \bigcup_{i \not \in I'} Z_i$. Then $U = X \setminus T$
is an open subset of $X$ containing the point $x$.
The number (2) is $\max_{i \in I'} \dim(Z_i)$.
For any open $W \subset U$ with $x \in W$
the irreducible components of $W$ are the irreducible sets
$W_i = Z_i \cap W$ for $i \in I'$ and $x$ is contained
in each of these.
Note that each $W_i$, $i \in I'$ contains a closed point because
$X$ is Jacobson, see Section \ref{section-ring-jacobson}.
Since $W_i \subset Z_i$ we have $\dim(W_i) \leq \dim(Z_i)$.
The existence of a closed point implies, via Lemma
\ref{lemma-dimension-spell-it-out}, that there is a chain of
irreducible closed subsets of length equal to $\dim(Z_i)$ in the open $W_i$.
Thus $\dim(W_i) = \dim(Z_i)$ for any $i \in I'$. Hence $\dim(W)$
is equal to the number (2). This proves that (1) $ = $ (2).

\medskip\noindent
Let $\mathfrak m \supset \mathfrak p$ be any maximal ideal
containing $\mathfrak p$. Let $x_0 \in X$ be the corresponding
point. First of all, $x_0$ is contained in all the
irreducible components $Z_i$, $i \in I'$. Let $\mathfrak q_i$
denote the minimal primes of $S$ corresponding to the
irreducible components $Z_i$. For each $i$ such that
$x_0 \in Z_i$ (which is equivalent to $\mathfrak m \supset \mathfrak q_i$)
we have a surjection
$$
S_{\mathfrak m} \longrightarrow
S_\mathfrak m/\mathfrak q_i S_\mathfrak m =(S/\mathfrak q_i)_{\mathfrak m}
$$
Moreover, the primes $\mathfrak q_i S_\mathfrak m$ so obtained
exhaust the minimal
primes of the Noetherian local ring $S_{\mathfrak m}$, see
Lemma \ref{lemma-irreducible-components-containing-x}.
We conclude, using Lemma \ref{lemma-dimension-spell-it-out},
that the dimension of $S_{\mathfrak m}$ is the
maximum of the dimensions of the $Z_i$ passing through $x_0$.
To finish the proof of the lemma it suffices to show that
we can choose $x_0$ such that $x_0 \in Z_i \Rightarrow i \in I'$.
Because $S$ is Jacobson (as we saw above)
it is enough to show that $V(\mathfrak p) \setminus T$
(with $T$ as above) is nonempty. And this is clear since it
contains the point $x$ (i.e. $\mathfrak p$).
\end{proof}

\begin{lemma}
\label{lemma-dimension-closed-point-finite-type-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $X = \Spec(S)$.
Let $\mathfrak m \subset S$ be a maximal ideal and let
$x \in X$ be the associated closed point.
Then $\dim_x(X) = \dim(S_{\mathfrak m})$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-disjoint-decomposition-CM-algebra}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Assume that $S$ is Cohen-Macaulay.
Then $\Spec(S) = \coprod T_d$ is a finite disjoint union of
open and closed subsets $T_d$ with $T_d$ equidimensional
(see Topology, Definition \ref{topology-definition-equidimensional})
of dimension $d$. Equivalently, $S$ is a product of rings
$S_d$, $d = 0, \ldots, \dim(S)$ such that every maximal ideal
$\mathfrak m$ of $S_d$ has height $d$.
\end{lemma}

\begin{proof}
The equivalence of the two statements follows from
Lemma \ref{lemma-disjoint-implies-product}.
Let $\mathfrak m \subset S$ be a maximal ideal.
Every maximal chain of primes in $S_{\mathfrak m}$ has
the same length equal to $\dim(S_{\mathfrak m})$, see
Lemma \ref{lemma-maximal-chain-CM}. Hence, the dimension of the irreducible
components passing through the point corresponding to $\mathfrak m$
all have dimension equal to $\dim(S_{\mathfrak m})$, see
Lemma \ref{lemma-dimension-spell-it-out}.
Since $\Spec(S)$ is a Jacobson topological space
the intersection
of any two irreducible components of it contains a closed point if nonempty,
see
Lemmas \ref{lemma-finite-type-field-Jacobson} and
\ref{lemma-jacobson}.
Thus we have shown that any two irreducible components
that meet have the same dimension. The lemma follows
easily from this, and the fact that $\Spec(S)$
has a finite number of irreducible components (see
Lemmas \ref{lemma-obvious-Noetherian} and \ref{lemma-Noetherian-topology}).
\end{proof}
















\section{Noether normalization}
\label{section-Noether-normalization}

\noindent
In this section we prove variants of the Noether normalization lemma.
The key ingredient we will use is contained in the following two lemmas.

\begin{lemma}
\label{lemma-helper}
Let $n \in \mathbf{N}$.
Let $N$ be a finite nonempty
set of multi-indices $\nu = (\nu_1, \ldots, \nu_n)$.
Given $e = (e_1, \ldots, e_n)$ we set $e \cdot \nu = \sum e_i\nu_i$.
Then for $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n$ we have:
If $\nu, \nu' \in N$ then
$$
(e \cdot \nu = e \cdot \nu')
\Leftrightarrow
(\nu = \nu')
$$
\end{lemma}

\begin{proof}
Say $N = \{\nu_j\}$ with $\nu_j = (\nu_{j1}, \ldots, \nu_{jn})$.
Let $A_i = \max_j \nu_{ji} - \min_j \nu_{ji}$. If for each $i$ we have
$e_{i - 1} > A_ie_i + A_{i + 1}e_{i + 1} + \ldots + A_ne_n$ then
the lemma holds. For suppose that $e \cdot (\nu - \nu') = 0$. Then for
$n \ge 2$,
$$
e_1(\nu_1 - \nu'_1) = \sum\nolimits_{i = 2}^n e_i(\nu'_i - \nu_i).
$$
We may assume that $(\nu_1 - \nu'_1) \ge 0$. If $(\nu_1 - \nu'_1) > 0$, then
$$
e_1(\nu_1 - \nu'_1) \ge e_1 >
A_2e_2 + \ldots + A_ne_n \ge
\sum\nolimits_{i = 2}^n e_i|\nu'_i - \nu_i| \ge
\sum\nolimits_{i = 2}^n e_i(\nu'_i - \nu_i).
$$
This contradiction implies that $\nu'_1 = \nu_1$. By
induction, $\nu'_i = \nu_i$ for $2 \le i \le n$.
\end{proof}

\begin{lemma}
\label{lemma-helper-polynomial}
Let $R$ be a ring. Let $g \in R[x_1, \ldots, x_n]$ be an element
which is nonconstant, i.e., $g \not \in R$.
For $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n = 1$ the polynomial
$$
g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}}, x_n)
=
ax_n^d + \text{lower order terms in }x_n
$$
where $d > 0$ and $a \in R$ is one of the nonzero coefficients of $g$.
\end{lemma}

\begin{proof}
Write $g = \sum_{\nu \in N} a_\nu x^\nu$ with $a_\nu \in R$ not zero.
Here $N$ is a finite set of multi-indices as in
Lemma \ref{lemma-helper}
and $x^\nu = x_1^{\nu_1} \ldots x_n^{\nu_n}$.
Note that the leading term in
$$
(x_1 + x_n^{e_1})^{\nu_1} \ldots (x_{n-1} + x_n^{e_{n-1}})^{\nu_{n-1}}
x_n^{\nu_n}
\text{\ \ is\ \ }x_n^{e_1\nu_1 + \ldots + e_{n-1}\nu_{n-1} + \nu_n}.
$$
Hence the lemma follows from
Lemma \ref{lemma-helper}
which guarantees that there is exactly one nonzero term $a_\nu x^\nu$ of $g$
which gives rise to the leading term of
$g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}},
x_n)$, i.e., $a = a_\nu$ for the unique $\nu \in N$ such that
$e \cdot \nu$ is maximal.
\end{proof}

\begin{lemma}
\label{lemma-one-relation}
Let $k$ be a field.
Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$.
If $I \not = 0$, then there exist $y_1, \ldots, y_{n-1} \in k[x_1, \ldots, x_n]$
such that $S$ is finite over $k[y_1, \ldots, y_{n-1}]$. Moreover we may
choose $y_i$ to be in the $\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$
generated by $x_1, \ldots, x_n$.
\end{lemma}

\begin{proof}
Pick $f \in I$, $f\not = 0$. It suffices to show the lemma
for $k[x_1, \ldots, x_n]/(f)$ since $S$ is a quotient of that ring.
We will take $y_i = x_i - x_n^{e_i}$, $i = 1, \ldots, n-1$
for suitable integers $e_i$. When does this work? It suffices
to show that $\overline{x_n} \in k[x_1, \ldots, x_n]/(f)$
is integral over the ring $k[y_1, \ldots, y_{n-1}]$. The
equation for $\overline{x_n}$ over this ring is
$$
f(y_1 + x_n^{e_1}, \ldots, y_{n-1} + x_n^{e_{n-1}}, x_n) = 0.
$$
Hence we are done if we can show there exists integers $e_i$ such
that the leading coefficient with respect to $x_n$ of the equation
above is a nonzero element of $k$. This can be achieved for example
by choosing $e_1 \gg e_2 \gg \ldots \gg e_{n-1}$, see
Lemma \ref{lemma-helper-polynomial}.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization}
Let $k$ be a field. Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$.
There exist $r\geq 0$, and $y_1, \ldots, y_r \in k[x_1, \ldots, x_n]$
such that (a) the map $k[y_1, \ldots, y_r] \to S$ is injective,
and (b) the map $k[y_1, \ldots, y_r] \to S$ is finite.
In this case the integer $r$ is the dimension of $S$.
Moreover we may choose $y_i$ to be in the
$\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$
generated by $x_1, \ldots, x_n$.
\end{lemma}

\begin{proof}
By induction on $n$, with $n = 0$ being trivial.
If $I = 0$, then take $r = n$ and $y_i = x_i$.
If $I \not = 0$, then choose $y_1, \ldots, y_{n-1}$
as in Lemma \ref{lemma-one-relation}. Let
$S' \subset S$ be the subring generated by
the images of the $y_i$. By induction we can
choose $r$ and $z_1, \ldots, z_r \in k[y_1, \ldots, y_{n-1}]$
such that (a), (b) hold for $k[z_1, \ldots, z_r]
\to S'$. Since $S' \to S$ is injective and finite
we see (a), (b) hold for $k[z_1, \ldots, z_r]
\to S$. The last assertion follows from Lemma
\ref{lemma-integral-sub-dim-equal}.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization-at-point}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra and denote $X = \Spec(S)$.
Let $\mathfrak q$ be a prime of $S$, and let $x \in X$ be the
corresponding point. There exists a $g \in S$, $g \not \in \mathfrak q$
such that $\dim(S_g) = \dim_x(X) =: d$ and such that
there exists a finite injective map $k[y_1, \ldots, y_d] \to S_g$.
\end{lemma}

\begin{proof}
Note that by definition $\dim_x(X)$ is the minimum
of the dimensions of $S_g$ for $g \in S$, $g \not \in \mathfrak q$, i.e.,
the minimum is attained. Thus the lemma follows from
Lemma \ref{lemma-Noether-normalization}.
\end{proof}

\begin{lemma}
\label{lemma-refined-Noether-normalization}
Let $k$ be a field. Let $\mathfrak q \subset k[x_1, \ldots, x_n]$
be a prime ideal. Set $r = \text{trdeg}_k\ \kappa(\mathfrak q)$.
Then there exists a finite ring map
$\varphi : k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]$ such
that $\varphi^{-1}(\mathfrak q) = (y_{r + 1}, \ldots, y_n)$.
\end{lemma}

\begin{proof}
By induction on $n$. The case $n = 0$ is clear. Assume $n > 0$.
If $r = n$, then $\mathfrak q = (0)$ and the result is clear.
Choose a nonzero $f \in \mathfrak q$. Of course $f$ is nonconstant.
After applying an automorphism of the form
$$
k[x_1, \ldots, x_n] \longrightarrow k[x_1, \ldots, x_n],
\quad
x_n \mapsto x_n,
\quad
x_i \mapsto x_i + x_n^{e_i}\ (i < n)
$$
we may assume that $f$ is monic in $x_n$ over $k[x_1, \ldots, x_n]$, see
Lemma \ref{lemma-helper-polynomial}. Hence the ring map
$$
k[y_1, \ldots, y_n] \longrightarrow k[x_1, \ldots, x_n],
\quad
y_n \mapsto f,
\quad
y_i \mapsto x_i\ (i < n)
$$
is finite. Moreover $y_n \in \mathfrak q \cap k[y_1, \ldots, y_n]$ by
construction. Thus
$\mathfrak q \cap k[y_1, \ldots, y_n] = \mathfrak pk[y_1, \ldots, y_n] + (y_n)$
where $\mathfrak p \subset k[y_1, \ldots, y_{n - 1}]$ is a prime ideal.
Note that $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite, and
hence $r = \text{trdeg}_k\ \kappa(\mathfrak p)$.
Apply the induction hypothesis to the pair
$(k[y_1, \ldots, y_{n - 1}], \mathfrak p)$ and we obtain a finite ring map
$k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$ such that
$\mathfrak p \cap k[z_1, \ldots, z_{n - 1}] = (z_{r + 1}, \ldots, z_{n - 1})$.
We extend the ring map
$k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$
to a ring map
$k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n]$
by mapping $z_n$ to $y_n$.
The composition of the ring maps
$$
k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]
$$
solves the problem.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization-over-a-domain}
Let $R \to S$ be an injective finite type map of domains. Then there exists an
integer $d$ and factorization
$$
R \to R[y_1, \ldots, y_d] \to S' \to S
$$
by injective maps such that $S'$ is finite over $R[y_1, \ldots, y_d]$
and such that $S'_f \cong S_f$ for some nonzero $f \in R$.
\end{lemma}

\begin{proof}
Pick $x_1, \ldots, x_n \in S$ which generate $S$ over $R$.
Let $K = f.f.(R)$ and $S_K = S \otimes_R K$.
By Lemma \ref{lemma-Noether-normalization}
we can find $y_1, \ldots, y_d \in S$ such that $K[y_1, \ldots, y_d] \to S_K$
is a finite injective map. Note that $y_i \in S$ because we may pick the
$y_j$ in the $\mathbf{Z}$-algebra generated by $x_1, \ldots, x_n$.
As a finite ring map is integral (see
Lemma \ref{lemma-finite-is-integral})
we can find monic $P_i \in K[y_1, \ldots, y_d][T]$ such that
$P_i(x_i) = 0$ in $S_K$. Let $f \in R$ be a nonzero element such that
$fP_i \in R[y_1, \ldots, y_d][T]$ for all $i$. Set $x_i' = fx_i$
and let $S' \subset S$ be the subalgebra generated by $y_1, \ldots, y_d$
and $x'_1, \ldots, x'_n$. Note that $x'_i$ is integral over
$R[y_1, \ldots, y_d]$ as we have $Q_i(x_i') = 0$ where
$Q_i = f^{\deg_T(P_i)}P_i(T/f)$ which is a monic polynomial in
$T$ with coefficients in $R[y_1, \ldots, y_d]$ by our choice of $f$.
Hence $R[y_1, \ldots, y_n] \subset S'$ is finite by
Lemma \ref{lemma-characterize-finite-in-terms-of-integral}.
By construction $S'_f \cong S_f$ and we win.
\end{proof}





\section{Dimension of finite type algebras over fields, reprise}
\label{section-dimension-finite-type-algebras-reprise}

\noindent
This section is a continuation of
Section \ref{section-dimension-finite-type-algebras}.
In this section we establish the connection between dimension and
transcendence degree over the ground field for finite type domains
over a field.

\begin{lemma}
\label{lemma-dimension-prime-polynomial-ring}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra which is an integral domain.
Let $K = f.f.(S)$ be the field of fractions of $S$.
Let $r = \text{trdeg}(K/k)$ be the transcendence degree of $K$ over $k$.
Then $\dim(S) = r$. Moreover, the local ring of $S$ at every maximal
ideal has dimension $r$.
\end{lemma}

\begin{proof}
We may write $S = k[x_1, \ldots, x_n]/\mathfrak p$.
By Lemma \ref{lemma-dimension-height-polynomial-ring}
all local rings of $S$ at maximal ideals have the same dimension.
Apply Lemma \ref{lemma-Noether-normalization}.
We get a finite injective ring map
$$
k[y_1, \ldots, y_d] \to S
$$
with $d = \dim(S)$. Clearly, $k(y_1, \ldots, y_d) \subset K$
is a finite extension and we win.
\end{proof}

\begin{lemma}
\label{lemma-tr-deg-specialization}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset \mathfrak q' \subset S$ be distinct
prime ideals. Then
$\text{trdeg}_k\ \kappa(\mathfrak q') < \text{trdeg}_k\ \kappa(\mathfrak q)$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-dimension-prime-polynomial-ring}
we have $\dim V(\mathfrak q) = \text{trdeg}_k\ \kappa(\mathfrak q)$
and similarly for $\mathfrak q'$. Hence the result follows
as the strict inclusion $V(\mathfrak q') \subset V(\mathfrak q)$
implies a strict inequality of dimensions.
\end{proof}

\noindent
The following lemma generalizes
Lemma \ref{lemma-dimension-closed-point-finite-type-field}.

\begin{lemma}
\label{lemma-dimension-at-a-point-finite-type-field}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Let $X = \Spec(S)$.
Let $\mathfrak p \subset S$ be a prime ideal,
and let $x \in X$ be the corresponding point.
Then we have
$$
\dim_x(X) = \dim(S_{\mathfrak p}) + \text{trdeg}_k\ \kappa(\mathfrak p).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-prime-polynomial-ring} we know that
$r = \text{trdeg}_k\ \kappa(\mathfrak p)$ is equal to the
dimension of $V(\mathfrak p)$.
Pick any maximal chain of primes
$\mathfrak p \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_r$
starting with $\mathfrak p$ in $S$.
This has length $r$ by Lemma \ref{lemma-dimension-spell-it-out}.
Let $\mathfrak q_j$, $j \in J$ be the minimal
primes of $S$ which are contained in $\mathfrak p$.
These correspond $1-1$ to minimal primes in $S_{\mathfrak p}$
via the rule $\mathfrak q_j \mapsto \mathfrak q_jS_{\mathfrak p}$.
By Lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}
we know that $\dim_x(X)$ is equal
to the maximum of the dimensions of the rings $S/\mathfrak q_j$.
For each $j$ pick a maximal chain of primes
$\mathfrak q_j \subset \mathfrak p'_1 \subset \ldots \subset \mathfrak p'_{s(j)}
= \mathfrak p$.
Then $\dim(S_{\mathfrak p}) = \max_{j \in J} s(j)$.
Now, each chain
$$
\mathfrak q_i \subset \mathfrak p'_1 \subset \ldots \subset
\mathfrak p'_{s(j)} = \mathfrak p \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_r
$$
is a maximal chain in $S/\mathfrak q_j$, and by what was said
before we have
$\dim_x(X) = \max_{j \in J} r + s(j)$.
The lemma follows.
\end{proof}

\noindent
The following lemma says that the codimension of one finite type
Spec in another is the difference of heights.

\begin{lemma}
\label{lemma-codimension}
Let $k$ be a field.
Let $S' \to S$ be a surjection of finite type $k$ algebras.
Let $\mathfrak p \subset S$ be a prime ideal,
and let $\mathfrak p'$ be the corresponding prime ideal of $S'$.
Let $X = \Spec(S)$, resp.\ $X' = \Spec(S')$,
and let $x \in X$, resp. $x'\in X'$ be the point corresponding
to $\mathfrak p$, resp.\ $\mathfrak p'$.
Then
$$
\dim_{x'} X' - \dim_x X =
\text{height}(\mathfrak p') - \text{height}(\mathfrak p).
$$
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-dimension-at-a-point-finite-type-field}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-preserved-field-extension}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $k \subset K$ be a field extension.
Then $\dim(S) = \dim(K \otimes_k S)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noether-normalization}
there exists a finite injective map
$k[y_1, \ldots, y_d] \to S$ with $d = \dim(S)$.
Since $K$ is flat over $k$ we also get a finite injective
map $K[y_1, \ldots, y_d] \to K \otimes_k S$.
The result follows from Lemma \ref{lemma-integral-sub-dim-equal}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-at-a-point-preserved-field-extension}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Set $X = \Spec(S)$.
Let $k \subset K$ be a field extension.
Set $S_K = K \otimes_k S$, and $X_K = \Spec(S_K)$.
Let $\mathfrak q \subset S$ be a prime corresponding to $x \in X$
and let $\mathfrak q_K \subset S_K$ be a prime corresponding
to $x_K \in X_K$ lying over $\mathfrak q$.
Then $\dim_x X = \dim_{x_K} X_K$.
\end{lemma}

\begin{proof}
Choose a presentation $S = k[x_1, \ldots, x_n]/I$.
This gives a presentation
$K \otimes_k S = K[x_1, \ldots, x_n]/(K \otimes_k I)$.
Let $\mathfrak q_K' \subset K[x_1, \ldots, x_n]$,
resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be
the corresponding primes. Consider the following
commutative diagram of Noetherian local rings
$$
\xymatrix{
K[x_1, \ldots, x_n]_{\mathfrak q_K'} \ar[r] &
(K \otimes_k S)_{\mathfrak q_K} \\
k[x_1, \ldots, x_n]_{\mathfrak q'} \ar[r] \ar[u] &
S_{\mathfrak q} \ar[u]
}
$$
Both vertical arrows are flat because they are localizations of
the flat ring maps $S \to S_K$ and
$k[x_1, \ldots, x_n] \to K[x_1, \ldots, x_n]$.
Moreover, the vertical arrows have the same fibre rings.
Hence, we see from
Lemma \ref{lemma-dimension-base-fibre-equals-total} that
$\text{height}(\mathfrak q') - \text{height}(\mathfrak q)
= \text{height}(\mathfrak q_K') - \text{height}(\mathfrak q_K)$.
Denote $x' \in X' = \Spec(k[x_1, \ldots, x_n])$
and $x'_K \in X'_K = \Spec(K[x_1, \ldots, x_n])$
the points corresponding to $\mathfrak q'$ and
$\mathfrak q_K'$. By Lemma \ref{lemma-codimension} and what we showed
above we have
\begin{eqnarray*}
n - \dim_x X & = & \dim_{x'} X' - \dim_x X \\
& = & \text{height}(\mathfrak q') - \text{height}(\mathfrak q) \\
& = & \text{height}(\mathfrak q_K') - \text{height}(\mathfrak q_K) \\
& = & \dim_{x'_K} X'_K - \dim_{x_K} X_K \\
& = & n - \dim_{x_K} X_K
\end{eqnarray*}
and the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-inequalities-under-field-extension}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $k \subset K$ be a field extension. Set $S_K = K \otimes_k S$.
Let $\mathfrak q \subset S$ be a prime and let $\mathfrak q_K \subset S_K$
be a prime lying over $\mathfrak q$. Then
$$
\dim (S_K \otimes_S \kappa(\mathfrak q))_{\mathfrak q_K} =
\dim (S_K)_{\mathfrak q_K} - \dim S_\mathfrak q =
\text{trdeg}_k \kappa(\mathfrak q) - \text{trdeg}_K \kappa(\mathfrak q_K)
$$
Moreover, given $\mathfrak q$ we can always choose $\mathfrak q_K$ such
that the number above is zero.
\end{lemma}

\begin{proof}
Observe that $S_\mathfrak q \to (S_K)_{\mathfrak q_K}$ is a flat
local homomorphism of local Noetherian rings with special fibre
$(S_K \otimes_S \kappa(\mathfrak q))_{\mathfrak q_K}$. Hence the first
equality by Lemma \ref{lemma-dimension-base-fibre-equals-total}.
The second equality follows from the fact that we have
$\dim_x X = \dim_{x_K} X_K$ with notation as in
Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
and we have
$\dim_x X = \dim S_\mathfrak q + \text{trdeg}_k \kappa(\mathfrak q)$
by Lemma \ref{lemma-dimension-at-a-point-finite-type-field}
and similarly for $\dim_{x_K} X_K$.
If we choose $\mathfrak q_K$ minimal over $\mathfrak q S_K$, then
the dimension of the fibre ring will be zero.
\end{proof}







\section{Dimension of graded algebras over a field}
\label{section-dimension-graded}

\noindent
Here is a basic result.

\begin{lemma}
\label{lemma-dimension-graded}
Let $k$ be a field.
Let $S$ be a finitely generated graded algebra over $k$.
Assume $S_0 = k$. Let $P(T) \in \mathbf{Q}[T]$ be the polynomial
such that $\dim(S_d) = P(d)$ for all $d \gg 0$. See
Proposition \ref{proposition-graded-hilbert-polynomial}.
Then
\begin{enumerate}
\item The irrelevant ideal $S_{+}$ is a maximal ideal $\mathfrak m$.
\item Any minimal prime of $S$ is a homogeneous ideal and is contained
in $S_{+} = \mathfrak m$.
\item We have $\dim(S) = \deg(P) + 1 = \dim_x\Spec(S)$
(with the convention that $\deg(0) = -1$)
where $x$ is the point corresponding to the maximal ideal
$S_{+} = \mathfrak m$.
\item The Hilbert function of the local ring $R = S_{\mathfrak m}$
is equal to the Hilbert function of $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement is obvious.
The second follows from Lemma \ref{lemma-graded-ring-minimal-prime}.
The equality $\dim(S) = \dim_x\Spec(S)$ follows from the
fact that every irreducible component passes through $x$ according
to (2). Hence we may compute this dimension as the dimension of
the local ring $R = S_{\mathfrak m}$ with $\mathfrak m = S_{+}$ by
Lemma \ref{lemma-dimension-closed-point-finite-type-field}.
Since
$\mathfrak m^d/\mathfrak m^{d + 1} \cong \mathfrak m^dR/\mathfrak m^{d + 1}R$
we see that the Hilbert function of the local ring $R$ is equal to the
Hilbert function of $S$, which is (4). We conclude the last equality
of (3) by Proposition \ref{proposition-dimension}.
\end{proof}













\section{Generic flatness}
\label{section-generic-flatness}

\noindent
Basically this says that a finite type algebra over a domain becomes
flat after inverting a single element of the domain.
There are several versions of this result (in increasing order of
strength).

\begin{lemma}
\label{lemma-generic-flatness-Noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R$ is a domain,
\item $R \to S$ is of finite type, and
\item $M$ is a finite type $S$-module.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
$M_f$ is a free $R_f$-module.
\end{lemma}

\begin{proof}
Let $K$ be the fraction field of $R$. Set $S_K = K \otimes_R S$. This
is an algebra of finite type over $K$. We will argue by induction on
$d = \dim(S_K)$ (which is finite for example by Noether normalization, see
Section \ref{section-Noether-normalization}).
Fix $d \geq 0$.
Assume we know that the lemma holds in all cases where $\dim(S_K) < d$.

\medskip\noindent
Suppose given $R \to S$ and $M$ as in the lemma with $\dim(S_K) = d$. By
Lemma \ref{lemma-filter-Noetherian-module}
there exists a filtration
$0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M$
so that $M_i/M_{i - 1}$ is isomorphic to $S/\mathfrak q$
for some prime $\mathfrak q$ of $S$. Note that
$\dim((S/\mathfrak q)_K) \leq \dim(S_K)$. Also, note that an extension of
free modules is free (see basic notion \ref{item-extension-free}).
Thus we may assume $M = S$ and that $S$ is a domain of finite type over $R$.

\medskip\noindent
If $R \to S$ has a nontrivial kernel, then take a nonzero $f \in R$ in
this kernel. In this case $S_f = 0$ and the lemma holds. (This is really
the case $d = -1$ and the start of the induction.) Hence we
may assume that $R \to S$ is a finite type extension of Noetherian domains.

\medskip\noindent
Apply Lemma \ref{lemma-Noether-normalization-over-a-domain}
and replace $R$ by $R_f$ (with $f$ as in the lemma) to get a
factorization
$$
R \subset R[y_1, \ldots, y_d] \subset S
$$
where the second extension is finite.
Note that $f.f.(R[y_1, \ldots, y_d]) \subset f.f.(S)$ is a finite
extension of fields. Choose $z_1, \ldots, z_r \in S$ which form
a basis for $f.f.(S)$ over $f.f.(R[y_1, \ldots, y_d])$.
This gives a short exact sequence
$$
0 \to
R[y_1, \ldots, y_d]^{\oplus r} \xrightarrow{(z_1, \ldots, z_r)}
S \to N \to 0
$$
By construction $N$ is a finite $R[y_1, \ldots, y_d]$-module whose
support does not contain the generic point $(0)$ of
$\Spec(R[y_1, \ldots, y_d])$. By
Lemma \ref{lemma-support-closed}
there exists a nonzero $g \in R[y_1, \ldots, y_d]$ such that
$g$ annihilates $N$, so we may view $N$ as a finite module over
$S' = R[y_1, \ldots, y_d]/(g)$. Since $\dim(S'_K) < d$ by induction
there exists a nonzero $f \in R$ such that $N_f$ is a free
$R_f$-module. Since
$(R[y_1, \ldots, y_d])_f \cong R_f[y_1, \ldots, y_d]$ is free
also we conclude by the already mentioned fact that an extension
of free modules is free.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-finitely-presented}
\begin{slogan}
Generic freeness.
\end{slogan}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a domain,
\item $R \to S$ is of finite presentation, and
\item $M$ is an $S$-module of finite presentation.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
$M_f$ is a free $R_f$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
For $g \in R[x_1, \ldots, x_n]$ denote $\overline{g}$ its image in $S$.
We may write $M = S^{\oplus t}/\sum Sn_i$ for some $n_i \in S^{\oplus t}$.
Write $n_i = (\overline{g}_{i1}, \ldots, \overline{g}_{it})$ for some
$g_{ij} \in R[x_1, \ldots, x_n]$. Let $R_0 \subset R$ be the subring
generated by all the coefficients of all the elements
$g_i, g_{ij} \in R[x_1, \ldots, x_n]$. Define
$S_0 = R_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
Define $M_0 = S_0^{\oplus t}/\sum S_0n_i$.
Then $R_0$ is a domain of finite type over $\mathbf{Z}$ and hence
Noetherian (see
Lemma \ref{lemma-Noetherian-permanence}).
Moreover via the injection $R_0 \to R$ we have $S \cong R \otimes_{R_0} S_0$
and $M \cong R \otimes_{R_0} M_0$. Applying
Lemma \ref{lemma-generic-flatness-Noetherian}
we obtain a nonzero $f \in R_0$ such that $(M_0)_f$ is a free
$(R_0)_f$-module. Hence $M_f = R_f \otimes_{(R_0)_f} (M_0)_f$
is a free $R_f$-module.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a domain,
\item $R \to S$ is of finite type, and
\item $M$ is a finite type $S$-module.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
\begin{enumerate}
\item[(a)] $M_f$ and $S_f$ are free as $R_f$-modules, and
\item[(b)] $S_f$ is a finitely presented $R_f$-algebra and $M_f$ is a
finitely presented $S_f$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the lemma for $S = R[x_1, \ldots, x_n]$, and then
we deduce the result in general.

\medskip\noindent
Assume $S = R[x_1, \ldots, x_n]$.
Choose elements $m_1, \ldots, m_t$ which generate $M$. This gives
a short exact sequence
$$
0 \to N \to S^{\oplus t} \xrightarrow{(m_1, \ldots, m_t)} M \to 0.
$$
Denote $K$ the fraction field of $R$. Denote
$S_K = K \otimes_R S = K[x_1, \ldots, x_n]$, and similarly
$N_K = K \otimes_R N$, $M_K = K \otimes_R M$.
As $R \to K$ is flat the sequence remains flat after tensoring with $K$.
As $S_K = K[x_1, \ldots, x_n]$ is a Noetherian ring (see
Lemma \ref{lemma-Noetherian-permanence})
we can find finitely many elements $n'_1, \ldots, n'_s \in N_K$
which generate it. Choose $n_1, \ldots, n_r \in N$ such that
$n'_i = \sum a_{ij}n_j$ for some $a_{ij} \in K$. Set
$$
M' = S^{\oplus t}/\sum\nolimits_{i = 1, \ldots, r} Sn_i
$$
By construction $M'$ is a finitely presented $S$-module, and
there is a surjection $M' \to M$ which induces an isomorphism
$M'_K \cong M_K$. We may apply
Lemma \ref{lemma-generic-flatness-finitely-presented}
to $R \to S$ and $M'$ and we find an $f \in R$ such that $M'_f$
is a free $R_f$-module. Thus $M'_f \to M_f$ is a surjection of
modules over the domain $R_f$ where the source is a free module
and which becomes an isomorphism upon tensoring with $K$.
Thus it is injective as $M'_f \subset M'_K$ as it is free over
the domain $R_f$. Hence $M'_f \to M_f$ is an isomorphism and the
result is proved.

\medskip\noindent
For the general case, choose a surjection $R[x_1, \ldots, x_n] \to S$.
Think of both $S$ and $M$ as finite modules over $R[x_1, \ldots, x_n]$.
By the special case proved above there exists a nonzero $f \in R$
such that both $S_f$ and $M_f$ are free as $R_f$-modules and finitely
presented as $R_f[x_1, \ldots, x_n]$-modules. Clearly this implies that
$S_f$ is a finitely presented $R_f$-algebra and that $M_f$ is a
finitely presented $S_f$-module.
\end{proof}

\noindent
Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Consider
the following condition on an element $f \in R$:
\begin{equation}
\label{equation-flat-and-finitely-presented}
\left\{
\begin{matrix}
S_f & \text{is of finite presentation over }R_f\\
M_f & \text{is of finite presentation as }S_f\text{-module}\\
S_f, M_f & \text{are free as }R_f\text{-modules}
\end{matrix}
\right.
\end{equation}
We define
\begin{equation}
\label{equation-good-locus}
U(R \to S, M)
=
\bigcup\nolimits_{f \in
R\text{ with }(\ref{equation-flat-and-finitely-presented})}
D(f)
\end{equation}
which is an open subset of $\Spec(R)$.

\begin{lemma}
\label{lemma-generic-flatness-locus-extension}
Let $R \to S$ be a ring map.
Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a short exact sequence
of $S$-modules.
Then
$$
U(R \to S, M_1) \cap U(R \to S, M_3) \subset U(R \to S, M_2).
$$
\end{lemma}

\begin{proof}
Let $u \in U(R \to S, M_1) \cap U(R \to S, M_3)$. Choose
$f_1, f_3 \in R$ such that $u \in D(f_1)$, $u \in D(f_3)$ and
such that (\ref{equation-flat-and-finitely-presented}) holds for
$f_1$ and $M_1$ and for $f_3$ and $M_3$. Then set $f = f_1f_3$.
Then $u \in D(f)$ and (\ref{equation-flat-and-finitely-presented})
holds for $f$ and both $M_1$ and $M_3$. An extension of free modules
is free, and an extension of finitely presented modules is finitely presented
(Lemma \ref{lemma-extension}). Hence we see that
(\ref{equation-flat-and-finitely-presented}) holds for $f$ and $M_2$.
Thus $u \in U(R \to S, M_2)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-locus-localize}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $f \in R$.
Using the identification $\Spec(R_f) = D(f)$ we have
$U(R_f \to S_f, M_f) = D(f) \cap U(R \to S, M)$.
\end{lemma}

\begin{proof}
Suppose that $u \in U(R_f \to S_f, M_f)$. Then there exists an
element $g \in R_f$ such that $u \in D(g)$ and such that
(\ref{equation-flat-and-finitely-presented})
holds for the pair $((R_f)_g \to (S_f)_g, (M_f)_g)$.
Write $g = a/f^n$ for some $a \in R$. Set $h = af$.
Then $R_h = (R_f)_g$, $S_h = (S_f)_g$, and $M_h = (M_f)_g$.
Moreover $u \in D(h)$. Hence $u \in U(R \to S, M)$.
Conversely, suppose that $u \in D(f) \cap U(R \to S, M)$.
Then there exists an element $g \in R$ such that $u \in D(g)$ and such that
(\ref{equation-flat-and-finitely-presented})
holds for the pair $(R_g \to S_g, M_g)$.
Then it is clear that (\ref{equation-flat-and-finitely-presented})
also holds for the pair
$(R_{fg} \to S_{fg}, M_{fg}) = ((R_f)_g \to (S_f)_g, (M_f)_g)$.
Hence $u \in U(R_f \to S_f, M_f)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-locus-reduce}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $U \subset \Spec(R)$ be a dense open.
Assume there is a covering $U = \bigcup_{i \in I} D(f_i)$ of
opens such that $U(R_{f_i} \to S_{f_i}, M_{f_i})$ is dense in
$D(f_i)$ for each $i \in I$. Then $U(R \to S, M)$ is dense in
$\Spec(R)$.
\end{lemma}

\begin{proof}
In view of
Lemma \ref{lemma-generic-flatness-locus-localize}
this is a purely topological statement. Namely, by that lemma
we see that $U(R \to S, M) \cap D(f_i)$ is dense in $D(f_i)$
for each $i \in I$. By
Topology, Lemma \ref{topology-lemma-nowhere-dense-local}
we see that $U(R \to S, M) \cap U$ is dense in $U$.
Since $U$ is dense in $\Spec(R)$ we conclude that $U(R \to S, M)$
is dense in $\Spec(R)$.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-reduced}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module, and
\item $R$ is reduced.
\end{enumerate}
Then there exists a subset $U \subset \Spec(R)$ such that
\begin{enumerate}
\item $U$ is open and dense in $\Spec(R)$,
\item for every $u \in U$ there exists an $f \in R$ such
that $u \in D(f) \subset U$ and such that we have
\begin{enumerate}
\item $M_f$ and $S_f$ are free over $R_f$,
\item $S_f$ is a finitely presented $R_f$-algebra, and
\item $M_f$ is a finitely presented $S_f$-module.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the lemma is equivalent to the statement that the open
$U(R \to S, M)$, see Equation (\ref{equation-good-locus}), is dense
in $\Spec(R)$. We first prove the lemma for
$S = R[x_1, \ldots, x_n]$, and then
we deduce the result in general.

\medskip\noindent
Proof of the case $S = R[x_1, \ldots, x_n]$ and $M$ any finite module
over $S$. Note that in this case $S_f = R_f[x_1, \ldots, x_n]$
is free and of finite presentation over $R_f$, so we do not have
to worry about the conditions regarding $S$,
only those that concern $M$. We will use induction on $n$.

\medskip\noindent
There exists a finite filtration
$$
0 \subset M_1 \subset M_2 \subset \ldots \subset M_t = M
$$
such that $M_i/M_{i - 1} \cong S/J_i$ for some ideal $J_i \subset S$, see
Lemma \ref{lemma-trivial-filter-finite-module}. Since
a finite intersection of dense opens is dense open,
we see from
Lemma \ref{lemma-generic-flatness-locus-extension}
that it suffices to prove the lemma for each of the modules $R/J_i$.
Hence we may assume that $M = S/J$ for some ideal $J$ of
$S = R[x_1, \ldots, x_n]$.

\medskip\noindent
Let $I \subset R$ be the ideal generated by the coefficients of
elements of $J$. Let $U_1 = \Spec(R) \setminus V(I)$ and
let
$$
U_2 = \Spec(R) \setminus \overline{U_1}.
$$
Then it is clear that $U = U_1 \cup U_2$ is dense in $\Spec(R)$.
Let $f \in R$ be an element such that either (a) $D(f) \subset U_1$ or
(b) $D(f) \subset U_2$. If for any such $f$
the lemma holds for the pair $(R_f \to R_f[x_1, \ldots, x_n], M_f)$
then by
Lemma \ref{lemma-generic-flatness-locus-reduce}
we see that $U(R \to S, M)$ is dense in $\Spec(R)$.
Hence we may assume either (a) $I = R$, or (b) $V(I) = \Spec(R)$.

\medskip\noindent
In case (b) we actually have $I = 0$ as $R$ is reduced! Hence $J = 0$
and $M = S$ and the lemma holds in this case.

\medskip\noindent
In case (a) we have to do a little bit more work. Note that every element
of $I$ is actually the coefficient of a monomial of an element of $J$, because
the set of coefficients of elements of $J$ forms an ideal (details omitted).
Hence we find an element
$$
g = \sum\nolimits_{K \in E} a_K x^K \in J
$$
where $E$ is a finite set of multi-indices $K = (k_1, \ldots, k_n)$
with at least one coefficient $a_{K_0}$ a unit in $R$. Actually we can
find one which has a coefficient equal to $1$ as $1 \in I$ in case (a).
Let $m = \#\{K \in E \mid a_K \text{ is not a unit}\}$.
Note that $0 \leq m \leq \# E - 1$.
We will argue by induction on $m$.

\medskip\noindent
The case $m = 0$. In this case all the coefficients $a_K$, $K \in E$
of $g$ are units and $E \not = \emptyset$.
If $E = \{K_0\}$ is a singleton and $K_0 = (0, \ldots, 0)$, then $g$
is a unit and $J = S$ so the result holds for sure. (This happens in
particular when $n = 0$ and it provides the base case of the induction
on $n$.) If not $E = \{(0, \ldots, 0)\}$, then at least one $K$ is not
equal to $(0, \ldots, 0)$, i.e., $g \not \in R$. At this point we employ
the usual trick of Noether normalization. Namely, we consider
$$
G(y_1, \ldots, y_n) =
g(y_1 + y_n^{e_1}, y_2 + y_n^{e_2}, \ldots, y_{n - 1} + y_n^{e_{n - 1}}, y_n)
$$
with $0 \ll e_{n -1} \ll e_{n - 2} \ll \ldots \ll e_1$. By
Lemma \ref{lemma-helper-polynomial}
it follows that $G(y_1, \ldots, y_n)$ as a polynomial in $y_n$
looks like
$$
a_K y_n^{k_n + \sum_{i = 1, \ldots, n - 1} e_i k_i} +
\text{lower order terms in }y_n
$$
As $a_K$ is a unit we conclude that $M = R[x_1, \ldots, x_n]/J$ is
finite over $R[y_1, \ldots, y_{n - 1}]$. Hence
$U(R \to R[x_1, \ldots, x_n], M) = U(R \to R[y_1, \ldots, y_{n - 1}], M)$
and we win by induction on $n$.

\medskip\noindent
The case $m > 0$. Pick a multi-index $K \in E$ such that $a_K$ is
not a unit. As before set
$U_1 = \Spec(R_{a_K}) = \Spec(R) \setminus V(a_K)$
and set
$$
U_2 = \Spec(R) \setminus \overline{U_1}.
$$
Then it is clear that $U = U_1 \cup U_2$ is dense in $\Spec(R)$.
Let $f \in R$ be an element such that either (a) $D(f) \subset U_1$ or
(b) $D(f) \subset U_2$. If for any such $f$
the lemma holds for the pair $(R_f \to R_f[x_1, \ldots, x_n], M_f)$
then by
Lemma \ref{lemma-generic-flatness-locus-reduce}
we see that $U(R \to S, M)$ is dense in $\Spec(R)$.
Hence we may assume either (a) $a_KR = R$, or (b) $V(a_K) = \Spec(R)$.
In case (a) the number $m$ drops, as $a_K$ has turned into a unit.
In case (b), since $R$ is reduced, we conclude that $a_K = 0$.
Hence the set $E$ decreases so the number $m$ drops as well.
In both cases we win by induction on $m$.

\medskip\noindent
At this point we have proven the lemma in case $S = R[x_1, \ldots, x_n]$.
Assume that $(R \to S, M)$ is an arbitrary pair satisfying the conditions of
the lemma. Choose a surjection $R[x_1, \ldots, x_n] \to S$. Observe that,
with the notation introduced in (\ref{equation-good-locus}), we have
$$
U(R \to S, M) =
U(R \to R[x_1, \ldots, x_n], S)
\cap
U(R \to R[x_1, \ldots, x_n], S)
$$
Hence as we've just finished proving the right two opens are dense also
the open on the left is dense.
\end{proof}






\section{Around Krull-Akizuki}
\label{section-krull-akizuki}

\noindent
One application of Krull-Akizuki is to show that there are plenty
of discrete valuation rings. More generally in this section we
show how to construct discrete valuation rings dominating Noetherian
local rings.

\medskip\noindent
First we show how to dominate a Noetherian local domain
by a $1$-dimensional Noetherian local domain by blowing up
the maximal ideal.

\begin{lemma}
\label{lemma-dominate-by-dimension-1}
Let $R$ be a local Noetherian domain with fraction field $K$.
Assume $R$ is not a field.
Then there exist $R \subset R' \subset K$ with
\begin{enumerate}
\item $R'$ local Noetherian of dimension $1$,
\item $R \to R'$ a local ring map, i.e., $R'$ dominates $R$, and
\item $R \to R'$ essentially of finite type.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose any valuation ring $A \subset K$ dominating $R$ (which
exist by Lemma \ref{lemma-dominate}).
Denote $v$ the corresponding valuation.
Let $x_1, \ldots, x_r$ be a minimal set of generators of the
maximal ideal $\mathfrak m$ of $R$. We may and do assume that
$v(x_r) = \min\{v(x_1), \ldots, v(x_r)\}$. Consider the ring
$$
S = R[x_1/x_r, x_2/x_r, \ldots, x_{r - 1}/x_r] \subset K.
$$
Note that $\mathfrak mS = x_rS$ is a principal ideal.
Note that $S \subset A$ and that $v(x_r) > 0$, hence we see
that $x_rS \not = S$. Choose a minimal prime $\mathfrak q$
over $x_rS$. Then $\text{height}(\mathfrak q) = 1$ by
Lemma \ref{lemma-minimal-over-1}
and $\mathfrak q$ lies over $\mathfrak m$. Hence we
see that $R' = S_{\mathfrak q}$ is a solution.
\end{proof}

\begin{lemma}[Koll\'ar]
\label{lemma-hart-serre-loc-thm}
\begin{reference}
This is taken from a forthcoming paper by
J\'anos Koll\'ar entitled ``Variants of normality for Noetherian schemes''.
\end{reference}
Let $(R, \mathfrak m)$ be a local Noetherian ring.
Then exactly one of the following holds:
\begin{enumerate}
\item $(R, \mathfrak m)$ is Artinian,
\item $(R, \mathfrak m)$ is regular of dimension $1$,
\item $\text{depth}(R) \geq 2$, or
\item there exists a finite ring map $R \to R'$ which is not
an isomorphism whose kernel and cokernel are annihilated by a power
of $\mathfrak m$ such that $\mathfrak m$ is not an associated
prime of $R'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $(R, \mathfrak m)$ is not Artinian if and only if
$V(\mathfrak m) \subset \Spec(R)$ is nowhere dense. See
Proposition \ref{proposition-dimension-zero-ring}. We assume this from now on.

\medskip\noindent
Let $J \subset R$ be the largest ideal killed by a power of $\mathfrak m$.
If $J \not = 0$ then $R \to R/J$ shows that $(R, \mathfrak m)$
is as in (4).

\medskip\noindent
Otherwise $J = 0$. In particular $\mathfrak m$ is not an associated prime
of $R$ and we see that there is a nonzerodivisor $x \in \mathfrak m$ by
Lemma \ref{lemma-ideal-nonzerodivisor}. If $\mathfrak m$
is not an associated prime of $R/xR$ then $\text{depth}(R) \geq 2$
by the same lemma. Thus we are left with the case when there is an
$y \in R$, $y \not \in xR$ such that $y \mathfrak m \subset xR$.

\medskip\noindent
If $y \mathfrak m \subset x \mathfrak m$ then we can consider the
map $\varphi : \mathfrak m \to \mathfrak m$, $f \mapsto yf/x$
(well defined as $x$ is a nonzerodivisor). By the determinantal trick
of Lemma \ref{lemma-charpoly-module} there exists a monic
polynomial $P$ with coefficients in $R$ such that $P(\varphi) = 0$.
We conclude that $P(y/x) = 0$ in $R_x$.
Let $R' \subset R_x$ be the ring generated by
$R$ and $y/x$. Then $R \subset R'$ and $R'/R$ is a finite $R$-module
annihilated by a power of $x$. Thus $R$ is as in (4).

\medskip\noindent
Otherwise there is a $t \in \mathfrak m$ such that $y t = u x$
for some unit $u$ of $R$. After replacing $t$ by $u^{-1}t$
we get $yt = x$. In particular $y$ is a nonzerodivisor.
For any $t' \in \mathfrak m$ we have $y t' = x s$ for some $s \in R$.
Thus $y (t' - s t ) = x s - x s = 0$.
Since $y$ is not a zero-divisor this implies that $t' = ts$ and so
$\mathfrak m = (t)$. Thus $(R, \mathfrak m)$ is regular of dimension 1.
\end{proof}

\begin{lemma}
\label{lemma-nonregular-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Assume $R$ is Noetherian, has dimension $1$, and that
$\dim(\mathfrak m/\mathfrak m^2) > 1$. Then there exists
a ring map $R \to R'$ such that
\begin{enumerate}
\item $R \to R'$ is finite,
\item $R \to R'$ is not an isomorphism,
\item the kernel and cokernel of $R \to R'$ are annihilated by
a power of $\mathfrak m$, and
\item $\mathfrak m$ is not an associated prime of $R'$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-hart-serre-loc-thm}
and the fact that $R$ is not Artinian, not regular, and
does not have depth $\geq 2$ (the last part because the
depth does not exceed the dimension by
Lemma \ref{lemma-bound-depth}).
\end{proof}

\begin{example}
\label{example-nonreduced}
Consider the Noetherian local ring
$$
R = k[[x, y]]/(y^2)
$$
It has dimension 1 and it is Cohen-Macaulay.
An example of an extension as in
Lemma \ref{lemma-nonregular-dimension-one}
is the extension
$$
k[[x, y]]/(y^2) \subset k[[x, z]]/(z^2), \ \ y \mapsto xz
$$
in other words it is gotten by adjoining $y/x$ to $R$. The
effect of repeating the construction $n > 1$ times is
to adjoin the element $y/x^n$.
\end{example}

\begin{example}
\label{example-bad-dvr-char-p}
Let $k$ be a field of characteristic $p > 0$ such that $k$
has infinite degree over its subfield $k^p$ of $p$th powers.
For example $k = \mathbf{F}_p(t_1, t_2, t_3, \ldots)$.
Consider the ring
$$
A =
\left\{
\sum a_i x^i \in k[[x]] \text{ such that }
[k^p(a_0, a_1, a_2, \ldots) : k^p] < \infty
\right\}
$$
Then $A$ is a discrete valuation ring and its completion is
$A^\wedge = k[[x]]$. Note that the field extension $f.f.(A) \subset
f.f.(k[[x]])$ is infinite purely inseparable.
Choose any $f \in k[[x]]$, $f \not \in A$. Let $R = A[f] \subset k[[x]]$.
Then $R$ is a Noetherian local domain of dimension $1$ whose
completion $R^\wedge$ is nonreduced (think!).
\end{example}

\begin{remark}
\label{remark-resolution-dim-1}
Suppose that $R$ is a $1$-dimensional semi-local Noetherian domain.
If there is a maximal ideal $\mathfrak m \subset R$ such that
$R_{\mathfrak m}$ is not regular, then we may apply
Lemma \ref{lemma-nonregular-dimension-one} to $(R, \mathfrak m)$
to get a finite ring extension $R \subset R_1$.
(For example one can do this so that $\Spec(R_1) \to \Spec(R)$
is the blow up of $\Spec(R)$ in the ideal $\mathfrak m$.)
Of course $R_1$ is a $1$-dimensional semi-local Noetherian
domain with the same fraction field as $R$. If $R_1$ is not a
regular semi-local ring, then we may repeat the construction to
get $R_1 \subset R_2$. Thus we get a sequence
$$
R \subset R_1 \subset R_2 \subset R_3 \subset \ldots
$$
of finite ring extensions which may stop if $R_n$ is regular for
some $n$. Resolution of singularities would be the claim
that eventually $R_n$ is indeed regular. In reality this is not
the case. Namely, there exists a characteristic $0$
Noetherian local domain $A$ of dimension $1$ whose completion is nonreduced,
see \cite[Proposition 3.1]{Ferrand-Raynaud} or our
Examples, Section \ref{examples-section-local-completion-nonreduced}.
For an example in characteristic $p > 0$ see
Example \ref{example-bad-dvr-char-p}.
Since the construction of blowing up commutes with completion it
is easy to see the sequence never stabilizes.
See \cite{Bennett} for a discussion (mostly in positive characteristic).
On the other hand, if the completion of $R$ in all of its maximal
ideals is reduced, then the procedure stops (insert future reference
here).
\end{remark}

\begin{lemma}
\label{lemma-characterize-dvr}
Let $A$ be a ring. The following are equivalent.
\begin{enumerate}
\item The ring $A$ is a discrete valuation ring.
\item The ring $A$ is a valuation ring and Noetherian.
\item The ring $A$ is a regular local ring of dimension $1$.
\item The ring $A$ is a Noetherian local domain with maximal ideal
$\mathfrak m$ generated by a single nonzero element.
\item The ring $A$ is a Noetherian local normal domain of dimension $1$.
\end{enumerate}
In this case if $\pi$ is a generator of the maximal ideal of
$A$, then every element of $A$ can be uniquely written as
$u\pi^n$, where $u \in A$ is a unit.
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is
Lemma \ref{lemma-valuation-ring-Noetherian-discrete}.
Moreover, in the proof of Lemma \ref{lemma-valuation-ring-Noetherian-discrete}
we saw that if $A$ is a discrete valuation ring, then $A$ is a PID, hence (3).
Note that a regular local ring is a domain (see
Lemma \ref{lemma-regular-domain}). Using this the equivalence of (3) and (4)
follows from dimension theory, see Section \ref{section-dimension}.

\medskip\noindent
Assume (3) and let $\pi$ be a generator of the maximal ideal $\mathfrak m$.
For all $n \geq 0$ we have
$\dim_{A/\mathfrak m} \mathfrak m^n/\mathfrak m^{n + 1} = 1$
because it is generated by $\pi^n$ (and it cannot be zero).
In particular $\mathfrak m^n = (\pi^n)$ and
the graded ring $\bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$
is isomorphic to the polynomial ring $A/\mathfrak m[T]$.
For $x \in A \setminus \{0\}$ define
$v(x) = \max\{n \mid x \in \mathfrak m^n\}$.
In other words $x = u \pi^{v(x)}$ with $u \in A^*$.
By the remarks above we have $v(xy) = v(x) + v(y)$
for all $x, y \in A \setminus \{0\}$. We extend this to the field of fractions
$K$ of $A$ by setting $v(a/b) = v(a) - v(b)$ (well defined by multiplicativity
shown above). Then it is clear that $A$ is the set of elements of
$K$ which have valuation $\geq 0$. Hence we see that $A$ is a
valuation ring by Lemma \ref{lemma-valuation-valuation-ring}.

\medskip\noindent
A valuation ring is a normal domain by Lemma \ref{lemma-valuation-ring-normal}.
Hence we see that the equivalent conditions (1) -- (3) imply
(5). Assume (5). Suppose that $\mathfrak m$ cannot be generated
by $1$ element to get a contradiction.
Then Lemma \ref{lemma-nonregular-dimension-one} implies there is a finite
ring map $A \to A'$ which is an isomorphism after inverting
any nonzero element of $\mathfrak m$ but not an isomorphism.
In particular $A' \subset f.f.(A)$.
Since $A \to A'$ is finite it is integral (see
Lemma \ref{lemma-finite-is-integral}).
Since $A$ is normal we get $A = A'$ a contradiction.
\end{proof}

\begin{definition}
\label{definition-uniformizer}
Let $A$ be a discrete valuation ring. A {\it uniformizer} is an element
$\pi \in A$ which generates the maximal ideal of $A$.
\end{definition}

\noindent
By Lemma \ref{lemma-characterize-dvr} any two uniformizers of a discrete
valuation ring are associates.

\begin{lemma}
\label{lemma-finite-length}
Let $R$ be a domain with fraction field $K$.
Let $M$ be an $R$-submodule of $K^{\oplus r}$.
Assume $R$ is local Noetherian of dimension $1$.
For any nonzero $x \in R$ we have $\text{length}_R(R/xR) < \infty$
and
$$
\text{length}_R(M/xM) \leq r \cdot \text{length}_R(R/xR).
$$
\end{lemma}

\begin{proof}
If $x$ is a unit then the result is true. Hence we may assume
$x \in \mathfrak m$ the maximal ideal of $R$. Since $x$ is not
zero and $R$ is a domain we have $\dim(R/xR) = 0$, and hence
$R/xR$ has finite length. Consider $M \subset K^{\oplus r}$ as
in the lemma. We may assume that the elements of $M$ generate
$K^{\oplus r}$ as a $K$-vector space after replacing $K^{\oplus r}$
by a smaller subspace if necessary.

\medskip\noindent
Suppose first that $M$ is a finite $R$-module. In that case we can clear
denominators and assume $M \subset R^{\oplus r}$. Since
$M$ generates $K^{\oplus r}$ as a vectors space we see that
$R^{\oplus r}/M$ has finite length. In particular there exists
an integer $c \geq 0$ such that $x^cR^{\oplus r} \subset M$.
Note that $M \supset xM \supset x^2M \supset \ldots$ is a sequence of
modules with successive quotients each isomorphic to $M/xM$. Hence
we see that
$$
n \text{length}_R(M/xM) = \text{length}_R(M/x^nM).
$$
The same argument for $M = R^{\oplus r}$ shows that
$$
n \text{length}_R(R^{\oplus r}/xR^{\oplus r}) =
\text{length}_R(R^{\oplus r}/x^nR^{\oplus r}).
$$
By our choice of $c$ above we see that $x^nM$ is sandwiched between
$x^n R^{\oplus r}$ and $x^{n + c}R^{\oplus r}$. This easily gives that
$$
r(n + c) \text{length}_R(R/xR)
\geq
n \text{length}_R(M/xM)
\geq
r (n - c) \text{length}_R(R/xR)
$$
Hence in the finite case we actually get the result of the lemma with
equality.

\medskip\noindent
Suppose now that $M$ is not finite. Suppose that the length of $M/xM$ is
$\geq k$ for some natural number $k$. Then we can find
$$
0 \subset N_0 \subset N_1 \subset N_2 \subset \ldots N_k \subset M/xM
$$
with $N_i \not = N_{i + 1}$ for $i = 0, \ldots k - 1$.
Choose an element $m_i \in M$ whose congruence class mod $xM$ falls
into $N_i$ but not into $N_{i - 1}$ for $i = 1, \ldots, k$.
Consider the finite $R$-module $M' = Rm_1 + \ldots + Rm_k \subset M$.
Let $N'_i \subset M'/xM'$ be the inverse image of $N_i$.
It is clear that $N'_i \not =N'_{i + 1}$ by our choice of $m_i$.
Hence we see that $\text{length}_R(M'/xM') \geq k$. By the
finite case we conclude $k \leq r\text{length}_R(R/xR)$
as desired.
\end{proof}

\noindent
Here is a first application.

\begin{lemma}
\label{lemma-finite-extension-residue-fields-dimension-1}
Let $R \to S$ be a homomorphism of domains inducing an
injection of fraction fields $K \subset L$. If $R$ is Noetherian
local of dimension $1$ and $[L : K] < \infty$ then
\begin{enumerate}
\item each prime ideal $\mathfrak n_i$ of $S$ lying over
the maximal ideal $\mathfrak m$ of $R$ is maximal,
\item there are finitely many of these, and
\item $[\kappa(\mathfrak n_i) : \kappa(\mathfrak m)] < \infty$ for each $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Pick $x \in \mathfrak m$ nonzero. Apply Lemma \ref{lemma-finite-length}
to the submodule $S \subset L \cong K^{\oplus n}$ where $n = [L : K]$.
Thus the ring $S/xS$ has finite length over $R$. It follows that
$S/\mathfrak m S$ has finite length over $\kappa(\mathfrak m)$.
In other words, $\dim_{\kappa(\mathfrak m)} S/\mathfrak m S$
is finite (Lemma \ref{lemma-dimension-is-length}). Thus $S/\mathfrak mS$
is Artinian (Lemma \ref{lemma-finite-dimensional-algebra}). The
structural results on Artinian rings implies parts (1) and (2), see
for example Lemma \ref{lemma-artinian-finite-length}.
Part (3) is implied by the finiteness established above.
\end{proof}

\begin{lemma}
\label{lemma-finite-length-global}
Let $R$ be a domain with fraction field $K$.
Let $M$ be an $R$-submodule of $K^{\oplus r}$.
Assume $R$ is Noetherian of dimension $1$.
For any nonzero $x \in R$ we have
$\text{length}_R(M/xM) < \infty$.
\end{lemma}

\begin{proof}
Since $R$ has dimension $1$ we see that
$x$ is contained in finitely many primes
$\mathfrak m_i$, $i = 1, \ldots, n$, each maximal.
Since $R$ is Noetherian we see that $R/xR$ is Artinian,
see Proposition \ref{proposition-dimension-zero-ring}.
Hence $R/xR$ is a quotient of
$\prod R/\mathfrak m_i^{e_i}$ for certain $e_i$ because
that $\mathfrak m_1^{e_1} \ldots \mathfrak m_n^{e_n} \subset (x)$
for suitably large $e_i$ as $R/xR$ is Artinian
(see Section \ref{section-artinian}).
Hence $M/xM$ similarly decomposes as a product
$\prod (M/xM)_{\mathfrak m_i} = \prod M/(\mathfrak m_i^{e_i}, x)M$
of its localizations at the $\mathfrak m_i$. By
Lemma \ref{lemma-finite-length} applied to $M_{\mathfrak m_i}$
over $R_{\mathfrak m_i}$ we see each
$M_{\mathfrak m_i}/xM_{\mathfrak m_i} = (M/xM)_{\mathfrak m_i}$
has finite length over $R_{\mathfrak m_i}$. It easily follows that $M/xM$
has finite length over $R$.
\end{proof}

\begin{lemma}[Krull-Akizuki]
\label{lemma-krull-akizuki}
Let $R$ be a domain with fraction field $K$.
Let $K \subset L$ be a finite extension of fields.
Assume $R$ is Noetherian and $\dim(R) = 1$.
In this case any ring $A$ with $R \subset A \subset L$ is
Noetherian.
\end{lemma}

\begin{proof}
To begin we may assume that $L$ is the fraction field of $A$
by replacing $L$ by the fraction field of $A$ if necessary.
Let $I \subset A$ be an ideal. Clearly $I$ generates $L$ as
a $K$-vector space. Hence we see that $I \cap R \not = (0)$.
Pick any nonzero $x \in I \cap R$. Then we get
$I/xA \subset A/xA$. By Lemma \ref{lemma-finite-length-global}
the $R$-module $A/xA$ has finite length as an $R$-module. Hence
$I/xA$ has finite length as an $R$-module. Hence $I$ is finitely
generated as an ideal in $A$.
\end{proof}

\begin{lemma}
\label{lemma-exists-dvr}
Let $R$ be a Noetherian local domain with fraction field $K$.
Assume that $R$ is not a field.
Let $K \subset L$ be a finitely generated field extension.
Then there exists discrete valuation ring $A$ with fraction field
$L$ which dominates $R$.
\end{lemma}

\begin{proof}
If $L$ is not finite over $K$ choose a transcendence basis
$x_1, \ldots, x_r$ of $L$ over $K$ and replace $R$ by
$R[x_1, \ldots, x_r]$ localized at the maximal ideal
generated by $\mathfrak m_R$ and $x_1, \ldots, x_r$.
Thus we may assume $K \subset L$ finite.

\medskip\noindent
By Lemma \ref{lemma-dominate-by-dimension-1} we may assume $\dim(R) = 1$.

\medskip\noindent
Let $A \subset L$ be the integral closure of $R$ in $L$.
By Lemma \ref{lemma-krull-akizuki} this is Noetherian.
By Lemma \ref{lemma-integral-overring-surjective} there
is a prime ideal $\mathfrak q \subset A$ lying
over the maximal ideal of $R$.
By Lemma \ref{lemma-characterize-dvr} the ring $A_{\mathfrak q}$ is a discrete
valuation ring dominating $R$ as desired.
\end{proof}








\section{Factorization}
\label{section-factoring}

\noindent
Here are some notions and relations between them that are typically taught
in a first year course on algebra at the undergraduate level.

\begin{definition}
\label{definition-irreducible-prime-element}
Let $R$ be a domain.
\begin{enumerate}
\item Elements $x, y \in R$ are called {\it associates} if
there exists a unit $u \in R^*$ such that $x = uy$.
\item An element $x \in R$ is called {\it irreducible}
if it is nonzero, not a unit and whenever $x = yz$, $y, z \in R$,
then $y$ is either a unit or an associate of $x$.
\item An element $x \in R$ is called {\it prime} if the ideal
generated by $x$ is a prime ideal.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-easy-divisibility}
Let $R$ be a domain. Let $x, y \in R$.
Then $x$, $y$ are associates if and only if $(x) = (y)$.
\end{lemma}

\begin{proof}
If $x = uy$ for some unit $u \in R$, then $(x) \subset (y)$ and
$y = u^{-1}x$ so also $(y) \subset (x)$. Conversely, suppose that
$(x) = (y)$. Then $x = fy$ and $y = gx$ for some $f, g \in A$.
Then $x = fg x$ and since $R$ is a domain $fg = 1$. Thus
$x$ and $y$ are associates.
\end{proof}

\begin{lemma}
\label{lemma-factorization-exists}
Let $R$ be a domain. Consider the following conditions:
\begin{enumerate}
\item The ring $R$ satisfies the ascending chain condition for
principal ideals.
\item Every nonzero, nonunit element $a \in R$
has a factorization $a = b_1 \ldots b_k$
with each $b_i$ an irreducible element of $R$.
\end{enumerate}
Then (1) implies (2).
\end{lemma}

\begin{proof}
Let $x$ be a nonzero element, not a unit, which does not have a
factorization into
irreducibles. Set $x_1 = x$. We can write $x = yz$ where neither
$y$ nor $z$ is irreducible or a unit.
Then either $y$ does not have a factorization
into irreducibles, in which case we set $x_2 = y$, or $z$ does not
have a factorization into irreducibles, in which case we set $x_2 = z$.
Continuing in this fashion we find a sequence
$$
x_1 | x_2 | x_3 | \ldots
$$
of elements of $R$ with $x_n/x_{n + 1}$ not a unit.
This gives a strictly increasing sequence of principal ideals
$(x_1) \subset (x_2) \subset (x_3) \subset \ldots$ thereby finishing the proof.
\end{proof}

\begin{definition}
\label{definition-UFD}
A {\it unique factorization domain}, abbreviated {\it UFD},
is a domain $R$ such that
if $x \in R$ is a nonzero, nonunit, then $x$ has a factorization
into irreducibles, and if
$$
x = a_1 \ldots a_m = b_1 \ldots b_n
$$
are factorizations into irreducibles then $n = m$ and
there exists a permutation $\sigma : \{1, \ldots, n\} \to \{1, \ldots, n\}$
such that $a_i$ and $b_{\sigma(i)}$ are associates.
\end{definition}

\begin{lemma}
\label{lemma-characterize-UFD}
Let $R$ be a domain. Assume every nonzero, nonunit factors into
irreducibles. Then $R$ is a UFD if and only if every irreducible
element is prime.
\end{lemma}

\begin{proof}
Assume $R$ is a UFD and let $x \in R$ be an irreducible element.
Say $ab \in (x)$, i.e., $ab = cx$. Choose factorizations
$a = a_1 \ldots a_n$, $b = b_1 \ldots b_m$, and $c = c_1 \ldots c_r$.
By uniqueness of the factorization
$$
a_1 \ldots a_n b_1 \ldots b_m = c_1 \ldots c_r x
$$
we find that $x$ is an associate of one of the elements
$a_1, \ldots, b_m$. In other words, either $a \in (x)$ or $b \in (x)$
and we conclude that $x$ is prime.

\medskip\noindent
Assume every irreducible element is prime. We have to prove that
factorization into irreducibles is unique up to permutation and
taking associates. Say $a_1 \ldots a_m = b_1 \ldots b_n$ with $a_i$
and $b_j$ irreducible. Since $a_1$ is prime, we see that
$b_j \in (a_1)$ for some $j$. After renumbering we may assume
$b_1 \in (a_1)$. Then $b_1 = a_1 u$ and since $b_1$ is irreducible
we see that $u$ is a unit. Hence $a_1$ and $b_1$ are associates
and $a_2 \ldots a_n = ub_2\ldots b_m$. By induction on $n + m$
we see that $n = m$ and $a_i$ associate to $b_{\sigma(i)}$ for
$i = 2, \ldots, n$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-UFD-height-1}
Let $R$ be a Noetherian domain. Then $R$ is a UFD if and only if every
height $1$ prime ideal is principal.
\end{lemma}

\begin{proof}
Assume $R$ is a UFD and let $\mathfrak p$ be a height 1 prime ideal.
Take $x \in \mathfrak p$ nonzero and let $x = a_1 \ldots a_n$
be a factorization into irreducibles.
Since $\mathfrak p$ is prime we see that $a_i \in \mathfrak p$
for some $i$. By Lemma \ref{lemma-characterize-UFD} the ideal
$(a_i)$ is prime. Since $\mathfrak p$ has height $1$ we conclude
that $(a_i) = \mathfrak p$.

\medskip\noindent
Assume every height $1$ prime is principal. Since $R$ is Noetherian
every nonzero nonunit element $x$ has a factorization into irreducibles,
see Lemma \ref{lemma-factorization-exists}. It suffices to prove that
an irreducible element $x$ is prime, see Lemma \ref{lemma-characterize-UFD}.
Let $(x) \subset \mathfrak p$ be a prime minimal over $(x)$. Then
$\mathfrak p$ has height $1$ by Lemma \ref{lemma-minimal-over-1}.
By assumption $\mathfrak p = (y)$. Hence $x = yz$ and $z$ is a unit
as $x$ is irreducible. Thus $(x) = (y)$ and we see that $x$ is prime.
\end{proof}

\begin{lemma}[Nagata's criterion for factoriality]
\label{lemma-invert-prime-elements}
\begin{reference}
\cite[Lemma 2]{Nagata-UFD}
\end{reference}
Let $A$ be a domain. Let $S \subset A$ be a multiplicative subset
generated by prime elements. Let $x \in A$ be irreducible. Then
\begin{enumerate}
\item the image of $x$ in $S^{-1}A$ is irreducible or a unit, and
\item $x$ is prime if and only if the image of $x$ in $S^{-1}A$ is
a unit or a prime element in $S^{-1}A$.
\end{enumerate}
Moreover, then $A$ is a UFD if and only if every element of $A$ has a
factorization into irreducibles and $S^{-1}A$ is a UFD.
\end{lemma}

\begin{proof}
Say $x = \alpha \beta$ for $\alpha, \beta \in S^{-1}A$. Then
$\alpha = a/s$ and $\beta = b/s'$ for $a, b \in A$, $s, s' \in S$.
Thus we get $ss'x = ab$. By assumption we can write
$ss' = p_1 \ldots p_r$ for some prime elements $p_i$.
For each $i$ the element $p_i$ divides either $a$ or $b$.
Dividing we find a factorization $x = a' b'$ and
$a = s'' a'$, $b = s''' b'$ for some $s'', s''' \in S$.
As $x$ is irreducible, either $a'$ or $b'$ is a unit.
Tracing back we find that either $\alpha$ or $\beta$ is a unit.
This proves (1).

\medskip\noindent
Suppose $x$ is prime. Then $A/(x)$ is a domain. Hence
$S^{-1}A/xS^{-1}A = S^{-1}(A/(x))$ is a domain or zero.
Thus $x$ maps to a prime element or a unit.

\medskip\noindent
Suppose that the image of $x$ in $S^{-1}A$ is a unit.
Then $y x = s$ for some $s \in S$ and $y \in A$. By assumption
$s = p_1 \ldots p_r$ with $p_i$ a prime element. For each $i$ either
$p_i$ divides $y$ or $p_i$ divides $x$. In the second case
$p_i$ and $x$ are associates (as $x$ is irreducible) and we are done.
But if the first case happens for all $i = 1, \ldots, r$, then
$x$ is a unit which is a contradiction.

\medskip\noindent
Suppose that the image of $x$ in $S^{-1}A$ is a prime element.
Assume $a, b \in A$ and $ab \in (x)$. Then $sa = xy$ or
$sb = xy$ for some $s \in S$ and $y \in A$. Say the first
case happens. By assumption
$s = p_1 \ldots p_r$ with $p_i$ a prime element. For each $i$ either
$p_i$ divides $y$ or $p_i$ divides $x$. In the second case
$p_i$ and $x$ are associates (as $x$ is irreducible) and we are done.
If the first case happens for all $i = 1, \ldots, r$, then
$a \in (x)$ as desired. This completes the proof of (2).

\medskip\noindent
The final statement of the lemma follows from (1) and (2)
and Lemma \ref{lemma-characterize-UFD}.
\end{proof}

\begin{lemma}
\label{lemma-UFD-ascending-chain-condition-principal-ideals}
A UFD satisfies the ascending chain condition for principal
ideals.
\end{lemma}

\begin{proof}
Consider an ascending chain $(a_1) \subset (a_2) \subset (a_3) \subset \ldots$
of principal ideals in $R$. Write $a_1 = p_1^{e_1} \ldots p_r^{e_r}$
with $p_i$ prime. Then we see that $a_n$ is an associate of
$p_1^{c_1} \ldots p_r^{c_r}$ for some $0 \leq c_i \leq e_i$.
Since there are only finitely many possibilities we conclude.
\end{proof}

\begin{lemma}
\label{lemma-factoring-in-polynomial}
Let $R$ be a domain. Assume $R$ has the ascending chain condition
for principal ideals. Then the same property holds for a polynomial
ring over $R$.
\end{lemma}

\begin{proof}
Consider an ascending chain $(f_1) \subset (f_2) \subset (f_3) \subset \ldots$
of principal ideals in $R[x]$. Since $f_{n + 1}$ divides $f_n$ we see
that the degrees decrease in the sequence. Thus $f_n$
has fixed degree $d \geq 0$ for all $n \gg 0$. Let $a_n$ be the
leading coefficient of $f_n$. The condition $f_n \in (f_{n + 1})$
implies that $a_{n + 1}$ divides $a_n$ for all $n$.
By our assumption on $R$ we see that $a_{n + 1}$ and $a_n$
are associates for all $n$ large enough (Lemma \ref{lemma-easy-divisibility}).
Thus for large $n$ we see that $f_n = u f_{n + 1}$ where
$u \in R$ (for reasons of degree) is a unit (as $a_n$ and $a_{n + 1}$
are associates).
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-UFD}
A polynomial ring over a UFD is a UFD. In particular, if $k$ is a field,
then $k[x_1, \ldots, x_n]$ is a UFD.
\end{lemma}

\begin{proof}
Let $R$ be a UFD. Then $R$ satisfies the ascending chain condition for
principal ideals
(Lemma \ref{lemma-UFD-ascending-chain-condition-principal-ideals}),
hence $R[x]$ satisfies the ascending chain condition for principal
ideals (Lemma \ref{lemma-factoring-in-polynomial}), and hence every
element of $R[x]$ has a factorization into irreducibles
(Lemma \ref{lemma-factorization-exists}).
Let $S \subset R$ be the multiplicative subset
generated by prime elements. Since every nonunit of $R$ is a product
of prime elements we see that $K = S^{-1}R$ is the fraction field
of $R$. Observe that every prime element of $R$ maps to a prime element
of $R[x]$ and that $S^{-1}(R[x]) = S^{-1}R[x] = K[x]$ is a
UFD (and even a PID). Thus we may apply
Lemma \ref{lemma-invert-prime-elements} to conclude.
\end{proof}

\begin{lemma}
\label{lemma-UFD-normal}
A unique factorization domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a UFD. Let $x$ be an element of the fraction field of
$R$ which is integral over $R$. Say $x^d - a_1 x^{d - 1} - \ldots - a_d = 0$
with $a_i \in R$. We can write
$x = u p_1^{e_1} \ldots p_r^{e_r}$ with $u$ a unit, $e_i \in \mathbf{Z}$,
and $p_1, \ldots, p_r$ irreducible elements which are not associates.
To prove the lemma we have to show $e_i \geq 0$. If not, say $e_1 < 0$,
then for $N \gg 0$ we get
$$
u^d p_2^{de_2 + N} \ldots p_r^{de_r + N} =
p_1^{-de_1}p_2^N \ldots p_r^N(
\sum\nolimits_{i = 1, \ldots, d} a_i x^{d - i} ) \in (p_1)
$$
which contradicts uniqueness of factorization in $R$.
\end{proof}

\begin{definition}
\label{definition-PID}
A {\it principal ideal domain}, abbreviated {\it PID},
is a domain $R$ such that every ideal is a principal ideal.
\end{definition}

\begin{lemma}
\label{lemma-PID-UFD}
A principal ideal domain is a unique factorization domain.
\end{lemma}

\begin{proof}
As a PID is Noetherian this follows from
Lemma \ref{lemma-characterize-UFD-height-1}.
\end{proof}

\begin{definition}
\label{definition-dedekind-domain}
A {\it Dedekind domain} is a domain $R$ such that every
nonzero ideal $I \subset R$ can be written as a product
$$
I = \mathfrak p_1 \ldots \mathfrak p_r
$$
of nonzero prime ideals uniquely up to permutation of the $\mathfrak p_i$.
\end{definition}

\begin{lemma}
\label{lemma-PID-dedekind}
A PID is a Dedekind domain.
\end{lemma}

\begin{proof}
Let $R$ be a PID. Since every nonzero ideal of $R$ is principal,
and $R$ is a UFD (Lemma \ref{lemma-PID-UFD}), this follows from
the fact that every irreducible element in $R$ is prime
(Lemma \ref{lemma-characterize-UFD})
so that factorizations of elements turn into factorizations into primes.
\end{proof}

\begin{lemma}
\label{lemma-product-ideals-principal}
Let $A$ be a ring. Let $I$ and $J$ be nonzero ideals of $A$
such that $IJ = (f)$ for some nonzerodivisor $f \in A$. Then $I$ and $J$ are
finitely generated ideals and finitely locally free of rank $1$ as $A$-modules.
\end{lemma}

\begin{proof}
It suffices to show that $I$ and $J$ are finite locally free $A$-modules
of rank $1$, see Lemma \ref{lemma-finite-projective}.
To do this, write $f = \sum_{i = 1, \ldots, n} x_i y_i$ with $x_i \in I$
and $y_i \in J$. We can
also write $x_i y_i = a_i f$ for some $a_i \in A$.
Since $f$ is a nonzerodivisor we see that $\sum a_i = 1$.
Thus it suffices to show that each $I_{a_i}$ and
$J_{a_i}$ is free of rank $1$ over $A_{a_i}$. After replacing $A$ by
$A_{a_i}$ we conclude that $f = xy$ for some $x \in I$ and $y \in J$.
Note that both $x$ and $y$ are nonzerodivisors. We claim that
$I = (x)$ and $J = (y)$ which finishes the proof. Namely, if $x' \in I$,
then $x'y = af = axy$ for some $a \in A$. Hence $x' = ax$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-characterize-Dedekind}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ is a Dedekind domain,
\item $R$ is a Noetherian domain, and for every maximal ideal $\mathfrak m$
the local ring $R_{\mathfrak m}$ is a discrete valuation ring, and
\item $R$ is a Noetherian, normal domain, and $\dim(R) \leq 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). The argument is nontrivial because we did not assume that $R$
was Noetherian in our definition of a Dedekind domain. Let
$\mathfrak p \subset R$ be a prime ideal. Observe that
$\mathfrak p \not = \mathfrak p^2$ by uniqueness
of the factorizations in the definition. Pick $x \in \mathfrak p$
with $x \not \in \mathfrak p^2$. Let $y \in \mathfrak p$ be a
second element (for example $y = 0$).
Write $(x, y) = \mathfrak p_1 \ldots \mathfrak p_r$.
Since $(x, y) \subset \mathfrak p$ at least one of the primes
$\mathfrak p_i$ is contained in $\mathfrak p$.
But as $x \not \in \mathfrak p^2$ there is at most one.
Thus exactly one of $\mathfrak p_1, \ldots, \mathfrak p_r$ is contained
in $\mathfrak p$, say $\mathfrak p_1 \subset \mathfrak p$.
We conclude that $(x, y)R_\mathfrak p = \mathfrak p_1R_\mathfrak p$
is prime for every choice of $y$. We claim that
$(x)R_\mathfrak p = \mathfrak pR_\mathfrak p$. Namely,
pick $y \in \mathfrak p$. By the above applied with $y^2$ we see
that $(x, y^2)R_\mathfrak p$ is prime.
Hence $y \in (x, y^2)R_\mathfrak p$, i.e., $y = ax + by^2$ in
$R_\mathfrak p$. Thus $(1 - by)y = ax \in (x)R_\mathfrak p$, i.e.,
$y \in (x)R_\mathfrak p$ as desired.

\medskip\noindent
Writing $(x) = \mathfrak p_1 \ldots \mathfrak p_r$ anew with
$\mathfrak p_1 \subset \mathfrak p$ we conclude that
$\mathfrak p_1 R_\mathfrak p = \mathfrak p R_\mathfrak p$, i.e.,
$\mathfrak p_1 = \mathfrak p$. Moreover, $\mathfrak p_1 = \mathfrak p$ is
a finitely generated ideal of $R$ by
Lemma \ref{lemma-product-ideals-principal}.
We conclude that $R$ is Noetherian by Lemma \ref{lemma-cohen}.
Moreover, it follows that $R_\mathfrak m$ is a discrete
valuation ring for every prime ideal $\mathfrak p$, see
Lemma \ref{lemma-characterize-dvr}.

\medskip\noindent
The equivalence of (2) and (3) follows from
Lemmas \ref{lemma-normality-is-local} and
\ref{lemma-characterize-dvr}. Assume (2) and (3) are satisfied.
Let $I \subset R$ be an ideal. We will construct a factorization
of $I$. If $I$ is prime, then there is nothing to prove.
If not, pick $I \subset \mathfrak p$ with $\mathfrak p \subset R$
maximal. Let $J = \{x \in R \mid x \mathfrak p \subset I\}$.
We claim $J \mathfrak p = I$. It suffices to check this after localization
at the maximal ideals $\mathfrak m$ of $A$ (the formation of $J$ commutes with
localization and we use Lemma \ref{lemma-characterize-zero-local}).
Then either $\mathfrak p R_\mathfrak m = R_\mathfrak m$ and the result
is clear, or $\mathfrak p R_\mathfrak m = \mathfrak m R_\mathfrak m$.
In the last case $\mathfrak p R_\mathfrak m = (\pi)$ and the case where
$\mathfrak p$ is principal is immediate. By Noetherian induction the
ideal $J$ has a factorization and we obtain the desired factorization
of $I$. We omit the proof of uniqueness of the factorization.
\end{proof}

\noindent
The following is a variant of the Krull-Akizuki lemma.

\begin{lemma}
\label{lemma-integral-closure-Dedekind}
Let $A$ be a Noetherian domain of dimension $1$ with fraction field $K$.
Let $K \subset L$ be a finite extension. Let $B$ be the
integral closure of $A$ in $L$. Then $B$ is a Dedekind domain and
$\Spec(B) \to \Spec(A)$ is surjective, has finite fibres, and
induces finite residue field extensions.
\end{lemma}

\begin{proof}
By Krull-Akizuki (Lemma \ref{lemma-krull-akizuki})
the ring $B$ is Noetherian. By Lemma \ref{lemma-integral-sub-dim-equal}
$\dim(B) = 1$. Thus $B$ is a Dedekind domain by
Lemma \ref{lemma-characterize-Dedekind}.
Surjectivity of the map on spectra follows from
Lemma \ref{lemma-integral-overring-surjective}.
The last two statements follow from
Lemma \ref{lemma-finite-extension-residue-fields-dimension-1}.
\end{proof}







\section{Orders of vanishing}
\label{section-orders-of-vanishing}

\begin{lemma}
\label{lemma-ord-additive}
Let $R$ be a semi-local Noetherian ring of dimension $1$.
If $a, b \in R$ are nonzerodivisors then
$$
\text{length}_R(R/(ab)) =
\text{length}_R(R/(a)) +
\text{length}_R(R/(b))
$$
and these lengths are finite.
\end{lemma}

\begin{proof}
We saw the finiteness in Lemma \ref{lemma-finite-length-global}.
Additivity holds since there is a short exact sequence
$0 \to R/(a) \to R/(ab) \to R/(b) \to 0$ where the first map
is given by multiplication by $b$. (Use length is additive,
see Lemma \ref{lemma-length-additive}.)
\end{proof}

\begin{definition}
\label{definition-ord}
Suppose that $K$ is a field, and $R \subset K$ is a
local\footnote{We could also define this when $R$ is only
semi-local but this is probably never really what you want!}
Noetherian subring of dimension $1$ with fraction field $K$.
In this case we define the {\it order of vanishing along $R$}
$$
\text{ord}_R : K^* \longrightarrow \mathbf{Z}
$$
by the rule
$$
\text{ord}_R(x) = \text{length}_R(R/(x))
$$
if $x \in R$ and we set
$\text{ord}_R(x/y) = \text{ord}_R(x) - \text{ord}_R(y)$
for $x, y \in R$ both nonzero.
\end{definition}

\noindent
We can use the order of vanishing to compare lattices in a
vector space. Here is the definition.

\begin{definition}
\label{definition-lattice}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
A {\it lattice in $V$} is a finite $R$-submodule $M \subset V$ such
that $V = K \otimes_R M$.
\end{definition}

\noindent
The condition $V = K \otimes_R M$ signifies that $M$ contains a
basis for the vector space $K$. We remark that in many places in the
literature the notion of a lattice may be defined only in case the
ring $R$ is a discrete valuation ring. If $R$ is a discrete valuation
ring then any lattice is a free $R$-module, and this may not be the case
in general.

\begin{lemma}
\label{lemma-compare-lattices}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
\begin{enumerate}
\item If $M$ is a lattice in $V$ and $M \subset M' \subset V$
is an $R$-submodule of $V$ containing $M$
then the following are equivalent
\begin{enumerate}
\item $M'$ is a lattice,
\item $\text{length}_R(M'/M)$ is finite, and
\item $M'$ is finitely generated.
\end{enumerate}
\item If $M$ is a lattice in $V$ and $M' \subset M$ is an $R$-submodule
of $M$ then $M'$ is a lattice if and only if
$\text{length}_R(M/M')$ is finite.
\item If $M$, $M'$ are lattices in $V$, then so are
$M \cap M'$ and $M + M'$.
\item If $M \subset M' \subset M'' \subset V$ are lattices in $V$
then
$$
\text{length}_R(M''/M) =
\text{length}_R(M'/M) +
\text{length}_R(M''/M').
$$
\item If $M$, $M'$, $N$, $N'$ are lattices in $V$ and
$N \subset M \cap M'$, $M + M' \subset N'$, then we have
\begin{eqnarray*}
& & \text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M')\\
& = &
\text{length}_R(M/N) - \text{length}_R(M'/N) \\
& = &
\text{length}_R(M + M' / M') - \text{length}_R(M + M'/M) \\
& = &
\text{length}_R(N' / M') - \text{length}_R(N'/M)
\end{eqnarray*}
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Assume (1)(a). Say $y_1, \ldots, y_m$ generate $M'$.
Then each $y_i = x_i/f_i$ for some $x_i \in M$ and
nonzero $f_i \in R$.
Hence we see that $f_1 \ldots f_m M' \subset M$.
Since $R$ is Noetherian local of dimension $1$
we see that $\mathfrak m^n \subset (f_1 \ldots f_m)$
for some $n$ (for example combine
Lemmas \ref{lemma-one-equation} and
Proposition \ref{proposition-dimension-zero-ring} or combine
Lemmas \ref{lemma-finite-length} and \ref{lemma-length-infinite}).
In other words $\mathfrak m^nM' \subset M$ for some $n$
Hence
$\text{length}(M'/M) < \infty$ by Lemma \ref{lemma-length-finite},
in other words (1)(b) holds.
Assume (1)(b). Then $M'/M$ is a finite $R$-module
(see Lemma \ref{lemma-finite-length-finite}).
Hence $M'$ is a finite $R$-module as an extension of finite $R$-modules.
Hence (1)(c). The implication
(1)(c) $\Rightarrow$ (1)(a) follows from the remark following
Definition \ref{definition-lattice}.

\medskip\noindent
Proof of (2). Suppose
$M$ is a lattice in $V$ and $M' \subset M$ is an $R$-submodule.
We have seen in (1) that if $M'$ is a lattice, then
$\text{length}_R(M/M') < \infty$. Conversely, assume that
$\text{length}_R(M/M') < \infty$. Then $M'$ is finitely generated
as $R$ is Noetherian and for some $n$ we have
$\mathfrak m^n M \subset M'$ (Lemma \ref{lemma-length-infinite}).
Hence it follows
that $M'$ contains a basis for $V$, and $M'$ is a lattice.

\medskip\noindent
Proof of (3). Assume $M$, $M'$ are lattices in $V$.
Since $R$ is Noetherian the submodule $M \cap M'$ of $M$ is finite.
As $M$ is a lattice we can find
$x_1, \ldots, x_n \in M$ which form a $K$-basis for
$V$. Because $M'$ is a lattice we can write $x_i = y_i/f_i$ with
$y_i \in M'$ and $f_i \in R$. Hence $f_ix_i \in M \cap M'$. Hence
$M \cap M'$ is a lattice also.
The fact that $M + M'$ is a lattice follows from part (1).

\medskip\noindent
Part (4) follows from additivity of lengths
(Lemma \ref{lemma-length-additive})
and the exact sequence
$$
0 \to M'/M \to M''/M \to M''/M' \to 0
$$
Part (5) follows from repeatedly applying part (4).
\end{proof}

\begin{definition}
\label{definition-distance}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
Let $M$, $M'$ be two lattices in $V$. The {\it distance between
$M$ and $M'$} is the integer
$$
d(M, M') = \text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M')
$$
of Lemma \ref{lemma-compare-lattices} part (5).
\end{definition}

\noindent
In particular, if $M' \subset M$, then
$d(M, M') = \text{length}_R(M/M')$.

\begin{lemma}
\label{lemma-properties-distance-function}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
This distance function has the property that
$$
d(M, M'') = d(M, M') + d(M', M'')
$$
whenever given three lattices $M$, $M'$, $M''$ of $V$.
In particular we have $d(M, M') = - d(M', M)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-order-vanishing-determinant}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
Let $\varphi : V \to V$ be a $K$-linear isomorphism.
For any lattice $M \subset V$ we have
$$
d(M, \varphi(M)) = \text{ord}_R(\det(\varphi))
$$
\end{lemma}

\begin{proof}
We can see that the integer $d(M, \varphi(M))$ does not depend
on the lattice $M$ as follows. Suppose that $M'$ is a second such
lattice. Then we see that
\begin{eqnarray*}
d(M, \varphi(M)) & = & d(M, M') + d(M', \varphi(M)) \\
& = & d(M, M') + d(\varphi(M'), \varphi(M)) + d(M', \varphi(M'))
\end{eqnarray*}
Since $\varphi$ is an isomorphism we see that
$d(\varphi(M'), \varphi(M)) = d(M', M) = -d(M, M')$, and hence
$d(M, \varphi(M)) = d(M', \varphi(M'))$. Moreover, both sides of the
equation (of the lemma) are additive in $\varphi$, i.e.,
$$
\text{ord}_R(\det(\varphi \circ \psi))
=
\text{ord}_R(\det(\varphi))
+
\text{ord}_R(\det(\psi))
$$
and also
\begin{eqnarray*}
d(M, \varphi(\psi((M))) & = &
d(M, \psi(M)) + d(\psi(M), \varphi(\psi(M))) \\
& = & d(M, \psi(M)) + d(M, \varphi(M))
\end{eqnarray*}
by the independence shown above. Hence it suffices to prove the lemma
for generators of $\text{GL}(V)$. Choose an isomorphism
$K^{\oplus n} \cong V$. Then $\text{GL}(V) = \text{GL}_n(K)$ is
generated by elementary matrices $E$.
The result is clear for $E$ equal to the identity matrix.
If $E = E_{ij}(\lambda)$ with $i \not = j$, $\lambda \in K$,
$\lambda \not = 0$, for example
$$
E_{12}(\lambda) =
\left(
\begin{matrix}
1 & \lambda & \ldots \\
0 & 1 & \ldots \\
\ldots & \ldots & \ldots
\end{matrix}
\right)
$$
then with respect to a different basis we get $E_{12}(1)$.
The result is clear for $E = E_{12}(1)$ by taking as lattice
$R^{\oplus n} \subset K^{\oplus n}$. Finally, if $E = E_i(a)$,
with $a \in K^*$ for example
$$
E_1(a) =
\left(
\begin{matrix}
a & 0 & \ldots \\
0 & 1 & \ldots \\
\ldots & \ldots & \ldots
\end{matrix}
\right)
$$
then $E_1(a)(R^{\oplus b}) = aR \oplus R^{\oplus n - 1}$ and
it is clear that $d(R^{\oplus n}, aR \oplus R^{\oplus n - 1})
= \text{ord}_R(a)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-extension-dim-1}
Let $A \to B$ be a ring map. Assume
\begin{enumerate}
\item $A$ is a Noetherian local domain of dimension $1$,
\item $A \subset B$ is a finite extension of domains.
\end{enumerate}
Let $K = f.f.(A)$ and $L = f.f.(B)$ so that $L$ is a
finite field extension of $K$.
Let $y \in L^*$ and $x = \text{Nm}_{L/K}(y)$.
In this situation $B$ is semi-local.
Let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $B$.
Then
$$
\text{ord}_A(x) =
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(y)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
\end{lemma}

\begin{proof}
The ring $B$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Write $y = b/b'$ for some $b, b' \in B$.
By the additivity of $\text{ord}$ and multiplicativity of
$\text{Nm}$ it suffices to prove the lemma for
$y = b$ or $y = b'$. In other words we may assume $y \in B$.
In this case the left hand side of the formula is
$$
\sum [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{length}_{B_{\mathfrak m_i}}((B/yB)_{\mathfrak m_i})
$$
By Lemma \ref{lemma-pushdown-module} this is equal to
$\text{length}_A(B/yB)$. By Lemma \ref{lemma-order-vanishing-determinant}
we have
$$
\text{length}_A(B/yB) = d(B, yB) =
\text{ord}_A(\det\nolimits_K(L \xrightarrow{y} L)).
$$
Since $x = \text{Nm}_{L/K}(y) = \det\nolimits_K(L \xrightarrow{y} L)$
by definition the lemma is proved.
\end{proof}

\noindent
We can extend some of the results above to reduced $1$-dimensional
Noetherian local rings which are not domains by the following lemma.

\begin{lemma}
\label{lemma-not-domain}
Let $(R, \mathfrak m)$ be a reduced Noetherian local ring of dimension $1$
and let $x \in \mathfrak m$ be a nonzerodivisor. Let
$\mathfrak q_1, \ldots, \mathfrak q_r$ be the minimal primes of $R$.
Then
$$
\text{length}_R(R/(x)) = \sum\nolimits_i \text{ord}_{R/\mathfrak q_i}(x)
$$
\end{lemma}

\begin{proof}
Note that $R_i = R/\mathfrak q_i$ is a Noetherian $1$-dimensional local
domain. Denote $K_i = f.f.(R_i)$.
If $x$ is a unit in $R$, then both sides are zero. Hence we may assume
$x \in \mathfrak m$. Consider the map $\Psi : R \to \prod R_i$.
As $R$ is reduced this map is injective, see
Lemma \ref{lemma-Zariski-topology}.
By Lemma \ref{lemma-total-ring-fractions-no-embedded-points} we have
$Q(R) = \prod K_i$. Hence the finite $R$-module $\Coker(\Psi)$
is annihilated by a nonzerodivisor $y \in R$, hence has support
$\{\mathfrak m\}$, is annihilated by some power of $x$ and has finite
length over $R$, see Lemma \ref{lemma-support-point}.
Consider the short exact sequence
$$
0 \to R \to \prod R_i \to \Coker(\Psi) \to 0
$$
Applying multiplication by $x^n$ to this for $n \gg 0$ we obtain
from the snake lemma
$$
0 \to \Coker(\Psi) \to R/x^nR \to \prod R_i/x^nR_i \to
\Coker(\Psi) \to 0
$$
Thus we see that
$$
\text{length}_R(R/x^nR) 
=
\text{length}_R(\prod R_i/x^nR_i) = \sum \text{length}_R(R_i/x^nR_i)
$$
by Lemma \ref{lemma-length-additive}.
By Lemma \ref{lemma-length-independent} we have
$\text{length}_R(R_i/x^nR_i) = \text{length}_{R_i}(R_i/x^nR_i)$.
Now the result follows from the additivity of
Lemma \ref{lemma-ord-additive} and the definition of the order
of vanishing along $R_i$.
\end{proof}

\begin{lemma}
\label{lemma-length-multiplication}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module. Let $x \in R$. Assume that
\begin{enumerate}
\item $\dim(\text{Supp}(M)) \leq 1$, and
\item $\dim(\text{Supp}(M/xM)) \leq 0$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$.
Then
$$
\text{length}_R(M_x) - \text{length}_R({}_xM) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(x)
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $M_x = M/xM$ and ${}_xM = \Ker(x : M \to M)$.
\end{lemma}

\begin{proof}
We first make some preparatory remarks.
The result of the lemma holds if $M$ has finite length, i.e., if $t = 0$,
because in this case the exact sequence $0 \to {}_xM \to M \to M \to M_x \to 0$
and additivity of length shows that
$\text{length}_R(M_x) = \text{length}_R({}_xM)$.
Also, if we have a short exact sequence $0 \to M \to M' \to M'' \to 0$
of modules satisfying (1) and (2), then lemma for 2 out of 3
of these implies the lemma for the third by the snake lemma.

\medskip\noindent
Denote $M_i$ the image of $M$ in $M_{\mathfrak q_i}$, so
$\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The kernel and cokernel of the map $M \to \bigoplus M_i$
have support $\{\mathfrak m\}$ and hence have finite length.
By our preparatory remarks, it follows that it suffices to
prove the lemma for each $M_i$. Thus we may assume that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$.
In this case we can filter $M$ by powers of $\mathfrak q$.
Again additivity shows that it suffices to prove the lemma
in the case $M$ is annihilated by $\mathfrak q$.
In this case we can view $M$ as a $R/\mathfrak q$-module,
i.e., we may assume that $R$ is a Noetherian local domain
of dimension $1$ with fraction field $K$.
Dividing by the torsion submodule, i.e., by the
kernel of $M \to M \otimes_R K = V$ (the torsion has
finite length hence is handled by our preliminary remarks)
we may assume that $M \subset V$ is a lattice.
Then $\text{length}({}_xM) = 0$ and
$\text{length}_R(M_x) = d(M, xM)$. Since
$\text{length}_K(V) = \dim_K(V)$
we see that $\det(x : V \to V) = x^{\dim_K(V)}$ and
$\text{ord}_R(\det(x : V \to V)) = \dim_K(V) \text{ord}_R(x)$.
Thus the lemma follows from
Lemma \ref{lemma-order-vanishing-determinant}
in this particular case.
\end{proof}

\begin{lemma}
\label{lemma-additivity-divisors-restricted}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $I \subset R$ be an ideal and let $x \in R$.
Assume $x$ is a nonzerodivisor on $R/I$ and that $\dim(R/I) = 1$.
Then
$$
\text{length}_R(R/(x, I))
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i})
$$
where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal
primes over $I$. More generally if $M$ is any finite Cohen-Macaulay
module of dimension $1$ over $R$ and $\dim(\text{Supp}(M/xM)) = 0$, then
$$
\text{length}_R(M/xM)
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the
minimal primes of the support of $M$.
\end{lemma}

\begin{proof}
These are special cases of Lemma \ref{lemma-length-multiplication}.
\end{proof}














\section{Quasi-finite maps}
\label{section-quasi-finite}

\noindent
Consider a ring map $R \to S$ of finite type.
A map $\Spec(S) \to \Spec(R)$ is quasi-finite
at a point if that point is isolated in its fibre.
This means that the fibre is zero dimensional at that point.
In this section we study the basic properties of this
important but technical notion. More advanced material
can be found in the next section.

\begin{lemma}
\label{lemma-isolated-point}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Let $\mathfrak q$ be a prime of $S$.
The following are equivalent:
\begin{enumerate}
\item $\mathfrak q$ is an isolated point of $\Spec(S)$,
\item $S_{\mathfrak q}$ is finite over $k$,
\item there exists a $g \in S$, $g \not\in \mathfrak q$ such that
$D(g) = \{ \mathfrak q \}$,
\item $\dim_{\mathfrak q} \Spec(S) = 0$,
\item $\mathfrak q$ is a closed point of $\Spec(S)$ and
$\dim(S_{\mathfrak q}) = 0$, and
\item the field extension $k \subset \kappa(\mathfrak q)$ is finite
and $\dim(S_{\mathfrak q}) = 0$.
\end{enumerate}
In this case $S = S_{\mathfrak q} \times S'$ for some
finite type $k$-algebra $S'$. Also, the element $g$
as in (3) has the property $S_{\mathfrak q} = S_g$.
\end{lemma}

\begin{proof}
Suppose $\mathfrak q$ is an isolated point of $\Spec(S)$, i.e.,
$\{\mathfrak q\}$ is open in $\Spec(S)$.
Because $\Spec(S)$ is a Jacobson space (see
Lemmas \ref{lemma-finite-type-field-Jacobson} and
\ref{lemma-jacobson})
we see that $\mathfrak q$ is a closed point. Hence
$\{\mathfrak q\}$ is open and closed in $\Spec(S)$.
By
Lemmas \ref{lemma-disjoint-decomposition} and
\ref{lemma-disjoint-implies-product} we may
write $S = S_1 \times S_2$ with $\mathfrak q$
corresponding to the only point $\Spec(S_1)$.
Hence $S_1 = S_{\mathfrak q}$ is a zero dimensional
ring of finite type over $k$. Hence it is finite over $k$
for example by Lemma \ref{lemma-Noether-normalization}.
We have proved (1) implies (2).

\medskip\noindent
Suppose $S_{\mathfrak q}$ is finite over $k$.
Then $S_{\mathfrak q}$ is Artinian local, see
Lemma \ref{lemma-finite-dimensional-algebra}. So
$\Spec(S_{\mathfrak q}) = \{\mathfrak qS_{\mathfrak q}\}$ by
Lemma \ref{lemma-artinian-finite-length}.
Consider the exact sequence $0 \to K \to S \to S_{\mathfrak q}
\to Q \to 0$. It is clear that $K_{\mathfrak q} = Q_{\mathfrak q} = 0$.
Also, $K$ is a finite $S$-module as $S$ is Noetherian and
$Q$ is a finite $S$-modules since $S_{\mathfrak q}$ is finite over $k$.
Hence there exists $g \in S$, $g \not \in \mathfrak q$ such that
$K_g = Q_g = 0$. Thus $S_{\mathfrak q} = S_g$ and
$D(g) = \{ \mathfrak q \}$. We have proved that (2) implies (3).

\medskip\noindent
Suppose $D(g) =  \{ \mathfrak q \}$. Since $D(g)$ is open by
construction of the topology on $\Spec(S)$ we see that
$\mathfrak q$ is an isolated point of $\Spec(S)$.
We have proved that (3) implies (1).
In other words (1), (2) and (3) are equivalent.

\medskip\noindent
Assume $\dim_{\mathfrak q} \Spec(S) = 0$. This means that
there is some open neighbourhood of $\mathfrak q$ in $\Spec(S)$
which has dimension zero. Then there is an open neighbourhood of the
form $D(g)$ which has dimension zero. Since $S_g$ is Noetherian
we conclude that $S_g$ is Artinian and
$D(g) = \Spec(S_g)$ is a finite discrete set, see
Proposition \ref{proposition-dimension-zero-ring}.
Thus $\mathfrak q$ is an isolated point of $D(g)$ and,
by the equivalence of (1) and (2) above applied to
$\mathfrak qS_g \subset S_g$, we see that
$S_{\mathfrak q} = (S_g)_{\mathfrak qS_g}$ is finite over $k$.
Hence (4) implies (2). It is clear that (1) implies (4).
Thus (1) -- (4) are all equivalent.

\medskip\noindent
Lemma \ref{lemma-dimension-closed-point-finite-type-field}
gives the implication (5) $\Rightarrow$ (4).
The implication (4) $\Rightarrow$ (6) follows from
Lemma \ref{lemma-dimension-at-a-point-finite-type-field}.
The implication (6) $\Rightarrow$ (5) follows from
Lemma \ref{lemma-finite-residue-extension-closed}.
At this point we know (1) -- (6) are equivalent.

\medskip\noindent
The two statements at the end of the lemma we saw during the
course of the proof of the equivalence of (1), (2) and (3) above.
\end{proof}

\begin{lemma}
\label{lemma-isolated-point-fibre}
\begin{slogan}
Equivalent conditions for isolated points in fibres
\end{slogan}
Let $R \to S$ be a ring map of finite type.
Let $\mathfrak q \subset S$ be a prime lying over
$\mathfrak p \subset R$. Let $F = \Spec(S \otimes_R \kappa(\mathfrak p))$
be the fibre of $\Spec(S) \to \Spec(R)$, see
Remark \ref{remark-fundamental-diagram}.
Denote $\overline{\mathfrak q} \in F$ the point corresponding to
$\mathfrak q$. The following are equivalent
\begin{enumerate}
\item $\overline{\mathfrak q}$ is an isolated point of $F$,
\item $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is finite over
$\kappa(\mathfrak p)$,
\item there exists a $g \in S$, $g \not \in \mathfrak q$ such that
the only prime of $D(g)$ mapping to $\mathfrak p$ is $\mathfrak q$,
\item $\dim_{\overline{\mathfrak q}}(F) = 0$,
\item $\overline{\mathfrak q}$ is a closed point of $F$ and
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite and $\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} =
(S \otimes_R \kappa(\mathfrak p))_{\overline{\mathfrak q}}$.
Moreover $S \otimes_R \kappa(\mathfrak p)$ is of finite type over
$\kappa(\mathfrak p)$.
The conditions correspond exactly to the conditions of
Lemma \ref{lemma-isolated-point}
for the $\kappa(\mathfrak p)$-algebra $S \otimes_R \kappa(\mathfrak p)$
and the prime $\overline{\mathfrak q}$, hence they are equivalent.
\end{proof}

\begin{definition}
\label{definition-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
\begin{enumerate}
\item If the equivalent conditions of Lemma \ref{lemma-isolated-point-fibre}
are satisfied then we say $R \to S$ is {\it quasi-finite at $\mathfrak q$}.
\item We say a ring map $A \to B$ is {\it quasi-finite}
if it is of finite type and quasi-finite at all primes of $B$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-quasi-finite}
Let $R \to S$ be a finite type ring map.
Then $R \to S$ is quasi-finite if and only if for all
primes $\mathfrak p \subset R$
the fibre $S \otimes_R \kappa(\mathfrak p)$ is finite
over $\kappa(\mathfrak p)$.
\end{lemma}

\begin{proof}
If the fibres are finite then the map is clearly quasi-finite.
For the converse, note that $S \otimes_R \kappa(\mathfrak p)$
is a $\kappa(\mathfrak p)$-algebra of finite type over
$k$ of dimension $0$. Hence it is finite over $k$ for example
by Lemma \ref{lemma-Noether-normalization}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-local}
Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$
be a prime lying over $\mathfrak p \subset R$. Let
$f \in R$, $f \not \in \mathfrak p$ and $g \in S$, $g \not \in \mathfrak q$.
Then $R \to S$ is quasi-finite at $\mathfrak q$ if and only if
$R_f \to S_{fg}$ is quasi-finite at $\mathfrak qS_{fg}$.
\end{lemma}

\begin{proof}
The fibre of $\Spec(S_{fg}) \to \Spec(R_f)$ is homeomorphic
to an open subset of the fibre of $\Spec(S) \to \Spec(R)$.
Hence the lemma follows from part (1) of the equivalent conditions of
Lemma \ref{lemma-isolated-point-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-four-rings}
Let
$$
\xymatrix{
S \ar[r] & S' & &
\mathfrak q \ar@{-}[r] & \mathfrak q' \\
R \ar[u] \ar[r] &  R' \ar[u] & &
\mathfrak p \ar@{-}[r] \ar@{-}[u] & \mathfrak p' \ar@{-}[u]
}
$$
be a commutative diagram of rings with primes as indicated.
Assume $R \to S$ of finite type, and $S \otimes_R R' \to S'$ surjective.
If $R \to S$ is quasi-finite at $\mathfrak q$, then
$R' \to S'$ is quasi-finite at $\mathfrak q'$.
\end{lemma}

\begin{proof}
Write $S \otimes_R \kappa(\mathfrak p) = S_1 \times S_2$
with $S_1$ finite over $\kappa(\mathfrak p)$ and such that
$\mathfrak q$ corresponds to a point of $S_1$ as in
Lemma \ref{lemma-isolated-point}.
Because $S \otimes_R R' \to S'$ surjective the canonical map
$(S \otimes_R \kappa(\mathfrak p)) \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p') \to S' \otimes_{R'} \kappa(\mathfrak p')$
is surjective. Let $S_i'$ be the image of $S_i \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p')$ in $S' \otimes_{R'} \kappa(\mathfrak p')$.
Then $S' \otimes_{R'} \kappa(\mathfrak p') =S'_1 \times
S'_2$ and $S'_1$ is finite over $\kappa(\mathfrak p')$.
The map $S' \otimes_{R'} \kappa(\mathfrak p') \to
\kappa(\mathfrak q')$ factors through $S_1'$
(i.e.\ it annihilates the factor $S_2'$)
because the map $S \otimes_R \kappa(\mathfrak p) \to
\kappa(\mathfrak q)$ factors through $S_1$
(i.e.\ it annihilates the factor $S_2$). Thus
$\mathfrak q'$ corresponds to a point of
$\Spec(S_1')$ in the disjoint union decomposition
of the fibre: $\Spec(S' \otimes_{R'} \kappa(\mathfrak p'))
= \Spec(S_1') \amalg \Spec(S_1')$. (See
Lemma \ref{lemma-spec-product}.)
Since $S_1'$ is finite over a field, it is Artinian ring,
and hence $\Spec(S_1')$ is a finite discrete set.
(See Proposition \ref{proposition-dimension-zero-ring}.)
We conclude $\mathfrak q'$ is isolated in its fibre as
desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-composition}
A composition of quasi-finite ring maps is quasi-finite.
\end{lemma}

\begin{proof}
Suppose $A \to B$ and $B \to C$ are quasi-finite ring maps. By
Lemma \ref{lemma-compose-finite-type}
we see that $A \to C$ is of finite type.
Let $\mathfrak r \subset C$  be a prime of $C$ lying over
$\mathfrak q \subset B$ and $\mathfrak p \subset A$. Since $A \to B$ and
$B \to C$ are quasi-finite at $\mathfrak q$ and $\mathfrak r$ respectively,
then there exist $b \in B$ and $c \in C$ such that $\mathfrak q$ is
the only prime of $D(b)$ which maps to $\mathfrak p$ and similarly
$\mathfrak r$ is  the only prime of $D(c)$ which maps to $\mathfrak q$.
If $c' \in C$ is the image of $b \in B$, then $\mathfrak r$ is the only
prime of $D(cc')$ which maps to $\mathfrak p$.
Therefore $A \to C$ is quasi-finite at $\mathfrak r$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-base-change}
Let $R \to S$ be a ring map of finite type.
Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$.
\begin{enumerate}
\item The set
$\{\mathfrak q' \mid R' \to S' \text{ quasi-finite at }\mathfrak q'\}$
is the inverse image of the corresponding set of $\Spec(S)$
under the canonical map $\Spec(S') \to \Spec(S)$.
\item If $\Spec(R') \to \Spec(R)$ is surjective,
then $R \to S$ is quasi-finite if and only if $R' \to S'$ is quasi-finite.
\item Any base change of a quasi-finite ring map is quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p' \subset R'$ be a prime lying over $\mathfrak p \subset R$.
Then the fibre ring $S' \otimes_{R'} \kappa(\mathfrak p')$ is the
base change of the fibre ring $S \otimes_R \kappa(\mathfrak p)$
by the field extension $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$.
Hence the first assertion follows from the invariance of dimension
under field extension
(Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension})
and Lemma \ref{lemma-isolated-point}.
The stability of quasi-finite maps under base change follows from
this and the stability of finite type property under base change.
The second assertion follows
since the assumption implies that given a prime $\mathfrak q \subset S$ we can
find a prime $\mathfrak q' \subset S'$ lying over it.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-permanence}
Let $A \to B$ and $B \to C$ be finite type ring homomorphisms.
Let $\mathfrak r$ be a prime of $C$ lying over
$\mathfrak q \subset B$ and $\mathfrak p \subset A$.
If $A \to C$ is quasi-finite at $\mathfrak r$, then
$B \to C$ is quasi-finite at $\mathfrak r$.
\end{lemma}

\begin{proof}
Using property (3) of Lemma \ref{lemma-isolated-point-fibre}:
By assumption there exists some $c \in C$ such that
$$
\{\mathfrak r' \subset C \text{ lying over }\mathfrak p\} \cap D(c) =
\{\mathfrak{r}\}.
$$
Since the primes $\mathfrak r' \subset C$ lying over $\mathfrak q$
form a subset of the primes $\mathfrak r' \subset C$ lying over
$\mathfrak p$ we conclude.
\end{proof}

\noindent
The following lemma is not quite about quasi-finite ring maps, but
it does not seem to fit anywhere else so well.

\begin{lemma}
\label{lemma-generically-finite}
Let $R \to S$ be a ring map of finite type.
Let $\mathfrak p \subset R$ be a minimal prime.
Assume that there are at most finitely many primes of $S$
lying over $\mathfrak p$. Then there exists a
$g \in R$, $g \not \in \mathfrak p$ such that the
ring map $R_g \to S_g$ is finite.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n$ be generators of $S$ over $R$.
Since $\mathfrak p$ is a minimal prime we have that
$\mathfrak pR_{\mathfrak p}$ is a locally nilpotent ideal, see
Lemma \ref{lemma-minimal-prime-reduced-ring}.
Hence $\mathfrak pS_{\mathfrak p}$ is a locally nilpotent ideal, see
Lemma \ref{lemma-locally-nilpotent}.
By assumption the finite type $\kappa(\mathfrak p)$-algebra
$S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$ has finitely many
primes. Hence (for example by
Lemmas \ref{lemma-finite-type-algebra-finite-nr-primes} and
\ref{lemma-Noether-normalization})
$\kappa(\mathfrak p) \to S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$
is a finite ring map. Thus we may find monic polynomials
$P_i \in R_{\mathfrak p}[X]$ such that $P_i(x_i)$ maps to zero
in $S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$. By what we said
above there exist $e_i \geq 1$ such that $P(x_i)^{e_i} = 0$
in $S_{\mathfrak p}$. Let $g_1 \in R$, $g_1 \not \in \mathfrak p$
be an element such that $P_i \in R[1/g_1]$ for all $i$.
Next, let $g_2 \in R$, $g_2 \not \in \mathfrak p$ be an element
such that $P(x_i)^{e_i} = 0$ in $S_{g_1g_2}$. Setting $g = g_1g_2$
we win.
\end{proof}







\section{Zariski's Main Theorem}
\label{section-Zariski}

\noindent
In this section our aim is to prove the algebraic version of
Zariski's Main theorem. This theorem will be the basis of many
further developments in the theory of schemes and morphisms of
schemes later in the Stacks project.

\medskip\noindent
Let $R \to S$ be a ring map of finite type.
Our goal in this section is to show that the set
of points of $\Spec(S)$ where the map is quasi-finite
is {\it open} (Theorem \ref{theorem-main-theorem}).
In fact, it will turn out that there exists
a finite ring map $R \to S'$ such that in some sense the quasi-finite
locus of $S/R$ is open in $\Spec(S')$
(but we will not prove this in the algebra chapter since we do not
develop the language of schemes here -- for the case where $R \to S$
is quasi-finite see Lemma \ref{lemma-quasi-finite-open-integral-closure}).
These statements are somewhat tricky to prove and
we do it by a long list of lemmas concerning integral and
finite extensions of rings. This material may be found
in \cite{Henselian}, and \cite{Peskine}. We also found notes
by Thierry Coquand helpful.

\begin{lemma}
\label{lemma-make-integral-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Then $\varphi(a_n)t$ is integral over $R$.
\end{lemma}

\begin{proof}
Namely, multiply the equation
$\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$
with $\varphi(a_n)^{n-1}$ and write it as
$\varphi(a_0 a_n^{n-1}) +
\varphi(a_1 a_n^{n-2}) (\varphi(a_n)t) +
\ldots +
(\varphi(a_n) t)^n = 0$.
\end{proof}

\noindent
The following lemma is in some sense the key lemma in this
section.

\begin{lemma}
\label{lemma-make-integral-trick}
Let $R$ be a ring. Let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$.
Assume that (a) $t$ is integral over $R[x]$,
and (b) there exists a monic $p \in R[x]$ such that
$t \varphi(p) \in \Im(\varphi)$. Then there
exists a $q \in R[x]$ such that $t - \varphi(q)$
is integral over $R$.
\end{lemma}

\begin{proof}
Write $t \varphi(p) = \varphi(r)$ for some $r \in R[x]$.
Using euclidean division, write $r = qp + r'$ with
$q, r' \in R[x]$ and $\deg(r') < \deg(p)$. We may replace
$t$ by $t - \varphi(q)$ which is still integral over
$R[x]$, so that we obtain $t \varphi(p) = \varphi(r')$.
In the ring $S_t$ we may write this as
$\varphi(p) - (1/t) \varphi(r') = 0$.
This implies that $\varphi(x)$ gives an element of the
localization $S_t$ which is integral over
$\varphi(R)[1/t] \subset S_t$. On the other hand,
$t$ is integral over the subring $\varphi(R)[\varphi(x)] \subset S$.
Combined we conclude that $t$ is integral over
the subring $\varphi(R)[1/t] \subset S_t$, see Lemma
\ref{lemma-integral-transitive}. In other words
there exists an equation of the form
$t^d + \sum_{i<d} (\varphi(r_i)/t^{n_i}) t^i = 0$
in $S_t$ with $r_i \in R$. This means that
$t^{d + N} + \sum_{i < d} \varphi(r_i) t^{i + N - n_i} = 0$ in $S$
for some $N$ large enough. In other words
$t$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-change-equation-multiply}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. If $t$ is integral over
$R[x]$, then there exists an $\ell \geq 0$ such that
for every $a \in R$ the element $\varphi(a)^\ell t$
is integral over $\varphi_a : R[y] \to S$, defined by
$y \mapsto \varphi(ax)$ and $r \mapsto \varphi(r)$
for $r\in R$.
\end{lemma}

\begin{proof}
Say $t^d + \sum_{i<d} \varphi(f_i)t^i = 0$
with $f_i \in R[x]$. Let $\ell$ be the maximum degree
in $x$ of all the $f_i$. Multiply the equation
by $\varphi(a)^\ell$ to get
$\varphi(a)^\ell t^d + \sum_{i<d} \varphi(a^\ell f_i)t^i = 0$.
Note that each $\varphi(a^\ell f_i)$ is in the image of
$\varphi_a$. The result follows from
Lemma \ref{lemma-make-integral-trivial}.
\end{proof}

\begin{lemma}
\label{lemma-combine-lemmas}
Let $R$ be a ring. Let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. Assume $t$ is integral
over $R[x]$. Let $p \in R[x]$, $p = a_0 + a_1x + \ldots +
a_k x^k$ such that $t \varphi(p) \in \Im(\varphi)$.
Then there exists a $q \in R[x]$ and $n \geq 0$
such that $\varphi(a_k)^n t - \varphi(q) $ is integral
over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-change-equation-multiply} there exists
an $\ell \geq 0$ such that
the element $\varphi(a_k)^\ell t$ is integral
over the map $\varphi' : R[y] \to S$, $\varphi'(y) =
\varphi(a_k x)$ and $\varphi'(r) = \varphi(r)$, for $r\in R$.
The polynomial $p' = a_k^{k-1} a_0 + a_k^{k-2} a_1 y
+ \ldots + y^k$ is monic and $t \varphi'(p')
= \varphi(a_k^{k-1}) t \varphi(p) \in \Im(\varphi)$.
By definition of $\varphi'$ this implies there exists
a $n \geq k-1$ such that $\varphi(a_k^n)t \varphi'(p')
\in \Im(\varphi')$. If also $n \geq \ell$, then
$\varphi(a_k)^n t$ is still integral over $R[y]$.
By Lemma \ref{lemma-make-integral-trick}
we see that $\varphi(a_k)^n t - \varphi'(q)$ is integral over $R$
for some $q \in R[y]$. Again by the simple relationship between
$\varphi'$ and $\varphi$ this implies the lemma.
\end{proof}

\begin{situation}
\label{situation-one-transcendental-element}
Let $R$ be a ring.
Let $\varphi : R[x] \to S$ be finite.
Let
$$
J = \{ g \in S \mid gS \subset \Im(\varphi)\}
$$
be the ``conductor ideal'' of $\varphi$.
Assume $\varphi(R) \subset S$ integrally closed in $S$.
\end{situation}

\begin{lemma}
\label{lemma-leading-coefficient-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0, \ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in J$.
Then there exists an $m \geq 0$ such that
$u \varphi(a_k)^m \in J$.
\end{lemma}

\begin{proof}
Assume that $S$ is generated by $t_1, \ldots, t_n$
as an $R[x]$-module. In this case
$J = \{ g \in S \mid gt_i \in \Im(\varphi)\text{ for all }i\}$.
Note that each element $u t_i$ is integral over
$R[x]$, see Lemma \ref{lemma-finite-is-integral}.
We have $\varphi(a_0 + a_1x + \ldots + a_k x^k) u t_i \in
\Im(\varphi)$. By Lemma \ref{lemma-combine-lemmas}, for
each $i$ there exists an integer $n_i$ and an element
$q_i \in R[x]$ such that $\varphi(a_k^{n_i}) u t_i - \varphi(q_i)$
is integral over $R$. By assumption this element is in $\varphi(R)$
and hence $\varphi(a_k^{n_i}) u t_i \in \Im(\varphi)$.
It follows that $m = \max\{n_1, \ldots, n_n\}$ works.
\end{proof}

\begin{lemma}
\label{lemma-all-coefficients-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0, \ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in \sqrt{J}$.
Then $u \varphi(a_i) \in \sqrt{J}$ for all $i$.
\end{lemma}

\begin{proof}
Under the assumptions of the lemma we have
$u^n \varphi(a_0 + a_1x + \ldots + a_k x^k)^n \in J$ for
some $n \geq 1$. By Lemma \ref{lemma-leading-coefficient-in-J}
we deduce $u^n \varphi(a_k^{nm}) \in J$ for some $m \geq 1$.
Thus $u \varphi(a_k) \in \sqrt{J}$, and so
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) - u \varphi(a_k) =
u \varphi(a_0 + a_1x + \ldots + a_{k-1} x^{k-1}) \in \sqrt{J}$.
We win by induction on $k$.
\end{proof}

\noindent
This lemma suggests the following definition.

\begin{definition}
\label{definition-strongly-transcendental}
Given an inclusion of rings $R \subset S$ and
an element $x \in S$ we say that $x$ is
{\it strongly transcendental over $R$} if
whenever $u(a_0 + a_1 x + \ldots + a_k x^k) = 0$
with $u \in S$ and $a_i \in R$, then
we have $ua_i = 0$ for all $i$.
\end{definition}

\noindent
Note that if $S$ is a domain then this is the same as
saying that $x$ as an element of the fraction field of
$S$ is transcendental over the fraction field of $R$.

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-minimal-prime}
Suppose $R \subset S$ is an inclusion of reduced rings
and suppose that $x \in S$ is strongly transcendental over $R$.
Let $\mathfrak q \subset S$ be a minimal prime
and let $\mathfrak p = R \cap \mathfrak q$.
Then the image of $x$ in $S/\mathfrak q$ is strongly
transcendental over the subring $R/\mathfrak p$.
\end{lemma}

\begin{proof}
Suppose $u(a_0 + a_1x + \ldots + a_k x^k) \in \mathfrak q$.
By Lemma \ref{lemma-minimal-prime-reduced-ring}
the local ring $S_{\mathfrak q}$ is a field,
and hence $u(a_0 + a_1x + \ldots + a_k x^k) $ is zero
in $S_{\mathfrak q}$. Thus $uu'(a_0 + a_1x + \ldots + a_k x^k) = 0$
for some $u' \in S$, $u' \not\in \mathfrak q$.
Since $x$ is strongly transcendental over $R$ we get
$uu'a_i = 0$ for all $i$. This in turn implies
that $ua_i \in \mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-domains-transcendental-not-quasi-finite}
Suppose $R\subset S$ is an inclusion of domains and
let $x \in S$. Assume $x$ is (strongly) transcendental over $R$
and that $S$ is finite over $R[x]$. Then $R \to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
As a first case, assume that $R$ is normal, see
Definition \ref{definition-ring-normal}.
By Lemma \ref{lemma-polynomial-ring-normal}
we see that $R[x]$ is normal.
Take a prime $\mathfrak q \subset S$,
and set $\mathfrak p = R \cap \mathfrak q$.
Assume that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak q)$ is finite.
This would be the case if $R \to S$ is
quasi-finite at $\mathfrak q$.
Let $\mathfrak r = R[x] \cap \mathfrak q$.
Then since $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r) \subset \kappa(\mathfrak q)$
we see that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r)$ is finite too.
Thus the inclusion $\mathfrak r \supset \mathfrak p R[x]$
is strict. By going down for $R[x] \subset S$,
see Proposition \ref{proposition-going-down-normal-integral},
we find a prime $\mathfrak q' \subset \mathfrak q$,
lying over the prime $\mathfrak pR[x]$. Hence
the fibre $\Spec(S \otimes_R \kappa(\mathfrak p))$
contains a point not equal to $\mathfrak q$,
namely $\mathfrak q'$, whose closure contains $\mathfrak q$ and hence
$\mathfrak q$ is not isolated in its fibre.

\medskip\noindent
If $R$ is not normal, let $R \subset R' \subset K$ be
the integral closure $R'$ of $R$ in its field of fractions
$K$. Let $S \subset S' \subset L$ be the subring $S'$ of
the field of fractions $L$ of $S$ generated by $R'$ and
$S$. Note that by construction the map $S \otimes_R R'
\to S'$ is surjective. This implies that $R'[x] \subset S'$
is finite. Also, the map $S \subset S'$
induces a surjection on $\Spec$, see
Lemma \ref{lemma-integral-overring-surjective}.
We conclude by Lemma \ref{lemma-four-rings} and the normal case
we just discussed.
\end{proof}

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-not-quasi-finite}
Suppose $R \subset S$ is an inclusion of reduced rings.
Assume $x \in S$ be strongly transcendental over $R$,
and $S$ finite over $R[x]$. Then $R \to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be any prime.
Choose a minimal prime $\mathfrak q' \subset \mathfrak q$.
According to Lemmas
\ref{lemma-reduced-strongly-transcendental-minimal-prime} and
\ref{lemma-domains-transcendental-not-quasi-finite}
the extension $R/(R \cap \mathfrak q') \subset
S/\mathfrak q'$ is not quasi-finite at the prime corresponding
to $\mathfrak q$. By Lemma \ref{lemma-four-rings}
the extension $R \to S$ is not quasi-finite
at $\mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-monogenic}
Let $R$ be a ring. Let $S = R[x]/I$.
Let $\mathfrak q \subset S$ be a prime.
Assume $R \to S$ is quasi-finite at $\mathfrak q$.
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Then there exists an element
$g \in S'$, $g \not\in \mathfrak q$ such that
$S'_g \cong S_g$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be the image of $\mathfrak q$ in $\Spec(R)$.
There exists an $f \in I$, $f = a_nx^n + \ldots + a_0$ such that
$a_i \not \in \mathfrak p$ for some $i$. Namely, otherwise the fibre ring
$S \otimes_R \kappa(\mathfrak p)$ would be $\kappa(\mathfrak p)[x]$
and the map would not be quasi-finite at any prime lying
over $\mathfrak p$. We conclude there exists a relation
$b_m x^m + \ldots + b_0 = 0$ with $b_j \in S'$, $j = 0, \ldots, m$
and $b_j \not \in \mathfrak q \cap S'$ for some $j$.
We prove the lemma by induction on $m$.

\medskip\noindent
The case $b_m \in \mathfrak q$. In this case we have $b_mx \in S'$ by
Lemma \ref{lemma-make-integral-trivial}.
Set $b'_{m - 1} = b_mx + b_{m - 1}$. Then
$$
b'_{m - 1}x^{m - 1} + b_{m - 2}x^{m - 2} + \ldots + b_0 = 0
$$
Since $b'_{m - 1}$ is congruent to $b_{m - 1}$ modulo $S' \cap \mathfrak q$
we see that it is still the case that one of
$b'_{m - 1}, b_{m - 2}, \ldots, b_0$ is not in $S' \cap \mathfrak q$.
Thus we win by induction on $m$.

\medskip\noindent
The case $b_m \not \in \mathfrak q$. In this case $x$ is integral
over $S'_{b_m}$, in fact $b_mx \in S'$ by
Lemma \ref{lemma-make-integral-trivial}.
Hence the injective map $S'_{b_m} \to S_{b_m}$ is also surjective, i.e.,
an isomorphism as desired.
\end{proof}

\begin{theorem}[Zariski's Main Theorem]
\label{theorem-main-theorem}
Let $R$ be a ring. Let $R \to S$ be a finite type $R$-algebra.
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Let $\mathfrak q \subset S$ be a prime of $S$.
If $R \to S$ is quasi-finite at $\mathfrak q$ then
there exists a $g \in S'$, $g \not \in \mathfrak q$
such that $S'_g \cong S_g$.
\end{theorem}

\begin{proof}
There exist finitely many elements
$x_1, \ldots, x_n \in S$ such that $S$ is finite
over the $R$-sub algebra generated by $x_1, \ldots, x_n$. (For
example generators of $S$ over $R$.) We prove the proposition
by induction on the minimal such number $n$.

\medskip\noindent
The case $n = 0$ is trivial, because in this case $S' = S$,
see Lemma \ref{lemma-finite-is-integral}.

\medskip\noindent
The case $n = 1$. We may replace $R$ by its integral closure in $S$
(Lemma \ref{lemma-quasi-finite-permanence} guarantees that $R \to S$
is still quasi-finite at $\mathfrak q$). Thus we may assume
$R \subset S$ is integrally closed in $S$.
Consider the map $\varphi : R[x] \to S$, $x \mapsto x_1$.
(We will see that $\varphi$ is not injective below.)
By assumption $\varphi$ is finite. Hence we are in Situation
\ref{situation-one-transcendental-element}.
Let $J \subset S$ be the ``conductor ideal'' defined
in Situation \ref{situation-one-transcendental-element}.
Consider the diagram
$$
\xymatrix{
R[x] \ar[r] & S \ar[r] & S/\sqrt{J} & R/(R \cap \sqrt{J})[x] \ar[l]
\\
& R \ar[lu] \ar[r] \ar[u] & R/(R \cap \sqrt{J}) \ar[u] \ar[ru] &
}
$$
According to Lemma \ref{lemma-all-coefficients-in-J}
the image of $x$ in the quotient $S/\sqrt{J}$
is strongly transcendental over $R/ (R \cap \sqrt{J})$.
Hence by Lemma \ref{lemma-reduced-strongly-transcendental-not-quasi-finite}
the ring map $R/ (R \cap \sqrt{J}) \to S/\sqrt{J}$
is not quasi-finite at any prime of $S/\sqrt{J}$.
By Lemma \ref{lemma-four-rings} we deduce that $\mathfrak q$
does not lie in $V(J) \subset \Spec(S)$.
Thus there exists an element $s \in J$,
$s \not\in \mathfrak q$. By definition of $J$ we may write
$s = \varphi(f)$ for some polynomial $f \in R[x]$.
Now let $I = \Ker(R[x] \to S)$. Since $\varphi(f) \in J$
we get $(R[x]/I)_f \cong S_{\varphi(f)}$. Also $s \not \in \mathfrak q$
means that $f \not \in \varphi^{-1}(\mathfrak q)$. Thus
$\varphi^{-1}(\mathfrak q)$ is a prime of $R[x]/I$
at which $R \to R[x]/I$ is quasi-finite, see
Lemma \ref{lemma-quasi-finite-local}.
Let $C \subset R[x]/I$ be the integral closure of $R$. By
Lemma \ref{lemma-quasi-finite-monogenic}
there exists an element $h \in C$, $h \not \in \varphi^{-1}(\mathfrak q)$
such that $C_h \cong (R[x]/I)_h$. We conclude that
$(R[x]/I)_{fh} = S_{\varphi(fh)}$ is isomorphic to a principal
localization $C_{h'}$ of $C$ for some
$h' \in C$, $h' \not \in \varphi^{-1}(\mathfrak q)$.
Since $\varphi(C) \subset S'$ we get
$g = \varphi(h') \in S'$, $g \not \in \mathfrak q$
and moreover the injective map $S'_g \to S_g$ is also surjective
because by our choice of $h'$ the map $C_{h'} \to S_g$ is surjective.

\medskip\noindent
The case $n > 1$. Consider the subring $R' \subset S$
which is the integral closure of $R[x_1, \ldots, x_{n-1}]$
in $S$. By Lemma \ref{lemma-four-rings} the extension
$S/R'$ is quasi-finite at $\mathfrak q$. Also, note
that $S$ is finite over $R'[x_n]$.
By the case $n = 1$ above, there exists a $g' \in R'$,
$g' \not \in \mathfrak q$ such that
$(R')_{g'} \cong S_{g'}$. At this point we cannot
apply induction to $R \to R'$ since $R'$ may not be finite type over $R$.
Since $S$ is finitely generated over $R$ we deduce in particular
that $(R')_{g'}$ is finitely generated over $R$. Say
the elements $g'$, and $y_1/(g')^{n_1}, \ldots, y_N/(g')^{n_N}$
with $y_i \in R'$
generate $(R')_{g'}$ over $R$. Let $R''$ be the $R$-sub algebra
of $R'$ generated by $x_1, \ldots, x_{n-1}, y_1, \ldots, y_N, g'$.
This has the property $(R'')_{g'} \cong S_{g'}$. Surjectivity
because of how we chose $y_i$, injectivity because
$R'' \subset R'$, and localization is exact. Note that
$R''$ is finite over $R[x_1, \ldots, x_{n-1}]$ because
of our choice of $R'$, see Lemma \ref{lemma-characterize-integral}.
Let $\mathfrak q'' = R'' \cap \mathfrak q$. Since
$(R'')_{\mathfrak q''} = S_{\mathfrak q}$ we see that
$R \to R''$ is quasi-finite at $\mathfrak q''$, see
Lemma \ref{lemma-isolated-point-fibre}.
We apply our induction hypothesis to $R \to R''$, $\mathfrak q''$
and $x_1, \ldots, x_{n-1} \in R''$ and we find a subring
$R''' \subset R''$ which is integral over $R$ and an
element $g'' \in R'''$, $g'' \not \in \mathfrak q''$
such that $(R''')_{g''} \cong (R'')_{g''}$. Write the image of $g'$ in
$(R'')_{g''}$ as $g'''/(g'')^n$ for some $g''' \in  R'''$.
Set $g = g''g''' \in R'''$. Then it is clear that $g \not\in
\mathfrak q$ and $(R''')_g \cong S_g$. Since by construction
we have $R''' \subset S'$ we also have $S'_g \cong S_g$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-open}
Let $R \to S$ be a finite type ring map.
The set of points $\mathfrak q$ of $\Spec(S)$ at which
$S/R$ is quasi-finite is open in $\Spec(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be a point at which the ring map
is quasi-finite. By Theorem \ref{theorem-main-theorem}
there exists an integral ring extension $R \to S'$, $S' \subset S$
and an element $g \in S'$, $g\not \in \mathfrak q$ such that
$S'_g \cong S_g$. Since $S$ and hence $S_g$ are of finite type
over $R$ we may find finitely many elements
$y_1, \ldots, y_N$ of $S'$ such that $S''_g \cong S$
where $S'' \subset S'$ is the sub $R$-algebra generated
by $g, y_1, \ldots, y_N$. Since $S''$ is finite over $R$
(see Lemma \ref{lemma-characterize-integral}) we see that
$S''$ is quasi-finite over $R$ (see Lemma \ref{lemma-quasi-finite}).
It is easy to see that this implies that $S''_g$ is quasi-finite over $R$,
for example because the property of being quasi-finite at a prime depends
only on the local ring at the prime. Thus we see that $S_g$ is quasi-finite
over $R$. By the same token this implies that $R \to S$ is quasi-finite
at every prime of $S$ which lies in $D(g)$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-open-integral-closure}
Let $R \to S$ be a finite type ring map.
Suppose that $S$ is quasi-finite over $R$.
Let $S' \subset S$ be the integral closure of $R$ in $S$. Then
\begin{enumerate}
\item $\Spec(S) \to \Spec(S')$ is a homeomorphism
onto an open subset,
\item if $g \in S'$ and $D(g)$ is contained in the image
of the map, then $S'_g \cong S_g$, and
\item there exists a finite $R$-algebra $S'' \subset S'$
such that (1) and (2) hold for the ring map
$S'' \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $S/R$ is quasi-finite we may apply
Theorem \ref{theorem-main-theorem} to
each point $\mathfrak q$ of $\Spec(S)$.
Since $\Spec(S)$ is quasi-compact, see
Lemma \ref{lemma-quasi-compact}, we may choose
a finite number of $g_i \in S'$, $i = 1, \ldots, n$
such that $S'_{g_i} = S_{g_i}$, and such that
$g_1, \ldots, g_n$ generate the unit ideal in $S$
(in other words the standard opens of $\Spec(S)$ associated
to $g_1, \ldots, g_n$ cover all of $\Spec(S)$).

\medskip\noindent
Suppose that $D(g) \subset \Spec(S')$
is contained in the image. Then $D(g) \subset \bigcup D(g_i)$.
In other words, $g_1, \ldots, g_n$ generate the unit ideal of
$S'_g$. Note that $S'_{gg_i} \cong S_{gg_i}$ by our choice
of $g_i$. Hence $S'_g \cong S_g$ by Lemma \ref{lemma-cover}.

\medskip\noindent
We construct a finite algebra $S'' \subset S'$ as
in (3). To do this note that each $S'_{g_i} \cong S_{g_i}$
is a finite type $R$-algebra. For each $i$ pick
some elements $y_{ij} \in S'$ such that each
$S'_{g_i}$ is generated as $R$-algebra by $1/g_i$
and the elements $y_{ij}$. Then set $S''$
equal to the sub $R$-algebra of $S'$ generated by all $g_i$
and all the $y_{ij}$. Details omitted.
\end{proof}




\section{Applications of Zariski's Main Theorem}
\label{section-apply-main-theorem}

\noindent
Here is an immediate application characterizing the finite
maps of $1$-dimensional semi-local rings among the quasi-finite
ones as those where equality always holds in the
formula of Lemma \ref{lemma-finite-extension-dim-1}.

\begin{lemma}
\label{lemma-quasi-finite-extension-dim-1}
Let $A \subset B$ be an extension of domains. Assume
\begin{enumerate}
\item $A$ is a local Noetherian ring of dimension $1$,
\item $A \to B$ is of finite type, and
\item the extension $K = f.f.(A) \subset L = f.f.(B)$
is a finite field extension.
\end{enumerate}
Then $B$ is semi-local.
Let $x \in \mathfrak m_A$, $x \not = 0$.
Let $\mathfrak m_i$, $i = 1, \ldots, n$
be the maximal ideals of $B$.
Then
$$
[L : K]\text{ord}_A(x)
\geq
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(x)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
We have equality if and only if $A \to B$ is finite.
\end{lemma}

\begin{proof}
The ring $B$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Let $B'$ be the integral closure of $A$ in $B$. By
Lemma \ref{lemma-quasi-finite-open-integral-closure}
we can find a finite $A$-subalgebra $C \subset B'$ such that
on setting $\mathfrak n_i = C \cap \mathfrak m_i$ we have
$C_{\mathfrak n_i} \cong B_{\mathfrak m_i}$ and the primes
$\mathfrak n_1, \ldots, \mathfrak n_n$ are pairwise distinct.
The ring $C$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Let $\mathfrak p_j$, $j = 1, \ldots, m$ be the other maximal
ideals of $C$ (the ``missing points''). By
Lemma \ref{lemma-finite-extension-dim-1} we have
$$
\text{ord}_A(x^{[L : K]}) =
\sum\nolimits_i
[\kappa(\mathfrak n_i) : \kappa(\mathfrak m_A)]
\text{ord}_{C_{\mathfrak n_i}}(x)
+
\sum\nolimits_j
[\kappa(\mathfrak p_j) : \kappa(\mathfrak m_A)]
\text{ord}_{C_{\mathfrak p_j}}(x)
$$
hence the inequality follows. In case of equality we conclude that
$m = 0$ (no ``missing points''). Hence $C \subset B$ is an inclusion
of semi-local rings inducing a bijection on maximal ideals and
an isomorphism on all localizations at maximal ideals. So if $b \in B$,
then $I = \{x \in C \mid xb \in C\}$ is an ideal of $C$ which is not
contained in any of the maximal ideals of $C$, and hence $I = C$,
hence $b \in C$. Thus $B = C$ and $B$ is finite over $A$.
\end{proof}

\noindent
Here is a more standard application of Zariski's main theorem to the
structure of local homomorphisms of local rings.

\begin{lemma}
\label{lemma-essentially-finite-type-fibre-dim-zero}
Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism
of local rings. Assume
\begin{enumerate}
\item $R \to S$ is essentially of finite type,
\item $\kappa(\mathfrak m_R) \subset \kappa(\mathfrak m_S)$ is finite, and
\item $\dim(S/\mathfrak m_RS) = 0$.
\end{enumerate}
Then $S$ is the localization of a finite $R$-algebra.
\end{lemma}

\begin{proof}
Let $S'$ be a finite type $R$-algebra such that $S = S'_{\mathfrak q'}$
for some prime $\mathfrak q'$ of $S'$. By
Definition \ref{definition-quasi-finite}
we see that $R \to S'$ is quasi-finite at $\mathfrak q'$.
After replacing $S'$ by $S'_{g'}$ for some
$g' \in S'$, $g' \not \in \mathfrak q'$ we may assume that $R \to S'$ is
quasi-finite, see
Lemma \ref{lemma-quasi-finite-open}.
Then by
Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite $R$-algebra $S''$ and elements
$g' \in S'$, $g' \not \in \mathfrak q'$ and $g'' \in S''$
such that $S'_{g'} \cong S''_{g''}$ as $R$-algebras.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-completion-at-quasi-finite-prime}
Let $R \to S$ be a ring map, $\mathfrak q$ a prime of $S$
lying over $\mathfrak p$ in $R$. If
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type, and
\item $R \to S$ is quasi-finite at $\mathfrak q$,
\end{enumerate}
then $R_\mathfrak p^\wedge \otimes_R S = S_\mathfrak q^\wedge \times B$
for some $R_\mathfrak p^\wedge$-algebra $B$.
\end{lemma}

\begin{proof}
There exists a finite $R$-algebra $S' \subset S$ and an element
$g \in S'$, $g \not \in \mathfrak q' = S' \cap \mathfrak q$
such that $S'_g = S_g$ and in particular
$S'_{\mathfrak q'} = S_\mathfrak q$, see
Lemma \ref{lemma-quasi-finite-open-integral-closure}.
We have
$$
R_\mathfrak p^\wedge \otimes_R S' = (S'_{\mathfrak q'})^\wedge \times B'
$$
by Lemma \ref{lemma-completion-finite-extension}.
Note that we have a commutative diagram
$$
\xymatrix{
R_\mathfrak p^\wedge \otimes_R S \ar[r] & S_\mathfrak q^\wedge \\
R_\mathfrak p^\wedge \otimes_R S' \ar[r] \ar[u] &
(S'_{\mathfrak q'})^\wedge \ar[u]
}
$$
where the right vertical is an isomorphism and the lower horizontal
arrow is the projection map of the product decomposition above.
The lemma follows.
\end{proof}




































\section{Dimension of fibres}
\label{section-dimension-fibres}

\noindent
We study the behaviour of dimensions of fibres, using
Zariski's main theorem. Recall that we defined the
dimension $\dim_x(X)$ of a topological space $X$ at a point $x$
in Topology, Definition \ref{topology-definition-Krull}.

\begin{definition}
\label{definition-relative-dimension}
Suppose that $R \to S$ is of finite type, and let
$\mathfrak q \subset S$ be a prime lying over a prime
$\mathfrak p$ of $R$.
We define the {\it relative dimension
of $S/R$ at $\mathfrak q$}, denoted
$\dim_{\mathfrak q}(S/R)$, to be the dimension
of $\Spec(S \otimes_R \kappa(\mathfrak p))$
at the point corresponding to $\mathfrak q$. We let
$\dim(S/R)$ be the supremum of $\dim_{\mathfrak q}(S/R)$
over all $\mathfrak q$. This is called the
{\it relative dimension of} $S/R$.
\end{definition}

\noindent
In particular, $R \to S$ is quasi-finite at $\mathfrak q$ if
and only if $\dim_{\mathfrak q}(S/R) = 0$. The following lemma
is more or less a reformulation of Zariski's Main Theorem.

\begin{lemma}
\label{lemma-quasi-finite-over-polynomial-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists a $g \in S$, $g \not\in \mathfrak q$
such that $S_g$ is quasi-finite over a
polynomial algebra $R[t_1, \ldots, t_n]$.
\end{lemma}

\begin{proof}
The ring $\overline{S} = S \otimes_R \kappa(\mathfrak p)$ is
of finite type over $\kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{S}$
corresponding to $\mathfrak q$.
By definition of
the dimension of a topological space at a point there exists
an open $U \subset \Spec(\overline{S})$ with
$\overline{q} \in U$ and $\dim(U) = n$.
Since the topology on $\Spec(\overline{S})$ is
induced from the topology on $\Spec(S)$ (see
Remark \ref{remark-fundamental-diagram}), we can find
a $g \in S$, $g \not \in \mathfrak q$ with image
$\overline{g} \in \overline{S}$ such that
$D(\overline{g}) \subset U$.
Thus after replacing $S$ by $S_g$ we see that
$\dim(\overline{S}) = n$.

\medskip\noindent
Next, choose generators $x_1, \ldots, x_N$ for $S$ as an $R$-algebra. By
Lemma \ref{lemma-Noether-normalization}
there exist elements $y_1, \ldots, y_n$ in the $\mathbf{Z}$-subalgebra of $S$
generated by $x_1, \ldots, x_N$ such that the map
$R[t_1, \ldots, t_n] \to S$, $t_i \mapsto y_i$ has the property
that $\kappa(\mathfrak p)[t_1\ldots, t_n] \to \overline{S}$
is finite. In particular, $S$ is quasi-finite over $R[t_1, \ldots, t_n]$
at $\mathfrak q$. Hence, by Lemma \ref{lemma-quasi-finite-open}
we may replace $S$ by $S_g$ for some $g\in S$, $g \not \in \mathfrak q$
such that $R[t_1, \ldots, t_n] \to S$ is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-refined-quasi-finite-over-polynomial-algebra}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$
be a prime lying over the prime $\mathfrak p$ of $R$.
Assume
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $\dim_{\mathfrak q}(S/R) = n$, and
\item $\text{trdeg}_{\kappa(\mathfrak p)}\kappa(\mathfrak q) = r$.
\end{enumerate}
Then there exist $f \in R$, $f \not \in \mathfrak p$,
$g \in S$, $g \not\in \mathfrak q$ and a quasi-finite ring map
$$
\varphi : R_f[x_1, \ldots, x_n] \longrightarrow S_g
$$
such that $\varphi^{-1}(\mathfrak qS_g) =
(\mathfrak p, x_{r + 1}, \ldots, x_n)R_f[x_{r + 1}, \ldots, x_n]$
\end{lemma}

\begin{proof}
After replacing $S$ by a principal localization we may assume there
exists a quasi-finite ring map $\varphi : R[t_1, \ldots, t_n] \to S$, see
Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}.
Set $\mathfrak q' = \varphi^{-1}(\mathfrak q)$.
Let $\overline{\mathfrak q}' \subset \kappa(\mathfrak p)[t_1, \ldots, t_n]$
be the prime corresponding to $\mathfrak q'$. By
Lemma \ref{lemma-refined-Noether-normalization}
there exists a finite ring map
$\kappa(\mathfrak p)[x_1, \ldots, x_n] \to
\kappa(\mathfrak p)[t_1, \ldots, t_n]$
such that the inverse image of $\overline{\mathfrak q}'$ is
$(x_{r + 1}, \ldots, x_n)$. Let
$\overline{h}_i \in \kappa(\mathfrak p)[t_1, \ldots, t_n]$
be the image of $x_i$. We can find an element
$f \in R$, $f \not \in \mathfrak p$
and $h_i \in R_f[t_1, \ldots, t_n]$ which map to $\overline{h}_i$
in $\kappa(\mathfrak p)[t_1, \ldots, t_n]$. Then the ring map
$$
R_f[x_1, \ldots, x_n] \longrightarrow R_f[t_1, \ldots, t_n]
$$
becomes finite after tensoring with $\kappa(\mathfrak p)$.
In particular, $R_f[t_1, \ldots, t_n]$ is quasi-finite over
$R_f[x_1, \ldots, x_n]$ at the prime $\mathfrak q'R_f[t_1, \ldots, t_n]$.
Hence, by
Lemma \ref{lemma-quasi-finite-open}
there exists a $g \in R_f[t_1, \ldots, t_n]$,
$g \not \in \mathfrak q'R_f[t_1, \ldots, t_n]$
such that $R_f[x_1, \ldots, x_n] \to R_f[t_1, \ldots, t_n, 1/g]$
is quasi-finite. Thus we see that the composition
$$
R_f[x_1, \ldots, x_n] \longrightarrow
R_f[t_1, \ldots, t_n, 1/g] \longrightarrow S_{\varphi(g)}
$$
is quasi-finite and we win.
\end{proof}

\begin{lemma}
\label{lemma-dimension-inequality-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$.
If $R \to S$ is quasi-finite at $\mathfrak q$, then
$\dim(S_{\mathfrak q}) \leq \dim(R_{\mathfrak p})$.
\end{lemma}

\begin{proof}
If $R_{\mathfrak p}$ is Noetherian
(and hence $S_{\mathfrak q}$ Noetherian since it is essentially of
finite type over $R_{\mathfrak p}$)
then this follows immediately from
Lemma \ref{lemma-dimension-base-fibre-total} and the
definitions. In the general case, let $S'$ be the integral
closure of $R_\mathfrak p$ in $S_\mathfrak p$.
By Zariski's Main Theorem \ref{theorem-main-theorem}
we have $S_{\mathfrak q} = S'_{\mathfrak q'}$ for some
$\mathfrak q' \subset S'$ lying over $\mathfrak q$.
By Lemma \ref{lemma-integral-dim-up} we have
$\dim(S') \leq \dim(R_\mathfrak p)$ and hence a fortiori
$\dim(S_\mathfrak q) = \dim(S'_{\mathfrak q'}) \leq \dim(R_\mathfrak p)$.
\end{proof}

\begin{lemma}
\label{lemma-dimension-quasi-finite-over-polynomial-algebra}
\begin{slogan}
A quasi-finite cover of affine n-space has dimension at most n.
\end{slogan}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Suppose there is a quasi-finite $k$-algebra map
$k[t_1, \ldots, t_n] \subset S$. Then $\dim(S) \leq n$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dim-affine-space} the dimension of
any local ring of $k[t_1, \ldots, t_n]$ is at most $n$.
Thus the result follows from
Lemma \ref{lemma-dimension-inequality-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-bounded-open-upstairs}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists an open neighbourhood $V$ of $\mathfrak q$
in $\Spec(S)$ such that
$\dim_{\mathfrak q'}(S/R) \leq n$ for all $\mathfrak q' \in V$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
we see that we may assume that $S$ is quasi-finite over
a polynomial algebra $R[t_1, \ldots, t_n]$. Considering
the fibres, we reduce to
Lemma \ref{lemma-dimension-quasi-finite-over-polynomial-algebra}.
\end{proof}

\noindent
In other words, the lemma says that the set of points where the
fibre has dimension $\leq n$ is open in $\Spec(S)$.
The next lemma says that formation of this open commutes with
base change.
If the ring map is of finite presentation then this set is
quasi-compact open (see below).

\begin{lemma}
\label{lemma-dimension-fibres-bounded-open-upstairs-base-change}
Let $R \to S$ be a finite type ring map.
Let $R \to R'$ be any ring map.
Set $S' = R' \otimes_R S$ and denote $f : \Spec(S') \to \Spec(S)$
the associated map on spectra.
Let $n \geq 0$.
The inverse image
$f^{-1}(\{\mathfrak q \in \Spec(S) \mid
\dim_{\mathfrak q}(S/R) \leq n\})$
is equal to
$\{\mathfrak q' \in \Spec(S') \mid
\dim_{\mathfrak q'}(S'/R') \leq n\}$.
\end{lemma}

\begin{proof}
The condition is formulated in terms of dimensions
of fibre rings which are of finite type over a field.
Combined with
Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
this yields the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-bounded-quasi-compact-open-upstairs}
Let $R \to S$ be a ring homomorphism of finite presentation.
Let $n \geq 0$. The set
$$
V_n = \{\mathfrak q \in \Spec(S) \mid \dim_{\mathfrak q}(S/R) \leq n\}
$$
is a quasi-compact open subset of $\Spec(S)$.
\end{lemma}

\begin{proof}
It is open by Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}.
Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ be a presentation of
$S$. Let $R_0$ be the $\mathbf{Z}$-subalgebra of $R$ generated by the
coefficients of the polynomials $f_i$.
Let $S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Then $S = R \otimes_{R_0} S_0$. By
Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs-base-change}
$V_n$ is the inverse image of an open $V_{0, n}$ under the quasi-compact
continuous map $\Spec(S) \to \Spec(S_0)$. Since
$S_0$ is Noetherian we see that $V_{0, n}$ is quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-domain-over-valuation-ring-dim-fibres}
Let $R$ be a valuation ring with residue field $k$ and field
of fractions $K$. Let $S$ be a domain containing $R$ such that
$S$ is of finite type over $R$. If $S \otimes_R k$ is not the
zero ring then
$$
\dim(S \otimes_R k) = \dim(S \otimes_R K)
$$
In fact, $\Spec(S \otimes_R k)$ is equidimensional.
\end{lemma}

\begin{proof}
It suffices to show that $\dim_{\mathfrak q}(S/k)$ is equal
to $\dim(S \otimes_R K)$ for every prime $\mathfrak q$ of
$S$ containing $\mathfrak m_RS$. Pick such a prime. By
Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
the inequality $\dim_{\mathfrak q}(S/k) \geq \dim(S \otimes_R K)$
holds. Set $n = \dim_{\mathfrak q}(S/k)$. By
Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
after replacing $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
there exists a quasi-finite ring map
$R[t_1, \ldots, t_n] \to S$. If $\dim(S \otimes_R K) < n$,
then $K[t_1, \ldots, t_n] \to S \otimes_R K$ has a nonzero kernel.
Say $f = \sum a_I t_1^{i_1}\ldots t_n^{i_n}$. After dividing
$f$ by a nonzero coefficient of $f$ with minimal valuation, we may
assume $f\in R[t_1, \ldots, t_n]$ and some $a_I$ does not map
to zero in $k$. Hence the ring map $k[t_1, \ldots, t_n] \to S \otimes_R k$
has a nonzero kernel which implies that $\dim(S \otimes_R k) < n$.
Contradiction.
\end{proof}
























\section{Algebras and modules of finite presentation}
\label{section-finite-presentation}

\noindent
In this section we discuss some standard results where the key
feature is that the assumption involves a finite type or finite
presentation assumption.

\begin{lemma}
\label{lemma-finite-type-descends}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is of finite type if and only if $R' \to S'$
is of finite type.
\end{lemma}

\begin{proof}
It is clear that if $R \to S$ is of finite type then $R' \to S'$
is of finite type. Assume that $R' \to S'$ is of finite type.
Say $y_1, \ldots, y_m$ generate $S'$ over $R'$.
Write $y_j = \sum_i a_{ij} \otimes x_{ji}$ for some
$a_{ij} \in R'$ and $x_{ji} \in S$. Let $A \subset S$
be the $R$-subalgebra generated by the $x_{ij}$.
By flatness we have $A' := R' \otimes_R A \subset S'$, and
by construction $y_j \in A'$. Hence $A' = S'$.
By faithful flatness $A = S$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-descends}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is of finite presentation if and only if $R' \to S'$
is of finite presentation.
\end{lemma}

\begin{proof}
It is clear that if $R \to S$ is of finite presentation then $R' \to S'$
is of finite presentation. Assume that $R' \to S'$ is of finite presentation.
By Lemma \ref{lemma-finite-type-descends} we see
that $R \to S$ is of finite type. Write $S = R[x_1, \ldots, x_n]/I$.
By flatness $S' = R'[x_1, \ldots, x_n]/R'\otimes I$.
Say $g_1, \ldots, g_m$ generate $R'\otimes I$ over $R'[x_1, \ldots, x_n]$.
Write $g_j = \sum_i a_{ij} \otimes f_{ji}$ for some
$a_{ij} \in R'$ and $f_{ji} \in I$. Let $J \subset I$
be the ideal generated by the $f_{ij}$.
By flatness we have $R' \otimes_R J \subset R'\otimes_R I$, and
both are ideals over $R'[x_1, \ldots, x_n]$.
By construction $g_j \in R' \otimes_R J$. Hence
$R' \otimes_R J = R'\otimes_R I$.
By faithful flatness $J = I$.
\end{proof}

\begin{lemma}
\label{lemma-construct-fp-module}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $S \subset R$ be a multiplicative subset.
Set $R' = S^{-1}(R/I) = S^{-1}R/S^{-1}I$.
\begin{enumerate}
\item For any finite $R'$-module $M'$ there exists a
finite $R$-module $M$ such that $S^{-1}(M/IM) \cong M'$.
\item For any finitely presented $R'$-module $M'$ there exists a
finitely presented $R$-module $M$ such that $S^{-1}(M/IM) \cong M'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose a short exact sequence
$0 \to K' \to (R')^{\oplus n} \to M' \to 0$.
Let $K \subset R^{\oplus n}$ be the inverse image of
$K'$ under the map $R^{\oplus n} \to (R')^{\oplus n}$.
Then $M = R^{\oplus n}/K$ works.

\medskip\noindent
Proof of (2).
Choose a presentation $(R')^{\oplus m} \to (R')^{\oplus n} \to M' \to 0$.
Suppose that the first map is given by the matrix
$A' = (a'_{ij})$ and the second map is determined by generators
$x'_i \in M'$, $i = 1, \ldots, n$. As $R' = S^{-1}(R/I)$ we can choose
$s \in S$ and a matrix $A = (a_{ij})$ with coefficients in $R$
such that $a'_{ij} = a_{ij} / s \bmod S^{-1}I$. Let $M$ be the
finitely presented $R$-module with presentation
$R^{\oplus m} \to R^{\oplus n} \to M \to 0$
where the first map is given by the matrix $A$ and the second map is
determined by generators $x_i \in M$, $i = 1, \ldots, n$.
Then the map $M \to M'$, $x_i \mapsto x'_i$ induces an isomorphism
$S^{-1}(M/IM) \cong M'$.
\end{proof}

\begin{lemma}
\label{lemma-construct-fp-module-from-localization}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset.
Let $M$ be an $R$-module.
\begin{enumerate}
\item If $S^{-1}M$ is a finite $S^{-1}R$-module then there
exists a finite $R$-module $M'$ and a map $M' \to M$ which induces an
isomorphism $S^{-1}M' \to S^{-1}M$.
\item If $S^{-1}M$ is a finitely presented $S^{-1}R$-module
then there exists an $R$-module $M'$ of finite presentation
and a map $M' \to M$ which induces an isomorphism
$S^{-1}M' \to S^{-1}M$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $x_1, \ldots, x_n \in M$ be elements which generate
$S^{-1}M$ as an $S^{-1}R$-module. Let $M'$ be the
$R$-submodule of $M$ generated by $x_1, \ldots, x_n$.

\medskip\noindent
Proof of (2). Let $x_1, \ldots, x_n \in M$ be elements which generate
$S^{-1}M$ as an $S^{-1}R$-module. Let
$K = \Ker(R^{\oplus n} \to M)$ where the map is given by
the rule $(a_1, \ldots, a_n) \mapsto \sum a_i x_i$. By
Lemma \ref{lemma-extension}
we see that $S^{-1}K$ is a finite $S^{-1}R$-module.
By (1) we can find a finite submodule $K' \subset K$
with $S^{-1}K' = S^{-1}K$. Take
$M' = \Coker(K' \to R^{\oplus n})$.
\end{proof}

\begin{lemma}
\label{lemma-construct-fp-module-from-stalk}
Let $R$ be a ring.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $M$ be an $R$-module.
\begin{enumerate}
\item If $M_{\mathfrak p}$ is a finite $R_{\mathfrak p}$-module then there
exists a finite $R$-module $M'$ and a map $M' \to M$ which induces an
isomorphism $M'_{\mathfrak p} \to M_{\mathfrak p}$.
\item If $M_{\mathfrak p}$ is a finitely presented $R_{\mathfrak p}$-module
then there exists an $R$-module $M'$ of finite presentation
and a map $M' \to M$ which induces an isomorphism
$M'_{\mathfrak p} \to M_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-construct-fp-module-from-localization}
\end{proof}

\begin{lemma}
\label{lemma-local-isomorphism}
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak q \subset S$
be a prime lying over $\mathfrak p \subset R$. Assume
\begin{enumerate}
\item $S$ is of finite presentation over $R$,
\item $\varphi$ induces an isomorphism $R_\mathfrak p \cong S_\mathfrak q$.
\end{enumerate}
Then there exist $f \in R$, $f \not \in \mathfrak p$ and an
$R_f$-algebra $C$ such that $S_f \cong R_f \times C$ as $R_f$-algebras.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. Let $a_i \in R_\mathfrak p$
be an element mapping to the image of $x_i$ in $S_\mathfrak q$.
Write $a_i = b_i/f$ for some $f \in R$, $f \not \in \mathfrak p$.
After replacing $R$ by $R_f$ and $x_i$ by $x_i - a_i$ we may
assume that $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$ such
that $x_i$ maps to zero in $S_\mathfrak q$. Then if $c_j$ denotes
the constant term of $g_i$ we conclude that $c_i$ maps to zero
in $R_\mathfrak p$. After another replacement of $R$ we may
assume that the constant coefficients $c_j$ of the $g_j$ are zero.
Thus we obtain an $R$-algebra map $S \to R$, $x_i \mapsto 0$ whose
kernel is the ideal $(x_1, \ldots, x_n)$.

\medskip\noindent
Note that $\mathfrak q = \mathfrak pS + (x_1, \ldots, x_n)$.
Write $g_j = \sum a_{ji}x_i + h.o.t.$. Since $S_\mathfrak q = R_\mathfrak p$
we have $\mathfrak p \otimes \kappa(\mathfrak p) =
\mathfrak q \otimes \kappa(\mathfrak q)$. It follows that
$m \times n$ matrix $A = (a_{ij})$ defines a surjective
map $\kappa(\mathfrak p)^{\oplus m} \to \kappa(\mathfrak p)^{\oplus n}$.
Thus after inverting some element of $R$ not in $\mathfrak p$ we may
assume there are $b_{ij} \in R$ such that $\sum b_{ij} g_j = x_i + h.o.t.$.
We conclude that $(x_1, \ldots, x_n) = (x_1, \ldots, x_n)^2$ in $S$.
It follows from Lemma \ref{lemma-ideal-is-squared-union-connected}
that $(x_1, \ldots, x_n)$ is generated by an idempotent $e$.
Setting $C = eS$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-isomorphic-local-rings}
Let $R$ be a ring.
Let $S$, $S'$ be of finite presentation over $R$.
Let $\mathfrak q \subset S$ and $\mathfrak q' \subset S'$
be primes. If $S_{\mathfrak q} \cong S_{\mathfrak q'}$ as
$R$-algebras, then there exist $g \in S$, $g \not \in \mathfrak q$
and $g' \in S'$, $g' \not \in \mathfrak q'$ such that
$S_g \cong S'_{g'}$ as $R$-algebras.
\end{lemma}

\begin{proof}
Let $\psi : S_{\mathfrak q} \to S_{\mathfrak q'}$ be the isomorphism
of the hypothesis of the lemma.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_r)$ and
$S' = R[y_1, \ldots, y_m]/J$.
For each $i = 1, \ldots, n$ choose a fraction
$h_i/g_i$ with $h_i, g_i \in R[y_1, \ldots, y_m]$
and $g_i \bmod J$ not in $\mathfrak q'$ which represents
the image of $x_i$ under $\psi$. After replacing
$S'$ by $S'_{g_1 \ldots g_n}$ and
$R[y_1, \ldots, y_m, y_{m + 1}]$ (mapping $y_{m + 1}$ to $1/(g_1\ldots g_n)$)
we may assume that $\psi(x_i)$ is the image of some
$h_i \in R[y_1, \ldots, y_m]$. Consider the elements
$f_j(h_1, \ldots, h_n) \in R[y_1, \ldots, y_m]$.
Since $\psi$ kills each $f_j$ we see that
there exists a $g \in R[y_1, \ldots, y_m]$, $g \bmod J \not \in \mathfrak q'$
such that $g f_j(h_1, \ldots, h_n) \in J$ for each $j = 1, \ldots, r$.
After replacing $S'$ by $S'_g$ and
$R[y_1, \ldots, y_m, y_{m + 1}]$ as before we may assume that
$f_j(h_1, \ldots, h_n) \in J$. Thus we obtain a ring map
$S \to S'$, $x_i \mapsto h_i$ which induces $\psi$ on local rings.
By Lemma \ref{lemma-compose-finite-type}
the map $S' \to S$ is of finite presentation.
By Lemma \ref{lemma-local-isomorphism}
we may assume that $S = S' \times C$. Thus localizing $S$ at the
idempotent corresponding to the factor $C$ we obtain the result.
\end{proof}

\begin{lemma}
\label{lemma-surjective-mod-locally-nilpotent}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Let $S \to S'$ be an $R$-algebra map such that $S \to S'/IS'$ is surjective
and such that $S'$ is of finite type over $R$. Then $S \to S'$ is surjective.
\end{lemma}

\begin{proof}
Write $S' = R[x_1, \ldots, x_m]/K$ for some ideal $K$. By assumption there
exist $g_j = x_j + \sum \delta_{j, J} x^J \in R[x_1, \ldots, x_n]$ with
$\delta_{j, J} \in I$ and with $g_j \bmod K \in \Im(S \to S')$.
Hence it suffices to show that $g_1, \ldots, g_m$ generate
$R[x_1, \ldots, x_n]$. Let $R_0 \subset R$ be a finitely generated
$\mathbf{Z}$-subalgebra of $R$ containing at least the $\delta_{j, J}$.
Then $R_0 \cap I$ is a nilpotent ideal (by
Lemma \ref{lemma-Noetherian-power}). It follows that
$R_0[x_1, \ldots, x_n]$ is generated by $g_1, \ldots, g_m$ (because
$x_j \mapsto g_j$ defines an automorphism of $R_0[x_1, \ldots, x_m]$;
details omitted). Since $R$ is the union of the subrings $R_0$ we win.
\end{proof}

\begin{lemma}
\label{lemma-isomorphism-modulo-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $S \to S'$
be an $R$-algebra map. Let $IS \subset \mathfrak q \subset S$
be a prime
ideal. Assume that
\begin{enumerate}
\item $S \to S'$ is surjective,
\item $S_\mathfrak q/IS_\mathfrak q \to S'_\mathfrak q/IS'_\mathfrak q$
is an isomorphism,
\item $S$ is of finite type over $R$,
\item $S'$ of finite presentation over $R$, and
\item $S'_\mathfrak q$ is flat over $R$.
\end{enumerate}
Then $S_g \to S'_g$ is an isomorphism for some
$g \in S$, $g \not \in \mathfrak q$.
\end{lemma}

\begin{proof}
Let $J = \Ker(S \to S')$. By
Lemma \ref{lemma-compose-finite-type}
$J$ is a finitely generated ideal. Since $S'_\mathfrak q$ is flat
over $R$ we see that
$J_\mathfrak q/IJ_\mathfrak q \subset S_\mathfrak q/IS_{\mathfrak q}$
(apply Lemma \ref{lemma-flat-tor-zero} to $0 \to J \to S \to S' \to 0$).
By assumption (2) we see that $J_\mathfrak q/IJ_\mathfrak q$ is zero.
By Nakayama's lemma (Lemma \ref{lemma-NAK}) we see that
there exists a $g \in S$, $g \not \in \mathfrak q$ such
that $J_g = 0$. Hence $S_g \cong S'_g$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-isomorphism-modulo-locally-nilpotent}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $S \to S'$
be an $R$-algebra map. Assume that
\begin{enumerate}
\item $I$ is locally nilpotent,
\item $S/IS \to S'/IS'$ is an isomorphism,
\item $S$ is of finite type over $R$,
\item $S'$ of finite presentation over $R$, and
\item $S'$ is flat over $R$.
\end{enumerate}
Then $S \to S'$ is an isomorphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-surjective-mod-locally-nilpotent} the map
$S \to S'$ is surjective. As $I$ is locally nilpotent, so are the
ideals $IS$ and $IS'$ (Lemma \ref{lemma-locally-nilpotent}). Hence
every prime ideal $\mathfrak q$ of $S$ contains $IS$ and (trivially)
$S_\mathfrak q/IS_\mathfrak q \cong S'_\mathfrak q/IS'_\mathfrak q$.
Thus Lemma \ref{lemma-isomorphism-modulo-ideal} applies
and we see that $S_\mathfrak q \to S'_\mathfrak q$ is an
isomorphism for every prime $\mathfrak q \subset S$.
It follows that $S \to S'$ is injective for example by
Lemma \ref{lemma-characterize-zero-local}.
\end{proof}





\section{Colimits and maps of finite presentation}
\label{section-colimits-flat}

\noindent
In this section we prove some preliminary lemmas
which will eventually help us prove result using
absolute Noetherian reduction.
In Categories, Section \ref{categories-section-directed-colimits}
we discuss filtered colimits in general.
Here is an example of this very general notion.

\begin{lemma}
\label{lemma-ring-colimit-fp-category}
Let $R \to A$ be a ring map. Consider the category $\mathcal{I}$ of all
diagrams of $R$-algebra maps $A' \to A$ with $A'$ finitely presented over
$R$. Then $\mathcal{I}$ is filtered, and the colimit of the $A'$ over
$\mathcal{I}$ is isomorphic to $A$.
\end{lemma}

\begin{proof}
The category\footnote{To avoid set theoretical difficulties we
consider only $A' \to A$ such that the underlying set of $A'$
is a subset of a fixed set of sufficiently large cardinality,
for example the power set of $A$.}
$\mathcal{I}$ is nonempty as $R \to A$ is an object of it.
Consider a pair of objects $A' \to A$, $A'' \to A$ of $\mathcal{I}$.
Then $A' \otimes_R A'' \to A$ is in
$\mathcal{I}$ (use Lemmas \ref{lemma-compose-finite-type} and
\ref{lemma-base-change-finiteness}). The ring maps
$A' \to A' \otimes_R A''$ and $A'' \to A' \otimes_R A''$
define arrows in $\mathcal{I}$ thereby proving the second defining
property of a filtered category, see
Categories, Definition \ref{categories-definition-directed}.
Finally, suppose that we have two morphisms $\sigma, \tau : A' \to A''$
in $\mathcal{I}$. If $x_1, \ldots, x_r \in A'$ are generators of
$A'$ as an $R$-algebra, then we can consider
$A''' = A''/(\sigma(x_i) - \tau(x_i))$.
This is a finitely presented $R$-algebra and the given $R$-algebra map
$A'' \to A$ factors through the surjection $\nu : A'' \to A'''$.
Thus $\nu$ is a morphism in $\mathcal{I}$ equalizing $\sigma$ and $\tau$
as desired.

\medskip\noindent
The fact that our index category is cofiltered means that we may
compute the value of $B = \colim_{A' \to A} A'$ in the category of sets
(some details omitted; compare with the discussion in
Categories, Section \ref{categories-section-directed-colimits} especially
Categories, Lemma \ref{categories-lemma-colimits-abelian-as-sets}).
To see that $B \to A$ is surjective, for
every $a \in A$ we can use $R[x] \to A$, $x \mapsto a$ to see that
$a$ is in the image of $B \to A$. Conversely, if $b \in B$ is mapped
to zero in $A$, then we can find $A' \to A$ in $\mathcal{I}$ and
$a' \in A'$ which maps to $b$. Then $A'/(a') \to A$ is in $\mathcal{I}$
as well and the map $A' \to B$ factors as $A' \to A'/(a') \to B$
which shows that $b = 0$ as desired.
\end{proof}

\noindent
Often it is easier to think about colimits over preordered sets.
Let $(\Lambda, \geq)$ a preordered set.
A system of rings over $\Lambda$ is given by
a ring $R_\lambda$ for every $\lambda \in \Lambda$,
and a morphism $R_\lambda \to R_\mu$ whenever $\lambda \leq \mu$.
These morphisms have to satisfy the rule that
$R_\lambda \to R_\mu \to R_\nu$ is equal to the map
$R_\lambda \to R_\nu$ for all $\lambda \leq \mu \leq \nu$.
See Categories, Section \ref{categories-section-posets-limits}.
We will often assume that $(I, \leq)$ is {\it directed},
which means that $\Lambda$ is nonempty and
given $\lambda, \mu \in \Lambda$
there exists a $\nu \in \Lambda$ with $\lambda \leq \nu$ and $\mu \leq \nu$.
Recall that the colimit $\colim_\lambda R_\lambda$
is sometimes called a ``direct limit'' in this case
(but we will not use this terminology).

\medskip\noindent
Note that Categories, Lemma \ref{categories-lemma-directed-category-system}
tells us that colimits over filtered index categories are the same
thing as colimits over directed sets.

\begin{lemma}
\label{lemma-ring-colimit-fp}
Let $R \to A$ be a ring map. There exists a directed system $A_\lambda$ of
$R$-algebras of finite presentation such that $A = \colim_\lambda A_\lambda$.
If $A$ is of finite type over $R$ we may arrange it so that all the
transition maps in the system of $A_\lambda$ are surjective.
\end{lemma}

\begin{proof}
The first proof is that this follows from
Lemma \ref{lemma-ring-colimit-fp-category} and
Categories, Lemma \ref{categories-lemma-directed-category-system}.

\medskip\noindent
Second proof.
Compare with the proof of Lemma \ref{lemma-module-colimit-fp}.
Consider any finite subset $S \subset A$, and any finite
collection of polynomial relations $E$ among the elements of $S$.
So each $s \in S$ corresponds to $x_s \in A$ and
each $e \in E$ consists of a polynomial
$f_e \in R[X_s; s\in S]$ such that $f_e(x_s) = 0$.
Let $A_{S, E} = R[X_s; s\in S]/(f_e; e\in E)$
which is a finitely presented $R$-algebra.
There are canonical maps $A_{S, E} \to A$.
If $S \subset S'$ and if the elements of
$E$ correspond, via the map $R[X_s; s \in S] \to R[X_s; s\in S']$,
to a subset of $E'$, then there is an obvious map
$A_{S, E} \to A_{S', E'}$ commuting with the
maps to $A$. Thus, setting $\Lambda$ equal the set of pairs
$(S, E)$ with ordering by inclusion as above, we get a
directed partially ordered set.
It is clear that the colimit of this directed system is $A$.

\medskip\noindent
For the last statement, suppose $A = R[x_1, \ldots, x_n]/I$.
In this case, consider the subset $\Lambda' \subset \Lambda$
consisting of those systems $(S, E)$ above
with $S = \{x_1, \ldots, x_n\}$. It is easy to see that
still $A = \colim_{\lambda' \in \Lambda'} A_{\lambda'}$.
Moreover, the transition maps are clearly surjective.
\end{proof}

\noindent
It turns out that we can characterize ring maps of finite
presentation as follows. This in some sense says that the
algebras of finite presentation are the ``compact'' objects
in the category of $R$-algebras.

\begin{lemma}
\label{lemma-characterize-finite-presentation}
Let $\varphi : R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $\varphi$ is of finite presentation,
\item for every directed system $A_\lambda$ of $R$-algebras
the map
$$
\colim_\lambda \Hom_R(S, A_\lambda) \longrightarrow
\Hom_R(S, \colim_\lambda A_\lambda)
$$
is bijective, and
\item for every directed system $A_\lambda$ of $R$-algebras
the map
$$
\colim_\lambda \Hom_R(S, A_\lambda) \longrightarrow
\Hom_R(S, \colim_\lambda A_\lambda)
$$
is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and write $S = R[x_1, \ldots, x_n] / (f_1, \ldots, f_m)$.
Let $A = \colim A_\lambda$. Observe that an $R$-algebra homomorphism
$S \to A$ or $S \to A_\lambda$ is determined by the images of
$x_1, \ldots, x_n$. Hence it is clear that
$\colim_\lambda \Hom_R(S, A_\lambda) \to \Hom_R(S, A)$
is injective. To see that it is surjective, let $\chi : S \to A$
be an $R$-algebra homomorphism. Then each
$x_i$ maps to some element in the image of some $A_{\lambda_i}$.
We may pick $\mu \geq \lambda_i$, $i = 1, \ldots, n$ and
assume $\chi(x_i)$ is the image of $y_i \in A_\mu$ for
$i = 1, \ldots, n$. Consider $z_j = f_j(y_1, \ldots, y_n) \in A_\mu$.
Since $\chi$ is a homomorphism the image of $z_j$ in
$A = \colim_\lambda A_\lambda$ is zero. Hence there exists a
$\mu_j \geq \mu$ such that $z_j$ maps to zero in $A_{\mu_j}$.
Pick $\nu \geq \mu_j$, $j = 1, \ldots, m$. Then the
images of $z_1, \ldots, z_m$ are zero in $A_\nu$. This
exactly means that the $y_i$ map to elements
$y'_i \in A_\nu$ which satisfy the relations $f_j(y'_1, \ldots, y'_n) = 0$.
Thus we obtain a ring map $S \to A_\nu$. This shows that
(1) implies (2).

\medskip\noindent
It is clear that (2) implies (3). Assume (3).
By Lemma \ref{lemma-ring-colimit-fp} we may write
$S = \colim_\lambda S_\lambda$ with $S_\lambda$
of finite presentation over $R$. Then the identity map
factors as
$$
S \to S_\lambda \to S
$$
for some $\lambda$. This implies that $S$
is finitely presented over $S_\lambda$ by
Lemma \ref{lemma-compose-finite-type} part (4)
applied to $S \to S_\lambda \to S$. Applying part (2) of the same
lemma to $R \to S_\lambda \to S$ we conclude that $S$ is of finite
presentation over $R$.
\end{proof}

\noindent
Using the basic material above we can give a criterion of when
an algebra $A$ is a filtered colimit of given type of algebra
as follows.

\begin{lemma}
\label{lemma-when-colimit}
Let $R \to \Lambda$ be a ring map. Let $\mathcal{E}$ be a set of $R$-algebras
such that each $A \in \mathcal{E}$ is of finite presentation over $R$.
Then the following two statements are equivalent
\begin{enumerate}
\item $\Lambda$ is a filtered colimit of elements of $\mathcal{E}$, and
\item for any $R$ algebra map $A \to \Lambda$ with $A$ of finite
presentation over $R$ we can find a factorization $A \to B \to \Lambda$
with $B \in \mathcal{E}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose that $\mathcal{I} \to \mathcal{E}$, $i \mapsto A_i$
is a filtered diagram such that $\Lambda = \colim_i A_i$.
Let $A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation over $R$. Then we get a factorization $A \to A_i \to \Lambda$
by applying Lemma \ref{lemma-characterize-finite-presentation}.
Thus (1) implies (2).

\medskip\noindent
Consider the category
$\mathcal{I}$ of Lemma \ref{lemma-ring-colimit-fp-category}.
By Categories, Lemma \ref{categories-lemma-cofinal-in-filtered}
the full subcategory $\mathcal{J}$ consisting of those
$A \to \Lambda$ with $A \in \mathcal{E}$ is cofinal in $\mathcal{I}$ and
is a filtered category. Then $\Lambda$ is also the colimit
over $\mathcal{J}$ by Categories, Lemma \ref{categories-lemma-cofinal}.
\end{proof}

\noindent
But more is true. Namely, given $R = \colim_\lambda R_\lambda$
we see that the category of finitely presented $R$-modules is equivalent
to the limit of the category of finitely presented $R_\lambda$-modules.
Similarly for the categories of finitely presented $R$-algebras.

\begin{lemma}
\label{lemma-module-map-property-in-colimit}
Let $A$ be a ring and let $M, N$ be $A$-modules.
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of $A$-algebras.
\begin{enumerate}
\item If $M$ is a finite $A$-module, and $u, u' : M \to N$ are
$A$-module maps such that
$u \otimes 1 = u' \otimes 1 : M \otimes_A R \to N \otimes_A R$
then for some $i$ we have
$u \otimes 1 = u' \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$.
\item If $N$ is a finite $A$-module and $u : M \to N$ is an $A$-module
map such that $u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is surjective,
then for some $i$ the map $u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$
is surjective.
\item If $N$ is a finitely presented $A$-module, and
$v : N \otimes_A R \to M \otimes_A R$ is an $R$-module
map, then there exists an $i$ and an $R_i$-module map
$v_i : N \otimes_A R_i \to M \otimes_A R_i$ such that $v = v_i \otimes 1$.
\item If $M$ is a finite $A$-module, $N$ is a finitely presented $A$-module,
and $u : M \to N$ is an $R$-module map such that
$u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is an isomorphism, then
for some $i$ the map $u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove (1) assume $u$ is as in (1) and
let $x_1, \ldots, x_m \in M$ be generators. Since
$N \otimes_A R = \colim_i N \otimes_A R_i$
we may pick an $i \in I$ such that $u(x_j) \otimes 1 = u'(x_j) \otimes 1$
in $M \otimes_A R_i$, $j = 1, \ldots, m$.
For such an $i$ we have
$u \otimes 1 = u' \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$.

\medskip\noindent
To prove (2) assume $u \otimes 1$ surjective and
let $y_1, \ldots, y_m \in N$ be generators. Since
$N \otimes_A R = \colim_i N \otimes_A R_i$
we may pick an $i \in I$ and $z_j \in M \otimes_A R_i$, $j = 1, \ldots, m$
whose images in $N \otimes_A R$ equal $y_j \otimes 1$.
For such an $i$ the map $u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$
is surjective.

\medskip\noindent
To prove (3) let $y_1, \ldots, y_m \in N$ be generators. Let
$K = \Ker(A^{\oplus m} \to N)$ where the map is given by
the rule $(a_1, \ldots, a_m) \mapsto \sum a_j x_j$. Let $k_1, \ldots, k_t$
be generators for $K$. Say $k_s = (k_{s1}, \ldots, k_{sm})$.
Since $M \otimes_A R = \colim_i M \otimes_A R_i$
we may pick an $i \in I$ and $z_j \in M \otimes_A R_i$, $j = 1, \ldots, m$
whose images in $M \otimes_A R$ equal $v(y_j \otimes 1)$.
We want to use the $z_j$ to define the map
$v_i : N \otimes_A R_i \to M \otimes_A R_i$.
Since $K \otimes_A R_i \to R_i^{\oplus m} \to N \otimes_A R_i \to 0$
is a presentation, it suffices to check that $\xi_s = \sum_j k_{sj}z_j$ is
zero in $M \otimes_A R_i$ for each $s = 1, \ldots, t$. This may not
be the case, but since the image of $\xi_s$ in $M \otimes_A R$ is zero
we see that it will be the case after increasing $i$ a bit.

\medskip\noindent
To prove (4) assume $u \otimes 1$ is an isomorphism, that
$M$ is finite, and that $N$ is finitely presented.
Let $v : N \otimes_A R \to M \otimes_A R$ be an inverse to
$u \otimes 1$. Apply part (3) to get a map
$v_i : N \otimes_A R_i \to M \otimes_A R_i$ for some $i$.
Apply part (1) to see that, after increasing $i$ we have
$v_i \circ (u \otimes 1) = \text{id}_{M \otimes_R R_i}$ and
$(u \otimes 1) \circ v_i = \text{id}_{N \otimes_R R_i}$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-category-fp-modules}
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of rings. Then the category of finitely presented $R$-modules is
the colimit of the categories of finitely presented $R_\lambda$-modules.
More precisely
\begin{enumerate}
\item Given a finitely presented $R$-module $M$ there exists a
$\lambda \in \Lambda$ and a finitely presented $R_\lambda$-module
$M_\lambda$ such that $M \cong M_\lambda \otimes_{R_\lambda} R$.
\item Given a $\lambda \in \Lambda$, finitely presented
$R_\lambda$-modules $M_\lambda, N_\lambda$, and an $R$-module map
$\varphi : M_\lambda \otimes_{R_\lambda} R \to N_\lambda \otimes_{R_\lambda} R$,
then there exists a $\mu \geq \lambda$ and an $R_\mu$-module map
$\varphi_\mu : M_\lambda \otimes_{R_\lambda} R_\mu \to
N_\lambda \otimes_{R_\lambda} R_\mu$
such that $\varphi = \varphi_\mu \otimes 1_R$.
\item Given a $\lambda \in \Lambda$, finitely presented
$R_\lambda$-modules $M_\lambda, N_\lambda$, and $R$-module maps
$\varphi_\lambda, \psi_\lambda : M_\lambda \to N_\lambda$
such that $\varphi \otimes 1_R = \psi \otimes 1_R$, then
$\varphi \otimes 1_{R_\mu} = \psi \otimes 1_{R_\mu}$ for some
$\mu \geq \lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove (1) choose a presentation
$R^{\oplus m} \to R^{\oplus n} \to M \to 0$.
Suppose that the first map is given by the matrix $A = (a_{ij})$.
We can choose a $\lambda \in \Lambda$ and a matrix
$A_\lambda = (a_{\lambda, ij})$ with coefficients in $R_\lambda$
which maps to $A$ in $R$.
Then we simply let $M_\lambda$ be the $R_\lambda$-module with presentation
$R_\lambda^{\oplus m} \to R_\lambda^{\oplus n} \to M_\lambda \to 0$
where the first arrow is given by $A_\lambda$.

\medskip\noindent
Parts (2) and (3) follow from
Lemma \ref{lemma-module-map-property-in-colimit}.
\end{proof}

\begin{lemma}
\label{lemma-algebra-map-property-in-colimit}
Let $A$ be a ring and let $B, C$ be $A$-algebras.
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of $A$-algebras.
\begin{enumerate}
\item If $B$ is a finite type $A$-algebra, and $u, u' : B \to C$ are
$A$-algebra maps such that
$u \otimes 1 = u' \otimes 1 : B \otimes_A R \to C \otimes_A R$
then for some $i$ we have
$u \otimes 1 = u' \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$.
\item If $C$ is a finite type $A$-algebra and $u : B \to C$ is an
$A$-algebra map such that
$u \otimes 1 : B \otimes_A R \to C \otimes_A R$ is surjective, then
for some $i$ the map $u \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$
is surjective.
\item If $C$ is of finite presentation over $A$ and
$v : C \otimes_A R \to B \otimes_A R$ is an $R$-algebra map, then there
exists an $i$ and an $R_i$-algebra map
$v_i : C \otimes_A R_i \to B \otimes_A R_i$ such that
$v = v_i \otimes 1$.
\item If $B$ is a finite type $A$-algebra, $C$ is a finitely presented
$A$-algebra, and
$u \otimes 1 : B \otimes_A R \to C \otimes_A R$ is an isomorphism, then
for some $i$ the map $u \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove (1) assume $u$ is as in (1) and
let $x_1, \ldots, x_m \in B$ be generators. Since
$B \otimes_A R = \colim_i B \otimes_A R_i$
we may pick an $i \in I$ such that $u(x_j) \otimes 1 = u'(x_j) \otimes 1$
in $B \otimes_A R_i$, $j = 1, \ldots, m$.
For such an $i$ we have
$u \otimes 1 = u' \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$.

\medskip\noindent
To prove (2) assume $u \otimes 1$ surjective and
let $y_1, \ldots, y_m \in C$ be generators. Since
$B \otimes_A R = \colim_i B \otimes_A R_i$
we may pick an $i \in I$ and $z_j \in B \otimes_A R_i$, $j = 1, \ldots, m$
whose images in $C \otimes_A R$ equal $y_j \otimes 1$.
For such an $i$ the map $u \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$
is surjective.

\medskip\noindent
To prove (3) let $c_1, \ldots, c_m \in C$ be generators. Let
$K = \Ker(A[x_1, \ldots, x_m] \to N)$ where the map is given by
the rule $x_j \mapsto \sum c_j$. Let $f_1, \ldots, f_t$
be generators for $K$ as an ideal in $A[x_1, \ldots, x_m]$.
We think of $f_j = f_j(x_1, \ldots, x_m)$ as a polynomial.
Since $B \otimes_A R = \colim_i B \otimes_A R_i$
we may pick an $i \in I$ and $z_j \in B \otimes_A R_i$, $j = 1, \ldots, m$
whose images in $B \otimes_A R$ equal $v(c_j \otimes 1)$.
We want to use the $z_j$ to define a map
$v_i : C \otimes_A R_i \to B \otimes_A R_i$.
Since $K \otimes_A R_i \to R_i[x_1, \ldots, x_m] \to C \otimes_A R_i \to 0$
is a presentation, it suffices to check that
$\xi_s = f_j(z_1, \ldots, z_m)$ is
zero in $B \otimes_A R_i$ for each $s = 1, \ldots, t$. This may not
be the case, but since the image of $\xi_s$ in $B \otimes_A R$ is zero
we see that it will be the case after increasing $i$ a bit.

\medskip\noindent
To prove (4) assume $u \otimes 1$ is an isomorphism, that
$B$ is a finite type $A$-algebra, and that $C$ is a finitely presented
$A$-algebra. Let $v : B \otimes_A R \to C \otimes_A R$ be an inverse to
$u \otimes 1$. Let $v_i : C \otimes_A R_i \to B \otimes_A R_i$ be as
in part (3). Apply part (1) to see that, after increasing $i$ we have
$v_i \circ (u \otimes 1) = \text{id}_{B \otimes_R R_i}$ and
$(u \otimes 1) \circ v_i = \text{id}_{C \otimes_R R_i}$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-category-fp-algebras}
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of rings. Then the category of finitely presented $R$-algebras is
the colimit of the categories of finitely presented $R_\lambda$-algebras.
More precisely
\begin{enumerate}
\item Given a finitely presented $R$-algebra $A$ there exists a
$\lambda \in \Lambda$ and a finitely presented $R_\lambda$-algebra
$A_\lambda$ such that $A \cong A_\lambda \otimes_{R_\lambda} R$.
\item Given a $\lambda \in \Lambda$, finitely presented
$R_\lambda$-algebras $A_\lambda, B_\lambda$, and an $R$-algebra map
$\varphi : A_\lambda \otimes_{R_\lambda} R \to B_\lambda \otimes_{R_\lambda} R$,
then there exists a $\mu \geq \lambda$ and an $R_\mu$-algebra map
$\varphi_\mu : A_\lambda \otimes_{R_\lambda} R_\mu \to
B_\lambda \otimes_{R_\lambda} R_\mu$
such that $\varphi = \varphi_\mu \otimes 1_R$.
\item Given a $\lambda \in \Lambda$, finitely presented
$R_\lambda$-algebras $A_\lambda, B_\lambda$, and $R$-algebra maps
$\varphi_\lambda, \psi_\lambda : A_\lambda \to B_\lambda$
such that $\varphi \otimes 1_R = \psi \otimes 1_R$, then
$\varphi \otimes 1_{R_\mu} = \psi \otimes 1_{R_\mu}$ for some
$\mu \geq \lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove (1) choose a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
We can choose a $\lambda \in \Lambda$ and elements
$f_{\lambda, j} \in R_\lambda[x_1, \ldots, x_n]$ mapping to
$f_j \in R[x_1, \ldots, x_n]$.
Then we simply let
$A_\lambda =
R_\lambda[x_1, \ldots, x_n]/(f_{\lambda, 1}, \ldots, f_{\lambda, m})$.

\medskip\noindent
Parts (3) and (4) follow from
Lemma \ref{lemma-algebra-map-property-in-colimit}.
\end{proof}

\begin{lemma}
\label{lemma-limit-no-condition-local}
Suppose $R \to S$ is a local homomorphism of local rings.
There exists a directed set $(\Lambda, \leq)$, and
a system of local homomorphisms $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $\varphi : R  \to S$ the ring map.
Let $\mathfrak m \subset R$ be the maximal ideal
of $R$ and let $\mathfrak n \subset S$ be the maximal
ideal of $S$. Let
$$
\Lambda = \{
(A, B)
\mid
A \subset R, B \subset S, \# A < \infty, \# B < \infty, \varphi(A) \subset B
\}.
$$
As partial ordering we take the inclusion relation. For each
$\lambda = (A, B) \in \Lambda$ we let $R'_\lambda$ be
the sub $\mathbf{Z}$-algebra generated by
$a \in A$, and we let $S'_\lambda$ be the sub
$\mathbf{Z}$-algebra generated by $b$, $b \in B$.
Let $R_\lambda$ be the localization of $R'_\lambda$
at the prime ideal $R'_\lambda \cap \mathfrak m$ and let
$S_\lambda$ be the localization of $S'_\lambda$ at
the prime ideal $S'_\lambda \cap \mathfrak n$.
In a picture
$$
\xymatrix{
B \ar[r] &
S'_\lambda \ar[r] &
S_\lambda \ar[r] &
S \\
A \ar[r] \ar[u] &
R'_\lambda \ar[r] \ar[u] &
R_\lambda \ar[r] \ar[u] &
R \ar[u]
}.
$$
The transition maps are clear. We leave the proofs of the other
assertions to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-essentially-finite-type}
Suppose $R \to S$ is a local homomorphism of local rings.
Assume that $S$ is essentially of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local homomorphisms $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $\varphi : R  \to S$ the ring map.
Let $\mathfrak m \subset R$ be the maximal ideal
of $R$ and let $\mathfrak n \subset S$ be the maximal
ideal of $S$. Let $x_1, \ldots, x_n \in S$ be elements such that
$S$ is a localization of the sub $R$-algebra of $S$
generated by $x_1, \ldots, x_n$. In other words, $S$
is a quotient of a localization of the polynomial ring
$R[x_1, \ldots, x_n]$.

\medskip\noindent
Let $\Lambda = \{ A \subset R \mid \# A < \infty\}$
be the set of finite subsets of $R$.
As partial ordering we take the inclusion relation. For each
$\lambda = A \in \Lambda$ we let $R'_\lambda$ be
the sub $\mathbf{Z}$-algebra generated by
$a \in A$, and we let $S'_\lambda$ be the sub
$\mathbf{Z}$-algebra generated by $\varphi(a)$, $a \in A$
and the elements $x_1, \ldots, x_n$. Let $R_\lambda$ be
the localization of $R'_\lambda$ at the prime ideal
$R'_\lambda \cap \mathfrak m$ and let
$S_\lambda$ be the localization of $S'_\lambda$ at
the prime ideal $S'_\lambda \cap \mathfrak n$.
In a picture
$$
\xymatrix{
\varphi(A) \amalg \{x_i\} \ar[r] &
S'_\lambda \ar[r] &
S_\lambda \ar[r] &
S \\
A \ar[r] \ar[u] &
R'_\lambda \ar[r] \ar[u] &
R_\lambda \ar[r] \ar[u] &
R \ar[u]
}
$$
It is clear that if $A \subset B$ corresponds to
$\lambda \leq \mu$ in $\Lambda$, then there are
canonical maps $R_\lambda \to R_\mu$, and $S_\lambda \to S_\mu$
and we obtain a system over the directed set $\Lambda$.

\medskip\noindent
The assertion that $R = \colim R_\lambda$ is clear
because all the maps $R_\lambda \to R$ are injective and
any element of $R$ eventually is in the image. The same
argument works for $S = \colim S_\lambda$.
Assertions (2), (3) are true by construction.
The final assertion holds because clearly
the maps $S'_\lambda \otimes_{R'_\lambda} R'_\mu
\to S'_\mu$ are surjective.
\end{proof}

\begin{lemma}
\label{lemma-limit-essentially-finite-presentation}
Suppose $R \to S$ is a local homomorphism of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local homomorphism $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
By assumption we may choose an isomorphism
$\Phi : (R[x_1, \ldots, x_n]/I)_{\mathfrak q} \to S$
where $I \subset R[x_1, \ldots, x_n]$ is a finitely generated ideal,
and $\mathfrak q \subset R[x_1, \ldots, x_n]/I$ is a prime.
(Note that $R \cap \mathfrak q$
is equal to the maximal ideal $\mathfrak m$ of $R$.)
We also choose generators $f_1, \ldots, f_m \in I$ for the ideal $I$.
Write $R$ in any way as a colimit $R = \colim R_\lambda$
over a directed set $(\Lambda, \leq )$, with each $R_\lambda$
local and essentially of finite type over $\mathbf{Z}$.
There exists some $\lambda_0 \in \Lambda$ such that $f_j$ is the image
of some $f_{j, \lambda_0} \in R_{\lambda_0}[x_1, \ldots, x_n]$.
For all $\lambda \geq \lambda_0$ denote
$f_{j, \lambda} \in R_{\lambda}[x_1, \ldots, x_n]$ the image
of $f_{j, \lambda_0}$. Thus we obtain a system of ring maps
$$
R_\lambda[x_1, \ldots, x_n]/(f_{1, \lambda}, \ldots, f_{n, \lambda})
\to
R[x_1, \ldots, x_n]/(f_1, \ldots, f_n) \to S
$$
Set $\mathfrak q_\lambda$ the inverse image of $\mathfrak q$.
Set $S_\lambda = (R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{n, \lambda}))_{\mathfrak q_\lambda}$.
We leave it to the reader to see that this works.
\end{proof}

\begin{remark}
\label{remark-suitable-systems-limits}
Suppose that $R \to S$ is a local homomorphism
of local rings, which is essentially of finite presentation.
Take any system $(\Lambda, \leq)$, $R_\lambda \to S_\lambda$
with the properties listed in
Lemma \ref{lemma-limit-essentially-finite-type}.
What may happen is that this is the ``wrong'' system, namely,
it may happen that property (4) of
Lemma \ref{lemma-limit-essentially-finite-presentation} is not
satisfied. Here is an example. Let $k$ be a field. Consider the ring
$$
R = k[[z, y_1, y_2, \ldots]]/(y_i^2 - zy_{i + 1}).
$$
Set $S = R/zR$. As system take $\Lambda = \mathbf{N}$ and
$R_n = k[[z, y_1, \ldots, y_n]]/(\{y_i^2 - zy_{i + 1}\}_{i \leq n-1})$
and $S_n = R_n/(z, y_n^2)$. All the maps
$S_n \otimes_{R_n} R_{n + 1} \to S_{n + 1}$
are not localizations (i.e., isomorphisms in this case)
since $1 \otimes y_{n + 1}^2$ maps to zero.
If we take instead $S_n' = R_n/zR_n$ then the
maps $S'_n \otimes_{R_n} R_{n + 1} \to S'_{n + 1}$ are
isomorphisms. The moral of this remark is that we do have to be
a little careful in choosing the systems.
\end{remark}

\begin{lemma}
\label{lemma-limit-module-essentially-finite-presentation}
Suppose $R \to S$ is a local homomorphism of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local homomorphisms $R_\lambda \to S_\lambda$
of local rings together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to M_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-limit-essentially-finite-presentation}
we may first write $R = \colim R_\lambda$ as a directed colimit
of local $\mathbf{Z}$-algebras which are essentially of finite type.
Next, we may assume that for some $\lambda_1 \in \Lambda$ there
exist $f_{j, \lambda_1} \in R_{\lambda_1}[x_1, \ldots, x_n]$
such that
$$
S =
\colim_{\lambda \geq \lambda_1} S_\lambda, \text{ with }
S_\lambda =
(R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{m, \lambda}))_{\mathfrak q_\lambda}
$$
Choose a presentation
$$
S^{\oplus s} \to S^{\oplus t} \to M \to 0
$$
of $M$ over $S$. Let $A \in \text{Mat}(t \times s, S)$ be
the matrix of the presentation. For some $\lambda_2 \in \Lambda$,
$\lambda_2 \geq \lambda_1$
we can find a matrix $A_{\lambda_2} \in \text{Mat}(t \times s, S_{\lambda_2})$
which maps to $A$. For all $\lambda \geq \lambda_2$ we let
$M_\lambda = \Coker(S_\lambda^{\oplus s} \xrightarrow{A_\lambda}
S_\lambda^{\oplus t})$. We leave it to the reader to see that
this works.
\end{proof}

\begin{lemma}
\label{lemma-limit-no-condition}
Suppose $R \to S$ is a ring map.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-no-condition-local}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-integral}
Suppose $R \to S$ is a ring map.
Assume that $S$ is integral over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the set $\Lambda$ of pairs $(E, F)$ where $E \subset R$
is a finite subset, $F \subset S$ is a finite subset, and
every element $f \in F$ is the root of a monic $P(X) \in R[X]$
whose coefficients are in $E$. Say $(E, F) \leq (E', F')$
if $E \subset E'$ and $F \subset F'$.
Given $\lambda = (E, F) \in \Lambda$ set $R_\lambda \subset R$ equal
to the $\mathbf{Z}$-subalgebra of $R$ generated by $E$ and
$S_\lambda \subset S$ equal to the $\mathbf{Z}$-subalgebra generated by
$F$ and the image of $E$ in $S$. It is clear that $R = \colim R_\lambda$.
We have $S = \colim S_\lambda$ as every element of $S$ is integral
over $S$. The ring maps $R_\lambda \to S_\lambda$ are finite by
Lemma \ref{lemma-characterize-finite-in-terms-of-integral} and the fact that
$S_\lambda$ is generated over $R_\lambda$ by the elements of
$F$ which are integral over $R_\lambda$ by our condition on the
pairs $(E, F)$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-type}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-type}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-module-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to M_\mu$
is an isomorphism.
\end{enumerate}
In particular, for every $\lambda \in \Lambda$ we have
$$
M = M_\lambda \otimes_{S_\lambda} S
= M_\lambda \otimes_{R_\lambda} R.
$$
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}














\section{More flatness criteria}
\label{section-more-flatness-criteria}

\noindent
The following lemma is often used in algebraic geometry to show that a finite
morphism from a normal surface to a smooth surface is flat. It is a partial
converse to
Lemma \ref{lemma-finite-flat-over-regular-CM}
because an injective finite local ring map certainly satisfies condition (3).

\begin{lemma}
\label{lemma-CM-over-regular-flat}
Let $R \to S$ be a local homomorphism of Noetherian local
rings. Assume
\begin{enumerate}
\item $R$ is regular,
\item $S$ Cohen-Macaulay,
\item $\dim(S) = \dim(R) + \dim(S/\mathfrak m_R S)$.
\end{enumerate}
Then $R \to S$ is flat.
\end{lemma}

\begin{proof}
By induction on $\dim(R)$. The case $\dim(R) = 0$ is trivial, because
then $R$ is a field. Assume $\dim(R) > 0$. By (3) this implies that
$\dim(S) > 0$. Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be the minimal
primes of $S$. Note that $\mathfrak q_i \not \supset \mathfrak m_R S$ since
$$
\dim(S/\mathfrak q_i) = \dim(S) > \dim(S/\mathfrak m_R S)
$$
the first equality by Lemma \ref{lemma-maximal-chain-CM} and the
inequality by (3). Thus
$\mathfrak p_i = R \cap \mathfrak q_i$ is not equal to $\mathfrak m_R$.
Pick $x \in \mathfrak m$, $x \not \in \mathfrak m^2$, and
$x \not \in \mathfrak p_i$, see
Lemma \ref{lemma-silly}.
Hence we see that $x$ is not contained in any of the minimal
primes of $S$. Hence $x$ is a nonzerodivisor on $S$ by (2), see
Lemma \ref{lemma-reformulate-CM} and
$S/xS$ is Cohen-Macaulay with $\dim(S/xS) = \dim(S) - 1$.
By (1) and Lemma \ref{lemma-regular-ring-CM} the ring $R/xR$ is regular
with $\dim(R/xR) = \dim(R) - 1$.
By induction we see that $R/xR \to S/xS$ is flat. Hence we
conclude by Lemma \ref{lemma-variant-local-criterion-flatness}
and the remark following it.
\end{proof}

\begin{lemma}
\label{lemma-flat-over-regular}
Let $R \to S$ be a homomorphism of Noetherian local rings.
Assume that $R$ is a regular local ring and that a regular system
of parameters maps to a regular sequence in $S$. Then $R \to S$
is flat.
\end{lemma}

\begin{proof}
Suppose that $x_1, \ldots, x_d$ are a system of parameters of $R$
which map to a regular sequence in $S$. Note that
$S/(x_1, \ldots, x_d)S$ is flat over $R/(x_1, \ldots, x_d)$
as the latter is a field. Then $x_d$ is a nonzerodivisor in
$S/(x_1, \ldots, x_{d - 1})S$ hence $S/(x_1, \ldots, x_{d - 1})S$
is flat over $R/(x_1, \ldots, x_{d - 1})$ by the local criterion
of flatness (see Lemma \ref{lemma-variant-local-criterion-flatness}
and remarks following). Then $x_{d - 1}$ is a nonzerodivisor in
$S/(x_1, \ldots, x_{d - 2})S$ hence $S/(x_1, \ldots, x_{d - 2})S$
is flat over $R/(x_1, \ldots, x_{d - 2})$ by the local criterion
of flatness (see Lemma \ref{lemma-variant-local-criterion-flatness}
and remarks following). Continue till one reaches the conclusion
that $S$ is flat over $R$.
\end{proof}

\noindent
The following lemma is the key to proving that results for finitely presented
modules over finitely presented rings over a base ring follow from the
corresponding results for finite modules in the Noetherian case.

\begin{lemma}
\label{lemma-colimit-eventually-flat}
Let $R \to S$, $M$, $\Lambda$, $R_\lambda \to S_\lambda$, $M_\lambda$
be as in Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Assume that $M$ is flat over $R$.
Then for some $\lambda \in \Lambda$ the module
$M_\lambda$ is flat over $R_\lambda$.
\end{lemma}

\begin{proof}
Pick some $\lambda \in \Lambda$ and consider
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
=
\Ker(\mathfrak m_\lambda \otimes_{R_\lambda} M_\lambda
\to M_\lambda).
$$
See Remark \ref{remark-Tor-ring-mod-ideal}. The right hand side
shows that this is a finitely generated $S_\lambda$-module (because
$S_\lambda$ is Noetherian and the modules in question are finite).
Let $\xi_1, \ldots, \xi_n$ be generators.
Because $M$ is flat over $R$ we
have that $0 = \Ker(\mathfrak m_\lambda R \otimes_R M \to M)$.
Since $\otimes$ commutes with colimits we see there exists
a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to
zero in
$\mathfrak m_{\lambda}R_{\lambda'} \otimes_{R_{\lambda'}} M_{\lambda'}$.
Hence we see that
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
\longrightarrow
\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'},
R_{\lambda'}/\mathfrak m_{\lambda}R_{\lambda'})
$$
is zero. Note that
$M_\lambda \otimes_{R_\lambda} R_\lambda/\mathfrak m_\lambda$
is flat over $R_\lambda/\mathfrak m_\lambda$ because this last
ring is a field. Hence we may apply Lemma
\ref{lemma-another-variant-local-criterion-flatness}
to get that $M_{\lambda'}$ is flat over $R_{\lambda'}$.
\end{proof}

\noindent
Using the lemma above we can start to reprove the results of
Section \ref{section-criteria-flatness}
in the non-Noetherian case.

\begin{lemma}
\label{lemma-mod-injective-general}
Suppose that $R \to S$ is a local homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Let $u : M \to N$ be a map of $S$-modules.
Assume
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $M$, $N$ are finitely presented over $S$,
\item $N$ is flat over $R$, and
\item $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective.
\end{enumerate}
Then $u$ is injective, and $N/u(M)$ is flat over $R$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-limit-module-essentially-finite-presentation}
and its proof we can find a system $R_\lambda \to S_\lambda$ of
local ring maps together with maps of $S_\lambda$-modules
$u_\lambda : M_\lambda \to N_\lambda$ satisfying the conclusions
(1) -- (6) for both $N$ and $M$ of that lemma and such that the
colimit of the maps $u_\lambda$ is $u$. By
Lemma \ref{lemma-colimit-eventually-flat}
we may assume that $N_\lambda$ is flat over $R_\lambda$ for all
sufficiently large $\lambda$. Denote $\mathfrak m_\lambda \subset R_\lambda$
the maximal ideal and $\kappa_\lambda = R_\lambda / \mathfrak m_\lambda$,
resp.\ $\kappa = R/\mathfrak m$ the residue fields.

\medskip\noindent
Consider the map
$$
\Psi_\lambda :
M_\lambda/\mathfrak m_\lambda M_\lambda \otimes_{\kappa_\lambda} \kappa
\longrightarrow
M/\mathfrak m M.
$$
Since $S_\lambda/\mathfrak m_\lambda S_\lambda$ is essentially of finite type
over the field $\kappa_\lambda$ we see that the tensor product
$S_\lambda/\mathfrak m_\lambda S_\lambda \otimes_{\kappa_\lambda} \kappa$
is essentially of finite type over $\kappa$. Hence it is a Noetherian
ring and we conclude the kernel of $\Psi_\lambda$ is finitely generated.
Since $M/\mathfrak m M$ is the colimit of the system
$M_\lambda/\mathfrak m_\lambda M_\lambda$ and $\kappa$ is the colimit of
the fields $\kappa_\lambda$ there exists a $\lambda' > \lambda$ such that
the kernel of $\Psi_\lambda$ is generated by the kernel of
$$
\Psi_{\lambda, \lambda'} :
M_\lambda/\mathfrak m_\lambda M_\lambda
\otimes_{\kappa_\lambda}
\kappa_{\lambda'}
\longrightarrow
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}.
$$
By construction there exists a multiplicative subset
$W \subset S_\lambda \otimes_{R_\lambda} R_{\lambda'}$ such that
$S_{\lambda'} = W^{-1}(S_\lambda \otimes_{R_\lambda} R_{\lambda'})$ and
$$
W^{-1}(M_\lambda/\mathfrak m_\lambda M_\lambda
\otimes_{\kappa_\lambda}
\kappa_{\lambda'})
=
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}.
$$
Now suppose that $x$ is an element of the kernel of
$$
\Psi_{\lambda'} :
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}
\otimes_{\kappa_{\lambda'}} \kappa
\longrightarrow
M/\mathfrak m M.
$$
Then for some $w \in W$ we have
$wx \in M_\lambda/\mathfrak m_\lambda M_\lambda \otimes \kappa$.
Hence $wx \in \Ker(\Psi_\lambda)$. Hence $wx$ is a linear
combination of elements in the kernel of $\Psi_{\lambda, \lambda'}$.
Hence $wx = 0$ in $M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}
\otimes_{\kappa_{\lambda'}} \kappa$, hence $x = 0$ because $w$ is invertible
in $S_{\lambda'}$.
We conclude that the kernel of $\Psi_{\lambda'}$ is zero for all sufficiently
large $\lambda'$!

\medskip\noindent
By the result of the preceding paragraph we may assume that
the kernel of $\Psi_\lambda$ is zero for all $\lambda$ sufficiently large,
which implies that the map
$M_\lambda/\mathfrak m_\lambda M_\lambda \to M/\mathfrak m M$
is injective. Combined with $\overline{u}$ being injective this
formally implies that also
$\overline{u_\lambda} : M_\lambda/\mathfrak m_\lambda M_\lambda
\to N_\lambda/\mathfrak m_\lambda N_\lambda$ is injective.
By
Lemma \ref{lemma-mod-injective}
we conclude that (for all sufficiently large $\lambda$) the map
$u_\lambda$ is injective and that $N_\lambda/u_\lambda(M_\lambda)$ is flat
over $R_\lambda$.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-general}
Suppose that $R \to S$ is a local ring homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $S$ is flat over $R$, and
\item $f \in S$ is a nonzerodivisor in $S/{\mathfrak m}S$.
\end{enumerate}
Then $S/fS$ is flat over $R$, and $f$ is a nonzerodivisor in $S$.
\end{lemma}

\begin{proof}
Follows directly from Lemma \ref{lemma-mod-injective-general}.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-regular-sequence-general}
Suppose that $R \to S$ is a local ring homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose
\begin{enumerate}
\item $R \to S$ is essentially of finite presentation,
\item $R \to S$ is flat, and
\item $f_1, \ldots, f_c$ is a sequence of elements of
$S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$
form a regular sequence in $S/{\mathfrak m}S$.
\end{enumerate}
Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each
of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.
\end{lemma}

\begin{proof}
Induction and Lemma \ref{lemma-grothendieck-general}.
\end{proof}

\noindent
Here is the version of the local criterion of flatness for the case
of local ring maps which are locally of finite presentation.

\begin{lemma}
\label{lemma-variant-local-criterion-flatness-general}
Let $R \to S$ be a local homomorphism of local rings.
Let $I \not = R$ be an ideal in $R$. Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is of finite presentation over $S$,
\item $\text{Tor}_1^R(M, R/I) = 0$, and
\item $M/IM$ is flat over $R/I$.
\end{enumerate}
Then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\Lambda$, $R_\lambda \to S_\lambda$, $M_\lambda$ be as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Denote $I_\lambda \subset R_\lambda$ the inverse image of $I$.
In this case the system
$R/I \to S/IS$, $M/IM$, $R_\lambda \to S_\lambda/I_\lambda S_\lambda$,
and $M_\lambda/I_\lambda M_\lambda$ satisfies the conclusions of
Lemma \ref{lemma-limit-module-essentially-finite-presentation}
as well. Hence by
Lemma \ref{lemma-colimit-eventually-flat}
we may assume (after shrinking the index set $\Lambda$)
that $M_\lambda/I_\lambda M_\lambda$ is flat for all $\lambda$.
Pick some $\lambda$ and consider
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/I_\lambda)
=
\Ker(I_\lambda \otimes_{R_\lambda} M_\lambda
\to M_\lambda).
$$
See Remark \ref{remark-Tor-ring-mod-ideal}. The right hand side
shows that this is a finitely generated $S_\lambda$-module (because
$S_\lambda$ is Noetherian and the modules in question are finite).
Let $\xi_1, \ldots, \xi_n$ be generators.
Because $\text{Tor}^1_R(M, R/I) = 0$ and since $\otimes$ commutes
with colimits we see there exists
a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to
zero in
$\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'})$.
The composition of the maps
$$
\xymatrix{
R_{\lambda'} \otimes_{R_\lambda}
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/I_\lambda)
\ar[d]^{\text{surjective by Lemma \ref{lemma-surjective-on-tor-one}}} \\
\text{Tor}_1^{R_\lambda}(M_\lambda, R_{\lambda'}/I_\lambda R_{\lambda'})
\ar[d]^{\text{surjective up to localization by
Lemma \ref{lemma-surjective-on-tor-one-trivial}}} \\
\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_\lambda R_{\lambda'})
\ar[d]^{\text{surjective by Lemma \ref{lemma-surjective-on-tor-one}}} \\
\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'}).
}
$$
is surjective up to a localization by the reasons indicated.
The localization is necessary since $M_{\lambda'}$ is not equal
to $M_\lambda \otimes_{R_\lambda} R_{\lambda'}$. Namely, it is equal
to $M_\lambda \otimes_{S_\lambda} S_{\lambda'}$ and $S_{\lambda'}$
is the localization of $S_{\lambda} \otimes_{R_\lambda} R_{\lambda'}$ whence
the statement up to a localization (or tensoring with $S_{\lambda'}$).
Note that
Lemma \ref{lemma-surjective-on-tor-one}
applies to the first and third arrows because
$M_\lambda/I_\lambda M_\lambda$ is flat over
$R_\lambda/I_\lambda$ and because $M_{\lambda'}/I_\lambda M_{\lambda'}$
is flat over $R_{\lambda'}/I_\lambda R_{\lambda'}$ as it is a base
change of the flat module $M_\lambda/I_\lambda M_\lambda$.
The composition maps the generators $\xi_i$ to zero as we explained above.
We finally conclude that
$\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'})$
is zero. This implies that $M_{\lambda'}$ is flat over $R_{\lambda'}$ by
Lemma \ref{lemma-variant-local-criterion-flatness}.
\end{proof}

\noindent
Please compare the lemma below to
Lemma \ref{lemma-criterion-flatness-fibre-Noetherian}
(the case of Noetherian local rings) and
Lemma \ref{lemma-criterion-flatness-fibre-nilpotent}
(the case of a nilpotent ideal in the base).

\begin{lemma}[Crit\`ere de platitude par fibres]
\label{lemma-criterion-flatness-fibre}
Let $R$, $S$, $S'$ be local rings and let $R \to S \to S'$ be local ring
homomorphisms. Let $M$ be an $S'$-module. Let $\mathfrak m \subset R$
be the maximal ideal. Assume
\begin{enumerate}
\item The ring maps $R \to S$ and $R \to S'$ are essentially
of finite presentation.
\item The module $M$ is of finite presentation over $S'$.
\item The module $M$ is not zero.
\item The module $M/\mathfrak mM$ is a flat $S/\mathfrak mS$-module.
\item The module $M$ is a flat $R$-module.
\end{enumerate}
Then $S$ is flat over $R$ and $M$ is a flat $S$-module.
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-limit-essentially-finite-presentation}
we may first write $R = \colim R_\lambda$ as a directed colimit
of local $\mathbf{Z}$-algebras which are essentially of finite type.
Denote $\mathfrak p_\lambda$ the maximal ideal of $R$.
Next, we may assume that for some $\lambda_1 \in \Lambda$ there
exist $f_{j, \lambda_1} \in R_{\lambda_1}[x_1, \ldots, x_n]$
such that
$$
S =
\colim_{\lambda \geq \lambda_1} S_\lambda, \text{ with }
S_\lambda =
(R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{u, \lambda}))_{\mathfrak q_\lambda}
$$
For some $\lambda_2 \in \Lambda$,
$\lambda_2 \geq \lambda_1$ there exist
$g_{j, \lambda_2} \in R_{\lambda_2}[x_1, \ldots, x_n, y_1, \ldots, y_m]$
with images
$\overline{g}_{j, \lambda_2} \in S_{\lambda_2}[y_1, \ldots, y_m]$
such that
$$
S' =
\colim_{\lambda \geq \lambda_2} S'_\lambda, \text{ with }
S'_\lambda =
(S_\lambda[y_1, \ldots, y_m]/
(\overline{g}_{1, \lambda}, \ldots,
\overline{g}_{v, \lambda}))_{\overline{\mathfrak q}'_\lambda}
$$
Note that this also implies that
$$
S'_\lambda =
(R_\lambda[x_1, \ldots, x_n, y_1, \ldots, y_m]/
(g_{1, \lambda}, \ldots, g_{v, \lambda}))_{\mathfrak q'_\lambda}
$$
Choose a presentation
$$
(S')^{\oplus s} \to (S')^{\oplus t} \to M \to 0
$$
of $M$ over $S'$. Let $A \in \text{Mat}(t \times s, S')$ be
the matrix of the presentation. For some $\lambda_3 \in \Lambda$,
$\lambda_3 \geq \lambda_2$
we can find a matrix $A_{\lambda_3} \in \text{Mat}(t \times s, S_{\lambda_3})$
which maps to $A$. For all $\lambda \geq \lambda_3$ we let
$M_\lambda = \Coker((S'_\lambda)^{\oplus s} \xrightarrow{A_\lambda}
(S'_\lambda)^{\oplus t})$.

\medskip\noindent
With these choices, we have for each $\lambda_3 \leq \lambda \leq \mu$
that $S_\lambda \otimes_{R_{\lambda}} R_\mu \to S_\mu$ is a localization,
$S'_\lambda \otimes_{S_{\lambda}} S_\mu \to S'_\mu$ is a localization, and
the map $M_\lambda \otimes_{S'_\lambda} S_\mu \to M_\mu$ is an
isomorphism. This also implies that
$S'_\lambda \otimes_{R_{\lambda}} R_\mu \to S'_\mu$ is a localization.
Thus, since $M$ is flat over $R$ we see by
Lemma \ref{lemma-colimit-eventually-flat} that
for all $\lambda$ big enough the module $M_\lambda$ is
flat over $R_\lambda$.
Moreover, note that
$
\mathfrak m = \colim \mathfrak p_\lambda
$,
$
S/\mathfrak mS = \colim S_\lambda/\mathfrak p_\lambda S_\lambda
$,
$
S'/\mathfrak mS' = \colim S'_\lambda/\mathfrak p_\lambda S'_\lambda
$,
and
$
M/\mathfrak mM = \colim M_\lambda/\mathfrak p_\lambda M_\lambda
$. Also, for each $\lambda_3 \leq \lambda \leq \mu$ we see (from the
properties listed above) that
$$
S'_\lambda/\mathfrak p_\lambda S'_\lambda
\otimes_{S_{\lambda}/\mathfrak p_\lambda S_\lambda}
S_\mu/\mathfrak p_\mu S_\mu
\longrightarrow
S'_\mu/\mathfrak p_\mu S'_\mu
$$
is a localization, and the map
$$
M_\lambda / \mathfrak p_\lambda M_\lambda
\otimes_{S'_\lambda/\mathfrak p_\lambda S'_\lambda}
S_\mu /\mathfrak p_\mu S'_\mu
\longrightarrow
M_\mu/\mathfrak p_\mu M_\mu
$$
is an isomorphism. Hence the system
$(S_\lambda/\mathfrak p_\lambda S_\lambda \to
S'_\lambda/\mathfrak p_\lambda S'_\lambda,
M_\lambda/\mathfrak p_\lambda M_\lambda)$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation} as well.
We may apply Lemma \ref{lemma-colimit-eventually-flat} again because
$M/\mathfrak m M$ is assumed flat over $S/\mathfrak mS$ and we see that
$M_\lambda/\mathfrak p_\lambda M_\lambda$ is flat over
$S_\lambda/\mathfrak p_\lambda S_\lambda$ for all $\lambda$ big enough.
Thus for $\lambda$ big enough the data
$R_\lambda \to S_\lambda \to S'_\lambda, M_\lambda$ satisfies
the hypotheses of Lemma \ref{lemma-criterion-flatness-fibre-Noetherian}.
Pick such a $\lambda$. Then $S = S_\lambda \otimes_{R_\lambda} R$
is flat over $R$, and $M = M_\lambda \otimes_{S_\lambda} S'_{\lambda}$
is flat over $S$ (since the base change of a flat module is flat).
\end{proof}

\noindent
The following is an easy consequence of the ``crit\`ere de platitude par
fibres'' Lemma \ref{lemma-criterion-flatness-fibre}. For more results of
this kind see More on Flatness, Section \ref{flat-section-introduction}.

\begin{lemma}
\label{lemma-criterion-flatness-fibre-fp-over-ft}
Let $R$, $S$, $S'$ be local rings and let $R \to S \to S'$ be local ring
homomorphisms. Let $M$ be an $S'$-module. Let $\mathfrak m \subset R$
be the maximal ideal. Assume
\begin{enumerate}
\item $R \to S'$ is essentially of finite presentation,
\item $R \to S$ is essentially of finite type,
\item $M$ is of finite presentation over $S'$,
\item $M$ is not zero,
\item $M/\mathfrak mM$ is a flat $S/\mathfrak mS$-module, and
\item $M$ is a flat $R$-module.
\end{enumerate}
Then $S$ is essentially of finite presentation and flat over $R$
and $M$ is a flat $S$-module.
\end{lemma}

\begin{proof}
As $S$ is essentially of finite presentation over $R$ we can write
$S = C_{\overline{\mathfrak q}}$ for some finite type $R$-algebra $C$.
Write $C = R[x_1, \ldots, x_n]/I$. Denote
$\mathfrak q \subset R[x_1, \ldots, x_n]$ be the prime ideal corresponding
to $\overline{\mathfrak q}$. Then we see that $S = B/J$ where
$B = R[x_1, \ldots, x_n]_{\mathfrak q}$ is essentially of finite presentation
over $R$ and $J = IB$. We can find $f_1, \ldots, f_k \in J$ such that
the images $\overline{f}_i \in B/\mathfrak mB$
generate the image $\overline{J}$ of $J$ in the Noetherian ring
$B/\mathfrak mB$. Hence there exist finitely generated ideals
$J' \subset J$ such that $B/J' \to B/J$ induces an isomorphism
$$
(B/J') \otimes_R R/\mathfrak m \longrightarrow
B/J \otimes_R R/\mathfrak m = S/\mathfrak mS.
$$
For any $J'$ as above we see that
Lemma \ref{lemma-criterion-flatness-fibre}
applies to the ring maps
$$
R \longrightarrow B/J' \longrightarrow S'
$$
and the module $M$. Hence we conclude that $B/J'$ is flat over $R$
for any choice $J'$ as above. Now, if $J' \subset J' \subset J$ are
two finitely generated ideals as above, then we conclude that
$B/J' \to B/J''$ is a surjective map between flat $R$-algebras
which are essentially of finite presentation which is an isomorphism
modulo $\mathfrak m$. Hence
Lemma \ref{lemma-mod-injective-general}
implies that $B/J' = B/J''$, i.e., $J' = J''$. Clearly this means that
$J$ is finitely generated, i.e., $S$ is essentially of finite presentation
over $R$. Thus we may apply
Lemma \ref{lemma-criterion-flatness-fibre}
to $R \to S \to S'$ and we win.
\end{proof}

\begin{lemma}[Crit\`ere de platitude par fibres: locally nilpotent case]
\label{lemma-criterion-flatness-fibre-locally-nilpotent}
Let
$$
\xymatrix{
S \ar[rr] & & S' \\
& R \ar[lu] \ar[ru]
}
$$
be a commutative diagram in the category of rings.
Let $I \subset R$ be a locally nilpotent ideal and
$M$ an $S'$-module. Assume
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $R \to S'$ is of finite presentation,
\item $M$ is a finitely presented $S'$-module,
\item $M/IM$ is flat as a $S/IS$-module, and
\item $M$ is flat as an $R$-module.
\end{enumerate}
Then $M$ is a flat $S$-module and $S_\mathfrak q$ is flat
and essentially of finite presentation over $R$
for every $\mathfrak q \subset S$ such that
$M \otimes_S \kappa(\mathfrak q)$ is nonzero.
\end{lemma}

\begin{proof}
If $M \otimes_S \kappa(\mathfrak q)$ is nonzero, then
$S' \otimes_S \kappa(\mathfrak q)$ is nonzero and hence
there exists a prime $\mathfrak q' \subset S'$ lying over
$\mathfrak q$ (Lemma \ref{lemma-in-image}). Let
$\mathfrak p \subset R$ be the image of $\mathfrak q$ in $\Spec(R)$.
Then $I \subset \mathfrak p$ as $I$ is locally nilpotent
hence $M/\mathfrak p M$ is flat over $S/\mathfrak pS$.
Hence we may apply Lemma \ref{lemma-criterion-flatness-fibre-fp-over-ft}
to $R_\mathfrak p \to S_\mathfrak q \to S'_{\mathfrak q'}$
and $M_{\mathfrak q'}$. We conclude that $M_{\mathfrak q'}$
is flat over $S$ and $S_\mathfrak q$ is flat and essentially
of finite presentation over $R$.
Since $\mathfrak q'$ was an arbitrary prime of $S'$ we also
see that $M$ is flat over $S$ (Lemma \ref{lemma-flat-localization}).
\end{proof}















\section{Openness of the flat locus}
\label{section-open-flat}


\begin{lemma}
\label{lemma-CM-dim-finite-type}
Let $k$ be a field. Let $S$ be a finite type
$k$-algebra. Let $f_1, \ldots, f_i$ be elements
of $S$. Assume that $S$ is Cohen-Macaulay and
equidimensional of dimension $d$, and that
$\dim V(f_1, \ldots, f_i) \leq d - i$. Then equality
holds and $f_1, \ldots, f_i$ forms a regular
sequence in $S_{\mathfrak q}$ for every prime $\mathfrak q$
of $V(f_1, \ldots, f_i)$.
\end{lemma}

\begin{proof}
If $S$ is Cohen-Macaulay and equidimensional of dimension
$d$, then we have $\dim(S_{\mathfrak m}) = d$ for all maximal
ideals $\mathfrak m$ of $S$, see
Lemma \ref{lemma-disjoint-decomposition-CM-algebra}.
By Proposition \ref{proposition-CM-module} we see that
for all maximal ideals $\mathfrak m \in V(f_1, \ldots, f_i)$
the sequence is a regular sequence in $S_{\mathfrak m}$ and
the local ring $S_{\mathfrak m}/(f_1, \ldots, f_i)$ is
Cohen-Macaulay of dimension $d - i$. This actually
means that $S/(f_1, \ldots, f_i)$ is Cohen-Macaulay
and equidimensional of dimension $d - i$.
\end{proof}

\begin{lemma}
\label{lemma-open-regular-sequence}
Suppose that $R \to S$ is a ring map which is
finite type, flat. Let $d$ be an integer
such that all fibres
$S \otimes_R \kappa(\mathfrak p)$ are
Cohen-Macaulay and equidimensional
of dimension $d$. Let $f_1, \ldots, f_i$
be elements of $S$. The set
$$
\{ \mathfrak q \in V(f_1, \ldots, f_i)
\mid f_1, \ldots, f_i
\text{ are a regular sequence in }
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
\text{ where }\mathfrak p = R \cap \mathfrak q
\}
$$
is open in $V(f_1, \ldots, f_i)$.
\end{lemma}

\begin{proof}
Write $\overline{S} = S/(f_1, \ldots, f_i)$.
Suppose $\mathfrak q$ is an element of the set defined in the
lemma, and $\mathfrak p$ is the corresponding prime of $R$.
We will use relative dimension as defined in
Definition \ref{definition-relative-dimension}.
First, note that $d = \dim_{\mathfrak q}(S/R) =
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q)$
by Lemma \ref{lemma-dimension-at-a-point-finite-type-field}.
Since $f_1, \ldots, f_i$ form a regular sequence in the
Noetherian local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
general dimension theory tells us that
$\dim(\overline{S}_{\mathfrak q}/\mathfrak p\overline{S}_{\mathfrak q})
= \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) - i$.
By the same Lemma \ref{lemma-dimension-at-a-point-finite-type-field}
we then conclude that $\dim_{\mathfrak q}(\overline{S}/R)
= \dim(\overline{S}_{\mathfrak q}/\mathfrak p\overline{S}_{\mathfrak q}) +
\text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q)
= d - i$. By Lemma
\ref{lemma-dimension-fibres-bounded-open-upstairs}
we have $\dim_{\mathfrak q'}(\overline{S}/R) \leq d - i$
for all $\mathfrak q' \in V(f_1, \ldots, f_i) = \Spec(\overline{S})$
in a neighbourhood of $\mathfrak q$. Thus after replacing
$S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
we may assume that the inequality holds for all
$\mathfrak q'$. The result follows from Lemma
\ref{lemma-CM-dim-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-exact-on-fibres-open}
Let $R \to S$ is a ring map.
Consider a finite homological complex of
finite free $S$-modules:
$$
F_{\bullet} :
0
\to
S^{n_e}
\xrightarrow{\varphi_e}
S^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i + 1}}
S^{n_i}
\xrightarrow{\varphi_i}
S^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
S^{n_0}
$$
For every prime $\mathfrak q$ of $S$ consider the
complex $\overline{F}_{\bullet, \mathfrak q} =
F_{\bullet, \mathfrak q} \otimes_R \kappa(\mathfrak p)$
where $\mathfrak p$ is inverse image of $\mathfrak q$ in $R$.
Assume there exists an integer $d$ such
that $R \to S$ is finite type, flat
with fibres $S \otimes_R \kappa(\mathfrak p)$
Cohen-Macaulay of dimension $d$.
The set
$$
\{\mathfrak q \in \Spec(S) \mid
\overline{F}_{\bullet, \mathfrak q}\text{ is exact}\}
$$
is open in $\Spec(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be an element of the set defined in the lemma.
We are going to use Proposition \ref{proposition-what-exact}
to show there exists a $g \in S$, $g \not \in \mathfrak q$
such that $D(g)$ is contained in the set defined in the lemma.
In other words, we are going to show that after replacing $S$
by $S_g$, the set of the lemma is all of $\Spec(S)$.
Thus during the proof we will, finitely often, replace
$S$ by such a localization.
Recall that Proposition \ref{proposition-what-exact}
characterizes exactness of complexes
in terms of ranks of the maps $\varphi_i$ and the ideals
$I(\varphi_i)$, in case the ring is local. We first address
the rank condition. Set
$r_i = n_i - n_{i + 1} + \ldots + (-1)^{e - i} n_e$.
Note that $r_i + r_{i + 1} = n_i$ and note that
$r_i$ is the expected rank of $\varphi_i$ (in the
exact case).

\medskip\noindent
By Lemma \ref{lemma-complex-exact-mod} we see that if
$\overline{F}_{\bullet, \mathfrak q}$ is exact, then
the localization $F_{\bullet, \mathfrak q}$ is exact.
In particular the complex $F_\bullet$ becomes
exact after localizing by an element
$g \in S$, $g \not \in \mathfrak q$. In this case
Proposition \ref{proposition-what-exact} applied
to all localizations of $S$ at prime ideals
implies that all $(r_i + 1) \times (r_i + 1)$-minors
of $\varphi_i$ are zero. Thus we see that the rank of
of $\varphi_i$ is at most $r_i$.

\medskip\noindent
Let $I_i \subset S$ denote the ideal generated
by the $r_i \times r_i$-minors of the matrix
of $\varphi_i$. By Proposition \ref{proposition-what-exact}
the complex $\overline{F}_{\bullet, \mathfrak q}$ is exact
if and only if for every $1 \leq i \leq e$ we have
either $(I_i)_{\mathfrak q} = S_{\mathfrak q}$ or
$(I_i)_{\mathfrak q}$ contains a $S_{\mathfrak q}/\mathfrak p
S_{\mathfrak q}$-regular sequence of length $i$.
Namely, by our choice of $r_i$ above and by the
bound on the ranks of the $\varphi_i$ this is the
only way the conditions of Proposition \ref{proposition-what-exact}
can be satisfied.

\medskip\noindent
If $(I_i)_{\mathfrak q} = S_{\mathfrak q}$, then after localizing $S$ at
some element $g \not\in \mathfrak q$ we may assume that
$I_i = S$. Clearly, this is an open condition.

\medskip\noindent
If $(I_i)_{\mathfrak q} \not = S_{\mathfrak q}$, then we have
a sequence $f_1, \ldots, f_i \in (I_i)_{\mathfrak q}$ which
form a regular sequence in $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$.
Note that for any prime $\mathfrak q' \subset S$ such that
$(f_1, \ldots, f_i) \not \subset \mathfrak q'$ we have
$(I_i)_{\mathfrak q'} = S_{\mathfrak q'}$.
Thus the result follows from Lemma \ref{lemma-open-regular-sequence}.
\end{proof}


\begin{theorem}
\label{theorem-openness-flatness}
Let $R$ be a ring. Let $R \to S$ be a ring map of finite
presentation. Let $M$ be a finitely presented $S$-module.
The set
$$
\{ \mathfrak q \in \Spec(S) \mid
M_{\mathfrak q}\text{ is flat over }R\}
$$
is open in $\Spec(S)$.
\end{theorem}

\begin{proof}
Let $\mathfrak q \in \Spec(S)$ be a prime.
Let $\mathfrak p \subset R$ be the inverse image of $\mathfrak q$ in $R$.
Note that $M_{\mathfrak q}$ is flat over $R$ if and only if
it is flat over $R_{\mathfrak p}$.
Let us assume that $M_{\mathfrak q}$ is flat over $R$.
We claim that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M_g$ is flat over $R$.

\medskip\noindent
We first reduce to the case where $R$ and $S$ are
of finite type over $\mathbf{Z}$.
Choose a directed set $\Lambda$ and
a system $(R_\lambda \to S_\lambda, M_\lambda)$
as in Lemma \ref{lemma-limit-module-finite-presentation}.
Set $\mathfrak p_\lambda$ equal to the inverse image of
$\mathfrak p$ in $R_\lambda$.
Set $\mathfrak q_\lambda$ equal to the inverse image of
$\mathfrak q$ in $S_\lambda$.
Then the system
$$
((R_\lambda)_{\mathfrak p_\lambda},
(S_\lambda)_{\mathfrak q_\lambda},
(M_\lambda)_{\mathfrak q_{\lambda}})
$$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Hence by Lemma \ref{lemma-colimit-eventually-flat}
we see that for some $\lambda$ the module
$M_\lambda$ is flat over $R_\lambda$ at the prime
$\mathfrak q_{\lambda}$. Suppose we
can prove our claim for the system
$(R_\lambda \to S_\lambda, M_\lambda, \mathfrak q_{\lambda})$.
In other words, suppose that we can find a $g \in S_\lambda$,
$g \not\in \mathfrak q_\lambda$ such that $(M_\lambda)_g$
is flat over $R_\lambda$. By Lemma \ref{lemma-limit-module-finite-presentation}
we have $M = M_\lambda \otimes_{R_\lambda} R$ and hence
also $M_g = (M_\lambda)_g \otimes_{R_\lambda} R$. Thus by
Lemma \ref{lemma-flat-base-change} we deduce the claim
for the system $(R \to S, M, \mathfrak q)$.

\medskip\noindent
At this point we may assume that $R$ and $S$ are of finite type
over $\mathbf{Z}$. We may write $S$ as a quotient of a
polynomial ring $R[x_1, \ldots, x_n]$. Of course, we may replace
$S$ by $R[x_1, \ldots, x_n]$ and assume that $S$ is a polynomial
ring over $R$. In particular we see that $R \to S$ is flat
and all fibres rings $S \otimes_R \kappa(\mathfrak p)$
have global dimension $n$.

\medskip\noindent
Choose a resolution $F_\bullet$ of $M$ over $S$ with each
$F_i$ finite free, see Lemma \ref{lemma-resolution-by-finite-free}.
Let $K_n = \Ker(F_{n-1} \to F_{n-2})$. Note that
$(K_n)_{\mathfrak q}$ is flat over $R$, since each $F_i$
is flat over $R$ and by assumption on $M$, see Lemma
\ref{lemma-flat-ses}. In addition, the sequence
$$
0 \to
K_n/\mathfrak p K_n \to
F_{n-1}/ \mathfrak p F_{n-1} \to
\ldots \to
F_0 / \mathfrak p F_0 \to
M/\mathfrak p M \to
0
$$
is exact upon localizing at $\mathfrak q$, because of vanishing
of $\text{Tor}_i^{R_\mathfrak p}(\kappa(\mathfrak p), M_{\mathfrak q})$.
Since the global dimension of $S_\mathfrak q/\mathfrak p S_{\mathfrak q}$
is $n$ we conclude that $K_n / \mathfrak p K_n$ localized
at $\mathfrak q$ is a finite free module over
$S_\mathfrak q/\mathfrak p S_{\mathfrak q}$. By
Lemma \ref{lemma-free-fibre-flat-free} $(K_n)_{\mathfrak q}$
is free over $S_{\mathfrak q}$. In particular, there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $(K_n)_g$
is finite free over $S_g$.

\medskip\noindent
By Lemma \ref{lemma-exact-on-fibres-open}
there exists a further localization $S_g$ such that
the complex
$$
0 \to K_n \to F_{n-1} \to \ldots \to F_0
$$
is exact on {\it all fibres} of $R \to S$. By
Lemma \ref{lemma-complex-exact-mod}
this implies that the cokernel of $F_1 \to F_0$ is
flat. This proves the theorem in the Noetherian case.
\end{proof}








\section{Openness of Cohen-Macaulay loci}
\label{section-CM-open}

\noindent
In this section we characterize the Cohen-Macaulay property
of finite type algebras in terms of flatness. We then use this
to prove the set of points where such an algebra is Cohen-Macaulay
is open.

\begin{lemma}
\label{lemma-where-CM}
Let $S$ be a finite type algebra over a field $k$.
Let $\varphi : k[y_1, \ldots, y_d] \to S$ be a quasi-finite ring map.
As subsets of $\Spec(S)$ we have
$$
\{ \mathfrak q \mid
S_{\mathfrak q} \text{ flat over }k[y_1, \ldots, y_d]\}
=
\{ \mathfrak q \mid
S_{\mathfrak q} \text{ CM and }\dim_{\mathfrak q}(S/k) = d\}
$$
For notation see Definition \ref{definition-relative-dimension}.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be a prime. Denote
$\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$.
Note that always
$\dim(S_{\mathfrak q}) \leq \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$
by Lemma \ref{lemma-dimension-inequality-quasi-finite} for example.
Moreover, the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite and hence
$\text{trdeg}_k(\kappa(\mathfrak p)) = \text{trdeg}_k(\kappa(\mathfrak q))$.

\medskip\noindent
Let $\mathfrak q$ be an element of the left hand side.
Then Lemma \ref{lemma-finite-flat-over-regular-CM} applies
and we conclude that $S_{\mathfrak q}$ is Cohen-Macaulay
and $\dim(S_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$.
Combined with the equality of transcendence degrees above and
Lemma \ref{lemma-dimension-at-a-point-finite-type-field} this
implies that $\dim_{\mathfrak q}(S/k) = d$. Hence $\mathfrak q$
is an element of the right hand side.

\medskip\noindent
Let $\mathfrak q$ be an element of the right hand side.
By the equality of transcendence degrees above, the assumption
that $\dim_{\mathfrak q}(S/k) = d$ and
Lemma \ref{lemma-dimension-at-a-point-finite-type-field}
we conclude that
$\dim(S_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$.
Hence Lemma \ref{lemma-CM-over-regular-flat}
applies and we see that $\mathfrak q$ is an
element of the left hand side.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-over-field-CM-open}
Let $S$ be a finite type algebra over a field $k$.
The set of primes $\mathfrak q$ such that $S_{\mathfrak q}$ is
Cohen-Macaulay is open in $S$.
\end{lemma}

\noindent
This lemma is a special case of
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open} below,
so you can skip straight to the proof of that lemma if you like.

\begin{proof}
Let $\mathfrak q \subset S$ be a prime such that $S_{\mathfrak q}$ is
Cohen-Macaulay. We have to show there exists a
$g \in S$, $g \not \in \mathfrak q$ such that the ring
$S_g$ is Cohen-Macaulay. For any $g \in S$, $g \not \in \mathfrak q$
we may replace $S$ by $S_g$ and $\mathfrak q$ by $\mathfrak qS_g$.
Combining this with
Lemmas \ref{lemma-Noether-normalization-at-point} and
\ref{lemma-dimension-at-a-point-finite-type-field}
we may assume that there exists a finite injective
ring map $k[y_1, \ldots, y_d] \to S$ with
$d = \dim(S_{\mathfrak q}) + \text{trdeg}_k(\kappa(\mathfrak q))$.
Set $\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$.
By construction we see that $\mathfrak q$ is an element of
the right hand side of the displayed equality of
Lemma \ref{lemma-where-CM}. Hence it is also an element of
the left hand side.

\medskip\noindent
By Theorem \ref{theorem-openness-flatness} we see that for some $g \in S$,
$g \not \in \mathfrak q$ the ring $S_g$ is flat over $k[y_1, \ldots, y_d]$.
Hence by the equality of Lemma \ref{lemma-where-CM} again we conclude that
all local rings of $S_g$ are Cohen-Macaulay as desired.
\end{proof}

\begin{lemma}
\label{lemma-generic-CM}
Let $k$ be a field. Let $S$ be a finite type $k$ algebra.
The set of Cohen-Macaulay primes forms a dense open
$U \subset \Spec(S)$.
\end{lemma}

\begin{proof}
The set is open by Lemma \ref{lemma-finite-type-over-field-CM-open}.
It contains all minimal primes $\mathfrak q \subset S$
since the local ring at a minimal prime $S_{\mathfrak q}$
has dimension zero and hence is Cohen-Macaulay.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-flat-CM-locus-open}
Let $R$ be a ring. Let $R \to S$ be of finite presentation
and flat. For any $d \geq 0$ the set
$$
\left\{
\begin{matrix}
\mathfrak q \in \Spec(S)
\text{ such that setting }\mathfrak p = R \cap \mathfrak q
\text{ the fibre ring}\\
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
\text{ is Cohen-Macaulay}
\text{ and } \dim_{\mathfrak q}(S/R) = d
\end{matrix}
\right\}
$$
is open in $\Spec(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be an element of the set indicated, with
$\mathfrak p$ the corresponding prime of $R$.
We have to find a $g \in S$, $g \not \in \mathfrak q$ such that
all fibre rings of $R \to S_g$ are Cohen-Macaulay.
During the course of the proof we may (finitely many times)
replace $S$ by $S_g$ for a $g \in S$, $g \not \in \mathfrak q$.
Thus by Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
we may assume there is a quasi-finite ring map
$R[t_1, \ldots, t_d] \to S$ with $d = \dim_{\mathfrak q}(S/R)$.
Let $\mathfrak q' = R[t_1, \ldots, t_d] \cap \mathfrak q$.
By Lemma \ref{lemma-where-CM} we see that the ring map
$$
R[t_1, \ldots, t_d]_{\mathfrak q'} /
\mathfrak p R[t_1, \ldots, t_d]_{\mathfrak q'}
\longrightarrow
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
$$
is flat. Hence by the crit\`ere de platitude par fibres
Lemma \ref{lemma-criterion-flatness-fibre} we see that
$R[t_1, \ldots, t_d]_{\mathfrak q'} \to S_{\mathfrak q}$ is flat.
Hence by Theorem \ref{theorem-openness-flatness} we see that
for some $g \in S$, $g \not \in \mathfrak q$ the ring map
$R[t_1, \ldots, t_d] \to S_g$ is flat. Replacing $S$ by $S_g$
we see that for every prime $\mathfrak r \subset S$,
setting $\mathfrak r' = R[t_1, \ldots, t_d] \cap \mathfrak r$
and $\mathfrak p' = R \cap \mathfrak r$
the local ring map
$R[t_1, \ldots, t_d]_{\mathfrak r'} \to S_{\mathfrak r}$ is flat.
Hence also the base change
$$
R[t_1, \ldots, t_d]_{\mathfrak r'} /
\mathfrak p' R[t_1, \ldots, t_d]_{\mathfrak r'}
\longrightarrow
S_{\mathfrak r}/\mathfrak p' S_{\mathfrak r}
$$
is flat. Hence by Lemma \ref{lemma-where-CM} applied with
$k = \kappa(\mathfrak p')$ we see
$\mathfrak r$ is in the set of the lemma
as desired.
\end{proof}

\begin{lemma}
\label{lemma-generic-CM-flat-finite-presentation}
Let $R$ be a ring. Let $R \to S$ be flat of finite presentation.
The set of primes $\mathfrak q$ such that the fibre ring
$S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$,
with $\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay
is open and dense in every fibre of $\Spec(S) \to \Spec(R)$.
\end{lemma}

\begin{proof}
The set, call it $W$, is open by
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open}.
It is dense in the fibres because the intersection of $W$
with a fibre is the corresponding set of the fibre
to which Lemma \ref{lemma-generic-CM} applies.
\end{proof}

\begin{lemma}
\label{lemma-extend-field-CM-locus}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $k \subset K$ be a field extension, and set $S_K = K \otimes_k S$.
Let $\mathfrak q \subset S$ be a prime of $S$.
Let $\mathfrak q_K \subset S_K$ be a prime of $S_K$ lying
over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay
if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
During the course of the proof we may (finitely many times) replace
$S$ by $S_g$ for any $g \in S$, $g \not \in \mathfrak q$. Hence
using Lemma \ref{lemma-Noether-normalization-at-point} we may
assume that $\dim(S) = \dim_{\mathfrak q}(S/k) =: d$ and
find a finite injective map $k[x_1, \ldots, x_d] \to S$.
Note that this also induces a finite injective map
$K[x_1, \ldots, x_d] \to S_K$ by base change.
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
we have $\dim_{\mathfrak q_K}(S_K/K) = d$.
Set $\mathfrak p = k[x_1, \ldots, x_d] \cap \mathfrak q$
and $\mathfrak p_K = K[x_1, \ldots, x_d] \cap \mathfrak q_K$.
Consider the following commutative diagram of Noetherian local
rings
$$
\xymatrix{
S_{\mathfrak q} \ar[r] &
(S_K)_{\mathfrak q_K} \\
k[x_1, \ldots, x_d]_{\mathfrak p} \ar[r] \ar[u] &
K[x_1, \ldots, x_d]_{\mathfrak p_K} \ar[u]
}
$$
By Lemma \ref{lemma-where-CM} we have to show that
the left vertical arrow is flat if and only if the right
vertical arrow is flat. Because the bottom arrow is flat
this equivalence holds by Lemma \ref{lemma-base-change-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-CM-locus-commutes-base-change}
Let $R$ be a ring. Let $R \to S$ be of finite type.
Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$.
Denote $f : \Spec(S') \to \Spec(S)$ the map
associated to the ring map $S \to S'$.
Set $W$ equal to the
set of primes $\mathfrak q$ such that the fibre ring
$S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$,
$\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay,
and let $W'$ denote the analogue for $S'/R'$. Then
$W' = f^{-1}(W)$.
\end{lemma}

\begin{proof}
Trivial from Lemma \ref{lemma-extend-field-CM-locus} and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-relative-dimension-CM}
Let $R$ be a ring. Let $R \to S$ be a ring map which is (a) flat,
(b) of finite presentation, (c) has Cohen-Macaulay fibres. Then we can write
$S = S_0 \times \ldots \times S_n$ as a product of $R$-algebras $S_d$
such that each $S_d$ satisfies
(a), (b), (c) and has all fibres equidimensional of dimension $d$.
\end{lemma}

\begin{proof}
For each integer $d$ denote $W_d \subset \Spec(S)$ the set
defined in Lemma \ref{lemma-finite-presentation-flat-CM-locus-open}.
Clearly we have $\Spec(S) = \coprod W_d$, and each $W_d$
is open by the lemma we just quoted. Hence the result follows
from Lemma \ref{lemma-disjoint-implies-product}.
\end{proof}
















\section{Differentials}
\label{section-differentials}

\noindent
In this section we define the module of differentials of a ring map.

\begin{definition}
\label{definition-derivation}
Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module.
A {\it derivation}, or more precisely an
{\it $R$-derivation} into $M$ is a map $D : S \to M$
which is additive, annihilates elements of $\varphi(R)$,
and satisfies the {\it Leibniz rule}: $D(ab) = aD(b) + bD(a)$.
\end{definition}

\noindent
Note that $D(ra) = rD(a)$ if $r \in R$ and $a \in S$. An equivalent
definition is that an $R$-derivation is an $R$-linear map
$D : S \to M$ which satisfies the Leibniz rule.
The set of all $R$-derivations forms an
$S$-module: Given two $R$-derivations $D, D'$
the sum $D + D' : S \to M$, $a \mapsto D(a)+D'(a)$
is an $R$-derivation, and given an $R$-derivation $D$
and an element $c\in S$ the scalar multiple $cD : S \to M$,
$a \mapsto cD(a)$ is an $R$-derivation. We denote this
$S$-module
$$
\text{Der}_R(S, M).
$$
Also, if $\alpha : M \to N$ is an $S$-module map, then the
composition $\alpha \circ D$ is an $R$-derivation into
$N$. In this way the assignment $M \mapsto \text{Der}_R(S, M)$
is a covariant functor.

\medskip\noindent
Consider the following map of free $S$-modules
$$
\bigoplus\nolimits_{(a, b)\in S^2} S[(a, b)] \oplus
\bigoplus\nolimits_{(f, g)\in S^2} S[(f, g)] \oplus
\bigoplus\nolimits_{r\in R} S[r]
\longrightarrow
\bigoplus\nolimits_{a\in S} S[a]
$$
defined by the rules
$$
[(a, b)] \longmapsto [a + b] - [a] - [b],\quad
[(f, g)] \longmapsto [fg] -f[g] - g[f],\quad
[r]      \longmapsto [\varphi(r)]
$$
with obvious notation. Let $\Omega_{S/R}$ be the cokernel of this map.
There is a map $\text{d} : S \to \Omega_{S/R}$ which maps $a$ to the
class $\text{d}a$ of $[a]$ in the cokernel. This is an $R$-derivation
by the relations imposed on $\Omega_{S/R}$, in other words
$$
\text{d}(a + b) = \text{d}a + \text{d}b, \quad
\text{d}(fg) = f\text{d}g + g\text{d}f, \quad
\text{d}r = 0
$$
where $a,b,f,g \in S$ and $r \in R$.

\begin{definition}
\label{definition-differentials}
The pair $(\Omega_{S/R}, \text{d})$ is called the {\it module
of K\"ahler differentials} or the {\it module of differentials}
of $S$ over $R$.
\end{definition}

\begin{lemma}
\label{lemma-universal-omega}
\begin{slogan}
Maps out of the module of differentials are the same as derivations.
\end{slogan}
The module of differentials of $S$ over $R$ has the following
universal property. The map
$$
\Hom_S(\Omega_{S/R}, M)
\longrightarrow
\text{Der}_R(S, M), \quad
\alpha
\longmapsto
\alpha \circ \text{d}
$$
is an isomorphism of functors.
\end{lemma}

\begin{proof}
By definition an $R$-derivation is a rule which associates
to each $a \in S$ an element $D(a) \in M$. Thus $D$ gives
rise to a map $[D] : \bigoplus S[a] \to M$. However, the conditions
of being an $R$-derivation exactly mean that $[D]$ annihilates
the image of the map in the displayed presentation of
$\Omega_{S/R}$ above.
\end{proof}

\begin{lemma}
\label{lemma-colimit-differentials}
Let $I$ be a directed set.
Let $(R_i \to S_i, \varphi_{ii'})$ be a system of
ring maps over $I$, see
Categories, Section \ref{categories-section-posets-limits}.
Then we have
$$
\Omega_{S/R} =
\colim_i \Omega_{S_i/R_i}.
$$
where $R \to S = \colim (R_i \to S_i)$.
\end{lemma}

\begin{proof}
This is clear from the presentation of $\Omega_{S/R}$ given above.
\end{proof}


\begin{lemma}
\label{lemma-trivial-differential-surjective}
Suppose that $R \to S$ is surjective.
Then $\Omega_{S/R} = 0$.
\end{lemma}

\begin{proof}
You can see this either because all $R$-derivations
clearly have to be zero, or because
the map in the presentation of $\Omega_{S/R}$ is surjective.
\end{proof}

\noindent
Suppose that
\begin{equation}
\label{equation-functorial-omega}
\vcenter{
\xymatrix{
S \ar[r]_\varphi
&
S'
\\
R \ar[r]^\psi \ar[u]^\alpha
&
R' \ar[u]_\beta
}
}
\end{equation}
is a commutative diagram of rings. In this case there is a
natural map of modules of differentials fitting into the
commutative diagram
$$
\xymatrix{
\Omega_{S/R} \ar[r] &
\Omega_{S'/R'}
\\
S \ar[u]^{\text{d}} \ar[r]^{\varphi}
&
S' \ar[u]_{\text{d}}
}
$$
To construct the map just use the obvious map
between the presentations for $\Omega_{S/R}$ and $\Omega_{S'/R'}$.
Namely,
$$
\xymatrix{
\bigoplus S'[(a', b')]
\oplus
\bigoplus S'[(f', g')]
\oplus
\bigoplus S'[r'] \ar[r]
&
\bigoplus S' [a'] \\
 \\
\bigoplus S[(a, b)]
\oplus
\bigoplus S[(f, g)]
\oplus
\bigoplus S[r] \ar[r]
\ar[uu]^{
\begin{matrix}
[(a, b)] \mapsto [(\varphi(a), \varphi(b))] \\
[(f, g)] \mapsto [(\varphi(f), \varphi(g))] \\
[r]\mapsto [\psi(r)]
\end{matrix}
} &
\bigoplus S[a] \ar[uu]_{[a] \mapsto [\varphi(a)]}
}
$$
The result is simply that $f\text{d}g \in \Omega_{S/R}$ is
mapped to $\varphi(f)\text{d}\varphi(g)$.

\begin{lemma}
\label{lemma-differential-surjective}
In diagram (\ref{equation-functorial-omega}), suppose
that $S \to S'$ is surjective with kernel $I \subset S$.
Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with
kernel generated as an $S$-module by the elements
$\text{d}a$, where $a \in S$ is such that $\varphi(a) \in \beta(R')$.
(This includes in particular the elements $\text{d}(i)$, $i \in I$.)
\end{lemma}

\begin{proof}
Consider the map of presentations above. Clearly the right vertical
map of free modules is surjective. Thus the map is surjective.
A diagram chase shows that the following elements generate
the kernel as an $S$-module for sure: $i\text{d}a, i\in I, a \in S$,
and $\text{d}a$, with $a \in S$ such that
$\varphi(a) = \beta(r')$ for some $r' \in R'$.
Note that $\varphi(i) = \varphi(ia) = 0 = \beta(0)$, and that
$\text{d}(ia) = i\text{d}a + a \text{d}i$.
Hence $i\text{d}a = \text{d}(ia) - a \text{d}i$ is
an $S$-linear combination of elements of the second kind.
\end{proof}

\begin{lemma}
\label{lemma-exact-sequence-differentials}
Let $A \to B \to C$ be ring maps.
Then there is a canonical exact sequence
$$
C \otimes_B \Omega_{B/A} \to
\Omega_{C/A} \to
\Omega_{C/B} \to 0
$$
of $C$-modules.
\end{lemma}

\begin{proof}
We get a diagram (\ref{equation-functorial-omega}) by putting
$R = A$, $S = C$, $R' = B$, and $S' = C$.
By Lemma \ref{lemma-differential-surjective} the map
$\Omega_{C/A} \to \Omega_{C/B}$ is surjective, and the kernel
is generated by the elements $\text{d}(c)$, where $c \in C$
is in the image of $B \to C$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-differentials-localize}
Let $\varphi : A \to B$ be a ring map.
\begin{enumerate}
\item If $S \subset A$ is a multiplicative subset mapping to
invertible elements of $B$, then $\Omega_{B/A} = \Omega_{B/S^{-1}A}$.
\item If $S \subset B$ is a multiplicative subset then
$S^{-1}\Omega_{B/A} = \Omega_{S^{-1}B/A}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To show the equality of (1) it is enough to show that any
$A$-derivation $D : B \to M$ annihilates the elements $\varphi(s)^{-1}$.
This is clear from the Leibniz rule applied to
$1 = \varphi(s) \varphi(s)^{-1}$.
To show (2) note that there is an obvious map
$S^{-1}\Omega_{B/A} \to \Omega_{S^{-1}B/A}$.
To show it is an isomorphism it is enough to show that
there is a $A$-derivation $\text{d}'$ of $S^{-1}B$ into $S^{-1}\Omega_{B/A}$.
To define it we simply set
$\text{d}'(b/s) = (1/s)\text{d}b - (1/s^2)b\text{d}s$.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq}
In diagram (\ref{equation-functorial-omega}),
suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$.
Then there is a canonical exact sequence of $S'$-modules
$$
I/I^2
\longrightarrow
\Omega_{S/R} \otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
The leftmost map is characterized by the rule that
$f \in I$ maps to $\text{d}f \otimes 1$.
\end{lemma}

\begin{proof}
The middle term is $\Omega_{S/R} \otimes_S S/I$.
For $f \in I$ denote $\overline{f}$ the image of $f$ in $I/I^2$.
To show that the map $\overline{f} \mapsto \text{d}f \otimes 1$
is well defined we just have to check that
$\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in I$.
And this is clear from the Leibniz rule
$\text{d} f_1f_2 \otimes 1 = (f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1 =
\text{d}f_2 \otimes f_1 + \text{d}f_1 \otimes f_2 = 0$.
A similar computation show this map is $S' = S/I$-linear.

\medskip\noindent
The map $\Omega_{S/R} \otimes_S S' \to \Omega_{S'/R}$
is the canonical $S'$-linear map associated to the
$S$-linear map $\Omega_{S/R} \to \Omega_{S'/R}$.
It is surjective because $\Omega_{S/R} \to \Omega_{S'/R}$
is surjective by Lemma \ref{lemma-differential-surjective}.

\medskip\noindent
The composite of the two maps is zero because
$\text{d}f$ maps to zero in $\Omega_{S'/R}$
for $f \in I$. Note that exactness just says that
the kernel of $\Omega_{S/R} \to \Omega_{S'/R}$
is generated as an $S$-submodule by the submodule $I\Omega_{S/R}$ together
with the elements $\text{d}f$, with $f \in I$. We know by
Lemma \ref{lemma-differential-surjective}
that this kernel is generated by the elements $\text{d}(a)$
where $\varphi(a) = \beta(r)$ for some $r \in R$.
But then $a = \alpha(r) + a - \alpha(r)$, so
$\text{d}(a) = \text{d}(a - \alpha(r))$. And
$a - \alpha(r) \in I$ since $\varphi(a - \alpha(r)) =
\varphi(a) - \varphi(\alpha(r)) = \beta(r) - \beta(r) = 0$.
We conclude the elements $\text{d}f$ with $f \in I$ already
generate the kernel as an $S$-module, as desired.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq-split}
In diagram (\ref{equation-functorial-omega}),
suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$. Moreover, assume that there exists
an $R$-algebra map $S' \to S$ which is a right inverse to
$S \to S'$. Then the exact sequence of $S'$-modules
of Lemma \ref{lemma-differential-seq} turns into a short exact sequence
$$
0 \longrightarrow
I/I^2
\longrightarrow
\Omega_{S/R} \otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
which is even a split short exact sequence.
\end{lemma}

\begin{proof}
Let $\beta : S' \to S$ be the right inverse to the surjection
$\alpha : S \to S'$, so $S = I \oplus \beta(S')$.
Clearly we can use $\beta : \Omega_{S'/R} \to \Omega_{S/R}$,
to get a right inverse to the map $\Omega_{S/R} \otimes_S S' \to \Omega_{S'/R}$.
On the other hand, consider the map
$$
D : S \longrightarrow I/I^2,
\quad
x \longmapsto x - \beta(\alpha(x))
$$
It is easy to show that $D$ is an $R$-derivation (omitted).
Moreover $x D(s) = 0$ if $x \in I, s \in S$. Hence, by the universal property
$D$ induces a map $\tau : \Omega_{S/R} \otimes_S S' \to I/I^2$.
We omit the verification that it is a left inverse to
$\text{d} : I/I^2  \to \Omega_{S/R} \otimes_S S'$. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-differential-mod-power-ideal}
Let $R \to S$ be a ring map. Let $I \subset S$ be an ideal.
Let $n \geq 1$ be an integer. Set $S' = S/I^{n + 1}$.
The map $\Omega_{S/R} \to \Omega_{S'/R}$ induces an
isomorphism
$$
\Omega_{S/R} \otimes_S S/I^n
\longrightarrow
\Omega_{S'/R} \otimes_{S'} S/I^n.
$$
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-differential-seq} and the fact that
$\text{d}(I^{n + 1}) \subset I^n\Omega_{S/R}$ by the
Leibniz rule for $\text{d}$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-base-change}
Suppose that we have ring maps $R \to R'$ and $R \to S$.
Set $S' = S \otimes_R R'$, so that we obtain a diagram
(\ref{equation-functorial-omega}). Then the canonical map defined above
induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.
\end{lemma}

\begin{proof}
Let $\text{d}' : S' = S \otimes_R R' \to \Omega_{S/R} \otimes_R R'$ denote the
map $\text{d}'( \sum a_i \otimes x_i ) = \text{d}(a_i) \otimes x_i$.
It exists because the map $S \times R' \to \Omega_{S/R} \otimes_R R'$,
$(a, x)\mapsto \text{d}a \otimes_R x$ is $R$-bilinear.
This is an $R'$-derivation, as can be verified by a simple computation.
We will show that $(\Omega_{S/R} \otimes_R R', \text{d}')$ satisfies
the universal property. Let $D : S' \to M'$ be an $R'$ derivation
into an $S'$-module. The composition $S \to S' \to M'$ is an $R$-derivation,
hence we get an $S$-linear map $\varphi_D : \Omega_{S/R} \to M'$. We may
tensor this with $R'$ and get the map $\varphi'_D :
\Omega_{S/R} \otimes_R R' \to M'$, $\varphi'_D(\eta \otimes x) =
x\varphi_D(\eta)$. It is clear that $D = \varphi'_D \circ \text{d}'$.
\end{proof}

\noindent
The multiplication map $S \otimes_R S \to S$ is the $R$-algebra
map which maps $a \otimes b$ to $ab$ in $S$. It is also an
$S$-algebra map, if we think of $S \otimes_R S$ as an $S$-algebra
via either of the maps $S \to S \otimes_R S$.

\begin{lemma}
\label{lemma-differentials-diagonal}
Let $R \to S$ be a ring map. Let $J = \Ker(S \otimes_R S \to S)$
be the kernel of the multiplication map. There is a canonical
isomorphism of $S$-modules $\Omega_{S/R} \to J/J^2$,
$a \text{d} b \mapsto a \otimes b - ab \otimes 1$.
\end{lemma}

\begin{proof}[First proof]
Apply Lemma \ref{lemma-differential-seq-split} to the commutative diagram
$$
\xymatrix{
S \otimes_R S \ar[r] & S \\
S \ar[r] \ar[u] & S \ar[u]
}
$$
where the left vertical arrow is $a \mapsto a \otimes 1$. We get the
exact sequence
$0 \to J/J^2 \to
\Omega_{S \otimes_R S/S} \otimes_{S \otimes_R S} S \to \Omega_{S/S} \to 0$.
By Lemma \ref{lemma-trivial-differential-surjective}
the term $\Omega_{S/S}$ is $0$, and we obtain an
isomorphism between the other two terms. We have
$\Omega_{S \otimes_R S/S} = \Omega_{S/R} \otimes_S (S \otimes_R S)$
by Lemma \ref{lemma-differentials-base-change} as $S \to S \otimes_R S$
is the base change of $R \to S$ and hence
$$
\Omega_{S \otimes_R S/S} \otimes_{S \otimes_R S} S =
\Omega_{S/R} \otimes_S (S \otimes_R S) \otimes_{S \otimes_R S} S =
\Omega_{S/R}
$$
We omit the verification that the map is given by the rule of the lemma.
\end{proof}

\begin{proof}[Second proof]
First we show that the rule $a \text{d} b \mapsto a \otimes b - ab \otimes 1$
is well defined. In order to do this we have to show
that $\text{d}r$ and $a\text{d}b + b \text{d}a - d(ab)$ map to zero.
The first because $r \otimes 1 - 1 \otimes r = 0$ by definition
of the tensor product. The second because
$$
(a \otimes b - ab \otimes 1) +
(b \otimes a - ba \otimes 1) -
(1 \otimes ab - ab \otimes 1)
=
(a \otimes 1 - 1\otimes a)(1\otimes b - b \otimes 1)
$$
is in $J^2$.

\medskip\noindent
We construct a map in the other direction.
We may think of $S \to S \otimes_R S$, $a \mapsto a \otimes 1$
as the base change of $R \to S$. Hence we have
$\Omega_{S \otimes_R S/S} = \Omega_{S/R} \otimes_S (S \otimes_R S)$,
by Lemma \ref{lemma-differentials-base-change}.
At this point the sequence of Lemma \ref{lemma-differential-seq} gives a map
$$
J/J^2  \to \Omega_{S \otimes_R S/ S} \otimes_{S \otimes_R S} S
= (\Omega_{S/R} \otimes_S (S \otimes_R S))\otimes_{S \otimes_R S} S
= \Omega_{S/R}.
$$
We leave it to the reader to see it is the inverse of the map
above.
\end{proof}




\begin{lemma}
\label{lemma-differentials-polynomial-ring}
If $S = R[x_1, \ldots, x_n]$, then
$\Omega_{S/R}$ is a finite free $S$-module with
basis $\text{d}x_1, \ldots, \text{d}x_n$.
\end{lemma}

\begin{proof}
We first show that $\text{d}x_1, \ldots, \text{d}x_n$
generate $\Omega_{S/R}$ as an $S$-module. To prove this
we show that $\text{d}g$ can be expressed as a
sum $\sum g_i \text{d}x_i$ for any $g \in R[x_1, \ldots, x_n]$.
We do this by induction on the (total) degree of $g$.
It is clear if the degree of $g$ is $0$, because then
$\text{d}g = 0$. If the degree of $g$ is $>0$, then
we may write $g$ as $c + \sum g_i x_i$ with $c\in R$
and $\deg(g_i) < \deg(g)$. By the Leibniz rule we have
$\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$,
and hence we win by induction.

\medskip\noindent
Consider the $R$-derivation $\partial / \partial x_i :
R[x_1, \ldots, x_n] \to R[x_1, \ldots, x_n]$. (We leave it to
the reader to define this; the defining property
being that $\partial / \partial x_i (x_j) = \delta_{ij}$.)
By the universal property this corresponds to an $S$-module map $l_i :
\Omega_{S/R} \to R[x_1, \ldots, x_n]$ which maps $\text{d}x_i$
to $1$ and $\text{d}x_j$ to $0$ for $j \not = i$.
Thus it is clear that there are no $S$-linear relations
among the elements $\text{d}x_1, \ldots, \text{d}x_n$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-presented}
Suppose $R \to S$ is of finite presentation.
Then $\Omega_{S/R}$ is a finitely presented
$S$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Write $I = (f_1, \ldots, f_m)$. According
to Lemma \ref{lemma-differential-seq} there is an exact sequence
of $S$-modules
$$
I/I^2
\to
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S
\to
\Omega_{S/R}
\to
0
$$
The result follows from the fact that $I/I^2$ is a finite
$S$-module (generated by the images of the $f_i$), and that
the middle term is finite free by
Lemma \ref{lemma-differentials-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-generated}
Suppose $R \to S$ is of finite type.
Then $\Omega_{S/R}$ is finitely generated
$S$-module.
\end{lemma}

\begin{proof}
This is very similar to, but easier than the proof
of Lemma \ref{lemma-differentials-finitely-presented}.
\end{proof}








\section{Finite order differential operators}
\label{section-differential-operators}

\noindent
In this section we introduce differential operators of finite order.

\begin{definition}
\label{definition-differential-operators}
Let $R \to S$ be a ring map. Let $M$, $N$ be $S$-modules.
Let $k \geq 0$ be an integer. We inductively define a
{\it differential operator $D : M \to N$ of order $k$}
to be an $R$-linear map such that for all $g \in S$ the map
$m \mapsto D(gm) - gD(m)$ is a differential operator of
order $k - 1$. For the base case $k = 0$ we define a
differential operator of order $0$ to be an $S$-linear map.
\end{definition}

\noindent
If $D : M \to N$ is a differential operator of order $k$,
then for all $g \in S$ the map $gD$ is a differential operator
of order $k$. The sum of two differential operators of order $k$
is another. Hence the set of all these
$$
\text{Diff}^k(M, N) = \text{Diff}^k_{S/R}(M, N)
$$
is an $S$-module. We have
$$
\text{Diff}^0(M, N) \subset
\text{Diff}^1(M, N) \subset
\text{Diff}^2(M, N) \subset \ldots
$$

\begin{lemma}
\label{lemma-composition-differential-operators}
Let $R \to S$ be a ring map. Let $L, M, N$ be $S$-modules.
If $D : L \to M$ and $D' : M \to N$ are differential
operators of order $k$ and $k'$, then $D' \circ D$ is a
differential operator of order $k + k'$.
\end{lemma}

\begin{proof}
Let $g \in S$. Then the map which sends $x \in L$ to
$$
D'(D(gx)) - gD'(D(x)) = D'(D(gx)) - D'(gD(x)) + D'(gD(x)) - gD'(D(x))
$$
is a sum of two compositions of differential operators of lower order.
Hence the lemma follows by induction on $k + k'$.
\end{proof}

\begin{lemma}
\label{lemma-module-principal-parts}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Let $k \geq 0$. There exists an $S$-module $P^k_{S/R}(M)$
and a canonical isomorphism
$$
\text{Diff}^k_{S/R}(M, N) = \Hom_S(P^k_{S/R}(M), N)
$$
functorial in the $S$-module $N$.
\end{lemma}

\begin{proof}
The existence of $P^k_{S/R}(M)$ follows from general category theoretic
arguments (insert future reference here), but we will also give a
construction. Set $F = \bigoplus_{m \in M} S[m]$ where $[m]$ is a
symbol indicating the basis element in the summand corresponding to $m$.
Given any differential operator $D : M \to N$ we obtain an $S$-linear
map $L_D : F \to N$ sending $[m]$ to $D(m)$. If $D$ has order $0$,
then $L_D$ annihilates the elements
$$
[m + m'] - [m] - [m'],\quad
g_0[m] - [g_0m]
$$
where $g_0 \in S$ and $m, m' \in M$.
If $D$ has order $1$, then $L_D$ annihilates the elements
$$
[m + m'] - [m] - [m'],\quad
f[m] - [fm], \quad
g_0g_1[m] - g_0[g_1m] - g_1[g_0m] + [g_1g_0m]
$$
where
$f \in R$, $g_0, g_1 \in S$, and $m \in M$.
If $D$ has order $k$, then $L_D$ annihilates the elements
$[m + m'] - [m] - [m']$, $f[m] - [fm]$, and the elements
$$
g_0g_1\ldots g_k[m] - \sum g_0 \ldots \hat g_i \ldots g_k[g_im] + \ldots
+(-1)^{k + 1}[g_0\ldots g_km]
$$
Conversely, if $L : F \to N$ is an
$S$-linear map annihilating all the elements listed in the previous
sentence, then $m \mapsto L([m])$ is a differential operator
of order $k$. Thus we see that $P^k_{S/R}(M)$ is the quotient
of $F$ by the submodule generated by these elements.
\end{proof}

\begin{definition}
\label{definition-module-principal-parts}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module. The module
$P^k_{S/R}(M)$ constructed in Lemma \ref{lemma-module-principal-parts}
is called the {\it module of principal parts of order $k$} of $M$.
\end{definition}

\noindent
Note that the inclusions
$$
\text{Diff}^0(M, N) \subset
\text{Diff}^1(M, N) \subset
\text{Diff}^2(M, N) \subset \ldots
$$
correspond via Yoneda's lemma (Categories, Lemma \ref{categories-lemma-yoneda})
to surjections
$$
\ldots \to P^2_{S/R}(M) \to P^1_{S/R}(M) \to P^0_{S/R}(M) = M
$$

\begin{example}
\label{example-derivations-and-differential-operators}
Let $R \to S$ be a ring map and let $N$ be an $S$-module. Observe that
$\text{Diff}^1(S, N) = \text{Der}_R(S, N) \oplus N$.
Namely, if $D : S \to N$ is a differential operator of order $1$
then $\sigma_D : S \to N$ defined by $\sigma_D(g) := D(g) - gD(1)$
is an $R$-derivation and
$D = \sigma_D + \lambda_{D(1)}$ where $\lambda_x : S \to N$ is the
linear map sending $g$ to $gx$. It follows that
$P^1_{S/R} = \Omega_{S/R} \oplus S$ by the universal property of
$\Omega_{S/R}$.
\end{example}

\begin{lemma}
\label{lemma-sequence-of-principal-parts}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module. There is a
canonical short exact sequence
$$
0 \to \Omega_{S/R} \otimes_S M \to P^1_{S/R}(M) \to M \to 0
$$
functorial in $M$ called the {\it sequence of principal parts}.
\end{lemma}

\begin{proof}
The map $P^1_{S/R}(M) \to M$ is given above.
Let $N$ be an $S$-module and let $D : M \to N$ be a
differential operator of order $1$. For $m \in M$ the map
$$
g \longmapsto D(gm) - gD(m)
$$
is an $R$-derivation $S \to N$ by the axioms for differential operators
of order $1$. Thus it corresponds to a linear map $D_m : \Omega_{S/R} \to N$
determined by the rule $a\text{d}b \mapsto aD(bm) - abD(m)$
(see Lemma \ref{lemma-universal-omega}). The map
$$
\Omega_{S/R} \times M \longrightarrow N,\quad
(\eta, m) \longmapsto D_m(\eta)
$$
is $S$-bilinear (details omitted) and hence determines an $S$-linear
map
$$
\sigma_D : \Omega_{S/R} \otimes_S M \to N
$$
In this way we obtain a map
$\text{Diff}^1(M, N) \to \Hom_S(\Omega_{S/R} \otimes_S M, N)$,
$D \mapsto \sigma_D$ functorial in $N$. By the Yoneda lemma this corresponds
a map $\Omega_{S/R} \otimes_S M \to P^1_{S/R}(M)$. It is immediate
from the construction that this map is functorial in $M$. The sequence
$$
\Omega_{S/R} \otimes_S M \to P^1_{S/R}(M) \to M \to 0
$$
is exact because for every module $N$ the sequence
$$
0 \to \Hom_S(M, N) \to
\text{Diff}^1(M, N) \to
\Hom_S(\Omega_{S/R} \otimes_S M, N)
$$
is exact by inspection.

\medskip\noindent
To see that $\Omega_{S/R} \otimes_S M \to P^1_{S/R}(M)$ is injective
we argue as follows. Choose an exact sequence
$$
0 \to M' \to F \to M \to 0
$$
with $F$ a free $S$-module. This induces an exact sequence
$$
0 \to \text{Diff}^1(M, N) \to \text{Diff}^1(F, N) \to \text{Diff}^1(M', N)
$$
for all $N$. This proves that in the commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Omega_{S/R} \otimes_S M' \ar[r] \ar[d] &
P^1_{S/R}(M') \ar[r] \ar[d] &
M' \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\Omega_{S/R} \otimes_S F \ar[r] \ar[d] &
P^1_{S/R}(F) \ar[r] \ar[d] &
F \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\Omega_{S/R} \otimes_S M \ar[r] \ar[d] &
P^1_{S/R}(M) \ar[r] \ar[d] &
M \ar[r] \ar[d] &
0 \\
& 0 & 0 & 0
}
$$
the middle column is exact. The left column is exact by
right exactness of $\Omega_{S/R} \otimes_S -$. By the snake lemma
(see Section \ref{section-snake}) it suffices to prove exactness
on the left for the free module $F$.
Using that $P^1_{S/R}(-)$ commutes with direct sums we reduce to the case
$M = S$. This case is a consequence of the discussion in
Example \ref{example-derivations-and-differential-operators}.
\end{proof}

\begin{remark}
\label{remark-functoriality-principal-parts}
Suppose given a commutative diagram of rings
$$
\xymatrix{
B \ar[r] & B' \\
A \ar[u] \ar[r] & A' \ar[u]
}
$$
a $B$-module $M$, a $B'$-module $M'$, and a $B$-linear map $M \to M'$.
Then we get a compatible system of module maps
$$
\xymatrix{
\ldots \ar[r] &
P^2_{B'/A'}(M') \ar[r] &
P^1_{B'/A'}(M') \ar[r] &
P^0_{B'/A'}(M') \\
\ldots \ar[r] &
P^2_{B/A}(M) \ar[r] \ar[u] &
P^1_{B/A}(M) \ar[r] \ar[u] &
P^0_{B/A}(M) \ar[u]
}
$$
These maps are compatible with further composition of maps of this type.
The easiest way to see this is to use the description of the modules
$P^k_{B/A}(M)$ in terms of generators and relations in the proof of
Lemma \ref{lemma-module-principal-parts} but it can also be seen
directly from the universal
property of these modules. Moreover, these maps are compatible with
the short exact sequences of Lemma \ref{lemma-sequence-of-principal-parts}.
\end{remark}





\section{The naive cotangent complex}
\label{section-netherlander}

\noindent
Let $R \to S$ be a ring map. Denote $R[S]$ the polynomial ring
whose variables are the elements $s \in S$. Let's denote $[s] \in R[S]$
the variable corresponding to $s \in S$. Thus $R[S]$ is a free
$R$-module on the basis elements $[s_1] \ldots [s_n]$ where
$s_1, \ldots, s_n$ ranges over all unordered sequences of elements of $S$.
There is a canonical surjection
\begin{equation}
\label{equation-canonical-presentation}
R[S] \longrightarrow S,\quad [s] \longmapsto s
\end{equation}
whose kernel we denote $I \subset R[S]$. It is a simple observation that
$I$ is generated by the elements
$[s + s'] - [s] - [s']$, $[s][s'] - [ss']$ and $[r] - r$.
According to Lemma \ref{lemma-differential-seq}
there is a canonical map
\begin{equation}
\label{equation-naive-cotangent-complex}
I/I^2 \longrightarrow \Omega_{R[S]/R} \otimes_{R[S]} S
\end{equation}
whose cokernel is canonically isomorphic to $\Omega_{S/R}$. Observe that
the $S$-module $\Omega_{R[S]/R} \otimes_{R[S]} S$ is free on the generators
$\text{d}[s]$.

\begin{definition}
\label{definition-naive-cotangent-complex}
Let $R \to S$ be a ring map. The {\it naive cotangent complex}
$\NL_{S/R}$ is the chain complex (\ref{equation-naive-cotangent-complex})
$$
\NL_{S/R} = \left(I/I^2 \longrightarrow \Omega_{R[S]/R} \otimes_{R[S]} S\right)
$$
with $I/I^2$ placed in (homological) degree $1$ and
$\Omega_{R[S]/R} \otimes_{R[S]} S$ placed in degree $0$. We will denote
$H_1(L_{S/R}) = H_1(\NL_{S/R})$\footnote{This module is sometimes
denoted $\Gamma_{S/R}$ in the literature.} the homology in degree $1$.
\end{definition}

\noindent
Before we continue let us say a few words about the actual cotangent
complex (Cotangent, Section \ref{cotangent-section-cotangent-ring-map}).
Given a ring map $R \to S$ there exists a canonical simplicial
$R$-algebra $P_\bullet$ whose terms are polynomial algebras and
which comes equipped with a canonical homotopy equivalence
$$
P_\bullet \longrightarrow S
$$
The cotangent complex $L_{S/R}$ of $S$ over $R$ is defined as the chain
complex associated to the cosimplicial module
$$
\Omega_{P_\bullet/R} \otimes_{P_\bullet} S
$$
The naive cotangent complex as defined above is canonically isomorphic to
the truncation $\tau_{\leq 1}L_{S/R}$ (see
Homology, Section \ref{homology-section-truncations} and
Cotangent, Section \ref{cotangent-section-surjections}). In particular, it is
indeed the case that $H_1(\NL_{S/R}) = H_1(L_{S/R})$ so our definition is
compatible with the one using the cotangent complex. Moreover,
$H_0(L_{S/R}) = H_0(\NL_{S/R}) = \Omega_{S/R}$ as we've seen above.

\medskip\noindent
Let $R \to S$ be a ring map. A {\it presentation of $S$ over $R$} is
a surjection $\alpha : P \to S$ of $R$-algebras where $P$ is a polynomial
algebra (on a set of variables). Often, when $S$ is of finite type over $R$
we will indicate this by saying: ``Let $R[x_1, \ldots, x_n] \to S$ be a
presentation of $S/R$'', or
``Let $0 \to I \to R[x_1, \ldots, x_n] \to S \to 0$ be a presentation
of $S/R$'' if we want to indicate that $I$ is the kernel of the presentation.
Note that the map $R[S] \to S$ used to define the naive cotangent complex
is an example of a presentation.

\medskip\noindent
Note that for every presentation $\alpha$ we obtain a two term
chain complex of $S$-modules
$$
\NL(\alpha) : I/I^2 \longrightarrow \Omega_{P/R} \otimes_P S.
$$
Here the term $I/I^2$ is placed in degree $1$ and the term
$\Omega_{P/R} \otimes S$ is placed in degree $0$. The class of $f \in I$
in $I/I^2$ is mapped to $\text{d}f \otimes 1$ in $\Omega_{P/R} \otimes S$.
The cokernel of this complex is canonically $\Omega_{S/R}$,
see Lemma \ref{lemma-differential-seq}. We call the complex $\NL(\alpha)$
the {\it naive cotangent complex associated to the
presentation $\alpha : P \to S$ of $S/R$}. Note that if $P = R[S]$
with its canonical surjection onto $S$, then we recover $\NL_{S/R}$.
If $P = R[x_1, \ldots, x_n]$ then will sometimes use the notation
$I/I^2 \to \bigoplus_{i = 1, \ldots, n} S\text{d}x_i$
to denote this complex.

\medskip\noindent
Suppose we are given a commutative diagram
\begin{equation}
\label{equation-functoriality-NL}
\vcenter{
\xymatrix{
S \ar[r]_{\phi} & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
}
\end{equation}
of rings. Let $\alpha : P \to S$ be a presentation of $S$ over $R$ and let
$\alpha' : P' \to S'$ be a presentation of $S'$ over $R'$.
A {\it morphism of presentations from $\alpha : P \to S$ to
$\alpha' : P' \to S'$} is defined to be an $R$-algebra
map
$$
\varphi : P \to P'
$$
such that $\phi \circ \alpha = \alpha' \circ \varphi$. Note that
in this case $\varphi(I) \subset I'$, where $I = \Ker(\alpha)$
and $I' = \Ker(\alpha')$. Thus $\varphi$ induces a map
of $S$-modules $I/I^2 \to I'/(I')^2$ and by functoriality of
differentials also an $S$-module map
$\Omega_{P/R} \otimes S \to \Omega_{P'/R'} \otimes S'$.
These maps are compatible with the differentials of $\NL(\alpha)$ and
$\NL(\alpha')$ and we obtain a map of naive cotangent complexes
$$
\NL(\alpha) \longrightarrow \NL(\alpha').
$$
It is often convenient to consider the induced map
$\NL(\alpha) \otimes_S S' \to \NL(\alpha')$.

\medskip\noindent
In the special case that $P = R[S]$ and $P' = R'[S']$ the map
$\phi : S \to S'$ induces a canonical ring map
$\varphi : P \to P'$ by the rule $[s] \mapsto [\phi(s)]$.
Hence the construction above determines canonical(!) maps
of chain complexes
$$
\NL_{S/R} \longrightarrow \NL_{S'/R'},\quad\text{and}\quad
\NL_{S/R} \otimes_S S' \longrightarrow \NL_{S'/R'}
$$
associated to the diagram (\ref{equation-functoriality-NL}). Note that
this construction is compatible with composition: given a commutative
diagram
$$
\xymatrix{
S \ar[r]_{\phi} & S' \ar[r]_{\phi'} & S'' \\
R \ar[r] \ar[u] & R' \ar[u] \ar[r] & R'' \ar[u]
}
$$
we see that the composition of
$$
\NL_{S/R} \longrightarrow \NL_{S'/R'} \longrightarrow \NL_{S''/R''}
$$
is the map $\NL_{S/R} \to \NL_{S''/R''}$ given by the outer square.

\medskip\noindent
It turns out that $\NL(\alpha)$ is homotopy equivalent to $\NL_{S/R}$
and that the maps constructed above are well defined up to homotopy
(homotopies of maps of complexes are discussed in
Homology, Section \ref{homology-section-complexes}
but we also spell out the exact meaning of the statements in the lemma
below in its proof).

\begin{lemma}
\label{lemma-NL-homotopy}
Suppose given a diagram (\ref{equation-functoriality-NL}).
Let $\alpha : P \to S$ and $\alpha' : P' \to S'$ be presentations.
\begin{enumerate}
\item There exists a morphism of presentations from $\alpha$ to $\alpha'$.
\item Any two morphisms of presentations induce homotopic
morphisms of complexes $\NL(\alpha) \to \NL(\alpha')$.
\item The construction is compatible with compositions of morphisms
of presentations (see proof for exact statement).
\item If $R \to R'$ and $S \to S'$ are isomorphisms, then
for any map $\varphi$ of presentations from $\alpha$ to $\alpha'$
the induced map $\NL(\alpha) \to \NL(\alpha')$ is a homotopy equivalence
and a quasi-isomorphism.
\end{enumerate}
In particular, comparing $\alpha$ to the canonical presentation
(\ref{equation-canonical-presentation}) we conclude there is a
quasi-isomorphism $\NL(\alpha) \to \NL_{S/R}$ well defined
up to homotopy and compatible with all functorialities (up to homotopy).
\end{lemma}

\begin{proof}
Since $P$ is a polynomial algebra over $R$ we can write
$P = R[x_a, a \in A]$ for some set $A$.
As $\alpha'$ is surjective, we can choose
for every $a \in A$ an element $f_a \in P'$
such that $\alpha'(f_a) = \phi(\alpha(x_a))$. Let
$\varphi : P = R[x_a, a \in A] \to P'$ be the
unique $R$-algebra map such that $\varphi(x_a) = f_a$.
This gives the morphism in (1).

\medskip\noindent
Let $\varphi$ and $\varphi'$ morphisms of presentations from $\alpha$
to $\alpha'$. Let $I = \Ker(\alpha)$ and $I' = \Ker(\alpha')$.
We have to construct the diagonal map $h$ in the diagram
$$
\xymatrix{
I/I^2 \ar[r]^-{\text{d}}
\ar@<1ex>[d]^{\varphi'_1} \ar@<-1ex>[d]_{\varphi_1}
&
\Omega_{P/R} \otimes_P S
\ar@<1ex>[d]^{\varphi'_0} \ar@<-1ex>[d]_{\varphi_0}
\ar[ld]_h
\\
I'/(I')^2 \ar[r]^-{\text{d}}
&
\Omega_{P'/R'} \otimes_{P'} S'
}
$$
where the vertical maps are induced by $\varphi$, $\varphi'$ such that
$$
\varphi_1 - \varphi'_1 = h \circ \text{d}
\quad\text{and}\quad
\varphi_0 - \varphi'_0 = \text{d} \circ h
$$
Consider the map $\varphi - \varphi' : P \to P'$. Since both $\varphi$
and $\varphi$ are compatible with $\alpha$ and $\alpha'$ we obtain
$\varphi - \varphi' : P \to I'$. This implies that
$\varphi, \varphi' : P \to P'$ induce the same $P$-module structure
on $I'/(I')^2$, since
$\varphi(p)i' - \varphi'(p)i' = (\varphi - \varphi')(p)i' \in (I')^2$.
Also $\varphi - \varphi'$ is $R$-linear and
$$
(\varphi - \varphi')(fg) =
\varphi(f)(\varphi - \varphi')(g) + (\varphi - \varphi')(f)\varphi'(g)
$$
Hence the induced map $D : P \to I'/(I')^2$ is a $R$-derivation.
Thus we obtain a canonical map $h : \Omega_{P/R} \otimes_P S \to I'/(I')^2$
such that $D = h \circ \text{d}$. 
A calculation (omitted) shows that $h$ is the desired homotopy.

\medskip\noindent
Suppose that we have a commutative diagram
$$
\xymatrix{
S \ar[r]_{\phi} & S' \ar[r]_{\phi'} & S'' \\
R \ar[r] \ar[u] & R' \ar[u] \ar[r] & R'' \ar[u]
}
$$
and that
\begin{enumerate}
\item $\alpha : P \to S$,
\item $\alpha' : P' \to S'$, and
\item $\alpha'' : P'' \to S''$
\end{enumerate}
are presentations. Suppose that
\begin{enumerate}
\item $\varphi : P \to P$ is a morphism of presentations from
$\alpha$ to $\alpha'$ and
\item $\varphi' : P' \to P''$
is a morphism of presentations from $\alpha'$ to $\alpha''$.
\end{enumerate}
Then it is immediate that
$\varphi' \circ \varphi : P \to P''$
is a morphism of presentations from $\alpha$ to $\alpha''$ and that
the induced map $\NL(\alpha) \to \NL(\alpha'')$ of naive cotangent complexes
is the composition of the maps $\NL(\alpha) \to \NL(\alpha')$ and
$\NL(\alpha) \to \NL(\alpha')$ induced by $\varphi$ and $\varphi'$.

\medskip\noindent
In the simple case of complexes with 2 terms a quasi-isomorphism
is just a map that induces an isomorphism on both the cokernel
and the kernel of the maps between the terms. Note that homotopic
maps of 2 term complexes (as explained above) define the same maps on
kernel and cokernel. Hence if $\varphi$ is a map from a presentation
$\alpha$ of $S$ over $R$ to itself, then the induced map
$\NL(\alpha) \to \NL(\alpha)$ is a quasi-isomorphism being homotopic
to the identity by part (2). To prove (4) in full generality, consider
a morphism $\varphi'$ from $\alpha'$ to $\alpha$ which exists by (1).
The compositions $\NL(\alpha) \to \NL(\alpha') \to \NL(\alpha)$ and
$\NL(\alpha') \to \NL(\alpha) \to \NL(\alpha')$ are homotopic to the identity
maps by (3), hence these maps are homotopy equivalences by definition.
It follows formally that both maps
$\NL(\alpha) \to \NL(\alpha')$ and $\NL(\alpha') \to \NL(\alpha)$ are
quasi-isomorphisms. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-NL-polynomial-algebra}
Let $A \to B$ be a polynomial algebra. Then $\NL_{B/A}$ is homotopy equivalent
to the chain complex $(0 \to \Omega_{B/A})$ with $\Omega_{B/A}$
in degree $0$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-NL-homotopy}
and the fact that $\text{id}_B : B \to B$ is a presentation of $B$ over $A$
with zero kernel.
\end{proof}

\noindent
The following lemma is part of the motivation for introducing the
naive cotangent complex. The cotangent complex extends this
to a genuine long exact cohomology sequence. If $B \to C$ is a
local complete intersection, then one can extend the sequence with a
zero on the left, see
More on Algebra, Lemma \ref{more-algebra-lemma-transitive-lci-at-end}.

\begin{lemma}[Jacobi-Zariski sequence]
\label{lemma-exact-sequence-NL}
Let $A \to B \to C$ be ring maps. Choose a presentation
$\alpha : A[x_s, s \in S] \to B$ with kernel $I$. Choose a presentation
$\beta : B[y_t, t \in T] \to C$ with kernel $J$. Let
$\gamma : A[x_s, y_t] \to C$ be the induced presentation of $C$ with kernel
$K$. Then we get a canonical commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Omega_{A[x_s]/A} \otimes C \ar[r] &
\Omega_{A[x_s, y_t]/A} \otimes C \ar[r] &
\Omega_{B[y_t]/B} \otimes C \ar[r] &
0 \\
&
I/I^2 \otimes C \ar[r] \ar[u] &
K/K^2 \ar[r] \ar[u] &
J/J^2 \ar[r] \ar[u] &
0
}
$$
with exact rows. We get the following exact sequence
of homology groups
$$
H_1(\NL_{B/A} \otimes_B C) \to
H_1(L_{C/A}) \to
H_1(L_{C/B}) \to
C \otimes_B \Omega_{B/A} \to
\Omega_{C/A} \to
\Omega_{C/B} \to 0
$$
of $C$-modules extending the sequence of
Lemma \ref{lemma-exact-sequence-differentials}.
If $\text{Tor}_1^B(\Omega_{B/A}, C) = 0$, then
$H_1(\NL_{B/A} \otimes_B C) = H_1(L_{B/A}) \otimes_B C$.
\end{lemma}

\begin{proof}
The precise definition of the maps is omitted.
The exactness of the top row follows as the $\text{d}x_s$,
$\text{d}y_t$ form a basis for the middle module.
The map $\gamma$ factors
$$
A[x_s, y_t] \to B[y_t] \to C
$$
with surjective first arrow and second arrow equal to $\beta$.
Thus we see that $K \to J$ is surjective.
Moreover, the kernel of the first displayed arrow is
$IA[x_s, y_t]$. Hence $I/I^2 \otimes C$ surjects onto the
kernel of $K/K^2 \to J/J^2$. Finally, we can use
Lemma \ref{lemma-NL-homotopy}
to identify the terms as homology groups of the naive
cotangent complexes.
The final assertion follows as the degree $0$ term of the complex
$\NL_{B/A}$ is a free $B$-module.
\end{proof}

\begin{remark}
\label{remark-composition-homotopy-equivalent-to-zero}
Let $A \to B$ and $\phi : B \to C$ be ring maps.
Then the composition $\NL_{B/A} \to \NL_{C/A} \to \NL_{C/B}$ is
homotopy equivalent to zero. Namely, this composition is the functoriality
of the naive cotangent complex for the square
$$
\xymatrix{
B \ar[r]_\phi & C \\
A \ar[r] \ar[u] & B \ar[u]
}
$$
Write $J = \Ker(B[C] \to C)$. An explicit homotopy is given by the map
$\Omega_{A[B]/A} \otimes_A B \to J/J^2$ which maps the basis element
$\text{d}[b]$ to the class of $[\phi(b)] - b$ in $J/J^2$.
\end{remark}

\begin{lemma}
\label{lemma-NL-surjection}
Let $A \to B$ be a surjective ring map with kernel $I$.
Then $\NL_{B/A}$ is homotopy equivalent to the chain complex
$(I/I^2 \to 0)$ with $I/I^2$ in degree $1$. In particular
$H_1(L_{B/A}) = I/I^2$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-NL-homotopy}
and the fact that $A \to B$ is a presentation of $B$ over $A$.
\end{proof}

\begin{lemma}
\label{lemma-application-NL}
Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so
also $B \to C$ is). Denote $I = \Ker(A \to C)$ and
$J = \Ker(B \to C)$. Then the sequence
$$
I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0
$$
is exact.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-exact-sequence-NL}
and the description of the naive cotangent complexes
$\NL_{C/B}$ and $\NL_{C/A}$ in Lemma \ref{lemma-NL-surjection}.
\end{proof}

\begin{lemma}[Flat base change]
\label{lemma-change-base-NL}
Let $R \to S$ be a ring map. Let $\alpha : P \to S$ be a presentation.
Let $R \to R'$ be a flat ring map.
Let $\alpha' : P \otimes_R R' \to S' = S \otimes_R R'$
be the induced presentation.
Then $\NL(\alpha) \otimes_R R' = \NL(\alpha) \otimes_S S' = \NL(\alpha')$.
In particular, the canonical map
$$
\NL_{S/R} \otimes_R R' \longrightarrow \NL_{S \otimes_R R'/R'}
$$
is a homotopy equivalence if $R \to R'$ is flat.
\end{lemma}

\begin{proof}
This is true because
$\Ker(\alpha') = R' \otimes_R \Ker(\alpha)$
since $R \to R'$ is flat.
\end{proof}

\begin{lemma}
\label{lemma-colimits-NL}
Let $R_i \to S_i$ be a system of ring maps over the directed set $I$.
Set $R = \colim R_i$ and $S = \colim S_i$.
Then $\NL_{S/R} = \colim \NL_{S_i/R_i}$.
\end{lemma}

\begin{proof}
Recall that $\NL_{S/R}$ is the complex
$I/I^2 \to \bigoplus_{s \in S} S\text{d}[s]$ where $I \subset R[S]$
is the kernel of the canonical presentation $R[S] \to S$.
Now it is clear that $R[S] = \colim R_i[S_i]$ and similarly
that $I = \colim I_i$ where $I_i = \Ker(R_i[S_i] \to S_i)$.
Hence the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-NL-of-localization}
If $S \subset A$ is a multiplicative subset of $A$, then
$\NL_{S^{-1}A/A}$ is homotopy equivalent to the zero complex.
\end{lemma}

\begin{proof}
Since $A \to S^{-1}A$ is flat we see that
$\NL_{S^{-1}A/A} \otimes_A S^{-1}A \to \NL_{S^{-1}A/S^{-1}A}$
is a homotopy equivalence by flat base change
(Lemma \ref{lemma-change-base-NL}). Since the source of the arrow
is isomorphic to $\NL_{S^{-1}A/A}$ and the target of the arrow is
zero (by Lemma \ref{lemma-NL-surjection}) we win.
\end{proof}

\begin{lemma}
\label{lemma-NL-localize-bottom}
Let $S \subset A$ is a multiplicative subset of $A$.
Let $S^{-1}A \to B$ be a ring map.
Then $\NL_{B/A} \to \NL_{B/S^{-1}A}$ is an homotopy equivalence.
\end{lemma}

\begin{proof}
Choose a presentation $\alpha : P \to B$ of $B$ over $A$.
Then $\beta : S^{-1}P \to B$ is a presentation of $B$ over $S^{-1}A$.
A direct computation shows that we have $\NL(\alpha) = \NL(\beta)$
which proves the lemma as the naive cotangent complex is well defined
up to homotopy by Lemma \ref{lemma-NL-homotopy}.
\end{proof}

\begin{lemma}
\label{lemma-principal-localization-NL}
\begin{slogan}
The formation of the naive cotangent complex commutes with localization
at an element.
\end{slogan}
Let $A \to B$ be a ring map. Let $g \in B$. Suppose $\alpha : P \to B$
is a presentation with kernel $I$. Then a presentation of $B_g$ over $A$ is
the map
$$
\beta : P[x] \longrightarrow B_g
$$
extending $\alpha$ and sending $x$ to $1/g$.
The kernel $J$ of $\beta$ is generated by $I$ and the element $f x - 1$
where $f \in P$ is an element mapped to $g \in B$ by $\alpha$. In this
situation we have
\begin{enumerate}
\item $J/J^2 = (I/I^2)_g \oplus B_g (f x - 1)$,
\item $\Omega_{P[x]/A} \otimes_{P[x]} B_g =
\Omega_{P/A} \otimes_P B_g \oplus B_g \text{d}x$,
\item $\NL(\beta) \cong
\NL(\alpha) \otimes_B B_g \oplus (B_g \xrightarrow{g} B_g)$
\end{enumerate}
Hence the canonical map $\NL_{B/A} \otimes_B B_g \to \NL_{B_g/A}$
is a homotopy equivalence.
\end{lemma}

\begin{proof}
Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_g$ we get the statement about
$I$ and $fx - 1$ generating $J$. Consider the commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Omega_{P/A} \otimes B_g \ar[r] &
\Omega_{P[x]/A} \otimes B_g \ar[r] &
\Omega_{B[x]/B} \otimes B_g \ar[r] &
0 \\
&
(I/I^2)_g \ar[r] \ar[u] &
J/J^2 \ar[r] \ar[u] &
(gx - 1)/(gx - 1)^2 \ar[r] \ar[u] &
0
}
$$
with exact rows of Lemma \ref{lemma-exact-sequence-NL}.
The $B_g$-module $\Omega_{B[x]/B} \otimes B_g$ is free of
rank $1$ on $\text{d}x$. The element $\text{d}x$ in the
$B_g$-module $\Omega_{P[x]/A} \otimes B_g$ provides
a splitting for the top row. The element $gx - 1 \in (gx - 1)/(gx - 1)^2$
is mapped to $g\text{d}x$ in $\Omega_{B[x]/B} \otimes B_g$
and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_g$.
(This can also be seen by arguing that $gx - 1$ is a nonzerodivisor
in $B[x]$ because it is a polynomial with invertible constant term
and any nonzerodivisor gives a quasi-regular sequence of length $1$
by Lemma \ref{lemma-regular-quasi-regular}.)

\medskip\noindent
Let us prove $(I/I^2)_g \to J/J^2$ injective. Consider the $P$-algebra map
$$
\pi : P[x] \to (P/I^2)_f = P_f/I_f^2
$$
sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$
we see that $\pi(J) \subset (I/I^2)_f = (I/I^2)_g$. Since this
is an ideal of square zero we see that $\pi(J^2) = 0$.
If $a \in I$ maps to an element of $J^2$ in $J$, then
$\pi(a) = 0$, which implies that $a$ maps to zero in $I_f/I_f^2$.
This proves the desired injectivity.

\medskip\noindent
Thus we have a short exact sequence of two term complexes
$$
0 \to \NL(\alpha) \otimes_B B_g \to \NL(\beta)
\to (B_g \xrightarrow{g} B_g) \to 0
$$
Such a short exact sequence can always be split in the category of
complexes. In our particular case we can take as splittings
$$
J/J^2 = (I/I^2)_g \oplus B_g (fx - 1)\quad\text{and}\quad
\Omega_{P[x]/A} \otimes B_g = \Omega_{P/A} \otimes B_g \oplus
B_g (g^{-2}\text{d}f + \text{d}x)
$$
This works because
$\text{d}(fx - 1) = x\text{d}f + f \text{d}x =
g(g^{-2}\text{d}f + \text{d}x)$
in $\Omega_{P[x]/A} \otimes B_g$.
\end{proof}

\begin{lemma}
\label{lemma-localize-NL}
Let $A \to B$ be a ring map. Let $S \subset B$ be a multiplicative subset.
The canonical map $\NL_{B/A} \otimes_B S^{-1}B \to \NL_{S^{-1}B/A}$
is a quasi-isomorphism.
\end{lemma}

\begin{proof}
We have $S^{-1}B = \colim_{g \in S} B_g$ where we think of $S$
as a directed set (ordering by divisibility), see
Lemma \ref{lemma-localization-colimit}.
By Lemma \ref{lemma-principal-localization-NL} each of the maps
$\NL_{B/A} \otimes_B B_g \to \NL_{B_g/A}$
are quasi-isomorphisms.
The lemma follows from Lemma \ref{lemma-colimits-NL}.
\end{proof}

\begin{lemma}
\label{lemma-sum-two-terms}
Let $R$ be a ring.
Let $A_1 \to A_0$, and $B_1 \to B_0$ be
two two term complexes. Suppose that there exist
morphisms of complexes $\varphi : A_\bullet \to B_\bullet$
and $\psi : B_\bullet \to A_\bullet$ such that
$\varphi \circ \psi$ and $\psi \circ \varphi$ are
homotopic to the identity maps.
Then $A_1 \oplus B_0 \cong B_1 \oplus A_0$ as
$R$-modules.
\end{lemma}

\begin{proof}
Choose a map $h : A_0 \to A_1$ such that
$$
\text{id}_{A_1} - \psi_1 \circ \varphi_1 = h \circ d_A
\text{ and }
\text{id}_{A_0} - \psi_0 \circ \varphi_0 = d_A \circ h.
$$
Similarly, choose a map $h' : B_0 \to B_1$ such that
$$
\text{id}_{B_1} - \varphi_1 \circ \psi_1 = h' \circ d_B
\text{ and }
\text{id}_{B_0} - \varphi_0 \circ \psi_0 = d_B \circ h'.
$$
A trivial computation shows that
$$
\left(
\begin{matrix}
\text{id}_{A_1} & -h' \circ \psi_1 + h \circ \psi_0 \\
0 & \text{id}_{B_0}
\end{matrix}
\right)
=
\left(
\begin{matrix}
\psi_1 & h \\
-d_B & \varphi_0
\end{matrix}
\right)
\left(
\begin{matrix}
\varphi_1 & - h' \\
d_A & \psi_0
\end{matrix}
\right)
$$
This shows that both matrices on the right hand side
are invertible and proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-conormal-module}
Let $R \to S$ be a ring map of finite type.
For any presentations $\alpha : R[x_1, \ldots, x_n] \to S$, and
$\beta : R[y_1, \ldots, y_m] \to S$ we have
$$
I/I^2 \oplus S^{\oplus m} \cong J/J^2 \oplus S^{\oplus n}
$$
as $S$-modules where $I = \Ker(\alpha)$ and $J = \Ker(\beta)$.
\end{lemma}

\begin{proof}
See Lemmas \ref{lemma-NL-homotopy} and \ref{lemma-sum-two-terms}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-module-localize}
Let $R \to S$ be a ring map of finite type.
Let $g \in S$. For any presentations
$\alpha : R[x_1, \ldots, x_n] \to S$, and
$\beta : R[y_1, \ldots, y_m] \to S_g$ we have
$$
(I/I^2)_g \oplus S^{\oplus m}_g \cong J/J^2 \oplus S_g^{\oplus n}
$$
as $S_g$-modules where
$I = \Ker(\alpha)$ and $J = \Ker(\beta)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-conormal-module}, we see that it suffices to
prove this for a single choice of $\alpha$ and $\beta$. Thus we may take
$\beta$ the presentation of Lemma \ref{lemma-principal-localization-NL}
and the result is clear.
\end{proof}







\section{Local complete intersections}
\label{section-lci}

\noindent
The property of being a local complete intersection is an
intrinsic property of a Noetherian local ring.
This will be discussed in
Divided Power Algebra, Section \ref{dpa-section-lci}.
However, for the moment we just define this property for
finite type algebras over a field.

\begin{definition}
\label{definition-lci-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
\begin{enumerate}
\item We say that $S$ is a {\it global complete intersection over $k$}
if there exists a presentation $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
such that $\dim(S) = n - c$.
\item We say that $S$ is a {\it local complete intersection over $k$}
if there exists a covering $\Spec(S) = \bigcup D(g_i)$ such
that each of the rings $S_{g_i}$ is a global complete intersection
over $k$.
\end{enumerate}
We will also use the convention that the zero ring is a global
complete intersection over $k$.
\end{definition}

\noindent
Suppose $S$ is a global complete intersection
$S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
as in the definition.
Recall that $\dim(S) = n - c$ means that all irreducible
components of $\Spec(S)$ have dimension $\leq n - c$.
Since all maximal ideals of the polynomial ring have local
rings of dimension $n$ we conclude that all irreducible
components of $\Spec(S)$ have dimension $\geq n - c$.
See Section \ref{section-dimension}.
In other words, $\Spec(S)$ is equidimensional
of dimension $n - c$.

\begin{lemma}
\label{lemma-localize-lci}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $g \in S$.
\begin{enumerate}
\item If $S$ is a global complete intersection so is $S_g$.
\item If $S$ is a local complete intersection so is $S_g$.
\end{enumerate}
\end{lemma}

\begin{proof}
The second statement follows immediately from the first.
For the first, say that $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $n - c = \dim(S)$. By the remarks above $S$ is equidimensional
of dimension $n - c$, so $\dim(S_g) = n - c$ as well (or it is
the zero ring in which case the lemma is true by convention).
Let $g' \in k[x_1, \ldots, x_n]$
be an element whose residue class corresponds to $g$.
Then
$S_g =  k[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}g' - 1)$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-lci-CM}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
If $S$ is a local complete intersection, then
$S$ is a Cohen-Macaulay ring.
\end{lemma}

\begin{proof}
Choose a maximal prime $\mathfrak m$ of $S$.
We have to show that $S_\mathfrak m$ is Cohen-Macaulay.
By assumption we may assume $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $\dim(S) = n - c$. Let $\mathfrak m' \subset k[x_1, \ldots, x_n]$
be the maximal ideal corresponding to $\mathfrak m$.
According to Proposition \ref{proposition-finite-gl-dim-polynomial-ring}
the local ring
$k[x_1, \ldots, x_n]_{\mathfrak m'}$ is regular local of
dimension $n$. In particular it is Cohen-Macaulay by
Lemma \ref{lemma-regular-ring-CM}.
By Lemma \ref{lemma-one-equation} applied $c$ times the local ring
$S_{\mathfrak m} = k[x_1, \ldots, x_n]_{\mathfrak m'}/(f_1, \ldots, f_c)$
has dimension $\geq n - c$. By assumption $\dim(S_{\mathfrak m}) \leq n - c$.
Thus we get equality. This implies that $f_1, \ldots, f_c$ is a regular
sequence in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ and that
$S_{\mathfrak m}$ is Cohen-Macaulay, see Proposition
\ref{proposition-CM-module}.
\end{proof}

\noindent
The following is the technical key to the rest of the material in this
section. An important feature of this lemma is that we may choose any
presentation for the ring $S$, but that condition (1) does not depend
on this choice.

\begin{lemma}
\label{lemma-lci}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q$ be a prime of $S$.
Choose any presentation $S = k[x_1, \ldots, x_n]/I$.
Let $\mathfrak q'$ be the prime of $k[x_1, \ldots, x_n]$ corresponding
to $\mathfrak q$. Set
$c = \text{height}(\mathfrak q') - \text{height}(\mathfrak q)$,
in other words $\dim_{\mathfrak q}(S) = n - c$
(see Lemma \ref{lemma-codimension}). The following are equivalent
\begin{enumerate}
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a global complete intersection over $k$.
\item The ideal $I_{\mathfrak q'} \subset k[x_1, \ldots, x_n]_{\mathfrak q'}$
can be generated by $c$ elements.
\item The conormal module $(I/I^2)_{\mathfrak q}$ can be generated by
$c$ elements over $S_{\mathfrak q}$.
\item The conormal module $(I/I^2)_{\mathfrak q}$ is a free
$S_{\mathfrak q}$-module of rank $c$.
\item The ideal $I_{\mathfrak q'}$ can be generated by a regular sequence
in the regular local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$.
\end{enumerate}
In this case any $c$ elements of $I_{\mathfrak q'}$
which generate $I_{\mathfrak q'}/\mathfrak q'I_{\mathfrak q'}$
form a regular sequence in the local
ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$.
\end{lemma}

\begin{proof}
Set $R = k[x_1, \ldots, x_n]_{\mathfrak q'}$. This is a
Cohen-Macaulay local
ring of dimension $\text{height}(\mathfrak q')$, see for example
Lemma \ref{lemma-lci-CM}. Moreover,
$\overline{R} = R/IR = R/I_{\mathfrak q'} = S_{\mathfrak q}$
is a quotient of dimension $\text{height}(\mathfrak q)$.
Let $f_1, \ldots, f_c \in I_{\mathfrak q'}$ be elements
which generate $(I/I^2)_{\mathfrak q}$. By Lemma \ref{lemma-NAK}
we see that $f_1, \ldots, f_c$ generate $I_{\mathfrak q'}$.
Since the dimensions work out, we conclude
by Proposition \ref{proposition-CM-module} that
$f_1, \ldots, f_c$ is a regular sequence in $R$.
By Lemma \ref{lemma-regular-quasi-regular} we see that
$(I/I^2)_{\mathfrak q}$ is free.
These arguments show that (2), (3), (4) are equivalent and
that they imply the last statement of the lemma, and therefore
they imply (5).

\medskip\noindent
If (5) holds, say $I_{\mathfrak q'}$ is generated by a regular
sequence of length $e$, then
$\text{height}(\mathfrak q) = \dim(S_{\mathfrak q}) =
\dim(k[x_1, \ldots, x_n]_{\mathfrak q'}) - e =
\text{height}(\mathfrak q') - e$ by dimension theory,
see Section \ref{section-dimension}. We conclude that $e = c$.
Thus (5) implies (2).

\medskip\noindent
We continue with the notation introduced in the first paragraph.
For each $f_i$ we may find $d_i \in k[x_1, \ldots, x_n]$,
$d_i \not \in \mathfrak q'$ such that
$f_i' = d_i f_i \in k[x_1, \ldots, x_n]$.
Then it is still true that $I_{\mathfrak q'} = (f_1', \ldots, f_c')R$.
Hence there exists a $g' \in k[x_1, \ldots, x_n]$, $g' \not \in \mathfrak q'$
such that $I_{g'} = (f_1', \ldots, f_c')$.
Moreover, pick $g'' \in k[x_1, \ldots, x_n]$, $g'' \not \in \mathfrak q'$
such that $\dim(S_{g''}) = \dim_{\mathfrak q} \Spec(S)$.
By Lemma \ref{lemma-codimension} this dimension is equal to $n - c$.
Finally, set $g$ equal to the image of $g'g''$ in $S$.
Then we see that
$$
S_g \cong k[x_1, \ldots, x_n, x_{n + 1}]
/
(f_1', \ldots, f_c', x_{n + 1}g'g'' - 1)
$$
and by our choice of $g''$ this ring has dimension $n - c$.
Therefore it is a global complete intersection.
Thus each of (2), (3), and (4) implies (1).

\medskip\noindent
Assume (1). Let $S_g \cong k[y_1, \ldots, y_m]/(f_1, \ldots, f_t)$
be a presentation of $S_g$ as a global complete intersection.
Write $J = (f_1, \ldots, f_t)$. Let $\mathfrak q'' \subset k[y_1, \ldots, y_m]$
be the prime corresponding to $\mathfrak qS_g$. Note that
$t = m - \dim(S_g) =
\text{height}(\mathfrak q'') - \text{height}(\mathfrak q)$,
see Lemma \ref{lemma-codimension} for the last equality.
As seen in the proof of Lemma \ref{lemma-lci-CM} (and also above) the elements
$f_1, \ldots, f_t$ form a regular sequence in the local ring
$k[y_1, \ldots, y_m]_{\mathfrak q''}$.
By Lemma \ref{lemma-regular-quasi-regular} we see that
$(J/J^2)_{\mathfrak q}$ is free of rank $t$.
By Lemma \ref{lemma-conormal-module-localize} we have
$$
J/J^2 \oplus S_g^n \cong (I/I^2)_g \oplus S_g^m
$$
Thus $(I/I^2)_{\mathfrak q}$ is free of rank
$t + n - m = m - \dim(S_g) + n - m = n - \dim(S_g) =
\text{height}(\mathfrak q') - \text{height}(\mathfrak q) = c$.
Thus we obtain (4).
\end{proof}

\noindent
The result of Lemma \ref{lemma-lci} suggests the following definition.

\begin{definition}
\label{definition-lci-local-ring}
Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite type
over $k$. We say $S$ is a {\it complete intersection (over $k$)}
if there exists a local $k$-algebra $R$ and elements
$f_1, \ldots, f_c \in \mathfrak m_R$ such that
\begin{enumerate}
\item $R$ is essentially of finite type over $k$,
\item $R$ is a regular local ring,
\item $f_1, \ldots, f_c$ form a regular sequence in $R$, and
\item $S \cong R/(f_1, \ldots, f_c)$ as $k$-algebras.
\end{enumerate}
\end{definition}

\noindent
By the Cohen structure theorem (see
Theorem \ref{theorem-cohen-structure-theorem}) any complete
Noetherian local ring may be written as the quotient of some regular complete
local ring. Hence we may use the definition above to define the notion of
a complete intersection ring for any complete Noetherian local ring.
We will discuss this in
Divided Power Algebra, Section \ref{dpa-section-lci}.
In the meantime the following lemma shows that such a definition makes sense.

\begin{lemma}
\label{lemma-ci-well-defined}
Let $A \to B \to C$ be surjective local ring homomorphisms.
Assume $A$ and $B$ are regular local rings. The following are equivalent
\begin{enumerate}
\item $\Ker(A \to C)$ is generated by a regular sequence,
\item $\Ker(A \to C)$ is generated by $\dim(A) - \dim(C)$ elements,
\item $\Ker(B \to C)$ is generated by a regular sequence, and
\item $\Ker(B \to C)$ is generated by $\dim(B) - \dim(C)$ elements.
\end{enumerate}
\end{lemma}

\begin{proof}
A regular local ring is Cohen-Macaulay, see Lemma \ref{lemma-regular-ring-CM}.
Hence the equivalences (1) $\Leftrightarrow$ (2) and
(3) $\Leftrightarrow$ (4), see Proposition \ref{proposition-CM-module}.
By Lemma \ref{lemma-regular-quotient-regular}
the ideal $\Ker(A \to B)$ can be generated
by $\dim(A) - \dim(B)$ elements.
Hence we see that (4) implies (2).

\medskip\noindent
It remains to show that (1) implies (4). We do this by induction on
$\dim(A) - \dim(B)$. The case $\dim(A) - \dim(B) = 0$ is trivial.
Assume $\dim(A) > \dim (B)$.
Write $I = \Ker(A \to C)$ and $J = \Ker(A \to B)$.
Note that $J \subset I$. Our assumption is that the minimal number
of generators of $I$ is $\dim(A) - \dim(C)$.
Let $\mathfrak m \subset A$ be the maximal
ideal. Consider the maps
$$
J/ \mathfrak m J \to  I / \mathfrak m I \to \mathfrak m /\mathfrak m^2
$$
By Lemma \ref{lemma-regular-quotient-regular} and its proof the
composition is injective. Take any element $x \in J$ which is
not zero in $J /\mathfrak mJ$. By the above and Nakayama's lemma
$x$ is an element of a minimal set of generators of $I$.
Hence we may replace $A$ by $A/xA$ and $I$ by $I/xA$ which
decreases both $\dim(A)$ and the minimal number of generators of $I$
by $1$. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-lci-local}
Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite
type over $k$. The following are equivalent:
\begin{enumerate}
\item $S$ is a complete intersection over $k$,
\item for any surjection $R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ the ideal
$\Ker(R \to S)$ can be generated by a regular sequence,
\item for some surjection $R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ the ideal
$\Ker(R \to S)$ can be generated by
$\dim(R) - \dim(S)$ elements,
\item there exists a global complete intersection
$A$ over $k$ and a prime $\mathfrak a$ of $A$ such
that $S \cong A_{\mathfrak a}$, and
\item there exists a local complete intersection
$A$ over $k$ and a prime $\mathfrak a$ of $A$ such
that $S \cong A_{\mathfrak a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1) and (1) implies (3).
It is also clear that (4) implies (5). Let us show that (3) implies
(4). Thus we assume there exists a surjection
$R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ such that the ideal
$\Ker(R \to S)$ can be generated by $\dim(R) - \dim(S)$ elements.
We may write $R = (k[x_1, \ldots, x_n]/J)_{\mathfrak q}$
for some $J \subset k[x_1, \ldots, x_n]$ and
some prime $\mathfrak q \subset k[x_1, \ldots, x_n]$ with
$J \subset \mathfrak q$. Let $I \subset k[x_1, \ldots, x_n]$
be the kernel of the map $k[x_1, \ldots, x_n] \to S$ so that
$S \cong (k[x_1, \ldots, x_n]/I)_{\mathfrak q}$.
By assumption $(I/J)_{\mathfrak q}$ is generated by
$\dim(R) - \dim(S)$ elements. We conclude that
$I_{\mathfrak q}$ can be generated by
$\dim(k[x_1, \ldots, x_n]_{\mathfrak q}) - \dim(S)$ elements
by Lemma \ref{lemma-ci-well-defined}.
From Lemma \ref{lemma-lci} we see that for some
$g \in k[x_1, \ldots, x_n]$, $g \not \in \mathfrak q$
the algebra $(k[x_1, \ldots, x_n]/I)_g$ is a global
complete intersection and $S$ is isomorphic to
a local ring of it.

\medskip\noindent
To finish the proof of the lemma we have to show that (5) implies (2).
Assume (5) and let $\pi : R \to S$ be a surjection with $R$ a regular local
$k$-algebra essentially of finite type over $k$.
By assumption we have $S = A_{\mathfrak a}$ for some local
complete intersection $A$ over $k$.
Choose a presentation $R = (k[y_1, \ldots, y_m]/J)_{\mathfrak q}$
with $J \subset \mathfrak q \subset k[y_1, \ldots, y_m]$.
We may and do assume that $J$ is the kernel of the map
$k[y_1, \ldots, y_m] \to R$. Let $I \subset k[y_1, \ldots, y_m]$
be the kernel of the map $k[y_1, \ldots, y_m] \to S = A_{\mathfrak a}$.
Then $J \subset I$ and $(I/J)_{\mathfrak q}$ is the kernel of
the surjection $\pi : R \to S$. So
$S = (k[y_1, \ldots, y_m]/I)_{\mathfrak q}$.

\medskip\noindent
By Lemma \ref{lemma-isomorphic-local-rings} we see that there exist
$g \in A$, $g \not \in \mathfrak a$ and
$g' \in k[y_1, \ldots, y_m]$, $g' \not \in \mathfrak q$
such that $A_g \cong (k[y_1, \ldots, y_m]/I)_{g'}$.
After replacing $A$ by $A_g$ and $k[y_1, \ldots, y_m]$ by
$k[y_1, \ldots, y_{m + 1}]$ we may assume that
$A \cong k[y_1, \ldots, y_m]/I$. Consider the surjective
maps of local rings
$$
k[y_1, \ldots, y_m]_{\mathfrak q} \to R \to S.
$$
We have to show that the kernel of $R \to S$ is generated by
a regular sequence. By Lemma \ref{lemma-lci} we know that
$k[y_1, \ldots, y_m]_{\mathfrak q} \to A_{\mathfrak a} = S$
has this property (as $A$ is a local complete intersection over $k$).
We win by Lemma \ref{lemma-ci-well-defined}.
\end{proof}

\begin{lemma}
\label{lemma-lci-at-prime}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q$ be a prime of $S$. The following are
equivalent:
\begin{enumerate}
\item The local ring $S_{\mathfrak q}$ is a complete intersection
ring (Definition \ref{definition-lci-local-ring}).
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a local complete intersection over $k$.
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a global complete intersection over $k$.
\item For any presentation $S = k[x_1, \ldots, x_n]/I$ with
$\mathfrak q' \subset k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$
any of the equivalent conditions (1) -- (5) of Lemma \ref{lemma-lci} hold.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a combination of Lemmas \ref{lemma-lci} and \ref{lemma-lci-local}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-lci-global}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
The following are equivalent:
\begin{enumerate}
\item The ring $S$ is a local complete intersection over $k$.
\item All local rings of $S$ are complete intersection rings over $k$.
\item All localizations of $S$
at maximal ideals are complete intersection rings over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-lci-at-prime},
the fact that $\Spec(S)$ is quasi-compact and the definitions.
\end{proof}

\noindent
The following lemma says that being a complete intersection is
preserved under change of base field (in a strong sense).

\begin{lemma}
\label{lemma-lci-field-change-local}
Let $k \subset K$ be a field extension.
Let $S$ be a finite type algebra over $k$.
Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$
and let $\mathfrak q$ be the corresponding prime of $S$.
Then $S_{\mathfrak q}$ is a complete intersection
over $k$ (Definition \ref{definition-lci-local-ring})
if and only if $(S_K)_{\mathfrak q_K}$ is a complete
intersection over $K$.
\end{lemma}

\begin{proof}
Choose a presentation $S = k[x_1, \ldots, x_n]/I$.
This gives a presentation
$S_K = K[x_1, \ldots, x_n]/I_K$ where $I_K = K \otimes_k I$.
Let $\mathfrak q_K' \subset K[x_1, \ldots, x_n]$,
resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be
the corresponding prime. We will show that the equivalent conditions
of Lemma \ref{lemma-lci}
hold for the pair $(S = k[x_1, \ldots, x_n]/I, \mathfrak q)$
if and only if they hold for the pair
$(S_K = K[x_1, \ldots, x_n]/I_K, \mathfrak q_K)$.
The lemma will follow from this (see Lemma \ref{lemma-lci-at-prime}).

\medskip\noindent
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} we have
$\dim_{\mathfrak q} S = \dim_{\mathfrak q_K} S_K$.
Hence the integer $c$ occurring in Lemma \ref{lemma-lci}
is the same for the pair $(S = k[x_1, \ldots, x_n]/I, \mathfrak q)$
as for the pair $(S_K = K[x_1, \ldots, x_n]/I_K, \mathfrak q_K)$.
On the other hand we have
\begin{eqnarray*}
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q')
\otimes_{\kappa(\mathfrak q')} \kappa(\mathfrak q_K')
& = &
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
I \otimes_{k[x_1, \ldots, x_n]} K[x_1, \ldots, x_n]
\otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
(K \otimes_k I) \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
I_K \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q'_K).
\end{eqnarray*}
Therefore,
$\dim_{\kappa(\mathfrak q')}
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q')
=
\dim_{\kappa(\mathfrak q'_K)}
I_K \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K')$.
Thus it follows from
Nakayama's Lemma \ref{lemma-NAK} that the minimal number
of generators of $I_{\mathfrak q'}$ is the same as the minimal
number of generators of $(I_K)_{\mathfrak q'_K}$.
Thus the lemma follows from characterization (2) of Lemma \ref{lemma-lci}.
\end{proof}

\begin{lemma}
\label{lemma-lci-field-change}
Let $k \to K$ be a field extension.
Let $S$ be a finite type $k$-algebra.
Then $S$ is a local complete intersection over $k$ if and
only if $S \otimes_k K$ is a local complete intersection over $K$.
\end{lemma}

\begin{proof}
This follows from a combination of Lemmas
\ref{lemma-lci-global} and \ref{lemma-lci-field-change-local}.
But we also give a different
proof here (based on the same principles).

\medskip\noindent
Set $S' = S \otimes_k K$. Let $\alpha : k[x_1, \ldots, x_n] \to S$ be a
presentation with kernel $I$. Let $\alpha' : K[x_1, \ldots, x_n] \to S'$
be the induced presentation with kernel $I'$.

\medskip\noindent
Suppose that $S$ is a local complete intersection.
Pick a prime $\mathfrak q \subset S'$. Denote
$\mathfrak q'$ the corresponding prime of $K[x_1, \ldots, x_n]$,
$\mathfrak p$ the corresponding prime of $S$, and
$\mathfrak p'$ the corresponding prime of $k[x_1, \ldots, x_n]$.
Consider the following diagram of Noetherian local rings
$$
\xymatrix{
S'_{\mathfrak q} &  K[x_1, \ldots, x_n]_{\mathfrak q'} \ar[l] \\
S_{\mathfrak p}\ar[u] &  k[x_1, \ldots, x_n]_{\mathfrak p'} \ar[u] \ar[l]
}
$$
By Lemma \ref{lemma-lci} we know that $S_{\mathfrak p}$
is cut out by some regular sequence $f_1, \ldots, f_e$ in
$k[x_1, \ldots, x_n]_{\mathfrak p'}$. Since the right vertical
arrow is flat we see that the images of $f_1, \ldots, f_c$
form a regular sequence in $K[x_1, \ldots, x_n]_{\mathfrak q'}$.
Because tensoring with $K$ over $k$ is an exact functor we have
$S'_{\mathfrak q} = K[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_e)$.
Hence by Lemma \ref{lemma-lci} again we see that $S'$ is a local
complete intersection in a neighbourhood of $\mathfrak q$. Since
$\mathfrak q$ was arbitrary we see that $S'$ is a local complete
intersection over $K$.

\medskip\noindent
Suppose that $S'$ is a local complete intersection.
Pick a maximal ideal $\mathfrak m$ of $S$. Let $\mathfrak m'$
denote the corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
Denote $\kappa = \kappa(\mathfrak m)$ the residue field.
By Remark \ref{remark-fundamental-diagram} the primes of
$S'$ lying over $\mathfrak m$ correspond to primes
in $K \otimes_k \kappa$. By the Hilbert-Nullstellensatz
Theorem \ref{theorem-nullstellensatz} we have $[\kappa : k] < \infty$.
Hence $K \otimes_k \kappa$ is finite nonzero over $K$.
Hence $K \otimes_k \kappa$ has a finite number $> 0$ of primes
which are all maximal, each of which has a residue field
finite over $K$ (see Section \ref{section-artinian}).
Hence there are finitely many $> 0$ prime ideals
$\mathfrak n \subset S'$ lying over $\mathfrak m$,
each of which is maximal and  has a residue field
which is finite over $K$. Pick one, say $\mathfrak n \subset S'$,
and let $\mathfrak n' \subset K[x_1, \ldots, x_n]$ denote the corresponding
prime ideal of $K[x_1, \ldots, x_n]$.
Note that since $V(\mathfrak mS')$ is finite, we see that
$\mathfrak n$ is an isolated closed point of it, and we
deduce that $\mathfrak mS'_{\mathfrak n}$ is an ideal of definition
of $S'_{\mathfrak n}$. This implies that $\dim(S_{\mathfrak m})
\geq \dim(S'_{\mathfrak n})$, for example by
Lemma \ref{lemma-dimension-base-fibre-total}
or by the characterization of dimension
in terms of minimal number of generators of ideal of definition,
see Section \ref{section-dimension}. (In reality the dimensions
are equal but we do not need this.)
Consider the corresponding diagram of Noetherian local rings
$$
\xymatrix{
S'_{\mathfrak n} &  K[x_1, \ldots, x_n]_{\mathfrak n'} \ar[l] \\
S_{\mathfrak m}\ar[u] &  k[x_1, \ldots, x_n]_{\mathfrak m'} \ar[u] \ar[l]
}
$$
According to Lemma \ref{lemma-change-base-NL} we have
$\NL(\alpha) \otimes_S S' = \NL(\alpha')$, in particular
$I'/(I')^2 = I/I^2 \otimes_S S'$. Thus
$(I/I^2)_{\mathfrak m} \otimes_{S_{\mathfrak m}} \kappa$
and
$(I'/(I')^2)_{\mathfrak n} \otimes_{S'_{\mathfrak n}} \kappa(\mathfrak n)$
have the same dimension. Since $(I'/(I')^2)_{\mathfrak n}$
is free of rank $n - \dim S'_{\mathfrak n}$ we deduce that
$(I/I^2)_{\mathfrak m}$ can be generated by
$n - \dim S'_{\mathfrak n} \leq n - \dim S_{\mathfrak m}$ elements.
By Lemma \ref{lemma-lci} we see that $S$ is a local
complete intersection in a neighbourhood of $\mathfrak m$.
Since $\mathfrak m$ was any maximal ideal we conclude that
$S$ is a local complete intersection.
\end{proof}

\noindent
We end with a lemma which we will later use to prove that
given ring maps $T \to A \to B$ where $B$ is syntomic over $T$,
and $B$ is syntomic over $A$, then $A$ is syntomic over $T$.

\begin{lemma}
\label{lemma-lci-permanence-initial}
Let
$$
\xymatrix{
B & S \ar[l] \\
A \ar[u] & R \ar[l] \ar[u]
}
$$
be a commutative square of local rings. Assume
\begin{enumerate}
\item $R$ and $\overline{S} = S/\mathfrak m_R S$ are regular local rings,
\item $A = R/I$ and $B = S/J$ for some ideals $I$, $J$,
\item $J \subset S$ and
$\overline{J} = J/\mathfrak m_R \cap J \subset \overline{S}$
are generated by regular sequences, and
\item $A \to B$ and $R \to S$ are flat.
\end{enumerate}
Then $I$ is generated by a regular sequence.
\end{lemma}

\begin{proof}
Set $\overline{B} = B/\mathfrak m_RB = B/\mathfrak m_AB$ so that
$\overline{B} = \overline{S}/\overline{J}$.
Let $f_1, \ldots, f_{\overline{c}} \in J$ be elements such that
$\overline{f}_1, \ldots, \overline{f}_{\overline{c}} \in \overline{J}$
form a regular sequence generating $\overline{J}$.
Note that $\overline{c} = \dim(\overline{S}) - \dim(\overline{B})$,
see Lemma \ref{lemma-ci-well-defined}.
By Lemma \ref{lemma-grothendieck-regular-sequence}
the ring $S/(f_1, \ldots, f_{\overline{c}})$ is flat
over $R$. Hence $S/(f_1, \ldots, f_{\overline{c}}) + IS$ is flat over $A$.
The map $S/(f_1, \ldots, f_{\overline{c}}) + IS \to B$ is therefore a
surjection of finite $S/IS$-modules flat over $A$ which
is an isomorphism modulo $\mathfrak m_A$, and hence an
isomorphism by Lemma \ref{lemma-mod-injective}. In other words,
$J = (f_1, \ldots, f_{\overline{c}}) + IS$.

\medskip\noindent
By Lemma \ref{lemma-ci-well-defined} again the ideal $J$ is
generated by a regular sequence of $c = \dim(S) - \dim(B)$ elements. Hence
$J/\mathfrak m_SJ$ is a vector space of dimension $c$.
By the description of $J$ above there exist
$g_1, \ldots, g_{c - \overline{c}} \in I$ such that
$J$ is generated by
$f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}}$
(use Nakayama's Lemma \ref{lemma-NAK}). Consider the ring
$A' = R/(g_1, \ldots, g_{c - \overline{c}})$ and the surjection
$A' \to A$. We see from the above that
$B = S/(f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}})$
is flat over $A'$ (as $S/(f_1, \ldots, f_{\overline{c}})$ is flat
over $R$). Hence $A' \to B$ is injective (as it is faithfully flat,
see Lemma \ref{lemma-local-flat-ff}).
Since this map factors through $A$ we get $A' = A$.
Note that $\dim(B) = \dim(A) + \dim(\overline{B})$, and
$\dim(S) = \dim(R) + \dim(\overline{S})$, see
Lemma \ref{lemma-dimension-base-fibre-equals-total}.
Hence $c - \overline{c} = \dim(R) -\dim(A)$ by elementary algebra.
Thus $I = (g_1, \ldots, g_{c - \overline{c}})$ is generated
by a regular sequence according to Lemma \ref{lemma-ci-well-defined}.
\end{proof}






\section{Syntomic morphisms}
\label{section-syntomic}

\noindent
Syntomic ring maps are flat finitely presented ring maps all of whose fibers
are local complete intersections. We discuss general local complete
intersection ring maps in
More on Algebra, Section \ref{more-algebra-section-lci}.

\begin{definition}
\label{definition-lci}
A ring map $R \to S$ is called {\it syntomic}, or we say $S$ is a
{\it flat local complete intersection over $R$}
if it is flat, of finite presentation, and if all of its fibre rings
$S \otimes_R \kappa(\mathfrak p)$ are local complete intersections,
see Definition \ref{definition-lci-field}.
\end{definition}

\noindent
Clearly, an algebra over a field is syntomic over the field
if and only if it is a local complete intersection. Here is
a pleasing feature of this definition.

\begin{lemma}
\label{lemma-syntomic-descends}
\begin{slogan}
Being syntomic is fpqc local on the base.
\end{slogan}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is syntomic if and only if $R' \to S'$ is syntomic.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-presentation-descends} and
Lemma \ref{lemma-flatness-descends} this holds for the property
of being flat and for the property of being of finite presentation.
The map $\Spec(R') \to \Spec(R)$ is surjective,
see Lemma \ref{lemma-ff-rings}. Thus it suffices to show
given primes $\mathfrak p' \subset R'$ lying over $\mathfrak p \subset R$
that $S \otimes_R \kappa(\mathfrak p)$ is a local complete
intersection if and only if $S' \otimes_{R'} \kappa(\mathfrak p')$
is a local complete intersection. Note that
$S' \otimes_{R'} \kappa(\mathfrak p') =
S \otimes_R \kappa(\mathfrak p)
\otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')$.
Thus Lemma \ref{lemma-lci-field-change} applies.
\end{proof}

\begin{lemma}
\label{lemma-base-change-syntomic}
Any base change of a syntomic map is syntomic.
\end{lemma}

\begin{proof}
This is true for being flat, for being of finite presentation,
and for having local complete intersections as fibres by
Lemmas \ref{lemma-flat-base-change}, \ref{lemma-compose-finite-type} and
\ref{lemma-lci-field-change}.
\end{proof}

\begin{lemma}
\label{lemma-local-syntomic}
Let $R \to S$ be a ring map.
Suppose we have $g_1, \ldots g_m \in S$ which generate the
unit ideal such that each $R \to S_{g_i}$ is syntomic.
Then $R \to S$ is syntomic.
\end{lemma}

\begin{proof}
This is true for being flat and for being of finite presentation by
Lemmas \ref{lemma-flat-localization} and \ref{lemma-cover-upstairs}.
The property of having fibre rings which are local complete intersections
is local on $S$ by its very definition, see
Definition \ref{definition-lci-field}.
\end{proof}

\begin{definition}
\label{definition-relative-global-complete-intersection}
Let $R \to S$ be a ring map. We say that $R \to S$ is
a {\it relative global complete intersection} if we are
given a presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that
every nonempty fibre has dimension $n - c$.
\end{definition}

\noindent
The following lemma is occasionally useful to find
global presentations.

\begin{lemma}
\label{lemma-huber}
Let $S$ be a finitely presented $R$-algebra which has a presentation
$S = R[x_1, \ldots, x_n]/I$ such that $I/I^2$ is free over $S$. Then
$S$ has a presentation $S = R[y_1, \ldots, y_m]/(f_1, \ldots, f_c)$
such that $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with
basis given by the classes of $f_1, \ldots, f_c$.
\end{lemma}

\begin{proof}
Note that $I$ is a finitely generated ideal by
Lemma \ref{lemma-finite-presentation-independent}.
Let $f_1, \ldots, f_c \in I$ be elements which map to a basis of $I/I^2$.
By Nakayama's lemma (Lemma \ref{lemma-NAK})
there exists a $g \in 1 + I$ such that
$$
g \cdot I \subset (f_1, \ldots, f_c)
$$
Hence we see that
$$
S \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)[1/g]
\cong R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, gx_{n + 1} - 1)
$$
as desired. It follows that $f_1, \ldots, f_c,gx_{n + 1} - 1$
form a basis for
$(f_1, \ldots, f_c, gx_{n + 1} - 1)/(f_1, \ldots, f_c, gx_{n + 1} - 1)^2$
for example by applying Lemma \ref{lemma-principal-localization-NL}.
\end{proof}



\begin{example}
\label{example-factor-polynomials}
Let $n , m \geq 1$ be integers. Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_{n + m}]
& \longrightarrow &
S = \mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\
a_1 & \longmapsto & b_1 + c_1 \\
a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\
\ldots & \ldots & \ldots \\
a_{n + m} & \longmapsto & b_n c_m
\end{eqnarray*}
In other words, this is the unique ring map of polynomial rings
as indicated such that the polynomial factorization
$$
x^{n + m} + a_1 x^{n + m - 1} + \ldots + a_{n + m}
=
(x^n + b_1 x^{n - 1} + \ldots + b_n)
(x^m + c_1 x^{m - 1} + \ldots + c_m)
$$
holds. Note that $S$ is generated by $n + m$ elements over $R$
(namely, $b_i, c_j$) and that there are $n + m$ equations
(namely $a_k = a_k(b_i, c_j)$). In order to show that
$S$ is a relative global complete intersection over $R$ it suffices
to prove that all fibres have dimension $0$.

\medskip\noindent
To prove this, let $R \to k$ be a
ring map into a field $k$. Say $a_i$ maps to $\alpha_i \in k$.
Consider the fibre ring $S_k = k \otimes_R S$. Let $k \to K$ be
a field extension. A $k$-algebra map of $S_k \to K$ is the same thing as
finding $\beta_1, \ldots, \beta_n, \gamma_1, \ldots, \gamma_m \in K$
such that
$$
x^{n + m} + \alpha_1 x^{n + m - 1} + \ldots + \alpha_{n + m}
=
(x^n + \beta_1 x^{n - 1} + \ldots + \beta_n)
(x^m + \gamma_1 x^{m - 1} + \ldots + \gamma_m).
$$
Hence we see there are at most finitely many choices of
such $n + m$-tuples in $K$. This proves that all fibres
have finitely many closed points (use Hilbert's Nullstellensatz
to see they all correspond to solutions in $\overline{k}$ for example)
and hence that $R \to S$ is a relative global complete intersection.

\medskip\noindent
Another way to argue this is to show
$\mathbf{Z}[a_1, \ldots, a_{n + m}] \to
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]$ is actually
also a {\it finite} ring map. Namely, by Lemma \ref{lemma-polynomials-divide}
each of $b_i, c_j$ is integral over $R$, and hence $R \to S$ is
finite by Lemma \ref{lemma-characterize-integral}.
\end{example}

\begin{example}
\label{example-roots-universal-polynomial}
Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_n]
& \longrightarrow &
S = \mathbf{Z}[\alpha_1, \ldots, \alpha_n] \\
a_1 & \longmapsto &
\alpha_1 + \ldots + \alpha_n \\
\ldots & \ldots & \ldots \\
a_n & \longmapsto & \alpha_1 \ldots \alpha_n
\end{eqnarray*}
In other words this is the unique ring map of polynomial
rings as indicated
such that
$$
x^n + a_1 x^{n - 1} + \ldots + a_n
=
\prod\nolimits_{i = 1}^n (x + \alpha_i)
$$
holds in $\mathbf{Z}[\alpha_i, x]$. Another way to say this
is that $a_i$ maps to the $i$th elementary symmetric function
in $\alpha_1, \ldots, \alpha_n$. Note that $S$ is generated by
$n$ elements over $R$ subject to $n$ equations. Hence to show
that $S$ is a relative global complete intersection over
$R$ we have to show that the fibre rings $S \otimes_R \kappa(\mathfrak p)$
have dimension $0$. This follows as in
Example \ref{example-factor-polynomials} because the ring map
$\mathbf{Z}[a_1, \ldots, a_n] \to
\mathbf{Z}[\alpha_1, \ldots, \alpha_n]$ is actually {\it finite}
since each $\alpha_i \in S$
satisfies the monic equation $x^n - a_1 x^{n - 1} + \ldots + (-1)^n a_n$
over $R$.
\end{example}

\begin{lemma}
\label{lemma-adjoin-roots}
Suppose that $A$ is a ring, and
$P(x) = x^n + b_1 x^{n-1} + \ldots + b_n \in A[x]$ is
a monic polynomial over $A$. Then there exists a
syntomic, finite locally free, faithfully flat ring extension
$A \subset A'$ such that $P(x) = \prod_{i = 1, \ldots, n} (x - \beta_i)$
for certain $\beta_i \in A'$.
\end{lemma}

\begin{proof}
Take $A' = A \otimes_R S$, where $R$ and $S$ are as in
Example \ref{example-roots-universal-polynomial},
where $R \to A$ maps $a_i$ to $b_i$, and let
$\beta_i = -1 \otimes \alpha_i$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-relative-global-complete-intersection}
Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a
relative global complete intersection over $R$.
\begin{enumerate}
\item For any $R \to R'$ the base change
$R' \otimes_R S = R'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative
global complete intersection.
\item For any $g \in S$ which is the image of $h \in R[x_1, \ldots, x_n]$
the ring
$S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)$
is a relative global complete intersection.
\item If $R \to S$ factors as $R \to R_f \to S$ for some $f \in R$.
Then the ring $S = R_f[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a relative global complete intersection over $R_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-preserved-field-extension}
the fibres of a base change have the same dimension as the
fibres of the original map. Moreover
$R' \otimes_R R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
= R'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. Thus (1) follows.
The proof of (2) is that
the localization at one element can be described as
$S_g \cong S[x_{n + 1}]/(gx_{n + 1} - 1)$.
Assertion (3) follows from (1) since under the assumptions of (3) we have
$R_f \otimes_R S \cong S$.
\end{proof}

\begin{lemma}
\label{lemma-localize-relative-complete-intersection}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
We will find $h \in R[x_1, \ldots, x_n]$ which maps to $g \in S$ such that
$$
S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)
$$
is a relative global complete intersection over $R$ in each of the following
cases:
\begin{enumerate}
\item Let $I \subset R$ be an ideal. If the fibres of
$\Spec(S/IS) \to \Spec(R/I)$ have dimension $n - c$, then we can
find $(h, g)$ as above such that $g$ maps to $1 \in S/IS$.
\item Let $\mathfrak p \subset R$ be a prime. If
$\dim(S \otimes_R \kappa(\mathfrak p)) = n - c$, then we can
find $(h, g)$ as above such that $g$ maps to a unit of
$S \otimes_R \kappa(\mathfrak p)$.
\item Let $\mathfrak q \subset S$ be a prime lying over
$\mathfrak p \subset R$. If $\dim_{\mathfrak q}(S/R) = n - c$, then we can
find $(h, g)$ as above such that $g \not \in \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Ad (1). By Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
there exists an open subset $W \subset \Spec(S)$ containing $V(IS)$
such that all fibres of $W \to \Spec(R)$ have dimension $\leq n - c$.
Say $W = \Spec(S) \setminus V(J)$. Then $V(J) \cap V(IS) = \emptyset$
hence we can find a $g \in J$ which maps to $1 \in S/IS$.
Let $h \in R[x_1, \ldots, x_n]$ be any preimage of $g$.

\medskip\noindent
Ad (2). By Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
there exists an open subset $W \subset \Spec(S)$ containing
$\Spec(S \otimes_R \kappa(\mathfrak p))$
such that all fibres of $W \to \Spec(R)$ have dimension $\leq n - c$.
Say $W = \Spec(S) \setminus V(J)$. Then
$V(J \cdot S \otimes_R \kappa(\mathfrak p)) = \emptyset$.
Hence we can find a $g \in J$ which maps to a unit in
$S \otimes_R \kappa(\mathfrak p)$ (details omitted).
Let $h \in R[x_1, \ldots, x_n]$ be any preimage of $g$.

\medskip\noindent
Ad (3). By Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that all nonempty fibres of $R \to S_g$
have dimension $\leq n - c$. Let $h \in R[x_1, \ldots, x_n]$
be any element that maps to $g$.
\end{proof}

\noindent
The following lemma says we can do absolute Noetherian
approximation for relative complete intersections.

\begin{lemma}
\label{lemma-relative-global-complete-intersection-Noetherian}
Let $R$ be a ring. Let $S$ be a relative global complete intersection
with presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
There exist a finite type $\mathbf{Z}$-subalgebra $R_0 \subset R$
such that $f_i \in R_0[x_1, \ldots, x_n]$ and such that
$$
S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
is a relative global intersection over $R_0$.
\end{lemma}

\begin{proof}
Let $R_0 \subset R$ be the $\mathbf{Z}$-algebra of $R$ generated by all the
coefficients of the polynomials $f_1, \ldots, f_c$. Let
$S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Clearly, $S = R \otimes_{R_0} S_0$.
Pick a prime $\mathfrak q \subset S$ and denote
$\mathfrak p \subset R$, $\mathfrak q_0 \subset S_0$, and
$\mathfrak p_0 \subset R_0$ the primes it lies over.
Because $\dim (S \otimes_R \kappa(\mathfrak p) ) = n - c$
we also have $\dim (S_0 \otimes_{R_0} \kappa(\mathfrak p_0)) = n - c$,
see Lemma \ref{lemma-dimension-preserved-field-extension}.
By Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
there exists a $g \in S_0$, $g \not \in \mathfrak q_0$
such that all nonempty fibres of $R_0 \to (S_0)_g$
have dimension $\leq n - c$. As $\mathfrak q$ was arbitrary and
$\Spec(S)$ quasi-compact, we can find finitely many
$g_1, \ldots, g_m \in S_0$ such that (a) for $j = 1, \ldots, m$
the nonempty fibres of
$R_0 \to (S_0)_{g_j}$ have dimension $\leq n - c$ and (b) the image of
$\Spec(S) \to \Spec(S_0)$ is contained in $D(g_1) \cup \ldots \cup D(g_m)$.
In other words, the images of $g_1, \ldots, g_m$ in $S = R \otimes_{R_0} S_0$
generate the unit ideal. After increasing $R_0$ we may assume
that $g_1, \ldots, g_m$ generate the unit ideal in $S_0$. By (a)
the nonempty fibres of $R_0 \to S_0$ all have dimension $\leq n - c$
and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-conormal}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
be a relative global complete intersection. For every prime
$\mathfrak q$ of $S$, let $\mathfrak q'$ denote the corresponding
prime of $R[x_1, \ldots, x_n]$. Then
\begin{enumerate}
\item $f_1, \ldots, f_c$ is a regular sequence in the local ring
$R[x_1, \ldots, x_n]_{\mathfrak q'}$,
\item each of the rings
$R[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i)$ is flat over $R$, and
\item the $S$-module $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$
is free with basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$.
\end{enumerate}
\end{lemma}

\begin{proof}
First, by Lemma \ref{lemma-regular-quasi-regular}, part (3) follows
from part (1). Parts (1) and (2) immediately reduce to the Noetherian case
by Lemma \ref{lemma-relative-global-complete-intersection-Noetherian}
(some minor details omitted). Assume $R$ is Noetherian.
By Lemma \ref{lemma-lci} for example we see
that $f_1, \ldots, f_c$ form a regular sequence in the local ring
$R[x_1, \ldots, x_n]_{\mathfrak q'} \otimes_R \kappa(\mathfrak p)$.
Moreover, the local ring $R[x_1, \ldots, x_n]_{\mathfrak q'}$
is flat over $R_{\mathfrak p}$. Since $R$, and hence
$R[x_1, \ldots, x_n]_{\mathfrak q'}$ is Noetherian we
may apply Lemma \ref{lemma-grothendieck-regular-sequence}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection}
A relative global complete intersection is syntomic, i.e., flat.
\end{lemma}

\begin{proof}
Let $R \to S$ be a relative global complete intersection.
The fibres are global complete intersections, and
$S$ is of finite presentation over $R$.
Thus the only thing to prove is that $R \to S$ is flat.
This is true by (2) of
Lemma \ref{lemma-relative-global-complete-intersection-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-syntomic}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over
the prime $\mathfrak p$ of $R$.
The following are equivalent:
\begin{enumerate}
\item There exists an element $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is syntomic.
\item There exists an element $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a relative global complete intersection over $R$.
\item There exists an element $g \in S$, $g \not \in \mathfrak q$,
such that $R \to S_g$ is of finite presentation,
the local ring map $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat, and
the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is
a complete intersection ring over $\kappa(\mathfrak p)$ (see
Definition \ref{definition-lci-local-ring}).
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (3) is Lemma \ref{lemma-lci-at-prime}.
The implication (2) $\Rightarrow$ (1) is
Lemma \ref{lemma-relative-global-complete-intersection}.
It remains to show that (3) implies (2).

\medskip\noindent
Assume (3). After replacing $S$ by $S_g$ for some $g \in S$,
$g\not\in \mathfrak q$ we may assume $S$ is finitely presented over $R$.
Choose a presentation $S = R[x_1, \ldots, x_n]/I$.
Let $c = n - \dim_\mathfrak q(S/R)$. Let
$\mathfrak q' \subset R[x_1, \ldots, x_n]$ be the prime corresponding
to $\mathfrak q$. Write $\kappa(\mathfrak p) = k$.
Note that $S \otimes_R k = k[x_1, \ldots, x_n]/\overline{I}$ where
$\overline{I} \subset k[x_1, \ldots, x_n]$ is the ideal generated
by the image of $I$. Let $\overline{\mathfrak q}' \subset k[x_1, \ldots, x_n]$
be the prime ideal generated by the image of $\mathfrak q'$.
By Lemma \ref{lemma-lci-at-prime} we see that
Lemma \ref{lemma-lci} holds for $\overline{I}$ and $\overline{\mathfrak q}'$.
Thus the dimension of
$\overline{I}_{\overline{\mathfrak q}'}/
\overline{\mathfrak q}'\overline{I}_{\overline{\mathfrak q}'}$
over $\kappa(\overline{\mathfrak q}')$ is $c$.
Pick $f_1, \ldots, f_c \in I$ mapping to a basis of this vector space.
The images $\overline{f}_j \in \overline{I}$ generate
$\overline{I}_{\overline{\mathfrak q}'}$ (by Lemma \ref{lemma-lci}).
Set $S' = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. Let $J$ be the
kernel of the surjection $S' \to S$. Since $S$ is of finite presentation
$J$ is a finitely generated ideal
(Lemma \ref{lemma-compose-finite-type}). Consider the short exact sequence
$$
0 \to J \to S' \to S \to 0
$$
As $S_\mathfrak q$ is flat over $R$ we see that
$J_{\mathfrak q'} \otimes_R k \to S'_{\mathfrak q'} \otimes_R k$
is injective (Lemma \ref{lemma-flat-tor-zero}).
However, by construction $S'_{\mathfrak q'} \otimes_R k$
maps isomorphically to $S_\mathfrak q \otimes_R k$. Hence we
conclude that $J_{\mathfrak q'} \otimes_R k =
J_{\mathfrak q'}/\mathfrak pJ_{\mathfrak q'} = 0$. By Nakayama's
lemma (Lemma \ref{lemma-NAK}) we conclude that there exists a
$g \in R[x_1, \ldots, x_n]$, $g \not \in \mathfrak q'$ such that
$J_g = 0$. In other words $S'_g \cong S_g$. After further localizing
we see that $S'$ (and hence $S$) becomes a relative global complete
intersection by
Lemma \ref{lemma-localize-relative-complete-intersection}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-presentation-ideal-mod-squares}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/I$ for some
finitely generated ideal $I$. If $g \in S$ is such that
$S_g$ is syntomic over $R$, then $(I/I^2)_g$ is a finite projective
$S_g$-module.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-syntomic} there exist finitely many elements
$g_1, \ldots, g_m \in S$ which generate the unit ideal in $S_g$
such that each $S_{gg_j}$ is a relative global complete intersection
over $R$. Since it suffices to prove that $(I/I^2)_{gg_j}$ is
finite projective, see
Lemma \ref{lemma-finite-projective},
we may assume that $S_g$ is a relative global complete intersection.
In this case the result follows from
Lemmas \ref{lemma-conormal-module-localize} and
\ref{lemma-relative-global-complete-intersection-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-composition-syntomic}
Let $R \to S$, $S \to S'$ be ring maps.
\begin{enumerate}
\item If $R \to S$ and $S \to S'$ are syntomic, then $R \to S'$
is syntomic.
\item If $R \to S$ and $S \to S'$ are relative global complete intersections,
then $R \to S'$ is a relative global complete intersection.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $R \to S$ and $S \to S'$ are syntomic.
This implies that $R \to S'$ is flat by
Lemma \ref{lemma-composition-flat}.
It also implies that $R \to S'$ is of finite presentation by
Lemma \ref{lemma-compose-finite-type}.
Thus it suffices to show that the fibres of $R \to S'$ are
local complete intersections.
Choose a prime $\mathfrak p \subset R$.
We have a factorization
$$
\kappa(\mathfrak p) \to
S \otimes_R \kappa(\mathfrak p) \to
S' \otimes_R \kappa(\mathfrak p).
$$
By assumption $S \otimes_R \kappa(\mathfrak p)$ is
a local complete intersection, and by Lemma \ref{lemma-base-change-syntomic}
we see that $S \otimes_R \kappa(\mathfrak p)$ is syntomic over
$S \otimes_R \kappa(\mathfrak p)$.
After replacing $S$ by $S \otimes_R \kappa(\mathfrak p)$
and $S'$ by $S' \otimes_R \kappa(\mathfrak p)$ we may assume
that $R$ is a field. Say $R = k$.

\medskip\noindent
Choose a prime $\mathfrak q' \subset S'$ lying over the prime
$\mathfrak q$ of $S$. Our goal is to find a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that $S'_{g'}$ is a global complete
intersection over $k$. Choose a $g \in S$, $g \not \in \mathfrak q$
such that $S_g = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is
a global complete intersection over $k$.
Since $S_g \to S'_g$ is still syntomic also, and $g \not \in \mathfrak q'$
we may replace $S$ by $S_g$ and $S'$ by $S'_g$ and assume that
$S =  k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is
a global complete intersection over $k$. Next we choose a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that
$S' = S[y_1, \ldots, y_m]/(h_1, \ldots, h_d)$
is a relative global complete intersection over $S$.
Hence we have reduced to part (2) of the lemma.

\medskip\noindent
Suppose that $R \to S$ and $S \to S'$ are
relative global complete intersections. Say
$S =  R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
and
$S' = S[y_1, \ldots, y_m]/(h_1, \ldots, h_d)$.
Then
$$
S' \cong
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(f_1, \ldots, f_c, h'_1, \ldots, h'_d)
$$
for some lifts $h_j' \in R[x_1, \ldots, x_n, y_1, \ldots, y_m]$ of the $h_j$.
Hence it suffices to bound the dimensions of the fibres.
Thus we may yet again assume $R = k$ is a field.
In this case we see that we have a ring, namely $S$, which is of finite
type over $k$ and equidimensional of dimension $n - c$, and a
finite type ring map $S \to S'$ all of whose nonempty fibre
rings are equidimensional of dimension $m - d$. Then, by
Lemma \ref{lemma-dimension-base-fibre-total} for example applied
to localizations at maximal ideals of $S'$, we see that
$\dim(S') \leq n - c + m - d$ as desired.
\end{proof}

\noindent
The following lemma will be improved later, see
Smoothing Ring Maps, Proposition \ref{smoothing-proposition-lift-smooth}.

\begin{lemma}
\label{lemma-lift-syntomic}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be a syntomic map.
Then there exists elements $\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i} \cong S_i/IS_i$
for some relative global complete intersection $S_i$
over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-syntomic} we find a collection of elements
$\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i}$ is a relative
global complete intersection over $R/I$.
Hence we may assume that $\overline{S}$ is a
relative global complete intersection.
Write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$
as in Definition \ref{definition-relative-global-complete-intersection}.
Choose $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$
lifting $\overline{f}_1, \ldots, \overline{f}_c$.
Set $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Note that $S/IS \cong \overline{S}$.
By Lemma \ref{lemma-localize-relative-complete-intersection}
we can find $g \in S$ mapping to $1$ in $\overline{S}$ such
that $S_g$ is a relative global complete intersection over $R$.
Since $\overline{S} \cong S_g/IS_g$ this finishes the proof.
\end{proof}


\section{Smooth ring maps}
\label{section-smooth}

\noindent
Let us motivate the definition of a smooth ring map by an example.
Suppose $R$ is a ring and $S = R[x, y]/(f)$ for some nonzero $f \in R[x, y]$.
In this case there is an exact sequence
$$
S \to
S\text{d}x \oplus S\text{d}y \to
\Omega_{S/R} \to 0
$$
where the first arrow maps $1$ to
$\frac{\partial f}{\partial x} \text{d}x +
\frac{\partial f}{\partial y} \text{d}y$ see
Section \ref{section-netherlander}.
We conclude that $\Omega_{S/R}$ is locally free of rank $1$ if
the partial derivatives of $f$ generate the unit ideal in $S$.
In this case $S$ is smooth of relative dimension $1$ over $R$.
But it can happen that $\Omega_{S/R}$ is locally free of rank $2$
namely if both partial derivatives of $f$ are zero. For example if
for a prime $p$ we have $p = 0$ in $R$ and $f = x^p + y^p$ then this
happens. Here $R \to S$ is a relative global complete intersection
of relative dimension $1$ which is not smooth.
Hence, in order to check that a ring map
is smooth it is not sufficient to check whether the module of differentials
is free. The correct condition is the following.

\begin{definition}
\label{definition-smooth}
A ring map $R \to S$ is {\it smooth} if it is of finite presentation
and the naive cotangent complex $\NL_{S/R}$ is quasi-isomorphic to a
finite projective $S$-module placed in degree $0$.
\end{definition}

\noindent
In particular, if $R \to S$ is smooth then the module $\Omega_{S/R}$
is a finite projective $S$-module. Moreover, by
Lemma \ref{lemma-smooth-independent-presentation} the naive cotangent
complex of any presentation has the same structure. Thus, for a surjection
$\alpha : R[x_1, \ldots, x_n] \to S$ with kernel $I$ the map
$$
I/I^2
\longrightarrow
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S
$$
is a split injection. In other words
$\bigoplus_{i = 1}^n S \text{d}x_i \cong I/I^2 \oplus \Omega_{S/R}$
as $S$-modules. This implies that $I/I^2$ is a finite projective
$S$-module too!

\begin{lemma}
\label{lemma-smooth-independent-presentation}
Let $R \to S$ be a ring map of finite presentation.
If for some presentation $\alpha$ of $S$ over $R$ the
naive cotangent complex $\NL(\alpha)$ is quasi-isomorphic
to a finite projective $S$-module placed in degree $0$, then
this holds for any presentation.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-NL-homotopy}.
\end{proof}

\begin{lemma}
\label{lemma-localize-smooth}
Let $R \to S$ be a smooth ring map.
Any localization $S_g$ is smooth over $R$.
If $f \in R$ maps to an invertible element of $S$,
then $R_f \to S$ is smooth.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-localize-NL} the naive cotangent
complex for $S_g$ over $R$ is the base change of the naive cotangent
complex of $S$ over $R$. The assumption is that the naive cotangent
complex of $S/R$ is $\Omega_{S/R}$ and that this is a finite projective
$S$-module. Hence so is its base change. Thus $S_g$ is smooth over $R$.

\medskip\noindent
The second assertion follows in the same way from
Lemma \ref{lemma-NL-localize-bottom}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-smooth}
Let $R \to S$ be a smooth ring map.
Let $R \to R'$ be any ring map.
Then the base change $R' \to S' = R' \otimes_R S$ is smooth.
\end{lemma}

\begin{proof}
Let $\alpha : R[x_1, \ldots, x_n] \to S$ be a presentation
with kernel $I$. Let $\alpha' : R'[x_1, \ldots, x_n] \to R' \otimes_R S$
be the induced presentation. Let $I' = \Ker(\alpha')$.
Since $0 \to I \to R[x_1, \ldots, x_n] \to S \to 0$
is exact, the sequence
$R' \otimes_R I \to R'[x_1, \ldots, x_n] \to R' \otimes_R S \to 0$
is exact. Thus $R' \otimes_R I \to I'$ is surjective.
By Definition \ref{definition-smooth} there is a short exact sequence
$$
0 \to I/I^2 \to
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S \to
\Omega_{S/R} \to
0
$$
and the $S$-module $\Omega_{S/R}$ is finite projective.
In particular $I/I^2$ is a direct summand of
$\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S$.
Consider the commutative diagram
$$
\xymatrix{
R' \otimes_R (I/I^2) \ar[r] \ar[d] &
R' \otimes_R (\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S)
\ar[d] \\
I'/(I')^2 \ar[r] &
\Omega_{R'[x_1, \ldots, x_n]/R'}
\otimes_{R'[x_1, \ldots, x_n]} (R' \otimes_R S)
}
$$
Since the right vertical map is an isomorphism we see that
the left vertical map is injective and surjective by what was
said above. Thus we conclude that $\NL(\alpha')$ is quasi-isomorphic
to $\Omega_{S'/R'} \cong S' \otimes_S \Omega_{S/R}$.
And this is finite projective since it is the base change
of a finite projective module.
\end{proof}

\begin{lemma}
\label{lemma-smooth-over-field}
Let $k$ be a field.
Let $S$ be a smooth $k$-algebra.
Then $S$ is a local complete intersection.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-base-change-smooth} and
\ref{lemma-lci-field-change} it suffices to prove this when
$k$ is algebraically closed. Choose a presentation
$\alpha : k[x_1, \ldots, x_n] \to S$ with kernel $I$. Let $\mathfrak m$
be a maximal ideal of $S$, and let $\mathfrak m' \supset I$ be the
corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
We will show that condition (5) of
Lemma \ref{lemma-lci}
holds (with $\mathfrak m$ instead of $\mathfrak q$).
We may write $\mathfrak m' = (x_1 - a_1, \ldots, x_n - a_n)$
for some $a_i \in k$, because $k$ is algebraically closed, see
Theorem \ref{theorem-nullstellensatz}.
By our assumption that $k \to S$ is smooth the $S$-module map
$\text{d} : I/I^2 \to \bigoplus_{i = 1}^n S \text{d}x_i$
is a split injection. Hence the corresponding map
$I/\mathfrak m' I \to \bigoplus \kappa(\mathfrak m') \text{d}x_i$
is injective. Say $\dim_{\kappa(\mathfrak m')}(I/\mathfrak m' I) = c$
and pick $f_1, \ldots, f_c \in I$ which map to a $\kappa(\mathfrak m')$-basis
of $I/\mathfrak m' I$. By
Nakayama's Lemma \ref{lemma-NAK}
we see that $f_1, \ldots, f_c$ generate $I_{\mathfrak m'}$ over
$k[x_1, \ldots, x_n]_{\mathfrak m'}$. Consider the commutative diagram
$$
\xymatrix{
I \ar[r] \ar[d] & I/I^2 \ar[rr] \ar[d] & &
I/\mathfrak m'I \ar[d] \\
\Omega_{k[x_1, \ldots, x_n]/k} \ar[r] &
\bigoplus S\text{d}x_i \ar[rr]^{\text{d}x_i \mapsto x_i - a_i} & &
\mathfrak m'/(\mathfrak m')^2
}
$$
(proof commutativity omitted). The middle vertical map is the one defining
the naive cotangent complex of $\alpha$. Note that the right lower
horizontal arrow induces an isomorphism
$\bigoplus \kappa(\mathfrak m') \text{d}x_i \to \mathfrak m'/(\mathfrak m')^2$.
Hence our generators $f_1, \ldots, f_c$ of $I_{\mathfrak m'}$ map to a
collection of elements in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ whose
classes in $\mathfrak m'/(\mathfrak m')^2$ are linearly independent
over $\kappa(\mathfrak m')$. Therefore they form a regular sequence
in the ring $k[x_1, \ldots, x_n]_{\mathfrak m'}$ by
Lemma \ref{lemma-regular-ring-CM}.
This verifies condition (5) of
Lemma \ref{lemma-lci}
hence $S_g$ is a global complete intersection over $k$ for some
$g \in S$, $g \not \in \mathfrak m$. As this works for any maximal
ideal of $S$ we conclude that $S$ is a local complete intersection over $k$.
\end{proof}

\begin{definition}
\label{definition-standard-smooth}
Let $R$ be a ring. Given integers $n \geq c \geq 0$ and
$f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$ we say
$$
S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
is a {\it standard smooth algebra over $R$} if the polynomial
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
maps to an invertible element in $S$.
\end{definition}

\begin{lemma}
\label{lemma-standard-smooth}
Let
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c) = R[x_1, \ldots, x_n]/I$
be a standard smooth algebra. Then
\begin{enumerate}
\item the ring map $R \to S$ is smooth,
\item the $S$-module $\Omega_{S/R}$ is free on
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$,
\item the $S$-module $I/I^2$ is free on the classes of $f_1, \ldots, f_c$,
\item for any $g \in S$ the ring map $R \to S_g$ is standard smooth,
\item for any ring map $R \to R'$ the base change
$R' \to R'\otimes_R S$ is standard smooth,
\item if $f \in R$ maps to an invertible element in $S$, then
$R_f \to S$ is standard smooth, and
\item the ring $S$ is a relative global complete intersection over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the naive cotangent complex of the given presentation
$$
(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2
\longrightarrow
\bigoplus\nolimits_{i = 1}^n S \text{d}x_i
$$
Let us compose this map with the projection onto the first $c$ direct summands
of the direct sum. According to the definition of a standard smooth
algebra the classes $f_i \bmod (f_1, \ldots, f_c)^2$ map to a basis of
$\bigoplus_{i = 1}^c S\text{d}x_i$. We conclude that
$(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free of rank $c$ with
a basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$, and
that the homology in degree $0$, i.e., $\Omega_{S/R}$,
of the naive cotangent complex is a free $S$-module with basis the images of
$\text{d}x_{c + j}$, $j = 1, \ldots, n - c$.
In particular, this proves $R \to S$ is smooth.

\medskip\noindent
The proofs of (4) and (6) are omitted. But see the example below and
the proof of
Lemma \ref{lemma-base-change-relative-global-complete-intersection}.

\medskip\noindent
Let $\varphi : R \to R'$ be any ring map.
Denote $S' = R'[x_1, \ldots, x_n]/(f_1^\varphi, \ldots, f_c^\varphi)$
where $f^\varphi$ is the polynomial obtained from $f \in R[x_1, \ldots, x_n]$
by applying $\varphi$ to all the coefficients. Then $S' \cong R' \otimes_R S$.
Moreover, the determinant of Definition \ref{definition-standard-smooth}
for $S'/R'$ is equal to $g^\varphi$. Its image in $S'$ is therefore
the image of $g$ via $R[x_1, \ldots, x_n] \to S \to S'$
and hence invertible. This proves (5).

\medskip\noindent
To prove (7) it suffices to show that
$S \otimes_R \kappa(\mathfrak p)$ has dimension $n - c$.
By (5) it suffices to prove that any standard smooth
algebra $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
over a field $k$ has dimension $n - c$. We already
know that $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a local
complete intersection by Lemma \ref{lemma-smooth-over-field}.
Hence, since $I/I^2$ is free of rank $c$ we see that it dimension
$n - c$, by Lemma \ref{lemma-lci} for example.
\end{proof}

\begin{example}
\label{example-make-standard-smooth}
Let $R$ be a ring.
Let $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$.
Let
$$
h =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right).
$$
Set $S = R[x_1, \ldots, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}h - 1)$.
This is an example of a standard smooth algebra, except that the
presentation is wrong and the variables should be in the
following order:
$x_1, \ldots, x_c, x_{n + 1}, x_{c + 1}, \ldots, x_n$.
\end{example}

\begin{lemma}
\label{lemma-compose-standard-smooth}
A composition of standard smooth ring maps is standard smooth.
\end{lemma}

\begin{proof}
Suppose that $R \to S$ and $S \to S'$ are standard smooth. We choose
presentations
$S =  R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
and
$S' = S[y_1, \ldots, y_m]/(g_1, \ldots, g_d)$.
Choose elements $g_j' \in R[x_1, \ldots, x_n, y_1, \ldots, y_m]$ mapping
to the $g_j$. In this way we see
$S' = R[x_1, \ldots, x_n, y_1, \ldots, y_m]/
(f_1, \ldots, f_c, g'_1, \ldots, g'_d)$.
To show that $S'$ is standard smooth it suffices to verify
that the determinant
$$
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 &
\partial g_1/\partial x_1 &
\ldots &
\partial g_d/\partial x_1 \\
\ldots &
\ldots &
\ldots &
\ldots &
\ldots &
\ldots  \\
\partial f_1/\partial x_c &
\ldots &
\partial f_c/\partial x_c &
\partial g_1/\partial x_c &
\ldots &
\partial g_d/\partial x_c \\
0 &
\ldots &
0 &
\partial g_1/\partial y_1 &
\ldots &
\partial g_d/\partial y_1 \\
\ldots &
\ldots &
\ldots &
\ldots &
\ldots &
\ldots  \\
0 &
\ldots &
0 &
\partial g_1/\partial y_d &
\ldots &
\partial g_d/\partial y_d
\end{matrix}
\right)
$$
is invertible in $S'$. This is clear since it is the product
of the two determinants which were assumed to be invertible
by hypothesis.
\end{proof}

\begin{lemma}
\label{lemma-smooth-syntomic}
Let $R \to S$ be a smooth ring map.
There exists an open covering of $\Spec(S)$ by
standard opens $D(g)$ such that each $S_g$ is standard smooth
over $R$. In particular $R \to S$ is syntomic.
\end{lemma}

\begin{proof}
Choose a presentation $\alpha : R[x_1, \ldots, x_n] \to S$
with kernel $I = (f_1, \ldots, f_m)$. For every subset
$E \subset \{1, \ldots, m\}$ consider the open
subset $U_E$ where the classes $f_e, e\in E$ freely generate
the finite projective $S$-module $I/I^2$, see Lemma \ref{lemma-cokernel-flat}.
We may cover $\Spec(S)$ by standard opens $D(g)$ each
completely contained in one of the opens $U_E$. For such a $g$
we look at the presentation
$$
\beta : R[x_1, \ldots, x_n, x_{n + 1}] \longrightarrow S_g
$$
mapping $x_{n + 1}$ to $1/g$. Setting $J = \Ker(\beta)$ we
use Lemma \ref{lemma-principal-localization-NL} to see that
$J/J^2 \cong (I/I^2)_g \oplus S_g$ is free.
We may and do replace $S$ by $S_g$. Then using
Lemma \ref{lemma-huber} we may assume we have a presentation
$\alpha : R[x_1, \ldots, x_n] \to S$ with kernel $I = (f_1, \ldots, f_c)$
such that $I/I^2$ is free on the classes of $f_1, \ldots, f_c$.

\medskip\noindent
Using the presentation $\alpha$ obtained at the end of the previous
paragraph, we more or less repeat this argument with
the basis elements $\text{d}x_1, \ldots, \text{d}x_n$
of $\Omega_{R[x_1, \ldots, x_n]/R}$.
Namely, for any subset $E \subset \{1, \ldots, n\}$ of cardinality $c$
we may consider the open subset $U_E$ of $\Spec(S)$ where
the differential of $\NL(\alpha)$ composed with the projection
$$
S^{\oplus c} \cong I/I^2
\longrightarrow
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S
\longrightarrow
\bigoplus\nolimits_{i \in E} S\text{d}x_i
$$
is an isomorphism. Again we may find a covering of $\Spec(S)$
by (finitely many) standard opens $D(g)$ such that each $D(g)$
is completely contained in one of the opens $U_E$.
By renumbering, we may assume $E = \{1, \ldots, c\}$.
For a $g$ with $D(g) \subset U_E$ we look at the presentation
$$
\beta : R[x_1, \ldots, x_n, x_{n + 1}] \to S_g
$$
mapping $x_{n + 1}$ to $1/g$. Setting $J = \Ker(\beta)$
we conclude from Lemma \ref{lemma-principal-localization-NL}
that $J = (f_1, \ldots, f_c, fx_{n + 1} - 1)$ where $\alpha(f) = g$
and that the composition
$$
J/J^2 \longrightarrow
\Omega_{R[x_1, \ldots, x_{n + 1}]/R} \otimes_{R[x_1, \ldots, x_{n + 1}]} S_g
\longrightarrow
\bigoplus\nolimits_{i = 1}^c S_g\text{d}x_i \oplus S_g \text{d}x_{n + 1}
$$
is an isomorphism. Reordering the coordinates as
$x_1, \ldots, x_c, x_{n + 1}, x_{c + 1}, \ldots, x_n$
we conclude that $S_g$ is standard smooth over $R$ as desired.

\medskip\noindent
This finishes the proof as standard smooth algebras are syntomic
(Lemmas \ref{lemma-standard-smooth} and
\ref{lemma-relative-global-complete-intersection})
and being syntomic over $R$ is local on $S$
(Lemma \ref{lemma-local-syntomic}).
\end{proof}

\begin{definition}
\label{definition-smooth-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$.
We say $R \to S$ is {\it smooth at $\mathfrak q$} if there
exists a $g \in S$, $g \not \in \mathfrak q$ such
that $R \to S_g$ is smooth.
\end{definition}

\noindent
For ring maps of finite presentation we can characterize this as follows.

\begin{lemma}
\label{lemma-smooth-at-point}
Let $R \to S$ be of finite presentation. Let $\mathfrak q$ be a
prime of $S$. The following are equivalent
\begin{enumerate}
\item $R \to S$ is smooth at $\mathfrak q$,
\item $H_1(L_{S/R})_\mathfrak q = 0$ and
$\Omega_{S/R, \mathfrak q}$ is a projective $S_\mathfrak q$-module, and
\item $H_1(L_{S/R})_\mathfrak q = 0$ and
$\Omega_{S/R, \mathfrak q}$ is a flat $S_\mathfrak q$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use without further mention that formation of the
naive cotangent complex commutes with localization, see
Section \ref{section-netherlander}, especially
Lemma \ref{lemma-localize-NL}.
It is clear that (1) implies (2) implies (3). Assume (3) holds.
Note that $\Omega_{S/R}$ is a finitely presented $S$-module, see
Lemma \ref{lemma-differentials-finitely-presented}. Hence
$\Omega_{S/R, \mathfrak q}$ is a finite free module by
Lemma \ref{lemma-finite-flat-local}. Writing $S_\mathfrak q$ as
the colimit of principal localizations we see from
Lemma \ref{lemma-colimit-category-fp-modules}
that we can find a $g \in S$, $g \not \in \mathfrak q$ such that
$(\Omega_{S/R})_g$ is finite free. Choose a presentation
$\alpha : R[x_1, \ldots, x_n] \to S$ with kernel $I$. We may work
with $\NL(\alpha)$ instead of $\NL_{S/R}$, see
Lemma \ref{lemma-NL-homotopy}. The surjection
$$
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_R S \to \Omega_{S/R} \to 0
$$
has a right inverse after inverting $g$ because $(\Omega_{S/R})_g$ is
projective. Hence the image of
$\text{d} : (I/I^2)_g \to \Omega_{R[x_1, \ldots, x_n]/R} \otimes_R S_g$
is a direct summand and this map has a right inverse too.
We conclude that $H_1(L_{S/R})_g$ is a quotient of $(I/I^2)_g$.
In particular $H_1(L_{S/R})_g$ is a finite $S_g$-module.
Thus the vanishing of $H_1(L_{S/R})_{\mathfrak q}$
implies the vanishing of $H_1(L_{S/R})_{gg'}$ for some $g' \in S$,
$g' \not \in \mathfrak q$. Then $R \to S_{gg'}$ is smooth by
definition.
\end{proof}

\begin{lemma}
\label{lemma-locally-smooth}
Let $R \to S$ be a ring map.
Then $R \to S$ is smooth if and only if $R \to S$ is smooth
at every prime $\mathfrak q$ of $S$.
\end{lemma}

\begin{proof}
The direct implication is trivial. Suppose that $R \to S$ is smooth
at every prime $\mathfrak q$ of $S$. Since $\Spec(S)$ is
quasi-compact, see Lemma \ref{lemma-quasi-compact},
there exists a finite covering
$\Spec(S) = \bigcup D(g_i)$ such that each $S_{g_i}$ is
smooth. By Lemma \ref{lemma-cover-upstairs} this implies that
$S$ is of finite presentation over $R$. According to
Lemma \ref{lemma-localize-NL} we see that
$\NL_{S/R} \otimes_S S_{g_i}$ is quasi-isomorphic to a finite projective
$S_{g_i}$-module. By Lemma \ref{lemma-finite-projective}
this implies that $\NL_{S/R}$ is quasi-isomorphic to a finite
projective $S$-module.
\end{proof}

\begin{lemma}
\label{lemma-compose-smooth}
A composition of smooth ring maps is smooth.
\end{lemma}

\begin{proof}
You can prove this in many different ways. One way is to use
the snake lemma (Lemma \ref{lemma-snake}), the Jacobi-Zariski sequence
(Lemma \ref{lemma-exact-sequence-NL}), combined with the
characterization of projective modules as being
direct summands of free modules (Lemma \ref{lemma-characterize-projective}).
Another proof can be obtained by combining
Lemmas \ref{lemma-smooth-syntomic}, \ref{lemma-compose-standard-smooth}
and \ref{lemma-locally-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-smooth}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
be a relative global complete intersection.
Let $\mathfrak q \subset S$ be a prime. Then $R \to S$
is smooth at $\mathfrak q$ if and only if there exists a
subset $I \subset \{1, \ldots, n\}$ of cardinality $c$
such that the polynomial
$$
g_I = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i \in I}.
$$
does not map to an element of $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-relative-global-complete-intersection-conormal}
we see that the naive cotangent complex
associated to the given presentation of $S$ is the complex
$$
\bigoplus\nolimits_{j = 1}^c S \cdot f_j
\longrightarrow
\bigoplus\nolimits_{i = 1}^n S \cdot \text{d}x_i, \quad
f_j \longmapsto \sum \frac{\partial f_j}{\partial x_i} \text{d}x_i.
$$
The maximal minors of the matrix giving the map are exactly
the polynomials $g_I$.

\medskip\noindent
Assume $g_I$ maps to $g \in S$, with $g \not \in \mathfrak q$.
Then the algebra $S_g$ is smooth over $R$. Namely, its naive
cotangent complex is quasi-isomorphic to the complex above
localized at $g$, see Lemma \ref{lemma-localize-NL}. And by
construction it is quasi-isomorphic to a free rank $n - c$
module in degree $0$.

\medskip\noindent
Conversely, suppose that all $g_I$ end up in $\mathfrak q$.
In this case the complex above tensored with $\kappa(\mathfrak q)$
does not have maximal rank, and hence there is no localization
by an element $g \in S$, $g \not \in \mathfrak q$
where this map becomes a split injection. By Lemma \ref{lemma-localize-NL}
again there is no such localization which is smooth over $R$.
\end{proof}

\begin{lemma}
\label{lemma-flat-fibre-smooth}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over the
prime $\mathfrak p$ of $R$. Assume
\begin{enumerate}
\item there exists a $g \in S$, $g \not\in \mathfrak q$
such that $R \to S_g$ is of finite presentation,
\item the local ring homomorphism
$R_{\mathfrak p} \to S_{\mathfrak q}$ is flat,
\item the fibre $S \otimes_R \kappa(\mathfrak p)$ is smooth
over $\kappa(\mathfrak p)$ at the prime corresponding
to $\mathfrak q$.
\end{enumerate}
Then $R \to S$ is smooth at $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-syntomic} and \ref{lemma-smooth-over-field}
we see that there exists a $g \in S$ such that $S_g$ is a
relative global complete intersection. Replacing $S$ by $S_g$ we may assume
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative
global complete intersection.
For any subset $I \subset \{1, \ldots, n\}$ of cardinality
$c$ consider the polynomial
$g_I = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, i \in I}$
of Lemma \ref{lemma-relative-global-complete-intersection-smooth}.
Note that the image $\overline{g}_I$ of $g_I$ in the polynomial ring
$\kappa(\mathfrak p)[x_1, \ldots, x_n]$ is the determinant
of the partial derivatives of the images $\overline{f}_j$ of the $f_j$
in the ring $\kappa(\mathfrak p)[x_1, \ldots, x_n]$. Thus the lemma follows
by applying Lemma \ref{lemma-relative-global-complete-intersection-smooth}
both to $R \to S$ and to
$\kappa(\mathfrak p) \to S \otimes_R \kappa(\mathfrak p)$.
\end{proof}

\noindent
Note that the sets $U, V$ in the following lemma
are open by definition.

\begin{lemma}
\label{lemma-flat-base-change-locus-smooth}
Let $R \to S$ be a ring map of finite presentation.
Let $R \to R'$ be a flat ring map.
Denote $S' = R' \otimes_R S$ the base change.
Let $U \subset \Spec(S)$ be the set of primes at
which $R \to S$ is smooth.
Let $V \subset \Spec(S')$ the set of primes at
which $R' \to S'$ is smooth.
Then $V$ is the inverse image of $U$ under the
map $f : \Spec(S') \to \Spec(S)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-change-base-NL} we see that
$\NL_{S/R} \otimes_S S'$ is homotopy equivalent to $\NL_{S'/R'}$.
This already implies that $f^{-1}(U) \subset V$.

\medskip\noindent
Let $\mathfrak q' \subset S'$ be a prime lying over
$\mathfrak q \subset S$. Assume $\mathfrak q' \in V$.
We have to show that $\mathfrak q \in U$.
Since $S \to S'$ is flat, we see that $S_{\mathfrak q} \to S'_{\mathfrak q'}$
is faithfully flat (Lemma \ref{lemma-local-flat-ff}). Thus the vanishing of
$H_1(L_{S'/R'})_{\mathfrak q'}$ implies the
vanishing of $H_1(L_{S/R})_{\mathfrak q}$.
By Lemma \ref{lemma-finite-projective-descends}
applied to the $S_{\mathfrak q}$-module $(\Omega_{S/R})_{\mathfrak q}$
and the map $S_{\mathfrak q} \to S'_{\mathfrak q'}$ we see that
$(\Omega_{S/R})_{\mathfrak q}$ is projective. Hence
$R \to S$ is smooth at $\mathfrak q$ by
Lemma \ref{lemma-smooth-at-point}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-field-change-local}
Let $k \subset K$ be a field extension.
Let $S$ be a finite type algebra over $k$.
Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$
and let $\mathfrak q$ be the corresponding prime of $S$.
Then $S$ is smooth over $k$ at $\mathfrak q$ if and only if
$S_K$ is smooth at $\mathfrak q_K$ over $K$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-flat-base-change-locus-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-lift-smooth}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be a smooth ring map.
Then there exists elements $\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i} \cong S_i/IS_i$
for some (standard) smooth ring $S_i$ over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-smooth-syntomic} we find a collection of elements
$\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i}$ is standard smooth over $R/I$.
Hence we may assume that $\overline{S}$ is standard smooth
over $R/I$. Write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$
as in Definition \ref{definition-standard-smooth}.
Choose $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$
lifting $\overline{f}_1, \ldots, \overline{f}_c$. Set
$S = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}\Delta - 1)$
where $\Delta = \det(\frac{\partial f_j}{\partial x_i})_{i, j = 1, \ldots, c}$
as in Example \ref{example-make-standard-smooth}.
This proves the lemma.
\end{proof}








\section{Formally smooth maps}
\label{section-formally-smooth}

\noindent
In this section we define formally smooth ring maps. It will turn out
that a ring map of finite presentation is formally smooth if and only if
it is smooth, see
Proposition \ref{proposition-smooth-formally-smooth}.

\begin{definition}
\label{definition-formally-smooth}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally smooth over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, a dotted
arrow exists which makes the diagram commute.
\end{definition}

\begin{lemma}
\label{lemma-base-change-fs}
Let $R \to S$ be a formally smooth ring map.
Let $R \to R'$ be any ring map.
Then the base change $S' = R' \otimes_R S$ is formally smooth over $R'$.
\end{lemma}

\begin{proof}
Let a solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rrd] & R' \otimes_R S \ar[r] \ar@{-->}[rd] & A/I \\
R  \ar[u] \ar[r] & R' \ar[r] \ar[u] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
By assumption the longer dotted arrow exists. By the universal
property of tensor product we obtain the shorter dotted arrow.
\end{proof}

\begin{lemma}
\label{lemma-compose-formally-smooth}
A composition of formally smooth ring maps is formally smooth.
\end{lemma}

\begin{proof}
Omitted. (Hint: This is completely formal, and follows from considering
a suitable diagram.)
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-formally-smooth}
A polynomial ring over $R$ is formally smooth over $R$.
\end{lemma}

\begin{proof}
Suppose we have a diagram as in Definition \ref{definition-formally-smooth}
with $S = R[x_j; j \in J]$. Then there exists a dotted arrow
simply by choosing lifts $a_j \in A$ of the elements in $A/I$
to which the elements $x_j$ map to under the top horizontal arrow.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-smooth}
Let $R \to S$ be a ring map.
Let $P \to S$ be a surjective $R$-algebra map from a
polynomial ring $P$ onto $S$. Denote $J \subset P$ the
kernel. Then $R \to S$ is formally smooth if and only
if there exists an $R$-algebra map $\sigma : S \to P/J^2$
which is a right inverse to the surjection
$P/J^2 \to S$.
\end{lemma}

\begin{proof}
Assume $R \to S$ is formally smooth.
Consider the commutative diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & P/J \\
R \ar[r] \ar[u] &  P/J^2\ar[u]
}
$$
By assumption the dotted arrow exists. This proves that
$\sigma$ exists.

\medskip\noindent
Conversely, suppose we have a $\sigma$ as in the lemma.
Let a solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
Because $P$ is formally smooth by
Lemma \ref{lemma-polynomial-ring-formally-smooth},
there exists an $R$-algebra homomorphism
$\psi : P \to A$ which lifts the map $P \to S \to A/I$.
Clearly $\psi(J) \subset I$ and since $I^2 = 0$ we conclude that
$\psi(J^2) = 0$. Hence $\psi$ factors as
$\overline{\psi} : P/J^2 \to A$. The desired dotted arrow
is the composition $\overline{\psi} \circ \sigma : S \to A$.
\end{proof}

\begin{remark}
\label{remark-lemma-characterize-formally-smooth}
Lemma \ref{lemma-characterize-formally-smooth} holds more
generally whenever $P$ is formally smooth over $R$.
\end{remark}

\begin{lemma}
\label{lemma-characterize-formally-smooth-again}
Let $R \to S$ be a ring map.
Let $P \to S$ be a surjective $R$-algebra map from a
polynomial ring $P$ onto $S$. Denote $J \subset P$ the
kernel. Then $R \to S$ is formally smooth if and only
if the sequence
$$
0 \to J/J^2 \to \Omega_{P/R} \otimes_P S \to \Omega_{S/R} \to 0
$$
of Lemma \ref{lemma-differential-seq} is a split exact sequence.
\end{lemma}

\begin{proof}
Assume $S$ is formally smooth over $R$. By
Lemma \ref{lemma-characterize-formally-smooth}
this means there exists an $R$-algebra map
$S \to P/J^2$ which is a left inverse to the
canonical map $P/J^2 \to S$. This means that
$$
P/J^2 \cong S \oplus J/J^2
$$
as an $R$-algebra where the multiplication on the right is
such that $S$ is a subalgebra and $J/J^2$ is an ideal of square zero
with the obvious $S$-module structure. Note that the middle term of
the exact sequence is
$\Omega_{P/R} \otimes_P S \cong \Omega_{(P/J^2)/R} \otimes_P S$
by Lemma \ref{lemma-differential-mod-power-ideal}.
A direct computation shows that
$$
\Omega_{(S \oplus J/J^2)/R} \otimes_{(S \oplus J/J^2)} S =
\Omega_{S/R} \oplus J/J^2
$$
as desired.

\medskip\noindent
Assume the exact sequence of the lemma is split exact.
Choose a splitting $\sigma : \Omega_{S/R} \to \Omega_{P/R} \otimes_R S$.
For each $\lambda \in S$ choose $x_\lambda \in P$
which maps to $\lambda$. Next, for each $\lambda \in S$ choose
$f_\lambda \in J$ such that
$$
\text{d}f_\lambda = \text{d}x_\lambda - \sigma(\text{d}\lambda)
$$
in the middle term of the exact sequence.
We claim that $s : \lambda \mapsto x_\lambda - f_\lambda \mod J^2$
is an $R$-algebra homomorphism $s : S \to P/J^2$.
To prove this we will repeatedly use that if $h \in J$ and
$\text{d}h = 0$ in $\Omega_{P/R} \otimes_R S$, then $h \in J^2$.
Let $\lambda, \mu \in S$.
Then $\sigma(\text{d}\lambda + \text{d}\mu - \text{d}(\lambda + \mu)) = 0$.
This implies
$$
\text{d}(x_\lambda + x_\mu - x_{\lambda + \mu}
- f_\lambda - f_\mu + f_{\lambda + \mu}) = 0
$$
which means that $x_\lambda + x_\mu - x_{\lambda + \mu}
- f_\lambda - f_\mu + f_{\lambda + \mu} \in J^2$, which in turn
means that $s(\lambda) + s(\mu) = s(\lambda + \mu)$.
Similarly, we have
$\sigma(\lambda \text{d}\mu + \mu \text{d}\lambda - \text{d}\lambda \mu) = 0$
which implies that
$$
\mu(\text{d}x_\lambda - \text{d}f_\lambda) +
\lambda(\text{d}x_\mu - \text{d}f_\mu) -
\text{d}x_{\lambda\mu} - \text{d}f_{\lambda\mu} = 0
$$
in the middle term of the exact sequence.
Moreover we have
$$
\text{d}(x_\lambda x_\mu) =
x_\lambda \text{d}x_\mu + x_\mu \text{d}x_\lambda =
\lambda \text{d}x_\mu + \mu \text{d} x_\lambda
$$
in the middle term again. Combined these equations mean that
$x_\lambda x_\mu - x_{\lambda\mu}
- \mu f_\lambda - \lambda f_\mu + f_{\lambda\mu} \in J^2$,
hence $(x_\lambda - f_\lambda)(x_\mu - f_\mu) -
(x_{\lambda\mu} - f_{\lambda\mu}) \in J^2$ as $f_\lambda f_\mu \in J^2$,
which means that $s(\lambda)s(\mu) = s(\lambda\mu)$.
If $\lambda \in R$, then $\text{d}\lambda = 0$ and we see
that $\text{d}f_\lambda = \text{d}x_\lambda$, hence
$\lambda - x_\lambda + f_\lambda \in J^2$ and hence
$s(\lambda) = \lambda$ as desired. At this point we can
apply Lemma \ref{lemma-characterize-formally-smooth}
to conclude that $S/R$ is formally smooth.
\end{proof}

\begin{proposition}
\label{proposition-characterize-formally-smooth}
Let $R \to S$ be a ring map. Consider a formally smooth $R$-algebra $P$ and
a surjection $P \to S$ with kernel $J$. The following are equivalent
\begin{enumerate}
\item $S$ is formally smooth over $R$,
\item for some $P \to S$ as above there exists a
section to $P/J^2 \to S$,
\item for all $P \to S$ as above there exists a
section to $P/J^2 \to S$,
\item for some $P \to S$ as above the sequence
$0 \to J/J^2 \to \Omega_{P/R} \otimes S \to \Omega_{S/R} \to 0$ is split exact,
\item for all $P \to S$ as above the sequence
$0 \to J/J^2 \to \Omega_{P/R} \otimes S \to \Omega_{S/R} \to 0$ is split exact,
and
\item the naive cotangent complex $\NL_{S/R}$ is quasi-isomorphic to a
projective $S$-module placed in degree $0$.
\end{enumerate}
\end{proposition}

\begin{proof}
It is clear that (1) implies (3) implies (2), see first part of the proof of
Lemma \ref{lemma-characterize-formally-smooth}.
It is also true that (3) implies (5) implies (4) and that (2) implies (4), see
first part of the proof of
Lemma \ref{lemma-characterize-formally-smooth-again}.
Finally, Lemma \ref{lemma-characterize-formally-smooth-again}
applied to the canonical surjection $R[S] \to S$
(\ref{equation-canonical-presentation}) shows that (1) implies (6).

\medskip\noindent
Assume (4) and let's prove (6). Consider the sequence of
Lemma \ref{lemma-exact-sequence-NL}
associated to the ring maps $R \to P \to S$. By the implication
(1) $\Rightarrow$ (6) proved above we see that $\NL_{P/R} \otimes_R S$
is quasi-isomorphic to $\Omega_{P/R} \otimes_P S$ placed in degree $0$.
Hence $H_1(\NL_{P/R} \otimes_P S) = 0$. Since $P \to S$ is surjective we
see that $\NL_{S/P}$ is homotopy equivalent to $J/J^2$ placed in degree $1$
(Lemma \ref{lemma-NL-surjection}). Thus we obtain the exact sequence
$0 \to H_1(L_{S/R}) \to J/J^2 \to \Omega_{P/R} \otimes_P S \to
\Omega_{S/R} \to 0$.
By assumption we see that $H_1(L_{S/R}) = 0$ and that $\Omega_{S/R}$
is a projective $S$-module. Thus (6) follows.

\medskip\noindent
Finally, let's prove that (6) implies (1). The assumption means that
the complex $J/J^2 \to \Omega_{P/R} \otimes S$ where $P = R[S]$ and
$P \to S$ is the canonical surjection (\ref{equation-canonical-presentation}).
Hence Lemma \ref{lemma-characterize-formally-smooth-again} shows that $S$
is formally smooth over $R$.
\end{proof}

\begin{lemma}
\label{lemma-ses-formally-smooth}
Let $A \to B \to C$ be ring maps. Assume $B \to C$ is formally smooth.
Then the sequence
$$
0 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to \Omega_{C/B} \to 0
$$
of
Lemma \ref{lemma-exact-sequence-differentials}
is a split short exact sequence.
\end{lemma}

\begin{proof}
Follows from
Proposition \ref{proposition-characterize-formally-smooth}
and
Lemma \ref{lemma-exact-sequence-NL}.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq-formally-smooth}
Let $A \to B \to C$ be ring maps with $A \to C$ formally smooth
and $B \to C$ surjective with kernel $J \subset B$.
Then the exact sequence
$$
0 \to J/J^2 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0
$$
of
Lemma \ref{lemma-differential-seq}
is split exact.
\end{lemma}

\begin{proof}
Follows from
Proposition \ref{proposition-characterize-formally-smooth},
Lemma \ref{lemma-exact-sequence-NL}, and
Lemma \ref{lemma-differential-seq}.
\end{proof}

\begin{lemma}
\label{lemma-application-NL-formally-smooth}
Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so
also $B \to C$ is) and $A \to B$ formally smooth.
Denote $I = \Ker(A \to C)$ and $J = \Ker(B \to C)$.
Then the sequence
$$
0 \to I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0
$$
of
Lemma \ref{lemma-application-NL}
is split exact.
\end{lemma}

\begin{proof}
Since $A \to B$ is formally smooth there exists a ring map
$\sigma : B \to A/I^2$ whose composition with $A \to B$ equals
the quotient map $A \to A/I^2$. Then $\sigma$ induces a map
$J/J^2 \to I/I^2$ which is inverse to the map $I/I^2 \to J/J^2$.
\end{proof}

\begin{lemma}
\label{lemma-lift-formal-smoothness}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal. Assume
\begin{enumerate}
\item $I^2 = 0$,
\item $R \to S$ is flat, and
\item $R/I \to S/IS$ is formally smooth.
\end{enumerate}
Then $R \to S$ is formally smooth.
\end{lemma}

\begin{proof}
Assume (1), (2) and (3).
Let $P = R[\{x_t\}_{t \in T}] \to S$ be a surjection of $R$-algebras
with kernel $J$. Thus $0 \to J \to P \to S \to 0$ is a
short exact sequence of flat $R$-modules. This implies that
$I \otimes_R S = IS$, $I \otimes_R P = IP$ and $I \otimes_R J = IJ$
as well as $J \cap IP = IJ$.
We will use throughout the proof that
$$
\Omega_{(S/IS)/(R/I)} = \Omega_{S/R} \otimes_S (S/IS)
= \Omega_{S/R} \otimes_R R/I = \Omega_{S/R} / I\Omega_{S/R}
$$
and similarly for $P$ (see Lemma \ref{lemma-differentials-base-change}).
By Lemma \ref{lemma-characterize-formally-smooth-again} the sequence
\begin{equation}
\label{equation-split}
0 \to J/(IJ + J^2) \to
\Omega_{P/R} \otimes_P S/IS \to
\Omega_{S/R} \otimes_S S/IS \to 0
\end{equation}
is split exact. Of course the middle term is
$\bigoplus_{t \in T} S/IS \text{d}x_t$. Choose a splitting
$\sigma : \Omega_{P/R} \otimes_P S/IS \to J/(IJ + J^2)$.
For each $t \in T$ choose an element $f_t \in J$ which maps
to $\sigma(\text{d}x_t)$ in $J/(IJ + J^2)$. This determines a
unique $S$-module map
$$
\tilde \sigma : \Omega_{P/R} \otimes_R S
= \bigoplus S\text{d}x_t \longrightarrow J/J^2
$$
with the property that $\tilde\sigma(\text{d}x_t) = f_t$.
As $\sigma$ is a section to $\text{d}$ the difference
$$
\Delta = \text{id}_{J/J^2} - \tilde \sigma \circ \text{d}
$$
is a self map $J/J^2 \to J/J^2$ whose image is contained in
$(IJ + J^2)/J^2$. In particular $\Delta((IJ + J^2)/J^2) = 0$
because $I^2 = 0$. This means that $\Delta$ factors as
$$
J/J^2 \to J/(IJ + J^2) \xrightarrow{\overline{\Delta}}
(IJ + J^2)/J^2 \to J/J^2
$$
where $\overline{\Delta}$ is a $S/IS$-module map.
Using again that the sequence (\ref{equation-split})
is split, we can find a $S/IS$-module map
$\overline{\delta} : \Omega_{P/R} \otimes_P S/IS \to (IJ + J^2)/J^2$
such that $\overline{\delta} \circ d$ is equal to $\overline{\Delta}$.
In the same manner as above the map $\overline{\delta}$ determines
an $S$-module map
$\delta : \Omega_{P/R} \otimes_P S \to J/J^2$.
After replacing $\tilde \sigma$ by $\tilde \sigma + \delta$
a simple computation shows that $\Delta = 0$. In other words $\tilde \sigma$
is a section of $J/J^2 \to \Omega_{P/R} \otimes_P S$.
By Lemma \ref{lemma-characterize-formally-smooth-again}
we conclude that $R \to S$ is formally smooth.
\end{proof}

\begin{proposition}
\label{proposition-smooth-formally-smooth}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is of finite presentation and formally smooth,
\item $R \to S$ is smooth.
\end{enumerate}
\end{proposition}

\begin{proof}
Follows from
Proposition \ref{proposition-characterize-formally-smooth}
and Definition \ref{definition-smooth}.
(Note that $\Omega_{S/R}$ is a finitely presented $S$-module if $R \to S$ is
of finite presentation, see
Lemma \ref{lemma-differentials-finitely-presented}.)
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-fs-Noetherian}
Let $R \to S$ be a smooth ring map. Then there exists a subring
$R_0 \subset R$ of finite type over $\mathbf{Z}$ and a smooth
ring map $R_0 \to S_0$ such that $S \cong R \otimes_{R_0} S_0$.
\end{lemma}

\begin{proof}
We are going to use that smooth is equivalent to finite presentation
and formally smooth, see Proposition \ref{proposition-smooth-formally-smooth}.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and denote $I = (f_1, \ldots, f_m)$.
Choose a right inverse
$\sigma : S \to R[x_1, \ldots, x_n]/I^2$
to the projection to $S$ as in
Lemma \ref{lemma-characterize-formally-smooth}.
Choose $h_i \in R[x_1, \ldots, x_n]$ such that
$\sigma(x_i \bmod I) = h_i \bmod I^2$.
The fact that $\sigma$ is an $R$-algebra homomorphism
$R[x_1, \ldots, x_n]/I \to R[x_1, \ldots, x_n]/I^2$
is equivalent to the condition that
$$
f_j(h_1, \ldots, h_n) = \sum\nolimits_{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2}
$$
for certain $a_{kl} \in R[x_1, \ldots, x_n]$.
Let $R_0 \subset R$ be the subring generated over $\mathbf{Z}$
by all the coefficients of the polynomials $f_j, h_i, a_{kl}$.
Set $S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$,
with $I_0 = (f_1, \ldots, f_m)$.
Let $\sigma_0 : S_0 \to R_0[x_1, \ldots, x_n]/I_0^2$ defined by
the rule $x_i \mapsto h_i \bmod I_0^2$; this works since the
$a_{lk}$ are defined over $R_0$ and satisfy the same relations.
Thus by Lemma \ref{lemma-characterize-formally-smooth}
the ring $S_0$ is formally smooth over $R_0$.
\end{proof}

\begin{lemma}
\label{lemma-smooth-descends-through-colimit}
Let $A = \colim A_i$ be a filtered colimit of rings. Let
$A \to B$ be a smooth ring map. There exists an $i$ and
a smooth ring map $A_i \to B_i$ such that $B = B_i \otimes_{A_i} A$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-finite-presentation-fs-Noetherian}
since $R_0 \to A$ will factor through $A_i$ for some $i$ by
Lemma \ref{lemma-characterize-finite-presentation}.
\end{proof}

\begin{lemma}
\label{lemma-descent-formally-smooth}
Let $R \to S$ be a ring map. Let $R \to R'$ be a faithfully flat ring map.
Set $S' = S \otimes_R R'$. Then $R \to S$ is formally smooth if and only
if $R' \to S'$ is formally smooth.
\end{lemma}

\begin{proof}
If $R \to S$ is formally smooth, then $R' \to S'$ is formally smooth by
Lemma \ref{lemma-base-change-fs}.
To prove the converse, assume $R' \to S'$ is formally smooth.
Note that $N \otimes_R R' = N \otimes_S S'$ for any $S$-module $N$. In
particular $S \to S'$ is faithfully flat also.
Choose a polynomial ring $P = R[\{x_i\}_{i \in I}]$ and a surjection
of $R$-algebras $P \to S$ with kernel $J$. Note that $P' = P \otimes_R R'$
is a polynomial algebra over $R'$. Since $R \to R'$ is flat the kernel
$J'$ of the surjection $P' \to S'$ is $J \otimes_R R'$. Hence the
split exact sequence (see
Lemma \ref{lemma-characterize-formally-smooth-again})
$$
0 \to J'/(J')^2 \to \Omega_{P'/R'} \otimes_{P'} S' \to \Omega_{S'/R'} \to 0
$$
is the base change via $S \to S'$ of the corresponding sequence
$$
J/J^2 \to \Omega_{P/R} \otimes_P S \to \Omega_{S/R} \to 0
$$
see
Lemma \ref{lemma-differential-seq}.
As $S \to S'$ is faithfully flat we conclude two things:
(1) this sequence (without ${}'$) is exact too, and (2)
$\Omega_{S/R}$ is a projective $S$-module. Namely, $\Omega_{S'/R'}$
is projective as a direct sum of the free module
$\Omega_{P'/R'} \otimes_{P'} S'$ and
$\Omega_{S/R} \otimes_S {S'} = \Omega_{S'/R'}$ by what we said above.
Thus (2) follows by descent of projectivity
through faithfully flat ring maps, see
Theorem \ref{theorem-ffdescent-projectivity}.
Hence the sequence
$0 \to J/J^2 \to \Omega_{P/R} \otimes_P S \to \Omega_{S/R} \to 0$
is exact also and we win by applying
Lemma \ref{lemma-characterize-formally-smooth-again}
once more.
\end{proof}

\noindent
It turns out that smooth ring maps satisfy the following strong
lifting property.

\begin{lemma}
\label{lemma-smooth-strong-lift}
Let $R \to S$ be a smooth ring map. Given a commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is a locally nilpotent ideal, a dotted
arrow exists which makes the diagram commute.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-presentation-fs-Noetherian} we can extend the
diagram to a commutative diagram
$$
\xymatrix{
S_0 \ar[r] & S \ar[r] \ar@{-->}[rd] & A/I \\
R_0 \ar[r] \ar[u] & R \ar[r] \ar[u] & A \ar[u]
}
$$
with $R_0 \to S_0$ smooth, $R_0$ of finite type over $\mathbf{Z}$, and
$S = S_0 \otimes_{R_0} R$. Let $x_1, \ldots, x_n \in S_0$ be generators of
$S_0$ over $R_0$. Let $a_1, \ldots, a_n$ be elements of $A$ which
map to the same elements in $A/I$ as the elements $x_1, \ldots, x_n$.
Denote $A_0 \subset A$ the subring generated by the image of $R_0$
and the elements $a_1, \ldots, a_n$. Set $I_0 = A_0 \cap I$. Then
$A_0/I_0 \subset A/I$ and $S_0 \to A/I$ maps into $A_0/I_0$.
Thus it suffices to find the dotted arrow in the diagram
$$
\xymatrix{
S_0 \ar[r] \ar@{-->}[rd] & A_0/I_0 \\
R_0 \ar[r] \ar[u] & A_0 \ar[u]
}
$$
The ring $A_0$ is of finite type over $\mathbf{Z}$ by construction.
Hence $A_0$ is Noetherian, whence $I_0$ is nilpotent, see
Lemma \ref{lemma-Noetherian-power}.
Say $I_0^n = 0$. By Proposition \ref{proposition-smooth-formally-smooth}
we can successively lift the $R_0$-algebra map $S_0 \to A_0/I_0$ to
$S_0 \to A_0/I_0^2$, $S_0 \to A_0/I_0^3$, $\ldots$,
and finally $S_0 \to A_0/I_0^n = A_0$.
\end{proof}






\section{Smoothness and differentials}
\label{section-smooth-differential}

\noindent
Some results on differentials and smooth ring maps.

\begin{lemma}
\label{lemma-triangle-differentials-smooth}
Given ring maps $A \to B \to C$ with $B \to C$ smooth, then the sequence
$$
0 \to C \otimes_B \Omega_{B/A} \to \Omega_{C/A} \to \Omega_{C/B} \to 0
$$
of Lemma \ref{lemma-exact-sequence-differentials} is exact.
\end{lemma}

\begin{proof}
This follows from the more general
Lemma \ref{lemma-ses-formally-smooth}
because a smooth ring map is formally smooth, see
Proposition \ref{proposition-smooth-formally-smooth}.
But it also follows directly from
Lemma \ref{lemma-exact-sequence-NL}
since $H_1(L_{C/B}) = 0$ is part of the definition of smoothness of $B \to C$.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq-smooth}
Let $A \to B \to C$ be ring maps with $A \to C$ smooth
and $B \to C$ surjective with kernel $J \subset B$.
Then the exact sequence
$$
0 \to J/J^2 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0
$$
of
Lemma \ref{lemma-differential-seq}
is split exact.
\end{lemma}

\begin{proof}
This follows from the more general
Lemma \ref{lemma-differential-seq-formally-smooth}
because a smooth ring map is formally smooth, see
Proposition \ref{proposition-smooth-formally-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-application-NL-smooth}
Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so
also $B \to C$ is) and $A \to B$ smooth.
Denote $I = \Ker(A \to C)$ and $J = \Ker(B \to C)$.
Then the sequence
$$
0 \to I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0
$$
of
Lemma \ref{lemma-application-NL}
is exact.
\end{lemma}

\begin{proof}
This follows from the more general
Lemma \ref{lemma-application-NL-formally-smooth}
because a smooth ring map is formally smooth, see
Proposition \ref{proposition-smooth-formally-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-section-smooth}
\begin{slogan}
If $R$ is a summand of $S$ and $S$ is smooth over $R$, then the
$I$-adic completion of $S$ is often a power series over $R$
where $I$ is the kernel of the projection map from $S$ to $R$.
\end{slogan}
Let $\varphi : R \to S$ be a smooth ring map.
Let $\sigma : S \to R$ be a left inverse to $\varphi$.
Set $I = \Ker(\sigma)$. Then
\begin{enumerate}
\item $I/I^2$ is a finite locally free $R$-module, and
\item if $I/I^2$ is free, then $S^\wedge \cong R[[t_1, \ldots, t_d]]$
as $R$-algebras, where $S^\wedge$ is the $I$-adic completion of $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-differential-seq-split}
applied to $R \to S \to R$ we see that
$I/I^2 = \Omega_{S/R} \otimes_{S, \sigma} R$.
Since by definition of a smooth morphism the module $\Omega_{S/R}$ is
finite locally free over $S$ we deduce that (1) holds.
If $I/I^2$ is free, then choose $f_1, \ldots, f_d \in I$ whose images
in $I/I^2$ form an $R$-basis. Consider the $R$-algebra map defined by
$$
\Psi : R[[x_1, \ldots, x_d]] \longrightarrow S^\wedge, \quad
x_i \longmapsto f_i.
$$
Denote $P = R[[x_1, \ldots, x_d]]$ and $J = (x_1, \ldots, x_d) \subset P$.
We write $\Psi_n : P/J^n \to S/I^n$ for the induced map of quotient rings.
Note that $S/I^2 = \varphi(R) \oplus I/I^2$. Thus $\Psi_2$ is an
isomorphism. Denote $\sigma_2 : S/I^2 \to P/J^2$ the inverse of $\Psi_2$.
We will prove by induction on $n$ that for all $n > 2$ there exists an inverse
$\sigma_n : S/I^n \to P/J^n$ of $\Psi_n$. Namely, as $S$ is formally
smooth over $R$ (by
Proposition \ref{proposition-smooth-formally-smooth})
we see that in the solid diagram
$$
\xymatrix{
S \ar@{..>}[r] \ar[rd]_{\sigma_{n - 1}} & P/J^n \ar[d] \\
 & P/J^{n - 1}
}
$$
of $R$-algebras we can fill in the dotted arrow by some $R$-algebra
map $\tau : S \to P/J^n$ making the diagram commute. This induces an
$R$-algebra map $\overline{\tau} : S/I^n \to P/J^n$ which is equal to
$\sigma_{n - 1}$ modulo $J^n$. By construction the map $\Psi_n$ is surjective
and now $\overline{\tau} \circ \Psi_n$ is an $R$-algebra endomorphism
of $P/J^n$ which maps $x_i$ to $x_i + \delta_{i, n}$ with
$\delta_{i, n} \in J^{n -1}/J^n$. It follows that $\Psi_n$ is an
isomorphism and hence it has an inverse $\sigma_n$.
This proves the lemma.
\end{proof}





\section{Smooth algebras over fields}
\label{section-smooth-over-field}

\noindent
Warning: The following two lemmas do not hold over nonperfect
fields in general.

\begin{lemma}
\label{lemma-rank-omega}
Let $k$ be an algebraically closed field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak m \subset S$ be a maximal ideal.
Then
$$
\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
=
\dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
\end{lemma}

\begin{proof}
Consider the exact sequence
$$
\mathfrak m/\mathfrak m^2 \to
\Omega_{S/k} \otimes_S \kappa(\mathfrak m) \to
\Omega_{\kappa(\mathfrak m)/k} \to 0
$$
of Lemma \ref{lemma-differential-seq}. We would like to show that the
first map is an isomorphism. Since $k$ is algebraically closed the
composition $k \to \kappa(\mathfrak m)$ is an isomorphism by
Theorem \ref{theorem-nullstellensatz}.
So the surjection $S \to \kappa(\mathfrak m)$ splits as a map of
$k$-algebras, and Lemma \ref{lemma-differential-seq-split} shows
that the sequence above is exact
on the left. Since $\Omega_{\kappa(\mathfrak m)/k} = 0$, we win.
\end{proof}

\begin{lemma}
\label{lemma-characterize-smooth-kbar}
Let $k$ be an algebraically closed field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak m \subset S$ be a maximal ideal.
The following are equivalent:
\begin{enumerate}
\item The ring $S_{\mathfrak m}$ is a regular local ring.
\item We have
$\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
\leq \dim(S_{\mathfrak m})$.
\item We have
$\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
= \dim(S_{\mathfrak m})$.
\item There exists a $g \in S$, $g \not \in \mathfrak m$
such that $S_g$ is smooth over $k$. In other words $S/k$
is smooth at $\mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that (1), (2) and (3) are equivalent by Lemma \ref{lemma-rank-omega}
and Definition \ref{definition-regular}.

\medskip\noindent
Assume that $S$ is smooth at $\mathfrak m$.
By Lemma \ref{lemma-smooth-syntomic} we see that
$S_g$ is standard smooth over $k$
for a suitable $g \in S$, $g \not \in \mathfrak m$.
Hence by Lemma \ref{lemma-standard-smooth}
we see that $\Omega_{S_g/k}$ is free of rank $\dim(S_g)$.
Hence by Lemma \ref{lemma-rank-omega}
we see that $\dim(S_m) = \dim (\mathfrak m/\mathfrak m^2)$
in other words $S_\mathfrak m$ is regular.

\medskip\noindent
Conversely, suppose that $S_{\mathfrak m}$ is regular.
Let $d = \dim(S_{\mathfrak m}) = \dim \mathfrak m/\mathfrak m^2$.
Choose a presentation $S = k[x_1, \ldots, x_n]/I$
such that $x_i$ maps to an element of $\mathfrak m$ for
all $i$. In other words, $\mathfrak m'' = (x_1, \ldots, x_n)$
is the corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
Note that we have a short exact sequence
$$
I/\mathfrak m''I \to \mathfrak m''/(\mathfrak m'')^2
\to \mathfrak m/(\mathfrak m)^2 \to 0
$$
Pick $c = n - d$ elements $f_1, \ldots, f_d \in I$ such that
their images in $\mathfrak m''/(\mathfrak m'')^2$ span the
kernel of the map to $\mathfrak m/(\mathfrak m)^2$. This is clearly
possible. Denote $J = (f_1, \ldots, f_c)$. So $J \subset I$.
Denote $S' = k[x_1, \ldots, x_n]/J$ so there is a surjection
$S' \to S$. Denote $\mathfrak m' = \mathfrak m''S'$ the corresponding
maximal ideal of $S'$. Hence we have
$$
\xymatrix{
k[x_1, \ldots, x_n] \ar[r] & S' \ar[r] & S \\
\mathfrak m'' \ar[u] \ar[r] & \mathfrak m' \ar[r] \ar[u] &
\mathfrak m \ar[u]
}
$$
By our choice of $J$ the exact sequence
$$
J/\mathfrak m''J \to \mathfrak m''/(\mathfrak m'')^2
\to \mathfrak m'/(\mathfrak m')^2 \to 0
$$
shows that $\dim( \mathfrak m'/(\mathfrak m')^2 ) = d$.
Since $S'_{\mathfrak m'}$ surjects onto $S_{\mathfrak m}$
we see that $\dim(S_{\mathfrak m'}) \geq d$. Hence by
the discussion preceding Definition \ref{definition-regular-local}
we conclude that $S'_{\mathfrak m'}$ is
regular of dimension $d$ as well. Because $S'$ was cut out
by $c = n - d$ equations we
conclude that there exists a $g' \in S'$, $g' \not \in \mathfrak m'$
such that $S'_{g'}$ is a global complete intersection over $k$,
see Lemma \ref{lemma-lci}.
Also the map $S'_{\mathfrak m'} \to S_{\mathfrak m}$
is a surjection of Noetherian local domains of the same
dimension and hence an isomorphism. By Lemma \ref{lemma-isomorphic-local-rings}
we see that $S'_{g'} \cong S_g$ for some
$g \in S$, $g \not \in \mathfrak m$ and
$g' \in S'$, $g' \not \in \mathfrak m'$. All in all we conclude that
after replacing $S$ by a principal localization we may
assume that $S$ is a global complete intersection.

\medskip\noindent
At this point we may write $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $\dim S = n - c$. Recall that the naive cotangent complex
of this algebra is given by
$$
\bigoplus S \cdot f_j
\to
\bigoplus S \cdot \text{d}x_i
$$
see Lemma \ref{lemma-relative-global-complete-intersection-conormal}.
By Lemma \ref{lemma-relative-global-complete-intersection-smooth}
in order to show that $S$ is smooth at
$\mathfrak m$ we have to show that one of the $c \times c$
minors $g_I$ of the matrix ``$A$'' giving the map above
does not vanish at $\mathfrak m$. By Lemma \ref{lemma-rank-omega}
the matrix $A \bmod \mathfrak m$ has rank $c$. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-characterize-smooth-over-field}
Let $k$ be any field.
Let $S$ be a finite type $k$-algebra.
Let $X = \Spec(S)$.
Let $\mathfrak q \subset S$ be a prime
corresponding to $x \in X$.
The following are equivalent:
\begin{enumerate}
\item The $k$-algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item We have
$\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)
\leq \dim_x X$.
\item We have
$\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)
= \dim_x X$.
\end{enumerate}
Moreover, in this case the local ring $S_{\mathfrak q}$ is regular.
\end{lemma}

\begin{proof}
If $S$ is smooth at $\mathfrak q$ over $k$, then there exists
a $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is
standard smooth over $k$, see Lemma \ref{lemma-smooth-syntomic}.
A standard smooth algebra over $k$ has a module of differentials
which is free of rank equal to the dimension, see
Lemma \ref{lemma-standard-smooth} (use that a relative global
complete intersection over a field has dimension equal to the
number of variables minus the number of equations). Thus we see that
(1) implies (3). To finish the proof of the lemma it
suffices to show that (2) implies (1) and that it implies
that $S_{\mathfrak q}$ is regular.

\medskip\noindent
Assume (2). By Nakayama's Lemma \ref{lemma-NAK} we see that
$\Omega_{S/k, \mathfrak q}$ can be generated by $\leq \dim_x X$ elements.
We may replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
such that $\Omega_{S/k}$ is generated by at most
$\dim_x X$ elements.
Let $K \supset k$ be an algebraically closed field extension
such that there exists a $k$-algebra map $\psi : \kappa(\mathfrak q) \to K$.
Consider $S_K = K \otimes_k S$. Let $\mathfrak m \subset S_K$
be the maximal ideal corresponding to the surjection
$$
\xymatrix{
S_K = K \otimes_k S \ar[r] &
K \otimes_k \kappa(\mathfrak q)
\ar[r]^-{\text{id}_K \otimes \psi} &
K.
}
$$
Note that $\mathfrak m \cap S = \mathfrak q$, in other words
$\mathfrak m$ lies over $\mathfrak q$.
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
the dimension of $X_K = \Spec(S_K)$ at the point corresponding
to $\mathfrak m$ is $\dim_x X$. By
Lemma \ref{lemma-dimension-closed-point-finite-type-field}
this is equal to $\dim((S_K)_{\mathfrak m})$.
By Lemma \ref{lemma-differentials-base-change}
the module of differentials of $S_K$ over $K$ is
the base change of $\Omega_{S/k}$, hence also
generated by at most $\dim_x X = \dim((S_K)_{\mathfrak m})$
elements. By Lemma \ref{lemma-characterize-smooth-kbar}
we see that $S_K$ is smooth at $\mathfrak m$ over $K$.
By Lemma \ref{lemma-flat-base-change-locus-smooth} this
implies that $S$ is smooth at $\mathfrak q$ over $k$.
This proves (1). Moreover, we know by
Lemma \ref{lemma-characterize-smooth-kbar}
that the local ring $(S_K)_{\mathfrak m}$ is regular.
Since $S_{\mathfrak q} \to (S_K)_{\mathfrak m}$ is flat we
conclude from Lemma \ref{lemma-flat-under-regular}
that $S_{\mathfrak q}$ is regular.
\end{proof}

\noindent
The following lemma can be significantly generalized
(in several different ways).

\begin{lemma}
\label{lemma-computation-differential}
Let $k$ be a field.
Let $R$ be a Noetherian local ring containing $k$.
Assume that the residue field $\kappa = R/\mathfrak m$
is a finitely generated separable extension of $k$.
Then the map
$$
\text{d} :
\mathfrak m/\mathfrak m^2
\longrightarrow
\Omega_{R/k} \otimes_R \kappa(\mathfrak m)
$$
is injective.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak m^2$. Hence we may assume that
$\mathfrak m^2 = 0$. By assumption we may write
$\kappa = k(\overline{x}_1, \ldots, \overline{x}_r, \overline{y})$
where $\overline{x}_1, \ldots, \overline{x}_r$ is a transcendence basis
of $\kappa$ over $k$ and $\overline{y}$ is separable algebraic over
$k(\overline{x}_1, \ldots, \overline{x}_r)$. Say its minimal
equation is $P(\overline{y}) = 0$ with $P(T) = T^d + \sum_{i < d} a_iT^i$,
with $a_i \in k(\overline{x}_1, \ldots, \overline{x}_r)$ and
$P'(\overline{y}) \not = 0$. Choose any lifts
$x_i \in R$ of the elements $\overline{x}_i \in \kappa$.
This gives a commutative diagram
$$
\xymatrix{
R \ar[r] & \kappa \\
& k(\overline{x}_1, \ldots, \overline{x}_r) \ar[lu]^\varphi \ar[u]
}
$$
of $k$-algebras. We want to extend the left upwards arrow
$\varphi$ to a $k$-algebra
map from $\kappa$ to $R$. To do this choose any $y \in R$ lifting
$\overline{y}$. To see that it defines a $k$-algebra map
defined on $\kappa \cong k(\overline{x}_1, \ldots, \overline{x}_r)[T]/(P)$
all we have to show is that we may choose $y$ such that $P^\varphi(y) = 0$.
If not then we compute for $\delta \in \mathfrak m$ that
$$
P(y + \delta) = P(y) + P'(y)\delta
$$
because $\mathfrak m^2 = 0$. Since $P'(y)\delta = P'(\overline{y})\delta$
we see that we can adjust our choice as desired.
This shows that $R \cong \kappa \oplus \mathfrak m$ as
$k$-algebras! From a direct computation of
$\Omega_{\kappa \oplus \mathfrak m/k}$ the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-separable-smooth}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
Assume $\kappa(\mathfrak q)$ is separable over $k$.
The following are equivalent:
\begin{enumerate}
\item The algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item The ring $S_{\mathfrak q}$ is regular.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $R = S_{\mathfrak q}$ and denote its maximal
by $\mathfrak m$ and its residue field $\kappa$.
By Lemma \ref{lemma-computation-differential} and
\ref{lemma-differential-seq} we see that there is a short exact
sequence
$$
0 \to \mathfrak m/\mathfrak m^2 \to
\Omega_{R/k} \otimes_R \kappa \to
\Omega_{\kappa/k} \to 0
$$
Note that $\Omega_{R/k} = \Omega_{S/k, \mathfrak q}$, see
Lemma \ref{lemma-differentials-localize}.
Moreover, since $\kappa$ is separable over $k$
we have $\dim_{\kappa} \Omega_{\kappa/k} = \text{trdeg}_k(\kappa)$.
Hence we get
$$
\dim_{\kappa} \Omega_{R/k} \otimes_R \kappa
=
\dim_\kappa \mathfrak m/\mathfrak m^2 + \text{trdeg}_k (\kappa)
\geq
\dim R + \text{trdeg}_k (\kappa)
=
\dim_{\mathfrak q} S
$$
(see Lemma \ref{lemma-dimension-at-a-point-finite-type-field} for
the last equality)
with equality if and only if $R$ is regular.
Thus we win by applying Lemma \ref{lemma-characterize-smooth-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-characteristic-zero}
Let $R \to S$ be a $\mathbf{Q}$-algebra map.
Let $f \in S$ be such that $\Omega_{S/R} = S \text{d}f \oplus C$
for some $S$-submodule $C$. Then
\begin{enumerate}
\item $f$ is not nilpotent, and
\item if $S$ is a Noetherian local ring, then $f$ is a nonzerodivisor in $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
For $a \in S$ write $\text{d}(a) = \theta(a)\text{d}f + c(a)$ for some
$\theta(a) \in S$ and $c(a) \in C$.
Consider the $R$-derivation $S \to S$, $a \mapsto \theta(a)$.
Note that $\theta(f) = 1$.

\medskip\noindent
If $f^n = 0$ with $n > 1$ minimal, then $0 = \theta(f^n) = n f^{n - 1}$
contradicting the minimality of $n$. We conclude that $f$ is not nilpotent.

\medskip\noindent
Suppose $fa = 0$. If $f$ is a unit then $a = 0$ and we win. Assume
$f$ is not a unit. Then
$0 = \theta(fa) = f\theta(a) + a$ by the Leibniz rule and hence $a \in (f)$.
By induction suppose we have shown $fa = 0 \Rightarrow a \in (f^n)$.
Then writing $a = f^nb$ we get
$0 = \theta(f^{n + 1}b) = (n + 1)f^nb + f^{n + 1}\theta(b)$.
Hence $a = f^n b = -f^{n + 1}\theta(b)/(n + 1) \in (f^{n + 1})$.
Since in the Noetherian local ring $S$ we have $\bigcap (f^n) = 0$, see
Lemma \ref{lemma-intersect-powers-ideal-module-zero}
we win.
\end{proof}

\noindent
The following is probably quite useless in applications.

\begin{lemma}
\label{lemma-characteristic-zero-local-smooth}
Let $k$ be a field of characteristic $0$.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
The following are equivalent:
\begin{enumerate}
\item The algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item The $S_{\mathfrak q}$-module $\Omega_{S/k, \mathfrak q}$
is (finite) free.
\item The ring $S_{\mathfrak q}$ is regular.
\end{enumerate}
\end{lemma}

\begin{proof}
In characteristic zero any field extension is separable and hence the
equivalence of (1) and (3) follows from Lemma \ref{lemma-separable-smooth}.
Also (1) implies (2) by definition of smooth algebras.
Assume that $\Omega_{S/k, \mathfrak q}$ is free over $S_{\mathfrak q}$.
We are going to use the notation and observations made in the
proof of Lemma \ref{lemma-separable-smooth}. So $R = S_{\mathfrak q}$
with maximal ideal $\mathfrak m$ and residue field $\kappa$.
Our goal is to prove $R$ is regular.

\medskip\noindent
If $\mathfrak m/\mathfrak m^2 = 0$, then $\mathfrak m = 0$
and $R \cong \kappa$. Hence $R$ is regular and we win.

\medskip\noindent
If $\mathfrak m/ \mathfrak m^2 \not = 0$, then choose any
$f \in \mathfrak m$ whose image in $\mathfrak m/ \mathfrak m^2$
is not zero. By Lemma \ref{lemma-computation-differential}
we see that $\text{d}f$ has nonzero image in
$\Omega_{R/k}/\mathfrak m\Omega_{R/k}$. By assumption
$\Omega_{R/k} = \Omega_{S/k, \mathfrak q}$ is finite free and
hence by Nakayama's Lemma \ref{lemma-NAK} we see that
$\text{d}f$ generates a direct summand. We apply
Lemma \ref{lemma-characteristic-zero}
to deduce that $f$ is a nonzerodivisor in $R$.
Furthermore, by Lemma \ref{lemma-differential-seq} we get an exact sequence
$$
(f)/(f^2) \to \Omega_{R/k} \otimes_R R/fR \to \Omega_{(R/fR)/k} \to 0
$$
This implies that $\Omega_{(R/fR)/k}$ is finite free as well.
Hence by induction we see that $R/fR$ is a regular local ring.
Since $f \in \mathfrak m$ was a nonzerodivisor we
conclude that $R$ is regular, see Lemma \ref{lemma-regular-mod-x}.
\end{proof}

\begin{example}
\label{example-characteristic-p}
Lemma \ref{lemma-characteristic-zero-local-smooth}
does not hold in characteristic $p > 0$.
The standard examples are the ring maps
$$
\mathbf{F}_p \longrightarrow \mathbf{F}_p[x]/(x^p)
$$
whose module of differentials is free but is clearly not smooth, and
the ring map ($p > 2$)
$$
\mathbf{F}_p(t) \to \mathbf{F}_p(t)[x, y]/(x^p + y^2 + \alpha)
$$
which is not smooth at the prime $\mathfrak q = (y, x^p - \alpha)$
but is regular.
\end{example}

\noindent
Using the material above we can characterize smoothness at the generic
point in terms of field extensions.

\begin{lemma}
\label{lemma-smooth-at-generic-point}
Let $R \to S$ be an injective finite type ring map with $R$ and $S$ domains.
Then $R \to S$ is smooth at $\mathfrak q = (0)$ if and only if
$f.f.(R) \subset f.f.(S)$ is a separable extension of fields.
\end{lemma}

\begin{proof}
Assume $R \to S$ is smooth at $(0)$. We may replace $S$ by $S_g$
for some nonzero $g \in S$ and assume that $R \to S$ is smooth.
Set $K = f.f.(R)$. Then $K \to S \otimes_R K$ is smooth
(Lemma \ref{lemma-base-change-smooth}). Moreover, for any
field extension $K \subset K'$ the ring map $K' \to S \otimes_R K'$
is smooth as well. Hence $S \otimes_R K'$ is a regular ring
by Lemma \ref{lemma-characterize-smooth-over-field}, in particular reduced.
It follows that $S \otimes_R K$ is a geometrically reduced over $K$.
Hence $f.f.(S)$ is geometrically reduced over $K$, see
Lemma \ref{lemma-geometrically-reduced-permanence}.
Hence $f.f.(S)/K$ is separable by
Lemma \ref{lemma-characterize-separable-field-extensions}.

\medskip\noindent
Conversely, assume that $f.f.(R) \subset f.f.(S)$ is separable.
We may assume $R \to S$ is of finite presentation, see
Lemma \ref{lemma-generic-finite-presentation}.
It suffices to prove that $K \to S \otimes_R K$ is smooth
at $(0)$, see
Lemma \ref{lemma-flat-base-change-locus-smooth}.
This follows from Lemma \ref{lemma-separable-smooth}, the
fact that a field is a regular ring,
and the assumption that $f.f.(R) \to f.f.(S)$ is separable.
\end{proof}











\section{Smooth ring maps in the Noetherian case}
\label{section-smooth-Noetherian}

\begin{definition}
\label{definition-small-extension}
Let $\varphi : B' \to B$ be a ring map.
We say $\varphi$ is a {\it small extension} if
$B'$ and $B$ are local Artinian rings, $\varphi$ is surjective
and $I = \Ker(\varphi)$ has length $1$ as a $B'$-module.
\end{definition}

\noindent
Clearly this means that $I^2 = 0$ and that $I = (x)$ for some
$x \in B'$ such that $\mathfrak m' x = 0$ where $\mathfrak m' \subset B'$
is the maximal ideal.

\begin{lemma}
\label{lemma-smooth-test-artinian}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime ideal of
$S$ lying over $\mathfrak p \subset R$. Assume $R$ is Noetherian
and $R \to S$ of finite type.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is smooth at $\mathfrak q$,
\item for every surjection of local $R$-algebras
$(B', \mathfrak m') \to (B, \mathfrak m)$
with $\Ker(B' \to B)$ having square zero
and every solid commutative diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & B \\
R \ar[r] \ar[u] & B' \ar[u]
}
$$
such that $\mathfrak q = S \cap \mathfrak m$ there exists a dotted
arrow making the diagram commute,
\item same as in (2) but with $B' \to B$ ranging over small extensions, and
\item same as in (2) but with $B' \to B$ ranging over small extensions
such that in addition $S \to B$ induces an isomorphism
$\kappa(\mathfrak q) \cong \kappa(\mathfrak m)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). This means there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is smooth. By
Proposition \ref{proposition-smooth-formally-smooth}
we know that $R \to S_g$ is formally smooth. Note that given any diagram
as in (2) the map $S \to B$ factors automatically through $S_{\mathfrak q}$
and a fortiori through $S_g$. The formal smoothness of $S_g$ over $R$
gives us a morphism $S_g \to B'$ fitting into a similar diagram with $S_g$ at
the upper left corner. Composing with $S \to S_g$ gives the desired arrow.
In other words, we have shown that (1) implies (2).

\medskip\noindent
Clearly (2) implies (3) and (3) implies (4).

\medskip\noindent
Assume (4). We are going to show that (1) holds, thereby finishing the
proof of the lemma. Choose a presentation
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
This is possible as $S$ is of finite type over $R$ and therefore of finite
presentation (see
Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}).
Set $I = (f_1, \ldots, f_m)$.
Consider the naive cotangent complex
$$
\text{d} : I/I^2
\longrightarrow
\bigoplus\nolimits_{j = 1}^m S\text{d}x_j
$$
of this presentation (see Section \ref{section-netherlander}).
It suffices to show that when we localize this complex at $\mathfrak q$
then the map becomes a split injection, see Lemma \ref{lemma-smooth-at-point}.
Denote $S' = R[x_1, \ldots, x_n]/I^2$.
By Lemma \ref{lemma-differential-mod-power-ideal} we have
$$
S \otimes_{S'} \Omega_{S'/R} =
S \otimes_{R[x_1, \ldots, x_n]} \Omega_{R[x_1, \ldots, x_n]/R} =
\bigoplus\nolimits_{j = 1}^m S\text{d}x_j.
$$
Thus the map
$$
\text{d} :
I/I^2
\longrightarrow
S \otimes_{S'} \Omega_{S'/R}
$$
is the same as the map in the naive cotangent complex above. In particular
the truth of the assertion we are trying to prove
depends only on the three rings $R \to S' \to S$.
Let $\mathfrak q' \subset R[x_1, \ldots, x_n]$ be the prime ideal
corresponding to $\mathfrak q$. Since
localization commutes with taking modules of differentials
(Lemma \ref{lemma-differentials-localize}) we see that it suffices to show
that the map
\begin{equation}
\label{equation-target-map}
\text{d} :
I_{\mathfrak q'}/I_{\mathfrak q'}^2
\longrightarrow
S_{\mathfrak q} \otimes_{S'_{\mathfrak q'}} \Omega_{S'_{\mathfrak q'}/R}
\end{equation}
coming from $R \to S'_{\mathfrak q'} \to S_{\mathfrak q}$
is a split injection.

\medskip\noindent
Let $N \in \mathbf{N}$ be an integer.
Consider the ring
$$
B'_N = S'_{\mathfrak q'} / (\mathfrak q')^N S'_{\mathfrak q'}
= (S'/(\mathfrak q')^N S')_{\mathfrak q'}
$$
and its quotient $B_N = B'_N/IB'_N$. Note that
$B_N \cong S_{\mathfrak q}/\mathfrak q^NS_{\mathfrak q}$.
Observe that $B'_N$ is an Artinian local ring since it is the
quotient of a local Noetherian ring by a power of its maximal ideal.
Consider a filtration of the kernel $I_N$ of $B'_N \to B_N$
by $B'_N$-submodules
$$
0 \subset J_{N, 1} \subset J_{N, 2} \subset \ldots \subset J_{N, n(N)} = I_N
$$
such that each successive quotient $J_{N, i}/J_{N, i - 1}$ has length $1$.
(As $B'_N$ is Artinian such a filtration exists.)
This gives a sequence of small extensions
$$
B'_N  \to B'_N/J_{N, 1} \to B'_N/J_{N, 2} \to \ldots \to
B'_N/J_{N, n(N)} = B'_N/I_N
= B_N = S_{\mathfrak q}/\mathfrak q^NS_{\mathfrak q}
$$
Applying condition (4) successively to these small extensions
starting with the map $S \to B_N$ we see there
exists a commutative diagram
$$
\xymatrix{
S \ar[r] \ar[rd] & B_N  \\
R \ar[r] \ar[u] & B'_N \ar[u]
}
$$
Clearly the ring map $S \to B'_N$ factors as $S \to S_{\mathfrak q} \to B'_N$
where $S_{\mathfrak q} \to B'_N$ is a local homomorphism of local rings.
Moreover, since the maximal ideal of $B'_N$ to the $N$th power is zero
we conclude that $S_{\mathfrak q} \to B'_N$ factors through
$S_{\mathfrak q}/(\mathfrak q)^NS_{\mathfrak q} = B_N$. In other words
we have shown that for all $N \in \mathbf{N}$ the surjection of
$R$-algebras $B'_N \to B_N$ has a splitting.

\medskip\noindent
Consider the presentation
$$
I_N \to B_N \otimes_{B'_N} \Omega_{B'_N/R} \to \Omega_{B_N/R} \to 0
$$
coming from the surjection $B'_N \to B_N$ with kernel $I_N$ (see
Lemma \ref{lemma-differential-seq}). By the above the $R$-algebra map
$B'_N \to B_N$ has a right inverse. Hence by
Lemma \ref{lemma-differential-seq-split} we see that the sequence above
is split exact! Thus for every $N$ the map
$$
I_N \longrightarrow B_N \otimes_{B'_N} \Omega_{B'_N/R}
$$
is a split injection. The rest of the proof is gotten by unwinding what
this means exactly. Note that
$$
I_N = I_{\mathfrak q'}/
(I_{\mathfrak q'}^2 + (\mathfrak q')^N \cap I_{\mathfrak q'})
$$
By Artin-Rees (Lemma \ref{lemma-Artin-Rees}) we find a $c \geq 0$
such that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}} I_N =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}}
I_{\mathfrak q'}/I_{\mathfrak q'}^2
$$
for all $N \geq c$
(these tensor product are just a fancy way of dividing by
$\mathfrak q^{N - c}$). We may of course assume $c \geq 1$.
By Lemma \ref{lemma-differential-mod-power-ideal} we see that
$$
S'_{\mathfrak q'}/(\mathfrak q')^{N - c}S'_{\mathfrak q'}
\otimes_{S'_{\mathfrak q'}} \Omega_{B'_N/R} =
S'_{\mathfrak q'}/(\mathfrak q')^{N - c}S'_{\mathfrak q'}
\otimes_{S'_{\mathfrak q'}} \Omega_{S'_{\mathfrak q'}/R}
$$
we can further tensor this by $B_N = S_{\mathfrak q}/\mathfrak q^N$
to see that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S'_{\mathfrak q'}} \Omega_{B'_N/R} =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S'_{\mathfrak q'}} \Omega_{S'_{\mathfrak q'}/R}.
$$
Since a split injection remains a split injection after tensoring
with anything we see that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}}
(\ref{equation-target-map}) =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}/\mathfrak q^N S_{\mathfrak q}}
(I_N \longrightarrow B_N \otimes_{B'_N} \Omega_{B'_N/R})
$$
is a split injection for all $N \geq c$. By
Lemma \ref{lemma-split-injection-after-completion} we see that
(\ref{equation-target-map}) is a split injection. This finishes the proof.
\end{proof}








\section{Overview of results on smooth ring maps}
\label{section-smooth-overview}

\noindent
Here is a list of results on smooth ring maps that we
proved in the preceding sections. For more precise statements
and definitions please consult the references given.
\begin{enumerate}
\item A ring map $R \to S$ is smooth if it is of finite presentation
and the naive cotangent complex of $S/R$ is quasi-isomorphic to
a finite projective $S$-module in degree $0$, see
Definition \ref{definition-smooth}.
\item If $S$ is smooth over $R$, then $\Omega_{S/R}$ is a finite projective
$S$-module, see discussion following Definition \ref{definition-smooth}.
\item The property of being smooth is local on $S$, see
Lemma \ref{lemma-locally-smooth}.
\item The property of being smooth is stable under base change, see
Lemma \ref{lemma-base-change-smooth}.
\item The property of being smooth is stable under composition, see
Lemma \ref{lemma-compose-smooth}.
\item A smooth ring map is syntomic, in particular flat, see
Lemma \ref{lemma-smooth-syntomic}.
\item A finitely presented, flat ring map with smooth fibre rings
is smooth, see Lemma \ref{lemma-flat-fibre-smooth}.
\item A finitely presented ring map $R \to S$ is smooth if and
only if it is formally smooth, see
Proposition \ref{proposition-smooth-formally-smooth}.
\item If $R \to S$ is a finite type ring map with $R$ Noetherian
then to check that $R \to S$ is smooth it suffices to check the lifting
property of formal smoothness along small extensions of Artinian
local rings, see Lemma \ref{lemma-smooth-test-artinian}.
\item A smooth ring map $R \to S$ is the base change
of a smooth ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$, see
Lemma \ref{lemma-finite-presentation-fs-Noetherian}.
\item Formation of the set of points where a
ring map is smooth commutes with flat base change, see
Lemma \ref{lemma-flat-base-change-locus-smooth}.
\item If $S$ is of finite type over an algebraically closed
field $k$, and $\mathfrak m \subset S$ a maximal ideal,
then the following are equivalent
\begin{enumerate}
\item $S$ is smooth over $k$ in a neighbourhood of $\mathfrak m$,
\item $S_{\mathfrak m}$ is a regular local ring,
\item $\dim(S_{\mathfrak m}) =
\dim_{\kappa(m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)$.
\end{enumerate}
see Lemma \ref{lemma-characterize-smooth-kbar}.
\item If $S$ is of finite type over a field $k$, and
$\mathfrak q \subset S$ a prime ideal,
then the following are equivalent
\begin{enumerate}
\item $S$ is smooth over $k$ in a neighbourhood of $\mathfrak q$,
\item $\dim_{\mathfrak q}(S/k) =
\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)$.
\end{enumerate}
see Lemma \ref{lemma-characterize-smooth-over-field}.
\item If $S$ is smooth over a field, then all its local rings are
regular, see Lemma \ref{lemma-characterize-smooth-over-field}.
\item If $S$ is of finite type over a field $k$,
$\mathfrak q \subset S$ a prime ideal,
the field extension $k \subset \kappa(\mathfrak q)$ is separable
and $S_{\mathfrak q}$ is regular, then $S$ is smooth over $k$ at
$\mathfrak q$, see Lemma \ref{lemma-separable-smooth}.
\item If $S$ is of finite type over a field $k$,
if $k$ has characteristic $0$, if
$\mathfrak q \subset S$ a prime ideal, and if
$\Omega_{S/k, \mathfrak q}$ is free, then $S$ is smooth over $k$ at
$\mathfrak q$, see Lemma \ref{lemma-characteristic-zero-local-smooth}.
\end{enumerate}
Some of these results were proved using the notion of a standard
smooth ring map, see Definition \ref{definition-standard-smooth}.
This is the analogue of what a relative global
complete intersection map is for the case of syntomic morphisms.
It is also the easiest way to make examples.













\section{\'Etale ring maps}
\label{section-etale}

\noindent
An \'etale ring map is a smooth ring map whose relative dimension
is equal to zero. This is the same as the following slightly more
direct definition.

\begin{definition}
\label{definition-etale}
Let $R \to S$ be a ring map. We say $R \to S$ is {\it \'etale} if it is
of finite presentation and the naive cotangent complex
$\NL_{S/R}$ is quasi-isomorphic to zero. Given a prime $\mathfrak q$
of $S$ we say that $R \to S$ is {\it \'etale at $\mathfrak q$}
if there exists a $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is \'etale.
\end{definition}

\noindent
In particular we see that $\Omega_{S/R} = 0$ if $S$ is \'etale over $R$.
If $R \to S$ is smooth,
then $R \to S$ is \'etale if and only if $\Omega_{S/R} = 0$.
From our results on smooth ring maps we automatically get a whole host
of results for \'etale maps. We summarize these in Lemma \ref{lemma-etale}
below. But before we do so we prove that {\it any} \'etale ring map is
standard smooth.

\begin{lemma}
\label{lemma-etale-standard-smooth}
Any \'etale ring map is standard smooth. More precisely, if
$R \to S$ is \'etale, then there exists a presentation
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$ such that
the image of $\det(\partial f_j/\partial x_i)$ is invertible in $S$.
\end{lemma}

\begin{proof}
Let $R \to S$ be \'etale. Choose a presentation $S = R[x_1, \ldots, x_n]/I$.
As $R \to S$ is \'etale we know that
$$
\text{d} :
I/I^2
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} S\text{d}x_i
$$
is an isomorphism, in particular $I/I^2$ is a free $S$-module.
Thus by Lemma \ref{lemma-huber} we may assume (after possibly changing
the presentation), that $I = (f_1, \ldots, f_c)$ such that the classes
$f_i \bmod I^2$ form a basis of $I/I^2$. It follows immediately from
the fact that the displayed map above is an isomorphism that $c = n$ and
that $\det(\partial f_j/\partial x_i)$ is invertible in $S$.
\end{proof}

\begin{lemma}
\label{lemma-etale}
Results on \'etale ring maps.
\begin{enumerate}
\item The ring map $R \to R_f$ is \'etale for any ring $R$ and any $f \in R$.
\item Compositions of \'etale ring maps are \'etale.
\item A base change of an \'etale ring map is \'etale.
\item The property of being \'etale is local: Given a ring map
$R \to S$ and elements $g_1, \ldots, g_m \in S$ which generate the unit ideal
such that $R \to S_{g_j}$ is \'etale for $j = 1, \ldots, m$ then
$R \to S$ is \'etale.
\item Given $R \to S$ of finite presentation, and a flat ring map
$R \to R'$, set $S' = R' \otimes_R S$. The set of primes where $R' \to S'$
is \'etale is the inverse image via $\Spec(S') \to \Spec(S)$
of the set of primes where $R \to S$ is \'etale.
\item An \'etale ring map is syntomic, in particular flat.
\item If $S$ is finite type over a field $k$, then $S$ is \'etale over
$k$ if and only if $\Omega_{S/k} = 0$.
\item Any \'etale ring map $R \to S$ is the base change of an \'etale
ring map $R_0 \to S_0$ with $R_0$ of finite type over $\mathbf{Z}$.
\item Let $A = \colim A_i$ be a filtered colimit of rings.
Let $A \to B$ be an \'etale ring map. Then there exists an \'etale ring
map $A_i \to B_i$ for some $i$ such that $B \cong A \otimes_{A_i} B_i$.
\item Let $A$ be a ring. Let $S$ be a multiplicative subset of $A$.
Let $S^{-1}A \to B'$ be \'etale. Then there exists an \'etale ring map
$A \to B$ such that $B' \cong S^{-1}B$.
\end{enumerate}
\end{lemma}

\begin{proof}
In each case we use the corresponding result for smooth ring maps with
a small argument added to show that $\Omega_{S/R}$ is zero.

\medskip\noindent
Proof of (1). The ring map $R \to R_f$ is smooth and $\Omega_{R_f/R} = 0$.

\medskip\noindent
Proof of (2). The composition $A \to C$ of smooth maps $A \to B$ and
$B \to C$ is smooth, see Lemma \ref{lemma-compose-smooth}. By
Lemma \ref{lemma-exact-sequence-differentials} we see that
$\Omega_{C/A}$ is zero as both $\Omega_{C/B}$ and $\Omega_{B/A}$ are zero.

\medskip\noindent
Proof of (3). Let $R \to S$ be \'etale and $R \to R'$ be arbitrary.
Then $R' \to S' = R' \otimes_R S$ is smooth, see
Lemma \ref{lemma-base-change-smooth}. Since
$\Omega_{S'/R'} = S' \otimes_S \Omega_{S/R}$ by
Lemma \ref{lemma-differentials-base-change}
we conclude that $\Omega_{S'/R'} = 0$. Hence $R' \to S'$ is \'etale.

\medskip\noindent
Proof of (4). Assume the hypotheses of (4). By
Lemma \ref{lemma-locally-smooth} we see that $R \to S$ is smooth.
We are also given that $\Omega_{S_{g_i}/R} = (\Omega_{S/R})_{g_i} = 0$
for all $i$. Then $\Omega_{S/R} = 0$, see Lemma \ref{lemma-cover}.

\medskip\noindent
Proof of (5). The result for smooth maps is
Lemma \ref{lemma-flat-base-change-locus-smooth}.
In the proof of that lemma we used that $\NL_{S/R} \otimes_S S'$
is homotopy equivalent to $\NL_{S'/R'}$.
This reduces us to showing that if $M$ is a finitely presented
$S$-module the set of primes $\mathfrak q'$ of $S'$
such that $(M \otimes_S S')_{\mathfrak q'} = 0$ is the inverse
image of the set of primes $\mathfrak q$ of $S$ such that
$M_{\mathfrak q} = 0$. This is true (proof omitted).

\medskip\noindent
Proof of (6). Follows directly from the corresponding result for
smooth ring maps (Lemma \ref{lemma-smooth-syntomic}).

\medskip\noindent
Proof of (7). Follows from Lemma \ref{lemma-characterize-smooth-over-field}
and the definitions.

\medskip\noindent
Proof of (8). Lemma \ref{lemma-finite-presentation-fs-Noetherian}
gives the result for smooth ring maps. The resulting smooth ring map
$R_0 \to S_0$ satisfies the
hypotheses of Lemma \ref{lemma-relative-dimension-CM}, and hence we may
replace $S_0$ by the factor of relative dimension $0$ over $R_0$.

\medskip\noindent
Proof of (9). Follows from (8) since $R_0 \to A$ will factor through
$A_i$ for some $i$ by Lemma \ref{lemma-characterize-finite-presentation}.

\medskip\noindent
Proof of (10). Follows from (9), (1), and (2) since $S^{-1}A$ is a
filtered colimit of principal localizations of $A$.
\end{proof}

\noindent
Next we work out in more detail what it means to be \'etale
over a field.

\begin{lemma}
\label{lemma-etale-over-field}
Let $k$ be a field. A ring map $k \to S$ is \'etale if and only if $S$
is isomorphic as a $k$-algebra to a finite product of finite separable
extensions of $k$.
\end{lemma}

\begin{proof}
If $k \to k'$ is a finite separable field extension then we can
write $k' = k(\alpha) \cong k[x]/(f)$. Here $f$ is the minimal
polynomial of the element $\alpha$. Since $k'$ is separable over $k$
we have $\gcd(f, f') = 1$. This
implies that $\text{d} : k'\cdot f \to k' \cdot \text{d}x$
is an isomorphism. Hence $k \to k'$ is \'etale.

\medskip\noindent
Conversely, suppose that $k \to S$ is \'etale. Let $\overline{k}$
be an algebraic closure of $k$. Then $S \otimes_k \overline{k}$
is \'etale over $\overline{k}$. Suppose we have the result over $\overline{k}$.
Then $S \otimes_k \overline{k}$ is reduced and hence $S$ is reduced.
Also, $S \otimes_k \overline{k}$ is finite over $\overline{k}$
and hence $S$ is finite over $k$. Hence $S$ is a finite product
$S = \prod k_i$
of fields, see
Lemma \ref{lemma-finite-dimensional-algebra}
and
Proposition \ref{proposition-dimension-zero-ring}.
The result over $\overline{k}$ means $S \otimes_k \overline{k}$
is isomorphic to a finite product of copies of $\overline{k}$, which
implies that each $k \subset k_i$ is finite separable, see for example
Lemmas \ref{lemma-characterize-separable-field-extensions} and
\ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.
Thus we have reduced to the case $k = \overline{k}$.
In this case
Lemma \ref{lemma-characterize-smooth-kbar}
(combined with $\Omega_{S/k} = 0$) we see that $S_{\mathfrak m} \cong k$
for all maximal ideals $\mathfrak m \subset S$. This implies the result
because $S$ is the product of the localizations at its maximal ideals by
Lemma \ref{lemma-finite-dimensional-algebra}
and
Proposition \ref{proposition-dimension-zero-ring}
again.
\end{proof}

\begin{lemma}
\label{lemma-etale-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$ in $R$.
If $S/R$ is \'etale at $\mathfrak q$ then
\begin{enumerate}
\item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$
is the maximal ideal of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable.
\end{enumerate}
\end{lemma}

\begin{proof}
First we may replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
and assume that $R \to S$ is \'etale. Then the lemma follows from
Lemma \ref{lemma-etale-over-field} by unwinding the
fact that $S \otimes_R \kappa(\mathfrak p)$ is \'etale over
$\kappa(\mathfrak p)$.
\end{proof}

\begin{lemma}
\label{lemma-etale-quasi-finite}
An \'etale ring map is quasi-finite.
\end{lemma}

\begin{proof}
Let $R \to S$ be an \'etale ring map. By definition $R \to S$ is of finite type.
For any prime $\mathfrak p \subset R$ the fibre ring
$S \otimes_R \kappa(\mathfrak p)$ is \'etale over $\kappa(\mathfrak p)$
and hence a finite products of fields finite separable over
$\kappa(\mathfrak p)$, in particular finite over $\kappa(\mathfrak p)$.
Thus $R \to S$ is quasi-finite by Lemma \ref{lemma-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-etale}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. If
\begin{enumerate}
\item $R \to S$ is of finite presentation,
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat
\item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal
of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable,
\end{enumerate}
then $R \to S$ is \'etale at $\mathfrak q$.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-isolated-point-fibre}
to find a $g \in S$, $g \not \in \mathfrak q$ such that
$\mathfrak q$ is the only prime of $S_g$ lying over $\mathfrak p$.
We may and do replace $S$ by $S_g$. Then
$S \otimes_R \kappa(\mathfrak p)$ has a unique prime, hence is a
local ring, hence is equal to
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
\cong \kappa(\mathfrak q)$.
By Lemma \ref{lemma-flat-fibre-smooth}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is smooth. Replace $S$ by $S_g$ again we may
assume that $R \to S$ is smooth. By
Lemma \ref{lemma-smooth-syntomic} we may even assume that
$R \to S$ is standard smooth, say $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Since $S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak q)$
has dimension $0$ we conclude that $n = c$, i.e.,
if $R \to S$ is \'etale.
\end{proof}

\noindent
Here is a completely new phenomenon.

\begin{lemma}
\label{lemma-map-between-etale}
Let $R \to S$ and $R \to S'$ be \'etale.
Then any $R$-algebra map $S' \to S$ is \'etale.
\end{lemma}

\begin{proof}
First of all we note that $S' \to S$ is of finite presentation by
Lemma \ref{lemma-compose-finite-type}.
Let $\mathfrak q \subset S$ be a prime ideal lying over the primes
$\mathfrak q' \subset S'$ and $\mathfrak p \subset R$.
By Lemma \ref{lemma-etale-at-prime} the ring map
$S_{\mathfrak q}/\mathfrak p S_{\mathfrak q} \to
S'_{\mathfrak q'}/\mathfrak p S'_{\mathfrak q'}$
is a map finite separable extensions of $\kappa(\mathfrak p)$.
In particular it is flat. Hence by
Lemma \ref{lemma-criterion-flatness-fibre} we see that
$S'_{\mathfrak q'} \to S_{\mathfrak q}$ is flat. Thus $S' \to S$
is flat. Moreover, the above also shows that $\mathfrak q'S_{\mathfrak q}$
is the maximal ideal of $S_{\mathfrak q}$ and that the residue
field extension of $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is
finite separable. Hence from Lemma \ref{lemma-characterize-etale}
we conclude that $S' \to S$ is \'etale at $\mathfrak q$. Since
being \'etale is local (see Lemma \ref{lemma-etale}) we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-flat-finitely-presented}
Let $\varphi :R \to S$ be a ring map. If $R \to S$ is surjective, flat and
finitely presented then there exist an idempotent $e \in R$ such that
$S = R_e$.
\end{lemma}

\begin{proof}
Since $\Spec(S) \to \Spec(R)$ is a homeomorphism
onto a closed subset (see Lemma \ref{lemma-spec-closed}) and
is open (see Proposition \ref{proposition-fppf-open}) we see that
the image is $D(e)$ for some idempotent $e \in R$ (see
Lemma \ref{lemma-disjoint-decomposition}). Thus $R_e \to S$
induces a bijection on spectra. Now this map induces an isomorphism
on all local rings for example by
Lemmas \ref{lemma-finite-flat-local} and \ref{lemma-NAK}.
Then it follows that $R_e \to S$ is also injective, for example
see Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-lift-etale}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be an \'etale ring map.
Then there exists an \'etale ring map
$R \to S$ such that $\overline{S} \cong S/IS$ as $R/I$-algebras.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-etale-standard-smooth} we can write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_n)$
as in Definition \ref{definition-standard-smooth} with
$\overline{\Delta} =
\det(\frac{\partial \overline{f}_i}{\partial x_j})_{i, j = 1, \ldots, n}$
invertible in $\overline{S}$. Just take some lifts $f_i$ and set
$S = R[x_1, \ldots, x_n, x_{n+1}]/(f_1, \ldots, f_c, x_{n + 1}\Delta - 1)$
where $\Delta = \det(\frac{\partial f_i}{\partial x_j})_{i, j = 1, \ldots, c}$
as in Example \ref{example-make-standard-smooth}.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-lift-etale-infinitesimal}
Consider a commutative diagram
$$
\xymatrix{
0 \ar[r] &
J \ar[r] &
B' \ar[r] &
B \ar[r] & 0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
A' \ar[r] \ar[u] &
A \ar[r] \ar[u] & 0
}
$$
with exact rows where $B' \to B$ and $A' \to A$ are surjective ring maps
whose kernels are ideals of square zero. If $A \to B$ is \'etale,
and $J = I \otimes_A B$, then $A' \to B'$ is \'etale.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-lift-etale}
there exists an \'etale ring map $A' \to C$ such that $C/IC = B$.
Then $A' \to C$ is formally smooth (by
Proposition \ref{proposition-smooth-formally-smooth})
hence we get an $A'$-algebra map $\varphi : C \to B'$.
Since $A' \to C$ is flat we have $I \otimes_A B = I \otimes_A C/IC = IC$.
Hence the assumption that $J = I \otimes_A B$ implies that
$\varphi$ induces an isomorphism $IC \to J$ and an isomorphism
$C/IC \to B'/IB'$, whence $\varphi$ is an isomorphism.
\end{proof}

\begin{example}
\label{example-factor-polynomials-etale}
Let $n , m \geq 1$ be integers. Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_{n + m}]
& \longrightarrow &
S = \mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\
a_1 & \longmapsto & b_1 + c_1 \\
a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\
\ldots & \ldots & \ldots \\
a_{n + m} & \longmapsto & b_n c_m
\end{eqnarray*}
of Example \ref{example-factor-polynomials}.
Write symbolically
$$
S = R[b_1, \ldots, c_m]/(\{a_k(b_i, c_j) - a_k\}_{k = 1, \ldots, n + m})
$$
where for example $a_1(b_i, c_j) = b_1 + c_1$.
The matrix of partial derivatives is
$$
\left(
\begin{matrix}
1 & c_1 & \ldots & c_m & 0 & \ldots & 0 \\
0 & 1 & c_1 & \ldots & c_m & \ldots & 0 \\
\ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\
0 & \ldots & 0 & 1 & c_1 & \ldots & c_m \\
1 & b_1 & \ldots & b_n & 0 & \ldots & 0 \\
0 & 1 & b_1 & \ldots & b_n & \ldots & 0 \\
\ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\
0 & \ldots & 0 & 1 & b_1 & \ldots & b_n \\
\end{matrix}
\right)
$$
The determinant $\Delta$ of this matrix is better known as the
{\it resultant} of the polynomials $g = x^n + b_1 x^{n - 1} + \ldots + b_n$
and $h = x^m + c_1 x^{m - 1} + \ldots + c_m$, and the matrix above
is known as the {\it Sylvester matrix} associated to $g, h$.
In a formula $\Delta = \text{Res}_x(g, h)$. The Sylvester matrix
is the transpose of the matrix of the linear map
\begin{eqnarray*}
S[x]_{< m} \oplus S[x]_{< n} & \longrightarrow & S[x]_{< n + m} \\
a \oplus b & \longmapsto & ag + bh
\end{eqnarray*}
Let $\mathfrak q \subset S$ be any prime. By the above the
following are equivalent:
\begin{enumerate}
\item $R \to S$ is \'etale at $\mathfrak q$,
\item $\Delta = \text{Res}_x(g, h) \not \in \mathfrak q$,
\item the images $\overline{g}, \overline{h} \in \kappa(\mathfrak q)[x]$
of the polynomials $g, h$ are relatively prime in $\kappa(\mathfrak q)[x]$.
\end{enumerate}
The equivalence of (2) and (3) holds because the image of the
Sylvester matrix in $\text{Mat}(n + m, \kappa(\mathfrak q))$
has a kernel if and only if the polynomials $\overline{g}, \overline{h}$
have a factor in common. We conclude that the ring map
$$
R \longrightarrow S[\frac{1}{\Delta}] = S[\frac{1}{\text{Res}_x(g, h)}]
$$
is \'etale.
\end{example}

\noindent
Lemma \ref{lemma-etale-standard-smooth} tells us that it does not really
make sense to define a standard \'etale morphism to be
a standard smooth morphism of relative dimension $0$.
As a model for an \'etale morphism we take the example given
by a finite separable extension $k \subset k'$ of fields.
Namely, we can always find an element $\alpha \in k'$ such
that $k' = k(\alpha)$ and such that the minimal polynomial
$f(x) \in k[x]$ of $\alpha$ has derivative $f'$ which is
relatively prime to $f$.

\begin{definition}
\label{definition-standard-etale}
Let $R$ be a ring. Let $g , f  \in R[x]$.
Assume that $f$ is monic and the derivative $f'$ is invertible in
the localization $R[x]_g/(f)$.
In this case the ring map $R \to R[x]_g/(f)$ is said to be
{\it standard \'etale}.
\end{definition}

\begin{lemma}
\label{lemma-standard-etale}
Let $R \to R[x]_g/(f)$ be standard \'etale.
\begin{enumerate}
\item The ring map $R \to R[x]_g/(f)$ is \'etale.
\item For any ring map $R \to R'$ the base change $R' \to R'[x]_g/(f)$
of the standard \'etale ring map $R \to R[x]_g/(f)$ is standard \'etale.
\item Any principal localization of $R[x]_g/(f)$ is standard \'etale over $R$.
\item A composition of standard \'etale maps is {\bf not} standard \'etale
in general.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Here is an example for (4).
The ring map $\mathbf{F}_2 \to \mathbf{F}_{2^2}$ is standard \'etale.
The ring map
$\mathbf{F}_{2^2} \to \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}
\times \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}$ is standard \'etale.
But the ring map
$\mathbf{F}_2 \to \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}
\times \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}$ is not standard \'etale.
\end{proof}

\noindent
Standard \'etale morphisms are a convenient way to produce \'etale maps.
Here is an example.

\begin{lemma}
\label{lemma-make-etale-map-prescribed-residue-field}
Let $R$ be a ring.
Let $\mathfrak p$ be a prime of $R$.
Let $\kappa(\mathfrak p) \subset L$ be a finite separable field extension.
There exists an \'etale ring map $R \to R'$ together with a prime $\mathfrak p'$
lying over $\mathfrak p$ such that the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is isomorphic
to $\kappa(\mathfrak p) \subset L$.
\end{lemma}

\begin{proof}
By the theorem of the primitive element we may write
$L = \kappa(\mathfrak p)[\alpha]$. Let
$\overline{f} \in \kappa(\mathfrak p)[x]$
denote the minimal polynomial for $\alpha$ (in particular this is monic).
After replacing $\alpha$ by $c\alpha$ for some $c \in R$,
$c\not \in \mathfrak p$ we may assume all the coefficients
of $\overline{f}$ are in the image of $R \to \kappa(\mathfrak p)$
(verification omitted). Thus we can find a monic polynomial
$f \in R[x]$ which maps to $\overline{f}$ in $\kappa(\mathfrak p)[x]$.
Since $\kappa(\mathfrak p) \subset L$ is separable, we see
that $\gcd(\overline{f}, \overline{f}') = 1$.
Hence there is an element $\gamma \in L$ such that
$\overline{f}'(\alpha) \gamma = 1$. Thus we get a $R$-algebra map
\begin{eqnarray*}
R[x, 1/f']/(f) & \longrightarrow & L \\
x & \longmapsto & \alpha \\
1/f' & \longmapsto & \gamma
\end{eqnarray*}
The left hand side is a standard \'etale algebra $R'$ over $R$
and the kernel of the ring map gives the desired prime.
\end{proof}






\begin{proposition}
\label{proposition-etale-locally-standard}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime.
If $R \to S$ is \'etale at $\mathfrak q$, then there exists
a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$
is standard \'etale.
\end{proposition}

\begin{proof}
The following proof is a little roundabout and there may be ways to
shorten it.

\medskip\noindent
Step 1. By Definition \ref{definition-etale}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is \'etale. Thus we may assume that $S$ is \'etale
over $R$.

\medskip\noindent
Step 2. By Lemma \ref{lemma-etale} there exists an \'etale ring map
$R_0 \to S_0$ with $R_0$ of finite type over $\mathbf{Z}$, and a ring map
$R_0 \to R$ such that $R = R \otimes_{R_0} S_0$. Denote
$\mathfrak q_0$ the prime of $S_0$ corresponding to $\mathfrak q$.
If we show the result for $(R_0 \to S_0, \mathfrak q_0)$ then the
result follows for $(R \to S, \mathfrak q)$ by base change. Hence
we may assume that $R$ is Noetherian.

\medskip\noindent
Step 3.
Note that $R \to S$ is quasi-finite by Lemma \ref{lemma-etale-quasi-finite}.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite ring map $R \to S'$, an $R$-algebra map
$S' \to S$, an element $g' \in S'$ such that
$g' \not \in \mathfrak q$ such that $S' \to S$ induces
an isomorphism $S'_{g'} \cong S_{g'}$.
(Note that of course $S'$ is not \'etale over $R$ in general.)
Thus we may assume that (a) $R$ is Noetherian, (b) $R \to S$ is finite
and (c) $R \to S$ is \'etale at $\mathfrak q$
(but no longer necessarily \'etale at all primes).

\medskip\noindent
Step 4. Let $\mathfrak p \subset R$ be the prime corresponding
to $\mathfrak q$. Consider the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. This is a finite algebra over
$\kappa(\mathfrak p)$. Hence it is Artinian
(see Lemma \ref{lemma-finite-dimensional-algebra}) and
so a finite product of local rings
$$
S \otimes_R \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n A_i
$$
see Proposition \ref{proposition-dimension-zero-ring}. One of the factors,
say $A_1$, is the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
which is isomorphic to $\kappa(\mathfrak q)$,
see Lemma \ref{lemma-etale-at-prime}. The other factors correspond to
the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of
$S$ lying over $\mathfrak p$.

\medskip\noindent
Step 5. We may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which
generates the finite separable field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ (so even if the
field extension is trivial we do not allow $\alpha = 0$).
Note that for any $\lambda \in \kappa(\mathfrak p)^*$ the
element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$
over $\kappa(\mathfrak p)$. Consider the element
$$
\overline{t} =
(\alpha, 0, \ldots, 0) \in
\prod\nolimits_{i = 1}^n A_i =
S \otimes_R \kappa(\mathfrak p).
$$
After possibly replacing $\alpha$ by $\lambda \alpha$ as above
we may assume that $\overline{t}$ is the image of $t \in S$.
Let $I \subset R[x]$ be the kernel of the $R$-algebra
map $R[x] \to S$ which maps $x$ to $t$. Set $S' = R[x]/I$,
so $S' \subset S$. Here is a diagram
$$
\xymatrix{
R[x] \ar[r] & S' \ar[r] & S \\
R \ar[u] \ar[ru] \ar[rru] & &
}
$$
By construction the primes $\mathfrak q_j$, $j \geq 2$ of $S$ all
lie over the prime $(\mathfrak p, x)$ of $R[x]$, whereas
the prime $\mathfrak q$ lies over a different prime of $R[x]$
because $\alpha \not = 0$.

\medskip\noindent
Step 6. Denote $\mathfrak q' \subset S'$ the prime of $S'$
corresponding to $\mathfrak q$. By the above $\mathfrak q$ is
the only prime of $S$ lying over $\mathfrak q'$. Thus we see that
$S_{\mathfrak q} = S_{\mathfrak q'}$, see
Lemma \ref{lemma-unique-prime-over-localize-below} (we have
going up for $S' \to S$ by Lemma \ref{lemma-integral-going-up}
since $S' \to S$ is finite as $R \to S$ is finite).
It follows that $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is finite
and injective as the localization of the finite injective ring map
$S' \to S$. Consider the maps of local rings
$$
R_{\mathfrak p} \to S'_{\mathfrak q'} \to S_{\mathfrak q}
$$
The second map is finite and injective. We have
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = \kappa(\mathfrak q)$,
see Lemma \ref{lemma-etale-at-prime}.
Hence a fortiori
$S_{\mathfrak q}/\mathfrak q'S_{\mathfrak q} = \kappa(\mathfrak q)$.
Since
$$
\kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q)
$$
and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in
$\kappa(\mathfrak q)$
we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$.
Hence by Nakayama's Lemma \ref{lemma-NAK} applied to the
$S'_{\mathfrak q'}$-module map $S'_{\mathfrak q'} \to S_{\mathfrak q}$,
the map $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is surjective.
In other words,
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.

\medskip\noindent
Step 7. By Lemma \ref{lemma-isomorphic-local-rings} there exist
$g \in S$, $g \not \in \mathfrak q$ and $g' \in S'$, $g' \not \in \mathfrak q'$
such that $S'_{g'} \cong S_g$. As $R$ is Noetherian the ring $S'$ is finite
over $R$ because it is an $R$-submodule
of the finite $R$-module $S$. Hence after replacing $S$ by $S'$ we may
assume that (a) $R$ is Noetherian, (b) $S$ finite over $R$, (c)
$S$ is \'etale over $R$ at $\mathfrak q$, and (d) $S = R[x]/I$.

\medskip\noindent
Step 8. Consider the ring
$S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{I}$
where $\overline{I} = I \cdot \kappa(\mathfrak p)[x]$ is the ideal generated
by $I$ in $\kappa(\mathfrak p)[x]$. As $\kappa(\mathfrak p)[x]$ is a PID
we know that $\overline{I} = (\overline{h})$ for some monic
$\overline{h} \in \kappa(\mathfrak p)$. After replacing $\overline{h}$
by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$
we may assume that $\overline{h}$ is the image of some $h \in R[x]$.
(The problem is that we do not know if we may choose $h$ monic.)
Also, as in Step 4 we know that
$S \otimes_R \kappa(\mathfrak p) = A_1 \times \ldots \times A_n$ with
$A_1 = \kappa(\mathfrak q)$ a finite separable extension of
$\kappa(\mathfrak p)$ and $A_2, \ldots, A_n$ local. This implies
that
$$
\overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
$$
for certain pairwise coprime irreducible monic polynomials
$\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain
$e_2, \ldots, e_n \geq 1$. Here the numbering is chosen so that
$A_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as
$\kappa(\mathfrak p)[x]$-algebras. Note that $\overline{h}_1$ is
the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence
is a separable polynomial (its derivative is prime to itself).

\medskip\noindent
Step 9. Let $m \in I$ be a monic element; such an element exists
because the ring extension $R \to R[x]/I$ is finite hence integral.
Denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$.
We may factor
$$
\overline{m} = \overline{k}
\overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n}
$$
for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and
$\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$.
Set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$.
Then $f$ is monic as a polynomial over $R$. Also, the image $\overline{f}$
of $f$ in $\kappa(\mathfrak p)[x]$ factors as
$$
\overline{f} =
\overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2}
\ldots \overline{h}_n^{ld_n}
=
\overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l
\overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n})
= \overline{h}_1 \overline{w}
$$
with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$.
Set $g = f'$ (the derivative with respect to $x$).

\medskip\noindent
Step 10. The ring map $R[x] \to S = R[x]/I$ has the properties:
(1) it maps $f$ to zero, and
(2) it maps $g$ to an element of $S \setminus \mathfrak q$.
The first assertion is clear since $f$ is an element of $I$.
For the second assertion we just have to show that $g$ does
not map to zero in
$\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$.
The image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative
of $\overline{f}$. Thus (2) is clear because
$$
\overline{g} =
\frac{\text{d}\overline{f}}{\text{d}x} =
\overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} +
\overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x},
$$
$\overline{w}$ is prime to $\overline{h}_1$ and
$\overline{h}_1$ is separable.

\medskip\noindent
Step 11.
We conclude that $\varphi : R[x]/(f) \to S$ is a surjective ring map,
$R[x]_g/(f)$ is \'etale over $R$ (because it is standard \'etale,
see Lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$.
Pick an element $g' \in R[x]/(f)$ such that
also $\varphi(g') \not \in \mathfrak q$ and $S_{\varphi(g')}$
is \'etale over $R$ (which exists since $S$ is \'etale over $R$ at
$\mathfrak q$). Then the ring map
$R[x]_{gg'}/(f) \to S_{\varphi(g)}$ is a surjective map of \'etale
algebras over $R$. Hence it is \'etale by Lemma \ref{lemma-map-between-etale}.
Hence it is a localization by
Lemma \ref{lemma-surjective-flat-finitely-presented}.
Thus a localization of $S$ at an element not in $\mathfrak q$ is
isomorphic to a localization of a standard \'etale algebra over $R$
which is what we wanted to show.
\end{proof}

\noindent
The following two lemmas say that the \'etale topology is coarser than the
topology generated by Zariski coverings and finite flat morphisms.
They should be skipped on a first reading.

\begin{lemma}
\label{lemma-standard-etale-finite-flat-Zariski}
Let $R \to S$ be a standard \'etale morphism.
There exists a ring map $R \to S'$ with the following properties
\begin{enumerate}
\item $R \to S'$ is finite, finitely presented, and flat
(in other words $S'$ is finite projective as an $R$-module),
\item $\Spec(S') \to \Spec(R)$ is surjective,
\item for every prime $\mathfrak q \subset S$, lying over
$\mathfrak p \subset R$ and every prime
$\mathfrak q' \subset S'$ lying over $\mathfrak p$ there exists
a $g' \in S'$, $g' \not \in \mathfrak q'$
such that the ring map $R \to S'_{g'}$ factors
through a map $\varphi : S \to S'_{g'}$ with
$\varphi^{-1}(\mathfrak q'S'_{g'}) = \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S = R[x]_g/(f)$ be a presentation of $S$ as in
Definition \ref{definition-standard-etale}.
Write $f = x^n + a_1 x^{n - 1} + \ldots + a_n$ with $a_i \in R$.
By Lemma \ref{lemma-adjoin-roots} there exists a finite locally free
and faithfully flat ring map $R \to S'$ such that $f = \prod (x - \alpha_i)$
for certain $\alpha_i \in S'$. Hence $R \to S'$ satisfies conditions (1), (2).
Let $\mathfrak q \subset R[x]/(f)$ be a prime ideal with
$g \not \in \mathfrak q$ (i.e., it corresponds to a prime of $S$).
Let $\mathfrak p = R \cap \mathfrak q$ and let
$\mathfrak q' \subset S'$ be a prime lying over $\mathfrak p$.
Note that there are
$n$ maps of $R$-algebras
\begin{eqnarray*}
\varphi_i : R[x]/(f) & \longrightarrow & S' \\
x & \longmapsto & \alpha_i
\end{eqnarray*}
To finish the proof we have to show that for some $i$ we have
(a) the image of $\varphi_i(g)$ in $\kappa(\mathfrak q')$ is not zero,
and (b) $\varphi_i^{-1}(\mathfrak q') = \mathfrak q$.
Because then we can just take $g' = \varphi_i(g)$, and
$\varphi = \varphi_i$ for that $i$.

\medskip\noindent
Let $\overline{f}$ denote the image of $f$ in $\kappa(\mathfrak p)[x]$.
Note that as a point of $\Spec(\kappa(\mathfrak p)[x]/(\overline{f}))$
the prime $\mathfrak q$ corresponds to an irreducible factor
$f_1$ of $\overline{f}$. Moreover, $g \not \in \mathfrak q$ means
that $f_1$ does not divide the image $\overline{g}$ of $g$ in
$\kappa(\mathfrak p)[x]$.
Denote $\overline{\alpha}_1, \ldots, \overline{\alpha}_n$ the images
of $\alpha_1, \ldots, \alpha_n$ in $\kappa(\mathfrak q')$.
Note that the polynomial $\overline{f}$ splits completely
in $\kappa(\mathfrak q')[x]$, namely
$$
\overline{f} = \prod\nolimits_i (x - \overline{\alpha}_i)
$$
Moreover $\varphi_i(g)$ reduces to $\overline{g}(\overline{\alpha}_i)$.
It follows we may pick $i$ such that $f_1(\overline{\alpha}_i) = 0$ and
$\overline{g}(\overline{\alpha}_i) \not = 0$.
For this $i$ properties (a) and (b) hold. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-etale-finite-flat-zariski}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is \'etale, and
\item $\Spec(S) \to \Spec(R)$ is surjective.
\end{enumerate}
Then there exists a ring map $R \to S'$ such that
\begin{enumerate}
\item $R \to S'$ is finite, finitely presented, and flat
(in other words it is finite projective as an $R$-module),
\item $\Spec(S') \to \Spec(R)$ is surjective,
\item for every prime $\mathfrak q' \subset S'$ there exists a
$g' \in S'$, $g' \not \in \mathfrak q'$ such that
the ring map $R \to S'_{g'}$ factors as $R \to S \to S'_{g'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-etale-locally-standard} and
the quasi-compactness of $\Spec(S)$ (see Lemma \ref{lemma-quasi-compact})
we can find $g_1, \ldots, g_n \in S$ generating the unit ideal
of $S$ such that each $R \to S_{g_i}$ is standard \'etale.
If we prove the lemma for the ring map $R \to \prod_{i = 1, \ldots, n} S_{g_i}$
then the lemma follows for the ring map $R \to S$.
Hence we may assume that $S = \prod_{i = 1, \ldots, n} S_i$
is a finite product of standard \'etale morphisms.

\medskip\noindent
For each $i$ choose a ring map $R \to S_i'$ as in
Lemma \ref{lemma-standard-etale-finite-flat-Zariski}
adapted to the standard \'etale morphism $R \to S_i$.
Set $S' = S_1' \otimes_R \ldots \otimes_R S_n'$; we will use
the $R$-algebra maps $S_i' \to S'$ without further mention below.
We claim this works. Properties (1) and (2) are immediate.
For property (3) suppose that $\mathfrak q' \subset S'$ is a prime.
Denote $\mathfrak p$ its image in $\Spec(R)$.
Choose $i \in \{1, \ldots, n\}$ such that $\mathfrak p$
is in the image of $\Spec(S_i) \to \Spec(R)$; this is
possible by assumption. Set $\mathfrak q_i' \subset S_i'$
the image of $\mathfrak q'$ in the spectrum of $S_i'$.
By construction of $S'_i$ there exists a $g'_i \in S_i'$
such that $R \to (S_i')_{g_i'}$ factors as
$R \to S_i \to (S_i')_{g_i'}$. Hence also
$R \to S'_{g_i'}$ factors as
$$
R \to S_i \to (S_i')_{g_i'} \to S'_{g_i'}
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-factor-mod-lift-etale}
Let $R$ be a ring. Let $f \in R[x]$ be a monic polynomial. Let $\mathfrak p$
be a prime of $R$. Let $f \bmod \mathfrak p = \overline{g} \overline{h}$
be a factorization of the image of $f$ in $\kappa(\mathfrak p)[x]$.
If $\gcd(\overline{g}, \overline{h}) = 1$, then there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, and
\item a factorization $f = g h$ in $R'[x]$
\end{enumerate}
such that
\begin{enumerate}
\item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item $\overline{g} = g \bmod \mathfrak p'$,
$\overline{h} = h \bmod \mathfrak p'$, and
\item the polynomials $g, h$ generate the unit ideal in $R'[x]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose
$\overline{g} = \overline{b}_0 x^n + \overline{b}_1 x^{n - 1} + \ldots
+ \overline{b}_n$, and
$\overline{h} = \overline{c}_0 x^m + \overline{c}_1 x^{m - 1} + \ldots
+ \overline{c}_m$ with $\overline{b}_0, \overline{c}_0 \in \kappa(\mathfrak p)$
nonzero. After localizing $R$ at some element of $R$ not contained in
$\mathfrak p$ we may assume $\overline{b}_0$ is the
image of an invertible element $b_0 \in R$. Replacing
$\overline{g}$ by $\overline{g}/b_0$ and
$\overline{h}$ by $b_0\overline{h}$ we reduce to the case where
$\overline{g}$, $\overline{h}$ are monic (verification omitted).
Say $\overline{g} = x^n + \overline{b}_1 x^{n - 1} + \ldots + \overline{b}_n$,
and $\overline{h} = x^m + \overline{c}_1 x^{m - 1} + \ldots + \overline{c}_m$.
Write $f = x^{n + m} + a_1 x^{n - 1} + \ldots + a_{n + m}$.
Consider the fibre product
$$
R' = R \otimes_{\mathbf{Z}[a_1, \ldots, a_{n + m}]}
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]
$$
where the map $\mathbf{Z}[a_k] \to \mathbf{Z}[b_i, c_j]$
is as in Examples \ref{example-factor-polynomials} and
\ref{example-factor-polynomials-etale}. By construction there
is an $R$-algebra map
$$
R' = R \otimes_{\mathbf{Z}[a_1, \ldots, a_{n + m}]}
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]
\longrightarrow
\kappa(\mathfrak p)
$$
which maps $b_i$ to $\overline{b}_i$ and $c_j$ to $\overline{c}_j$.
Denote $\mathfrak p' \subset R'$ the kernel of this map.
Since by assumption the polynomials $\overline{g}, \overline{h}$
are relatively prime we see that the element
$\Delta = \text{Res}_x(g, h) \in \mathbf{Z}[b_i, c_j]$
(see Example \ref{example-factor-polynomials-etale})
does not map to zero in $\kappa(\mathfrak p)$ under the displayed map.
We conclude that $R \to R'$ is \'etale at $\mathfrak p'$.
In fact a solution to the problem posed in the lemma is
the ring map $R \to R'[1/\Delta]$ and the prime
$\mathfrak p' R'[1/\Delta]$. Because $\text{Res}_x(f, g)$ is
invertible in this ring the Sylvester matrix is invertible over
$R'$ and hence $1 = a g +  b h$ for some $a, b \in R'[x]$
see Example \ref{example-factor-polynomials-etale}.
\end{proof}

\noindent
The following lemmas say roughly that after an \'etale extension
a quasi-finite ring map becomes finite.
To help interpret the results recall that the locus where a
finite type ring map is quasi-finite is open
(see Lemma \ref{lemma-quasi-finite-open}) and that formation of
this locus commutes with arbitrary base change
(see Lemma \ref{lemma-quasi-finite-base-change}).

\begin{lemma}
\label{lemma-produce-finite}
Let $R \to S' \to S$ be ring maps.
Let $\mathfrak p \subset R$ be a prime.
Let $g \in S'$ be an element.
Assume
\begin{enumerate}
\item $R \to S'$ is integral,
\item $R \to S$ is finite type,
\item $S'_g \cong S_g$, and
\item $g$ invertible in $S' \otimes_R \kappa(\mathfrak p)$.
\end{enumerate}
Then there exists a $f \in R$, $f \not \in \mathfrak p$ such
that $R_f \to S_f$ is finite.
\end{lemma}

\begin{proof}
By assumption the image $T$ of $V(g) \subset \Spec(S')$ under
the morphism $\Spec(S') \to \Spec(R)$ does not
contain $\mathfrak p$. By Section \ref{section-going-up}
especially, Lemma \ref{lemma-going-up-closed} we see $T$ is closed.
Pick $f \in R$, $f \not \in \mathfrak p$ such that
$T \cap V(f) = \emptyset$. Then we see that $g$ becomes invertible
in $S'_f$. Hence $S'_f \cong S_f$. Thus $S_f$ is both of finite type
and integral over $R_f$, hence finite.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-one-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over
the prime $\mathfrak p \subset R$.
Assume $R \to S$ finite type and quasi-finite at $\mathfrak q$.
Then there exists
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item $R' \to A$ is finite,
\item $A$ has exactly one prime $\mathfrak r$ lying over $\mathfrak p'$, and
\item $\mathfrak r$ lies over $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Let $\mathfrak q' = S' \cap \mathfrak q$.
By Zariski's Main Theorem \ref{theorem-main-theorem}
there exists a $g \in S'$, $g \not \in \mathfrak q'$ such
that $S'_g \cong S_g$. Consider the fibre rings
$F = S \otimes_R \kappa(\mathfrak p)$ and
$F' = S' \otimes_R \kappa(\mathfrak p)$. Denote $\overline{\mathfrak q}'$
the prime of $F'$ corresponding to $\mathfrak q'$. Since
$F'$ is integral over $\kappa(\mathfrak p)$ we see
that $\overline{\mathfrak q}'$ is a closed point of
$\Spec(F')$, see Lemma \ref{lemma-integral-over-field}.
Note that $\mathfrak q$ defines an isolated closed point
$\overline{\mathfrak q}$ of
$\Spec(F)$ (see Definition \ref{definition-quasi-finite}).
Since $S'_g \cong S_g$ we have $F'_g \cong F_g$,
so $\overline{\mathfrak q}$ and $\overline{\mathfrak q}'$
have isomorphic open neighbourhoods in $\Spec(F)$
and $\Spec(F')$. We conclude the set
$\{\overline{\mathfrak q}'\} \subset \Spec(F')$ is
open. Combined with $\mathfrak q'$ being closed (shown above)
we conclude that $\overline{\mathfrak q}'$ defines
an isolated closed point of $\Spec(F')$ as well.

\medskip\noindent
An additional small remark is that under the map
$\Spec(F) \to \Spec(F')$ the point $\overline{\mathfrak q}$
is the only point mapping to $\overline{\mathfrak q}'$. This follows
from the discussion above.

\medskip\noindent
By Lemma \ref{lemma-disjoint-implies-product} we may write
$F' = F'_1 \times F'_2$ with
$\Spec(F'_1) = \{\overline{\mathfrak q}'\}$.
Since $F' = S' \otimes_R \kappa(\mathfrak p)$, there
exists an $s' \in S'$ which maps to the element
$(r, 0) \in F'_1 \times F'_2 = F'$ for some $r \in R$, $r \not \in \mathfrak p$.
In fact, what we will use about $s'$ is that it is an element of $S'$,
not contained in $\mathfrak q'$, and contained in any other prime
lying over $\mathfrak p$.

\medskip\noindent
Let $f(x) \in R[x]$ be a monic polynomial such that $f(s') = 0$.
Denote $\overline{f} \in \kappa(\mathfrak p)[x]$ the image.
We can factor it as $\overline{f} = x^e \overline{h}$ where
$\overline{h}(0) \not = 0$. By Lemma \ref{lemma-factor-mod-lift-etale}
we can find an \'etale ring extension $R \to R'$,
a prime $\mathfrak p'$ lying over $\mathfrak p$, and
a factorization $f = h i$ in $R'[x]$ such that
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
$x^e = h \bmod \mathfrak p'$,
$\overline{i} = i \bmod \mathfrak p'$, and
we can write $a h + b i = 1$ in $R'[x]$ (for suitable $a, b$).

\medskip\noindent
Consider the elements $h(s'), i(s') \in R' \otimes_R S'$.
By construction we have $h(s')i(s') = f(s') = 0$. On the other
hand they generate the unit ideal since $a(s')h(s') + b(s')i(s') = 1$.
Thus we see that $R' \otimes_R S'$ is the product of the
localizations at these elements:
$$
R' \otimes_R S'
=
(R' \otimes_R S')_{h(s')}
\times
(R' \otimes_R S')_{i(s')}
=
S'_1 \times S'_2
$$
Moreover this product decomposition is compatible with the product
decomposition we found for the fibre ring $F'$; this comes from our
choice of $s', h$ which guarantee that $\overline{\mathfrak q}'$
is the only prime of $F'$ which does not contain the image of $h(s')$
in $F'$. Here we use that the fibre ring of $R'\otimes_R S'$ over $R'$ at
$\mathfrak p'$ is the same as $F'$ due to the fact that
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$.
It follows that $S'_1$  has exactly
one prime, say $\mathfrak r'$,
lying over $\mathfrak p'$ and
that this prime lies over $\mathfrak q$.
Hence the element $g \in S'$ maps to an element of $S'_1$ not contained
in $\mathfrak r'$.

\medskip\noindent
The base change $R'\otimes_R S$ inherits a similar product decomposition
$$
R' \otimes_R S
=
(R' \otimes_R S)_{h(s')}
\times
(R' \otimes_R S)_{i(s')}
=
S_1 \times S_2
$$
It follows from the above that $S_1$ has exactly
one prime, say $\mathfrak r$,
lying over $\mathfrak p'$ (consider the fibre ring as above),
and that this prime lies over $\mathfrak q$.

\medskip\noindent
Now we may apply Lemma \ref{lemma-produce-finite} to the ring maps
$R' \to S'_1 \to S_1$, the prime $\mathfrak p'$ and
the element $g$ to see that after replacing $R'$ by
a principal localization we can assume that $S_1$ is
finite over $R'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume $R \to S$ finite type.
Then there exists
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item we have $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item each $A_i$ is finite over $R'$,
\item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over
$\mathfrak p'$, and
\item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $F = S \otimes_R \kappa(\mathfrak p)$ the fibre ring of $S/R$
at the prime $\mathfrak p$. As $F$ is of finite type over $\kappa(\mathfrak p)$
it is Noetherian and hence $\Spec(F)$ has finitely many isolated closed
points. If there are no isolated closed points,
i.e., no primes $\mathfrak q$ of $S$ over $\mathfrak p$ such that
$S/R$ is quasi-finite at $\mathfrak q$, then the lemma holds.
If there exists at least one such prime $\mathfrak q$, then
we may apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-one-prime}.
This gives a diagram
$$
\xymatrix{
S \ar[r] & R'\otimes_R S \ar@{=}[r] & A_1 \times B' \\
R \ar[r] \ar[u] & R' \ar[u] \ar[ru]
}
$$
as in said lemma. Since the residue fields at $\mathfrak p$ and $\mathfrak p'$
are the same, the fibre rings of $S/R$ and $(A \times B)/R'$
are the same. Hence, by induction on the number of isolated closed points
of the fibre we may assume that the lemma holds for
$R' \to B$ and $\mathfrak p'$. Thus we get an \'etale ring
map $R' \to R''$, a prime $\mathfrak p'' \subset R''$ and
a decomposition
$$
R'' \otimes_{R'} B' = A_2 \times \ldots \times A_n \times B
$$
We omit the verification that the ring map $R \to R''$, the
prime $\mathfrak p''$ and the resulting decomposition
$$
R'' \otimes_R S = (R'' \otimes_{R'} A_1) \times
A_2 \times \ldots \times A_n \times B
$$
is a solution to the problem posed in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-variant}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume $R \to S$ finite type.
Then there exists
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item each $A_i$ is finite over $R'$,
\item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over
$\mathfrak p'$,
\item the finite field extensions
$\kappa(\mathfrak p') \subset \kappa(\mathfrak r_i)$
are purely inseparable, and
\item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
The strategy of the proof is to make two \'etale ring
extensions: first we control the residue fields, then we
apply Lemma \ref{lemma-etale-makes-quasi-finite-finite}.

\medskip\noindent
Denote $F = S \otimes_R \kappa(\mathfrak p)$ the fibre ring of $S/R$
at the prime $\mathfrak p$.
As in the proof of Lemma \ref{lemma-etale-makes-quasi-finite-finite}
there are finitely may primes, say
$\mathfrak q_1, \ldots, \mathfrak q_n$ of $S$ lying over
$R$ at which the ring map $R \to S$ is quasi-finite.
Let $\kappa(\mathfrak p) \subset L_i \subset \kappa(\mathfrak q_i)$
be the subfield such that $\kappa(\mathfrak p) \subset L_i$
is separable, and the field extension $L_i \subset \kappa(\mathfrak q_i)$
is purely inseparable. Let $\kappa(\mathfrak p) \subset L$
be a finite Galois extension into which $L_i$ embeds for $i = 1, \ldots, n$.
By Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
we can find an \'etale ring extension
$R \to R'$ together with a prime $\mathfrak p'$ lying over $\mathfrak p$
such that the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is isomorphic
to $\kappa(\mathfrak p) \subset L$.
Thus the fibre ring of $R' \otimes_R S$ at $\mathfrak p'$ is
isomorphic to $F \otimes_{\kappa(\mathfrak p)} L$.
The primes lying over $\mathfrak q_i$ correspond to primes
of $\kappa(\mathfrak q_i) \otimes_{\kappa(\mathfrak p)} L$
which is a product of fields purely inseparable over
$L$ by our choice of $L$ and elementary field theory.
These are also the only primes over $\mathfrak p'$
at which $R' \to R' \otimes_R S$ is quasi-finite, by
Lemma \ref{lemma-quasi-finite-base-change}.
Hence after replacing $R$ by $R'$, $\mathfrak p$ by $\mathfrak p'$,
and $S$ by $R' \otimes_R S$ we may assume that for all
primes $\mathfrak q$ lying over $\mathfrak p$
for which $S/R$ is quasi-finite the field extensions
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
are purely inseparable.

\medskip\noindent
Next apply Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
The result is what we want since the field extensions do not
change under this \'etale ring extension.
\end{proof}







\section{Local homomorphisms}
\label{section-local-homomorphisms}

\begin{lemma}
\label{lemma-etale-under-finite-flat}
Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism
of local rings. Assume $S$ is the localization of an \'etale ring extension
of $R$. Then there exists a finite, finitely presented, faithfully flat
ring map $R \to S'$ such that for every maximal ideal $\mathfrak m'$ of $S'$
there is a factorization
$$
R \to S \to S'_{\mathfrak m'}.
$$
of the ring map $R \to S'_{\mathfrak m'}$.
\end{lemma}

\begin{proof}
Write $S = T_{\mathfrak q}$ for some \'etale $R$-algebra $T$. By
Proposition \ref{proposition-etale-locally-standard}
we may assume $T$ is standard \'etale.
Apply
Lemma \ref{lemma-standard-etale-finite-flat-Zariski}
to the ring map $R \to T$ to get $R \to S'$. Then in particular
for every maximal ideal $\mathfrak m'$ of $S'$ we get a factorization
$\varphi : T \to S'_{g'}$ for some $g' \not \in \mathfrak m'$ such
that $\mathfrak q = \varphi^{-1}(\mathfrak m'S'_{g'})$. Thus $\varphi$
induces the desired local ring map $S \to S'_{\mathfrak m'}$.
\end{proof}





\section{Integral closure and smooth base change}
\label{section-integral-closure-smooth-base-change}

\begin{lemma}
\label{lemma-trick}
Let $R$ be a ring.
Let $f \in R[x]$ be a monic polynomial.
Let $R \to B$ be a ring map.
If $h \in B[x]/(f)$ is integral over $R$, then the element
$f' h$ can be written as $f'h = \sum_i b_i x^i$ with $b_i \in B$
integral over $R$.
\end{lemma}

\begin{proof}
Say $h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $B[x]/(f)$
with $r_i \in R$.
There exists a finite free ring extension $B \subset B'$ such that
$f = (x - \alpha_1) \ldots (x - \alpha_d)$ for some $\alpha_i \in B'$,
see Lemma \ref{lemma-adjoin-roots}.
Note that each $\alpha_i$ is integral over $R$.
We may represent $h = h_0 + h_1 x + \ldots + h_{d - 1} x^{d - 1}$
with $h_i \in B$. Then it is a universal fact that
$$
f' h
\equiv
\sum\nolimits_{i = 1, \ldots, d}
h(\alpha_i)
(x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d)
$$
as elements of $B[x]/(f)$. You prove this by
evaluating both sides at the points $\alpha_i$ over the ring
$B_{univ} = \mathbf{Z}[\alpha_i, h_j]$ (some details omitted).
By our assumption that $h$ satisfies
$h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $B[x]/(f)$
we see that
$$
h(\alpha_i)^e + r_1 h(\alpha_i)^{e - 1} + \ldots + r_e = 0
$$
in $B'$. Hence $h(\alpha_i)$ is integral over $R$. Using the formula
above we see that $f'h \equiv \sum_{j = 0, \ldots, d - 1} b'_j x^j$
in $B'[x]/(f)$ with $b'_j \in B'$ integral over $R$. However,
since $f' h \in B[x]/(f)$ and since $1, x, \ldots, x^{d - 1}$ is a
$B'$-basis for $B'[x]/(f)$ we see that $b'_j \in B$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-commutes-etale}
Let $R \to S$ be an \'etale ring map.
Let $R \to B$ be any ring map.
Let $A \subset B$ be the integral closure of $R$ in $B$.
Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in
$S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is
an isomorphism.
\end{lemma}

\begin{proof}
The map $S \otimes_R A \to A'$ is injective because $A \subset B$ and
$R \to S$ is flat. We are going to use repeatedly that taking integral
closure commutes with localization, see
Lemma \ref{lemma-integral-closure-localize}.
Hence we may localize on $S$, by Lemma \ref{lemma-cover} (the criterion
for checking whether an $S$-module map is an isomorphism).
Thus we may assume that $S = R[x]_g/(f) = (R[x]/(f))_g$
is standard \'etale over $R$,
see Proposition \ref{proposition-etale-locally-standard}.
Applying localization one more time we see that
$A'$ is $(A'')_g$ where $A''$ is the integral closure of
$R[x]/(f)$ in $B[x]/(f)$. Suppose that $a \in A''$. It suffices
to show that $a$ is in $S \otimes_R A$. By
Lemma \ref{lemma-trick} we see that $f' a = \sum a_i x^i$ with $a_i \in A$.
Since $f'$ is invertible in $B[x]_g/(f)$ (by definition of a standard
\'etale ring map) we conclude that $a \in S \otimes_R A$ as desired.
\end{proof}

\begin{example}
\label{example-fourier}
Let $p$ be a prime number. The ring extension
$$
R = \mathbf{Z}[1/p] \subset
R' = \mathbf{Z}[1/p][x]/(x^{p - 1} + \ldots + x + 1)
$$
has the following property: For $d < p$ there exist elements
$\alpha_0, \ldots, \alpha_{d - 1} \in R'$ such that
$$
\prod\nolimits_{0 \leq i < j < d} (\alpha_i - \alpha_j)
$$
is a unit in $R'$. Namely, take $\alpha_i$ equal to the class of
$x^i$ in $R'$ for $i = 0, \ldots, p - 1$. Then we have
$$
T^p - 1 = \prod\nolimits_{i = 0, \ldots, p - 1} (T - \alpha_i)
$$
in $R'[T]$. Namely, the ring  $\mathbf{Q}[x]/(x^{p - 1} + \ldots + x + 1)$
is a field because the cyclotomic polynomial $x^{p - 1} + \ldots + x + 1$
is irreducible over $\mathbf{Q}$ and the $\alpha_i$ are pairwise distinct
roots of $T^p - 1$, whence the equality. Taking
derivatives on both sides and substituting $T = \alpha_i$ we obtain
$$
p \alpha_i^{p - 1}
=
(\alpha_i - \alpha_1) \ldots
\widehat{(\alpha_i - \alpha_i)} \ldots
(\alpha_i - \alpha_1)
$$
and we see this is invertible in $R'$.
\end{example}

\begin{lemma}
\label{lemma-integral-closure-commutes-smooth}
Let $R \to S$ be a smooth ring map.
Let $R \to B$ be any ring map.
Let $A \subset B$ be the integral closure of $R$ in $B$.
Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in
$S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is
an isomorphism.
\end{lemma}

\begin{proof}
Arguing as in the proof of Lemma \ref{lemma-integral-closure-commutes-etale}
we may localize on $S$. Hence we may assume that $R \to S$ is a standard
smooth ring map, see Lemma \ref{lemma-smooth-syntomic}. By definition of
a standard smooth ring map we see that $S$ is \'etale over a polynomial
ring $R[x_1, \ldots, x_n]$. Since we have seen the result in the case of
an \'etale ring extension (Lemma \ref{lemma-integral-closure-commutes-etale})
this reduces us to the case where $S = R[x]$. Thus we have to show
$$
f = \sum b_i x^i
\text{ integral over }R[x]
\Leftrightarrow
\text{each }b_i\text{ integral over }R.
$$
The implication from right to left holds because the set of elements
in $B[x]$ integral over $R[x]$ is a ring
(Lemma \ref{lemma-integral-closure-is-ring}) and contains
$x$.

\medskip\noindent
Suppose that $f \in B[x]$ is integral over $R[x]$, and assume that
$f = \sum_{i < d} b_i x^i$ has degree $< d$. Since integral closure
and localization commute, it suffices to show there exist
distinct primes $p, q$ such that each $b_i$ is
integral both over $R[1/p]$ and over $R[1/q]$. Hence, we can find a finite
free ring extension $R \subset R'$ such that $R'$ contains
$\alpha_1, \ldots, \alpha_d$ with the property that
$\prod_{i < j} (\alpha_i - \alpha_j)$ is a unit in $R'$, see
Example \ref{example-fourier}.
In this case we have the universal equality
$$
f
=
\sum_i
f(\alpha_i)
\frac{(x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d)}
{(\alpha_i - \alpha_1) \ldots \widehat{(\alpha_i - \alpha_i)} \ldots
(\alpha_i - \alpha_d)}.
$$
OK, and the elements $f(\alpha_i)$ are integral over $R'$ since
$(R' \otimes_R B)[x] \to R' \otimes_R B$, $h \mapsto h(\alpha_i)$
is a ring map. Hence we see that the coefficients of $f$
in $(R' \otimes_R B)[x]$ are integral over over $R'$. Since $R'$ is finite
over $R$ (hence integral over $R$) we see that they are integral
over $R$ also, as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-commutes-colim-smooth}
Let $R \to S$ and $R \to B$ be ring maps.
Let $A \subset B$ be the integral closure of $R$ in $B$.
Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in
$S \otimes_R B$. If $S$ is a filtered colimit of smooth $R$-algebras,
then the canonical map $S \otimes_R A \to A'$ is an isomorphism.
\end{lemma}

\begin{proof}
This follows from the straightforward fact that taking
tensor products and taking integral closures
commutes with filtered colimits and
Lemma \ref{lemma-integral-closure-commutes-smooth}.
\end{proof}






\section{Formally unramified maps}
\label{section-formally-unramified}

\noindent
It turns out to be logically more efficient to define
the notion of a formally unramified map before introducing
the notion of a formally \'etale one.

\begin{definition}
\label{definition-formally-unramified}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally unramified over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there exists
at most one dotted arrow making the diagram commute.
\end{definition}

\begin{lemma}
\label{lemma-characterize-formally-unramified}
Let $R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally unramified,
\item the module of differentials $\Omega_{S/R}$ is zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $J = \Ker(S \otimes_R S \to S)$ be the kernel of
the multiplication map. Let $A_{univ} = S \otimes_R S/J^2$. Recall
that $I_{univ} = J/J^2$ is isomorphic to $\Omega_{S/R}$, see
Lemma \ref{lemma-differentials-diagonal}. Moreover, the two $R$-algebra maps
$\sigma_1, \sigma_2 : S \to A_{univ}$, $\sigma_1(s) = s \otimes 1 \bmod J^2$,
and $\sigma_2(s) = 1 \otimes s \bmod J^2$ differ by the
universal derivation $\text{d} : S \to \Omega_{S/R} = I_{univ}$.

\medskip\noindent
Assume $R \to S$ formally unramified.
Then we see that $\sigma_1 = \sigma_2$.
Hence $\text{d}(s) = 0$ for all $s \in S$.
Hence $\Omega_{S/R} = 0$.

\medskip\noindent
Assume that $\Omega_{S/R} = 0$. Let $A, I, R \to A, S \to A/I$
be a solid diagram as in Definition \ref{definition-formally-unramified}.
Let $\tau_1, \tau_2 : S \to A$ be two dotted arrows making the
diagram commute. Consider the $R$-algebra map $A_{univ} \to A$
defined by the rule $s_1 \otimes s_2 \mapsto \tau_1(s_1)\tau_2(s_2)$.
We omit the verification that this is well defined. Since $A_{univ} \cong S$
as $I_{univ} = \Omega_{S/R} = 0$ we conclude that $\tau_1 = \tau_2$.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-local}
Let $R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally unramified,
\item $R \to S_{\mathfrak q}$ is formally unramified for all
primes $\mathfrak q$ of $S$, and
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is formally unramified
for all primes $\mathfrak q$ of $S$ with $\mathfrak p = R \cap \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-characterize-formally-unramified}
that (1) is equivalent to
$\Omega_{S/R} = 0$. Similarly, by
Lemma \ref{lemma-differentials-localize}
we see that (2) and (3)
are equivalent to $(\Omega_{S/R})_{\mathfrak q} = 0$ for all
$\mathfrak q$. Hence the equivalence follows from
Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-localize}
Let $A \to B$ be a formally unramified ring map.
\begin{enumerate}
\item For $S \subset A$ a multiplicative subset,
$S^{-1}A \to S^{-1}B$ is formally unramified.
\item For $S \subset B$ a multiplicative subset,
$A \to S^{-1}B$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-formally-unramified-local}.
(You can also deduce it from
Lemma \ref{lemma-characterize-formally-unramified}
combined with
Lemma \ref{lemma-differentials-localize}.)
\end{proof}

\begin{lemma}
\label{lemma-colimit-formally-unramified}
Let $R$ be a ring. Let $I$ be a directed set.
Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras
over $I$. If each $R \to S_i$ is formally unramified, then
$S = \colim_{i \in I} S_i$ is formally unramified over $R$
\end{lemma}

\begin{proof}
Consider a diagram as in Definition \ref{definition-formally-unramified}.
By assumption there exists at most one $R$-algebra map $S_i \to A$ lifting
the compositions $S_i \to S \to A/I$. Since every element of $S$
is in the image of one of the maps $S_i \to S$ we see that there
is at most one map $S \to A$ fitting into the diagram.
\end{proof}



\section{Conormal modules and universal thickenings}
\label{section-conormal}

\noindent
It turns out that one can define the first infinitesimal neighbourhood
not just for a closed immersion of schemes, but already for any formally
unramified morphism. This is based on the following algebraic fact.

\begin{lemma}
\label{lemma-universal-thickening}
Let $R \to S$ be a formally unramified ring map. There exists a surjection of
$R$-algebras $S' \to S$ whose kernel is an ideal of square zero with the
following universal property: Given any commutative diagram
$$
\xymatrix{
S \ar[r]_a & A/I \\
R \ar[r]^b \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there is a unique $R$-algebra
map $a' : S' \to A$ such that $S' \to A \to A/I$ is equal to $S' \to S \to A/I$.
\end{lemma}

\begin{proof}
Choose a set of generators $z_i \in S$, $i \in I$ for $S$ as an $R$-algebra.
Let $P = R[\{x_i\}_{i \in I}]$ denote the polynomial ring on generators
$x_i$, $i \in I$. Consider the $R$-algebra map $P \to S$ which maps
$x_i$ to $z_i$. Let $J = \Ker(P \to S)$. Consider the map
$$
\text{d} : J/J^2 \longrightarrow \Omega_{P/R} \otimes_P S
$$
see
Lemma \ref{lemma-differential-seq}.
This is surjective since $\Omega_{S/R} = 0$ by assumption, see
Lemma \ref{lemma-characterize-formally-unramified}.
Note that $\Omega_{P/R}$ is free on $\text{d}x_i$, and hence the module
$\Omega_{P/R} \otimes_P S$ is free over $S$. Thus we may choose a splitting
of the surjection above and write
$$
J/J^2 = K \oplus \Omega_{P/R} \otimes_P S
$$
Let $J^2 \subset J' \subset J$ be the ideal of $P$ such that
$J'/J^2$ is the second summand in the decomposition above.
Set $S' = P/J'$. We obtain a short exact sequence
$$
0 \to J/J' \to S' \to S \to 0
$$
and we see that $J/J' \cong K$ is a square zero ideal in $S'$. Hence
$$
\xymatrix{
S \ar[r]_1 & S \\
R \ar[r] \ar[u] & S' \ar[u]
}
$$
is a diagram as above. In fact we claim that this is an initial object in
the category of diagrams. Namely, let $(I \subset A, a, b)$ be an arbitrary
diagram. We may choose an $R$-algebra map $\beta : P \to A$ such that
$$
\xymatrix{
S \ar[r]_1 & S \ar[r]_a & A/I \\
R \ar[r] \ar@/_/[rr]_b \ar[u] & P \ar[u] \ar[r]^\beta & A \ar[u]
}
$$
is commutative. Now it may not be the case that $\beta(J') = 0$, in other
words it may not be true that $\beta$ factors through $S' = P/J'$.
But what is clear is that $\beta(J') \subset I$ and
since $\beta(J) \subset I$ and $I^2 = 0$ we have $\beta(J^2) = 0$.
Thus the ``obstruction'' to finding a morphism from
$(J/J' \subset S', 1, R \to S')$ to $(I \subset A, a, b)$ is
the corresponding $S$-linear map $\overline{\beta} : J'/J^2 \to I$.
The choice in picking $\beta$ lies in the choice of $\beta(x_i)$.
A different choice of $\beta$, say $\beta'$, is gotten by taking
$\beta'(x_i) = \beta(x_i) + \delta_i$ with $\delta_i \in I$.
In this case, for $g \in J'$, we obtain
$$
\beta'(g) =
\beta(g) + \sum\nolimits_i \delta_i \frac{\partial g}{\partial x_i}.
$$
Since the map $\text{d}|_{J'/J^2} : J'/J^2 \to \Omega_{P/R} \otimes_P S$
given by $g \mapsto \frac{\partial g}{\partial x_i}\text{d}x_i$
is an isomorphism by construction, we see that there is a unique choice
of $\delta_i \in I$ such that $\beta'(g) = 0$ for all $g \in J'$.
(Namely, $\delta_i$ is $-\overline{\beta}(g)$ where $g \in J'/J^2$
is the unique element with $\frac{\partial g}{\partial x_j} = 1$ if
$i = j$ and $0$ else.) The uniqueness of the solution implies the
uniqueness required in the lemma.
\end{proof}

\noindent
In the situation of
Lemma \ref{lemma-universal-thickening}
the $R$-algebra map $S' \to S$ is unique up to unique isomorphism.

\begin{definition}
\label{definition-universal-thickening}
Let $R \to S$ be a formally unramified ring map.
\begin{enumerate}
\item The {\it universal first order thickening} of $S$ over $R$ is
the surjection of $R$-algebras $S' \to S$ of
Lemma \ref{lemma-universal-thickening}.
\item The {\it conormal module} of $R \to S$ is the kernel $I$ of the
universal first order thickening $S' \to S$, seen as an $S$-module.
\end{enumerate}
We often denote the conormal module {\it $C_{S/R}$} in this situation.
\end{definition}

\begin{lemma}
\label{lemma-universal-thickening-quotient}
Let $I \subset R$ be an ideal of a ring.
The universal first order thickening of $R/I$ over $R$
is the surjection $R/I^2 \to R/I$. The conormal module
of $R/I$ over $R$ is $C_{(R/I)/R} = I/I^2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Let $A \to B$ be a formally unramified ring map.
Let $\varphi : B' \to B$ be the universal first order thickening of
$B$ over $A$.
\begin{enumerate}
\item Let $S \subset A$ be a multiplicative subset.
Then $S^{-1}B' \to S^{-1}B$ is the universal first order thickening of
$S^{-1}B$ over $S^{-1}A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/S^{-1}A}$.
\item Let $S \subset B$ be a multiplicative subset.
Then $S' = \varphi^{-1}(S)$ is a multiplicative subset in $B'$
and $(S')^{-1}B' \to S^{-1}B$ is the universal first order thickening
of $S^{-1}B$ over $A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/A}$.
\end{enumerate}
Note that the lemma makes sense by
Lemma \ref{lemma-formally-unramified-localize}.
\end{lemma}

\begin{proof}
With notation and assumptions as in (1). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $S^{-1}A$.
Note that $S^{-1}B' \to S^{-1}B$ is a surjection of $S^{-1}A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to S^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & S^{-1}A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$S^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $S^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.

\medskip\noindent
With notation and assumptions as in (2). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $A$.
Note that $(S')^{-1}B' \to S^{-1}B$ is a surjection of $A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to (S')^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S'$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$(S')^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $(S')^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universal-thickening}
Let $R \to A  \to B$ be ring maps. Assume $A \to B$ formally unramified.
Let $B' \to B$ be the universal first order thickening of $B$ over $A$.
Then $B'$ is formally unramified over $A$, and the canonical map
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$ is an
isomorphism.
\end{lemma}

\begin{proof}
We are going to use the construction of $B'$ from the proof of
Lemma \ref{lemma-universal-thickening}
although in principle it should be possible to deduce these results
formally from the definition. Namely, we choose a presentation
$B = P/J$, where $P = A[x_i]$ is a polynomial ring over $A$.
Next, we choose elements $f_i \in J$ such that
$\text{d}f_i = \text{d}x_i \otimes 1$ in $\Omega_{P/A} \otimes_P B$.
Having made these choices we have
$B' = P/J'$ with $J' = (f_i) + J^2$, see proof of
Lemma \ref{lemma-universal-thickening}.

\medskip\noindent
Consider the canonical exact sequence
$$
J'/(J')^2 \to \Omega_{P/A} \otimes_P B' \to \Omega_{B'/A} \to 0
$$
see
Lemma \ref{lemma-differential-seq}.
By construction the classes of the $f_i \in J'$ map to elements of
the module $\Omega_{P/A} \otimes_P B'$ which generate it modulo
$J'/J^2$ by construction. Since $J'/J^2$ is a nilpotent ideal, we see
that these elements generate the module altogether (by
Nakayama's Lemma \ref{lemma-NAK}). This proves that $\Omega_{B'/A} = 0$
and hence that $B'$ is formally unramified over $A$, see
Lemma \ref{lemma-characterize-formally-unramified}.

\medskip\noindent
Since $P$ is a polynomial ring over $A$ we have
$\Omega_{P/R} = \Omega_{A/R} \otimes_A P \oplus \bigoplus P\text{d}x_i$.
We are going to use this decomposition.
Consider the following exact sequence
$$
J'/(J')^2 \to
\Omega_{P/R} \otimes_P B' \to
\Omega_{B'/R} \to 0
$$
see
Lemma \ref{lemma-differential-seq}.
We may tensor this with $B$ and obtain the exact sequence
$$
J'/(J')^2 \otimes_{B'} B \to
\Omega_{P/R} \otimes_P B \to
\Omega_{B'/R} \otimes_{B'} B \to 0
$$
If we remember that $J' = (f_i) + J^2$
then we see that the first arrow annihilates the submodule $J^2/(J')^2$.
In terms of the direct sum decomposition
$\Omega_{P/R} \otimes_P B =
\Omega_{A/R} \otimes_A B \oplus \bigoplus B\text{d}x_i $ given
we see that the submodule $(f_i)/(J')^2 \otimes_{B'} B$ maps
isomorphically onto the summand $\bigoplus B\text{d}x_i$. Hence what is
left of this exact sequence is an isomorphism
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$
as desired.
\end{proof}









\section{Formally \'etale maps}
\label{section-formally-etale}

\begin{definition}
\label{definition-formally-etale}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally \'etale over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there exists
a unique dotted arrow making the diagram commute.
\end{definition}

\noindent
Clearly a ring map is formally \'etale if and only if
it is both formally smooth and formally unramified.

\begin{lemma}
\label{lemma-formally-etale-etale}
Let $R \to S$ be a ring map of finite presentation.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally \'etale,
\item $R \to S$ is \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that $R \to S$ is formally \'etale.
Then $R \to S$ is smooth by
Proposition \ref{proposition-smooth-formally-smooth}.
By Lemma \ref{lemma-characterize-formally-unramified}
we have $\Omega_{S/R} = 0$.
Hence $R \to S$ is \'etale by definition.

\medskip\noindent
Assume that $R \to S$ is \'etale.
Then $R \to S$ is formally smooth by
Proposition \ref{proposition-smooth-formally-smooth}.
By Lemma \ref{lemma-characterize-formally-unramified}
it is formally unramified. Hence $R \to S$ is formally \'etale.
\end{proof}

\begin{lemma}
\label{lemma-colimit-formally-etale}
Let $R$ be a ring. Let $I$ be a directed set.
Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras
over $I$. If each $R \to S_i$ is formally \'etale, then
$S = \colim_{i \in I} S_i$ is formally \'etale over $R$
\end{lemma}

\begin{proof}
Consider a diagram as in Definition \ref{definition-formally-etale}.
By assumption we get unique $R$-algebra maps $S_i \to A$ lifting
the compositions $S_i \to S \to A/I$. Hence these are compatible
with the transition maps $\varphi_{ii'}$ and define a lift
$S \to A$. This proves existence.
The uniqueness is clear by restricting to each $S_i$.
\end{proof}

\begin{lemma}
\label{lemma-localization-formally-etale}
Let $R$ be a ring. Let $S \subset R$ be any multiplicative subset.
Then the ring map $R \to S^{-1}R$ is formally \'etale.
\end{lemma}

\begin{proof}
Let $I \subset A$ be an ideal of square zero. What we are saying
here is that given a ring map $\varphi : R \to A$ such that
$\varphi(f) \mod I$ is invertible for all $f \in S$ we have also that
$\varphi(f)$ is invertible in $A$ for all $f \in S$. This is true because
$A^*$ is the inverse image of $(A/I)^*$ under the canonical map
$A \to A/I$.
\end{proof}





\section{Unramified ring maps}
\label{section-unramified}

\noindent
The definition of a G-unramified ring map is the one from EGA.
The definition of an unramified ring map is the one from \cite{Henselian}.

\begin{definition}
\label{definition-unramified}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is {\it unramified} if $R \to S$ is of
finite type and $\Omega_{S/R} = 0$.
\item We say $R \to S$ is {\it G-unramified} if $R \to S$ is of finite
presentation and $\Omega_{S/R} = 0$.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is unramified.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it G-unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is G-unramified.
\end{enumerate}
\end{definition}

\noindent
Of course a G-unramified map is unramified.

\begin{lemma}
\label{lemma-formally-unramified-unramified}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite type, and
\item $R \to S$ is unramified.
\end{enumerate}
Moreover, also the following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite presentation, and
\item $R \to S$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-characterize-formally-unramified}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-unramified}
Properties of unramified and G-unramified ring maps.
\begin{enumerate}
\item The base change of an unramified ring map is unramified.
The base change of a G-unramified ring map is G-unramified.
\item The composition of unramified ring maps is unramified.
The composition of G-unramified ring maps is G-unramified.
\item Any principal localization $R \to R_f$ is G-unramified and
unramified.
\item If $I \subset R$ is an ideal, then $R \to R/I$ is unramified.
If $I \subset R$ is a finitely generated ideal, then $R \to R/I$ is
G-unramified.
\item An \'etale ring map is G-unramified and unramified.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and $(\Omega_{S/R})_{\mathfrak q} = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and
$\Omega_{S/R} \otimes_S \kappa(\mathfrak q) = 0$, then
$R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})_{\mathfrak q}
= 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})
\otimes_{S \otimes_R \kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is a ring map, $g_1, \ldots, g_m \in S$ generate
the unit ideal and $R \to S_{g_j}$ is unramified (resp.\ G-unramified) for
$j = 1, \ldots, m$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is a ring map which is unramified (resp.\ G-unramified)
at every prime of $S$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is G-unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S = R \otimes_{R_0} S_0$.
\item If $R \to S$ is unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S$ is a quotient of
$R \otimes_{R_0} S_0$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove each point, in order.

\medskip\noindent
Ad (1). Follows from Lemmas \ref{lemma-differentials-base-change}
and \ref{lemma-base-change-finiteness}.

\medskip\noindent
Ad (2). Follows from Lemmas \ref{lemma-exact-sequence-differentials}
and \ref{lemma-base-change-finiteness}.

\medskip\noindent
Ad (3). Follows by direct computation of $\Omega_{R_f/R}$ which we omit.

\medskip\noindent
Ad (4). We have $\Omega_{(R/I)/R} = 0$, see
Lemma \ref{lemma-trivial-differential-surjective},
and the ring map $R \to R/I$
is of finite type. If $I$ is a finitely generated ideal then $R \to R/I$
is of finite presentation.

\medskip\noindent
Ad (5). See discussion following Definition \ref{definition-etale}.

\medskip\noindent
Ad (6). In this case $\Omega_{S/R}$ is a finite $S$-module (see
Lemma \ref{lemma-differentials-finitely-generated}) and hence there
exists a $g \in S$, $g \not \in \mathfrak q$ such that
$(\Omega_{S/R})_g = 0$. By Lemma \ref{lemma-differentials-localize}
this means that $\Omega_{S_g/R} = 0$ and hence $R \to S_g$ is
unramified as desired.

\medskip\noindent
Ad (7). Use Nakayama's lemma (Lemma \ref{lemma-NAK}) to see that
the condition is equivalent to the condition of (6).

\medskip\noindent
Ad (8) and (9). These are equivalent in the same manner that (6) and (7)
are equivalent. Moreover
$\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)} =
\Omega_{S/R} \otimes_S (S \otimes_R \kappa(\mathfrak p))$ by
Lemma \ref{lemma-differentials-base-change}.
Hence we see that (9) is equivalent to (7) since
the $\kappa(\mathfrak q)$ vector spaces in both are canonically
isomorphic.

\medskip\noindent
Ad (10). Follows from from Lemmas \ref{lemma-cover}
and \ref{lemma-differentials-localize}.

\medskip\noindent
Ad (11). Follows from (6) and (7) and the fact that the spectrum of $S$
is quasi-compact.

\medskip\noindent
Ad (12). Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_j + \sum a_{ijk}g_j\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij}, a_{ijk} \in R[x_1, \ldots, x_n]$.
Choose a finitely generated
$\mathbf{Z}$-subalgebra $R_0 \subset R$ containing all the coefficients of the
polynomials $g_i, h_{ij}, a_{ijk}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. This works.

\medskip\noindent
Ad (13). Write $S = R[x_1, \ldots, x_n]/I$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_{ij} + \sum g'_{ik}\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij} \in R[x_1, \ldots, x_n]$ and $g_{ij}, g'_{ik} \in I$.
Choose a finitely generated $\mathbf{Z}$-subalgebra $R_0 \subset R$
containing all the coefficients of the
polynomials $g_{ij}, h_{ij}, g'_{ik}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_{ij}, g'_{ik})$. This works.
\end{proof}

\begin{lemma}
\label{lemma-diagonal-unramified}
Let $R \to S$ be a ring map.
If $R \to S$ is unramified, then there exists an idempotent
$e \in S \otimes_R S$ such that $S \otimes_R S \to S$ is isomorphic
to $S \otimes_R S \to (S \otimes_R S)_e$.
\end{lemma}

\begin{proof}
Let $J = \Ker(S \otimes_R S \to S)$. By assumption
$J/J^2 = 0$, see
Lemma \ref{lemma-differentials-diagonal}.
Since $S$ is of finite type over $R$ we
see that $J$ is finitely generated, namely by
$x_i \otimes 1 - 1 \otimes x_i$, where $x_i$ generate $S$ over $R$.
We win by Lemma \ref{lemma-ideal-is-squared-union-connected}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be
a prime lying over $\mathfrak p$ in $R$.
If $S/R$ is unramified at $\mathfrak q$ then
\begin{enumerate}
\item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$
is the maximal ideal of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable.
\end{enumerate}
\end{lemma}

\begin{proof}
We may first replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
and assume that $R \to S$ is unramified.
The base change $S \otimes_R \kappa(\mathfrak p)$
is unramified over $\kappa(\mathfrak p)$ by
Lemma \ref{lemma-unramified}.
By
Lemma \ref{lemma-characterize-smooth-over-field}
it is smooth hence \'etale over $\kappa(\mathfrak p)$.
Hence we see that
$S \otimes_R \kappa(\mathfrak p) =
(R \setminus \mathfrak p)^{-1} S/\mathfrak pS$
is a product of finite separable field extensions of
$\kappa(\mathfrak p)$ by Lemma \ref{lemma-etale-over-field}.
This implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-unramified-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q$ be a prime of $S$.
If $R \to S$ is unramified at $\mathfrak q$ then
$R \to S$ is quasi-finite at $\mathfrak q$.
In particular, an unramified ring map is quasi-finite.
\end{lemma}

\begin{proof}
An unramified ring map is of finite type.
Thus it is clear that the second statement follows from the first.
To see the first statement apply the characterization of
Lemma \ref{lemma-isolated-point-fibre} part (2) using
Lemma \ref{lemma-unramified-at-prime}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-unramified}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. If
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal
of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable,
\end{enumerate}
then $R \to S$ is unramified at $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-unramified} (8) it suffices to show that
$\Omega_{S \otimes_R \kappa(\mathfrak p) / \kappa(\mathfrak p)}$
is zero when localized at $\mathfrak q$. Hence we may replace $S$
by $S \otimes_R \kappa(\mathfrak p)$ and $R$ by $\kappa(\mathfrak p)$.
In other words, we may assume that $R = k$ is a field and $S$
is a finite type $k$-algebra.
In this case the hypotheses imply that
$S_{\mathfrak q} \cong \kappa(\mathfrak q)$
and hence $S = \kappa(\mathfrak q) \times S'$ (see
Lemma \ref{lemma-isolated-point}).
Hence $(\Omega_{S/k})_{\mathfrak q} = \Omega_{\kappa(\mathfrak q)/k}$
which is zero as desired.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-unramified-finite-presentation}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is \'etale,
\item $R \to S$ is flat and G-unramified, and
\item $R \to S$ is flat, unramified, and of finite presentation,
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (2) and (3) are equivalent by definition.
The implication (1) $\Rightarrow$ (3) follows from
the fact that \'etale ring maps are of finite presentation,
Lemma \ref{lemma-etale} (flatness of \'etale maps), and
Lemma \ref{lemma-unramified} (\'etale maps are unramified).
Conversely, the characterization of \'etale ring maps in
Lemma \ref{lemma-characterize-etale}
and the structure of unramified ring maps in
Lemma \ref{lemma-unramified-at-prime}
shows that (3) implies (1). (This uses that $R \to S$
is \'etale if $R \to S$ is \'etale at every prime $\mathfrak q \subset S$,
see Lemma \ref{lemma-etale}.)
\end{proof}

\begin{proposition}
\label{proposition-unramified-locally-standard}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime.
If $R \to S$ is unramified at $\mathfrak q$, then there exist
\begin{enumerate}
\item a $g \in S$, $g \not \in \mathfrak q$,
\item a standard \'etale ring map $R \to S'$, and
\item a surjective $R$-algebra map $S' \to S_g$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is the ``same'' as the proof of
Proposition \ref{proposition-etale-locally-standard}.
The proof is a little roundabout and there may be ways to
shorten it.

\medskip\noindent
Step 1. By Definition \ref{definition-unramified}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is unramified. Thus we may assume that $S$ is
unramified over $R$.

\medskip\noindent
Step 2. By Lemma \ref{lemma-unramified}
there exists an unramified ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$, and a ring map
$R_0 \to R$ such that $S$ is a quotient of $R \otimes_{R_0} S_0$. Denote
$\mathfrak q_0$ the prime of $S_0$ corresponding to $\mathfrak q$.
If we show the result for $(R_0 \to S_0, \mathfrak q_0)$ then the
result follows for $(R \to S, \mathfrak q)$ by base change. Hence
we may assume that $R$ is Noetherian.

\medskip\noindent
Step 3.
Note that $R \to S$ is quasi-finite by
Lemma \ref{lemma-unramified-quasi-finite}.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite ring map $R \to S'$, an $R$-algebra map
$S' \to S$, an element $g' \in S'$ such that
$g' \not \in \mathfrak q$ such that $S' \to S$ induces
an isomorphism $S'_{g'} \cong S_{g'}$.
(Note that $S'$ may not unramified over $R$.)
Thus we may assume that (a) $R$ is Noetherian, (b) $R \to S$ is finite
and (c) $R \to S$ is unramified at $\mathfrak q$
(but no longer necessarily unramified at all primes).

\medskip\noindent
Step 4. Let $\mathfrak p \subset R$ be the prime corresponding
to $\mathfrak q$. Consider the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. This is a finite algebra over
$\kappa(\mathfrak p)$. Hence it is Artinian
(see Lemma \ref{lemma-finite-dimensional-algebra}) and
so a finite product of local rings
$$
S \otimes_R \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n A_i
$$
see Proposition \ref{proposition-dimension-zero-ring}. One of the factors,
say $A_1$, is the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
which is isomorphic to $\kappa(\mathfrak q)$,
see Lemma \ref{lemma-unramified-at-prime}. The other factors correspond to
the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of
$S$ lying over $\mathfrak p$.

\medskip\noindent
Step 5. We may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which
generates the finite separable field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ (so even if the
field extension is trivial we do not allow $\alpha = 0$).
Note that for any $\lambda \in \kappa(\mathfrak p)^*$ the
element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$
over $\kappa(\mathfrak p)$. Consider the element
$$
\overline{t} =
(\alpha, 0, \ldots, 0) \in
\prod\nolimits_{i = 1}^n A_i =
S \otimes_R \kappa(\mathfrak p).
$$
After possibly replacing $\alpha$ by $\lambda \alpha$ as above
we may assume that $\overline{t}$ is the image of $t \in S$.
Let $I \subset R[x]$ be the kernel of the $R$-algebra
map $R[x] \to S$ which maps $x$ to $t$. Set $S' = R[x]/I$,
so $S' \subset S$. Here is a diagram
$$
\xymatrix{
R[x] \ar[r] & S' \ar[r] & S \\
R \ar[u] \ar[ru] \ar[rru] & &
}
$$
By construction the primes $\mathfrak q_j$, $j \geq 2$ of $S$ all
lie over the prime $(\mathfrak p, x)$ of $R[x]$, whereas
the prime $\mathfrak q$ lies over a different prime of $R[x]$
because $\alpha \not = 0$.

\medskip\noindent
Step 6. Denote $\mathfrak q' \subset S'$ the prime of $S'$
corresponding to $\mathfrak q$. By the above $\mathfrak q$ is
the only prime of $S$ lying over $\mathfrak q'$. Thus we see that
$S_{\mathfrak q} = S_{\mathfrak q'}$, see
Lemma \ref{lemma-unique-prime-over-localize-below} (we have
going up for $S' \to S$ by Lemma \ref{lemma-integral-going-up}
since $S' \to S$ is finite as $R \to S$ is finite).
It follows that $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is finite
and injective as the localization of the finite injective ring map
$S' \to S$. Consider the maps of local rings
$$
R_{\mathfrak p} \to S'_{\mathfrak q'} \to S_{\mathfrak q}
$$
The second map is finite and injective. We have
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = \kappa(\mathfrak q)$,
see Lemma \ref{lemma-unramified-at-prime}.
Hence a fortiori
$S_{\mathfrak q}/\mathfrak q'S_{\mathfrak q} = \kappa(\mathfrak q)$.
Since
$$
\kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q)
$$
and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in
$\kappa(\mathfrak q)$
we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$.
Hence by Nakayama's Lemma \ref{lemma-NAK} applied to the
$S'_{\mathfrak q'}$-module map $S'_{\mathfrak q'} \to S_{\mathfrak q}$,
the map $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is surjective.
In other words,
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.

\medskip\noindent
Step 7. By Lemma \ref{lemma-isomorphic-local-rings} there exist
$g \in S$, $g \not \in \mathfrak q$ and
$g' \in S'$, $g' \not \in \mathfrak q'$ such that $S'_{g'} \cong S_g$.
As $R$ is Noetherian the ring $S'$ is finite over $R$
because it is an $R$-submodule
of the finite $R$-module $S$. Hence after replacing $S$ by $S'$ we may
assume that (a) $R$ is Noetherian, (b) $S$ finite over $R$, (c)
$S$ is unramified over $R$ at $\mathfrak q$, and (d) $S = R[x]/I$.

\medskip\noindent
Step 8. Consider the ring
$S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{I}$
where $\overline{I} = I \cdot \kappa(\mathfrak p)[x]$ is the ideal generated
by $I$ in $\kappa(\mathfrak p)[x]$. As $\kappa(\mathfrak p)[x]$ is a PID
we know that $\overline{I} = (\overline{h})$ for some monic
$\overline{h} \in \kappa(\mathfrak p)$. After replacing $\overline{h}$
by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$
we may assume that $\overline{h}$ is the image of some $h \in R[x]$.
(The problem is that we do not know if we may choose $h$ monic.)
Also, as in Step 4 we know that
$S \otimes_R \kappa(\mathfrak p) = A_1 \times \ldots \times A_n$ with
$A_1 = \kappa(\mathfrak q)$ a finite separable extension of
$\kappa(\mathfrak p)$ and $A_2, \ldots, A_n$ local. This implies
that
$$
\overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
$$
for certain pairwise coprime irreducible monic polynomials
$\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain
$e_2, \ldots, e_n \geq 1$. Here the numbering is chosen so that
$A_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as
$\kappa(\mathfrak p)[x]$-algebras. Note that $\overline{h}_1$ is
the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence
is a separable polynomial (its derivative is prime to itself).

\medskip\noindent
Step 9. Let $m \in I$ be a monic element; such an element exists
because the ring extension $R \to R[x]/I$ is finite hence integral.
Denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$.
We may factor
$$
\overline{m} = \overline{k}
\overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n}
$$
for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and
$\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$.
Set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$.
Then $f$ is monic as a polynomial over $R$. Also, the image $\overline{f}$
of $f$ in $\kappa(\mathfrak p)[x]$ factors as
$$
\overline{f} =
\overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2}
\ldots \overline{h}_n^{ld_n}
=
\overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l
\overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n})
= \overline{h}_1 \overline{w}
$$
with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$.
Set $g = f'$ (the derivative with respect to $x$).

\medskip\noindent
Step 10. The ring map $R[x] \to S = R[x]/I$ has the properties:
(1) it maps $f$ to zero, and
(2) it maps $g$ to an element of $S \setminus \mathfrak q$.
The first assertion is clear since $f$ is an element of $I$.
For the second assertion we just have to show that $g$ does
not map to zero in
$\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$.
The image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative
of $\overline{f}$. Thus (2) is clear because
$$
\overline{g} =
\frac{\text{d}\overline{f}}{\text{d}x} =
\overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} +
\overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x},
$$
$\overline{w}$ is prime to $\overline{h}_1$ and
$\overline{h}_1$ is separable.

\medskip\noindent
Step 11.
We conclude that $\varphi : R[x]/(f) \to S$ is a surjective ring map,
$R[x]_g/(f)$ is \'etale over $R$ (because it is standard \'etale,
see Lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$.
Thus the map $(R[x]/(f))_g \to S_{\varphi(g)}$ is the desired
surjection.
\end{proof}



\begin{lemma}
\label{lemma-etale-makes-unramified-closed-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p \subset R$.
Assume that $R \to S$ is of finite type and unramified at $\mathfrak q$.
Then there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$.
\item a product decomposition
$$
R' \otimes_R S = A \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $R' \to A$ is surjective, and
\item $\mathfrak p'A$ is a prime of $A$ lying over $\mathfrak p'$ and
over $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may replace $(R \to S, \mathfrak p, \mathfrak q)$
with any base change $(R' \to R'\otimes_R S, \mathfrak p', \mathfrak q')$
by a \'etale ring map $R \to R'$ with a prime $\mathfrak p'$
lying over $\mathfrak p$, and a choice of $\mathfrak q'$ lying over
both $\mathfrak q$ and $\mathfrak p'$. Note also that given
$R \to R'$ and $\mathfrak p'$ a suitable $\mathfrak q'$ can always
be found.

\medskip\noindent
The assumption that $R \to S$ is of finite type means that we may apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}. Thus we may
assume that $S = A_1 \times \ldots \times A_n \times B$, that
each $R \to A_i$ is finite with exactly one prime $\mathfrak r_i$
lying over $\mathfrak p$ such that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable
and that $R \to B$ is not quasi-finite at any prime lying over $\mathfrak p$.
Then clearly $\mathfrak q = \mathfrak r_i$ for some $i$, since
an unramified morphism is quasi-finite
(see Lemma \ref{lemma-unramified-quasi-finite}).
Say $\mathfrak q = \mathfrak r_1$.
By Lemma \ref{lemma-unramified-at-prime} we see that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_1)$
is separable hence the trivial field extension, and that
$\mathfrak p(A_1)_{\mathfrak r_1}$ is the maximal ideal.
Also, by Lemma \ref{lemma-unique-prime-over-localize-below}
(which applies to $R \to A_1$ because a finite ring map satisfies going up by
Lemma \ref{lemma-integral-going-up})
we have $(A_1)_{\mathfrak r_1} = (A_1)_{\mathfrak p}$.
It follows from Nakayama's Lemma \ref{lemma-NAK}
that the map of local rings
$R_{\mathfrak p} \to (A_1)_{\mathfrak p} = (A_1)_{\mathfrak r_1}$
is surjective. Since $A_1$ is finite over $R$ we see that there
exists a $f \in R$, $f \not \in \mathfrak p$ such that
$R_f \to (A_1)_f$ is surjective. After replacing $R$ by $R_f$ we win.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-unramified-closed}
\begin{slogan}
In an unramified ring map, one can separate the points in a fiber
by passing to an \'etale neighbourhood.
\end{slogan}
Let $R \to S$ be a ring map.
Let $\mathfrak p$ be a prime of $R$.
If $R \to S$ is unramified then there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$.
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $R' \to A_i$ is surjective,
\item $\mathfrak p'A_i$ is a prime of $A_i$ lying over $\mathfrak p'$, and
\item there is no prime of $B$ lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}.
Thus, after an \'etale base change,
we may assume that $S = A_1 \times \ldots \times A_n \times B$,
that each $R \to A_i$ is finite with exactly one prime $\mathfrak r_i$
lying over $\mathfrak p$ such that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable,
and that $R \to B$ is not quasi-finite at any prime lying over $\mathfrak p$.
Since $R \to S$ is quasi-finite (see
Lemma \ref{lemma-unramified-quasi-finite})
we see there is no prime of $B$ lying over $\mathfrak p$.
By Lemma \ref{lemma-unramified-at-prime} we see that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$
is separable hence the trivial field extension, and that
$\mathfrak p(A_i)_{\mathfrak r_i}$ is the maximal ideal.
Also, by Lemma \ref{lemma-unique-prime-over-localize-below}
(which applies to $R \to A_i$ because a finite ring map satisfies going up by
Lemma \ref{lemma-integral-going-up})
we have $(A_i)_{\mathfrak r_i} = (A_i)_{\mathfrak p}$.
It follows from Nakayama's Lemma \ref{lemma-NAK}
that the map of local rings
$R_{\mathfrak p} \to (A_i)_{\mathfrak p} = (A_i)_{\mathfrak r_i}$
is surjective. Since $A_i$ is finite over $R$ we see that there
exists a $f \in R$, $f \not \in \mathfrak p$ such that
$R_f \to (A_i)_f$ is surjective. After replacing $R$ by $R_f$ we win.
\end{proof}










\section{Henselian local rings}
\label{section-henselian}

\noindent
In this section we discuss a bit the notion of a henselian local ring.
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For $a \in R$ we denote $\overline{a}$ the image of $a$ in $\kappa$.
For a polynomial $f \in R[T]$ we often denote $\overline{f}$
the image of $f$ in $\kappa[T]$.
Given a polynomial $f \in R[T]$ we denote $f'$ the derivative
of $f$ with respect to $T$. Note that $\overline{f}' = \overline{f'}$.

\begin{definition}
\label{definition-henselian}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
\begin{enumerate}
\item We say $R$ is {\it henselian} if for every monic $f \in R[T]$ and
every root $a_0 \in \kappa$ of $\overline{f}$ such that
$\overline{f'}(a_0) \not = 0$
there exists an $a \in R$ such that $f(a) = 0$ and
$a_0 = \overline{a}$.
\item We say $R$ is {\it strictly henselian} if $R$ is henselian
and its residue field is separably algebraically closed.
\end{enumerate}
\end{definition}

\noindent
Note that the condition $\overline{f'}(a_0) \not = 0$ is equivalent to the
condition that $a_0$ is a simple root of the polynomial $\overline{f}$.
In fact, it implies that the lift $a \in R$, if it exists, is unique.

\begin{lemma}
\label{lemma-uniqueness}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $f \in R[T]$. Let $a, b \in R$ such that $f(a) = f(b) = 0$,
$a = b \bmod \mathfrak m$, and $f'(a) \not \in \mathfrak m$.
Then $a = b$.
\end{lemma}

\begin{proof}
Write $f(x + y) - f(x) = f'(x)y + g(x, y) y^2$ in $R[x, y]$ (this is possible
as one sees by expanding $f(x + y)$; details omitted).
Then we see that $0 = f(b) - f(a) = f(a + (b - a)) - f(a) =
f'(a)(b - a) + c (b - a)^2$ for some $c \in R$. By assumption
$f'(a)$ is a unit in $R$. Hence $(b - a)(1 + f'(a)^{-1}c(b - a)) = 0$.
By assumption $b - a \in \mathfrak m$, hence $1 + f'(a)^{-1}c(b - a)$
is a unit in $R$. Hence $b - a = 0$ in $R$.
\end{proof}

\noindent
Here is the characterization of henselian local rings.

\begin{lemma}
\label{lemma-characterize-henselian}
\begin{slogan}
Characterizations of henselian local rings
\end{slogan}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
The following are equivalent
\begin{enumerate}
\item $R$ is henselian,
\item for every $f \in R[T]$ and every root $a_0 \in \kappa$
of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$
there exists an $a \in R$ such that $f(a) = 0$ and
$a_0 = \overline{a}$,
\item for any monic $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$,
\item for any monic $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover
$\deg_T(g) = \deg_T(g_0)$,
\item for any $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$,
\item for any $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$ and
moreover $\deg_T(g) = \deg_T(g_0)$,
\item for any \'etale ring map $R \to S$ and prime $\mathfrak q$ of $S$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$
there exists a section $\tau : S \to R$ of $R \to S$,
\item for any \'etale ring map $R \to S$ and prime $\mathfrak q$ of $S$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$
there exists a section $\tau : S \to R$ of $R \to S$ with
$\mathfrak q = \tau^{-1}(\mathfrak m)$,
\item any finite $R$-algebra is a product of local rings,
\item any finite $R$-algebra is a finite product of local rings,
\item any finite type $R$-algebra $S$ can be written as
$A \times B$ with $R \to A$ finite
and $R \to B$ not quasi-finite at any prime lying over $\mathfrak m$,
\item any finite type $R$-algebra $S$ can be written as
$A \times B$ with $R \to A$ finite
such that each irreducible component of $\Spec(B \otimes_R \kappa)$
has dimension $\geq 1$, and
\item any quasi-finite $R$-algebra $S$ can be written as
$S = A \times B$ with $R \to A$ finite such that $B \otimes_R \kappa = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Here is a list of the easier implications:
\begin{enumerate}
\item[2$\Rightarrow$1] because in (2) we consider all polynomials and
in (1) only monic ones,
\item[5$\Rightarrow$3] because in (5) we consider all polynomials and
in (3) only monic ones,
\item[6$\Rightarrow$4] because in (6) we consider all polynomials and
in (4) only monic ones,
\item[4$\Rightarrow$3] is obvious,
\item[6$\Rightarrow$5] is obvious,
\item[8$\Rightarrow$7] is obvious,
\item[10$\Rightarrow$9] is obvious,
\item[11$\Leftrightarrow$12] by definition of being quasi-finite at a prime,
\item[11$\Rightarrow$13] by definition of being quasi-finite,
\end{enumerate}

\noindent
Proof of 1$\Rightarrow$8. Assume (1).
Let $R \to S$ be \'etale, and let $\mathfrak q \subset S$
be a prime ideal such that $\kappa(\mathfrak q) \cong \kappa$. By
Proposition \ref{proposition-etale-locally-standard}
we can find a $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is standard \'etale. After replacing $S$ by $S_g$ we may assume
that $S = R[t]_g/(f)$ is standard \'etale. Since the prime $\mathfrak q$
has residue field $\kappa$ it corresponds to a root $a_0$ of
$\overline{f}$ which is not a root of $\overline{g}$. By definition
of a standard \'etale algebra this also means that
$\overline{f'}(a_0) \not = 0$.
Since also $f$ is monic by definition of a standard \'etale algebra again we
may use that $R$ is henselian to conclude that there exists an $a \in R$
with $a_0 = \overline{a}$ such that $f(a) = 0$. This implies that
$g(a)$ is a unit of $R$ and we obtain the desired map
$\tau : S = R[t]_g/(f) \to R$ by the rule $t \mapsto a$. By construction
$\tau^{-1}(\mathfrak q) = \mathfrak m$. This proves (8) holds.

\medskip\noindent
Proof of 7$\Rightarrow$8. (This is really unimportant and should be
skipped.) Assume (7) holds and assume $R \to S$ is \'etale.
Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be
the other primes of $S$ lying over $\mathfrak m$.
Then we can find a $g \in S$, $g \not \in \mathfrak q$ and
$g \in \mathfrak q_i$ for $i = 1, \ldots, r$, see
Lemma \ref{lemma-silly}. Apply (7) to the \'etale ring map
$R \to S_g$ and the prime $\mathfrak qS_g$. This gives a section
$\tau_g : S_g \to R$ such that the composition $\tau : S \to S_g \to R$
has the property $\tau^{-1}(\mathfrak q) = \mathfrak m$.
Minor details omitted.

\medskip\noindent
Proof of 8$\Rightarrow$11. Assume (8) and let $R \to S$ be a finite type
ring map. Apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
We find an \'etale ring map $R \to R'$ and a prime $\mathfrak m' \subset R'$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$
such that $R' \otimes_R S = A' \times B'$ with $A'$ finite over $R'$
and $B'$ not quasi-finite over $R'$ at any prime lying over $\mathfrak m'$.
Apply (8) to get a section $\tau : R' \to R$ with
$\mathfrak m = \tau^{-1}(\mathfrak m')$. Then use that
$$
S = (S \otimes_R R') \otimes_{R', \tau} R
= (A' \times B') \otimes_{R', \tau} R
= (A' \otimes_{R', \tau} R)  \times  (B' \otimes_{R', \tau} R)
$$
which gives a decomposition as in (11).

\medskip\noindent
Proof of 8$\Rightarrow$10. Assume (8) and let $R \to S$ be a finite
ring map. Apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
We find an \'etale ring map $R \to R'$ and a prime $\mathfrak m' \subset R'$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$
such that $R' \otimes_R S = A'_1 \times \ldots \times A'_n \times B'$
with $A'_i$ finite over $R'$ having exactly one prime over $\mathfrak m'$
and $B'$ not quasi-finite over $R'$ at any prime lying over $\mathfrak m'$.
Apply (8) to get a section $\tau : R' \to R$ with
$\mathfrak m = \tau^{-1}(\mathfrak m')$. Then we obtain
\begin{align*}
S & = (S \otimes_R R') \otimes_{R', \tau} R \\
& = (A'_1 \times \ldots \times A'_n \times B') \otimes_{R', \tau} R \\
& = (A'_1 \otimes_{R', \tau} R)  \times
\ldots \times (A'_1 \otimes_{R', \tau} R) \times
(B' \otimes_{R', \tau} R) \\
& = A_1 \times \ldots \times A_n \times B
\end{align*}
The factor $B$ is finite over $R$ but $R \to B$
is not quasi-finite at any prime lying over $\mathfrak m$. Hence
$B = 0$. The factors $A_i$ are finite $R$-algebras having exactly
one prime lying over $\mathfrak m$, hence they are local rings.
This proves that $S$ is a finite product of local rings.

\medskip\noindent
Proof of 9$\Rightarrow$10. This holds because if $S$ is finite over the local
ring $R$, then it has at most finitely many maximal ideals. Namely, by
going up for $R \to S$ the maximal ideals of $S$ all lie over $\mathfrak m$,
and $S/\mathfrak mS$ is Artinian hence has finitely many primes.

\medskip\noindent
Proof of 10$\Rightarrow$1. Assume (10). Let $f \in R[T]$ be a monic
polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$.
Then $S = R[T]/(f)$ is a finite $R$-algebra. Applying (10)
we get $S = A_1 \times \ldots \times A_r$ is a finite product of
local $R$-algebras. In particular we see that
$S/\mathfrak mS = \prod A_i/\mathfrak mA_i$ is the decomposition
of $\kappa[T]/(\overline{f})$ as a product of local rings.
This means that one of the factors, say $A_1/\mathfrak mA_1$
is the quotient $\kappa[T]/(\overline{f}) \to \kappa[T]/(T - a_0)$.
Since $A_1$ is a summand of the finite free $R$-module $S$ it
is a finite free $R$-module itself. As $A_1/\mathfrak mA_1$ is a
$\kappa$-vector space of dimension 1 we see that $A_1 \cong R$ as an
$R$-module. Clearly this means that $R \to A_1$ is an isomorphism.
Let $a \in R$ be the image of $T$ under the map
$R[T] \to S \to A_1 \to R$. Then $f(a) = 0$ and $\overline{a} = a_0$
as desired.

\medskip\noindent
Proof of 13$\Rightarrow$1. Assume (13). Let $f \in R[T]$ be a monic
polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$.
Then $S_1 = R[T]/(f)$ is a finite $R$-algebra. Let $g \in R[T]$
be any element such that $\overline{g} = \overline{f}/(T - a_0)$.
Then $S = (S_1)_g$ is a quasi-finite $R$-algebra such that
$S \otimes_R \kappa \cong \kappa[T]_{\overline{g}}/(\overline{f})
\cong \kappa[T]/(T - a_0) \cong \kappa$.
Applying (13) to $S$ we get $S = A \times B$ with $A$ finite over $R$ and
$B \otimes_R \kappa = 0$. In particular we see that
$\kappa \cong S/\mathfrak mS = A/\mathfrak mA$.
Since $A$ is a summand of the flat $R$-algebra $S$ we see
that it is finite flat, hence free over $R$.
As $A/\mathfrak mA$ is a
$\kappa$-vector space of dimension 1 we see that $A \cong R$ as an
$R$-module. Clearly this means that $R \to A$ is an isomorphism.
Let $a \in R$ be the image of $T$ under the map
$R[T] \to S \to A \to R$. Then $f(a) = 0$ and $\overline{a} = a_0$
as desired.

\medskip\noindent
Proof of 8$\Rightarrow$2. Assume (8). Let $f \in R[T]$ be any
polynomial and let $a_0 \in \kappa$ be a simple root. Then
the algebra $S = R[T]_{f'}/(f)$ is \'etale over $R$.
Let $\mathfrak q \subset S$ be the prime
generated by $\mathfrak m$ and $T - b$ where $b \in R$ is any
element such that $\overline{b} = a_0$. Apply (8) to $S$ and $\mathfrak q$
to get $\tau : S \to R$.
Then the image $\tau(T) = a \in R$ works in (2).

\medskip\noindent
At this point we see that (1), (2), (7), (8), (9), (10), (11), (12), (13) are
all equivalent. The weakest assertion of (3), (4), (5) and (6)
is (3) and the strongest is (6). Hence we still have to prove that
(3) implies (1) and (1) implies (6).

\medskip\noindent
Proof of 3$\Rightarrow$1. Assume (3). Let $f \in R[T]$ be monic and
let $a_0 \in \kappa$ be a simple root of $\overline{f}$. This gives
a factorization $\overline{f} = (T - a_0)h_0$ with $h_0(a_0) \not = 0$,
so $\gcd(T - a_0, h_0) = 1$. Apply (3) to get a factorization
$f = gh$ with $\overline{g} = T - a_0$ and $\overline{h} = h_0$.
Set $S = R[T]/(f)$ which is a finite free $R$-algebra. We will write
$g$, $h$ also for the images of $g$ and $h$ in $S$. Then
$gS + hS = S$ by
Nakayama's Lemma \ref{lemma-NAK}
as the equality holds modulo $\mathfrak m$. Since $gh = f = 0$ in $S$
this also implies that $gS \cap hS = 0$. Hence by the Chinese Remainder
theorem we obtain $S = S/(g) \times S/(h)$. This implies that
$A = S/(g)$ is a summand of a finite free $R$-module, hence finite
free. Moreover, the rank of $A$ is $1$ as
$A/\mathfrak mA = \kappa[T]/(T - a_0)$. Thus the map $R \to A$
is an isomorphism. Setting $a \in R$ equal to the image of $T$
under the maps $R[T] \to S \to A \to R$ gives an element of $R$
with $f(a) = 0$ and $\overline{a} = a_0$.

\medskip\noindent
Proof of 1$\Rightarrow$6. Assume (1) or equivalently all of
(1), (2), (7), (8), (9), (10), (11), (12), (13).
Let $f \in R[T]$ be a polynomial.
Suppose that $\overline{f} = g_0h_0$ is a factorization with
$\gcd(g_0, h_0) = 1$. We may and do assume that $g_0$ is monic.
Consider $S = R[T]/(f)$. Because we
have the factorization we see that the coefficients of
$f$ generate the unit ideal in $R$.
This implies that $S$ has finite fibres over $R$, hence is
quasi-finite over $R$. It also implies that $S$ is flat over $R$ by
Lemma \ref{lemma-grothendieck}.
Combining (13) and (10) we may write
$S = A_1 \times \ldots \times A_n \times B$
where each $A_i$ is local and finite over $R$, and
$B \otimes_R \kappa = 0$. After reordering the factors $A_1, \ldots, A_n$
we may assume that
$$
\kappa[T]/(g_0) =
A_1/\mathfrak m A_1 \times \ldots \times A_r/\mathfrak mA_r,
\ \kappa[T]/(h_0) =
A_{r + 1}/\mathfrak mA_{r + 1} \times \ldots \times A_n/\mathfrak mA_n
$$
as quotients of $\kappa[T]$. The finite flat $R$-algebra
$A = A_1 \times \ldots \times A_r$ is free as an $R$-module, see
Lemma \ref{lemma-finite-flat-local}.
Its rank is $\deg_T(g_0)$. Let $g \in R[T]$ be the characteristic polynomial
of the $R$-linear operator $T : A \to A$. Then $g$ is a monic polynomial
of degree $\deg_T(g) = \deg_T(g_0)$ and moreover $\overline{g} = g_0$.
By Cayley-Hamilton
(Lemma \ref{lemma-charpoly})
we see that $g(T_A) = 0$ where $T_A$ indicates
the image of $T$ in $A$. Hence we obtain a well defined surjective map
$R[T]/(g) \to A$ which is an isomorphism by
Nakayama's Lemma \ref{lemma-NAK}. The map $R[T] \to A$ factors
through $R[T]/(f)$ by construction hence we may write $f = gh$ for
some $h$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-henselian}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
\begin{enumerate}
\item If $R \subset S$ is a finite ring extension then $S$ is
a finite product of henselian local rings.
\item If $R \subset S$ is a finite local homomorphism of local rings,
then $S$ is a henselian local ring.
\item If $R \to S$ is a finite type ring map, and $\mathfrak q$ is
a prime of $S$ lying over $\mathfrak m$
at which $R \to S$ is quasi-finite, then
$S_{\mathfrak q}$ is henselian.
\item If $R \to S$ is quasi-finite then $S_{\mathfrak q}$ is henselian
for every prime $\mathfrak q$ lying over $\mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) implies part (1) since $S$ as in part (1) is a finite product
of its localizations at the primes lying over $\mathfrak m$.
Part (2) follows from
Lemma \ref{lemma-characterize-henselian} part (10)
since any finite $S$-algebra is also a finite $R$-algebra.
If $R \to S$ and $\mathfrak q$ are as in (3), then
$S_{\mathfrak q}$ is a local ring of a finite $R$-algebra by
Lemma \ref{lemma-characterize-henselian} part (11).
Hence (3) follows from (1).
Part (4) follows from part (3).
\end{proof}

\begin{lemma}
\label{lemma-mop-up}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
Any finite type $R$-algebra $S$ can be written as
$S = A_1 \times \ldots \times A_n \times B$ with $A_i$ local
and finite over $R$ and $R \to B$ not quasi-finite at any
prime of $B$ lying over $\mathfrak m$.
\end{lemma}

\begin{proof}
This is a combination of parts (11) and (10) of
Lemma \ref{lemma-characterize-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-mop-up-strictly-henselian}
Let $(R, \mathfrak m, \kappa)$ be a strictly henselian local ring.
Any finite type $R$-algebra $S$ can be written as
$S = A_1 \times \ldots \times A_n \times B$ with $A_i$ local
and finite over $R$ and $\kappa \subset \kappa(\mathfrak m_{A_i})$
finite purely inseparable and $R \to B$ not quasi-finite
at any prime of $B$ lying over $\mathfrak m$.
\end{lemma}

\begin{proof}
First write $S = A_1 \times \ldots \times A_n \times B$ as in
Lemma \ref{lemma-mop-up}.
The field extension $\kappa \subset \kappa(\mathfrak m_{A_i})$
is finite and $\kappa$ is separably algebraically closed, hence
it is finite purely inseparable.
\end{proof}

\begin{lemma}
\label{lemma-henselian-cat-finite-etale}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
The category of finite \'etale ring extensions $R \to S$ is
equivalent to the category of finite \'etale algebras
$\kappa \to \overline{S}$ via the functor $S \mapsto S/\mathfrak mS$.
\end{lemma}

\begin{proof}
Denote $\mathcal{C} \to \mathcal{D}$ the functor of categories
of the statement.
Suppose that $R \to S$ is finite \'etale. Then we may write
$$
S = A_1 \times \ldots \times A_n
$$
with $A_i$ local and finite \'etale over $S$, use either
Lemma \ref{lemma-mop-up}
or
Lemma \ref{lemma-characterize-henselian} part (10).
In particular $A_i/\mathfrak mA_i$ is a finite separable field
extension of $\kappa$, see
Lemma \ref{lemma-etale-at-prime}.
Thus we see that every object of $\mathcal{C}$ and
$\mathcal{D}$ decomposes canonically into irreducible pieces
which correspond via the given functor.
Next, suppose that $S_1$, $S_2$ are finite \'etale over $R$ such that
$\kappa_1 = S_1/\mathfrak mS_1$ and $\kappa_2 = S_2/\mathfrak mS_2$
are fields (finite separable over $\kappa$). Then $S_1 \otimes_R S_2$
is finite \'etale over $R$ and we may write
$$
S_1 \otimes_R S_2 = A_1 \times \ldots \times A_n
$$
as before. Then we see that $\Hom_R(S_1, S_2)$ is identified
with the set of indices $i \in \{1, \ldots, n\}$ such that
$S_2 \to A_i$ is an isomorphism. To see this use that given any $R$-algebra
map $\varphi : S_1 \to S_2$ the map
$\varphi \times 1 : S_1 \otimes_R S_2 \to S_2$
is surjective, and hence is equal to projection onto one of the factors $A_i$.
But in exactly the same way we see that
$\Hom_\kappa(\kappa_1, \kappa_2)$ is identified with
the set of indices $i \in \{1, \ldots, n\}$ such that
$\kappa_2 \to A_i/\mathfrak mA_i$ is an isomorphism.
By the discussion above these sets of indices match, and we conclude
that our functor is fully faithful.
Finally, let $\kappa \subset \kappa'$ be a finite
separable field extension. By
Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
there exists an \'etale ring map $R \to S$ and a prime $\mathfrak q$
of $S$ lying over $\mathfrak m$ such that $\kappa \subset \kappa(\mathfrak q)$
is isomorphic to the given extension. By part (1)
we may write $S = A_1 \times \ldots \times A_n \times B$.
Since $R \to S$ is quasi-finite we see that there exists no
prime of $B$ over $\mathfrak m$. Hence $S_{\mathfrak q}$ is
equal to $A_i$ for some $i$. Hence $R \to A_i$ is finite \'etale
and produces the given residue field extension. Thus the functor
is essentially surjective and we win.
\end{proof}

\begin{lemma}
\label{lemma-unramified-over-strictly-henselian}
Let $(R, \mathfrak m, \kappa)$ be a strictly henselian local ring.
Let $R \to S$ be an unramified ring map. Then
$$
S = A_1 \times \ldots \times A_n \times B
$$
with each $R \to A_i$ surjective and no prime of $B$ lying
over $\mathfrak m$.
\end{lemma}

\begin{proof}
First write $S = A_1 \times \ldots \times A_n \times B$ as in
Lemma \ref{lemma-mop-up}.
Now we see that $R \to A_i$ is finite unramified and $A_i$ local.
Hence the maximal ideal of $A_i$ is $\mathfrak mA_i$ and its
residue field $A_i / \mathfrak m A_i$ is a finite
separable extension of $\kappa$, see
Lemma \ref{lemma-unramified-at-prime}.
However, the condition that $R$ is strictly henselian means that
$\kappa$ is separably algebraically closed, so
$\kappa = A_i / \mathfrak m A_i$. By
Nakayama's Lemma \ref{lemma-NAK}
we conclude that $R \to A_i$ is surjective as desired.
\end{proof}

\begin{lemma}
\label{lemma-complete-henselian}
Let $(R, \mathfrak m, \kappa)$ be a complete local ring, see
Definition \ref{definition-complete-local-ring}.
Then $R$ is henselian.
\end{lemma}

\begin{proof}
Let $f \in R[T]$ be monic.
Denote $f_n \in R/\mathfrak m^{n + 1}[T]$ the image.
Denote $f'_n$ the derivative of $f_n$ with respect to $T$.
Let $a_0 \in \kappa$ be a simple root of $f_0$. We lift this
to a solution of $f$ over $R$ inductively as follows:
Suppose given $a_n \in R/\mathfrak m^{n + 1}$ such that
$a_n \bmod \mathfrak m = a_0$ and $f_n(a_n) = 0$. Pick any
element $b \in R/\mathfrak m^{n + 2}$ such that
$a_n = b \bmod \mathfrak m^{n + 1}$. Then
$f_{n + 1}(b) \in \mathfrak m^{n + 1}/\mathfrak m^{n + 2}$.
Set
$$
a_{n + 1} = b - f_{n + 1}(b)/f'_{n + 1}(b)
$$
(Newton's method). This makes sense as
$f'_{n + 1}(b) \in R/\mathfrak m^{n + 1}$
is invertible by the condition on $a_0$. Then we compute
$f_{n + 1}(a_{n + 1}) = f_{n + 1}(b) - f_{n + 1}(b) = 0$
in $R/\mathfrak m^{n + 2}$. Since the system of elements
$a_n \in R/\mathfrak m^{n + 1}$ so constructed is compatible
we get an element
$a \in \lim R/\mathfrak m^n = R$ (here we use that $R$ is complete).
Moreover, $f(a) = 0$ since it maps to zero in each $R/\mathfrak m^n$.
Finally $\overline{a} = a_0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-local-dimension-zero-henselian}
\begin{slogan}
Local rings of dimension zero are henselian.
\end{slogan}
Let $(R, \mathfrak m)$ be a local ring of dimension $0$.
Then $R$ is henselian.
\end{lemma}

\begin{proof}
Let $R \to S$ be a finite ring map. By
Lemma \ref{lemma-characterize-henselian}
it suffices to show that $S$ is a product of local rings. By
Lemma \ref{lemma-finite-finite-fibres}
$S$ has finitely many primes $\mathfrak m_1, \ldots, \mathfrak m_r$
which all lie over $\mathfrak m$. There are no inclusions among these
primes, see
Lemma \ref{lemma-integral-no-inclusion},
hence they are all maximal. Every element of
$\mathfrak m_1 \cap \ldots \cap \mathfrak m_r$ is nilpotent by
Lemma \ref{lemma-Zariski-topology}.
It follows $S$ is the product of the localizations of $S$ at the primes
$\mathfrak m_i$ by
Lemma \ref{lemma-product-local}.
\end{proof}

\noindent
The following lemma will be the key to the uniqueness and functorial
properties of henselization and strict henselization.

\begin{lemma}
\label{lemma-map-into-henselian}
Let $R \to S$ be a ring map with $S$ henselian local.
Given
\begin{enumerate}
\item an \'etale ring map $R \to A$,
\item a prime $\mathfrak q$ of $A$ lying over
$\mathfrak p = R \cap \mathfrak m_S$,
\item a $\kappa(\mathfrak p)$-algebra map
$\tau : \kappa(\mathfrak q) \to S/\mathfrak m_S$,
\end{enumerate}
then there exists a unique homomorphism of $R$-algebras $f : A \to S$
such that $\mathfrak q = f^{-1}(\mathfrak m_S)$ and
$f \bmod \mathfrak q = \tau$.
\end{lemma}

\begin{proof}
Consider $A \otimes_R S$. This is an \'etale algebra over $S$, see
Lemma \ref{lemma-etale}. Moreover, the kernel
$$
\mathfrak q' = \Ker(A \otimes_R S \to
\kappa(\mathfrak q) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak m_S) \to
\kappa(\mathfrak m_S))
$$
of the map using the map given in (3) is a prime ideal lying over
$\mathfrak m_S$ with residue field equal to the residue field of $S$.
Hence by Lemma \ref{lemma-characterize-henselian}
there exists a unique splitting $\tau : A \otimes_R S \to S$
with $\tau^{-1}(\mathfrak m_S) = \mathfrak q'$.
Set $f$ equal to the composition $A \to A \otimes_R S \to S$.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-solutions}
Let $\varphi : R \to S$ be a local homomorphism
of strictly henselian local rings.
Let $P_1, \ldots, P_n \in R[x_1, \ldots, x_n]$ be polynomials such that
$R[x_1, \ldots, x_n]/(P_1, \ldots, P_n)$ is \'etale over $R$.
Then the map
$$
R^n \longrightarrow S^n, \quad
(h_1, \ldots, h_n) \longmapsto (\varphi(h_1), \ldots, \varphi(h_n))
$$
induces a bijection between
$$
\{
(r_1, \ldots, r_n) \in R^n
\mid
P_i(r_1, \ldots, r_n) = 0, \ i = 1, \ldots, n
\}
$$
and
$$
\{
(s_1, \ldots, s_n) \in S^n
\mid
P'_i(s_1, \ldots, s_n) = 0, \ i = 1, \ldots, n
\}
$$
where $P'_i \in S[x_1, \ldots, x_n]$ are the images of the $P_i$
under $\varphi$.
\end{lemma}

\begin{proof}
The first solution set is canonically isomorphic to the set
$$
\Hom_R(R[x_1, \ldots, x_n]/(P_1, \ldots, P_n), R).
$$
As $R$ is henselian the map $R \to R/\mathfrak m_R$ induces a bijection
between this set and the set of solutions in the
residue field $R/\mathfrak m_R$, see
Lemma \ref{lemma-characterize-henselian}.
The same is true for $S$.
Now since $R[x_1, \ldots, x_n]/(P_1, \ldots, P_n)$ is \'etale over $R$
and $R/\mathfrak m_R$ is separably algebraically closed we see that
$R/\mathfrak m_R[x_1, \ldots, x_n]/(\overline{P_1}, \ldots, \overline{P_n})$
is a finite product of copies of $R/\mathfrak m_R$. Hence the
tensor product
$$
R/\mathfrak m_R[x_1, \ldots, x_n]/(\overline{P_1}, \ldots, \overline{P_n})
\otimes_{R/\mathfrak m_R} S/\mathfrak m_S
=
S/\mathfrak m_S[x_1, \ldots, x_n]/(\overline{P_1'}, \ldots, \overline{P_n'})
$$
is also a finite product of copies of $S/\mathfrak m_S$ with the same
index set. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-split-ML-henselian}
Let $R$ be a henselian local ring.
Any countably generated Mittag-Leffler module over $R$ is a direct
sum of finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Let $M$ be a countably generated and Mittag-Leffler $R$-module.
We claim that for any element $x \in M$ there exists a direct
sum decomposition $M = N \oplus K$ with $x \in N$, the module
$N$ finitely presented, and $K$ Mittag-Leffler.

\medskip\noindent
Suppose the claim is true. Choose generators $x_1, x_2, x_3, \ldots$
of $M$. By the claim we can inductively find direct sum decompositions
$$
M = N_1 \oplus N_2 \oplus \ldots \oplus N_n \oplus K_n
$$
with $N_i$ finitely presented,
$x_1, \ldots, x_n \in N_1 \oplus \ldots \oplus N_n$, and $K_n$ Mittag-Leffler.
Repeating ad infinitum we see that $M = \bigoplus N_i$.

\medskip\noindent
We still have to prove the claim. Let $x \in M$. By
Lemma \ref{lemma-ML-countable}
there exists an endomorphism $\alpha : M \to M$
such that $\alpha$ factors through a finitely presented module, and
$\alpha (x) = x$. Say $\alpha$ factors as
$$
\xymatrix{
M \ar[r]^\pi & P \ar[r]^i & M
}
$$
Set $a = \pi \circ \alpha \circ i : P \to P$, so
$i \circ a \circ \pi = \alpha^3$. By
Lemma \ref{lemma-charpoly-module}
there exists a monic polynomial $P \in R[T]$ such that $P(a) = 0$.
Note that this implies formally that $\alpha^2 P(\alpha) = 0$.
Hence we may think of $M$ as a module over $R[T]/(T^2P)$.
Assume that $x \not = 0$. Then $\alpha(x) = x$ implies that
$0 = \alpha^2P(\alpha)x = P(1)x$ hence $P(1) = 0$ in $R/I$ where
$I = \{r \in R \mid rx = 0\}$ is the annihilator of $x$.
As $x \not = 0$ we see $I \subset \mathfrak m_R$, hence
$1$ is a root of $\overline{P} = P \bmod \mathfrak m_R \in R/\mathfrak m_R[T]$.
As $R$ is henselian we can find a factorization
$$
T^2P = (T^2 Q_1) Q_2
$$
for some $Q_1, Q_2 \in R[T]$ with
$Q_2 = (T - 1)^e \bmod \mathfrak m_R R[T]$ and
$Q_1(1) \not = 0 \bmod \mathfrak m_R$, see
Lemma \ref{lemma-characterize-henselian}.
Let $N = \Im(\alpha^2Q_1(\alpha) : M \to M)$ and
$K = \Im(Q_2(\alpha) : M \to M)$. As $T^2Q_1$ and
$Q_2$ generate the unit ideal of $R[T]$ we get a direct sum
decomposition $M = N \oplus K$. Moreover, $Q_2$ acts as zero on $N$ and
$T^2Q_1$ acts as zero on $K$. Note that $N$ is a quotient of $P$
hence is finitely generated. Also $x \in N$ because
$\alpha^2Q_1(\alpha)x = Q_1(1)x$ and $Q_1(1)$ is a unit in $R$. By
Lemma \ref{lemma-direct-sum-ML}
the modules $N$ and $K$ are Mittag-Leffler. Finally, the finitely generated
module $N$ is finitely presented as a finitely generated Mittag-Leffler
module is finitely presented, see
Example \ref{example-ML} part (1).
\end{proof}



\section{Filtered colimits of \'etale ring maps}
\label{section-ind-etale}

\noindent
This section is a precursor to the section on ind-\'etale ring maps
(Pro-\'etale Cohomology, Section \ref{proetale-section-ind-etale}).
The material will also be useful to prove uniqueness properties of the
henselization and strict henselization of a local ring.

\begin{lemma}
\label{lemma-base-change-colimit-etale}
Let $R \to A$ and $R \to R'$ be ring maps. If $A$ is a filtered
colimit of \'etale ring maps, then so is $R' \to R' \otimes_R A$.
\end{lemma}

\begin{proof}
This is true because colimits commute with tensor products
and \'etale ring maps are preserved under base change
(Lemma \ref{lemma-etale}).
\end{proof}

\begin{lemma}
\label{lemma-composition-colimit-etale}
Let $A \to B \to C$ be ring maps. If $A \to B$ is a filtered
colimit of \'etale ring maps and $B \to C$ is a filtered colimit
of \'etale ring maps, then $A \to C$ is a filtered colimit of
\'etale ring maps.
\end{lemma}

\begin{proof}
We will use the criterion of Lemma \ref{lemma-when-colimit}.
Let $A \to P \to C$ be a factorization of $A \to C$
with $P$ of finite presentation over $A$.
Write $B = \colim_{i \in I} B_i$ where $I$ is a directed set and
where $B_i$ is an \'etale $A$-algebra. 
Write $C = \colim_{j \in J} C_j$ where $J$ is a directed set and
where $C_j$ is an \'etale $B$-algebra.
We can factor $P \to C$ as $P \to C_j \to C$ for
some $j$ by Lemma \ref{lemma-characterize-finite-presentation}.
By Lemma \ref{lemma-etale} we can find an
$i \in I$ and an \'etale ring map $B_i \to C'_j$
such that $C_j = B \otimes_{B_i} C'_j$.
Then $C_j = \colim_{i' \geq i} B_{i'} \otimes_{B_i} C'_j$
and again we see that $P \to C_j$ factors as
$P \to B_{i'} \otimes_{B_i} C'_j \to C$.
As $A \to C' = B_{i'} \otimes_{B_i} C'_j$ is \'etale as
compositions and tensor products of \'etale ring maps
are \'etale. Hence we have factored $P \to C$ as
$P \to C' \to C$ with $C'$ \'etale over $A$ and the criterion
of Lemma \ref{lemma-when-colimit} applies.
\end{proof}

\begin{lemma}
\label{lemma-colimit-colimit-etale}
Let $R$ be a ring. Let $A = \colim A_i$ be a filtered colimit
of $R$-algebras such that each $A_i$ is a filtered colimit of
\'etale $R$-algebras. Then $A$ is a filtered colimit of \'etale
$R$-algebras.
\end{lemma}

\begin{proof}
Write $A_i = \colim_{j \in J_i} A_j$ where $J_i$ is a directed set and
$A_j$ is an \'etale $R$-algebra.
For each $i \leq i'$ and $j \in J_i$ there exists an
$j' \in J_{i'}$ and an $R$-algebra map $\varphi_{jj'} : A_j \to A_{j'}$
making the diagram
$$
\xymatrix{
A_i \ar[r] & A_{i'} \\
A_j \ar[u] \ar[r]^{\varphi_{jj'}} & A_{j'} \ar[u]
}
$$
commute. This is true because $R \to A_j$ is of finite presentation
so that Lemma \ref{lemma-characterize-finite-presentation} applies.
Let $\mathcal{J}$ be the category with objects $\coprod_{i \in I} J_i$
and morphisms triples $(j, j', \varphi_{jj'})$ as above (and obvious
composition law). Then $\mathcal{J}$ is a filtered category and
$A = \colim_\mathcal{J} A_j$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimits-of-etale}
Let $R$ be a ring. Let $A \to B$ be an $R$-algebra homomorphism.
If $A$ and $B$ are filtered colimits of \'etale $R$-algebras, then
$B$ is a filtered colimit of \'etale $A$-algebras.
\end{lemma}

\begin{proof}
Write $A = \colim A_i$ and $B = \colim B_j$ as filtered colimits with $A_i$
and $B_j$ \'etale over $R$. For each $i$ we can find a $j$ such that
$A_i \to B$ factors through $B_j$, see
Lemma \ref{lemma-characterize-finite-presentation}.
The factorization $A_i \to B_j$ is \'etale by
Lemma \ref{lemma-map-between-etale}.
Since $A \to A \otimes_{A_i} B_j$ is \'etale (Lemma \ref{lemma-etale})
it suffices to prove that $B = \colim A \otimes_{A_i} B_j$ where the
colimit is over pairs $(i, j)$ and factorizations $A_i \to B_j \to B$
of $A_i \to B$ (this is a directed system; details omitted).
This is clear because colimits commute with tensor products
and hence $\colim A \otimes_{A_i} B_j = A \otimes_A B = B$.
\end{proof}






\begin{lemma}
\label{lemma-map-into-henselian-colimit}
Let $R \to S$ be a ring map with $S$ henselian local. Given
\begin{enumerate}
\item an $R$-algebra $A$ which is a filtered colimit of \'etale $R$-algebras,
\item a prime $\mathfrak q$ of $A$ lying over
$\mathfrak p = R \cap \mathfrak m_S$,
\item a $\kappa(\mathfrak p)$-algebra map
$\tau : \kappa(\mathfrak q) \to S/\mathfrak m_S$,
\end{enumerate}
then there exists a unique homomorphism of $R$-algebras $f : A \to S$
such that $\mathfrak q = f^{-1}(\mathfrak m_S)$ and
$f \bmod \mathfrak q = \tau$.
\end{lemma}

\begin{proof}
Write $A = \colim A_i$ as a filtered colimit of \'etale $R$-algebras.
Set $\mathfrak q_i = A_i \cap \mathfrak q$. We obtain $f_i : A_i \to S$
by applying Lemma \ref{lemma-map-into-henselian}. Set $f = \colim f_i$.
\end{proof}

\begin{lemma}
\label{lemma-uniqueness-henselian}
Let $R$ be a ring. Given a commutative diagram of ring maps
$$
\xymatrix{
S \ar[r] & K \\
R \ar[u] \ar[r] & S' \ar[u]
}
$$
where $S$, $S'$ are henselian local, $S$, $S'$ are filtered colimits
of \'etale $R$-algebras, $K$ is a field and the arrows $S \to K$ and 
$S' \to K$ identify $K$ with the residue field of both $S$ and $S'$.
Then there exists an unique $R$-algebra isomorphism $S \to S'$
compatible with the maps to $K$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-map-into-henselian-colimit}.
\end{proof}

\noindent
The following lemma is not strictly speaking about colimits of \'etale
ring maps.

\begin{lemma}
\label{lemma-colimit-henselian}
A filtered colimit of henselian local rings along local homomorphisms
is henselian.
\end{lemma}

\begin{proof}
Categories, Lemma \ref{categories-lemma-directed-category-system}
says that this is really just a question about a colimit of
henselian local rings over a directed set.
Let $(R_i, \varphi_{ii'})$ be such a system with each $\varphi_{ii'}$
local. Then $R = \colim_i R_i$ is local, and
its residue field $\kappa$ is $\colim \kappa_i$
(argument omitted).
Suppose that $f \in R[T]$ is monic and that $a_0 \in \kappa$ is
a simple root of $\overline{f}$. Then for some large enough $i$
there exists an $f_i \in R_i[T]$ mapping to $f$ and an
$a_{0, i} \in \kappa_i$ mapping to $a_0$. Since
$\overline{f_i}(a_{0, i}) \in \kappa_i$,
resp.\ $\overline{f_i'}(a_{0, i}) \in \kappa_i$ maps to
$0 = \overline{f}(a_0) \in \kappa$,
resp.\ $0 \not = \overline{f'}(a_0) \in \kappa$
we conclude that $a_{0, i}$ is a simple root of $\overline{f_i}$.
As $R_i$ is henselian we can find $a_i \in R_i$ such that
$f_i(a_i) = 0$ and $a_{0, i} = \overline{a_i}$.
Then the image $a \in R$ of $a_i$ is the desired solution.
Thus $R$ is henselian.
\end{proof}




\section{Henselization and strict henselization}
\label{section-henselization}

\noindent
In this section we construct the henselization. We encourage the reader
to keep in mind the uniqueness already proved in
Lemma \ref{lemma-uniqueness-henselian}
and the functorial behaviour pointed out in
Lemma \ref{lemma-map-into-henselian-colimit}
while reading this material.

\begin{lemma}
\label{lemma-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring. There exists a
local ring map $R \to R^h$ with the following properties
\begin{enumerate}
\item $R^h$ is henselian,
\item $R^h$ is a filtered colimit of \'etale $R$-algebras,
\item $\mathfrak m R^h$ is the
maximal ideal of $R^h$, and
\item $\kappa = R^h/\mathfrak m R^h$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the category of pairs $(S, \mathfrak q)$ where $R \to S$ is an
\'etale ring map, and $\mathfrak q$ is a prime of $S$ lying over
$\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$. A morphism of pairs
$(S, \mathfrak q) \to (S', \mathfrak q')$ is given by an $R$-algebra
map $\varphi : S \to S'$ such that $\varphi^{-1}(\mathfrak q') = \mathfrak q$.
We set
$$
R^h = \colim_{(S, \mathfrak q)} S.
$$
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the pair $(R, \mathfrak m)$ and hence is not empty,
which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Note that for any pair $(S, \mathfrak q)$ the prime ideal $\mathfrak q$
is maximal, for example since
$\kappa \to S/\mathfrak q \subset \kappa(\mathfrak q)$ are isomorphisms.
Suppose that $(S, \mathfrak q)$ and $(S', \mathfrak q')$ are two objects. Set
$S'' = S \otimes_R S'$ and $\mathfrak q'' = \mathfrak qS'' + \mathfrak q'S''$.
Then $S''/\mathfrak q'' = S/\mathfrak q \otimes_R S'/\mathfrak q' = \kappa$
by what we said above. Moreover, $R \to S''$ is \'etale by
Lemma \ref{lemma-etale}.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q) \to (S', \mathfrak q')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
with prime ideal
$$
\mathfrak q'' =
(\mathfrak q' \otimes S' + S' \otimes \mathfrak q') \otimes S'
+
(S' \otimes_{\varphi, S, \psi} S') \otimes \mathfrak q'
$$
Arguing as above (base change of \'etale maps is \'etale, composition of
\'etale maps is \'etale) we see that $S''$ is \'etale over $R$. Moreover,
the canonical map $S' \to S''$ (using the right most factor for example)
equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that $R^h$ consists of triples $(S, \mathfrak q, f)$
with $f \in S$, and two such triples
$(S, \mathfrak q, f)$, $(S', \mathfrak q', f')$
define the same element of $R^h$ if and only if there exists
a pair $(S'', \mathfrak q'')$ and morphisms of pairs
$\varphi : (S, \mathfrak q) \to (S'', \mathfrak q'')$
and
$\varphi' : (S', \mathfrak q') \to (S'', \mathfrak q'')$
such that $\varphi(f) = \varphi'(f')$.

\medskip\noindent
Suppose that $x \in R^h$.
Represent $x$ by a triple $(S, \mathfrak q, f)$.
Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be
the other primes of $S$ lying over $\mathfrak m$.
Then we can find a $g \in S$, $g \not \in \mathfrak q$ and
$g \in \mathfrak q_i$ for $i = 1, \ldots, r$, see
Lemma \ref{lemma-silly}. Consider the morphism of
pairs $(S, \mathfrak q) \to (S_g, \mathfrak qS_g)$.
In this way we see that we may always assume that $x$
is given by a triple $(S, \mathfrak q, f)$ where
$\mathfrak q$ is the only prime of $S$ lying over $\mathfrak m$,
i.e., $\sqrt{\mathfrak mS} = \mathfrak q$. But since
$R \to S$ is \'etale, we have
$\mathfrak mS_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$, see
Lemma \ref{lemma-etale-at-prime}.
Hence we actually get that $\mathfrak mS = \mathfrak q$.

\medskip\noindent
Suppose that $x \not \in \mathfrak mR^h$.
Represent $x$ by a triple $(S, \mathfrak q, f)$ with
$\mathfrak mS = \mathfrak q$.
Then $f \not \in \mathfrak mS$, i.e., $f \not \in \mathfrak q$.
Hence $(S, \mathfrak q) \to (S_f, \mathfrak qS_f)$ is a morphism
of pairs such that the image of $f$ becomes invertible.
Hence $x$ is invertible with inverse represented by the triple
$(S_f, \mathfrak qS_f, 1/f)$. We conclude that $R^h$ is a local
ring with maximal ideal $\mathfrak mR^h$. The residue field is
$\kappa$ since we can define $R^h/\mathfrak mR^h \to \kappa$
by mapping a triple $(S, \mathfrak q, f)$ to the residue
class of $f$ module $\mathfrak q$.

\medskip\noindent
We still have to show that $R^h$ is henselian.
Namely, suppose that $P \in R^h[T]$ is a monic
polynomial and $a_0 \in \kappa$ is a simple root of
the reduction $\overline{P} \in \kappa[T]$.
Then we can find a pair $(S, \mathfrak q)$ such that
$P$ is the image of a monic polynomial $Q \in S[T]$.
Since $S \to R^h$ induces an isomorphism of residue
fields we see that $S' = S[T]/(Q)$ has a prime ideal
$\mathfrak q' = (\mathfrak q, T - a_0)$ at which
$S \to S'$ is standard \'etale. Moreover, $\kappa = \kappa(\mathfrak q')$.
Pick $g \in S'$, $g \not \in \mathfrak q'$ such that
$S'' = S'_g$ is \'etale over $S$. Then
$(S, \mathfrak q) \to (S'', \mathfrak q'S'')$ is a morphism
of pairs. Now that triple $(S'', \mathfrak q'S'', \text{class of }T)$
determines an element $a \in R^h$ with the properties $P(a) = 0$,
and $\overline{a} = a_0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-strict-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $\kappa \subset \kappa^{sep}$ be a separable algebraic closure.
There exists a commutative diagram
$$
\xymatrix{
\kappa \ar[r] & \kappa \ar[r] & \kappa^{sep} \\
R \ar[r] \ar[u] & R^h \ar[r] \ar[u] & R^{sh} \ar[u]
}
$$
with the following properties
\begin{enumerate}
\item the map $R^h \to R^{sh}$ is local
\item $R^{sh}$ is strictly henselian,
\item $R^{sh}$ is a filtered colimit of \'etale $R$-algebras,
\item $\mathfrak m R^{sh}$ is the
maximal ideal of $R^{sh}$, and
\item $\kappa^{sep} = R^{sh}/\mathfrak m R^{sh}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is proved by exactly the same proof as used for
Lemma \ref{lemma-henselization}.
The only difference is that, instead of pairs, one uses triples
$(S, \mathfrak q, \alpha)$ where $R \to S$ \'etale,
$\mathfrak q$ is a prime of $S$ lying over $\mathfrak m$, and
$\alpha : \kappa(\mathfrak q) \to \kappa^{sep}$ is an embedding
of extensions of $\kappa$.
\end{proof}

\begin{definition}
\label{definition-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
\begin{enumerate}
\item The local ring map $R \to R^h$ constructed in
Lemma \ref{lemma-henselization}
is called the {\it henselization} of $R$.
\item Given a separable algebraic closure $\kappa \subset \kappa^{sep}$
the local ring map $R \to R^{sh}$ constructed in
Lemma \ref{lemma-strict-henselization}
is called the
{\it strict henselization of $R$ with respect to
$\kappa \subset \kappa^{sep}$}.
\item A local ring map $R \to R^{sh}$ is called a {\it strict henselization}
of $R$ if it is isomorphic to one of the local ring maps constructed in
Lemma \ref{lemma-strict-henselization}
\end{enumerate}
\end{definition}

\noindent
The maps $R \to R^h \to R^{sh}$ are flat local ring homomorphisms.
By Lemma \ref{lemma-uniqueness-henselian} the $R$-algebras $R^h$ and
$R^{sh}$ are well defined up to unique isomorphism by the conditions
that they are henselian local, filtered colimits of \'etale $R$-algebras
with residue field $\kappa$ and $\kappa^{sep}$.
In the rest of this section we mostly just discuss functoriality of the
(strict) henselizations.
We will discuss more intricate results concerning
the relationship between $R$ and its henselization in
More on Algebra, Section \ref{more-algebra-section-permanence-henselization}.

\begin{remark}
\label{remark-construct-sh-from-h}
We can also construct $R^{sh}$ from $R^h$. Namely, for any finite separable
subextension $\kappa \subset \kappa' \subset \kappa^{sep}$
there exists a unique (up to unique isomorphism) finite \'etale local
ring extension $R^h \subset R^h(\kappa')$
whose residue field extension extension reproduces the given extension, see
Lemma \ref{lemma-henselian-cat-finite-etale}.
Hence we can set
$$
R^{sh} =
\bigcup\nolimits_{\kappa \subset \kappa' \subset \kappa^{sep}}
R^h(\kappa')
$$
The arrows in this system, compatible with the arrows on the level
of residue fields, exist by
Lemma \ref{lemma-henselian-cat-finite-etale}.
This will produce a henselian local ring by
Lemma \ref{lemma-colimit-henselian}
since each of the rings
$R^h(\kappa')$ is henselian by
Lemma \ref{lemma-finite-over-henselian}.
By construction the residue field extension induced by
$R^h \to R^{sh}$ is the field extension $\kappa \subset \kappa^{sep}$.
Hence $R^{sh}$ so constructed is strictly henselian.
By Lemma \ref{lemma-composition-colimit-etale} the $R$-algebra
$R^{sh}$ is a colimit of \'etale $R$-algebras. Hence the uniqueness
of Lemma \ref{lemma-uniqueness-henselian} shows that $R^{sh}$
is the strict henselization.
\end{remark}

\begin{lemma}
\label{lemma-henselian-functorial-prepare}
Let $R \to S$ be a local map of local rings.
Let $S \to S^h$ be the henselization.
Let $R \to A$ be an \'etale ring map and let $\mathfrak q$
be a prime of $A$ lying over $\mathfrak m_R$
such that $R/\mathfrak m_R \cong \kappa(\mathfrak q)$.
Then there exists a unique morphism of rings
$f : A \to S^h$ fitting into the commutative diagram
$$
\xymatrix{
A \ar[r]_f & S^h \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-map-into-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-henselian-functorial}
Let $R \to S$ be a local map of local rings.
Let $R \to R^h$ and $S \to S^h$ be the henselizations.
There exists a unique local ring map $R^h \to S^h$ fitting
into the commutative diagram
$$
\xymatrix{
R^h \ar[r]_f & S^h \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-map-into-henselian-colimit}.
\end{proof}

\noindent
Here is a slightly different construction of the henselization.

\begin{lemma}
\label{lemma-henselization-different}
Let $R$ be a ring.
Let $\mathfrak p \subset R$ be a prime ideal.
Consider the category of pairs $(S, \mathfrak q)$ where
$R \to S$ is \'etale and $\mathfrak q$ is a prime lying over $\mathfrak p$
such that $\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
This category is filtered and
$$
(R_{\mathfrak p})^h = \colim_{(S, \mathfrak q)} S
= \colim_{(S, \mathfrak q)} S_{\mathfrak q}
$$
canonically.
\end{lemma}

\begin{proof}
A morphism of pairs $(S, \mathfrak q) \to (S', \mathfrak q')$
is given by an $R$-algebra map $\varphi : S \to S'$ such that
$\varphi^{-1}(\mathfrak q') = \mathfrak q$.
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the pair $(R, \mathfrak p)$ and hence is not empty,
which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Suppose that $(S, \mathfrak q)$ and $(S', \mathfrak q')$ are two pairs.
Note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes
of the fibre rings $S \otimes \kappa(\mathfrak p)$,
resp.\ $S' \otimes \kappa(\mathfrak p)$ with residue fields
$\kappa(\mathfrak p)$, hence they correspond to maximal ideals of
$S \otimes \kappa(\mathfrak p)$, resp.\ $S' \otimes \kappa(\mathfrak p)$.
Set $S'' = S \otimes_R S'$. By the above there exists a unique
prime $\mathfrak q'' \subset S''$ lying over $\mathfrak q$ and over
$\mathfrak q'$ whose residue field is $\kappa(\mathfrak p)$.
The ring map $R \to S''$ is \'etale by
Lemma \ref{lemma-etale}.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q) \to (S', \mathfrak q')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
Arguing as above (base change of \'etale maps is \'etale, composition of
\'etale maps is \'etale) we see that $S''$ is \'etale over $R$. The fibre
ring of $S''$ over $\mathfrak p$ is
$$
F'' = (F' \otimes_{\varphi, F, \psi} F')
\otimes_{F' \otimes_{\kappa(\mathfrak p)} F'} F'
$$
where $F', F$ are the fibre rings of $S'$ and $S$. Since $\varphi$ and
$\psi$ are morphisms of pairs the map $F' \to \kappa(\mathfrak p)$
corresponding to $\mathfrak p'$ extends to a map $F'' \to \kappa(\mathfrak p)$
and in turn corresponds to a prime ideal $\mathfrak q'' \subset S''$
whose residue field is $\kappa(\mathfrak p)$.
The canonical map $S' \to S''$ (using the right most factor for example)
is a morphism of pairs $(S', \mathfrak q') \to (S'', \mathfrak q'')$
which equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that the category is filtered.

\medskip\noindent
Recall that in the proof of
Lemma \ref{lemma-henselization}
we constructed $(R_{\mathfrak p})^h$ as the corresponding colimit
but starting with $R_{\mathfrak p}$ and its maximal ideal
$\mathfrak pR_{\mathfrak p}$. Now, given any pair $(S, \mathfrak q)$
for $(R, \mathfrak p)$ we obtain a pair
$(S_{\mathfrak p}, \mathfrak qS_{\mathfrak p})$ for
$(R_{\mathfrak p}, \mathfrak pR_{\mathfrak p})$.
Moreover, in this situation
$$
S_{\mathfrak p} = \colim_{f \in R, f \not \in \mathfrak p} S_f.
$$
Hence in order to show the equalities
of the lemma, it suffices to show that any pair $(S_{loc}, \mathfrak q_{loc})$
for $(R_{\mathfrak p}, \mathfrak pR_{\mathfrak p})$ is of the form
$(S_{\mathfrak p}, \mathfrak qS_{\mathfrak p})$ for some pair
$(S, \mathfrak q)$ over $(R, \mathfrak p)$ (some details omitted).
This follows from
Lemma \ref{lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-henselian-functorial-improve}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying
over $\mathfrak p \subset R$. Let $R \to R^h$ and $S \to S^h$ be the
henselizations of $R_\mathfrak p$ and $S_\mathfrak q$. The local ring map
$R^h \to S^h$ of Lemma \ref{lemma-henselian-functorial} identifies $S^h$
with the henselization of $R^h \otimes_R S$ at the unique prime
lying over $\mathfrak m^h$ and $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-henselization-different} we see that $R^h$, resp.\ $S^h$
are filtered colimits of \'etale $R$, resp.\ $S$-algebras.
Hence we see that $R^h \otimes_R S$ is a filtered colimit of
\'etale $S$-algebras $A_i$ (Lemma \ref{lemma-etale}). By
Lemma \ref{lemma-colimits-of-etale} we see that $S^h$ is a
filtered colimit of \'etale $R^h \otimes_R S$-algebras.
Since moreover $S^h$ is a henselian local ring with residue field
equal to $\kappa(\mathfrak q)$, the statement follows from the uniqueness
result of Lemma \ref{lemma-uniqueness-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-henselization}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p$ in $R$.
Assume $R \to S$ is quasi-finite at $\mathfrak q$.
The commutative diagram
$$
\xymatrix{
R_{\mathfrak p}^h \ar[r] & S_{\mathfrak q}^h \\
R_{\mathfrak p} \ar[u] \ar[r] & S_{\mathfrak q} \ar[u]
}
$$
of
Lemma \ref{lemma-henselian-functorial}
identifies $S_{\mathfrak q}^h$ with the localization of
$R_{\mathfrak p}^h \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$
at the prime generated by $\mathfrak q$.
\end{lemma}

\begin{proof}
Note that $R_{\mathfrak p}^h \otimes_R S$ is quasi-finite over
$R_{\mathfrak p}^h$ at the prime ideal corresponding to $\mathfrak q$, see
Lemma \ref{lemma-four-rings}. Hence the localization $S'$ of
$R_{\mathfrak p}^h \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$ is henselian, see
Lemma \ref{lemma-finite-over-henselian}. As a localization $S'$ is a filtered
colimit of \'etale
$R_{\mathfrak p}^h \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$-algebras.
By Lemma \ref{lemma-henselian-functorial-improve} we see that
$S_\mathfrak q^h$ is the henselization of
$R_{\mathfrak p}^h \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$.
Thus $S' = S_\mathfrak q^h$ by the uniqueness
result of Lemma \ref{lemma-uniqueness-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-quotient-henselization}
Let $R$ be a local ring with henselization $R^h$.
Let $I \subset \mathfrak m_R$.
Then $R^h/IR^h$ is the henselization of $R/I$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-quasi-finite-henselization}.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-functorial-prepare}
Let $\varphi : R \to S$ be a local map of local rings.
Let $S/\mathfrak m_S \subset \kappa^{sep}$ be a separable algebraic closure.
Let $S \to S^{sh}$ be the strict henselization of $S$
with respect to $S/\mathfrak m_S \subset \kappa^{sep}$.
Let $R \to A$ be an \'etale ring map and let $\mathfrak q$
be a prime of $A$ lying over $\mathfrak m_R$.
Given any commutative diagram
$$
\xymatrix{
\kappa(\mathfrak q) \ar[r]_{\phi} & \kappa^{sep} \\
R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u]
}
$$
there exists a unique morphism of rings
$f : A \to S^{sh}$ fitting into the commutative diagram
$$
\xymatrix{
A \ar[r]_f & S^{sh} \\
R \ar[u] \ar[r]^{\varphi} & S \ar[u]
}
$$
such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$ and the induced
map $\kappa(\mathfrak q) \to \kappa^{sep}$ is the given one.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-map-into-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-functorial}
Let $R \to S$ be a local map of local rings.
Choose separable algebraic closures
$R/\mathfrak m_R \subset \kappa_1^{sep}$
and
$S/\mathfrak m_S \subset \kappa_2^{sep}$.
Let $R \to R^{sh}$ and $S \to S^{sh}$ be the corresponding strict
henselizations. Given any commutative diagram
$$
\xymatrix{
\kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\
R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u]
}
$$
There exists a unique local ring map $R^{sh} \to S^{sh}$ fitting
into the commutative diagram
$$
\xymatrix{
R^{sh} \ar[r]_f & S^{sh} \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
and inducing $\phi$ on the residue fields of
$R^{sh}$ and $S^{sh}$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-map-into-henselian-colimit}.
\end{proof}

\begin{lemma}
\label{lemma-strict-henselization-different}
Let $R$ be a ring.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\kappa(\mathfrak p) \subset \kappa^{sep}$ be a
separable algebraic closure.
Consider the category of triples $(S, \mathfrak q, \phi)$
where $R \to S$ is \'etale, $\mathfrak q$ is a prime lying over $\mathfrak p$,
and $\phi : \kappa(\mathfrak q) \to \kappa^{sep}$ is a
$\kappa(\mathfrak p)$-algebra map. This category is filtered and
$$
(R_{\mathfrak p})^{sh} =
\colim_{(S, \mathfrak q, \phi)} S =
\colim_{(S, \mathfrak q, \phi)} S_{\mathfrak q}
$$
canonically.
\end{lemma}

\begin{proof}
A morphism of triples $(S, \mathfrak q, \phi) \to (S', \mathfrak q', \phi')$
is given by an $R$-algebra map $\varphi : S \to S'$ such that
$\varphi^{-1}(\mathfrak q') = \mathfrak q$ and such that
$\phi' \circ \varphi = \phi$.
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the triple
$(R, \mathfrak p, \kappa(\mathfrak p) \subset \kappa^{sep})$
and hence is not empty, which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Suppose that $(S, \mathfrak q, \phi)$ and $(S', \mathfrak q', \phi')$
are two triples.
Note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes
of the fibre rings $S \otimes \kappa(\mathfrak p)$,
resp.\ $S' \otimes \kappa(\mathfrak p)$ with residue fields
finite separable over $\kappa(\mathfrak p)$ and $\phi$, resp.\ $\phi'$
correspond to maps into $\kappa^{sep}$. Hence this data corresponds to
$\kappa(\mathfrak p)$-algebra maps
$$
\phi : S \otimes_R \kappa(\mathfrak p) \longrightarrow \kappa^{sep},
\quad
\phi' : S' \otimes_R \kappa(\mathfrak p) \longrightarrow \kappa^{sep}.
$$
Set $S'' = S \otimes_R S'$. Combining the maps the above we get a unique
$\kappa(\mathfrak p)$-algebra map
$$
\phi'' = \phi \otimes \phi' :
S'' \otimes_R \kappa(\mathfrak p)
\longrightarrow
\kappa^{sep}
$$
whose kernel corresponds to a prime $\mathfrak q'' \subset S''$
lying over $\mathfrak q$ and over $\mathfrak q'$, and whose residue field
maps via $\phi''$ to the compositum of
$\phi(\kappa(\mathfrak q))$ and $\phi'(\kappa(\mathfrak q'))$ in
$\kappa^{sep}$. The ring map $R \to S''$ is \'etale by
Lemma \ref{lemma-etale}.
Hence $(S'', \mathfrak q'', \phi'')$ is a triple dominating both
$(S, \mathfrak q, \phi)$ and $(S', \mathfrak q', \phi')$.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q, \phi) \to (S', \mathfrak q', \phi')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
Arguing as above (base change of \'etale maps is \'etale, composition of
\'etale maps is \'etale) we see that $S''$ is \'etale over $R$. The fibre
ring of $S''$ over $\mathfrak p$ is
$$
F'' = (F' \otimes_{\varphi, F, \psi} F')
\otimes_{F' \otimes_{\kappa(\mathfrak p)} F'} F'
$$
where $F', F$ are the fibre rings of $S'$ and $S$. Since $\varphi$ and
$\psi$ are morphisms of triples the map $\phi' : F' \to \kappa^{sep}$
extends to a map $\phi'' : F'' \to \kappa^{sep}$
which in turn corresponds to a prime ideal $\mathfrak q'' \subset S''$.
The canonical map $S' \to S''$ (using the right most factor for example)
is a morphism of triples
$(S', \mathfrak q', \phi') \to (S'', \mathfrak q'', \phi'')$
which equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that the category is filtered.

\medskip\noindent
We still have to show that the colimit $R_{colim}$ of the system
is equal to the strict henselization
of $R_{\mathfrak p}$ with respect to $\kappa^{sep}$. To see this note that
the system of triples $(S, \mathfrak q, \phi)$ contains as a subsystem
the pairs $(S, \mathfrak q)$ of
Lemma \ref{lemma-henselization-different}.
Hence $R_{colim}$ contains $R_{\mathfrak p}^h$ by the result of that lemma.
Moreover, it is clear that $R_{\mathfrak p}^h \subset R_{colim}$
is a directed colimit of \'etale ring extensions.
It follows that $R_{colim}$ is henselian by
Lemmas \ref{lemma-finite-over-henselian} and
\ref{lemma-colimit-henselian}.
Finally, by
Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
we see that the residue field of $R_{colim}$ is equal to
$\kappa^{sep}$. Hence we conclude that $R_{colim}$ is strictly henselian
and hence equals the strict henselization of $R_{\mathfrak p}$ as desired.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-functorial-improve}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying
over $\mathfrak p \subset R$. Choose separable algebraic closures
$\kappa(\mathfrak p) \subset \kappa_1^{sep}$
and
$\kappa(\mathfrak q) \subset \kappa_2^{sep}$.
Let $R^{sh}$ and $S^{sh}$ be the corresponding strict
henselizations of $R_\mathfrak p$ and $S_\mathfrak q$.
Given any commutative diagram
$$
\xymatrix{
\kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\
\kappa(\mathfrak p) \ar[r]^{\varphi} \ar[u] & \kappa(\mathfrak q) \ar[u]
}
$$
The local ring map $R^{sh} \to S^{sh}$ of
Lemma \ref{lemma-strictly-henselian-functorial} identifies $S^{sh}$
with the strict henselization of $R^{sh} \otimes_R S$ at a prime
lying over $\mathfrak m^{sh}$ and $\mathfrak q$.
\end{lemma}

\begin{proof}
The proof is identical to the proof of
Lemma \ref{lemma-henselian-functorial-improve}
except that it uses
Lemma \ref{lemma-strict-henselization-different}
instead of
Lemma \ref{lemma-henselization-different}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-strict-henselization}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p$ in $R$.
Let $\kappa(\mathfrak q) \subset \kappa^{sep}$ be a separable
algebraic closure. Assume $R \to S$ is quasi-finite at $\mathfrak q$.
The commutative diagram
$$
\xymatrix{
R_{\mathfrak p}^{sh} \ar[r] & S_{\mathfrak q}^{sh} \\
R_{\mathfrak p} \ar[u] \ar[r] & S_{\mathfrak q} \ar[u]
}
$$
of
Lemma \ref{lemma-strictly-henselian-functorial}
identifies $S_{\mathfrak q}^{sh}$ with a localization of
$R_{\mathfrak p}^{sh} \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$.
\end{lemma}

\begin{proof}
The residue field of $R_{\mathfrak p}^{sh}$ is the separable
algebraic closure of $\kappa(\mathfrak p)$ in $\kappa^{sep}$.
Note that $R_{\mathfrak p}^{sh} \otimes_R S$ is quasi-finite over
$R_{\mathfrak p}^{sh}$ at the prime ideal corresponding to $\mathfrak q$, see
Lemma \ref{lemma-four-rings}. Hence the localization $S'$ of
$R_{\mathfrak p}^{sh} \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$
is henselian, see
Lemma \ref{lemma-finite-over-henselian}.
Note that the residue field of $S'$ is $\kappa^{sep}$ since it
contains both the separable algebraic closure of
$\kappa(\mathfrak p)$ and $\kappa(\mathfrak q)$.
Furthermore, as a localization $S'$ is a filtered colimit of \'etale
$R_{\mathfrak p}^{sh} \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$-algebras.
By Lemma \ref{lemma-strictly-henselian-functorial-improve}
we see that $S_{\mathfrak q}^{sh}$ is a strict henselization of
$R_{\mathfrak p}^{sh} \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$.
Thus $S' = S_\mathfrak q^h$ by the uniqueness
result of Lemma \ref{lemma-uniqueness-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-quotient-strict-henselization}
Let $R$ be a local ring with strict henselization $R^{sh}$.
Let $I \subset \mathfrak m_R$.
Then $R^{sh}/IR^{sh}$ is a strict henselization of $R/I$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-quasi-finite-strict-henselization}.
\end{proof}

\begin{lemma}
\label{lemma-sh-from-h-map}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime
lying over $\mathfrak p \subset R$ such that
$\kappa(\mathfrak p) \to \kappa(\mathfrak q)$ is an isomorphism.
Choose a separable algebraic closure $\kappa^{sep}$ of
$\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
Then
$$
(S_\mathfrak q)^{sh} =
(S_\mathfrak q)^h \otimes_{(R_\mathfrak p)^h} (R_\mathfrak p)^{sh}
$$
\end{lemma}

\begin{proof}
This follows from the alternative construction of the strict henselization
of a local ring in Remark \ref{remark-construct-sh-from-h} and the
fact that the residue fields are equal. Some details omitted.
\end{proof}








\section{Serre's criterion for normality}
\label{section-serre-criterion}

\noindent
We introduce the following properties of Noetherian rings.

\begin{definition}
\label{definition-conditions}
Let $R$ be a Noetherian ring.
Let $k \geq 0$ be an integer.
\begin{enumerate}
\item We say $R$ has property {\it $(R_k)$} if for every prime $\mathfrak p$
of height $\leq k$ the local ring $R_{\mathfrak p}$ is regular.
We also say that $R$ is {\it regular in codimension $\leq k$}.
\item We say $R$ has property {\it $(S_k)$} if for every prime $\mathfrak p$
the local ring $R_{\mathfrak p}$ has depth at least
$\min\{k, \dim(R_{\mathfrak p})\}$.
\item Let $M$ be a finite $R$-module. We say $M$ has property $(S_k)$
if for every prime $\mathfrak p$ the module
$M_{\mathfrak p}$ has depth at least
$\min\{k, \dim(\text{Supp}(M_{\mathfrak p}))\}$.
\end{enumerate}
\end{definition}

\noindent
Any Noetherian ring has property $(S_0)$ (and so does any finite module
over it). Our convention that $\dim(\emptyset) = -\infty$ guarantees
that the zero module has property $(S_k)$ for all $k$.

\begin{lemma}
\label{lemma-criterion-no-embedded-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ has no embedded associated prime, and
\item $M$ has property $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be an embedded associated prime of $M$.
Then there exists another associated prime $\mathfrak q$ of $M$
such that $\mathfrak p \supset \mathfrak q$. In particular this
implies that $\dim(\text{Supp}(M_{\mathfrak p})) \geq 1$ (since $\mathfrak q$
is in the support as well). On the other hand $\mathfrak pR_{\mathfrak p}$
is associated to $M_{\mathfrak p}$
(Lemma \ref{lemma-associated-primes-localize}) and hence
$\text{depth}(M_{\mathfrak p}) = 0$
(see Lemma \ref{lemma-ideal-nonzerodivisor}).
In other words $(S_1)$ does not hold.
Conversely, if $(S_1)$ does not hold then there exists a prime
$\mathfrak p$ such that $\dim(\text{Supp}(M_{\mathfrak p})) \geq 1$
and $\text{depth}(M_{\mathfrak p}) = 0$. Then we see
(arguing backwards using the lemmas cited above) that $\mathfrak p$
is an embedded associated prime.
\end{proof}

\begin{lemma}
\label{lemma-criterion-reduced}
\begin{slogan}
Reduced equals R0 plus S1.
\end{slogan}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ is reduced, and
\item $R$ has properties $(R_0)$ and $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose that $R$ is reduced. Then $R_{\mathfrak p}$ is a field for
every minimal prime $\mathfrak p$ of $R$, according to
Lemma \ref{lemma-minimal-prime-reduced-ring}. Hence we have $(R_0)$.
Let $\mathfrak p$ be a prime of height $\geq 1$. Then $A = R_{\mathfrak p}$
is a reduced local ring of dimension $\geq 1$. Hence its maximal
ideal $\mathfrak m$ is not an associated prime
since this would mean there exists a $x \in \mathfrak m$
with annihilator $\mathfrak m$ so $x^2 = 0$. Hence the depth of
$A = R_{\mathfrak p}$ is at least one, by Lemma \ref{lemma-ass-zero-divisors}.
This shows that $(S_1)$ holds.

\medskip\noindent
Conversely, assume that $R$ satisfies $(R_0)$ and $(S_1)$.
If $\mathfrak p$ is a minimal prime of $R$, then
$R_{\mathfrak p}$ is a field by $(R_0)$, and hence is reduced.
If $\mathfrak p$ is not minimal, then we see that $R_{\mathfrak p}$
has depth $\geq 1$ by $(S_1)$ and we conclude there exists an element
$t \in \mathfrak pR_{\mathfrak p}$ such that
$R_{\mathfrak p} \to R_{\mathfrak p}[1/t]$ is injective.
This implies that $R_{\mathfrak p}$ is a subring of localizations
of $R$ at primes of smaller height. Thus by induction on the height we
conclude that $R$ is reduced.
\end{proof}

\begin{lemma}[Serre's criterion for normality]
\label{lemma-criterion-normal}
\begin{slogan}
Normal equals R1 plus S2.
\end{slogan}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ is a normal ring, and
\item $R$ has properties $(R_1)$ and $(S_2)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1) $\Rightarrow$ (2). Assume $R$ is normal, i.e., all
localizations $R_{\mathfrak p}$ at primes are normal domains.
In particular we see that $R$ has $(R_0)$ and $(S_1)$ by
Lemma \ref{lemma-criterion-reduced}. Hence it suffices to show
that a local Noetherian normal domain $R$ of dimension $d$ has
depth $\geq \min(2, d)$ and is regular if $d = 1$. The assertion
if $d = 1$ follows from Lemma \ref{lemma-characterize-dvr}.

\medskip\noindent
Let $R$ be a local Noetherian normal domain with maximal ideal
$\mathfrak m$ and dimension $d \geq 2$. Apply
Lemma \ref{lemma-hart-serre-loc-thm} to $R$.
It is clear that $R$ does not fall into cases (1) or (2)
of the lemma.
Let $R \to R'$ as in (4) of the lemma.
Since $R$ is a domain we have $R \subset R'$. Since $\mathfrak m$
is not an associated prime of $R'$ there exists an $x \in \mathfrak m$
which is a nonzerodivisor on $R'$. Then $R_x = R'_x$ so
$R$ and $R'$ are domains with the same fraction field. But
finiteness of $R \subset R'$ implies every element of $R'$ is integral
over $R$ (Lemma \ref{lemma-finite-is-integral})
and we conclude that $R = R'$ as $R$ is normal.
This means (4) does not happen. Thus we get the remaining possibility
(3), i.e., $\text{depth}(R) \geq 2$ as desired.

\medskip\noindent
Proof of (2) $\Rightarrow$ (1). Assume $R$ satisfies $(R_1)$ and $(S_2)$.
By Lemma \ref{lemma-criterion-reduced} we conclude that $R$ is
reduced. Hence it suffices to show that if $R$ is a reduced local
Noetherian ring of dimension $d$ satisfying $(S_2)$ and $(R_1)$
then $R$ is a normal domain. If $d = 0$, the result is clear.
If $d = 1$, then the result follows from Lemma \ref{lemma-characterize-dvr}.

\medskip\noindent
Let $R$ be a reduced local Noetherian ring with maximal ideal
$\mathfrak m$ and dimension $d \geq 2$ which satisfies $(R_1)$ and
$(S_2)$. By Lemma \ref{lemma-characterize-reduced-ring-normal}
it suffices to show that $R$ is integrally closed in its
total ring of fractions $Q(R)$. Pick $x \in Q(R)$ which is integral
over $R$. Then $R' = R[x]$ is a finite ring extension of $R$
(Lemma \ref{lemma-characterize-finite-in-terms-of-integral}).
Because $\dim(R_\mathfrak p) < d$ for
every nonmaximal prime $\mathfrak p \subset R$
we have $R_\mathfrak p = R'_\mathfrak p$ by induction.
Hence the support of $R'/R$ is $\{\mathfrak m\}$.
It follows that $R'/R$ is annihilated by a power of $\mathfrak m$
(Lemma \ref{lemma-Noetherian-power-ideal-kills-module}).
By Lemma \ref{lemma-hart-serre-loc-thm} this
contradicts the assumption that the depth of $R$ is $\geq 2 = \min(2, d)$
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-regular-normal}
A regular ring is normal.
\end{lemma}

\begin{proof}
Let $R$ be a regular ring. By
Lemma \ref{lemma-criterion-normal}
it suffices to prove that $R$ is $(R_1)$ and $(S_2)$.
As a regular local ring is Cohen-Macaulay, see
Lemma \ref{lemma-regular-ring-CM},
it is clear that $R$ is $(S_2)$.
Property $(R_1)$ is immediate.
\end{proof}

\begin{lemma}
\label{lemma-normal-domain-intersection-localizations-height-1}
Let $R$ be a Noetherian normal domain with fraction field $K$. Then
\begin{enumerate}
\item for any nonzero $a \in R$ the quotient $R/aR$ has no embedded primes,
and all its associated primes have height $1$
\item
$$
R = \bigcap\nolimits_{\text{height}(\mathfrak p) = 1} R_{\mathfrak p}
$$
\item For any nonzero $x \in K$ the quotient $R/(R \cap xR)$
has no embedded primes, and all its associates primes have height $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-criterion-normal} we see that $R$ has $(S_2)$.
Hence for any nonzero element $a \in R$ we see that $R/aR$ has $(S_1)$
(use Lemma \ref{lemma-depth-in-ses} for example)
Hence $R/aR$ has no embedded primes
(Lemma \ref{lemma-criterion-no-embedded-primes}).
We conclude the associated primes of $R/aR$ are exactly
the minimal primes $\mathfrak p$ over $(a)$, which have height $1$
as $a$ is not zero (Lemma \ref{lemma-minimal-over-1}). This proves (1).

\medskip\noindent
Thus, given $b \in R$ we have $b \in aR$ if and only if
$b \in aR_{\mathfrak p}$ for every minimal prime $\mathfrak p$
over $(a)$ (see Lemma \ref{lemma-zero-at-ass-zero}).
These primes all have height $1$ as seen above so
$b/a \in R$ if and only if $b/a \in R_{\mathfrak p}$ for all
height 1 primes. Hence (2) holds.

\medskip\noindent
For (3) write $x = a/b$. Let $\mathfrak p_1, \ldots, \mathfrak p_r$
be the minimal primes over $(ab)$. These all have height 1 by the above.
Then we see that
$R \cap xR = \bigcap_{i = 1, \ldots, r} (R \cap xR_{\mathfrak p_i})$
by part (2) of the lemma. Hence $R/(R \cap xR)$ is a submodule of
$\bigoplus R/(R \cap xR_{\mathfrak p_i})$.
As $R_{\mathfrak p_i}$ is a discrete valuation ring (by property $(R_1)$
for the Noetherian normal domain $R$, see Lemma \ref{lemma-criterion-normal})
we have $xR_{\mathfrak p_i} = \mathfrak p_i^{e_i}R_{\mathfrak p_i}$
for some $e_i \in \mathbf{Z}$. Hence the direct sum is equal
to $\bigoplus_{e_i > 0} R/\mathfrak p_i^{(e_i)}$, see
Definition \ref{definition-symbolic-power}.
By Lemma \ref{lemma-symbolic-power-associated}
the only associated prime of the module
$R/\mathfrak p^{(n)}$ is $\mathfrak p$. Hence the set of associate primes
of $R/(R \cap xR)$ is a subset of $\{\mathfrak p_i\}$ and there are
no inclusion relations among them. This proves (3).
\end{proof}















\section{Formal smoothness of fields}
\label{section-p-bases}

\noindent
In this section we show that field extensions are formally smooth
if and only if they are separable. However, we first prove finitely
generated field extensions are separable algebraic if and only if
they are formally unramified.

\begin{lemma}
\label{lemma-characterize-separable-algebraic-field-extensions}
Let $k \subset K$ be a finitely generated field extension.
The following are equivalent
\begin{enumerate}
\item $K$ is a finite separable field extension of $k$,
\item $\Omega_{K/k} = 0$,
\item $K$ is formally unramified over $k$,
\item $K$ is unramified over $k$,
\item $K$ is formally \'etale over $k$,
\item $K$ is \'etale over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (2) and (3) is
Lemma \ref{lemma-characterize-formally-unramified}.
By Lemma \ref{lemma-etale-over-field}
we see that (1) is equivalent to (6).
Property (6) implies (5) and (4) which both in turn imply (3)
(Lemmas \ref{lemma-formally-etale-etale}, \ref{lemma-unramified},
and \ref{lemma-formally-unramified-unramified}).
Thus it suffices to show that (2) implies (1).
Choose a finitely generated $k$-subalgebra $A \subset K$
such that $K$ is the fraction field of the domain $A$.
Set $S = A \setminus \{0\}$.
Since $0 = \Omega_{K/k} = S^{-1}\Omega_{A/k}$
(Lemma \ref{lemma-differentials-localize})
and since $\Omega_{A/k}$ is finitely generated
(Lemma \ref{lemma-differentials-finitely-generated}),
we can replace $A$ by a localization $A_f$ to reduce to the case
that $\Omega_{A/k} = 0$ (details omitted).
Then $A$ is unramified over $k$, hence
$K/k$ is finite separable for example by
Lemma \ref{lemma-unramified-at-prime} applied with $\mathfrak q = (0)$.
\end{proof}

\begin{lemma}
\label{lemma-derivative-zero-pth-power}
Let $k$ be a perfect field of characteristic $p > 0$.
Let $K/k$ be an extension.
Let $a \in K$. Then $\text{d}a = 0$ in $\Omega_{K/k}$
if and only if $a$ is a $p$th power.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-colimit-differentials} we see that there exists a subfield
$k \subset L \subset K$ such that $k \subset L$
is a finitely generated field extension and such that
$\text{d}a$ is zero in $\Omega_{L/k}$.
Hence we may assume that $K$ is a finitely generated field extension
of $k$.

\medskip\noindent
Choose a transcendence basis $x_1, \ldots, x_r \in K$
such that $K$ is finite separable over $k(x_1, \ldots, x_r)$.
This is possible by the definitions, see
Definitions \ref{definition-perfect} and
\ref{definition-separable-field-extension}.
We remark that the result holds for the purely transcendental
subfield $k(x_1, \ldots, x_r) \subset K$.
Namely,
$$
\Omega_{k(x_1, \ldots, x_r)/k} =
\bigoplus\nolimits_{i = 1}^r k(x_1, \ldots, x_r) \text{d}x_i
$$
and any rational function all of whose partial derivatives are zero
is a $p$th power. Moreover, we also have
$$
\Omega_{K/k} =
\bigoplus\nolimits_{i = 1}^r K\text{d}x_i
$$
since $k(x_1, \ldots, x_r) \subset K$ is finite separable
(computation omitted). Suppose $a \in K$ is an element such that
$\text{d}a = 0$ in the module of differentials. By our choice of $x_i$ we
see that the minimal polynomial $P(T) \in k(x_1, \ldots, x_r)[T]$
of $a$ is separable. Write
$$
P(T) = T^d + \sum\nolimits_{i = 1}^d a_i T^{d - i}
$$
and hence
$$
0 = \text{d}P(a) = \sum\nolimits_{i = 1}^d a^{d - i}\text{d}a_i
$$
in $\Omega_{K/k}$. By the description of
$\Omega_{K/k}$ above and the fact that $P$ was the minimal
polynomial of $a$, we see that this implies $\text{d}a_i = 0$.
Hence $a_i = b_i^p$ for each $i$. Therefore by
Fields, Lemma \ref{fields-lemma-pth-root}
we see that $a$ is a $p$th power.
\end{proof}

\begin{lemma}
\label{lemma-size-extension-pth-roots}
Let $k$ be a field of characteristic $p > 0$.
Let $a_1, \ldots, a_n \in k$ be elements such that
$\text{d}a_1, \ldots, \text{d}a_n$ are linearly independent in
$\Omega_{k/\mathbf{F}_p}$. Then the field extension
$k(a_1^{1/p}, \ldots, a_n^{1/p})$ has degree $p^n$ over $k$.
\end{lemma}

\begin{proof}
By induction on $n$. If $n = 1$ the result is
Lemma \ref{lemma-derivative-zero-pth-power}.
For the induction step, suppose that $k(a_1^{1/p}, \ldots, a_{n - 1}^{1/p})$
has degree $p^{n - 1}$ over $k$. We have to show that $a_n$ does not
map to a $p$th power in $k(a_1^{1/p}, \ldots, a_{n - 1}^{1/p})$.
If it does then we can write
\begin{align*}
a_n & =
\left(\sum\nolimits_{I = (i_1, \ldots, i_{n - 1}),\ 0 \leq i_j \leq p - 1}
\lambda_I a_1^{i_1/p} \ldots a_{n - 1}^{i_{n - 1}/p}\right)^p \\
& = \sum\nolimits_{I = (i_1, \ldots, i_{n - 1}),\ 0 \leq i_j \leq p - 1}
\lambda_I^p a_1^{i_1} \ldots a_{n - 1}^{i_{n - 1}}
\end{align*}
Applying $\text{d}$ we see that $\text{d}a_n$ is linearly dependent on
$\text{d}a_i$, $i < n$. This is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-separable-differentials}
Let $k$ be a field of characteristic $p > 0$.
The following are equivalent:
\begin{enumerate}
\item the field extension $K/k$ is separable
(see Definition \ref{definition-separable-field-extension}), and
\item the map
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $K$ as a directed colimit $K = \colim_i K_i$ of finitely generated
field extensions $k \subset K_i$. By definition $K$ is separable if and only
if each $K_i$ is separable over $k$, and by
Lemma \ref{lemma-colimit-differentials} we see that
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective if and only if each
$K_i \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K_i/\mathbf{F}_p}$
is injective. Hence we may assume that $K/k$ is a finitely generated field
extension.

\medskip\noindent
Assume $k \subset K$ is a finitely generated field extension which is
separable. Choose $x_1, \ldots, x_{r + 1} \in K$ as in
Lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}.
In this case there exists an irreducible polynomial
$G(X_1, \ldots, X_{r + 1}) \in k[X_1, \ldots, X_{r + 1}]$
such that $G(x_1, \ldots, x_{r + 1}) = 0$ and such that
$\partial G/\partial X_{r + 1}$ is not identically zero.
Moreover $K$ is the field of fractions of the domain.
$S = K[X_1, \ldots, X_{r + 1}]/(G)$.
Write
$$
G = \sum a_I X^I, \quad X^I = X_1^{i_1}\ldots X_{r + 1}^{i_{r + 1}}.
$$
Using the presentation of $S$ above we see that
$$
\Omega_{S/\mathbf{F}_p}
=
\frac{
S \otimes_k \Omega_k \oplus
\bigoplus\nolimits_{i = 1, \ldots, r + 1} S\text{d}X_i
}{
\langle
\sum X^I \text{d}a_I + \sum \partial G/\partial X_i \text{d}X_i
\rangle
}
$$
Since $\Omega_{K/\mathbf{F}_p}$ is the localization
of the $S$-module $\Omega_{S/\mathbf{F}_p}$ (see
Lemma \ref{lemma-differentials-localize}) we conclude
that
$$
\Omega_{K/\mathbf{F}_p}
=
\frac{
K \otimes_k \Omega_k \oplus
\bigoplus\nolimits_{i = 1, \ldots, r + 1} K\text{d}X_i
}{
\langle
\sum X^I \text{d}a_I + \sum \partial G/\partial X_i \text{d}X_i
\rangle
}
$$
Now, since the polynomial $\partial G/\partial X_{r + 1}$ is not identically
zero we conclude that the map
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{S/\mathbf{F}_p}$
is injective as desired.

\medskip\noindent
Assume $k \subset K$ is a finitely generated field extension
and that
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective.
(This part of the proof is the same as the argument proving
Lemma \ref{lemma-characterize-separable-field-extensions}.)
Let $x_1, \ldots, x_r$ be a transcendence basis of $K$ over $k$ such
that the degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset K$ is minimal.
If $K$ is separable over $k(x_1, \ldots, x_r)$ then we win.
Assume this is not the case to get a contradiction.
Then there exists an element $\alpha \in K$ which is not
separable over $k(x_1, \ldots, x_r)$. Let $P(T) \in k(x_1, \ldots, x_r)[T]$
be its minimal polynomial. Because $\alpha$ is not separable
actually $P$ is a polynomial in $T^p$. Clear denominators
to get an irreducible polynomial
$$
G(X_1, \ldots, X_r, T) = \sum a_{I, i} X^I T^i \in k[X_1, \ldots, X_r, T]
$$
such that $G(x_1, \ldots, x_r, \alpha) = 0$ in $L$.
Note that this means $k[X_1, \ldots, X_r, T]/(G) \subset L$.
We may assume that for some pair $(I_0, i_0)$ the coefficient
$a_{I_0, i_0} = 1$.
We claim that $\text{d}G/\text{d}X_i$ is not identically zero
for at least one $i$. Namely, if this is not the case, then
$G$ is actually a polynomial in $X_1^p, \ldots, X_r^p, T^p$.
Then this means that
$$
\sum\nolimits_{(I, i) \not = (I_0, i_0)} x^I\alpha^i \text{d}a_{I, i}
$$
is zero in $\Omega_{K/\mathbf{F}_p}$. Note that there is no
$k$-linear relation among the elements
$$
\{x^I\alpha^i \mid a_{I, i} \not = 0 \text{ and } (I, i) \not = (I_0, i_0)\}
$$
of $K$. Hence the assumption
that $K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective this implies that $\text{d}a_{I, i} = 0$
in $\Omega_{k/\mathbf{F}_p}$ for all $(I, i)$.
By Lemma \ref{lemma-derivative-zero-pth-power}
we see that each $a_{I, i}$ is a $p$th power, which
implies that $G$ is a $p$th power contradicting the irreducibility of
$G$. Thus,
after renumbering, we may assume that $\text{d}G/\text{d}X_1$ is not zero.
Then we see that $x_1$ is separably algebraic over
$k(x_2, \ldots, x_r, \alpha)$, and that $x_2, \ldots, x_r, \alpha$
is a transcendence basis of $L$ over $k$. This means that
the degree of inseparability of the finite extension
$k(x_2, \ldots, x_r, \alpha) \subset L$ is less than the
degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$, which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-implies-separable}
Let $k \subset K$ be an extension of fields.
If $K$ is formally smooth over $k$, then $K$ is
a separable extension of $k$.
\end{lemma}

\begin{proof}
Assume $K$ is formally smooth over $k$.
By Lemma \ref{lemma-ses-formally-smooth} we see that
$K \otimes_k \Omega_{k/\mathbf{Z}} \to \Omega_{K/\mathbf{Z}}$
is injective. Hence $K$ is separable over $k$ by
Lemma \ref{lemma-separable-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-smooth-field-extension}
Let $k \subset K$ be an extension of fields.
Then $K$ is formally smooth over $k$ if and only if
$H_1(L_{K/k}) = 0$.
\end{lemma}

\begin{proof}
This follows from Proposition \ref{proposition-characterize-formally-smooth}
and the fact that a vector spaces is free (hence projective).
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-extensions-easy}
Let $k \subset K$ be an extension of fields.
\begin{enumerate}
\item If $K$ is purely transcendental over $k$, then
$K$ is formally smooth over $k$.
\item If $K$ is separable algebraic over $k$, then $K$ is
formally smooth over $k$.
\item If $K$ is separable over $k$, then $K$ is formally smooth
over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
For (1) write $K = k(x_j; j \in J)$. Suppose that
$A$ is a $k$-algebra, and $I \subset A$ is an ideal of
square zero. Let $\varphi : K \to A/I$ be a $k$-algebra map.
Let $a_j \in A$ be an element such that $a_j \mod I = \varphi(x_j)$.
Then it is easy to see that there is a unique $k$-algebra
map $K \to A$ which maps $x_j$ to $a_j$ and which reduces
to $\varphi$ mod $I$. Hence $k \subset K$ is formally smooth.

\medskip\noindent
In case (2) we see that $k \subset K$ is a colimit of
\'etale ring extensions. An \'etale ring map is formally \'etale
(Lemma \ref{lemma-formally-etale-etale}). Hence this case follows from
Lemma \ref{lemma-colimit-formally-etale} and the trivial observation
that a formally \'etale ring map is formally smooth.

\medskip\noindent
In case (3), write $K = \colim K_i$ as the filtered colimit of its
finitely generated sub $k$-extensions. By
Definition \ref{definition-separable-field-extension}
each $K_i$ is separable algebraic over a purely transcendental
extension of $k$. Hence $K_i/k$ is formally smooth by cases (1) and (2) and
Lemma \ref{lemma-compose-formally-smooth}. Thus
$H_1(L_{K_i/k}) = 0$ by
Lemma \ref{lemma-characterize-formally-smooth-field-extension}.
Hence $H_1(L_{K/k}) = 0$ by Lemma \ref{lemma-colimits-NL}.
Hence $K/k$ is formally smooth by
Lemma \ref{lemma-characterize-formally-smooth-field-extension} again.
\end{proof}

\begin{lemma}
\label{lemma-fields-are-formally-smooth}
\begin{slogan}
Formally smooth equals separable for field extensions.
\end{slogan}
Let $k$ be a field.
\begin{enumerate}
\item If the characteristic of $k$ is zero, then any extension field
of $k$ is formally smooth over $k$.
\item If the characteristic of $k$ is $p > 0$, then $k \subset K$ is
formally smooth if and only if it is a separable field extension.
\end{enumerate}
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-formally-smooth-implies-separable} and
\ref{lemma-formally-smooth-extensions-easy}.
\end{proof}

\noindent
Here we put together all the different characterizations of separable
field extensions.

\begin{proposition}
\label{proposition-characterize-separable-field-extensions}
Let $k \subset K$ be a field extension.
If the characteristic of $k$ is zero then
\begin{enumerate}
\item $K$ is separable over $k$,
\item $K$ is geometrically reduced over $k$,
\item $K$ is formally smooth over $k$,
\item $H_1(L_{K/k}) = 0$, and
\item the map $K \otimes_k \Omega_{k/\mathbf{Z}} \to \Omega_{K/\mathbf{Z}}$
is injective.
\end{enumerate}
If the characteristic of $k$ is $p > 0$, then the following are
equivalent:
\begin{enumerate}
\item $K$ is separable over $k$,
\item the ring $K \otimes_k k^{1/p}$ is reduced,
\item $K$ is geometrically reduced over $k$,
\item the map $K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective,
\item $H_1(L_{K/k}) = 0$, and
\item $K$ is formally smooth over $k$.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a combination of
Lemmas \ref{lemma-characterize-separable-field-extensions},
\ref{lemma-fields-are-formally-smooth}
\ref{lemma-formally-smooth-implies-separable}, and
\ref{lemma-separable-differentials}.
\end{proof}

\noindent
Here is yet another characterization of finitely generated separable field
extensions.

\begin{lemma}
\label{lemma-localization-smooth-separable}
Let $k \subset K$ be a finitely generated field extension.
Then $K$ is separable over $k$ if and only if $K$ is
the localization of a smooth $k$-algebra.
\end{lemma}

\begin{proof}
Choose a finite type $k$-algebra $R$ which is a domain whose
fraction field is $K$. Lemma \ref{lemma-smooth-at-generic-point}
says that $k \to R$ is smooth
at $(0)$ if and only if $K/k$ is separable.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-colimit-syntomic}
Let $k \subset K$ be a field extension.
Then $K$ is a filtered colimit of global complete intersection
algebras over $k$. If $K/k$ is separable, then $K$ is a filtered
colimit of smooth algebras over $k$.
\end{lemma}

\begin{proof}
Suppose that $E \subset K$ is a finite subset. It suffices to show that
there exists a $k$ subalgebra $A \subset K$ which contains $E$
and which is a global complete intersection (resp.\ smooth) over $k$.
The separable/smooth case follows from
Lemma \ref{lemma-localization-smooth-separable}.
In general let $L \subset K$ be the subfield generated by $E$.
Pick a transcendence basis $x_1, \ldots, x_d \in L$ over $k$.
The extension $k(x_1, \ldots, x_d) \subset L$ is finite.
Say $L = k(x_1, \ldots, x_d)[y_1, \ldots, y_r]$.
Pick inductively polynomials $P_i \in k(x_1, \ldots, x_d)[Y_1, \ldots, Y_r]$
such that $P_i = P_i(Y_1, \ldots, Y_i)$ is monic in $Y_i$ over
$k(x_1, \ldots, x_d)[Y_1, \ldots, Y_{i - 1}]$ and maps to the
minimum polynomial of $y_i$ in
$k(x_1, \ldots, x_d)[y_1, \ldots, y_{i - 1}][Y_i]$.
Then it is clear that $P_1, \ldots, P_r$ is a regular sequence
in $k(x_1, \ldots, x_r)[Y_1, \ldots, Y_r]$ and that
$L = k(x_1, \ldots, x_r)[Y_1, \ldots, Y_r]/(P_1, \ldots, P_r)$.
If $h \in k[x_1, \ldots, x_d]$ is a polynomial such that
$P_i \in k[x_1, \ldots, x_d, 1/h, Y_1, \ldots, Y_r]$, then
we see that $P_1, \ldots, P_r$ is a regular sequence in
$k[x_1, \ldots, x_d, 1/h, Y_1, \ldots, Y_r]$ and
$A = k[x_1, \ldots, x_d, 1/h, Y_1, \ldots, Y_r]/(P_1, \ldots, P_r)$
is a global complete intersection. After adjusting our choice of $h$
we may assume $E \subset A$ and we win.
\end{proof}






\section{Constructing flat ring maps}
\label{section-constructing-flat}

\noindent
The following lemma is occasionally useful.

\begin{lemma}
\label{lemma-flat-local-given-residue-field}
Let $(R, \mathfrak m, k)$ be a local ring. Let $k \subset K$ be a field
extension. There exists a local ring $(R', \mathfrak m', k')$, a flat local
ring map $R \to R'$ such that $\mathfrak m' = \mathfrak mR'$ and such that
$k \subset k'$ is isomorphic to $k \subset K$.
\end{lemma}

\begin{proof}
Suppose that $k \subset k' = k(\alpha)$ is a monogenic extension of fields.
Then $k'$ is the residue field of a flat local extension $R \subset R'$
as in the lemma. Namely, if $\alpha$ is transcendental over $k$, then we let
$R'$ be the localization of $R[x]$ at the prime $\mathfrak mR[x]$.
If $\alpha$ is algebraic with minimal polynomial
$T^d + \sum \overline{\lambda}_iT^{d - i}$, then we let
$R' = R[T]/(T^d + \sum \lambda_i T^{d - i})$.

\medskip\noindent
Consider the collection of triples $(k', R \to R', \phi)$, where
$k \subset k' \subset K$ is a subfield,
$R \to R'$ is a local ring map as in the lemma, and
$\phi : R' \to k'$ induces an isomorphism $R'/\mathfrak mR' \cong k'$
of $k$-extensions. These form a ``big'' category $\mathcal{C}$ with morphisms
$(k_1, R_1, \phi_1) \to (k_2, R_2, \phi_2)$
given by ring maps $\psi : R_1 \to R_2$ such that
$$
\xymatrix{
R_1 \ar[d]_\psi \ar[r]_{\phi_1} & k_1 \ar[r] & K \ar@{=}[d] \\
R_2 \ar[r]^{\phi_2} & k_2 \ar[r] & K
}
$$
commutes. This implies that $k_1 \subset k_2$.

\medskip\noindent
Suppose that $I$ is a directed set, and
$((R_i, k_i, \phi_i), \psi_{ii'})$ is a system over $I$, see
Categories, Section \ref{categories-section-posets-limits}.
In this case we can consider
$$
R' = \colim_{i \in I} R_i
$$
This is a local ring with maximal ideal $\mathfrak mR'$, and
residue field $k' = \bigcup_{i \in I} k_i$. Moreover, the ring
map $R \to R'$ is flat as it is a colimit of flat maps (and tensor
products commute with directed colimits).
Hence we see that $(R', k', \phi')$ is an ``upper bound'' for the system.

\medskip\noindent
An almost trivial application of Zorn's Lemma would finish the proof
if $\mathcal{C}$ was a set, but it isn't.
(Actually, you can make this work by finding a reasonable bound on the
cardinals of the local rings occurring.)
To get around this problem we choose a well ordering on $K$.
For $x \in K$ we let $K(x)$ be the subfield of $K$ generated
by all elements of $K$ which are $\leq x$.
By transfinite induction on $x \in K$ we will produce ring maps
$R \subset R(x)$ as in the lemma with residue field extension
$k \subset K(x)$. Moreover, by construction we will have that
$R(x)$ will contain $R(y)$ for all $y \leq x$.
Namely, if $x$ has a predecessor $x'$, then $K(x) = K(x')[x]$
and hence we can let $R(x') \subset R(x)$ be the local ring extension
constructed in the first paragraph of the proof. If $x$ does not
have a predecessor, then we first set
$R'(x) = \colim_{x' < x} R(x')$ as in the third paragraph
of the proof. The residue field of $R'(x)$ is $K'(x) = \bigcup_{x' < x} K(x')$.
Since $K(x) = K'(x)[x]$ we see that we can use the construction of the
first paragraph of the proof to produce $R'(x) \subset R(x)$.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-colimit-finite-etale-given-residue-field}
Let $(R, \mathfrak m, k)$ be a local ring. If $k \subset K$ is a
separable algebraic extension, then there exists a directed set $I$ and
a system of finite \'etale extensions $R \subset R_i$, $i \in I$
of local rings such that $R' = \colim R_i$ has residue field
$K$ (as extension of $k$).
\end{lemma}

\begin{proof}
Let $R \subset R'$ be the extension constructed in the proof of
Lemma \ref{lemma-flat-local-given-residue-field}. By construction
$R' = \colim_{\alpha \in A} R_\alpha$ where $A$ is a well-ordered
set and the transition maps $R_\alpha \to R_{\alpha + 1}$
are finite \'etale and $R_\alpha = \colim_{\beta < \alpha} R_\beta$
if $\alpha$ is not a successor. We will prove the result by transfinite
induction.

\medskip\noindent
Suppose the result holds for $R_\alpha$, i.e., $R_\alpha = \colim R_i$
with $R_i$ finite \'etale over $R$. Since
$R_\alpha \to R_{\alpha + 1}$ is finite \'etale
there exists an $i$ and a finite \'etale extension $R_i \to R_{i, 1}$
such that $R_{\alpha + 1} = R_\alpha \otimes_{R_i} R_{i, 1}$.
Thus $R_{\alpha + 1} = \colim_{i' \geq i} R_{i'} \otimes_{R_i} R_{i, 1}$
and the result holds for $\alpha + 1$. Suppose $\alpha$ is not a successor
and the result holds for $R_\beta$ for all $\beta < \alpha$.
Since every finite subset $E \subset R_\alpha$ is contained in $R_\beta$
for some $\beta < \alpha$ and we see that $E$ is contained in a finite \'etale
subextension by assumption. Thus the result holds for $R_\alpha$.
\end{proof}

\begin{lemma}
\label{lemma-finite-free-given-residue-field-extension}
Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime and
let $\kappa(\mathfrak p) \subset L$ be a finite extension of fields.
Then there exists a finite free ring map $R \to S$ such that
$\mathfrak q = \mathfrak pS$ is prime and
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is isomorphic to the given
extension $\kappa(\mathfrak p) \subset L$.
\end{lemma}

\begin{proof}
By induction of the degree of $\kappa(\mathfrak p) \subset L$.
If the degree is $1$, then we take $R = S$.
In general, if there exists a sub extension
$\kappa(\mathfrak p) \subset L' \subset L$ then we win by induction
on the degree (by first constructing $R \subset S'$ corresponding
to $L'/\kappa(\mathfrak p)$ and then construction $S' \subset S$
corresponding to $L/L'$). Thus we may assume that
$L \supset \kappa(\mathfrak p)$ is generated by a single element
$\alpha \in L$. Let $X^d + \sum_{i < d} a_iX^i$ be the minimal polynomial
of $\alpha$ over $\kappa(\mathfrak p)$, so $a_i \in \kappa(\mathfrak p)$.
We may write $a_i$ as the image
of $f_i/g$ for some $f_i, g \in R$ and $g \not \in \mathfrak p$.
After replacing $\alpha$ by $g\alpha$ (and correspondingly
replacing $a_i$ by $g^{d - i}a_i$) we may assume that $a_i$ is
the image of some $f_i \in R$.
Then we simply take $S = R[x]/(x^d + \sum f_ix^i)$.
\end{proof}







\section{The Cohen structure theorem}
\label{section-cohen-structure-theorem}

\noindent
Here is a fundamental notion in commutative algebra.

\begin{definition}
\label{definition-complete-local-ring}
Let $(R, \mathfrak m)$ be a local ring. We say $R$ is a
{\it complete local ring} if the canonical map
$$
R \longrightarrow \lim_n R/\mathfrak m^n
$$
to the completion of $R$ with respect to $\mathfrak m$ is an
isomorphism\footnote{This includes the condition
that $\bigcap \mathfrak m^n = (0)$; in some texts this may be indicated
by saying that $R$ is complete and separated. Warning: It can happen
that the completion $\lim_n R/\mathfrak m^n$ of a local ring is
non-complete, see
Examples, Lemma \ref{examples-lemma-noncomplete-completion}.
This does not happen when $\mathfrak m$ is finitely generated, see
Lemma \ref{lemma-hathat-finitely-generated} in which
case the completion is Noetherian, see
Lemma \ref{lemma-completion-Noetherian}.}.
\end{definition}

\noindent
Note that an Artinian local ring $R$ is a complete local ring
because $\mathfrak m_R^n = 0$ for some $n > 0$. In this section
we mostly focus on Noetherian complete local rings.

\begin{lemma}
\label{lemma-quotient-complete-local}
Let $R$ be a Noetherian complete local ring.
Any quotient of $R$ is also a Noetherian complete local ring.
Given a finite ring map $R \to S$, then $S$ is a product of
Noetherian complete local rings.
\end{lemma}

\begin{proof}
The ring $S$ is Noetherian by Lemma \ref{lemma-Noetherian-permanence}.
As an $R$-module $S$ is complete by Lemma \ref{lemma-completion-tensor}.
Hence $S$ is the product of the completions at its maximal ideals
by Lemma \ref{lemma-completion-finite-extension}.
\end{proof}

\begin{lemma}
\label{lemma-complete-local-ring-Noetherian}
Let $(R, \mathfrak m)$ be a complete local ring.
If $\mathfrak m$ is a finitely generated ideal then
$R$ is Noetherian.
\end{lemma}

\begin{proof}
See Lemma \ref{lemma-completion-Noetherian}.
\end{proof}

\begin{definition}
\label{definition-coefficient-ring}
Let $(R, \mathfrak m)$ be a complete local ring.
A subring $\Lambda \subset R$ is
called a {\it coefficient ring} if the following conditions hold:
\begin{enumerate}
\item $\Lambda$ is a complete local ring with maximal ideal
$\Lambda \cap \mathfrak m$,
\item the residue field of $\Lambda$ maps isomorphically to the
residue field of $R$, and
\item $\Lambda \cap \mathfrak m = p\Lambda$, where $p$ is the characteristic
of the residue field of $R$.
\end{enumerate}
\end{definition}

\noindent
Let us make some remarks on this definition. We split the discussion
into the following cases:
\begin{enumerate}
\item The local ring $R$ contains a field. This happens if
either $\mathbf{Q} \subset R$, or $pR = 0$ where $p$ is the
characteristic of $R/\mathfrak m$. In this case a coefficient ring
$\Lambda$ is a field contained in $R$ which maps isomorphically to
$R/\mathfrak m$.
\item The characteristic of $R/\mathfrak m$ is $p > 0$ but no
power of $p$ is zero in $R$. In this case $\Lambda$ is a complete
discrete valuation ring with uniformizer $p$ and residue field $R/\mathfrak m$.
\item The characteristic of $R/\mathfrak m$ is $p > 0$, and for some
$n > 1$ we have $p^{n - 1} \not = 0$, $p^n = 0$ in $R$. In this case
$\Lambda$ is an Artinian local ring whose maximal ideal is
generated by $p$ and which has residue field $R/\mathfrak m$.
\end{enumerate}
The complete discrete valuation rings with uniformizer $p$
above play a special role and we baptize them as follows.

\begin{definition}
\label{definition-cohen-ring}
A {\it Cohen ring} is a complete discrete valuation ring with
uniformizer $p$ a prime number.
\end{definition}

\begin{lemma}
\label{lemma-cohen-rings-exist}
Let $p$ be a prime number.
Let $k$ be a field of characteristic $p$.
There exists a Cohen ring $\Lambda$ with $\Lambda/p\Lambda \cong k$.
\end{lemma}

\begin{proof}
First note that the $p$-adic integers $\mathbf{Z}_p$ form a Cohen ring
for $\mathbf{F}_p$. Let $k$ be an arbitrary field of characteristic $p$.
Let $\mathbf{Z}_p \to R$ be a flat local ring map such that
$\mathfrak m_R = pR$ and $R/pR = k$, see
Lemma \ref{lemma-flat-local-given-residue-field}.
Then clearly $R$ is a discrete valuation ring. Hence its
completion is a Cohen ring for $k$.
\end{proof}

\begin{lemma}
\label{lemma-cohen-ring-formally-smooth}
Let $p > 0$ be a prime.
Let $\Lambda$ be a Cohen ring with residue field of characteristic $p$.
For every $n \geq 1$ the ring map
$$
\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda
$$
is formally smooth.
\end{lemma}

\begin{proof}
If $n = 1$, this follows from
Proposition \ref{proposition-characterize-separable-field-extensions}.
For general $n$ we argue by induction on $n$.
Namely, if $\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda$ is
formally smooth, then we can apply Lemma \ref{lemma-lift-formal-smoothness}
to the ring map
$\mathbf{Z}/p^{n + 1}\mathbf{Z} \to \Lambda/p^{n + 1}\Lambda$
and the ideal $I = (p^n) \subset \mathbf{Z}/p^{n + 1}\mathbf{Z}$.
\end{proof}

\begin{theorem}[Cohen structure theorem]
\label{theorem-cohen-structure-theorem}
Let $(R, \mathfrak m)$ be a complete local ring.
\begin{enumerate}
\item $R$ has a coefficient ring (see
Definition \ref{definition-coefficient-ring}),
\item if $\mathfrak m$ is a finitely generated ideal, then
$R$ is isomorphic to a quotient
$$
\Lambda[[x_1, \ldots, x_n]]/I
$$
where $\Lambda$ is either a field or a Cohen ring.
\end{enumerate}
\end{theorem}

\begin{proof}
Let us prove a coefficient ring exists.
First we prove this in case the characteristic of the residue field $\kappa$
is zero. Namely, in this case we will prove by induction
on $n > 0$ that there exists a section
$$
\varphi_n : \kappa \longrightarrow R/\mathfrak m^n
$$
to the canonical map $R/\mathfrak m^n \to \kappa = R/\mathfrak m$.
This is trivial for $n = 1$. If $n > 1$, let $\varphi_{n - 1}$ be given.
The field extension $\mathbf{Q} \subset \kappa$ is formally smooth by
Proposition \ref{proposition-characterize-separable-field-extensions}.
Hence we can find the dotted arrow
in the following diagram
$$
\xymatrix{
R/\mathfrak m^{n - 1} &
R/\mathfrak m^n \ar[l] \\
\kappa \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] & \mathbf{Q} \ar[l] \ar[u]
}
$$
This proves the induction step. Putting these maps together
$$
\lim_n\ \varphi_n : \kappa \longrightarrow
R = \lim_n\ R/\mathfrak m^n
$$
gives a map whose image is the desired coefficient ring.

\medskip\noindent
Next, we prove the existence of a coefficient ring in the case
where the characteristic of the residue field $\kappa$ is $p > 0$.
Namely, choose a Cohen ring $\Lambda$ with $\kappa = \Lambda/p\Lambda$,
see Lemma \ref{lemma-cohen-rings-exist}. In this case we will prove by
induction on $n > 0$ that there exists a map
$$
\varphi_n :
\Lambda/p^n\Lambda
\longrightarrow
R/\mathfrak m^n
$$
whose composition with the reduction map $R/\mathfrak m^n \to \kappa$
produces the given isomorphism $\Lambda/p\Lambda = \kappa$. This is trivial
for $n = 1$. If $n > 1$, let $\varphi_{n - 1}$ be given.
The ring map $\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda$
is formally smooth by Lemma \ref{lemma-cohen-ring-formally-smooth}.
Hence we can find the dotted arrow
in the following diagram
$$
\xymatrix{
R/\mathfrak m^{n - 1} &
R/\mathfrak m^n \ar[l] \\
\Lambda/p^n\Lambda \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] &
\mathbf{Z}/p^n\mathbf{Z} \ar[l] \ar[u]
}
$$
This proves the induction step. Putting these maps together
$$
\lim_n\ \varphi_n :
\Lambda = \lim_n\ \Lambda/p^n\Lambda
\longrightarrow
R = \lim_n\ R/\mathfrak m^n
$$
gives a map whose image is the desired coefficient ring.

\medskip\noindent
The final statement of the theorem follows readily. Namely, if
$y_1, \ldots, y_n$ are generators of the ideal $\mathfrak m$,
then we can use the map $\Lambda \to R$ just constructed
to get a map
$$
\Lambda[[x_1, \ldots, x_n]] \longrightarrow R,
\quad x_i \longmapsto y_i.
$$
Since both sides are $(x_1, \ldots, x_n)$-adically complete
this map is surjective by Lemma \ref{lemma-completion-generalities}
as it is surjective modulo $(x_1, \ldots, x_n)$ by
construction.
\end{proof}

\begin{remark}
\label{remark-Noetherian-complete-local-ring-universally-catenary}
If $k$ is a field then the power series ring $k[[X_1, \ldots, X_d]]$
is a Noetherian complete local regular ring of dimension $d$.
If $\Lambda$ is a Cohen ring then $\Lambda[[X_1, \ldots, X_d]]$
is a complete local Noetherian regular ring of dimension $d + 1$.
Hence the Cohen structure theorem implies that any Noetherian
complete local ring is a quotient of a regular local ring.
In particular we see that a Noetherian complete local ring is
universally catenary, see Lemma \ref{lemma-CM-ring-catenary}
and Lemma \ref{lemma-regular-ring-CM}.
\end{remark}

\begin{lemma}
\label{lemma-regular-complete-containing-coefficient-field}
Let $(R, \mathfrak m)$ be a Noetherian complete local ring.
Assume $R$ is regular.
\begin{enumerate}
\item If $R$ contains either $\mathbf{F}_p$ or $\mathbf{Q}$, then $R$
is isomorphic to a power series ring over its residue field.
\item If $k$ is a field and $k \to R$ is a ring map inducing
an isomorphism $k \to R/\mathfrak m$, then $R$ is isomorphic
as a $k$-algebra to a power series ring over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
In case (1), by the Cohen structure theorem
(Theorem \ref{theorem-cohen-structure-theorem})
there exists a coefficient ring which must be a field
mapping isomorphically to the residue field. Thus
it suffices to prove (2). In case (2) we pick
$f_1, \ldots, f_d \in \mathfrak m$ which
map to a basis of $\mathfrak m/\mathfrak m^2$ and we consider
the continuous $k$-algebra map $k[[x_1, \ldots, x_d]] \to R$
sending $x_i$ to $f_i$. As both source and target are
$(x_1, \ldots, x_d)$-adically complete, this map is surjective by
Lemma \ref{lemma-completion-generalities}. On the other hand, it
has to be injective because otherwise the dimension of
$R$ would be $< d$ by Lemma \ref{lemma-one-equation}.
\end{proof}

\begin{lemma}
\label{lemma-complete-local-Noetherian-domain-finite-over-regular}
Let $(R, \mathfrak m)$ be a Noetherian complete local domain.
Then there exists a $R_0 \subset R$ with the following properties
\begin{enumerate}
\item $R_0$ is a regular complete local ring,
\item $R_0 \subset R$ is finite and induces an isomorphism on
residue fields,
\item $R_0$ is either isomorphic to $k[[X_1, \ldots, X_d]]$ where $k$
is a field or $\Lambda[[X_1, \ldots, X_d]]$ where $\Lambda$ is a Cohen ring.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\Lambda$ be a coefficient ring of $R$.
Since $R$ is a domain we see that either $\Lambda$ is a field
or $\Lambda$ is a Cohen ring.

\medskip\noindent
Case I: $\Lambda = k$ is a field. Let $d = \dim(R)$.
Choose $x_1, \ldots, x_d \in \mathfrak m$
which generate an ideal of definition $I \subset R$.
(See Section \ref{section-dimension}.)
By Lemma \ref{lemma-change-ideal-completion} we see that $R$
is $I$-adically complete as well.
Consider the map $R_0 = k[[X_1, \ldots, X_d]] \to R$
which maps $X_i$ to $x_i$.
Note that $R_0$ is complete with respect to the ideal
$I_0 = (X_1, \ldots, X_d)$,
and that $R/I_0R \cong R/IR$ is finite over $k = R_0/I_0$
(because $\dim(R/I) = 0$, see Section \ref{section-dimension}.)
Hence we conclude that $R_0 \to R$ is finite by
Lemma \ref{lemma-finite-over-complete-ring}.
Since $\dim(R) = \dim(R_0)$ this implies that
$R_0 \to R$ is injective (see Lemma \ref{lemma-integral-dim-up}),
and the lemma is proved.

\medskip\noindent
Case II: $\Lambda$ is a Cohen ring. Let $d + 1 = \dim(R)$.
Let $p > 0$ be the characteristic of the residue field $k$.
As $R$ is a domain we see that $p$ is a nonzerodivisor in $R$.
Hence $\dim(R/pR) = d$, see Lemma \ref{lemma-one-equation}.
Choose $x_1, \ldots, x_d \in R$
which generate an ideal of definition in $R/pR$.
Then $I = (p, x_1, \ldots, x_d)$ is an ideal of definition of $R$.
By Lemma \ref{lemma-change-ideal-completion} we see that $R$
is $I$-adically complete as well.
Consider the map $R_0 = \Lambda[[X_1, \ldots, X_d]] \to R$
which maps $X_i$ to $x_i$.
Note that $R_0$ is complete with respect to the ideal
$I_0 = (p, X_1, \ldots, X_d)$,
and that $R/I_0R \cong R/IR$ is finite over $k = R_0/I_0$
(because $\dim(R/I) = 0$, see Section \ref{section-dimension}.)
Hence we conclude that $R_0 \to R$ is finite by
Lemma \ref{lemma-finite-over-complete-ring}.
Since $\dim(R) = \dim(R_0)$ this implies that
$R_0 \to R$ is injective (see Lemma \ref{lemma-integral-dim-up}),
and the lemma is proved.
\end{proof}





\section{Japanese rings}
\label{section-japanese}

\noindent
In this section we being to discuss finiteness of integral closure.

\begin{definition}
\label{definition-N}
Let $R$ be a domain with field of fractions $K$.
\begin{enumerate}
\item We say $R$ is {\it N-1} if the integral closure of $R$ in $K$
is a finite $R$-module.
\item We say $R$ is {\it N-2} or {\it Japanese} if for any finite
extension $K \subset L$ of fields the integral closure of $R$ in $L$
is finite over $R$.
\end{enumerate}
\end{definition}

\noindent
The main interest in these notions is for Noetherian rings,
but here is a non-Noetherian example.

\begin{example}
\label{example-Japanese-not-Noetherian}
Let $k$ be a field. The domain $R = k[x_1, x_2, x_3, \ldots]$ is N-2,
but not Noetherian. The reason is the following. Suppose that $R \subset L$
and the field $L$ is a finite extension of the fraction field of $R$.
Then there exists an integer $n$ such that $L$ comes from a finite
extension $k(x_1, \ldots, x_n) \subset L_0$ by adjoining
the (transcendental) elements $x_{n + 1}, x_{n + 2}$, etc.
Let $S_0$ be the integral
closure of $k[x_1, \ldots, x_n]$ in $L_0$. By
Proposition \ref{proposition-ubiquity-nagata} below
it is true that $S_0$ is finite over $k[x_1, \ldots, x_n]$.
Moreover, the integral closure of $R$ in $L$ is
$S = S_0[x_{n + 1}, x_{n + 2}, \ldots]$ (use
Lemma \ref{lemma-polynomial-domain-normal}) and
hence finite over $R$. The same argument works for
$R = \mathbf{Z}[x_1, x_2, x_3, \ldots]$.
\end{example}

\begin{lemma}
\label{lemma-localize-N}
Let $R$ be a domain.
If $R$ is N-1 then so is any localization of $R$.
Same for N-2.
\end{lemma}

\begin{proof}
These statements hold because taking integral closure commutes
with localization, see Lemma \ref{lemma-integral-closure-localize}.
\end{proof}

\begin{lemma}
\label{lemma-Japanese-local}
Let $R$ be a domain. Let $f_1, \ldots, f_n \in R$ generate the
unit ideal. If each domain $R_{f_i}$ is N-1 then so is $R$.
Same for N-2.
\end{lemma}

\begin{proof}
Assume $R_{f_i}$ is N-2 (or N-1).
Let $L$ be a finite extension of the fraction field of $R$ (equal to
the fraction field in the N-1 case). Let $S$ be the integral
closure of $R$ in $L$. By Lemma \ref{lemma-integral-closure-localize}
we see that $S_{f_i}$ is the integral closure of $R_{f_i}$ in $L$.
Hence $S_{f_i}$ is finite over $R_{f_i}$ by assumption.
Thus $S$ is finite over $R$ by Lemma \ref{lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-Noetherian-japanese}
Let $R$ be a domain.
Let $R \subset S$ be a quasi-finite extension of domains
(for example finite).
Assume $R$ is N-2 and Noetherian.
Then $S$ is N-2.
\end{lemma}

\begin{proof}
Let $K = f.f.(R) \subset L = f.f.(S)$. Note that this is
a finite field extension (for example by
Lemma \ref{lemma-isolated-point-fibre} (2)
applied to the fibre $S \otimes_R K$, and the definition of a
quasi-finite ring map).
Let $S'$ be the integral closure of $R$ in $S$.
Then $S'$ is contained in the integral closure of $R$ in $L$
which is finite over $R$ by assumption. As $R$ is Noetherian this
implies $S'$ is finite over $R$.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exist elements $g_1, \ldots, g_n \in S'$
such that $S'_{g_i} \cong S_{g_i}$ and such that $g_1, \ldots, g_n$
generate the unit ideal in $S$. Hence it suffices to show that
$S'$ is N-2 by Lemmas \ref{lemma-localize-N} and \ref{lemma-Japanese-local}.
Thus we have reduced to the case where $S$ is finite over $R$.

\medskip\noindent
Assume $R \subset S$ with hypotheses as in the lemma and moreover
that $S$ is finite over $R$. Let $M$ be a finite field extension
of the fraction field of $S$. Then $M$ is also a finite field extension
of $f.f(R)$ and we conclude that the integral closure $T$ of $R$ in
$M$ is finite over $R$. By Lemma \ref{lemma-integral-closure-transitive}
we see that $T$ is also the integral closure of $S$ in $M$ and we win by
Lemma \ref{lemma-integral-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Laurent-ring-N-1}
Let $R$ be a Noetherian domain.
If $R[z, z^{-1}]$ is N-1, then so is $R$.
\end{lemma}

\begin{proof}
Let $R'$ be the integral closure of $R$ in its field of fractions $K$.
Let $S'$ be the integral closure of $R[z, z^{-1}]$ in its field of fractions.
Clearly $R' \subset S'$.
Since $K[z, z^{-1}]$ is a normal domain we see that $S' \subset K[z, z^{-1}]$.
Suppose that $f_1, \ldots, f_n \in S'$ generate $S'$ as $R[z, z^{-1}]$-module.
Say $f_i = \sum a_{ij}z^j$ (finite sum), with $a_{ij} \in K$.
For any $x \in R'$ we can write
$$
x = \sum h_i f_i
$$
with $h_i \in R[z, z^{-1}]$. Thus we see that $R'$ is contained in the
finite $R$-submodule $\sum Ra_{ij} \subset K$. Since $R$ is Noetherian
we conclude that $R'$ is a finite $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-finite-extension-N-2}
Let $R$ be a Noetherian domain, and let $R \subset S$ be a
finite extension of domains. If $S$ is N-1, then so is $R$.
If $S$ is N-2, then so is $R$.
\end{lemma}

\begin{proof}
Omitted. (Hint: Integral closures of $R$ in extension fields
are contained in integral closures of $S$ in extension fields.)
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-normal-domain-finite-separable-extension}
Let $R$ be a Noetherian normal domain with fraction field $K$.
Let $K \subset L$ be a finite separable field extension.
Then the integral closure of $R$ in $L$ is finite over $R$.
\end{lemma}

\begin{proof}
Consider the trace pairing
(Fields, Definition \ref{fields-definition-trace-pairing})
$$
L \times L \longrightarrow K,
\quad (x, y) \longmapsto \langle x, y\rangle := \text{Trace}_{L/K}(xy).
$$
Since $L/K$ is separable this is nondegenerate
(Fields, Lemma \ref{fields-lemma-separable-trace-pairing}).
Moreover, if $x \in L$ is integral over $R$, then
$\text{Trace}_{L/K}(x)$ is in $R$. This is true because the
minimal polynomial of $x$ over $K$ has coefficients in $R$
(Lemma \ref{lemma-minimal-polynomial-normal-domain})
and because $\text{Trace}_{L/K}(x)$ is an
integer multiple of one of these coefficients
(Fields, Lemma \ref{fields-lemma-trace-and-norm-from-minimal-polynomial}).
Pick $x_1, \ldots, x_n \in L$ which are integral over $R$
and which form a $K$-basis of $L$. Then the integral closure
$S \subset L$ is contained in the $R$-module
$$
M = \{y \in L \mid \langle x_i, y\rangle \in R, \ i = 1, \ldots, n\}
$$
By linear algebra we see that $M \cong R^{\oplus n}$ as an $R$-module.
Hence $S \subset R^{\oplus n}$ is a finitely generated $R$-module
as $R$ is Noetherian.
\end{proof}

\begin{example}
\label{example-bad-invariants}
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
does not work if the ring is not Noetherian.
For example consider the action of $G = \{+1, -1\}$ on
$A = \mathbf{C}[x_1, x_2, x_3, \ldots]$ where $-1$ acts by
mapping $x_i$ to $-x_i$. The invariant ring $R = A^G$ is
the $\mathbf{C}$-algebra generated by all $x_ix_j$. Hence
$R \subset A$ is not finite. But $R$ is a normal domain
with fraction field $K = L^G$ the $G$-invariants in the fraction field
$L$ of $A$. And clearly $A$ is the integral closure of $R$ in
$L$.
\end{example}

\noindent
The following lemma can sometimes be used as a substitute for
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
in case of purely inseparable extensions.

\begin{lemma}
\label{lemma-Noetherian-normal-domain-insep-extension}
Let $R$ be a Noetherian normal domain with fraction field $K$
of characteristic $p > 0$.
Let $a \in K$ be an element such that there exists a derivation
$D : R \to R$ with $D(a) \not = 0$. Then the integral closure
of $R$ in $L = K[x]/(x^p - a)$ is finite over $R$.
\end{lemma}

\begin{proof}
After replacing $x$ by $fx$ and $a$ by $f^pa$ for some $f \in R$
we may assume $a \in R$. Hence also $D(a) \in R$. We will show
by induction on $i \leq p - 1$ that if
$$
y = a_0 + a_1x + \ldots + a_i x^i,\quad a_j \in K
$$
is integral over $R$, then $D(a)^i a_j \in R$. Thus the integral
closure is contained in the finite $R$-module with basis
$D(a)^{-p + 1}x^j$, $j = 0, \ldots, p - 1$. Since $R$ is Noetherian
this proves the lemma.

\medskip\noindent
If $i = 0$, then $y = a_0$ is integral over $R$ if and only if $a_0 \in R$
and the statement is true. Suppose the statement holds for some $i < p - 1$
and suppose that
$$
y = a_0 + a_1x + \ldots + a_{i + 1} x^{i + 1},\quad a_j \in K
$$
is integral over $R$. Then
$$
y^p = a_0^p + a_1^p a + \ldots + a_{i + 1}^pa^{i + 1}
$$
is an element of $R$ (as it is in $K$ and integral over $R$). Applying
$D$ we obtain
$$
(a_1^p + 2a_2^p a + \ldots + (i + 1)a_{i + 1}^p a^i)D(a)
$$
is in $R$. Hence it follows that
$$
D(a)a_1 + 2D(a) a_2 x + \ldots + (i + 1)D(a) a_{i + 1} x^i
$$
is integral over $R$. By induction we find $D(a)^{i + 1}a_j \in R$
for $j = 1, \ldots, i + 1$. (Here we use that $1, \ldots, i + 1$
are invertible.) Hence $D(a)^{i + 1}a_0$ is also in $R$ because it
is the difference of $y$ and $\sum_{j > 0} D(a)^{i + 1}a_jx^j$ which
are integral over $R$ (since $x$ is integral over $R$ as $a \in R$).
\end{proof}

\begin{lemma}
\label{lemma-domain-char-zero-N-1-2}
A Noetherian domain of characteristic zero is N-1 if and only if
it is N-2 (i.e., Japanese).
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
since every field extension in characteristic zero is separable.
\end{proof}

\begin{lemma}
\label{lemma-domain-char-p-N-1-2}
Let $R$ be a Noetherian domain with fraction field $K$ of
characteristic $p > 0$. Then $R$ is N-2 if and only if
for every finite purely inseparable extension $K \subset L$ the integral
closure of $R$ in $L$ is finite over $R$.
\end{lemma}

\begin{proof}
Assume the integral closure of $R$ in every finite purely inseparable
field extension of $K$ is finite.
Let $K \subset L$ be any finite extension. We have to show the
integral closure of $R$ in $L$ is finite over $R$.
Choose a finite normal field extension $K \subset M$
containing $L$. As $R$ is Noetherian it suffices to show that
the integral closure of $R$ in $M$ is finite over $R$.
By Fields, Lemma \ref{fields-lemma-normal-case}
there exists a subextension $K \subset M_{insep} \subset M$
such that $M_{insep}/K$ is purely inseparable, and $M/M_{insep}$
is separable. By assumption the integral closure $R'$ of $R$ in
$M_{insep}$ is finite over $R$. By
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
the integral
closure $R''$ of $R'$ in $M$ is finite over $R'$. Then $R''$ is finite
over $R$ by Lemma \ref{lemma-finite-transitive}.
Since $R''$ is also the integral closure
of $R$ in $M$ (see Lemma \ref{lemma-integral-closure-transitive}) we win.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-N-2}
Let $R$ be a Noetherian domain.
If $R$ is N-1 then $R[x]$ is N-1.
If $R$ is N-2 then $R[x]$ is N-2.
\end{lemma}

\begin{proof}
Assume $R$ is N-1. Let $R'$ be the integral closure of $R$
which is finite over $R$. Hence also $R'[x]$ is finite over
$R[x]$. The ring $R'[x]$ is normal (see
Lemma \ref{lemma-polynomial-domain-normal}), hence N-1.
This proves the first assertion.

\medskip\noindent
For the second assertion, by Lemma \ref{lemma-finite-extension-N-2}
it suffices to show that $R'[x]$ is N-2. In other words we may
and do assume that $R$ is a normal N-2 domain. In characteristic zero
we are done by Lemma \ref{lemma-domain-char-zero-N-1-2}.
In characteristic $p > 0$ we have to show that the integral
closure of $R[x]$ is finite in any finite purely inseparable extension
of $f.f.(R[x]) = K(x) \subset L$ with $K = f.f.(R)$. Clearly there
exists a finite purely inseparable field extension $K \subset L'$
and $q = p^e$ such that $L \subset L'(x^{1/q})$. As $R[x]$ is
Noetherian it suffices to show that the integral closure of $R[x]$
in $L'(x^{1/q})$ is finite over $R[x]$. And this integral closure
is equal to $R'[x^{1/q}]$ with $R \subset R' \subset L'$ the integral
closure of $R$ in $L'$.
Since $R$ is N-2 we see that $R'$ is finite over $R$ and hence
$R'[x^{1/q}]$ is finite over $R[x]$.
\end{proof}

\begin{lemma}
\label{lemma-openness-normal-locus}
Let $R$ be a Noetherian domain.
If there exists an $f \in R$ such that $R_f$ is normal
then
$$
U = \{\mathfrak p \in \Spec(R) \mid R_{\mathfrak p} \text{ is normal}\}
$$
is open in $\Spec(R)$.
\end{lemma}

\begin{proof}
It is clear that the standard open $D(f)$ is contained in $U$.
By Serre's criterion Lemma \ref{lemma-criterion-normal} we see that
$\mathfrak p \not \in U$ implies that for some
$\mathfrak q \subset \mathfrak p$ we have
either
\begin{enumerate}
\item Case I: $\text{depth}(R_{\mathfrak q}) < 2$
and $\dim(R_{\mathfrak q}) \geq 2$, and
\item Case II: $R_{\mathfrak q}$ is not regular
and $\dim(R_{\mathfrak q}) = 1$.
\end{enumerate}
This in particular also means that $R_{\mathfrak q}$ is not
normal, and hence $f \in \mathfrak q$. In case I we see that
$\text{depth}(R_{\mathfrak q}) =
\text{depth}(R_{\mathfrak q}/fR_{\mathfrak q}) + 1$.
Hence such a prime $\mathfrak q$ is the same thing as an embedded
associated prime of $R/fR$. In case II $\mathfrak q$ is an associated
prime of $R/fR$ of height 1. Thus there is a finite set $E$
of such primes $\mathfrak q$ (see Lemma \ref{lemma-finite-ass}) and
$$
\Spec(R) \setminus U
=
\bigcup\nolimits_{\mathfrak q \in E} V(\mathfrak q)
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-N-1}
Let $R$ be a Noetherian domain.
Assume
\begin{enumerate}
\item there exists a nonzero $f \in R$ such that $R_f$ is normal, and
\item for every maximal ideal $\mathfrak m \subset R$
the local ring $R_{\mathfrak m}$ is N-1.
\end{enumerate}
Then $R$ is N-1.
\end{lemma}

\begin{proof}
Set $K = f.f.(R)$. Suppose that $R \subset R' \subset K$ is a finite
extension of $R$ contained in $K$. Note that $R_f = R'_f$ since
$R_f$ is already normal. Hence by Lemma \ref{lemma-openness-normal-locus}
the set of primes
$\mathfrak p' \in \Spec(R')$ with $R'_{\mathfrak p'}$ non-normal
is closed in $\Spec(R')$. Since $\Spec(R') \to \Spec(R)$
is closed the image of this set is closed in $\Spec(R)$.
For such a ring $R'$ denote $Z_{R'} \subset \Spec(R)$ this image.

\medskip\noindent
Pick a maximal ideal $\mathfrak m \subset R$.
Let $R_{\mathfrak m} \subset R_{\mathfrak m}'$ be the integral
closure of the local ring in $K$. By assumption this is
a finite ring extension. By Lemma \ref{lemma-integral-closure-localize}
we can find finitely
many elements $r_1, \ldots, r_n \in K$ integral over $R$ such that
$R_{\mathfrak m}'$ is generated by $r_1, \ldots, r_n$ over $R_{\mathfrak m}$.
Let $R' = R[x_1, \ldots, x_n] \subset K$. With this choice it is clear
that $\mathfrak m \not \in Z_{R'}$.

\medskip\noindent
As $\Spec(R)$ is quasi-compact, the above shows that we can
find a finite collection $R \subset R'_i \subset K$ such that
$\bigcap Z_{R'_i} = \emptyset$. Let $R'$ be the subring of $K$
generated by all of these. It is finite over $R$. Also $Z_{R'} = \emptyset$.
Namely, every prime $\mathfrak p'$ lies over a prime $\mathfrak p'_i$
such that $(R'_i)_{\mathfrak p'_i}$ is normal. This implies
that $R'_{\mathfrak p'} = (R'_i)_{\mathfrak p'_i}$ is normal too.
Hence $R'$ is normal, in other words
$R'$ is the integral closure of $R$ in $K$.
\end{proof}

\begin{lemma}[Tate]
\label{lemma-tate-japanese}
Let $R$ be a ring.
Let $x \in R$.
Assume
\begin{enumerate}
\item $R$ is a normal Noetherian domain,
\item $R/xR$ is a domain and N-2,
\item $R \cong \lim_n R/x^nR$ is complete with respect to $x$.
\end{enumerate}
Then $R$ is N-2.
\end{lemma}

\begin{proof}
We may assume $x \not = 0$ since otherwise the lemma is trivial.
Let $K$ be the fraction field of $R$. If the characteristic of $K$
is zero the lemma follows from (1), see
Lemma \ref{lemma-domain-char-zero-N-1-2}. Hence we may assume
that the characteristic of $K$ is $p > 0$, and we may apply
Lemma \ref{lemma-domain-char-p-N-1-2}. Thus given $K \subset L$
be a finite purely inseparable field extension we have to show
that the integral closure $S$ of $R$ in $L$ is finite over $R$.

\medskip\noindent
Let $q$ be a power of $p$ such that $L^q \subset K$.
By enlarging $L$ if necessary we may assume there exists
an element $y \in L$ such that $y^q = x$. Since $R \to S$
induces a homeomorphism of spectra (see Lemma \ref{lemma-p-ring-map})
there is a unique prime ideal $\mathfrak q \subset S$ lying
over the prime ideal $\mathfrak p = xR$. It is clear that
$$
\mathfrak q = \{f \in S \mid f^q \in \mathfrak p\} = yS
$$
since $y^q = x$. Hence $R_{\mathfrak p}$ and $S_{\mathfrak q}$
are discrete valuation rings, see Lemma \ref{lemma-characterize-dvr}.
By Lemma \ref{lemma-finite-extension-residue-fields-dimension-1} we
see that $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is
a finite field extension. Hence the integral closure
$S' \subset \kappa(\mathfrak q)$ of $R/xR$ is finite over
$R/xR$ by assumption (2). Since $S/yS \subset S'$ this implies
that $S/yS$ is finite over $R$. Note that $S/y^nS$ has a finite
filtration whose subquotients are the modules
$y^iS/y^{i + 1}S \cong S/yS$. Hence we see that each $S/y^nS$
is finite over $R$. In particular $S/xS$ is finite over $R$.
Also, it is clear that $\bigcap x^nS = (0)$ since an element
in the intersection has $q$th power contained in $\bigcap x^nR = (0)$
(Lemma \ref{lemma-intersect-powers-ideal-module-zero}).
Thus we may apply Lemma \ref{lemma-finite-over-complete-ring} to conclude
that $S$ is finite over $R$, and we win.
\end{proof}

\begin{lemma}
\label{lemma-power-series-over-N-2}
Let $R$ be a ring.
If $R$ is Noetherian, a domain, and N-2, then so is $R[[x]]$.
\end{lemma}

\begin{proof}
Observe that $R[[x]]$ is Noetherian by
Lemma \ref{lemma-Noetherian-power-series}.
Let $R' \supset R$ be the integral closure of $R$ in its fraction
field. Because $R$ is N-2 this is finite over $R$. Hence $R'[[x]]$
is finite over $R[[x]]$. By
Lemma \ref{lemma-power-series-over-Noetherian-normal-domain}
we see that $R'[[x]]$ is a normal domain.
Apply Lemma \ref{lemma-tate-japanese} to the
element $x \in R'[[x]]$ to see that $R'[[x]]$ is N-2. Then
Lemma \ref{lemma-finite-extension-N-2} shows that $R[[x]]$ is N-2.
\end{proof}





\section{Nagata rings}
\label{section-nagata}

\noindent
Here is the definition.

\begin{definition}
\label{definition-nagata}
Let $R$ be a ring.
\begin{enumerate}
\item We say $R$ is {\it universally Japanese} if for any finite
type ring map $R \to S$ with $S$ a domain we have that $S$ is N-2
(i.e., Japanese).
\item We say that $R$ is a {\it Nagata ring} if $R$ is Noetherian and
for every prime ideal $\mathfrak p$ the ring $R/\mathfrak p$ is N-2.
\end{enumerate}
\end{definition}

\noindent
It is clear that a Noetherian universally Japanese ring is a Nagata ring.
It is our goal to show that a Nagata ring is universally Japanese. This is
not obvious at all, and requires some work. But first, here is a useful
lemma.

\begin{lemma}
\label{lemma-nagata-in-reduced-finite-type-finite-integral-closure}
Let $R$ be a Nagata ring.
Let $R \to S$ be essentially of finite type with $S$ reduced.
Then the integral closure of $R$ in $S$ is finite over $R$.
\end{lemma}

\begin{proof}
As $S$ is essentially of finite type over $R$ it is Noetherian and
has finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_m$,
see Lemma \ref{lemma-Noetherian-irreducible-components}.
Since $S$ is reduced we have $S \subset \prod S_{\mathfrak q_i}$
and each $S_{\mathfrak q_i} = K_i$ is a field, see
Lemmas \ref{lemma-total-ring-fractions-no-embedded-points}
and \ref{lemma-minimal-prime-reduced-ring}.
It suffices to show that the integral closure
$A_i'$ of $R$ in each $K_i$ is finite over $R$.
This is true because $R$ is Noetherian and $A \subset \prod A_i'$.
Let $\mathfrak p_i \subset R$ be the prime of $R$
corresponding to $\mathfrak q_i$.
As $S$ is essentially of finite type over $R$ we see that
$K_i = S_{\mathfrak q_i} = \kappa(\mathfrak q_i)$ is a finitely
generated field extension of $\kappa(\mathfrak p_i)$. Hence the algebraic
closure $L_i$ of $\kappa(\mathfrak p_i)$ in $\subset K_i$
is finite over $\kappa(\mathfrak p_i)$, see
Fields, Lemma \ref{fields-lemma-algebraic-closure-in-finitely-generated}.
It is clear that $A_i'$ is the integral closure of $R/\mathfrak p_i$
in $L_i$, and hence we win by definition of a Nagata ring.
\end{proof}

\begin{lemma}
\label{lemma-check-universally-japanese}
Let $R$ be a ring.
To check that $R$ is universally Japanese it suffices to show:
If $R \to S$ is of finite type, and $S$ a domain then $S$ is N-1.
\end{lemma}

\begin{proof}
Namely, assume the condition of the lemma.
Let $R \to S$ be a finite type ring map with $S$ a domain.
Let $f.f.(S) \subset L$ be a finite extension of its fraction field.
Then there exists a finite ring extension $S \subset S' \subset L$
with $f.f.(S') = L$. By assumption $S'$ is N-1, and hence the integral
closure $S''$ of $S'$ in $L$ is finite over $S'$. Thus $S''$ is finite
over $S$ (Lemma \ref{lemma-finite-transitive})
and $S''$ is the integral closure of $S$ in $L$
(Lemma \ref{lemma-integral-closure-transitive}).
We conclude that $R$ is universally Japanese.
\end{proof}

\begin{lemma}
\label{lemma-universally-japanese}
If $R$ is universally Japanese then any algebra essentially of finite type
over $R$ is universally Japanese.
\end{lemma}

\begin{proof}
The case of an algebra of finite type over $R$ is immediate from
the definition. The general case follows on applying
Lemma \ref{lemma-localize-N}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-nagata}
Let $R$ be a Nagata ring.
If $R \to S$ is a quasi-finite ring map (for example finite)
then $S$ is a Nagata ring also.
\end{lemma}

\begin{proof}
First note that $S$ is Noetherian as $R$ is Noetherian and a quasi-finite
ring map is of finite type.
Let $\mathfrak q \subset S$ be a prime ideal, and set
$\mathfrak p = R \cap \mathfrak q$. Then
$R/\mathfrak p \subset S/\mathfrak q$ is quasi-finite and
hence we conclude that $S/\mathfrak q$ is N-2 by
Lemma \ref{lemma-quasi-finite-over-Noetherian-japanese}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-nagata-localize}
A localization of a Nagata ring is a Nagata ring.
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-localize-N}.
\end{proof}

\begin{lemma}
\label{lemma-nagata-local}
Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ generate the
unit ideal.
\begin{enumerate}
\item  If each $R_{f_i}$ is universally Japanese then so is $R$.
\item  If each $R_{f_i}$ is Nagata then so is $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\varphi : R \to S$ be a finite type ring map so that $S$ is a domain.
Then $\varphi(f_1), \ldots, \varphi(f_n)$ generate the unit ideal
in $S$. Hence if each $S_{f_i} = S_{\varphi(f_i)}$ is N-1 then so is
$S$, see Lemma \ref{lemma-Japanese-local}. This proves (1).

\medskip\noindent
If each $R_{f_i}$ is Nagata, then each $R_{f_i}$ is Noetherian and
hence $R$ is Noetherian, see Lemma \ref{lemma-cover}. And if
$\mathfrak p \subset R$ is a prime, then we see each
$R_{f_i}/\mathfrak pR_{f_i} = (R/\mathfrak p)_{f_i}$ is N-2
and hence we conclude $R/\mathfrak p$ is N-2 by
Lemma \ref{lemma-Japanese-local}. This proves (2).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-complete-local-Nagata}
A Noetherian complete local ring is a Nagata ring.
\end{lemma}

\begin{proof}
Let $R$ be a complete local Noetherian ring.
Let $\mathfrak p \subset R$ be a prime.
Then $R/\mathfrak p$ is also a complete local Noetherian ring,
see Lemma \ref{lemma-quotient-complete-local}.
Hence it suffices to show that a Noetherian complete local
domain $R$ is N-2. By
Lemmas \ref{lemma-quasi-finite-over-Noetherian-japanese}
and \ref{lemma-complete-local-Noetherian-domain-finite-over-regular}
we reduce to the case $R = k[[X_1, \ldots, X_d]]$ where $k$ is a field or
$R = \Lambda[[X_1, \ldots, X_d]]$ where $\Lambda$ is a Cohen ring.

\medskip\noindent
In the case $k[[X_1, \ldots, X_d]]$ we reduce to the statement that a
field is N-2 by Lemma \ref{lemma-power-series-over-N-2}. This is clear.
In the case $\Lambda[[X_1, \ldots, X_d]]$ we reduce to the statement
that a Cohen ring $\Lambda$ is N-2. Applying Lemma \ref{lemma-tate-japanese}
once more with $x = p \in \Lambda$ we reduce yet again to the case
of a field. Thus we win.
\end{proof}

\begin{definition}
\label{definition-analytically-unramified}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
We say $R$ is {\it analytically unramified} if its completion
$R^\wedge = \lim_n R/\mathfrak m^n$ is reduced.
A prime ideal $\mathfrak p \subset R$ is said to be
{\it analytically unramified} if $R/\mathfrak p$ is analytically
unramified.
\end{definition}

\noindent
At this point we know
the following are true for any Noetherian local ring $R$:
The map $R \to R^\wedge$ is a faithfully flat local ring homomorphism
(Lemma \ref{lemma-completion-faithfully-flat}).
The completion $R^\wedge$ is Noetherian
(Lemma \ref{lemma-completion-Noetherian})
and complete (Lemma \ref{lemma-completion-complete}).
Hence the completion $R^\wedge$ is a Nagata ring
(Lemma \ref{lemma-Noetherian-complete-local-Nagata}).
Moreover, we have seen in Section \ref{section-cohen-structure-theorem}
that $R^\wedge$ is
a quotient of a regular local ring
(Theorem \ref{theorem-cohen-structure-theorem}), and hence
universally catenary
(Remark \ref{remark-Noetherian-complete-local-ring-universally-catenary}).

\begin{lemma}
\label{lemma-analytically-unramified-easy}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item If $R$ is analytically unramified, then $R$ is reduced.
\item If $R$ is analytically unramified, then each minimal prime of
$R$ is analytically unramified.
\item If $R$ is reduced with minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$
is analytically unramified, then $R$ is analytically unramified.
\item If $R$ is analytically unramified, then the integral closure
of $R$ in its total ring of fractions $Q(R)$ is finite over $R$.
\item If $R$ is a domain and analytically unramified, then $R$ is N-1.
\end{enumerate}
\end{lemma}

\begin{proof}
In this proof we will use the remarks immediately following
Definition \ref{definition-analytically-unramified}.
As $R \to R^\wedge$ is a faithfully flat local ring homomorphism
it is injective and (1) follows.

\medskip\noindent
Let $\mathfrak q$ be a minimal prime of $R$, and assume $R$ is
analytically unramified.
Then $\mathfrak q$ is an associated
prime of $R$ (see
Proposition \ref{proposition-minimal-primes-associated-primes}).
Hence there exists an $f \in R$
such that $\{x \in R \mid fx = 0\} = \mathfrak q$.
Note that $(R/\mathfrak q)^\wedge = R^\wedge/\mathfrak q^\wedge$,
and that $\{x \in R^\wedge \mid fx = 0\} = \mathfrak q^\wedge$,
because completion is exact (Lemma \ref{lemma-completion-flat}).
If $x \in R^\wedge$ is such
that $x^2 \in \mathfrak q^\wedge$, then $fx^2 = 0$ hence
$(fx)^2 = 0$ hence $fx = 0$ hence $x \in \mathfrak q^\wedge$.
Thus $\mathfrak q$ is analytically unramified and (2) holds.

\medskip\noindent
Assume $R$ is reduced with minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$
is analytically unramified. Then
$R \to R/\mathfrak q_1 \times \ldots \times R/\mathfrak q_t$ is
injective. Since completion is exact (see Lemma \ref{lemma-completion-flat})
we see that
$R^\wedge \subset (R/\mathfrak q_1)^\wedge \times \ldots \times
(R/\mathfrak q_t)^\wedge$. Hence (3) is clear.

\medskip\noindent
Assume $R$ is analytically unramified.
Let $\mathfrak p_1, \ldots, \mathfrak p_s$ be the minimal primes
of $R^\wedge$. Then we see that
$$
Q(R^\wedge) =
R^\wedge_{\mathfrak p_1} \times \ldots \times R^\wedge_{\mathfrak p_s}
$$
with each $R^\wedge_{\mathfrak p_i}$ a field
as $R^\wedge$ is reduced (see
Lemma \ref{lemma-total-ring-fractions-no-embedded-points}).
Hence the integral closure $S$ of $R^\wedge$
in $Q(R^\wedge)$ is equal to $S = S_1 \times \ldots \times S_s$ with
$S_i$ the integral closure of $R^\wedge/\mathfrak p_i$ in its fraction
field. In particular $S$ is finite over $R^\wedge$.
Denote $R'$ the integral closure of $R$ in $Q(R)$.
As $R \to R^\wedge$ is flat we see that
$R' \otimes_R R^\wedge \subset Q(R) \otimes_R R^\wedge \subset Q(R^\wedge)$.
Moreover $R' \otimes_R R^\wedge$ is integral over $R^\wedge$
(Lemma \ref{lemma-base-change-integral}).
Hence $R' \otimes_R R^\wedge \subset S$ is a $R^\wedge$-submodule.
As $R^\wedge$ is Noetherian it is a finite $R^\wedge$-module.
Thus we may find $f_1, \ldots, f_n \in R'$ such that
$R' \otimes_R R^\wedge$ is generated by the elements $f_i \otimes 1$
as a $R^\wedge$-module.
By faithful flatness we see that $R'$ is generated by $f_1, \ldots, f_n$
as an $R$-module. This proves (4).

\medskip\noindent
Part (5) is a special case of part (4).
\end{proof}

\begin{lemma}
\label{lemma-codimension-1-analytically-unramified}
Let $R$ be a Noetherian local ring.
Let $\mathfrak p \subset R$ be a prime.
Assume
\begin{enumerate}
\item $R_{\mathfrak p}$ is a discrete valuation ring, and
\item $\mathfrak p$ is analytically unramified.
\end{enumerate}
Then for any associated prime $\mathfrak q$ of $R^\wedge/\mathfrak pR^\wedge$
the local ring $(R^\wedge)_{\mathfrak q}$ is a discrete valuation ring.
\end{lemma}

\begin{proof}
Assumption (2) says that $R^\wedge/\mathfrak pR^\wedge$ is a reduced ring.
Hence an associated prime $\mathfrak q \subset R^\wedge$
of $R^\wedge/\mathfrak pR^\wedge$
is the same thing as a minimal prime over $\mathfrak pR^\wedge$.
In particular we see that the maximal ideal of $(R^\wedge)_{\mathfrak q}$
is $\mathfrak p(R^\wedge)_{\mathfrak q}$.
Choose $x \in R$ such that $xR_{\mathfrak p} = \mathfrak pR_{\mathfrak p}$.
By the above we see that $x \in (R^\wedge)_{\mathfrak q}$ generates
the maximal ideal. As $R \to R^\wedge$ is faithfully flat we see that
$x$ is a nonzerodivisor in $(R^\wedge)_{\mathfrak q}$.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-criterion-analytically-unramified}
Let $(R, \mathfrak m)$ be a Noetherian local domain.
Let $x \in \mathfrak m$. Assume
\begin{enumerate}
\item $x \not = 0$,
\item $R/xR$ has no embedded primes, and
\item for each associated prime $\mathfrak p \subset R$
of $R/xR$ we have
\begin{enumerate}
\item the local ring $R_{\mathfrak p}$ is regular, and
\item $\mathfrak p$ is analytically unramified.
\end{enumerate}
\end{enumerate}
Then $R$ is analytically unramified.
\end{lemma}

\begin{proof}
Let $\mathfrak p_1, \ldots, \mathfrak p_t$ be the associated primes
of the $R$-module $R/xR$. Since $R/xR$ has no embedded primes we
see that each $\mathfrak p_i$ has height $1$, and is a minimal
prime over $(x)$.
For each $i$, let $\mathfrak q_{i1}, \ldots, \mathfrak q_{is_i}$
be the associated primes of the $R^\wedge$-module
$R^\wedge/\mathfrak p_iR^\wedge$.
By Lemma \ref{lemma-codimension-1-analytically-unramified}
we see that $(R^\wedge)_{\mathfrak q_{ij}}$ is regular.
By Lemma \ref{lemma-bourbaki} we see that
$$
\text{Ass}_{R^\wedge}(R^\wedge/xR^\wedge)
=
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(R/xR)}
\text{Ass}_{R^\wedge}(R^\wedge/\mathfrak pR^\wedge)
=
\{\mathfrak q_{ij}\}.
$$
Let $y \in R^\wedge$ with $y^2 = 0$.
As $(R^\wedge)_{\mathfrak q_{ij}}$ is regular, and hence a domain
(Lemma \ref{lemma-regular-domain})
we see that $y$ maps to zero in $(R^\wedge)_{\mathfrak q_{ij}}$.
Hence $y$ maps to zero in $R^\wedge/xR^\wedge$ by
Lemma \ref{lemma-zero-at-ass-zero}.
Hence $y = xy'$. Since $x$ is a nonzerodivisor (as $R \to R^\wedge$ is flat)
we see that $(y')^2 = 0$. Hence we conclude that
$y \in \bigcap x^nR^\wedge = (0)$
(Lemma \ref{lemma-intersect-powers-ideal-module-zero}).
\end{proof}

\begin{lemma}
\label{lemma-local-nagata-domain-analytically-unramified}
Let $(R, \mathfrak m)$ be a local ring.
If $R$ is Noetherian, a domain, and Nagata, then $R$ is
analytically unramified.
\end{lemma}

\begin{proof}
By induction on $\dim(R)$.
The case $\dim(R) = 0$ is trivial. Hence we assume $\dim(R) = d$ and that
the lemma holds for all Noetherian Nagata domains of dimension $< d$.

\medskip\noindent
Let $R \subset S$ be the integral closure
of $R$ in the field of fractions of $R$. By assumption $S$ is a finite
$R$-module. By Lemma \ref{lemma-quasi-finite-over-nagata} we see that
$S$ is Nagata. By Lemma \ref{lemma-integral-sub-dim-equal} we see
$\dim(R) = \dim(S)$.
Let $\mathfrak m_1, \ldots, \mathfrak m_t$ be the maximal
ideals of $S$. Each of these lies over the maximal ideal $\mathfrak m$
of $R$. Moreover
$$
(\mathfrak m_1 \cap \ldots \cap \mathfrak m_t)^n \subset \mathfrak mS
$$
for sufficiently large $n$ as $S/\mathfrak mS$ is Artinian.
By Lemma \ref{lemma-completion-flat} $R^\wedge \to S^\wedge$
is an injective map, and by the Chinese Remainder
Lemma \ref{lemma-chinese-remainder} combined with
Lemma \ref{lemma-change-ideal-completion} we have
$S^\wedge = \prod S^\wedge_i$ where $S^\wedge_i$
is the completion of $S$ with respect to the maximal ideal $\mathfrak m_i$.
Hence it suffices to show that $S_{\mathfrak m_i}$ is analytically unramified.
In other words, we have reduced to the case where $R$ is a Noetherian
normal Nagata domain.

\medskip\noindent
Assume $R$ is a Noetherian, normal, local Nagata domain.
Pick a nonzero $x \in \mathfrak m$ in the maximal ideal.
We are going to apply Lemma \ref{lemma-criterion-analytically-unramified}.
We have to check properties (1), (2), (3)(a) and (3)(b).
Property (1) is clear.
We have that $R/xR$ has no embedded primes by
Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}.
Thus property (2) holds. The same lemma also tells us each associated
prime $\mathfrak p$ of $R/xR$ has height $1$.
Hence $R_{\mathfrak p}$ is a $1$-dimensional normal domain
hence regular (Lemma \ref{lemma-characterize-dvr}). Thus (3)(a) holds.
Finally (3)(b) holds by induction hypothesis, since
$R/\mathfrak p$ is Nagata (by Lemma \ref{lemma-quasi-finite-over-nagata}
or directly from the definition).
Thus we conclude $R$ is analytically unramified.
\end{proof}

\begin{lemma}
\label{lemma-local-nagata-and-analytically-unramified}
Let $(R, \mathfrak m)$ be a Noetherian local ring. The following
are equivalent
\begin{enumerate}
\item $R$ is Nagata,
\item for $R \to S$ finite with $S$ a domain and $\mathfrak m' \subset S$
maximal the local ring $S_{\mathfrak m'}$ is analytically unramified,
\item for $(R, \mathfrak m) \to (S, \mathfrak m')$ finite
local homomorphism with $S$ a domain, then $S$ is analytically
unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $R$ is Nagata and let $R \to S$ and $\mathfrak m' \subset S$
be as in (2). Then $S$ is Nagata by Lemma \ref{lemma-quasi-finite-over-nagata}.
Hence the local ring $S_{\mathfrak m'}$ is Nagata
(Lemma \ref{lemma-nagata-localize}). Thus it is analytically
unramified by Lemma \ref{lemma-local-nagata-domain-analytically-unramified}.
It is clear that (2) implies (3).

\medskip\noindent
Assume (3) holds. Let $\mathfrak p \subset R$ be a prime ideal and
let $f.f.(R/\mathfrak p) \subset L$ be a finite extension of fields.
To prove (1) we have to show that the integral closure of $R/\mathfrak p$
is finite over $R/\mathfrak p$. Choose $x_1, \ldots, x_n \in L$
which generate $L$ over $f.f.(R/\mathfrak p)$. For each $i$ let
$P_i(T) = T^{d_i} + a_{i, 1} T^{d_i - 1} + \ldots + a_{i, d_i}$
be the minimal polynomial for $x_i$ over $f.f.(R/\mathfrak p)$.
After replacing $x_i$ by $f_i x_i$ for a suitable
$f_i \in R$, $f_i \not \in \mathfrak p$ we may assume
$a_{i, j} \in R/\mathfrak p$. In fact, after further multiplying
by elements of $\mathfrak m$, we may assume
$a_{i, j} \in \mathfrak m/\mathfrak p \subset R/\mathfrak p$ for all $i, j$.
Having done this let $S = R/\mathfrak p[x_1, \ldots, x_n] \subset L$.
Then $S$ is finite over $R$, a domain, and $S/\mathfrak m S$ is a quotient
of $R/\mathfrak m[T_1, \ldots, T_n]/(T_1^{d_1}, \ldots, T_n^{d_n})$.
Hence $S$ is local. By (3) $S$ is analytically unramified and by
Lemma \ref{lemma-analytically-unramified-easy}
we find that its integral closure $S'$ in $L$ is finite over $S$.
Since $S'$ is also the integral closure of $R/\mathfrak p$ in
$L$ we win.
\end{proof}

\noindent
The following proposition says in particular that an algebra of finite
type over a Nagata ring is a Nagata ring.

\begin{proposition}[Nagata]
\label{proposition-nagata-universally-japanese}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a Nagata ring,
\item any finite type $R$-algebra is Nagata, and
\item $R$ is universally Japanese and Noetherian.
\end{enumerate}
\end{proposition}

\begin{proof}
It is clear that a Noetherian universally Japanese ring is universally
Nagata (i.e., condition (2) holds). Let $R$ be a Nagata ring.
We will show that any finitely generated $R$-algebra $S$ is Nagata.
This will prove the proposition.

\medskip\noindent
Step 1. There exists a sequence of ring maps
$R = R_0 \to R_1 \to R_2 \to \ldots \to R_n = S$ such that
each $R_i \to R_{i + 1}$ is generated by a single element.
Hence by induction it suffices to prove $S$ is Nagata if
$S \cong R[x]/I$.

\medskip\noindent
Step 2. Let $\mathfrak q \subset S$ be a prime of $S$, and let
$\mathfrak p \subset R$ be the corresponding prime of $R$.
We have to show that $S/\mathfrak q$ is N-2. Hence we have
reduced to the proving the following:
(*) Given a Nagata domain $R$ and a monogenic extension $R \subset S$
of domains then $S$ is N-2.

\medskip\noindent
Step 3. Let $R$ be a Nagata domain and $R \subset S$ a monogenic
extension of domains. Let $R \subset R'$ be the integral closure
of $R$ in its fraction field. Let $S'$ be the subring of
$f.f.(S)$ generated by $R'$ and $S$. As $R'$ is finite over $R$
(by the Nagata property) also $S'$ is finite over $S$.
Since $S$ is Noetherian it suffices to prove that $S'$
is N-2 (Lemma \ref{lemma-finite-extension-N-2}).
Hence we have reduced to proving the following:
(**) Given a normal Nagata domain $R$ and a
monogenic extension $R \subset S$ of domains then $S$ is N-2.

\medskip\noindent
Step 4: Let $R$ be a normal Nagata domain and
let $R \subset S$ be a monogenic extension of domains.
Suppose the extension of fraction fields $f.f.(R) \subset f.f.(S)$
is purely transcendental. In this case $S = R[x]$. By
Lemma \ref{lemma-polynomial-ring-N-2} we see that $S$ is N-2.
Hence we have reduced to proving the following:
(**) Given a normal Nagata domain $R$ and a
monogenic extension $R \subset S$ of domains
inducing a finite extension of fraction fields
then $S$ is N-2.

\medskip\noindent
Step 5. Let $R$ be a normal Nagata domain and
let $R \subset S$ be a monogenic extension of domains
inducing a finite extension of fraction fields
$K = f.f.(R) \subset f.f.(S) = L$. Choose an element $x \in S$
which generates $S$ as an $R$-algebra. Let $L \subset M$
be a finite extension of fields.
Let $R'$ be the integral closure of $R$ in $M$.
Then the integral closure $S'$ of $S$ in $M$ is equal to the integral
closure of $R'[x]$ in $M$.
Also $f.f.(R') = M$, and $R \subset R'$
is finite (by the Nagata property of $R$).
This implies that $R'$ is a Nagata ring
(Lemma \ref{lemma-quasi-finite-over-nagata}).
To show that $S'$ is finite over $S$ is the same as showing that
$S'$ is finite over $R'[x]$. Replace $R$ by $R'$ and $S$ by $R'[x]$
to reduce to the following statement:
(***) Given a normal Nagata domain $R$ with fraction field $K$,
and $x \in K$, the ring $S \subset K$ generated by $R$ and $x$
is N-1.

\medskip\noindent
Step 6. Let $R$ be a normal Nagata domain with fraction field $K$.
Let $x = b/a \in K$. We have to show that the ring $S \subset K$
generated by $R$ and $x$ is N-1. Note that $S_a \cong R_a$ is normal.
Hence by Lemma \ref{lemma-characterize-N-1} it suffices to show that
$S_{\mathfrak m}$ is N-1 for every maximal ideal $\mathfrak m$ of $S$.

\medskip\noindent
With assumptions as in the preceding paragraph, pick such a maximal
ideal and set $\mathfrak n = R \cap \mathfrak m$. The residue field
extension $\kappa(\mathfrak n) \subset \kappa(\mathfrak m)$ is finite
(Theorem \ref{theorem-nullstellensatz}) and generated by the image of $x$.
Hence there exists a monic polynomial
$f(X) = X^d + \sum_{i = 1, \ldots, d} a_iX^{d -i}$ with
$f(x) \in \mathfrak m$. Let $K \subset K''$ be a finite extension
of fields such that $f(X)$ splits completely in $K''[X]$.
Let $R'$ be the integral closure of $R$ in $K''$.
Let $S' \subset K'$ be the subring generated by $R'$ and $x$.
As $R$ is Nagata we see $R'$ is finite over $R$ and Nagata
(Lemma \ref{lemma-quasi-finite-over-nagata}).
Moreover, $S'$ is finite over $S$. If for every maximal ideal
$\mathfrak m'$ of $S'$ the local ring $S'_{\mathfrak m'}$ is
N-1, then $S'_{\mathfrak m}$ is N-1 by
Lemma \ref{lemma-characterize-N-1}, which in turn
implies that $S_{\mathfrak m}$ is N-1 by
Lemma \ref{lemma-finite-extension-N-2}.
After replacing $R$ by $R'$ and $S$ by $S'$, and $\mathfrak m$ by
any of the maximal ideals $\mathfrak m'$ lying over $\mathfrak m$
we reach the situation where the polynomial $f$ above split completely:
$f(X) = \prod_{i = 1, \ldots, d} (X - a_i)$ with $a_i \in R$.
Since $f(x) \in \mathfrak m$ we see that $x - a_i \in \mathfrak m$
for some $i$. Finally, after replacing $x$ by $x - a_i$ we may assume
that $x \in \mathfrak m$.

\medskip\noindent
To recapitulate: $R$ is a normal Nagata domain with fraction field $K$,
$x \in K$ and $S$ is the subring of $K$ generated by $x$ and $R$,
finally $\mathfrak m \subset S$ is a maximal ideal with $x \in \mathfrak m$.
We have to show $S_{\mathfrak m}$ is N-1.

\medskip\noindent
We will show that Lemma \ref{lemma-criterion-analytically-unramified}
applies to the local ring
$S_{\mathfrak m}$ and the element $x$. This will imply that
$S_{\mathfrak m}$ is analytically unramified, whereupon we
see that it is N-1 by Lemma \ref{lemma-analytically-unramified-easy}.

\medskip\noindent
We have to check properties (1), (2), (3)(a) and (3)(b).
Property (1) is trivial.
Let $I = \Ker(R[X] \to S)$ where $X \mapsto x$.
We claim that $I$ is generated by all linear forms $aX + b$ such that
$ax = b$ in $K$. Clearly all these linear forms are in $I$.
If $g = a_d X^d + \ldots a_1 X + a_0 \in I$, then we see that
$a_dx$ is integral over $R$ (Lemma \ref{lemma-make-integral-trivial})
and hence $b := a_dx \in R$
as $R$ is normal. Then $g - (a_dX - b)X^{d - 1} \in I$ and we win by
induction on the degree. As a consequence we see that
$$
S/xS = R[X]/(X, I) = R/J
$$
where
$$
J = \{b \in R \mid ax = b \text{ for some }a \in R\} = xR \cap R
$$
By Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}
we see that $S/xS = R/J$ has no embedded primes as an $R$-module, hence as
an $R/J$-module, hence as an $S/xS$-module, hence as an $S$-module.
This proves property (2).
Take such an associated prime $\mathfrak q \subset S$ with the
property $\mathfrak q \subset \mathfrak m$ (so that it is an
associated prime of $S_{\mathfrak m}/xS_{\mathfrak m}$ -- it does not
matter for the arguments).
Then $\mathfrak q$ is minimal over $xS$ and hence has height $1$.
By the sequence of equalities above we see that
$\mathfrak p = R \cap \mathfrak q$ is an associated
prime of $R/J$, and so has height $1$
(see Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}).
Thus $R_{\mathfrak p}$ is a discrete valuation ring and therefore
$R_{\mathfrak p} \subset S_{\mathfrak q}$ is an equality. This shows
that $S_{\mathfrak q}$ is regular. This proves property (3)(a).
Finally, $(S/\mathfrak q)_{\mathfrak m}$ is a localization
of $S/\mathfrak q$, which is a quotient of $S/xS = R/J$.
Hence $(S/\mathfrak q)_{\mathfrak m}$ is a localization of
a quotient of the Nagata ring $R$, hence
Nagata (Lemmas \ref{lemma-quasi-finite-over-nagata}
and \ref{lemma-nagata-localize})
and hence analytically unramified
(Lemma \ref{lemma-local-nagata-domain-analytically-unramified}).
This shows (3)(b) holds and we are done.
\end{proof}

\begin{proposition}
\label{proposition-ubiquity-nagata}
The following types of rings are Nagata and in particular universally Japanese:
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains with fraction field of characteristic zero,
\item finite type ring extensions of any of the above.
\end{enumerate}
\end{proposition}

\begin{proof}
The Noetherian complete local ring case is
Lemma \ref{lemma-Noetherian-complete-local-Nagata}.
In the other cases you just check if $R/\mathfrak p$ is N-2 for every
prime ideal $\mathfrak p$ of the ring. This is clear whenever
$R/\mathfrak p$ is a field, i.e., $\mathfrak p$ is maximal.
Hence for the Dedekind ring case we only need to check it when
$\mathfrak p = (0)$. But since we assume the fraction field has
characteristic zero Lemma \ref{lemma-domain-char-zero-N-1-2} kicks in.
\end{proof}

\begin{example}
\label{example-nonjapanese-dvr}
A discrete valuation ring is Nagata if and only if it is N-2
(this follows immediately from the definition). The discrete valuation
ring $A$ of Example \ref{example-bad-dvr-char-p} is not Nagata, i.e.,
it is not N-2. Namely, the finite extension
$A \subset R = A[f]$ is not N-1. To see this say $f = \sum a_i x^i$.
For every $n \geq 1$ set $g_n = \sum_{i < n} a_i x^i \in A$.
Then $h_n = (f - g_n)/x^n$ is an element of the fraction field of $R$
and $h_n^p \in k^p[[x]] \subset A$. Hence the integral closure $R'$
of $R$ contains $h_1, h_2, h_3, \ldots$. Now, if $R'$
were finite over $R$ and hence $A$, then $f  = x^n h_n + g_n$
would be contained in the submodule $A + x^nR'$ for all $n$. By
Artin-Rees this would imply $f \in A$
(Lemma \ref{lemma-intersect-powers-ideal-module-zero}), a contradiction.
\end{example}

\begin{lemma}
\label{lemma-nagata-pth-roots}
Let $(A, \mathfrak m)$ be a Noetherian local domain which is Nagata
and has fraction field of characteristic $p$. If $a \in A$ has a
$p$th root in $A^\wedge$, then $a$ is has a $p$th root in $A$.
\end{lemma}

\begin{proof}
Consider the ring extension $A \subset B = A[x]/(x^p - a)$.
If $a$ does not have a $p$th root in $A$, then $B$ is a domain
whose completion isn't reduced. This contradicts our earlier
results, as $B$ is a Nagata
(Proposition \ref{proposition-nagata-universally-japanese})
and hence analytically unramified by
Lemma \ref{lemma-local-nagata-domain-analytically-unramified}.
\end{proof}






\section{Ascending properties}
\label{section-ascending-properties}

\noindent
In this section we start proving some algebraic facts concerning the
``ascent'' of properties of rings. To do this for depth of rings
one uses the following result on ascending depth of modules, see
\cite[IV, Proposition 6.3.1]{EGA}.

\begin{lemma}
\label{lemma-apply-grothendieck-module}
\begin{reference}
\cite[IV, Proposition 6.3.1]{EGA}
\end{reference}
We have
$$
\text{depth}(M \otimes_R N)
=
\text{depth}(M) + \text{depth}(N/\mathfrak m_RN)
$$
where $R \to S$ is a local homomorphism of local Noetherian rings,
$M$ is a finite $R$-module, and $N$ is a finite $S$-module flat over $R$.
\end{lemma}

\begin{proof}
In the statement and in the proof below, we take the depth of $M$
as an $R$-module, the depth of $M \otimes_R N$ as an $S$-module, and
the depth of $N/\mathfrak M_RN$ as an $S/\mathfrak m_RS$-module.
Denote $n$ the right hand side. First assume that $n$ is zero.
Then both $\text{depth}(M) = 0$ and
$\text{depth}(N/\mathfrak m_RN) = 0$.
This means there is a $z \in M$ whose annihilator is $\mathfrak m_R$
and a $\overline{y} \in N/\mathfrak m_RN$
whose annihilator is $\mathfrak m_S/\mathfrak m_RS$.
Let $y \in N$ be a lift of $\overline{y}$.
Since $N$ is flat over $R$ the map $z : R/\mathfrak m_R \to M$
produces an injective map $N/\mathfrak m_RN \to M \otimes_R N$.
Hence the annihilator of $z \otimes y$ is $\mathfrak m_S$.
Thus $\text{depth}(M \otimes_R N) = 0$ as well.

\medskip\noindent
Assume $n > 0$. If $\text{depth}(N/\mathfrak m_RN) > 0$, then we may choose
$f \in \mathfrak m_S$ mapping to $\overline{f} \in S/\mathfrak m_RS$ which
is a nonzerodivisor on $N/\mathfrak m_RN$.
Then $\text{depth}(N/\mathfrak m_RN) =
\text{depth}(N/(f, \mathfrak m_R)N) + 1$
by Lemma \ref{lemma-depth-drops-by-one}.
According to Lemma \ref{lemma-mod-injective} the element $f \in S$ is a
nonzerodivisor on $N$ and $N/fN$ is flat over $R$.
Hence by induction on $n$ we have
$$
\text{depth}(M \otimes_R N/fN) =
\text{depth}(M) + \text{depth}(N/(f, \mathfrak m_R)N).
$$
Because $N/fN$ is flat over $R$ the sequence
$$
0 \to M \otimes_R N \to M \otimes_R N \to M \otimes_R N/fN \to 0
$$
is exact where the first map is multiplication by $f$
(Lemma \ref{lemma-flat-tor-zero}). Hence by
Lemma \ref{lemma-depth-drops-by-one} we find that
$\text{depth}(M \otimes_R N) = \text{depth}(M \otimes_R N/fN) + 1$
and we conclude that equality holds in the formula of the lemma.

\medskip\noindent
If $n > 0$, but $\text{depth}(N/\mathfrak m_RN) = 0$,
then we can choose $f \in \mathfrak m_R$ which is a nonzerodivisor on $M$.
As $N$ is flat over $R$ it is also the case that $f$ is a nonzerodivisor on
$M \otimes_R N$. By induction on $n$ again we have
$$
\text{depth}(M/fM \otimes_R N) =
\text{depth}(M/fM) + \text{depth}(N/\mathfrak m_RN).
$$
In this case
$\text{depth}(M \otimes_R N) = \text{depth}(M/fM \otimes_R N) + 1$
and $\text{depth}(M) = \text{depth}(M/fM) + 1$
by Lemma \ref{lemma-depth-drops-by-one} and
we conclude that equality holds in the formula of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-apply-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Then
$$
\text{depth}(S) = \text{depth}(R) + \text{depth}(S/\mathfrak m_RS).
$$
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-apply-grothendieck-module}.
\end{proof}

\begin{lemma}
\label{lemma-CM-goes-up}
Let $R \to S$ be a flat local homomorphism of local Noetherian rings.
Then the following are equivalent
\begin{enumerate}
\item $S$ is Cohen-Macaulay, and
\item $R$ and $S/\mathfrak m_RS$ are Cohen-Macaulay.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Lemmas \ref{lemma-apply-grothendieck} and
\ref{lemma-dimension-base-fibre-equals-total}.
\end{proof}

\begin{lemma}
\label{lemma-Sk-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian,
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are $(S_k)$, and
\item $R$ has property $(S_k)$.
\end{enumerate}
Then $S$ has property $(S_k)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. By
Lemma \ref{lemma-apply-grothendieck} we have
$$
\text{depth}(S_{\mathfrak q}) =
\text{depth}(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{depth}(R_{\mathfrak p}).
$$
On the other hand, we have
$$
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})
\geq
\dim(S_{\mathfrak q})
$$
by Lemma \ref{lemma-dimension-base-fibre-total}.
(Actually equality holds, by
Lemma \ref{lemma-dimension-base-fibre-equals-total}
but strictly speaking we do not need this.)
Finally, as the fibre rings of the map
are assumed $(S_k)$ we see that
$\text{depth}(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})
\geq \min(k, \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}))$.
Thus the lemma follows by the following string of inequalities
\begin{eqnarray*}
\text{depth}(S_{\mathfrak q}) & = &
\text{depth}(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{depth}(R_{\mathfrak p}) \\
& \geq &
\min(k, \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})) +
\min(k, \dim(R_{\mathfrak p})) \\
& = &
\min(2k, \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) + k,
k + \dim(R_\mathfrak p),
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\dim(R_{\mathfrak p})) \\
& \geq &
\min(k, \dim(S_{\mathfrak q}))
\end{eqnarray*}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-Rk-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$
have property $(R_k)$, and
\item $R$ has property $(R_k)$.
\end{enumerate}
Then $S$ has property $(R_k)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$.
Assume that $\dim(S_{\mathfrak q}) \leq k$.
Since $\dim(S_{\mathfrak q}) = \dim(R_{\mathfrak p})
+ \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$ by
Lemma \ref{lemma-dimension-base-fibre-equals-total}
we see that $\dim(R_{\mathfrak p}) \leq k$ and
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) \leq k$.
Hence $R_{\mathfrak p}$ and $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
are regular by assumption.
It follows that $S_{\mathfrak q}$ is regular by
Lemma \ref{lemma-flat-over-regular-with-regular-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-reduced-goes-up-noetherian}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are reduced,
\item $R$ is reduced.
\end{enumerate}
Then $S$ is reduced.
\end{lemma}

\begin{proof}
For Noetherian rings reduced is the same as having properties
$(S_1)$ and $(R_0)$, see Lemma \ref{lemma-criterion-reduced}.
Thus we know $R$ and the fibre rings have these properties.
Hence we may apply Lemmas \ref{lemma-Sk-goes-up} and \ref{lemma-Rk-goes-up}
and we see that $S$ is $(S_1)$ and $(R_0)$, in other words reduced
by Lemma \ref{lemma-criterion-reduced} again.
\end{proof}

\begin{lemma}
\label{lemma-reduced-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is smooth,
\item $R$ is reduced.
\end{enumerate}
Then $S$ is reduced.
\end{lemma}

\begin{proof}
Observe that $R \to S$ is flat with regular fibres (see the list of
results on smooth ring maps in Section \ref{section-smooth-overview}).
In particular, the fibres are reduced.
Thus if $R$ is Noetherian, then $S$ is Noetherian and we get
the result from Lemma \ref{lemma-reduced-goes-up-noetherian}.

\medskip\noindent
In the general case we may find a finitely generated
$\mathbf{Z}$-subalgebra $R_0 \subset R$ and a smooth ring
map $R_0 \to S_0$ such that $S \cong R \otimes_{R_0} S_0$, see
remark (10) in Section \ref{section-smooth-overview}.
Now, if $x \in S$ is an element with $x^2 = 0$,
then we can enlarge $R_0$ and assume that $x$ comes
from an element $x_0 \in S_0$. After enlarging
$R_0$ once more we may assume that $x_0^2 = 0$ in $S_0$.
However, since $R_0 \subset R$ is reduced we see that
$S_0$ is reduced and hence $x_0 = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-normal-goes-up-noetherian}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian,
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are normal, and
\item $R$ is normal.
\end{enumerate}
Then $S$ is normal.
\end{lemma}

\begin{proof}
For a Noetherian ring being normal is the same as having properties
$(S_2)$ and $(R_1)$, see Lemma \ref{lemma-criterion-normal}.
Thus we know $R$ and the fibre rings have these properties.
Hence we may apply Lemmas \ref{lemma-Sk-goes-up} and \ref{lemma-Rk-goes-up}
and we see that $S$ is $(S_2)$ and $(R_1)$, in other words normal
by Lemma \ref{lemma-criterion-normal} again.
\end{proof}

\begin{lemma}
\label{lemma-normal-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is smooth,
\item $R$ is normal.
\end{enumerate}
Then $S$ is normal.
\end{lemma}

\begin{proof}
Observe that $R \to S$ is flat with regular fibres (see the list of
results on smooth ring maps in Section \ref{section-smooth-overview}).
In particular, the fibres are normal. Thus if $R$ is Noetherian,
then $S$ is Noetherian and we get the result from
Lemma \ref{lemma-normal-goes-up-noetherian}.

\medskip\noindent
The general case. First note that $R$ is reduced and hence
$S$ is reduced by Lemma \ref{lemma-reduced-goes-up}.
Let $\mathfrak q$ be a prime of $S$ and let $\mathfrak p$ be
the corresponding prime of $R$. Note that $R_{\mathfrak p}$
is a normal domain. We have to show that $S_{\mathfrak q}$ is
a normal domain. To do this we may replace $R$ by $R_{\mathfrak p}$
and $S$ by $S_{\mathfrak p}$. Hence we may assume that $R$ is
a normal domain.

\medskip\noindent
Assume $R \to S$ smooth, and $R$ a normal domain.
We may find a finitely generated $\mathbf{Z}$-subalgebra
$R_0 \subset R$ and a smooth ring map $R_0 \to S_0$ such
that $S \cong R \otimes_{R_0} S_0$, see
remark (10) in Section \ref{section-smooth-overview}.
As $R_0$ is a Nagata domain (see Proposition \ref{proposition-ubiquity-nagata})
we see that its integral closure $R_0'$ is finite over $R_0$.
Moreover, as $R$ is a normal domain it is clear that $R_0' \subset R$.
Hence we may replace $R_0$ by $R_0'$ and $S_0$ by
$R_0' \otimes_{R_0} S_0$ and assume that $R_0$ is a normal
Noetherian domain. By the first paragraph of the proof we conclude
that $S_0$ is a normal ring (it need not be a domain of course).
In this way we see that $R = \bigcup R_\lambda$
is the union of normal Noetherian domains and correspondingly
$S = \colim R_\lambda \otimes_{R_0} S_0$ is the colimit
of normal rings. This implies that $S$ is a normal ring.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-regular-goes-up}
\begin{slogan}
Regularity ascends along smooth maps of rings.
\end{slogan}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is smooth,
\item $R$ is a regular ring.
\end{enumerate}
Then $S$ is regular.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-Rk-goes-up} applied for all $(R_k)$
using Lemma \ref{lemma-characterize-smooth-over-field} to see that the
hypotheses are satisfied.
\end{proof}






\section{Descending properties}
\label{section-descending-properties}

\noindent
In this section we start proving some algebraic facts concerning the
``descent'' of properties of rings. It turns out that it is often
``easier'' to descend properties than it is to ascend them. In other
words, the assumption on the ring map $R \to S$ are often weaker than
the assumptions in the corresponding lemma of the preceding section.
However, we warn the reader that the results on descent are often
useless unless the corresponding ascent can also be shown!
Here is a typical result which illustrates this phenomenon.

\begin{lemma}
\label{lemma-descent-Noetherian}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is Noetherian.
\end{enumerate}
Then $R$ is Noetherian.
\end{lemma}

\begin{proof}
Let $I_0 \subset I_1 \subset I_2 \subset \ldots$ be a
growing sequence of ideals of $R$. By assumption we have
$I_nS = I_{n +1}S = I_{n + 2}S = \ldots$ for some $n$.
Since $R \to S$ is flat we have $I_kS = I_k \otimes_R S$.
Hence, as $R \to S$ is faithfully flat we see that
$I_nS = I_{n +1}S = I_{n + 2}S = \ldots$ implies that
$I_n = I_{n +1} = I_{n + 2} = \ldots$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-descent-reduced}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is reduced.
\end{enumerate}
Then $R$ is reduced.
\end{lemma}

\begin{proof}
This is clear as $R \to S$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-descent-normal}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is a normal ring.
\end{enumerate}
Then $R$ is a normal ring.
\end{lemma}

\begin{proof}
Since $S$ is reduced it follows that $R$ is reduced.
Let $\mathfrak p$ be a prime of $R$. We have to show that
$R_{\mathfrak p}$ is a normal domain. Since $S_{\mathfrak p}$
is faithfully over $R_{\mathfrak p}$ too we may assume that
$R$ is local with maximal ideal $\mathfrak m$.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Then we see that $R \to S_{\mathfrak q}$ is faithfully flat
(Lemma \ref{lemma-local-flat-ff}).
Hence we may assume $S$ is local as well.
In particular $S$ is a normal domain.
Since $R \to S$ is faithfully flat
and $S$ is a normal domain we see that $R$ is a domain.
Next, suppose that $a/b$ is integral over $R$ with $a, b \in R$.
Then $a/b \in S$ as $S$ is normal. Hence $a \in bS$.
This means that $a : R \to R/bR$ becomes the zero map
after base change to $S$. By faithful flatness we see that
$a \in bR$, so $a/b \in R$. Hence $R$ is normal.
\end{proof}

\begin{lemma}
\label{lemma-descent-regular}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is a regular ring.
\end{enumerate}
Then $R$ is a regular ring.
\end{lemma}

\begin{proof}
We see that $R$ is Noetherian by Lemma \ref{lemma-descent-Noetherian}.
Let $\mathfrak p \subset R$ be a prime. Choose a prime $\mathfrak q \subset S$
lying over $\mathfrak p$. Then Lemma \ref{lemma-flat-under-regular}
applies to $R_\mathfrak p \to S_\mathfrak q$ and we conclude that
$R_\mathfrak p$ is regular. Since $\mathfrak p$ was arbitrary we see
$R$ is regular.
\end{proof}

\begin{lemma}
\label{lemma-descent-Sk}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is Noetherian and has property $(S_k)$.
\end{enumerate}
Then $R$ is Noetherian and has property $(S_k)$.
\end{lemma}

\begin{proof}
We have already seen that (1) and (2) imply that $R$ is Noetherian,
see Lemma \ref{lemma-descent-Noetherian}.
Let $\mathfrak p \subset R$ be a prime ideal.
Choose a prime $\mathfrak q \subset S$ lying over $\mathfrak p$
which corresponds to a minimal prime of the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. Then
$A = R_{\mathfrak p} \to S_{\mathfrak q} = B$ is a flat local ring
homomorphism of Noetherian local rings with $\mathfrak m_AB$ an
ideal of definition of $B$. Hence
$\dim(A) = \dim(B)$ (Lemma \ref{lemma-dimension-base-fibre-equals-total}) and
$\text{depth}(A) = \text{depth}(B)$ (Lemma \ref{lemma-apply-grothendieck}).
Hence since $B$ has $(S_k)$ we
see that $A$ has $(S_k)$.
\end{proof}

\begin{lemma}
\label{lemma-descent-Rk}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is Noetherian and has property $(R_k)$.
\end{enumerate}
Then $R$ is Noetherian and has property $(R_k)$.
\end{lemma}

\begin{proof}
We have already seen that (1) and (2) imply that $R$ is Noetherian,
see Lemma \ref{lemma-descent-Noetherian}.
Let $\mathfrak p \subset R$ be a prime ideal and assume
$\dim(R_{\mathfrak p}) \leq k$.
Choose a prime $\mathfrak q \subset S$ lying over $\mathfrak p$
which corresponds to a minimal prime of the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. Then
$A = R_{\mathfrak p} \to S_{\mathfrak q} = B$ is a flat local ring
homomorphism of Noetherian local rings with $\mathfrak m_AB$ an
ideal of definition of $B$. Hence
$\dim(A) = \dim(B)$ (Lemma \ref{lemma-dimension-base-fibre-equals-total}).
As $S$ has $(R_k)$ we conclude that $B$ is a regular local ring.
By Lemma \ref{lemma-flat-under-regular} we conclude that $A$ is regular.
\end{proof}

\begin{lemma}
\label{lemma-descent-nagata}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R \to S$ is smooth and surjective on spectra, and
\item $S$ is a Nagata ring.
\end{enumerate}
Then $R$ is a Nagata ring.
\end{lemma}

\begin{proof}
Recall that a Nagata ring is the same thing as a Noetherian
universally Japanese ring
(Proposition \ref{proposition-nagata-universally-japanese}).
We have already seen that $R$ is Noetherian in
Lemma \ref{lemma-descent-Noetherian}.
Let $R \to A$ be a finite type ring map into a domain.
According to Lemma \ref{lemma-check-universally-japanese}
it suffices to check that $A$ is N-1.
It is clear that $B = A \otimes_R S$ is a finite type $S$-algebra
and hence Nagata (Proposition \ref{proposition-nagata-universally-japanese}).
Since $A \to B$ is smooth (Lemma \ref{lemma-base-change-smooth})
we see that $B$ is reduced (Lemma \ref{lemma-reduced-goes-up}).
Since $B$ is Noetherian it has only a finite number of minimal
primes $\mathfrak q_1, \ldots, \mathfrak q_t$ (see
Lemma \ref{lemma-Noetherian-irreducible-components}).
As $A \to B$ is flat each of these lies over $(0) \subset A$
(by going down, see Lemma \ref{lemma-flat-going-down})
The total ring of fractions $Q(B)$ is the product of the
$L_i = f.f.(B/\mathfrak q_i)$ (Lemmas
\ref{lemma-total-ring-fractions-no-embedded-points} and
\ref{lemma-minimal-prime-reduced-ring}).
Moreover, the integral closure $B'$ of $B$ in $Q(B)$ is
the product of the integral closures $B_i'$ of the $B/\mathfrak q_i$
in the factors $L_i$ (compare with
Lemma \ref{lemma-characterize-reduced-ring-normal}).
Since $B$ is universally Japanese the
ring extensions $B/\mathfrak q_i \subset B_i'$ are finite
and we conclude that $B' = \prod B_i'$ is finite over $B$.
Since $A \to B$ is flat we see that any
nonzerodivisor on $A$ maps to a nonzerodivisor on $B$.
The corresponding map
$$
Q(A) \otimes_A B = (A \setminus \{0\})^{-1}A \otimes_A B
= (A \setminus \{0\})^{-1}B \to Q(B)
$$
is injective (we used Lemma \ref{lemma-tensor-localization}).
Via this map $A'$ maps into $B'$. This induces a map
$$
A' \otimes_A B \longrightarrow B'
$$
which is injective (by the above and the flatness of $A \to B$).
Since $B'$ is a finite $B$-module
and $B$ is Noetherian we see that $A' \otimes_A B$ is a finite $B$-module.
Hence there exist finitely many elements $x_i \in A'$ such that
the elements $x_i \otimes 1$ generate $A' \otimes_A B$ as a $B$-module.
Finally, by faithful flatness of $A \to B$ we conclude that
the $x_i$ also generated $A'$ as an $A$-module, and we win.
\end{proof}

\begin{remark}
\label{remark-universally-catenary-does-not-descend}
The property of being ``universally catenary'' does not descend;
not even along \'etale ring maps. In
Examples, Section \ref{examples-section-non-catenary-Noetherian-local}
there is a construction of a finite ring map $A \to B$ with
$A$ local Noetherian and not universally catenary,
$B$ semi-local with two maximal ideals $\mathfrak m$, $\mathfrak n$
with $B_{\mathfrak m}$ and $B_{\mathfrak n}$ regular of dimension $2$ and $1$
respectively, and the same residue fields as that of $A$.
Moreover, $\mathfrak m_A$ generates the maximal ideal in both
$B_{\mathfrak m}$ and $B_{\mathfrak n}$ (so $A \to B$ is unramified
as well as finite).
By Lemma \ref{lemma-etale-makes-unramified-closed}
there exists a local \'etale ring map
$A \to A'$ such that $B \otimes_A A' = B_1 \times B_2$ decomposes
with $A' \to B_i$ surjective.
This shows that $A'$ has two minimal primes $\mathfrak q_i$
with $A'/\mathfrak q_i \cong B_i$. Since $B_i$ is regular local
(since it is \'etale over either $B_{\mathfrak m}$ or $B_{\mathfrak n}$)
we conclude that $A'$ is universally catenary.
\end{remark}









\section{Geometrically normal algebras}
\label{section-geometrically-normal}

\noindent
In this section we put some applications of ascent and descent of
properties of rings.

\begin{lemma}
\label{lemma-geometrically-normal}
Let $k$ be a field. Let $A$ be a $k$-algebra.
The following properties of $A$ are equivalent:
\begin{enumerate}
\item $k' \otimes_k A$ is a normal ring
for every field extension $k'/k$,
\item $k' \otimes_k A$ is a normal ring
for every finitely generated field extension $k'/k$,
\item $k' \otimes_k A$ is a normal ring
for every finite purely inseparable extension $k'/k$,
\item $k^{perf} \otimes_k A$ is a normal ring.
\end{enumerate}
Here normal ring is defined in Definition \ref{definition-ring-normal}.
\end{lemma}

\begin{proof}
It is clear that (1) $\Rightarrow$ (2) $\Rightarrow$ (3)
and (1) $\Rightarrow$ (4).

\medskip\noindent
If $k'/k$ is a finite purely inseparable extension, then
there is an embedding $k' \to k^{perf}$ of $k$-extensions.
The ring map $k' \otimes_k A \to k^{perf} \otimes_k A$
is faithfully flat, hence $k' \otimes_k A$ is normal if
$k^{perf} \otimes_k A$ is normal by
Lemma \ref{lemma-descent-normal}. In this way we see that
(4) $\Rightarrow$ (3).

\medskip\noindent
Assume (2) and let $k \subset k'$ be any field extension.
Then we can write $k' = \colim_i k_i$ as a directed
colimit of finitely generated field extensions. Hence we
see that $k' \otimes_k A = \colim_i k_i \otimes_k A$
is a directed colimit of normal rings. Thus we see
that $k' \otimes_k A$ is a normal ring by
Lemma \ref{lemma-colimit-normal-ring}.
Hence (1) holds.

\medskip\noindent
Assume (3) and let $k \subset K$ be a finitely generated field extension.
By Lemma \ref{lemma-make-separable} we can find a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is separable. By
Lemma \ref{lemma-localization-smooth-separable}
there exists a smooth $k'$-algebra $B$ such that $K'$ is the
fraction field of $B$. Now we can argue as follows:
Step 1: $k' \otimes_k A$ is a normal ring because we assumed (3).
Step 2: $B \otimes_{k'} k' \otimes_k A$ is a normal ring as
$k' \otimes_k A \to B \otimes_{k'} k' \otimes_k A$ is smooth
(Lemma \ref{lemma-base-change-smooth})
and ascent of normality along smooth maps
(Lemma \ref{lemma-normal-goes-up}).
Step 3. $K' \otimes_{k'} k' \otimes_k A = K' \otimes_k A$ is
a normal ring as it is a localization of a normal ring
(Lemma \ref{lemma-localization-normal-ring}).
Step 4. Finally $K \otimes_k A$ is a normal ring by descent of
normality along the faithfully flat ring map
$K \otimes_k A \to K' \otimes_k A$ (Lemma \ref{lemma-descent-normal}).
This proves the lemma.
\end{proof}

\begin{definition}
\label{definition-geometrically-normal}
Let $k$ be a field.
A $k$-algebra $R$ is called {\it geometrically normal} over $k$ if
the equivalent conditions of Lemma \ref{lemma-geometrically-normal} hold.
\end{definition}

\begin{lemma}
\label{lemma-localization-geometrically-normal-algebra}
Let $k$ be a field. A localization of a geometrically normal $k$-algebra
is geometrically normal.
\end{lemma}

\begin{proof}
This is clear as being a normal ring is checked at the localizations at
prime ideals.
\end{proof}

\begin{lemma}
\label{lemma-separable-field-extension-geometrically-normal}
Let $k$ be a field. Let $K/k$ be a separable field extension.
Then $K$ is geometrically normal over $k$.
\end{lemma}

\begin{proof}
This is true because $k^{perf} \otimes_k K$ is a field.
Namely, it is reduced for example by
Lemma \ref{lemma-characterize-separable-field-extensions}
and it has a unique prime ideal because $K \subset k^{perf} \otimes_k K$
is a universal homeomorphism.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-normal-tensor-normal}
Let $k$ be a field. Let $A, B$ be $k$-algebras. Assume $A$ is geometrically
normal over $k$ and $B$ is a normal ring. Then $A \otimes_k B$ is a normal
ring.
\end{lemma}

\begin{proof}
Let $\mathfrak r$ be a prime ideal of $A \otimes_k B$. Denote
$\mathfrak p$, resp.\ $\mathfrak q$ the corresponding prime of $A$,
resp.\ $B$. Then $(A \otimes_k B)_{\mathfrak r}$ is a localization of
$A_{\mathfrak p} \otimes_k B_{\mathfrak q}$. Hence it suffices to prove the
result for the ring $A_{\mathfrak p} \otimes_k B_{\mathfrak q}$, see
Lemma \ref{lemma-localization-normal-ring}
and
Lemma \ref{lemma-localization-geometrically-normal-algebra}.
Thus we may assume $A$ and $B$ are domains.

\medskip\noindent
Assume that $A$ and $B$ are domains with fractions fields $K$ and $L$.
Note that $B$ is the filtered colimit of its finite type normal
$k$-sub algebras (as $k$ is a Nagata ring, see
Proposition \ref{proposition-ubiquity-nagata},
and hence the integral closure of a finite type $k$-sub algebra is still
a finite type $k$-sub algebra by
Proposition \ref{proposition-nagata-universally-japanese}).
By
Lemma \ref{lemma-colimit-normal-ring}
we reduce to the case that $B$ is of finite type over $k$.

\medskip\noindent
Assume that $A$ and $B$ are domains with fractions fields $K$ and $L$
and $B$ of finite type over $k$. In this case the ring $K \otimes_k B$
is of finite type over $K$, hence Noetherian
(Lemma \ref{lemma-Noetherian-permanence}).
In particular $K \otimes_k B$ has finitely many minimal primes
(Lemma \ref{lemma-Noetherian-irreducible-components}).
Since $A \to A \otimes_k B$ is flat, this implies that $A \otimes_k B$
has finitely many minimal primes (by going down for flat ring maps --
Lemma \ref{lemma-flat-going-down}
-- these primes all lie over $(0) \subset A$). Thus it suffices to prove
that $A \otimes_k B$ is integrally closed in its total ring of fractions
(Lemma \ref{lemma-characterize-reduced-ring-normal}).

\medskip\noindent
We claim that $K \otimes_k B$ and $A \otimes_k L$ are both normal rings.
If this is true then any element $x$ of $Q(A \otimes_k B)$ which is
integral over $A \otimes_k B$ is (by
Lemma \ref{lemma-normal-ring-integrally-closed})
contained in $K \otimes_k B \cap A \otimes_k L = A \otimes_k B$ and we're done.
Since $A \otimes_K L$ is a normal ring by assumption, it suffices to
prove that $K \otimes_k B$ is normal.

\medskip\noindent
As $A$ is geometrically normal over $k$ we see $K$ is geometrically normal
over $k$
(Lemma \ref{lemma-localization-geometrically-normal-algebra})
hence $K$ is geometrically reduced over $k$.
Hence $K = \bigcup K_i$ is the union of finitely generated field extensions
of $k$ which are geometrically reduced
(Lemma \ref{lemma-subalgebra-separable}).
Each $K_i$ is the localization of a smooth $k$-algebra
(Lemma \ref{lemma-localization-smooth-separable}).
So $K_i \otimes_k B$ is the localization of a smooth $B$-algebra hence normal
(Lemma \ref{lemma-normal-goes-up}).
Thus $K \otimes_k B$ is a normal ring
(Lemma \ref{lemma-colimit-normal-ring})
and we win.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-normal-over-separable-algebraic}
Let $k \subset k'$ be a separable algebraic field extension.
Let $A$ be an algebra over $k'$. Then $A$ is geometrically normal
over $k$ if and only if it is geometrically normal over $k'$.
\end{lemma}

\begin{proof}
Let $k \subset L$ be a finite purely inseparable field extension.
Then $L' = k' \otimes_k L$ is a field (see material in
Fields, Section \ref{fields-section-algebraic})
and $A \otimes_k L = A \otimes_{k'} L'$. Hence if
$A$ is geometrically normal over $k'$, then $A$ is geometrically
normal over $k$.

\medskip\noindent
Assume $A$ is geometrically normal over $k$. Let $K/k'$ be a field
extension. Then
$$
K \otimes_{k'} A = (K \otimes_k A) \otimes_{(k' \otimes_k k')} k'
$$
Since $k' \otimes_k k' \to k'$ is a localization by
Lemma \ref{lemma-separable-algebraic-diagonal},
we see that $K \otimes_{k'} A$
is a localization of a normal ring, hence normal.
\end{proof}




\section{Geometrically regular algebras}
\label{section-geometrically-regular}

\noindent
Let $k$ be a field.
Let $A$ be a Noetherian $k$-algebra.
Let $k \subset K$ be a finitely generated field extension.
Then the ring $K \otimes_k A$ is Noetherian as well, see
Lemma \ref{lemma-Noetherian-field-extension}.
Thus the following lemma makes sense.

\begin{lemma}
\label{lemma-geometrically-regular}
Let $k$ be a field. Let $A$ be a $k$-algebra.
Assume $A$ is Noetherian.
The following properties of $A$ are equivalent:
\begin{enumerate}
\item $k' \otimes_k A$ is regular for every finitely generated field
extension $k \subset k'$, and
\item $k' \otimes_k A$ is regular for every finite purely inseparable
extension $k \subset k'$.
\end{enumerate}
Here regular ring is as in Definition \ref{definition-regular}.
\end{lemma}

\begin{proof}
The lemma makes sense by the remarks preceding the lemma.
It is clear that (1) $\Rightarrow$ (2).

\medskip\noindent
Assume (2) and let $k \subset K$ be a finitely generated field extension.
By Lemma \ref{lemma-make-separable} we can find a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is separable. By
Lemma \ref{lemma-localization-smooth-separable}
there exists a smooth $k'$-algebra $B$ such that $K'$ is the
fraction field of $B$. Now we can argue as follows:
Step 1: $k' \otimes_k A$ is a regular ring because we assumed (2).
Step 2: $B \otimes_{k'} k' \otimes_k A$ is a regular ring as
$k' \otimes_k A \to B \otimes_{k'} k' \otimes_k A$ is smooth
(Lemma \ref{lemma-base-change-smooth})
and ascent of regularity along smooth maps
(Lemma \ref{lemma-regular-goes-up}).
Step 3. $K' \otimes_{k'} k' \otimes_k A = K' \otimes_k A$ is
a regular ring as it is a localization of a regular ring
(immediate from the definition).
Step 4. Finally $K \otimes_k A$ is a regular ring by descent of
regularity along the faithfully flat ring map
$K \otimes_k A \to K' \otimes_k A$ (Lemma \ref{lemma-descent-regular}).
This proves the lemma.
\end{proof}

\begin{definition}
\label{definition-geometrically-regular}
Let $k$ be a field. Let $R$ be a Noetherian $k$-algebra.
The $k$-algebra $R$ is called {\it geometrically regular} over $k$ if
the equivalent conditions of Lemma \ref{lemma-geometrically-regular} hold.
\end{definition}

\noindent
It is clear from the definition that $K \otimes_k R$ is a geometrically
regular algebra over $K$ for any finitely generated field extension $K$ of
$k$. We will see later (More on Algebra, Proposition
\ref{more-algebra-proposition-characterization-geometrically-regular})
that it suffices to check $R \otimes_k k'$ is regular whenever
$k \subset k' \subset k^{1/p}$ (finite).

\begin{lemma}
\label{lemma-geometrically-regular-descent}
\begin{slogan}
Geometric regularity descends through faithfully flat maps of algebras
\end{slogan}
Let $k$ be a field. Let $A \to B$ be a faithfully flat $k$-algebra
map. If $B$ is geometrically regular over $k$, so is $A$.
\end{lemma}

\begin{proof}
Assume $B$ is geometrically regular over $k$.
Let $k \subset k'$ be a finite, purely inseparable extension.
Then $A \otimes_k k' \to B \otimes_k k'$ is faithfully flat as a
base change of $A \to B$ (by
Lemmas \ref{lemma-surjective-spec-radical-ideal} and
\ref{lemma-flat-base-change})
and $B \otimes_k k'$ is regular by our
assumption on $B$ over $k$. Then $A \otimes_k k'$ is regular by
Lemma \ref{lemma-descent-regular}.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-regular-goes-up}
Let $k$ be a field. Let $A \to B$ be a smooth ring map
of $k$-algebras. If $A$ is geometrically regular over $k$,
then $B$ is geometrically regular over $k$.
\end{lemma}

\begin{proof}
Let $k \subset k'$ be a finitely generated field extension.
Then $A \otimes_k k' \to B \otimes_k k'$ is a smooth ring map
(Lemma \ref{lemma-base-change-smooth}) and $A \otimes_k k'$
is regular. Hence $B \otimes_k k'$ is regular by
Lemma \ref{lemma-regular-goes-up}.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-regular-over-subfields}
Let $k$ be a field. Let $A$ be an algebra over $k$.
Let $k = \colim k_i$ be a directed colimit of subfields.
If $A$ is geometrically regular over each $k_i$, then
$A$ is geometrically regular over $k$.
\end{lemma}

\begin{proof}
Let $k \subset k'$ be a finite purely inseparable field extension.
We can get $k'$ by adjoining finitely many variables to $k$ and
imposing finitely many polynomial relations. Hence we see that
there exists an $i$ and a finite purely inseparable field extension
$k_i \subset k_i'$ such that $k_i = k \otimes_{k_i} k_i'$.
Thus $A \otimes_k k' = A \otimes_{k_i} k_i'$ and the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-regular-over-separable-algebraic}
Let $k \subset k'$ be a separable algebraic field extension.
Let $A$ be an algebra over $k'$. Then $A$ is geometrically
regular over $k$ if and only if it is geometrically regular over $k'$.
\end{lemma}

\begin{proof}
Let $k \subset L$ be a finite purely inseparable field extension.
Then $L' = k' \otimes_k L$ is a field (see material in
Fields, Section \ref{fields-section-algebraic})
and $A \otimes_k L = A \otimes_{k'} L'$. Hence if
$A$ is geometrically regular over $k'$, then $A$ is geometrically
regular over $k$.

\medskip\noindent
Assume $A$ is geometrically regular over $k$. Since $k'$
is the filtered colimit of finite extensions of $k$ we may
assume by Lemma \ref{lemma-geometrically-regular-over-subfields}
that $k'/k$ is finite separable. Consider the ring maps
$$
k' \to A \otimes_k k' \to A.
$$
Note that $A \otimes_k k'$ is geometrically regular over $k'$
as a base change of $A$ to $k'$. Note that $A \otimes_k k' \to A$
is the base change of $k' \otimes_k k' \to k'$ by the map
$k' \to A$. Since $k'/k$ is an \'etale extension of rings, we
see that $k' \otimes_k k' \to k'$ is \'etale
(Lemma \ref{lemma-etale}). Hence $A$ is
geometrically regular over $k'$ by
Lemma \ref{lemma-geometrically-regular-goes-up}.
\end{proof}





\section{Geometrically Cohen-Macaulay algebras}
\label{section-geometrically-CM}

\noindent
This section is a bit of a misnomer, since Cohen-Macaulay algebras
are automatically geometrically Cohen-Macaulay. Namely, see
Lemma \ref{lemma-extend-field-CM-locus}
and
Lemma \ref{lemma-CM-geometrically-CM}
below.

\begin{lemma}
\label{lemma-tensor-fields-CM}
Let $k$ be a field and let $k \subset K$ and $k \subset L$ be
two field extensions such that one of them is a field extension of finite type.
Then $K \otimes_k L$ is a Noetherian Cohen-Macaulay ring.
\end{lemma}

\begin{proof}
The ring $K \otimes_k L$ is Noetherian by
Lemma \ref{lemma-Noetherian-field-extension}.
Say $K$ is a finite extension of the purely transcendental extension
$k(t_1, \ldots, t_r)$. Then
$k(t_1, \ldots, t_r) \otimes_k L \to K \otimes_k L$
is a finite free ring map. By
Lemma \ref{lemma-finite-flat-over-regular-CM}
it suffices to show that $k(t_1, \ldots, t_r) \otimes_k L$ is Cohen-Macaulay.
This is clear because it is a localization of the polynomial
ring $L[t_1, \ldots, t_r]$. (See for example
Lemma \ref{lemma-CM-polynomial-algebra}
for the fact that a polynomial ring is Cohen-Macaulay.)
\end{proof}

\begin{lemma}
\label{lemma-CM-geometrically-CM}
Let $k$ be a field. Let $S$ be a Noetherian $k$-algebra.
Let $k \subset K$ be a finitely generated field extension,
and set $S_K = K \otimes_k S$. Let $\mathfrak q \subset S$
be a prime of $S$. Let $\mathfrak q_K \subset S_K$ be a prime
of $S_K$ lying over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay
if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-Noetherian-field-extension}
the ring $S_K$ is Noetherian. Hence
$S_{\mathfrak q} \to (S_K)_{\mathfrak q_K}$ is a flat local homomorphism
of Noetherian local rings. Note that the fibre
$$
(S_K)_{\mathfrak q_K} / \mathfrak q (S_K)_{\mathfrak q_K}
\cong (\kappa(\mathfrak q) \otimes_k K)_{\mathfrak q'}
$$
is the localization of the Cohen-Macaulay (Lemma \ref{lemma-tensor-fields-CM})
ring $\kappa(\mathfrak q) \otimes_k K$ at a suitable prime ideal
$\mathfrak q'$. Hence the lemma follows from Lemma \ref{lemma-CM-goes-up}.
\end{proof}







\section{Colimits and maps of finite presentation, II}
\label{section-colimits-finite-presentation}

\noindent
This section is a continuation of Section \ref{section-colimits-flat}.

\medskip\noindent
We start with an application of the openness of flatness.
It says that we can approximate flat modules by flat modules
which is useful.

\begin{lemma}
\label{lemma-flat-finite-presentation-limit-flat}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume that
\begin{enumerate}
\item $R \to S$ is of finite presentation,
\item $M$ is a finitely presented $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
In this case we have the following:
\begin{enumerate}
\item There exists a finite type $\mathbf{Z}$-algebra $R_0$ and
a finite type ring map $R_0 \to S_0$ and a finite $S_0$-module $M_0$
such that $M_0$ is flat over $R_0$, together with a ring maps
$R_0 \to R$ and $S_0 \to S$ and an $S_0$-module map $M_0 \to M$
such that $S \cong R \otimes_{R_0} S_0$ and $M = S \otimes_{S_0} M_0$.
\item If $R = \colim_{\lambda \in \Lambda} R_\lambda$ is written
as a directed colimit, then there exists a $\lambda$ and a ring map
$R_\lambda \to S_\lambda$ of finite presentation, and an $S_\lambda$-module
$M_\lambda$ of finite presentation such that $M_\lambda$ is flat over
$R_\lambda$ and such that $S = R \otimes_{R_\lambda} S_\lambda$ and
$M = S \otimes_{S_{\lambda}} M_\lambda$.
\item If
$$
(R \to S, M) =
\colim_{\lambda \in \Lambda}
(R_\lambda \to S_\lambda, M_\lambda)
$$
is written as a directed colimit such that
\begin{enumerate}
\item $R_\mu \otimes_{R_\lambda} S_\lambda \to S_\mu$ and
$S_\mu \otimes_{S_\lambda} M_\lambda \to M_\mu$ are isomorphisms
for $\mu \geq \lambda$,
\item $R_\lambda \to S_\lambda$ is of finite presentation,
\item $M_\lambda$ is a finitely presented $S_\lambda$-module,
\end{enumerate}
then for all sufficiently large $\lambda$ the module $M_\lambda$
is flat over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first write $(R \to S, M)$ as the directed colimit of a system
$(R_\lambda \to S_\lambda, M_\lambda)$ as in
as in Lemma \ref{lemma-limit-module-finite-presentation}.
Let $\mathfrak q \subset S$ be a prime.
Let $\mathfrak p \subset R$, $\mathfrak q_\lambda \subset S_\lambda$,
and $\mathfrak p_\lambda \subset R_\lambda$ the corresponding primes.
As seen in the proof of Theorem \ref{theorem-openness-flatness}
$$
((R_\lambda)_{\mathfrak p_\lambda},
(S_\lambda)_{\mathfrak q_\lambda},
(M_\lambda)_{\mathfrak q_{\lambda}})
$$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}, and
hence by Lemma \ref{lemma-colimit-eventually-flat}
we see that for some $\lambda_{\mathfrak q} \in \Lambda$
for all $\lambda \geq \lambda_{\mathfrak q}$
the module $M_\lambda$ is flat over
$R_\lambda$ at the prime $\mathfrak q_{\lambda}$.

\medskip\noindent
By Theorem \ref{theorem-openness-flatness} we get an open subset
$U_\lambda \subset \Spec(S_\lambda)$ such that $M_\lambda$
flat over $R_\lambda$ at all the primes of $U_\lambda$.
Denote $V_\lambda \subset \Spec(S)$ the inverse image of
$U_\lambda$ under the map $\Spec(S) \to \Spec(S_\lambda)$.
The argument above shows that for every $\mathfrak q \in \Spec(S)$
there exists a $\lambda_{\mathfrak q}$ such that
$\mathfrak q \in V_\lambda$ for all $\lambda \geq \lambda_{\mathfrak q}$.
Since $\Spec(S)$ is quasi-compact we see this implies there
exists a single $\lambda_0 \in \Lambda$ such that
$V_{\lambda_0} = \Spec(S)$.

\medskip\noindent
The complement $\Spec(S_{\lambda_0}) \setminus U_{\lambda_0}$
is $V(I)$ for some ideal $I \subset S_{\lambda_0}$. As
$V_{\lambda_0} = \Spec(S)$ we see that $IS = S$.
Choose $f_1, \ldots, f_r \in I$ and $s_1, \ldots, s_n \in S$ such
that $\sum f_i s_i = 1$. Since $\colim S_\lambda = S$, after
increasing $\lambda_0$ we may assume there exist
$s_{i, \lambda_0} \in S_{\lambda_0}$ such that
$\sum f_i s_{i, \lambda_0} = 1$.
Hence for this $\lambda_0$ we have
$U_{\lambda_0} = \Spec(S_{\lambda_0})$.
This proves (1).

\medskip\noindent
Proof of (2). Let $(R_0 \to S_0, M_0)$ be as in (1) and suppose that
$R = \colim R_\lambda$. Since $R_0$ is a finite type $\mathbf{Z}$
algebra, there exists a $\lambda$ and a map $R_0 \to R_\lambda$ such
that $R_0 \to R_\lambda \to R$ is the given map $R_0 \to R$ (see
Lemma \ref{lemma-characterize-finite-presentation}).
Then, part (2) follows by taking $S_\lambda = R_\lambda \otimes_{R_0} S_0$
and $M_\lambda = S_\lambda \otimes_{S_0} M_0$.

\medskip\noindent
Finally, we come to the proof of (3). Let
$(R_\lambda \to S_\lambda, M_\lambda)$ be as in (3). Choose
$(R_0 \to S_0, M_0)$ and $R_0 \to R$ as in (1).
As in the proof of (2), there exists a $\lambda_0$ and a ring map
$R_0 \to R_{\lambda_0}$ such that $R_0 \to R_{\lambda_0} \to R$ is the given
map $R_0 \to R$. Since $S_0$ is of finite presentation over $R_0$ and since
$S = \colim S_\lambda$ we see that for some $\lambda_1 \geq \lambda_0$
we get an $R_0$-algebra map $S_0 \to S_{\lambda_1}$ such that the
composition $S_0 \to S_{\lambda_1} \to S$ is the given map $S_0 \to S$
(see Lemma \ref{lemma-characterize-finite-presentation}).
For all $\lambda \geq \lambda_1$ this gives maps
$$
\Psi_{\lambda} :
R_\lambda \otimes_{R_0} S_0
\longrightarrow
R_\lambda \otimes_{R_{\lambda_1}} S_{\lambda_1}
\cong
S_\lambda
$$
the last isomorphism by assumption. By construction
$\colim_\lambda \Psi_\lambda$ is an isomorphism. Hence $\Psi_\lambda$
is an isomorphism for all $\lambda$ large enough by
Lemma \ref{lemma-colimit-category-fp-algebras}.
In the same vein, there exists a $\lambda_2 \geq \lambda_1$
and an $S_0$-module map $M_0 \to M_{\lambda_2}$ such that
$M_0 \to M_{\lambda_2} \to M$ is the given
map $M_0 \to M$ (see Lemma \ref{lemma-module-map-property-in-colimit}).
For $\lambda \geq \lambda_2$ there is an induced map
$$
S_\lambda \otimes_{S_0} M_0
\longrightarrow
S_\lambda \otimes_{S_{\lambda_2}} M_{\lambda_2}
\cong
M_\lambda
$$
and for $\lambda$ large enough this map is an isomorphism by
Lemma \ref{lemma-colimit-category-fp-modules}.
This implies (3) because $M_0$ is flat over $R_0$.
\end{proof}

\begin{lemma}
\label{lemma-descend-faithfully-flat-finite-presentation}
Let $R \to A \to B$ be ring maps.
Assume $A \to B$ faithfully flat of finite presentation.
Then there exists a commutative diagram
$$
\xymatrix{
R \ar[r] \ar@{=}[d] &
A_0 \ar[d] \ar[r] &
B_0 \ar[d] \\
R \ar[r] & A \ar[r] & B
}
$$
with $R \to A_0$ of finite presentation,
$A_0 \to B_0$ faithfully flat of finite presentation
and $B = A \otimes_{A_0} B_0$.
\end{lemma}

\begin{proof}
We first prove the lemma with $R$ replaced $\mathbf{Z}$.
By Lemma \ref{lemma-flat-finite-presentation-limit-flat}
there exists a diagram
$$
\xymatrix{
A_0 \ar[r] & A \\
B_0 \ar[u] \ar[r] & B \ar[u]
}
$$
where $A_0$ is of finite type over $\mathbf{Z}$, $B_0$ is flat of finite
presentation over $A_0$ such that $B = A \otimes_{A_0} B_0$.
As $A_0 \to B_0$ is flat of finite presentation we see that the image of
$\Spec(B_0) \to \Spec(A_0)$ is open, see
Proposition \ref{proposition-fppf-open}. Hence the complement of the image
is $V(I_0)$ for some ideal $I_0 \subset A_0$.
As $A \to B$ is faithfully
flat the map $\Spec(B) \to \Spec(A)$ is surjective, see
Lemma \ref{lemma-ff-rings}.
Now we use that
the base change of the image is the image of the base change.
Hence $I_0A = A$. Pick a relation
$\sum f_i r_i = 1$, with $r_i \in A$, $f_i \in I_0$. Then after
enlarging $A_0$ to contain the elements $r_i$ (and correspondingly
enlarging $B_0$) we see that $A_0 \to B_0$ is surjective on spectra
also, i.e., faithfully flat.

\medskip\noindent
Thus the lemma holds in case $R = \mathbf{Z}$.
In the general case, take the solution $A_0' \to B_0'$
just obtained and set $A_0 = A_0' \otimes_{\mathbf{Z}} R$,
$B_0 = B_0' \otimes_{\mathbf{Z}} R$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-finite}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is finite,
\item $C_0$ is of finite type over $B_0$.
\end{enumerate}
Then there exists an $i \geq 0$ such that the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is finite.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_m$ be generators for $C_0$ over $B_0$.
Pick monic polynomials $P_j \in A \otimes_{A_0} B_0[T]$ such
that $P_j(1 \otimes x_j) = 0$ in $A \otimes_{A_0} C_0$. For some
$i \geq 0$ we can find $P_{j, i} \in A_i \otimes_{A_0} B_0[T]$
mapping to $P_j$. Since $\otimes$
commutes with colimits we see that $P_{j, i}(1 \otimes x_j)$ is zero
in $A_i \otimes_{A_0} C_0$ after possibly increasing $i$.
Then this $i$ works.
\end{proof}

\begin{lemma}
\label{lemma-colimit-surjective}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is surjective,
\item $C_0$ is of finite type over $B_0$.
\end{enumerate}
Then for some $i \geq 0$ the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is surjective.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_m$ be generators for $C_0$ over $B_0$.
Pick $b_j \in A \otimes_{A_0} B_0$ mapping to $1 \otimes x_j$ in
$A \otimes_{A_0} C_0$. For some $i \geq 0$ we can find
$b_{j, i} \in A_i \otimes_{A_0} B_0$ mapping to $b_j$.
Then this $i$ works.
\end{proof}

\begin{lemma}
\label{lemma-colimit-unramified}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is unramified,
\item $C_0$ is of finite type over $B_0$.
\end{enumerate}
Then for some $i \geq 0$ the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is unramified.
\end{lemma}

\begin{proof}
Set $B_i = A_i \otimes_{A_0} B_0$, $C_i = A_i \otimes_{A_0} C_0$,
$B = A \otimes_{A_0} B_0$, and $C = A \otimes_{A_0} C_0$.
Let $x_1, \ldots, x_m$ be generators for $C_0$ over $B_0$.
Then $\text{d}x_1, \ldots, \text{d}x_m$ generate $\Omega_{C_0/B_0}$
over $C_0$ and their images generate $\Omega_{C_i/B_i}$ over $C_i$
(Lemmas \ref{lemma-differentials-polynomial-ring} and
\ref{lemma-differential-seq}).
Observe that $0 = \Omega_{C/B} = \colim \Omega_{C_i/B_i}$
(Lemma \ref{lemma-colimit-differentials}).
Thus there is an $i$ such that $\text{d}x_1, \ldots, \text{d}x_m$
map to zero and hence $\Omega_{C_i/B_i} = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-colimit-isomorphism}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is
an isomorphism,
\item $B_0 \to C_0$ is of finite presentation.
\end{enumerate}
Then for some $i \geq 0$ the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is
an isomorphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-colimit-surjective} there exists an $i$ such that
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is
surjective. Since the map is of finite presentation
the kernel is a finitely generated ideal. Let
$g_1, \ldots, g_r \in A_i \otimes_{A_0} B_0$ generate the kernel.
Then we may pick $i' \geq i$ such that $g_j$ map to zero
in $A_{i'} \otimes_{A_0} B_0$. Then
$A_{i'} \otimes_{A_0} B_0 \to A_{i'} \otimes_{A_0} C_0$ is
an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-colimit-etale}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is \'etale,
\item $B_0 \to C_0$ is of finite presentation.
\end{enumerate}
Then for some $i \geq 0$ the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is \'etale.
\end{lemma}

\begin{proof}
Write $C_0 = B_0[x_1, \ldots, x_n]/(f_{1, 0}, \ldots, f_{m, 0})$.
Write $B_i = A_i \otimes_{A_0} B_0$ and $C_i = A_i \otimes_{A_0} C_0$.
Note that $C_i = B_i[x_1, \ldots, x_n]/(f_{1, i}, \ldots, f_{m, i})$
where $f_{j, i}$ is the image of $f_{j, 0}$ in the polynomial ring
over $B_i$. Write $B = A \otimes_{A_0} B_0$ and $C = A \otimes_{A_0} C_0$.
Note that $C = B[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
where $f_j$ is the image of $f_{j, 0}$ in the polynomial ring
over $B$. The assumption is that the map
$$
\text{d} :
(f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2
\longrightarrow
\bigoplus C \text{d}x_k
$$
is an isomorphism. Thus for sufficiently large $i$ we can find elements
$$
\xi_{k, i} \in (f_{1, i}, \ldots, f_{m, i})/(f_{1, i}, \ldots, f_{m, i})^2
$$
with $\text{d}\xi_{k, i} = \text{d}x_k$ in $\bigoplus C_i \text{d}x_k$.
Moreover, on increasing $i$ if necessary, we see that
$\sum (\partial f_{j, i}/\partial x_k) \xi_{k, i} =
f_{j, i} \bmod (f_{1, i}, \ldots, f_{m, i})^2$
since this is true in the limit. Then this $i$ works.
\end{proof}

\begin{lemma}
\label{lemma-colimit-smooth}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is smooth,
\item $B_0 \to C_0$ is of finite presentation.
\end{enumerate}
Then for some $i \geq 0$ the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is smooth.
\end{lemma}

\begin{proof}
Write $C_0 = B_0[x_1, \ldots, x_n]/(f_{1, 0}, \ldots, f_{m, 0})$.
Write $B_i = A_i \otimes_{A_0} B_0$ and $C_i = A_i \otimes_{A_0} C_0$.
Note that $C_i = B_i[x_1, \ldots, x_n]/(f_{1, i}, \ldots, f_{m, i})$
where $f_{j, i}$ is the image of $f_{j, 0}$ in the polynomial ring
over $B_i$. Write $B = A \otimes_{A_0} B_0$ and $C = A \otimes_{A_0} C_0$.
Note that $C = B[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
where $f_j$ is the image of $f_{j, 0}$ in the polynomial ring
over $B$. The assumption is that the map
$$
\text{d} :
(f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2
\longrightarrow
\bigoplus C \text{d}x_k
$$
is a split injection. Let $\xi_k \in (f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2$
be elements such that $\sum (\partial f_j/\partial x_k) \xi_k =
f_j \bmod (f_1, \ldots, f_m)^2$. Then for sufficiently large $i$ we can
find elements
$$
\xi_{k, i} \in (f_{1, i}, \ldots, f_{m, i})/(f_{1, i}, \ldots, f_{m, i})^2
$$
with $\sum (\partial f_{j, i}/\partial x_k) \xi_{k, i} =
f_{j, i} \bmod (f_{1, i}, \ldots, f_{m, i})^2$
since this is true in the limit. Then this $i$ works.
\end{proof}

\begin{lemma}
\label{lemma-colimit-lci}
Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings.
Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras.
Assume
\begin{enumerate}
\item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is
syntomic (resp.\ a relative global complete intersection),
\item $C_0$ is of finite presentation over $B_0$.
\end{enumerate}
Then there exists an $i \geq 0$ such that the map
$A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is syntomic (resp.\ a relative global complete intersection).
\end{lemma}

\begin{proof}
Assume $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is a relative
global complete intersection.
By Lemma \ref{lemma-relative-global-complete-intersection-Noetherian}
there exists a finite type $\mathbf{Z}$-algebra $R$,
a ring map $R \to A \otimes_{A_0} B_0$, a relative
global complete intersection $R \to S$, and an isomorphism
$$
(A \otimes_{A_0} B_0) \otimes_R S
\longrightarrow
A \otimes_{A_0} C_0
$$
Because $R$ is of finite type (and hence finite presentation)
over $\mathbf{Z}$, there exists an $i$ and a map
$R \to A_i \otimes_{A_0} B_0$ lifting the map $R \to A \otimes_{A_0} B_0$,
see Lemma \ref{lemma-characterize-finite-presentation}.
Using the same lemma, there exists an $i' \geq i$ such that
$(A_i \otimes_{A_0} B_0) \otimes_R S \to A \otimes_{A_0} C_0$
comes from a map
$(A_i \otimes_{A_0} B_0) \otimes_R S \to A_{i'} \otimes_{A_0} C_0$.
Thus we may assume, after replacing $i$ by $i'$,
that the displayed map comes from an $A_i \otimes_{A_0} B_0$-algebra map
$$
(A_i \otimes_{A_0} B_0) \otimes_R S
\longrightarrow
A_i \otimes_{A_0} C_0
$$
By Lemma \ref{lemma-colimit-isomorphism} after increasing $i$ this
map is an isomorphism. This finishes the proof in this case because the base
change of a relative global complete intersection is a relative
global complete intersection by
Lemma \ref{lemma-base-change-relative-global-complete-intersection}.

\medskip\noindent
Assume $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is syntomic.
Then there exist elements $g_1, \ldots, g_m$ in
$A \otimes_{A_0} C_0$ generating the unit ideal such that
$A \otimes_{A_0} B_0 \to (A \otimes_{A_0} C_0)_{g_j}$ is a
relative global complete intersection, see Lemma \ref{lemma-syntomic}.
We can find an $i$ and elements $g_{i, j} \in A_i \otimes_{A_0} C_0$
mapping to $g_j$. After increasing $i$ we may assume
$g_{i, 1}, \ldots, g_{i, m}$ generate the unit ideal
of $A_i \otimes_{A_0} C_0$. The result of the previous paragraph
implies that, after increasing $i$, we may assume the maps
$A_i \otimes_{A_0} B_0 \to (A_i \otimes_{A_0} C_0)_{g_{i, j}}$
are relative global complete intersections.
Then $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$
is syntomic by Lemma \ref{lemma-local-syntomic}
(and the already used Lemma \ref{lemma-syntomic}).
\end{proof}














\noindent
The following lemma is an application of the results above
which doesn't seem to fit well anywhere else.

\begin{lemma}
\label{lemma-fppf-fpqf}
Let $R \to S$ be a faithfully flat ring map of finite presentation.
Then there exists a commutative diagram
$$
\xymatrix{
S \ar[rr] & & S' \\
& R \ar[lu] \ar[ru]
}
$$
where $R \to S'$ is quasi-finite, faithfully flat and of finite presentation.
\end{lemma}

\begin{proof}
As a first step we reduce this lemma to the case where $R$ is of finite
type over $\mathbf{Z}$.
By Lemma \ref{lemma-descend-faithfully-flat-finite-presentation}
there exists a diagram
$$
\xymatrix{
S_0 \ar[r] & S \\
R_0 \ar[u] \ar[r] & R \ar[u]
}
$$
where $R_0$ is of finite type over $\mathbf{Z}$,
and $S_0$ is faithfully flat of finite presentation over $R_0$
such that $S = R \otimes_{R_0} S_0$.
If we prove the lemma for the ring map $R_0 \to S_0$, then the lemma
follows for $R \to S$ by base change, as the base change of
a quasi-finite ring map is quasi-finite, see
Lemma \ref{lemma-quasi-finite-base-change}. (Of course we
also use that base changes of flat maps are flat and
base changes of maps of finite presentation are of finite presentation.)

\medskip\noindent
Assume $R \to S$ is a faithfully flat ring map of finite presentation
and that $R$ is Noetherian (which we may assume by the preceding
paragraph). Let $W \subset \Spec(S)$ be the open set of
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open}.
As $R \to S$ is faithfully flat the map $\Spec(S) \to \Spec(R)$
is surjective, see Lemma \ref{lemma-ff-rings}.
By Lemma \ref{lemma-generic-CM-flat-finite-presentation}
the map $W \to \Spec(R)$ is also surjective.
Hence by replacing $S$ with a product $S_{g_1} \times \ldots \times S_{g_m}$
we may assume $W = \Spec(S)$; here we use that $\Spec(R)$
is quasi-compact (Lemma \ref{lemma-quasi-compact}), and that the map
$\Spec(S) \to \Spec(R)$ is open
(Proposition \ref{proposition-fppf-open}).
Suppose that $\mathfrak p \subset R$ is a prime. Choose a prime
$\mathfrak q \subset S$ lying over $\mathfrak p$ which corresponds
to a maximal ideal of the fibre ring $S \otimes_R \kappa(\mathfrak p)$.
The Noetherian local ring
$\overline{S}_{\mathfrak q} = S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
is Cohen-Macaulay, say of dimension $d$. We may choose $f_1, \ldots, f_d$
in the maximal ideal of $S_{\mathfrak q}$ which map to a regular sequence
in $\overline{S}_{\mathfrak q}$. Choose a common denominator
$g \in S$, $g \not \in \mathfrak q$ of $f_1, \ldots, f_d$, and consider
the $R$-algebra
$$
S' = S_g/(f_1, \ldots, f_d).
$$
By construction there is a prime ideal $\mathfrak q' \subset S'$
lying over $\mathfrak p$ and corresponding to $\mathfrak q$ (via
$S_g \to S'_g$). Also by construction the ring map $R \to S'$ is
quasi-finite at $\mathfrak q$ as the local ring
$$
S'_{\mathfrak q'}/\mathfrak pS'_{\mathfrak q'} =
S_{\mathfrak q}/(f_1, \ldots, f_d) + \mathfrak pS_{\mathfrak q} =
\overline{S}_{\mathfrak q}/(\overline{f}_1, \ldots, \overline{f}_d)
$$
has dimension zero, see Lemma \ref{lemma-isolated-point-fibre}.
Also by construction $R \to S'$ is of finite presentation.
Finally, by Lemma \ref{lemma-grothendieck-regular-sequence} the local ring map
$R_{\mathfrak p} \to S'_{\mathfrak q'}$ is flat (this is where we
use that $R$ is Noetherian). Hence, by openness of flatness
(Theorem \ref{theorem-openness-flatness}), and openness of quasi-finiteness
(Lemma \ref{lemma-quasi-finite-open})
we may after replacing
$g$ by $gg'$ for a suitable $g' \in S$, $g' \not \in \mathfrak q$
assume that $R \to S'$ is flat and quasi-finite.
The image $\Spec(S') \to \Spec(R)$ is open and
contains $\mathfrak p$. In other words we have shown
a ring $S'$ as in the statement of the lemma exists (except possibly
the faithfulness part) whose image contains any given prime.
Using one more time the quasi-compactness of $\Spec(R)$
we see that a finite product of such rings does the job.
\end{proof}





\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Algebraic Stacks}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This is where we define algebraic stacks and make some very elementary
observations. The general philosophy will be to have no separation
conditions whatsoever and add those conditions necessary to make lemmas,
propositions, theorems true/provable. Thus the notions discussed here
differ slightly from those in other places in the literature, e.g.,
\cite{LM-B}.

\medskip\noindent
This chapter is not an introduction to algebraic stacks.
For an informal discussion of algebraic stacks, please take a look at
Introducing Algebraic Stacks, Section
\ref{stacks-introduction-section-introduction}.


\section{Conventions}
\label{section-conventions}

\noindent
The conventions we use in this chapter are the same as those in the
chapter on algebraic spaces. For convenience we repeat them here.

\medskip\noindent
We work in a suitable big fppf site $\Sch_{fppf}$
as in Topologies, Definition \ref{topologies-definition-big-fppf-site}.
So, if not explicitly stated otherwise all schemes will be objects
of $\Sch_{fppf}$. We discuss what changes if you change the big
fppf site in
Section \ref{section-change-big-site}.

\medskip\noindent
We will always work relative to a base $S$ contained in $\Sch_{fppf}$.
And we will then work with the big fppf site $(\Sch/S)_{fppf}$, see
Topologies, Definition \ref{topologies-definition-big-small-fppf}.
The absolute case can be recovered by taking
$S = \Spec(\mathbf{Z})$.

\medskip\noindent
If $U, T$ are schemes over $S$, then we denote
$U(T)$ for the set of $T$-valued points {\it over} $S$.
In a formula: $U(T) = \Mor_S(T, U)$.

\medskip\noindent
Note that any fpqc covering is a universal effective
epimorphism, see
Descent, Lemma \ref{descent-lemma-fpqc-universal-effective-epimorphisms}.
Hence the topology on $\Sch_{fppf}$
is weaker than the canonical topology and all representable presheaves
are sheaves.








\section{Notation}
\label{section-notation}

\noindent
We use the letters $S, T, U, V, X, Y$ to indicate schemes.
We use the letters $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$ to indicate
categories (fibred, fibred in groupoids, stacks, ...)
over $(\Sch/S)_{fppf}$. We use small case letters
$f$, $g$ for functors such as $f : \mathcal{X} \to \mathcal{Y}$
over $(\Sch/S)_{fppf}$.
We use capital $F$, $G$, $H$ for algebraic spaces over $S$, and more
generally for presheaves of sets on $(\Sch/S)_{fppf}$.
(In future chapters we will revert to using also $X$, $Y$, etc
for algebraic spaces.)

\medskip\noindent
The reason for these choices is that we want to clearly distinguish between
the different types of objects in this chapter, to build the foundations.









\section{Representable categories fibred in groupoids}
\label{section-representable}

\noindent
Let $S$ be a scheme contained in $\Sch_{fppf}$.
The basic object of study in this chapter will be a
category fibred in groupoids
$p : \mathcal{X} \to (\Sch/S)_{fppf}$, see
Categories, Definition \ref{categories-definition-fibred-groupoids}.
We will often simply say ``let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$'' to indicate
this situation. A $1$-morphism $\mathcal{X} \to \mathcal{Y}$ of categories
in groupoids over $(\Sch/S)_{fppf}$ will be a $1$-morphism
in the $2$-category of categories fibred in groupoids over
$(\Sch/S)_{fppf}$, see
Categories,
Definition \ref{categories-definition-categories-fibred-in-groupoids-over-C}.
It is simply a functor $\mathcal{X} \to \mathcal{Y}$ over
$(\Sch/S)_{fppf}$.
We recall this is really a $(2, 1)$-category and that all $2$-fibre products
exist.

\medskip\noindent
Let $\mathcal{X}$ be a category fibred in groupoids over
$(\Sch/S)_{fppf}$. Recall that $\mathcal{X}$
is said to be {\it representable} if there exists a
scheme $U \in \Ob((\Sch/S)_{fppf})$ and an
equivalence
$$
j : \mathcal{X} \longrightarrow (\Sch/U)_{fppf}
$$
of categories over $(\Sch/S)_{fppf}$, see
Categories,
Definition \ref{categories-definition-representable-fibred-category}.
We will sometimes say that $\mathcal{X}$ is
{\it representable by a scheme} to distinguish from the case
where $\mathcal{X}$ is representable by an algebraic space (see
below).

\medskip\noindent
If $\mathcal{X}, \mathcal{Y}$ are fibred in groupoids and
representable by $U, V$, then we have
\begin{equation}
\label{equation-morphisms-schemes}
\Mor_{\textit{Cat}/(\Sch/S)_{fppf}}(\mathcal{X}, \mathcal{Y})
\Big/
2\text{-isomorphism}
=
\Mor_{\Sch/S}(U, V)
\end{equation}
see
Categories,
Lemma \ref{categories-lemma-morphisms-representable-fibred-categories}.
More precisely, any $1$-morphism $\mathcal{X} \to \mathcal{Y}$
gives rise to a morphism $U \to V$. Conversely, given a morphism
of schemes $U \to V$ over $S$ there exists a $1$-morphism
$\phi : \mathcal{X} \to \mathcal{Y}$ which gives rise to $U \to V$
and which is unique up to unique $2$-isomorphism.






\section{The 2-Yoneda lemma}
\label{section-2-yoneda}

\noindent
Let $U \in \Ob((\Sch/S)_{fppf})$, and let $\mathcal{X}$ be a
category fibred in groupoids over $(\Sch/S)_{fppf}$.
We will frequently use the $2$-Yoneda lemma, see
Categories, Lemma \ref{categories-lemma-yoneda-2category}.
Technically it says that there is an equivalence of categories
$$
\Mor_{\textit{Cat}/(\Sch/S)_{fppf}}(
(\Sch/U)_{fppf}, \mathcal{X})
\longrightarrow
\mathcal{X}_U, \quad
f \longmapsto f(U/U).
$$
It says that $1$-morphisms $(\Sch/U)_{fppf} \to \mathcal{X}$
correspond to objects $x$ of the fibre category $\mathcal{X}_U$.
Namely, given a $1$-morphism $f : (\Sch/U)_{fppf} \to \mathcal{X}$
we obtain the object $x = f(U/U) \in \Ob(\mathcal{X}_U)$.
Conversely, given a choice of pullbacks for $\mathcal{X}$ as in
Categories,
Definition \ref{categories-definition-pullback-functor-fibred-category},
and an object $x$ of $\mathcal{X}_U$, we obtain a functor
$(\Sch/U)_{fppf} \to \mathcal{X}$ defined by the rule
$$
(\varphi : V \to U) \longmapsto \varphi^*x
$$
on objects. By abuse of notation we use
$x : (\Sch/U)_{fppf} \to \mathcal{X}$
to indicate this functor. It indeed has the property that $x(U/U) = x$
and moreover, given any other functor $f$ with $f(U/U) = x$ there exists
a unique $2$-isomorphism $x \to f$. In other words the functor $x$
is well determined by the object $x$ up to unique $2$-isomorphism.

\medskip\noindent
We will use this without further mention in the following.





\section{Representable morphisms of categories fibred in groupoids}
\label{section-representable-morphism}


\noindent
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $(\Sch/S)_{fppf}$. Let $f : \mathcal{X} \to \mathcal{Y}$
be a {\it representable $1$-morphism}, see
Categories, Definition
\ref{categories-definition-representable-map-categories-fibred-in-groupoids}.
This means that for every $U \in \Ob((\Sch/S)_{fppf})$ and
any $y \in \Ob(\mathcal{Y}_U)$ the $2$-fibre product
$(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}$
is representable. Choose a representing object $V_y$ and an equivalence
$$
(\Sch/V_y)_{fppf}
\longrightarrow
(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}.
$$
The projection
$(\Sch/V_y)_{fppf} \to
(\Sch/U)_{fppf} \times_\mathcal{Y} \mathcal{Y}
\to (\Sch/U)_{fppf}$
comes from a morphism of schemes $f_y : V_y \to U$, see
Section \ref{section-representable}. We represent this by the diagram
\begin{equation}
\label{equation-representable}
\vcenter{
\xymatrix{
V_y \ar@{~>}[r] \ar[d]_{f_y} &
(\Sch/V_y)_{fppf} \ar[d] \ar[r] &
\mathcal{X} \ar[d]^f \\
U \ar@{~>}[r] &
(\Sch/U)_{fppf} \ar[r]^-y &
\mathcal{Y}
}
}
\end{equation}
where the squiggly arrows represent the $2$-Yoneda embedding.
Here are some lemmas about this notion that work in great generality
(namely, they work for categories fibred in groupoids over any
base category which has fibre products).

\begin{lemma}
\label{lemma-morphism-schemes-gives-representable-transformation}
Let $S$, $X$, $Y$ be objects of $\Sch_{fppf}$.
Let $f : X \to Y$ be a morphism of schemes.
Then the $1$-morphism induced by $f$
$$
(\Sch/X)_{fppf} \longrightarrow (\Sch/Y)_{fppf}
$$
is a representable $1$-morphism.
\end{lemma}

\begin{proof}
This is formal and relies only on the fact that
the category $(\Sch/S)_{fppf}$ has fibre products.
\end{proof}

\begin{lemma}
\label{lemma-representable-morphism-equivalent}
Let $S$ be an object of $\Sch_{fppf}$.
Consider a $2$-commutative diagram
$$
\xymatrix{
\mathcal{X}' \ar[r] \ar[d]_{f'} & \mathcal{X} \ar[d]^f \\
\mathcal{Y}' \ar[r] & \mathcal{Y}
}
$$
of $1$-morphisms of categories fibred in groupoids over
$(\Sch/S)_{fppf}$.
Assume the horizontal arrows are equivalences.
Then $f$ is representable if and only if $f'$ is representable.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-representable-transformations}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$
Let $f : \mathcal{X} \to \mathcal{Y}$, $g : \mathcal{Y} \to \mathcal{Z}$
be representable $1$-morphisms. Then
$$
g \circ f : \mathcal{X} \longrightarrow \mathcal{Z}
$$
is a representable $1$-morphism.
\end{lemma}

\begin{proof}
This is entirely formal and works in any category.
\end{proof}

\begin{lemma}
\label{lemma-base-change-representable-transformations}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$
Let $f : \mathcal{X} \to \mathcal{Y}$ be a representable $1$-morphism.
Let $g : \mathcal{Z} \to \mathcal{Y}$ be any $1$-morphism.
Consider the fibre product diagram
$$
\xymatrix{
\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \ar[r]_-{g'} \ar[d]_{f'} &
\mathcal{X} \ar[d]^f \\
\mathcal{Z} \ar[r]^g & \mathcal{Y}
}
$$
Then the base change $f'$ is a representable $1$-morphism.
\end{lemma}

\begin{proof}
This is entirely formal and works in any category.
\end{proof}

\begin{lemma}
\label{lemma-product-representable-transformations}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}_i, \mathcal{Y}_i$ be categories fibred in groupoids over
$(\Sch/S)_{fppf}$, $i = 1, 2$.
Let $f_i : \mathcal{X}_i \to \mathcal{Y}_i$, $i = 1, 2$
be representable $1$-morphisms.
Then
$$
f_1 \times f_2 :
\mathcal{X}_1 \times \mathcal{X}_2
\longrightarrow
\mathcal{Y}_1 \times \mathcal{Y}_2
$$
is a representable $1$-morphism.
\end{lemma}

\begin{proof}
Write $f_1 \times f_2$ as the composition
$\mathcal{X}_1 \times \mathcal{X}_2 \to
\mathcal{Y}_1 \times \mathcal{X}_2 \to
\mathcal{Y}_1 \times \mathcal{Y}_2$.
The first arrow is the base change of $f_1$ by the map
$\mathcal{Y}_1 \times \mathcal{X}_2 \to \mathcal{Y}_1$, and the second arrow
is the base change of $f_2$ by the map
$\mathcal{Y}_1 \times \mathcal{Y}_2 \to \mathcal{Y}_2$.
Hence this lemma is a formal
consequence of Lemmas \ref{lemma-composition-representable-transformations}
and \ref{lemma-base-change-representable-transformations}.
\end{proof}



\section{Split categories fibred in groupoids}
\label{section-split}

\noindent
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Recall that given a ``presheaf of groupoids''
$$
F : (\Sch/S)_{fppf}^{opp} \longrightarrow \textit{Groupoids}
$$
we get a category fibred in groupoids $\mathcal{S}_F$ over
$(\Sch/S)_{fppf}$, see
Categories, Example \ref{categories-example-functor-groupoids}.
Any category fibred in groupoids isomorphic (!) to one of these
is called a {\it split category fibred in groupoids}.
Any category fibred in groupoids is equivalent to a split one.

\medskip\noindent
If $F$ is a presheaf of sets then $\mathcal{S}_F$ is
fibred in sets, see
Categories,
Definition \ref{categories-definition-category-fibred-sets},
and
Categories, Example \ref{categories-example-presheaf}.
The rule $F \mapsto \mathcal{S}_F$ is in some sense fully faithful
on presheaves, see
Categories, Lemma \ref{categories-lemma-2-category-fibred-sets}.
If $F, G$ are presheaves, then
$$
\mathcal{S}_{F \times G}
=
\mathcal{S}_F \times_{(\Sch/S)_{fppf}} \mathcal{S}_G
$$
and if $F \to H$ and $G \to H$ are maps of presheaves of sets, then
$$
\mathcal{S}_{F \times_H G} =
\mathcal{S}_F \times_{\mathcal{S}_H} \mathcal{S}_G
$$
where the right hand sides are $2$-fibre products. This is immediate
from the definitions as the fibre categories of
$\mathcal{S}_F, \mathcal{S}_G, \mathcal{S}_H$ have only identity morphisms.

\medskip\noindent
An even more special case is where $F = h_X$ is a representable
presheaf. In this case we have
$\mathcal{S}_{h_X} = (\Sch/X)_{fppf}$, see
Categories,
Example \ref{categories-example-fibred-category-from-functor-of-points}.

\medskip\noindent
We will use the notation $\mathcal{S}_F$ without further mention in the
following.




\section{Categories fibred in groupoids representable by algebraic spaces}
\label{section-representable-by-algebraic-spaces}

\noindent
A slightly weaker notion than being representable is the notion of
being representable by algebraic spaces which we discuss in this section.
This discussion might have been avoided had we worked with some category
$\textit{Spaces}_{fppf}$ of algebraic spaces instead of the category
$\Sch_{fppf}$. However, it seems to us natural to consider the
category of schemes as the natural collection of ``test objects'' over
which the fibre categories of an algebraic stack are defined.

\medskip\noindent
In analogy with Categories, Definitions
\ref{categories-definition-representable-fibred-category}
we make the following definition.

\begin{definition}
\label{definition-representable-by-algebraic-space}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
A category fibred in groupoids $p : \mathcal{X} \to (\Sch/S)_{fppf}$
is called {\it representable by an algebraic space over $S$}
if there exists an algebraic space $F$ over $S$ and an equivalence
$j : \mathcal{X} \to \mathcal{S}_F$
of categories over $(\Sch/S)_{fppf}$.
\end{definition}

\noindent
We continue our abuse of notation in suppressing the equivalence $j$
whenever we encounter such a situation.
It follows formally from the above that if $\mathcal{X}$ is
representable (by a scheme), then it is representable by an
algebraic space. Here is the analogue of
Categories,
Lemma \ref{categories-lemma-characterize-representable-fibred-category}.

\begin{lemma}
\label{lemma-characterize-representable-by-space}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $p : \mathcal{X} \to (\Sch/S)_{fppf}$
be a category fibred in groupoids.
Then $\mathcal{X}$ is representable by an algebraic space over $S$
if and only if the following conditions are satisfied:
\begin{enumerate}
\item $\mathcal{X}$ is fibred in setoids\footnote{This means that
it is fibred in groupoids and objects in the fibre categories
have no nontrivial automorphisms, see Categories,
Definition \ref{categories-definition-category-fibred-sets}.}, and
\item the presheaf $U \mapsto \Ob(\mathcal{X}_U)/\!\!\cong$ is
an algebraic space.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted, but see Categories,
Lemma \ref{categories-lemma-characterize-representable-fibred-category}.
\end{proof}

\noindent
If $\mathcal{X}, \mathcal{Y}$ are fibred in groupoids and
representable by algebraic spaces $F, G$ over $S$, then we have
\begin{equation}
\label{equation-morphisms-spaces}
\Mor_{\textit{Cat}/(\Sch/S)_{fppf}}(\mathcal{X}, \mathcal{Y})
\Big/
2\text{-isomorphism}
=
\Mor_{\Sch/S}(F, G)
\end{equation}
see
Categories, Lemma \ref{categories-lemma-2-category-fibred-setoids}.
More precisely, any $1$-morphism $\mathcal{X} \to \mathcal{Y}$
gives rise to a morphism $F \to G$. Conversely, give a morphism
of sheaves $F \to G$ over $S$ there exists a $1$-morphism
$\phi : \mathcal{X} \to \mathcal{Y}$ which gives rise to $F \to G$
and which is unique up to unique $2$-isomorphism.



\section{Morphisms representable by algebraic spaces}
\label{section-morphisms-representable-by-algebraic-spaces}

\noindent
In analogy with Categories, Definition
\ref{categories-definition-representable-map-categories-fibred-in-groupoids}
we make the following definition.

\begin{definition}
\label{definition-representable-by-algebraic-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
A $1$-morphism $f : \mathcal{X} \to \mathcal{Y}$ of
categories fibred in groupoids over $(\Sch/S)_{fppf}$
is called {\it representable by algebraic spaces} if
for any $U \in \Ob((\Sch/S)_{fppf})$
and any $y : (\Sch/U)_{fppf} \to \mathcal{Y}$
the category fibred in groupoids
$$
(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}
$$
over $(\Sch/U)_{fppf}$
is representable by an algebraic space over $U$.
\end{definition}

\noindent
Choose an algebraic space $F_y$ over $U$ which represents
$(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}$.
We may think of $F_y$ as an algebraic space over $S$
which comes equipped with a canonical morphism $f_y : F_y \to U$
over $S$, see
Spaces, Section \ref{spaces-section-change-base-scheme}.
Here is the diagram
\begin{equation}
\label{equation-representable-by-algebraic-spaces}
\vcenter{
\xymatrix{
F_y \ar[d]_{f_y} &
(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}
\ar@{~>}[l] \ar[d]_{\text{pr}_0} \ar[r]_-{\text{pr}_1} &
\mathcal{X} \ar[d]^f \\
U &
(\Sch/U)_{fppf} \ar@{~>}[l] \ar[r]^-y &
\mathcal{Y}
}
}
\end{equation}
where the squiggly arrows represent the construction which associates
to a stack fibred in setoids its associated sheaf of isomorphism classes
of objects. The right square is
$2$-commutative, and is a $2$-fibre product square.

\medskip\noindent
Here is the analogue of Categories,
Lemma \ref{categories-lemma-criterion-representable-map-stack-in-groupoids}.

\begin{lemma}
\label{lemma-criterion-map-representable-spaces-fibred-in-groupoids}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
The following are necessary and sufficient conditions for
$f$ to be representable by algebraic spaces:
\begin{enumerate}
\item for each scheme $U/S$ the
functor $f_U : \mathcal{X}_U \longrightarrow \mathcal{Y}_U$
between fibre categories is faithful, and
\item for each $U$ and each $y \in \Ob(\mathcal{Y}_U)$ the presheaf
$$
(h : V \to U)
\longmapsto
\{(x, \phi) \mid x \in \Ob(\mathcal{X}_V), \phi : h^*y \to f(x)\}/\cong
$$
is an algebraic space over $U$.
\end{enumerate}
Here we have made a choice of pullbacks for $\mathcal{Y}$.
\end{lemma}

\begin{proof}
This follows from the description of fibre categories of the $2$-fibre products
$(\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}$ in
Categories, Lemma \ref{categories-lemma-identify-fibre-product}
combined with
Lemma \ref{lemma-characterize-representable-by-space}.
\end{proof}

\noindent
Here are some lemmas about this notion that work in great generality.

\begin{lemma}
\label{lemma-representable-by-spaces-morphism-equivalent}
Let $S$ be an object of $\Sch_{fppf}$.
Consider a $2$-commutative diagram
$$
\xymatrix{
\mathcal{X}' \ar[r] \ar[d]_{f'} & \mathcal{X} \ar[d]^f \\
\mathcal{Y}' \ar[r] & \mathcal{Y}
}
$$
of $1$-morphisms of categories fibred in groupoids over
$(\Sch/S)_{fppf}$.
Assume the horizontal arrows are equivalences.
Then $f$ is representable by algebraic spaces
if and only if $f'$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-morphism-spaces-gives-representable-by-spaces}
Let $S$ be an object of $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $S$.
If $\mathcal{X}$ and $\mathcal{Y}$ are representable by
algebraic spaces over $S$, then the $1$-morphism $f$
is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Omitted. This relies only on the fact that
the category of algebraic spaces over $S$ has fibre products,
see Spaces, Lemma \ref{spaces-lemma-fibre-product-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-map-presheaves-representable-by-algebraic-spaces}
Let $S$ be an object of $\Sch_{fppf}$.
Let $a : F \to G$ be a map of presheaves of sets on $(\Sch/S)_{fppf}$.
Denote $a' : \mathcal{S}_F  \to \mathcal{S}_G$ the associated
map of categories fibred in sets.
Then $a$ is representable by algebraic spaces (see
Bootstrap,
Definition \ref{bootstrap-definition-morphism-representable-by-spaces})
if and only if $a'$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-map-fibred-setoids-representable-algebraic-spaces}
Let $S$ be an object of $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of
categories fibred in setoids over $(\Sch/S)_{fppf}$.
Let $F$, resp.\ $G$ be the presheaf which to $T$ associates
the set of isomorphism classes of objects of
$\mathcal{X}_T$, resp.\ $\mathcal{Y}_T$.
Let $a : F \to G$ be the map of presheaves corresponding to $f$.
Then $a$ is representable by algebraic spaces (see
Bootstrap,
Definition \ref{bootstrap-definition-morphism-representable-by-spaces})
if and only if $f$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Omitted. Hint: Combine
Lemmas \ref{lemma-representable-by-spaces-morphism-equivalent}
and \ref{lemma-map-presheaves-representable-by-algebraic-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-representable-by-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
representable by algebraic spaces.
Let $g : \mathcal{Z} \to \mathcal{Y}$ be any $1$-morphism.
Consider the fibre product diagram
$$
\xymatrix{
\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \ar[r]_-{g'} \ar[d]_{f'} &
\mathcal{X} \ar[d]^f \\
\mathcal{Z} \ar[r]^g & \mathcal{Y}
}
$$
Then the base change $f'$ is a $1$-morphism representable by
algebraic spaces.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-by-space-representable-by-space}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$
Let $f : \mathcal{X} \to \mathcal{Y}$,
$g : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms.
Assume
\begin{enumerate}
\item $f$ is representable by algebraic spaces, and
\item $\mathcal{Z}$ is representable by an algebraic space over $S$.
\end{enumerate}
Then the $2$-fibre product
$\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X}$
is representable by an algebraic space.
\end{lemma}

\begin{proof}
This is a reformulation of
Bootstrap, Lemma \ref{bootstrap-lemma-representable-by-spaces-over-space}.
First note that
$\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X}$
is fibred in setoids over $(\Sch/S)_{fppf}$.
Hence it is equivalent to $\mathcal{S}_F$ for some presheaf
$F$ on $(\Sch/S)_{fppf}$, see
Categories, Lemma \ref{categories-lemma-setoid-fibres}.
Moreover, let $G$ be an algebraic space which represents
$\mathcal{Z}$. The $1$-morphism
$\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \to \mathcal{Z}$
is representable by algebraic spaces by
Lemma \ref{lemma-base-change-representable-by-spaces}.
And $\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \to \mathcal{Z}$
corresponds to a morphism $F \to G$ by
Categories, Lemma \ref{categories-lemma-2-category-fibred-setoids}.
Then $F \to G$ is representable by algebraic spaces by
Lemma \ref{lemma-map-fibred-setoids-representable-algebraic-spaces}.
Hence
Bootstrap, Lemma \ref{bootstrap-lemma-representable-by-spaces-over-space}
implies that $F$ is an algebraic space as desired.
\end{proof}

\noindent
Let $S$, $\mathcal{X}$, $\mathcal{Y}$, $\mathcal{Z}$, $f$, $g$ be as in
Lemma \ref{lemma-base-change-by-space-representable-by-space}.
Let $F$ and $G$ be algebraic spaces over $S$ such that
$F$ represents $\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X}$
and $G$ represents $\mathcal{Z}$. The $1$-morphism
$f' : \mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \to \mathcal{Z}$
corresponds to a morphism $f' : F \to G$ of algebraic spaces
by (\ref{equation-morphisms-spaces}).
Thus we have the following diagram
\begin{equation}
\label{equation-representable-by-algebraic-spaces-on-space}
\vcenter{
\xymatrix{
F \ar[d]_{f'} &
\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X}
\ar@{~>}[l] \ar[d] \ar[r] &
\mathcal{X} \ar[d]^f \\
G &
\mathcal{Z} \ar@{~>}[l] \ar[r]^-g &
\mathcal{Y}
}
}
\end{equation}
where the squiggly arrows represent the construction which associates
to a stack fibred in setoids its associated sheaf of isomorphism classes
of objects.

\begin{lemma}
\label{lemma-composition-representable-by-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$.
If $f : \mathcal{X} \to \mathcal{Y}$, $g : \mathcal{Y} \to \mathcal{Z}$
are $1$-morphisms representable by algebraic spaces, then
$$
g \circ f : \mathcal{X} \longrightarrow \mathcal{Z}
$$
is a $1$-morphism representable by algebraic spaces.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-base-change-by-space-representable-by-space}.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-product-representable-by-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}_i, \mathcal{Y}_i$ be categories fibred in groupoids over
$(\Sch/S)_{fppf}$, $i = 1, 2$.
Let $f_i : \mathcal{X}_i \to \mathcal{Y}_i$, $i = 1, 2$
be $1$-morphisms representable by algebraic spaces.
Then
$$
f_1 \times f_2 :
\mathcal{X}_1 \times \mathcal{X}_2
\longrightarrow
\mathcal{Y}_1 \times \mathcal{Y}_2
$$
is a $1$-morphism representable by algebraic spaces.
\end{lemma}

\begin{proof}
Write $f_1 \times f_2$ as the composition
$\mathcal{X}_1 \times \mathcal{X}_2 \to
\mathcal{Y}_1 \times \mathcal{X}_2 \to
\mathcal{Y}_1 \times \mathcal{Y}_2$.
The first arrow is the base change of $f_1$ by the map
$\mathcal{Y}_1 \times \mathcal{X}_2 \to \mathcal{Y}_1$, and the second arrow
is the base change of $f_2$ by the map
$\mathcal{Y}_1 \times \mathcal{Y}_2 \to \mathcal{Y}_2$.
Hence this lemma is a formal
consequence of Lemmas \ref{lemma-composition-representable-by-spaces}
and \ref{lemma-base-change-representable-by-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-get-a-stack}
\begin{reference}
Lemma in an email of Matthew Emerton dated June 15, 2016
\end{reference}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X} \to \mathcal{Z}$ and $\mathcal{Y} \to \mathcal{Z}$
be $1$-morphisms of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
If $\mathcal{X} \to \mathcal{Z}$ is representable by algebraic spaces
and $\mathcal{Y}$ is a stack in groupoids, then
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y}$ is a stack in groupoids.
\end{lemma}

\begin{proof}
The property of a morphism being representable by algebraic spaces
is preserved under base-change
(Lemma \ref{lemma-base-change-by-space-representable-by-space}),
and so, passing to the base-change
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y}$ over $\mathcal{Y}$,
we may reduce to the case of a morphism of categories
fibred in groupoids $\mathcal{X} \to \mathcal{Y}$
which is representable by algebraic spaces, and
whose target is a stack in groupoids; our goal is then to prove
that $\mathcal{X}$ is also a stack in groupoids.
This follows from Stacks, Lemma
\ref{stacks-lemma-relative-sheaf-over-stack-is-stack}
whose assumptions are satisfied as a result of
Lemma \ref{lemma-criterion-map-representable-spaces-fibred-in-groupoids}.
\end{proof}







\section{Properties of morphisms representable by algebraic spaces}
\label{section-representable-properties}

\noindent
Here is the definition that makes this work.

\begin{definition}
\label{definition-relative-representable-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume $f$ is representable by algebraic spaces.
Let $\mathcal{P}$ be a property of morphisms of algebraic spaces which
\begin{enumerate}
\item is preserved under any base change, and
\item is fppf local on the base, see
Descent on Spaces,
Definition \ref{spaces-descent-definition-property-morphisms-local}.
\end{enumerate}
In this case we say that $f$ has {\it property $\mathcal{P}$} if for every
$U \in \Ob((\Sch/S)_{fppf})$ and
any $y \in \mathcal{Y}_U$ the resulting morphism of algebraic spaces
$f_y : F_y \to U$, see
diagram (\ref{equation-representable-by-algebraic-spaces}),
has property $\mathcal{P}$.
\end{definition}

\noindent
It is important to note that we will only use this definition for
properties of morphisms that are stable under base change, and
local in the fppf topology on the target. This is
not because the definition doesn't make sense otherwise; rather it
is because we may want to give a different definition which is
better suited to the property we have in mind.

\begin{lemma}
\label{lemma-property-morphism-equivalent}
Let $S$ be an object of $\Sch_{fppf}$.
Let $\mathcal{P}$ be as in
Definition \ref{definition-relative-representable-property}.
Consider a $2$-commutative diagram
$$
\xymatrix{
\mathcal{X}' \ar[r] \ar[d]_{f'} & \mathcal{X} \ar[d]^f \\
\mathcal{Y}' \ar[r] & \mathcal{Y}
}
$$
of $1$-morphisms of categories fibred in groupoids over
$(\Sch/S)_{fppf}$.
Assume the horizontal arrows are equivalences and $f$ (or equivalently $f'$)
is representably by algebraic spaces.
Then $f$ has $\mathcal{P}$ if and only if $f'$ has $\mathcal{P}$.
\end{lemma}

\begin{proof}
Note that this makes sense by
Lemma \ref{lemma-representable-by-spaces-morphism-equivalent}.
Proof omitted.
\end{proof}

\noindent
Here is a sanity check.

\begin{lemma}
\label{lemma-map-presheaves-representable-by-spaces-transformation-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $a : F \to G$ be a map of presheaves on $(\Sch/S)_{fppf}$.
Let $\mathcal{P}$ be as in
Definition \ref{definition-relative-representable-property}.
Assume $a$ is representable by algebraic spaces.
Then $a : F \to G$ has property $\mathcal{P}$ (see
Bootstrap, Definition \ref{bootstrap-definition-property-transformation})
if and only if the corresponding morphism
$\mathcal{S}_F \to \mathcal{S}_G$ of categories fibred in groupoids
has property $\mathcal{P}$.
\end{lemma}

\begin{proof}
Note that the lemma makes sense by
Lemma \ref{lemma-map-presheaves-representable-by-algebraic-spaces}.
Proof omitted.
\end{proof}

\begin{lemma}
\label{lemma-map-fibred-setoids-property}
Let $S$ be an object of $\Sch_{fppf}$. Let $\mathcal{P}$ be as in
Definition \ref{definition-relative-representable-property}.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of
categories fibred in setoids over $(\Sch/S)_{fppf}$.
Let $F$, resp.\ $G$ be the presheaf which to $T$ associates
the set of isomorphism classes of objects of
$\mathcal{X}_T$, resp.\ $\mathcal{Y}_T$.
Let $a : F \to G$ be the map of presheaves corresponding to $f$.
Then $a$ has $\mathcal{P}$ if and only if $f$ has $\mathcal{P}$.
\end{lemma}

\begin{proof}
The lemma makes sense by
Lemma \ref{lemma-map-fibred-setoids-representable-algebraic-spaces}.
The lemma follows on combining
Lemmas \ref{lemma-property-morphism-equivalent}
and \ref{lemma-map-presheaves-representable-by-spaces-transformation-property}.
\end{proof}

\begin{lemma}
\label{lemma-composition-representable-transformations-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$, $\mathcal{Y}$, $\mathcal{Z}$ be categories fibred
in groupoids over $(\Sch/S)_{fppf}$.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-relative-representable-property}
which is stable under composition.
Let $f : \mathcal{X} \to \mathcal{Y}$,
$g : \mathcal{Y} \to \mathcal{Z}$ be $1$-morphisms which
are representable by algebraic spaces.
If $f$ and $g$ have property $\mathcal{P}$ so does
$g \circ f : \mathcal{X} \to \mathcal{Z}$.
\end{lemma}

\begin{proof}
Note that the lemma makes sense by
Lemma \ref{lemma-composition-representable-by-spaces}.
Proof omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-representable-transformations-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-relative-representable-property}.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
representable by algebraic spaces.
Let $g : \mathcal{Z} \to \mathcal{Y}$ be any $1$-morphism.
Consider the $2$-fibre product diagram
$$
\xymatrix{
\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \ar[r]_-{g'} \ar[d]_{f'} &
\mathcal{X} \ar[d]^f \\
\mathcal{Z} \ar[r]^g & \mathcal{Y}
}
$$
If $f$ has $\mathcal{P}$, then the base change $f'$
has $\mathcal{P}$.
\end{lemma}

\begin{proof}
The lemma makes sense by
Lemma \ref{lemma-base-change-representable-by-spaces}.
Proof omitted.
\end{proof}

\begin{lemma}
\label{lemma-descent-representable-transformations-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
be categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-relative-representable-property}.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
representable by algebraic spaces.
Let $g : \mathcal{Z} \to \mathcal{Y}$ be any $1$-morphism.
Consider the fibre product diagram
$$
\xymatrix{
\mathcal{Z} \times_{g, \mathcal{Y}, f} \mathcal{X} \ar[r]_-{g'} \ar[d]_{f'} &
\mathcal{X} \ar[d]^f \\
\mathcal{Z} \ar[r]^g & \mathcal{Y}
}
$$
Assume that for every scheme $U$ and object $x$ of $\mathcal{Y}_U$,
there exists an fppf covering $\{U_i \to U\}$ such that $x|_{U_i}$
is in the essential image of the functor
$g : \mathcal{Z}_{U_i} \to \mathcal{Y}_{U_i}$.
In this case, if $f'$ has $\mathcal{P}$, then $f$ has $\mathcal{P}$.
\end{lemma}

\begin{proof}
Proof omitted. Hint: Compare with the proof of
Spaces,
Lemma \ref{spaces-lemma-descent-representable-transformations-property}.
\end{proof}

\begin{lemma}
\label{lemma-product-representable-transformations-property}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-relative-representable-property}
which is stable under composition.
Let $\mathcal{X}_i, \mathcal{Y}_i$ be categories fibred in groupoids over
$(\Sch/S)_{fppf}$, $i = 1, 2$.
Let $f_i : \mathcal{X}_i \to \mathcal{Y}_i$, $i = 1, 2$
be $1$-morphisms representable by algebraic spaces.
If $f_1$ and $f_2$ have property $\mathcal{P}$ so does
$
f_1 \times f_2 :
\mathcal{X}_1 \times \mathcal{X}_2
\to
\mathcal{Y}_1 \times \mathcal{Y}_2
$.
\end{lemma}

\begin{proof}
The lemma makes sense by
Lemma \ref{lemma-product-representable-by-spaces}.
Proof omitted.
\end{proof}

\begin{lemma}
\label{lemma-representable-transformations-property-implication}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $(\Sch/S)_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism representable
by algebraic spaces.
Let $\mathcal{P}$, $\mathcal{P}'$ be properties as in
Definition \ref{definition-relative-representable-property}.
Suppose that for any morphism of algebraic spaces $a : F \to G$
we have $\mathcal{P}(a) \Rightarrow \mathcal{P}'(a)$.
If $f$ has property $\mathcal{P}$ then
$f$ has property $\mathcal{P}'$.
\end{lemma}

\begin{proof}
Formal.
\end{proof}

\begin{lemma}
\label{lemma-open-fibred-category-is-full}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $j : \mathcal X \to \mathcal Y$ be a $1$-morphism of
categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume $j$ is representable by algebraic spaces and a monomorphism
(see
Definition \ref{definition-relative-representable-property}
and
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-monomorphism}).
Then $j$ is fully faithful on fibre categories.
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-criterion-map-representable-spaces-fibred-in-groupoids}
that $j$ is faithful on fibre categories. Consider a scheme $U$,
two objects $u, v$ of $\mathcal{X}_U$, and an isomorphism
$t : j(u) \to j(v)$ in $\mathcal{Y}_U$. We have to construct an
isomorphism in $\mathcal{X}_U$ between $u$ and $v$.
By the $2$-Yoneda lemma (see Section \ref{section-2-yoneda})
we think of $u$, $v$ as $1$-morphisms
$u, v : (\Sch/U)_{fppf} \to \mathcal{X}$
and we consider the $2$-fibre product
$$
(\Sch/U)_{fppf} \times_{j \circ v, \mathcal{Y}} \mathcal{X}.
$$
By assumption this is representable by an algebraic space
$F_{j \circ v}$, over $U$ and the morphism
$F_{j \circ v} \to U$ is a monomorphism.
But since $(1_U, v, 1_{j(v)})$ gives a $1$-morphism of
$(\Sch/U)_{fppf}$ into the displayed $2$-fibre product,
we see that $F_{j \circ v} = U$ (here we use
that if $V \to U$ is a monomorphism of algebraic spaces which has a
section, then $V = U$). Therefore the $1$-morphism projecting to
the first coordinate
$$
(\Sch/U)_{fppf} \times_{j \circ v, \mathcal{Y}} \mathcal{X}
\to (\Sch/U)_{fppf}
$$
is an equivalence of fibre categories.
Since $(1_U, u, t)$ and $(1_U, v, 1_{j(v)})$ give two
objects in $((\Sch/U)_{fppf} \times_{j \circ v, \mathcal{Y}}
\mathcal{X})_U$ which have the same first coordinate, there must
be a $2$-morphism between them in the $2$-fibre product.
This is by definition a morphism $\tilde t : u \to v$ such that
$j(\tilde t) = t$.
\end{proof}

\noindent
Here is a characterization of those categories fibred in groupoids
for which the diagonal is representable by algebraic spaces.

\begin{lemma}
\label{lemma-representable-diagonal}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be a category fibred in groupoids over
$(\Sch/S)_{fppf}$. The following are equivalent:
\begin{enumerate}
\item the diagonal $\mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces,
\item for every scheme $U$ over $S$, and any
$x, y \in \Ob(\mathcal{X}_U)$ the sheaf
$\mathit{Isom}(x, y)$ is representable by an algebraic space over $U$,
\item for every scheme $U$ over $S$, and any $x \in \Ob(\mathcal{X}_U)$
the associated $1$-morphism $x : (\Sch/U)_{fppf} \to \mathcal{X}$
is representable by algebraic spaces,
\item for every pair of schemes $T_1, T_2$ over $S$, and any
$x_i \in \Ob(\mathcal{X}_{T_i})$, $i = 1, 2$ the $2$-fibre product
$(\Sch/T_1)_{fppf} \times_{x_1, \mathcal{X}, x_2}
(\Sch/T_2)_{fppf}$
is representable by an algebraic space,
\item for every representable category fibred in groupoids $\mathcal{U}$
over $(\Sch/S)_{fppf}$ every $1$-morphism
$\mathcal{U} \to \mathcal{X}$ is representable by algebraic spaces,
\item for every pair $\mathcal{T}_1, \mathcal{T}_2$ of representable
categories fibred in groupoids over $(\Sch/S)_{fppf}$ and any
$1$-morphisms $x_i : \mathcal{T}_i \to \mathcal{X}$, $i = 1, 2$ the
$2$-fibre product $\mathcal{T}_1 \times_{x_1, \mathcal{X}, x_2} \mathcal{T}_2$
is representable by an algebraic space,
\item for every category fibred in groupoids $\mathcal{U}$
over $(\Sch/S)_{fppf}$ which is
representable by an algebraic space every $1$-morphism
$\mathcal{U} \to \mathcal{X}$ is representable by algebraic spaces,
\item for every pair $\mathcal{T}_1, \mathcal{T}_2$ of categories fibred
in groupoids over $(\Sch/S)_{fppf}$ which are representable
by algebraic spaces, and any $1$-morphisms
$x_i : \mathcal{T}_i \to \mathcal{X}$ the
$2$-fibre product $\mathcal{T}_1 \times_{x_1, \mathcal{X}, x_2} \mathcal{T}_2$
is representable by an algebraic space.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) follows from
Stacks, Lemma \ref{stacks-lemma-isom-as-2-fibre-product}
and the definitions.
Let us prove the equivalence of (1) and (3).
Write $\mathcal{C} = (\Sch/S)_{fppf}$ for the base category.
We will use some of the observations of the proof of the similar
Categories, Lemma \ref{categories-lemma-representable-diagonal-groupoids}.
We will use the symbol $\cong$ to mean ``equivalence of categories fibred
in groupoids over $\mathcal{C} = (\Sch/S)_{fppf}$''.
Assume (1). Suppose given $U$ and $x$ as in (3). For any scheme $V$
and $y \in \Ob(\mathcal{X}_V)$ we see (compare reference above) that
$$
\mathcal{C}/U
\times_{x, \mathcal{X}, y}
\mathcal{C}/V
\cong
(\mathcal{C}/U \times_S V)
\times_{(x, y), \mathcal{X} \times \mathcal{X}, \Delta}
\mathcal{X}
$$
which is representable by an algebraic space by assumption. Conversely,
assume (3). Consider any scheme $U$ over $S$ and a pair $(x, x')$
of objects of $\mathcal{X}$ over $U$. We have to show that
$\mathcal{X} \times_{\Delta, \mathcal{X} \times \mathcal{X}, (x, x')} U$
is representable by an algebraic space. This is clear because
(compare reference above)
$$
\mathcal{X}
\times_{\Delta, \mathcal{X} \times \mathcal{X}, (x, x')}
\mathcal{C}/U
\cong
(\mathcal{C}/U \times_{x, \mathcal{X}, x'} \mathcal{C}/U)
\times_{\mathcal{C}/U \times_S U, \Delta}
\mathcal{C}/U
$$
and the right hand side is representable by an algebraic space by assumption
and the fact that the category of algebraic spaces over $S$ has fibre products
and contains $U$ and $S$.

\medskip\noindent
The equivalences
(3) $\Leftrightarrow$ (4),
(5) $\Leftrightarrow$ (6),
and
(7) $\Leftrightarrow$ (8)
are formal. The equivalences
(3) $\Leftrightarrow$ (5) and
(4) $\Leftrightarrow$ (6)
follow from
Lemma \ref{lemma-representable-by-spaces-morphism-equivalent}.
Assume (3), and let $\mathcal{U} \to \mathcal{X}$ be as in (7).
To prove (7) we have to show that for every scheme $V$ and $1$-morphism
$y : (\Sch/V)_{fppf} \to \mathcal{X}$ the $2$-fibre product
$(\Sch/V)_{fppf} \times_{y, \mathcal{X}} \mathcal{U}$
is representable by an algebraic space. Property (3) tells us
that $y$ is representable by algebraic spaces hence
Lemma \ref{lemma-base-change-by-space-representable-by-space}
implies what we want. Finally, (7) directly implies (3).
\end{proof}

\noindent
In the situation of the lemma, for any $1$-morphism
$x : (\Sch/U)_{fppf} \to \mathcal{X}$ as in the lemma, it makes sense
to say that $x$ has property $\mathcal{P}$, for any property as in
Definition \ref{definition-relative-representable-property}.
In particular this holds for
$\mathcal{P} = $ ``surjective'',
$\mathcal{P} = $ ``smooth'', and
$\mathcal{P} = $ ``\'etale'',
see
Descent on Spaces,
Lemmas \ref{spaces-descent-lemma-descending-property-surjective},
\ref{spaces-descent-lemma-descending-property-smooth}, and
\ref{spaces-descent-lemma-descending-property-etale}.
We will use these three cases in the definitions
of algebraic stacks below.








\section{Stacks in groupoids}
\label{section-stacks}

\noindent
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Recall that a category $p : \mathcal{X} \to (\Sch/S)_{fppf}$
over $(\Sch/S)_{fppf}$ is said to be a
{\it stack in groupoids} (see
Stacks, Definition \ref{stacks-definition-stack-in-groupoids})
if and only if
\begin{enumerate}
\item $p : \mathcal{X} \to \mathcal{C}$ is fibred
in groupoids over $(\Sch/S)_{fppf}$,
\item for all $U \in \Ob((\Sch/S)_{fppf})$,
for all $x, y\in \Ob(\mathcal{X}_U)$ the presheaf
$\mathit{Isom}(x, y)$ is a sheaf on the site $(\Sch/U)_{fppf}$, and
\item for all coverings $\mathcal{U} = \{U_i \to U\}$ in
$(\Sch/S)_{fppf}$, all descent data $(x_i, \phi_{ij})$
for $\mathcal{U}$ are effective.
\end{enumerate}
For examples see
Examples of Stacks,
Section \ref{examples-stacks-section-examples-stacks-in-groupoids}
ff.










\section{Algebraic stacks}
\label{section-algebraic-stacks}

\noindent
Here is the definition of an algebraic stack. We remark that condition
(2) implies we can make sense out of the condition in part (3) that
$(\Sch/U)_{fppf} \to \mathcal{X}$
is smooth and surjective, see discussion following
Lemma \ref{lemma-representable-diagonal}.

\begin{definition}
\label{definition-algebraic-stack}
Let $S$ be a base scheme contained in $\Sch_{fppf}$.
An {\it algebraic stack over $S$} is a category
$$
p : \mathcal{X} \to (\Sch/S)_{fppf}
$$
over $(\Sch/S)_{fppf}$ with the following properties:
\begin{enumerate}
\item The category $\mathcal{X}$ is a stack in groupoids over
$(\Sch/S)_{fppf}$.
\item The diagonal
$\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces.
\item There exists a scheme $U \in \Ob((\Sch/S)_{fppf})$
and a $1$-morphism $(\Sch/U)_{fppf} \to \mathcal{X}$
which is surjective and smooth\footnote{In future chapters we will denote
this simply $U \to \mathcal{X}$ as is customary in the literature. Another
good alternative would be to formulate this condition as the existence of a
representable category fibred in groupoids $\mathcal{U}$ and a surjective
smooth $1$-morphism $\mathcal{U} \to \mathcal{X}$.}.
\end{enumerate}
\end{definition}

\noindent
There are some differences with other definitions found in the literature.

\medskip\noindent
The first is that we require $\mathcal{X}$ to be a stack in groupoids
in the fppf topology, whereas in many references the \'etale topology is
used. It somehow seems to us that the fppf topology is the natural topology
to work with. In the end the resulting $2$-category of algebraic stacks
ends up being the same. This is explained in
Criteria for Representability, Section \ref{criteria-section-stacks-etale}.

\medskip\noindent
The second is that we only require the diagonal map of $\mathcal{X}$ to be
representable by algebraic spaces, whereas in most references some other
conditions are imposed. Our point of view is to try to prove a certain
number of the results that follow only assuming that the diagonal
of $\mathcal{X}$ be representable by algebraic spaces, and simply add
an additional hypothesis wherever this is necessary. It has the added
benefit that any algebraic space (as defined in
Spaces, Definition \ref{spaces-definition-algebraic-space})
gives rise to an algebraic stack.

\medskip\noindent
The third is that in some papers it is required that there exists a
scheme $U$ and a surjective and \'etale morphism $U \to \mathcal{X}$.
In the groundbreaking paper \cite{DM} where algebraic stacks were first
introduced Deligne and Mumford used this definition and showed that
the moduli stack of stable genus $g > 1$ curves is an algebraic stack
which has an \'etale covering by a scheme. Michael Artin, see
\cite{ArtinVersal}, realized that many
natural results on algebraic stacks generalize to the case where one
only assume a smooth covering by a scheme. Hence our choice above.
To distinguish the two cases one sees the terms ``Deligne-Mumford stack''
and ``Artin stack'' used in the literature. We will reserve the term
``Artin stack'' for later use (insert future reference here), and continue
to use ``algebraic stack'', but we will use ``Deligne-Mumford stack''
to indicate those algebraic stacks which have an \'etale covering by a
scheme.

\begin{definition}
\label{definition-deligne-mumford}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be an algebraic stack over $S$.
We say $\mathcal{X}$ is a {\it Deligne-Mumford stack} if there exists
a scheme $U$ and a surjective \'etale morphism
$(\Sch/U)_{fppf} \to \mathcal{X}$.
\end{definition}

\noindent
We will compare our notion of a Deligne-Mumford stack with
the notion as defined in the paper by Deligne and Mumford later
(see insert future reference here).

\medskip\noindent
The category of algebraic stacks over $S$ forms a $2$-category.
Here is the precise definition.

\begin{definition}
\label{definition-morphism-algebraic-stacks}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
The {\it $2$-category of algebraic stacks over $S$} is the
sub $2$-category of the $2$-category of categories fibred in
groupoids over $(\Sch/S)_{fppf}$ (see
Categories,
Definition \ref{categories-definition-categories-fibred-in-groupoids-over-C})
defined as follows:
\begin{enumerate}
\item Its objects are those categories fibred in groupoids
over $(\Sch/S)_{fppf}$ which are algebraic stacks over $S$.
\item Its $1$-morphisms $f : \mathcal{X} \to \mathcal{Y}$ are
any functors of categories over $(\Sch/S)_{fppf}$, as in
Categories, Definition \ref{categories-definition-categories-over-C}.
\item Its $2$-morphisms are transformations between functors
over $(\Sch/S)_{fppf}$, as in
Categories, Definition \ref{categories-definition-categories-over-C}.
\end{enumerate}
\end{definition}

\noindent
In other words this $2$-category is the full sub $2$-category of
$\textit{Cat}/(\Sch/S)_{fppf}$ whose objects are algebraic stacks.
Note that every $2$-morphism is automatically an isomorphism.
Hence this is actually a $(2, 1)$-category and not just a $2$-category.

\medskip\noindent
We will see later (insert future reference here) that this $2$-category
has $2$-fibre products.

\medskip\noindent
Similar to the remark above the $2$-category of algebraic stacks over $S$ is a
full sub $2$-category of the $2$-category of categories fibred in groupoids
over $(\Sch/S)_{fppf}$. It turns out that it is closed under
equivalences. Here is the precise statement.

\begin{lemma}
\label{lemma-equivalent}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories over $(\Sch/S)_{fppf}$.
Assume $\mathcal{X}$, $\mathcal{Y}$ are equivalent as categories over
$(\Sch/S)_{fppf}$. Then $\mathcal{X}$ is an algebraic stack if and
only if $\mathcal{Y}$ is an algebraic stack. Similarly, $\mathcal{X}$
is a Deligne-Mumford stack if and only if $\mathcal{Y}$ is a Deligne-Mumford
stack.
\end{lemma}

\begin{proof}
Assume $\mathcal{X}$ is an algebraic stack (resp.\ a Deligne-Mumford stack). By
Stacks, Lemma \ref{stacks-lemma-stack-in-groupoids-equivalent}
this implies that $\mathcal{Y}$ is a stack in groupoids over
$\Sch_{fppf}$. Choose an equivalence $f : \mathcal{X} \to \mathcal{Y}$
over $\Sch_{fppf}$. This gives a $2$-commutative diagram
$$
\xymatrix{
\mathcal{X} \ar[r]_f \ar[d]_{\Delta_\mathcal{X}} &
\mathcal{Y} \ar[d]^{\Delta_\mathcal{Y}} \\
\mathcal{X} \times \mathcal{X} \ar[r]^{f \times f} &
\mathcal{Y} \times \mathcal{Y}
}
$$
whose horizontal arrows are equivalences. This implies that
$\Delta_\mathcal{Y}$ is representable by algebraic spaces according to
Lemma \ref{lemma-representable-by-spaces-morphism-equivalent}.
Finally, let $U$ be a scheme over $S$, and let
$x : (\Sch/U)_{fppf} \to \mathcal{X}$ be a $1$-morphism which
is surjective and smooth (resp.\ \'etale). Considering the diagram
$$
\xymatrix{
(\Sch/U)_{fppf} \ar[r]_{\text{id}} \ar[d]_x &
(\Sch/U)_{fppf} \ar[d]^{f \circ x} \\
\mathcal{X} \ar[r]^f &
\mathcal{Y}
}
$$
and applying
Lemma \ref{lemma-property-morphism-equivalent}
we conclude that $x \circ f$ is surjective and smooth (resp.\ \'etale)
as desired.
\end{proof}




\section{Algebraic stacks and algebraic spaces}
\label{section-stacks-spaces}

\noindent
In this section we discuss some simple criteria which imply that an
algebraic stack is an algebraic space. The main result is that this
happens exactly when objects of fibre categories have no nontrivial
automorphisms. This is not a triviality! Before we come to this
we first do a sanity check.

\begin{lemma}
\label{lemma-representable-algebraic}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
\begin{enumerate}
\item A category fibred in groupoids
$p : \mathcal{X} \to (\Sch/S)_{fppf}$
which is representable by an algebraic space is a Deligne-Mumford stack.
\item If $F$ is an algebraic space over $S$, then the associated
category fibred in groupoids
$p : \mathcal{S}_F \to (\Sch/S)_{fppf}$
is a Deligne-Mumford stack.
\item If $X \in \Ob((\Sch/S)_{fppf})$, then
$(\Sch/X)_{fppf} \to (\Sch/S)_{fppf}$ is
a Deligne-Mumford stack.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (3).
Parts (1) and (2) are equivalent by Lemma \ref{lemma-equivalent}.
Hence it suffices to prove (2).
First, we note that $\mathcal{S}_F$ is stack in sets since
$F$ is a sheaf (Stacks, Lemma
\ref{stacks-lemma-stack-in-setoids-characterize}).
A fortiori it is a stack in groupoids. Second the diagonal
morphism $\mathcal{S}_F \to \mathcal{S}_F  \times \mathcal{S}_F$
is the same as the morphism $\mathcal{S}_F \to \mathcal{S}_{F \times F}$
which comes from the diagonal of $F$. Hence this is representable
by algebraic spaces according to
Lemma \ref{lemma-morphism-spaces-gives-representable-by-spaces}.
Actually it is even representable (by schemes), as the diagonal of
an algebraic space is representable, but we do not need this.
Let $U$ be a scheme and let $h_U \to F$ be a surjective \'etale morphism.
We may think of this a surjective \'etale morphism of algebraic spaces.
Hence by
Lemma
\ref{lemma-map-presheaves-representable-by-spaces-transformation-property}
the corresponding $1$-morphism $(\Sch/U)_{fppf} \to \mathcal{S}_F$
is surjective and \'etale.
\end{proof}

\noindent
The following result says that a Deligne-Mumford stack whose inertia
is trivial ``is'' an algebraic space. This lemma will be obsoleted by
the stronger
Proposition \ref{proposition-algebraic-stack-no-automorphisms}
below which says that this holds more generally for algebraic stacks...

\begin{lemma}
\label{lemma-algebraic-stack-no-automorphisms}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be an algebraic stack over $S$.
The following are equivalent
\begin{enumerate}
\item $\mathcal{X}$ is a Deligne-Mumford stack and is a stack in setoids,
\item $\mathcal{X}$ is a Deligne-Mumford stack such that the
canonical $1$-morphism $\mathcal{I}_\mathcal{X} \to \mathcal{X}$
is an equivalence, and
\item $\mathcal{X}$ is representable by an algebraic space.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) follows from
Stacks, Lemma \ref{stacks-lemma-characterize-stack-in-setoids}.
The implication (3) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-representable-algebraic}.
Finally, assume (1). By
Stacks, Lemma \ref{stacks-lemma-stack-in-setoids-characterize}
there exists a sheaf $F$ on $(\Sch/S)_{fppf}$
and an equivalence $j : \mathcal{X} \to \mathcal{S}_F$. By
Lemma \ref{lemma-map-presheaves-representable-by-algebraic-spaces}
the fact that $\Delta_\mathcal{X}$ is representable by algebraic
spaces, means that $\Delta_F : F \to F \times F$
is representable by algebraic spaces.
Let $U$ be a scheme, and let $x : (\Sch/U)_{fppf} \to \mathcal{X}$
be a surjective \'etale morphism. The composition
$j \circ x : (\Sch/U)_{fppf} \to \mathcal{S}_F$
corresponds to a morphism $h_U \to F$ of sheaves. By
Bootstrap, Lemma \ref{bootstrap-lemma-representable-diagonal}
this morphism is representable by algebraic spaces.
Hence by
Lemma \ref{lemma-map-fibred-setoids-property}
we conclude that $h_U \to F$ is surjective and \'etale.
Finally, we apply
Bootstrap, Theorem \ref{bootstrap-theorem-bootstrap}
to see that $F$ is an algebraic space.
\end{proof}

\begin{proposition}
\label{proposition-algebraic-stack-no-automorphisms}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be an algebraic stack over $S$.
The following are equivalent
\begin{enumerate}
\item $\mathcal{X}$ is a stack in setoids,
\item the canonical $1$-morphism $\mathcal{I}_\mathcal{X} \to \mathcal{X}$
is an equivalence, and
\item $\mathcal{X}$ is representable by an algebraic space.
\end{enumerate}
\end{proposition}

\begin{proof}
The equivalence of (1) and (2) follows from
Stacks, Lemma \ref{stacks-lemma-characterize-stack-in-setoids}.
The implication (3) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-algebraic-stack-no-automorphisms}.
Finally, assume (1). By
Stacks, Lemma \ref{stacks-lemma-stack-in-setoids-characterize}
there exists an equivalence $j : \mathcal{X} \to \mathcal{S}_F$
where $F$ is a sheaf on $(\Sch/S)_{fppf}$.  By
Lemma \ref{lemma-map-presheaves-representable-by-algebraic-spaces}
the fact that $\Delta_\mathcal{X}$ is representable by algebraic
spaces, means that $\Delta_F : F \to F \times F$
is representable by algebraic spaces.
Let $U$ be a scheme and let $x : (\Sch/U)_{fppf} \to \mathcal{X}$
be a surjective smooth morphism. The composition
$j \circ x : (\Sch/U)_{fppf} \to \mathcal{S}_F$
corresponds to a morphism $h_U \to F$ of sheaves. By
Bootstrap, Lemma \ref{bootstrap-lemma-representable-diagonal}
this morphism is representable by algebraic spaces.
Hence by
Lemma \ref{lemma-map-fibred-setoids-property}
we conclude that $h_U \to F$ is surjective and smooth.
In particular it is surjective, flat and locally of finite presentation
(by
Lemma \ref{lemma-representable-transformations-property-implication}
and the fact that a smooth morphism of algebraic spaces is flat and
locally of finite presentation, see
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-smooth-locally-finite-presentation} and
\ref{spaces-morphisms-lemma-smooth-flat}).
Finally, we apply
Bootstrap, Theorem \ref{bootstrap-theorem-final-bootstrap}
to see that $F$ is an algebraic space.
\end{proof}






\section{2-Fibre products of algebraic stacks}
\label{section-2-fibre-products}

\noindent
The $2$-category of algebraic stacks has products and $2$-fibre products.
The first lemma is really a special case of
Lemma \ref{lemma-2-fibre-product}
but its proof is slightly easier.

\begin{lemma}
\label{lemma-product-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$, $\mathcal{Y}$ be algebraic stacks over $S$.
Then $\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$
is an algebraic stack, and is a product in the $2$-category of
algebraic stacks over $S$.
\end{lemma}

\begin{proof}
An object of $\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$
over $T$ is just a pair $(x, y)$ where $x$ is an object of $\mathcal{X}_T$
and $y$ is an object of $\mathcal{Y}_T$. Hence it is immediate from
the definitions that
$\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$ is a
stack in groupoids. If $(x, y)$ and $(x', y')$ are
two objects of $\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$
over $T$, then
$$
\mathit{Isom}((x, y), (x', y')) =
\mathit{Isom}(x, x') \times \mathit{Isom}(y, y').
$$
Hence it follows from the equivalences in
Lemma \ref{lemma-representable-diagonal}
and the fact that the category of algebraic spaces has products
that the diagonal of $\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$
is representable by algebraic spaces.
Finally, suppose that $U, V \in \Ob((\Sch/S)_{fppf})$,
and let $x, y$ be surjective smooth morphisms
$x : (\Sch/U)_{fppf} \to \mathcal{X}$,
$y : (\Sch/Y)_{fppf} \to \mathcal{Y}$.
Note that
$$
(\Sch/U \times_S V)_{fppf} =
(\Sch/U)_{fppf}
\times_{(\Sch/S)_{fppf}} (\Sch/V)_{fppf}.
$$
The object $(\text{pr}_U^*x, \text{pr}_V^*y)$ of
$\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$ over
$(\Sch/U \times_S V)_{fppf}$ thus defines a $1$-morphism
$$
(\Sch/U \times_S V)_{fppf}
\longrightarrow
\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}
$$
which is the composition of base changes of $x$ and $y$, hence
is surjective and smooth, see
Lemmas \ref{lemma-base-change-representable-transformations-property} and
\ref{lemma-composition-representable-transformations-property}.
We conclude that $\mathcal{X} \times_{(\Sch/S)_{fppf}} \mathcal{Y}$
is indeed an algebraic stack. We omit the verification that it
really is a product.
\end{proof}

\begin{lemma}
\label{lemma-2-fibre-product-general}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{Z}$ be a stack in groupoids over $(\Sch/S)_{fppf}$
whose diagonal is representable by algebraic spaces.
Let $\mathcal{X}$, $\mathcal{Y}$ be algebraic stacks over $S$.
Let $f : \mathcal{X} \to \mathcal{Z}$, $g : \mathcal{Y} \to \mathcal{Z}$
be $1$-morphisms of stacks in groupoids. Then the $2$-fibre product
$\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y}$ is an algebraic stack.
\end{lemma}

\begin{proof}
We have to check conditions (1), (2), and (3) of
Definition \ref{definition-algebraic-stack}.
The first condition follows from
Stacks, Lemma \ref{stacks-lemma-2-product-stacks-in-groupoids}.

\medskip\noindent
The second condition we have to check is that the $\mathit{Isom}$-sheaves
are representable by algebraic spaces. To do this, suppose that
$T$ is a scheme over $S$, and $u, v$ are objects of
$(\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y})_T$.
By our construction of $2$-fibre products (which goes all the way
back to
Categories, Lemma \ref{categories-lemma-2-product-categories-over-C})
we may write $u = (x, y, \alpha)$ and $v = (x', y', \alpha')$.
Here $\alpha : f(x) \to g(y)$ and similarly for $\alpha'$.
Then it is clear that
$$
\xymatrix{
\mathit{Isom}(u, v) \ar[d] \ar[rr] & &
\mathit{Isom}(y, y') \ar[d]^{\phi \mapsto g(\phi) \circ \alpha} \\
\mathit{Isom}(x, x') \ar[rr]^-{\psi \mapsto \alpha' \circ f(\psi)} & &
\mathit{Isom}(f(x), g(y'))
}
$$
is a cartesian diagram of sheaves on $(\Sch/T)_{fppf}$.
Since by assumption the sheaves
$\mathit{Isom}(y, y')$, $\mathit{Isom}(x, x')$, $\mathit{Isom}(f(x), g(y'))$
are algebraic spaces (see
Lemma \ref{lemma-representable-diagonal})
we see that $\mathit{Isom}(u, v)$
is an algebraic space.

\medskip\noindent
Let $U, V \in \Ob((\Sch/S)_{fppf})$,
and let $x, y$ be surjective smooth morphisms
$x : (\Sch/U)_{fppf} \to \mathcal{X}$,
$y : (\Sch/Y)_{fppf} \to \mathcal{Y}$.
Consider the morphism
$$
(\Sch/U)_{fppf}
\times_{f \circ x, \mathcal{Z}, g \circ y}
(\Sch/V)_{fppf}
\longrightarrow
\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y}.
$$
As the diagonal of $\mathcal{Z}$ is representable by algebraic spaces
the source of this arrow is representable by an algebraic space $F$, see
Lemma \ref{lemma-representable-diagonal}.
Moreover, the morphism is the composition
of base changes of $x$ and $y$, hence surjective and smooth, see
Lemmas \ref{lemma-base-change-representable-transformations-property} and
\ref{lemma-composition-representable-transformations-property}.
Choosing a scheme $W$ and a surjective \'etale morphism $W \to F$
we see that the composition of the displayed $1$-morphism
with the corresponding $1$-morphism
$$
(\Sch/W)_{fppf}
\longrightarrow
(\Sch/U)_{fppf}
\times_{f \circ x, \mathcal{Z}, g \circ y}
(\Sch/V)_{fppf}
$$
is surjective and smooth which proves the last condition.
\end{proof}

\begin{lemma}
\label{lemma-2-fibre-product}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$ be algebraic stacks over $S$.
Let $f : \mathcal{X} \to \mathcal{Z}$, $g : \mathcal{Y} \to \mathcal{Z}$
be $1$-morphisms of algebraic stacks. Then the $2$-fibre product
$\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y}$ is an algebraic stack.
It is also the $2$-fibre product in the $2$-category of algebraic stacks
over $(\Sch/S)_{fppf}$.
\end{lemma}

\begin{proof}
The fact that $\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y}$ is an
algebraic stack follows from the stronger
Lemma \ref{lemma-2-fibre-product-general}.
The fact that $\mathcal{X} \times_{f, \mathcal{Z}, g} \mathcal{Y}$
is a $2$-fibre product in the $2$-category of algebraic stacks over $S$
follows formally from the fact that the $2$-category of algebraic stacks
over $S$ is a full sub $2$-category of the $2$-category of stacks in
groupoids over $(\Sch/S)_{fppf}$.
\end{proof}







\section{Algebraic stacks, overhauled}
\label{section-overhaul}

\noindent
Some basic results on algebraic stacks.

\begin{lemma}
\label{lemma-lift-morphism-presentations}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of algebraic
stacks over $S$.
Let $V \in \Ob((\Sch/S)_{fppf})$.
Let $y : (\Sch/V)_{fppf} \to \mathcal{Y}$ be surjective and smooth.
Then there exists an object $U \in \Ob((\Sch/S)_{fppf})$
and a $2$-commutative diagram
$$
\xymatrix{
(\Sch/U)_{fppf} \ar[r]_a \ar[d]_x &
(\Sch/V)_{fppf} \ar[d]^y \\
\mathcal{X} \ar[r]^f & \mathcal{Y}
}
$$
with $x$ surjective and smooth.
\end{lemma}

\begin{proof}
First choose $W \in \Ob((\Sch/S)_{fppf})$ and a surjective
smooth $1$-morphism $z : (\Sch/W)_{fppf} \to \mathcal{X}$.
As $\mathcal{Y}$ is an algebraic stack we may choose an equivalence
$$
j :
\mathcal{S}_F
\longrightarrow
(\Sch/W)_{fppf}
\times_{f \circ z, \mathcal{Y}, y}
(\Sch/V)_{fppf}
$$
where $F$ is an algebraic space. By
Lemma \ref{lemma-base-change-representable-transformations-property}
the morphism
$\mathcal{S}_F \to (\Sch/W)_{fppf}$ is surjective and smooth
as a base change of $y$. Hence by
Lemma \ref{lemma-composition-representable-transformations-property}
we see that $\mathcal{S}_F \to \mathcal{X}$ is surjective and smooth.
Choose an object $U \in \Ob((\Sch/S)_{fppf})$
and a surjective \'etale morphism $U \to F$. Then applying
Lemma \ref{lemma-composition-representable-transformations-property}
once more we obtain the desired properties.
\end{proof}

\noindent
This lemma is a generalization of
Proposition \ref{proposition-algebraic-stack-no-automorphisms}.

\begin{lemma}
\label{lemma-characterize-representable-by-algebraic-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of algebraic
stacks over $S$. The following are equivalent:
\begin{enumerate}
\item for $U \in \Ob((\Sch/S)_{fppf})$
the functor $f : \mathcal{X}_U \to \mathcal{Y}_U$ is faithful,
\item the functor $f$ is faithful, and
\item $f$ is representable by algebraic spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1) and (2) are equivalent by general properties of $1$-morphisms
of categories fibred in groupoids, see
Categories, Lemma \ref{categories-lemma-equivalence-fibred-categories}.
We see that (3) implies (2) by
Lemma \ref{lemma-criterion-map-representable-spaces-fibred-in-groupoids}.
Finally, assume (2).
Let $U$ be a scheme. Let $y \in \Ob(\mathcal{Y}_U)$.
We have to prove that
$$
\mathcal{W} = (\Sch/U)_{fppf} \times_{y, \mathcal{Y}} \mathcal{X}
$$
is representable by an algebraic space over $U$. Since
$(\Sch/U)_{fppf}$ is an algebraic stack we see from
Lemma \ref{lemma-2-fibre-product}
that $\mathcal{W}$ is an algebraic stack.
On the other hand the explicit description of objects of $\mathcal{W}$
as triples $(V, x, \alpha : y(V) \to f(x))$ and the fact that $f$ is
faithful, shows that the fibre categories of $\mathcal{W}$ are setoids. Hence
Proposition \ref{proposition-algebraic-stack-no-automorphisms}
guarantees that $\mathcal{W}$ is representable by an algebraic space.
\end{proof}

\begin{lemma}
\label{lemma-smooth-surjective-morphism-implies-algebraic}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $u : \mathcal{U} \to \mathcal{X}$ be a $1$-morphism of
stacks in groupoids over $(\Sch/S)_{fppf}$. If
\begin{enumerate}
\item $\mathcal{U}$ is representable by an algebraic space, and
\item $u$ is representable by algebraic spaces, surjective and smooth,
\end{enumerate}
then $\mathcal X$ is an algebraic stack over $S$.
\end{lemma}

\begin{proof}
We have to show that $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces, see
Definition \ref{definition-algebraic-stack}.
Given two schemes $T_1$, $T_2$ over $S$ denote
$\mathcal{T}_i = (\Sch/T_i)_{fppf}$ the associated representable
fibre categories. Suppose given $1$-morphisms
$f_i : \mathcal{T}_i \to \mathcal{X}$.
According to
Lemma \ref{lemma-representable-diagonal}
it suffices to prove that the $2$-fibered
product $\mathcal{T}_1 \times_\mathcal{X} \mathcal{T}_2$
is representable by an algebraic space. By
Stacks, Lemma
\ref{stacks-lemma-2-fibre-product-stacks-in-setoids-over-stack-in-groupoids}
this is in any case a stack in setoids. Thus
$\mathcal{T}_1 \times_\mathcal{X} \mathcal{T}_2$ corresponds
to some sheaf $F$ on $(\Sch/S)_{fppf}$, see
Stacks, Lemma \ref{stacks-lemma-stack-in-setoids-characterize}.
Let $U$ be the algebraic space which represents $\mathcal{U}$.
By assumption
$$
\mathcal{T}_i' = \mathcal{U} \times_{u, \mathcal{X}, f_i} \mathcal{T}_i
$$
is representable by an algebraic space $T'_i$ over $S$. Hence
$\mathcal{T}_1' \times_\mathcal{U} \mathcal{T}_2'$ is representable
by the algebraic space $T'_1 \times_U T'_2$.
Consider the commutative diagram
$$
\xymatrix{
&
\mathcal{T}_1 \times_{\mathcal X} \mathcal{T}_2 \ar[rr]\ar'[d][dd] & &
\mathcal{T}_1 \ar[dd] \\
\mathcal{T}_1' \times_\mathcal{U} \mathcal{T}_2' \ar[ur]\ar[rr]\ar[dd] & &
\mathcal{T}_1' \ar[ur]\ar[dd] \\
&
\mathcal{T}_2 \ar'[r][rr] & &
\mathcal X \\
\mathcal{T}_2' \ar[rr]\ar[ur] & &
\mathcal{U} \ar[ur] }
$$
In this diagram the bottom square, the right square, the back square, and
the front square are $2$-fibre products. A formal argument then shows
that $\mathcal{T}_1' \times_\mathcal{U} \mathcal{T}_2' \to
\mathcal{T}_1 \times_{\mathcal X} \mathcal{T}_2$
is the ``base change'' of $\mathcal{U} \to \mathcal{X}$, more precisely
the diagram
$$
\xymatrix{
\mathcal{T}_1' \times_\mathcal{U} \mathcal{T}_2' \ar[d] \ar[r] &
\mathcal{U} \ar[d] \\
\mathcal{T}_1 \times_{\mathcal X} \mathcal{T}_2 \ar[r] &
\mathcal{X}
}
$$
is a $2$-fibre square.
Hence $T'_1 \times_U T'_2 \to F$ is representable by algebraic spaces,
smooth, and surjective, see
Lemmas \ref{lemma-map-fibred-setoids-representable-algebraic-spaces},
\ref{lemma-base-change-representable-by-spaces},
\ref{lemma-map-fibred-setoids-property}, and
\ref{lemma-base-change-representable-transformations-property}.
Therefore $F$ is an algebraic space by
Bootstrap, Theorem \ref{bootstrap-theorem-final-bootstrap}
and we win.
\end{proof}

\noindent
An application of
Lemma \ref{lemma-smooth-surjective-morphism-implies-algebraic}
is that something which is an algebraic space over an algebraic stack
is an algebraic stack. This is the analogue of
Bootstrap, Lemma \ref{bootstrap-lemma-representable-by-spaces-over-space}.
Actually, it suffices to assume the morphism
$\mathcal{X} \to \mathcal{Y}$ is ``algebraic'', as we will see in
Criteria for Representability,
Lemma \ref{criteria-lemma-algebraic-morphism-to-algebraic}.

\begin{lemma}
\label{lemma-representable-morphism-to-algebraic}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X} \to \mathcal{Y}$ be a morphism of stacks in groupoids
over $(\Sch/S)_{fppf}$. Assume that
\begin{enumerate}
\item $\mathcal{X} \to \mathcal{Y}$ is representable by algebraic spaces, and
\item $\mathcal{Y}$ is an algebraic stack over $S$.
\end{enumerate}
Then $\mathcal{X}$ is an algebraic stack over $S$.
\end{lemma}

\begin{proof}
Let $\mathcal{V} \to \mathcal{Y}$ be a surjective smooth $1$-morphism
from a representable stack in groupoids to $\mathcal{Y}$. This exists by
Definition \ref{definition-algebraic-stack}.
Then the $2$-fibre product
$\mathcal{U} = \mathcal{V} \times_{\mathcal Y} \mathcal X$
is representable by an algebraic space by
Lemma \ref{lemma-base-change-by-space-representable-by-space}.
The $1$-morphism $\mathcal{U} \to \mathcal X$ is representable by algebraic
spaces, smooth, and surjective, see
Lemmas \ref{lemma-base-change-representable-by-spaces} and
\ref{lemma-base-change-representable-transformations-property}.
By
Lemma \ref{lemma-smooth-surjective-morphism-implies-algebraic}
we conclude that $\mathcal{X}$ is an algebraic stack.
\end{proof}

\begin{lemma}
\label{lemma-open-fibred-category-is-algebraic}
\begin{reference}
Removing the hypothesis that $j$ is a monomorphism was observed
in an email from Matthew Emerton dates June 15, 2016
\end{reference}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $j : \mathcal X \to \mathcal Y$ be a $1$-morphism of
categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume $j$ is representable by algebraic spaces.
Then, if $\mathcal{Y}$ is a stack in groupoids
(resp.\ an algebraic stack), so is $\mathcal{X}$.
\end{lemma}

\begin{proof}
The statement on algebraic stacks will follow from the statement on
stacks in groupoids by Lemma \ref{lemma-representable-morphism-to-algebraic}.
If $j$ is representable by algebraic spaces, then $j$ is
faithful on fibre categories and for each $U$ and each
$y \in \Ob(\mathcal{Y}_U)$ the presheaf
$$
(h : V \to U)
\longmapsto
\{(x, \phi) \mid x \in \Ob(\mathcal{X}_V), \phi : h^*y \to f(x)\}/\cong
$$
is an algebraic space over $U$. See
Lemma \ref{lemma-criterion-map-representable-spaces-fibred-in-groupoids}.
In particular this presheaf is a sheaf and the conclusion follows
from Stacks, Lemma \ref{stacks-lemma-relative-sheaf-over-stack-is-stack}.
\end{proof}



\section{From an algebraic stack to a presentation}
\label{section-stack-to-presentation}

\noindent
Given an algebraic stack over $S$ we obtain a groupoid in algebraic spaces
over $S$ whose associated quotient stack is the algebraic stack.

\medskip\noindent
Recall that if $(U, R, s, t, c)$ is a groupoid in algebraic spaces over $S$
then $[U/R]$ denotes the quotient stack associated to this datum, see
Groupoids in Spaces,
Definition \ref{spaces-groupoids-definition-quotient-stack}.
In general $[U/R]$ is {\bf not} an algebraic stack. In particular the
stack $[U/R]$ occurring in the following lemma is in general not
algebraic.

\begin{lemma}
\label{lemma-map-space-into-stack}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be an algebraic stack over $S$.
Let $\mathcal{U}$ be an algebraic stack over $S$ which
is representable by an algebraic space.
Let $f : \mathcal{U} \to \mathcal{X}$ be a 1-morphism. Then
\begin{enumerate}
\item the $2$-fibre product
$\mathcal{R} = \mathcal{U} \times_{f, \mathcal{X}, f} \mathcal{U}$
is representable by an algebraic space,
\item there is a canonical equivalence
$$
\mathcal{U} \times_{f, \mathcal{X}, f} \mathcal{U}
\times_{f, \mathcal{X}, f} \mathcal{U} =
\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R},
$$
\item the projection $\text{pr}_{02}$ induces via (2) a $1$-morphism
$$
\text{pr}_{02} :
\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R}
\longrightarrow
\mathcal{R}
$$
\item let $U$, $R$ be the algebraic spaces representing
$\mathcal{U}, \mathcal{R}$ and $t, s : R \to U$ and
$c : R \times_{s, U, t} R \to U$ are the morphisms corresponding
to the $1$-morphisms
$\text{pr}_0, \text{pr}_1 : \mathcal{R} \to \mathcal{U}$
and
$\text{pr}_{02} :
\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R} \to
\mathcal{R}$ above, then the quintuple $(U, R, s, t, c)$ is a groupoid in
algebraic spaces over $S$,
\item the morphism $f$ induces a canonical $1$-morphism
$f_{can} : [U/R] \to \mathcal{X}$
of stacks in groupoids over $(\Sch/S)_{fppf}$, and
\item the $1$-morphism $f_{can} : [U/R] \to \mathcal{X}$ is fully faithful.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). By definition $\Delta_\mathcal{X}$ is representable
by algebraic spaces so
Lemma \ref{lemma-representable-diagonal}
applies to show that $\mathcal{U} \to \mathcal{X}$ is representable
by algebraic spaces. Hence the result follows from
Lemma \ref{lemma-base-change-by-space-representable-by-space}.

\medskip\noindent
Let $T$ be a scheme over $S$. By construction of the $2$-fibre product (see
Categories, Lemma \ref{categories-lemma-2-product-categories-over-C})
we see that the objects of the fibre category $\mathcal{R}_T$
are triples $(a, b, \alpha)$ where $a, b \in \Ob(\mathcal{U}_T)$
and $\alpha : f(a) \to f(b)$
is a morphism in the fibre category $\mathcal{X}_T$.

\medskip\noindent
Proof of (2). The equivalence comes from repeatedly applying
Categories, Lemmas \ref{categories-lemma-associativity-2-fibre-product} and
\ref{categories-lemma-2-fibre-product-erase-factor}.
Let us identify
$\mathcal{U} \times_\mathcal{X} \mathcal{U} \times_\mathcal{X} \mathcal{U}$
with
$(\mathcal{U} \times_\mathcal{X} \mathcal{U})
\times_\mathcal{X} \mathcal{U}$.
If $T$ is a scheme over $S$, then on fibre categories over $T$
this equivalence maps the object
$((a, b, \alpha), c, \beta)$ on the left hand side
to the object $((a, b, \alpha), (b, c, \beta))$ of the right hand side.

\medskip\noindent
Proof of (3). The $1$-morphism $\text{pr}_{02}$ is constructed in the proof of
Categories, Lemma \ref{categories-lemma-triple-2-fibre-product-pr02}.
In terms of the description of objects of the fibre category
above we see that $((a, b, \alpha), (b, c, \beta))$
maps to $(a, c, \beta \circ \alpha)$.

\medskip\noindent
Unfortunately, this is {\it not compatible} with our conventions on
groupoids where we always have $j = (t, s) : R \to U$, and we ``think''
of a $T$-valued point $r$ of $R$ as a morphism $r : s(r) \to t(r)$.
However, this does not affect the proof of (4), since the opposite of
a groupoid is a groupoid. But in the proof of (5) it is responsible
for the inverses in the displayed formula below.

\medskip\noindent
Proof of (4). Recall that the sheaf $U$ is isomorphic to the sheaf
$T \mapsto \Ob(\mathcal{U}_T)/\!\cong$, and
similarly for $R$, see
Lemma \ref{lemma-characterize-representable-by-space}.
It follows from
Categories,
Lemma \ref{categories-lemma-category-fibred-setoids-presheaves-products}
that this description is compatible with $2$-fibre products
so we get a similar matching of
$\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R}$
and $R \times_{s, U, t} R$.
The morphisms $t, s : R \to U$ and $c : R \times_{s, U, t} R \to R$
we get from the general equality (\ref{equation-morphisms-spaces}).
Explicitly these maps are the transformations of functors that come
from letting $\text{pr}_0$, $\text{pr}_0$, $\text{pr}_{02}$
act on isomorphism classes of objects of fibre categories.
Hence to show that we obtain a groupoid in algebraic
spaces it suffices to show that for every scheme $T$ over $S$
the structure
$$
(\Ob(\mathcal{U}_T)/\!\cong,
\Ob(\mathcal{R}_T)/\!\cong,
\text{pr}_1, \text{pr}_0, \text{pr}_{02})
$$
is a groupoid which is clear from our description of objects of
$\mathcal{R}_T$ above.

\medskip\noindent
Proof of (5). We will eventually apply
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}
to obtain the functor $[U/R] \to \mathcal{X}$.
Consider the $1$-morphism $f : \mathcal{U} \to \mathcal{X}$.
We have a $2$-arrow $\tau : f \circ \text{pr}_1 \to f \circ \text{pr}_0$
by definition of $\mathcal{R}$ as the $2$-fibre product.
Namely, on an object $(a, b, \alpha)$ of $\mathcal{R}$ over $T$ it is
the map $\alpha^{-1} : b \to a$. We claim that
$$
\tau \circ \text{id}_{\text{pr}_{02}} =
(\tau \star \text{id}_{\text{pr}_0})
\circ
(\tau \star \text{id}_{\text{pr}_1}).
$$
This identity says that given an object
$((a, b, \alpha), (b, c, \beta))$ of
$\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R}$
over $T$, then the composition of
$$
\xymatrix{
c \ar[r]^{\beta^{-1}} & b \ar[r]^{\alpha^{-1}} & a
}
$$
is the same as the arrow $(\beta \circ \alpha)^{-1} : a \to c$. This is
clearly true, hence the claim holds. In this way we see that all the
assumption of
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}
are satisfied for the structure
$(\mathcal{U}, \mathcal{R}, \text{pr}_0, \text{pr}_1, \text{pr}_{02})$
and the $1$-morphism $f$ and the $2$-morphism $\tau$.
Except, to apply the lemma we need to prove this holds
for the structure $(\mathcal{S}_U, \mathcal{S}_R, s, t, c)$
with suitable morphisms.

\medskip\noindent
Now there should be some general abstract nonsense
argument which transfer these data between the two, but it seems to
be quite long. Instead, we use the following trick.
Pick a quasi-inverse $j^{-1} : \mathcal{S}_U \to \mathcal{U}$
of the canonical equivalence $j : \mathcal{U} \to \mathcal{S}_U$ which comes
from $U(T) = \Ob(\mathcal{U}_T)/\!\!\cong$.
This just means that for every scheme $T/S$ and every
object $a \in \mathcal{U}_T$ we have picked out a particular
element of its isomorphism class, namely $j^{-1}(j(a))$.
Using $j^{-1}$ we may therefore see $\mathcal{S}_U$
as a subcategory of $\mathcal{U}$. Having chosen this subcategory
we can consider those objects $(a, b, \alpha)$ of $\mathcal{R}_T$
such that $a, b$ are objects of $(\mathcal{S}_U)_T$, i.e., such
that $j^{-1}(j(a)) = a$ and $j^{-1}(j(b)) = b$. Then it is clear that
this forms a subcategory of $\mathcal{R}$ which maps isomorphically
to $\mathcal{S}_R$ via the canonical equivalence
$\mathcal{R} \to \mathcal{S}_R$. Moreover, this is clearly compatible
with forming the $2$-fibre product
$\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R}$.
Hence we see that we may simply restrict
$f$ to $\mathcal{S}_U$ and restrict $\tau$ to a transformation
between functors $\mathcal{S}_R \to \mathcal{X}$. Hence it is clear that
the displayed equality of
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}
holds since it holds even as an equality of transformations of functors
$\mathcal{R} \times_{\text{pr}_1, \mathcal{U}, \text{pr}_0} \mathcal{R}
\to \mathcal{X}$ before restricting to the subcategory
$\mathcal{S}_{R \times_{s, U, t} R}$.

\medskip\noindent
This proves that
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}
applies and we get our desired morphism of stacks
$f_{can} : [U/R] \to \mathcal{X}$. We briefly spell out how
$f_{can}$ is defined in this special case.
On an object $a$ of $\mathcal{S}_U$ over $T$
we have $f_{can}(a) = f(a)$, where we think of
$\mathcal{S}_U \subset \mathcal{U}$ by the chosen embedding above.
If $a, b$ are objects of $\mathcal{S}_U$ over $T$, then a morphism
$\varphi : a \to b$ in $[U/R]$ is by definition an object of the
form $\varphi = (b, a, \alpha)$ of $\mathcal{R}$ over $T$. (Note
switch.) And the rule in the proof of
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}
is that
\begin{equation}
\label{equation-on-morphisms}
f_{can}(\varphi) = \Big(f(a) \xrightarrow{\alpha^{-1}} f(b)\Big).
\end{equation}
Proof of (6). Both $[U/R]$ and $\mathcal{X}$ are stacks.
Hence given a scheme $T/S$ and objects $a, b$ of $[U/R]$
over $T$ we obtain a transformation of fppf sheaves
$$
\mathit{Isom}(a, b) \longrightarrow \mathit{Isom}(f_{can}(a), f_{can}(b))
$$
on $(\Sch/T)_{fppf}$. We have to show that this is an
isomorphism. We may work fppf locally on $T$, hence we may assume that
$a, b$ come from morphisms $a, b : T \to U$. By the embedding
$\mathcal{S}_U \subset \mathcal{U}$ above we may also think of $a, b$ as
objects of $\mathcal{U}$ over $T$. In
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-morphisms}
we have seen that the left hand sheaf is represented by the algebraic space
$$
R \times_{(t, s), U \times_S U, (b, a)} T
$$
over $T$. On the other hand, the right hand side is by
Stacks, Lemma \ref{stacks-lemma-isom-as-2-fibre-product}
equal to the sheaf associated to the following stack in setoids:
$$
\mathcal{X}
\times_{\mathcal{X} \times \mathcal{X}, (f \circ b, f \circ a)} T =
\mathcal{X}
\times_{\mathcal{X} \times \mathcal{X}, (f, f)}
(\mathcal{U} \times \mathcal{U})
\times_{\mathcal{U} \times \mathcal{U}, (b, a)} T =
\mathcal{R}
\times_{(\text{pr}_0, \text{pr}_1), \mathcal{U} \times \mathcal{U}, (b, a)} T
$$
which is representable by the fibre product displayed above.
At this point we have shown that the two $\mathit{Isom}$-sheaves
are isomorphic. Our $1$-morphism $f_{can} : [U/R] \to \mathcal{X}$ induces
this isomorphism on $\mathit{Isom}$-sheaves by
Equation (\ref{equation-on-morphisms}).
\end{proof}

\noindent
We can use the previous very abstract lemma to produce
presentations.

\begin{lemma}
\label{lemma-stack-presentation}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $\mathcal{X}$ be an algebraic stack over $S$.
Let $U$ be an algebraic space over $S$.
Let $f : \mathcal{S}_U \to \mathcal{X}$ be a surjective smooth morphism.
Let $(U, R, s, t, c)$ be the groupoid in algebraic spaces
and $f_{can} : [U/R] \to \mathcal{X}$ be the result of applying
Lemma \ref{lemma-map-space-into-stack}
to $U$ and $f$. Then
\begin{enumerate}
\item the morphisms $s$, $t$ are smooth, and
\item the $1$-morphism $f_{can} : [U/R] \to \mathcal{X}$
is an equivalence.
\end{enumerate}
\end{lemma}

\begin{proof}
The morphisms $s, t$ are smooth by
Lemmas \ref{lemma-property-morphism-equivalent} and
\ref{lemma-map-presheaves-representable-by-spaces-transformation-property}.
As the $1$-morphism $f$ is smooth and
surjective it is clear that given any scheme $T$ and any object
$a \in \Ob(\mathcal{X}_T)$ there exists a smooth and surjective
morphism $T' \to T$ such that $a|_T'$ comes from an object of
$[U/R]_{T'}$. Since $f_{can} : [U/R] \to \mathcal{X}$
is fully faithful, we deduce that
$[U/R] \to \mathcal{X}$ is essentially surjective as
descent data on objects are effective on both sides, see
Stacks, Lemma \ref{stacks-lemma-characterize-essentially-surjective-when-ff}.
\end{proof}

\begin{remark}
\label{remark-flat-fp-presentation}
If the morphism $f : \mathcal{S}_U \to \mathcal{X}$ of
Lemma \ref{lemma-stack-presentation}
is only assumed surjective, flat and locally of finite presentation, then
it will still be the case that $f_{can} : [U/R] \to \mathcal{X}$ is an
equivalence. In this case the morphisms $s$, $t$ will be flat and
locally of finite presentation, but of course not smooth in general.
\end{remark}

\noindent
Lemma \ref{lemma-stack-presentation}
suggests the following definitions.

\begin{definition}
\label{definition-smooth-groupoid}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
We say $(U, R, s, t, c)$ is a {\it smooth groupoid}\footnote{This terminology
might be a bit confusing: it does not imply that $[U/R]$ is smooth
over anything.}
if $s, t : R \to U$ are smooth morphisms of algebraic spaces.
\end{definition}

\begin{definition}
\label{definition-presentation}
Let $\mathcal{X}$ be an algebraic stack over $S$.
A {\it presentation} of $\mathcal{X}$ is given by a smooth groupoid
$(U, R, s, t, c)$ in algebraic spaces over $S$, and an
equivalence $f : [U/R] \to \mathcal{X}$.
\end{definition}

\noindent
We have seen above that every algebraic stack has a presentation.
Our next task is to show that every smooth groupoid in algebraic
spaces over $S$ gives rise to an algebraic stack.


\section{The algebraic stack associated to a smooth groupoid}
\label{section-smooth-groupoid-gives-algebraic-stack}

\noindent
In this section we start with a smooth groupoid in algebraic spaces
and we show that the associated quotient stack is an algebraic stack.

\begin{lemma}
\label{lemma-diagonal-quotient-stack}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $S$.
Then the diagonal of $[U/R]$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
It suffices to show that the $\mathit{Isom}$-sheaves are algebraic
spaces, see
Lemma \ref{lemma-representable-diagonal}.
This follows from
Bootstrap, Lemma \ref{bootstrap-lemma-quotient-stack-isom}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-quotient-smooth-presentation}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $(U, R, s, t, c)$ be a smooth groupoid in algebraic spaces over $S$.
Then the morphism $\mathcal{S}_U \to [U/R]$ is smooth and surjective.
\end{lemma}

\begin{proof}
Let $T$ be a scheme and let $x : (\Sch/T)_{fppf} \to [U/R]$
be a $1$-morphism. We have to show that the projection
$$
\mathcal{S}_U \times_{[U/R]} (\Sch/T)_{fppf}
\longrightarrow
(\Sch/T)_{fppf}
$$
is surjective and smooth. We already know that the left hand side
is representable by an algebraic space $F$, see
Lemmas \ref{lemma-diagonal-quotient-stack} and
\ref{lemma-representable-diagonal}.
Hence we have to show the corresponding morphism $F \to T$ of
algebraic spaces is surjective and smooth.
Since we are working with properties of morphisms of algebraic
spaces which are local on the target in the fppf topology we
may check this fppf locally on $T$. By construction, there exists
an fppf covering $\{T_i \to T\}$ of $T$ such that
$x|_{(\Sch/T_i)_{fppf}}$ comes from a morphism
$x_i : T_i \to U$. (Note that $F \times_T T_i$ represents the
$2$-fibre product $\mathcal{S}_U \times_{[U/R]} (\Sch/T_i)_{fppf}$
so everything is compatible with the base change via $T_i \to T$.)
Hence we may assume that $x$ comes from $x : T \to U$.
In this case we see that
$$
\mathcal{S}_U \times_{[U/R]} (\Sch/T)_{fppf}
=
(\mathcal{S}_U \times_{[U/R]} \mathcal{S}_U)
\times_{\mathcal{S}_U} (\Sch/T)_{fppf}
=
\mathcal{S}_R \times_{\mathcal{S}_U} (\Sch/T)_{fppf}
$$
The first equality by
Categories, Lemma \ref{categories-lemma-2-fibre-product-erase-factor}
and the second equality by
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-2-cartesian}.
Clearly the last $2$-fibre product is represented by the algebraic
space $F = R \times_{s, U, x} T$ and the projection
$R \times_{s, U, x} T \to T$ is smooth as the base change of
the smooth morphism of algebraic spaces $s : R \to U$.
It is also surjective as $s$ has a section (namely the identity
$e : U \to R$ of the groupoid).
This proves the lemma.
\end{proof}

\noindent
Here is the main result of this section.

\begin{theorem}
\label{theorem-smooth-groupoid-gives-algebraic-stack}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $(U, R, s, t, c)$ be a smooth groupoid in algebraic spaces over $S$.
Then the quotient stack $[U/R]$ is an algebraic stack over $S$.
\end{theorem}

\begin{proof}
We check the three conditions of
Definition \ref{definition-algebraic-stack}.
By construction we have that $[U/R]$ is a stack in groupoids
which is the first condition.

\medskip\noindent
The second condition follows from the stronger
Lemma \ref{lemma-diagonal-quotient-stack}.

\medskip\noindent
Finally, we have to show there exists a scheme $W$ over $S$
and a surjective smooth $1$-morphism
$(\Sch/W)_{fppf} \longrightarrow \mathcal{X}$.
First choose $W \in \Ob((\Sch/S)_{fppf})$ and a
surjective \'etale morphism $W \to U$. Note that this
gives a surjective \'etale morphism $\mathcal{S}_W \to \mathcal{S}_U$
of categories fibred in sets, see
Lemma
\ref{lemma-map-presheaves-representable-by-spaces-transformation-property}.
Of course then $\mathcal{S}_W \to \mathcal{S}_U$ is also surjective and
smooth, see
Lemma \ref{lemma-representable-transformations-property-implication}.
Hence $\mathcal{S}_W \to \mathcal{S}_U \to [U/R]$ is surjective
and smooth by a combination of
Lemmas \ref{lemma-smooth-quotient-smooth-presentation} and
\ref{lemma-composition-representable-transformations-property}.
\end{proof}





\section{Change of big site}
\label{section-change-big-site}

\noindent
In this section we briefly discuss what happens when we change big sites.
The upshot is that we can always enlarge the big site at will, hence we
may assume any set of schemes we want to consider is contained in the big
fppf site over which we consider our algebraic space.
We encourage the reader to skip this section.

\medskip\noindent
Pullbacks of stacks is defined in
Stacks, Section \ref{stacks-section-inverse-image}.

\begin{lemma}
\label{lemma-change-big-site}
Suppose given big sites $\Sch_{fppf}$ and $\Sch'_{fppf}$.
Assume that $\Sch_{fppf}$ is contained in $\Sch'_{fppf}$,
see Topologies, Section \ref{topologies-section-change-alpha}.
Let $S$ be an object of $\Sch_{fppf}$. Let
Let $f : (\Sch'/S)_{fppf} \to (\Sch/S)_{fppf}$ the morphism
of sites corresponding to the inclusion functor
$u : (\Sch/S)_{fppf} \to (\Sch'/S)_{fppf}$.
Let $\mathcal{X}$ be a stack in groupoids over $(\Sch/S)_{fppf}$.
\begin{enumerate}
\item if $\mathcal{X}$ is representable by some
$X \in \Ob((\Sch/S)_{fppf})$, then
$f^{-1}\mathcal{X}$ is representable too, in fact it is representable by the
same scheme $X$, now viewed as an object of $(\Sch'/S)_{fppf}$,
\item if $\mathcal{X}$ is representable by
$F \in \Sh((\Sch/S)_{fppf})$ which is
an algebraic space, then $f^{-1}\mathcal{X}$ is representable
by the algebraic space $f^{-1}F$,
\item if $\mathcal{X}$ is an algebraic stack, then $f^{-1}\mathcal{X}$
is an algebraic stack, and
\item if $\mathcal{X}$ is a Deligne-Mumford stack, then $f^{-1}\mathcal{X}$
is a Deligne-Mumford stack too.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (3). By
Lemma \ref{lemma-stack-presentation}
we may write $\mathcal{X} = [U/R]$ for some smooth
groupoid in algebraic spaces $(U, R, s, t, c)$. By
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-change-big-site}
we see that $f^{-1}[U/R] = [f^{-1}U/f^{-1}R]$.
Of course $(f^{-1}U, f^{-1}R, f^{-1}s, f^{-1}t, f^{-1}c)$
is a smooth groupoid in algebraic spaces too. Hence (3) is proved.

\medskip\noindent
Now the other cases (1), (2), (4) each mean that $\mathcal{X}$ has
a presentation $[U/R]$ of a particular kind, and hence translate into the
same kind of presentation for $f^{-1}\mathcal{X} = [f^{-1}U/f^{-1}R]$.
Whence the lemma is proved.
\end{proof}

\noindent
It is not true (in general) that the restriction of an algebraic space
over the bigger site is an algebraic space over the smaller site (simply
by reasons of cardinality). Hence we can only ever use a simple lemma of this
kind to enlarge the base category and never to shrink it.

\begin{lemma}
\label{lemma-fully-faithful}
Suppose $\Sch_{fppf}$ is contained in $\Sch'_{fppf}$.
Let $S$ be an object of $\Sch_{fppf}$. Denote
$\textit{Algebraic-Stacks}/S$ the $2$-category of algebraic spaces over $S$
defined using $\Sch_{fppf}$. Similarly, denote
$\textit{Algebraic-Stacks}'/S$ the $2$-category of algebraic spaces over $S$
defined using $\Sch'_{fppf}$. The rule
$\mathcal{X} \mapsto f^{-1}\mathcal{X}$ of
Lemma \ref{lemma-change-big-site}
defines a functor of $2$-categories
$$
\textit{Algebraic-Stacks}/S \longrightarrow \textit{Algebraic-Stacks}'/S
$$
which defines equivalences of morphism categories
$$
\Mor_{\textit{Algebraic-Stacks}/S}(\mathcal{X}, \mathcal{Y})
\longrightarrow
\Mor_{\textit{Algebraic-Stacks}'/S}(f^{-1}\mathcal{X}, f^{-1}\mathcal{Y})
$$
for every objects $\mathcal{X}, \mathcal{Y}$ of
$\textit{Algebraic-Stacks}/S$. An object
$\mathcal{X}'$ of $\textit{Algebraic-Stacks}'/S$
is equivalence to $f^{-1}\mathcal{X}$ for some
$\mathcal{X}$ in $\textit{Algebraic-Stacks}/S$
if and only if it has a presentation $\mathcal{X} = [U'/R']$
with $U', R'$ isomorphic to $f^{-1}U$, $f^{-1}R$ for some
$U, R \in \textit{Spaces}/S$.
\end{lemma}

\begin{proof}
The statement on morphism categories is a consequence of the more general
Stacks, Lemma \ref{stacks-lemma-bigger-site}.
The characterization of the ``essential image'' follows from the description
of $f^{-1}$ in the proof of
Lemma \ref{lemma-change-big-site}.
\end{proof}


\section{Change of base scheme}
\label{section-change-base-scheme}

\noindent
In this section we briefly discuss what happens when we change base schemes.
The upshot is that given a morphism $S \to S'$ of base schemes, any algebraic
stack over $S$ can be viewed as an algebraic stack over $S'$.

\begin{lemma}
\label{lemma-category-of-spaces-over-smaller-base-scheme}
Let $\Sch_{fppf}$ be a big fppf site.
Let $S \to S'$ be a morphism of this site.
The constructions A and B of
Stacks, Section \ref{stacks-section-localize}
above give isomorphisms of $2$-categories
$$
\left\{
\begin{matrix}
2\text{-category of algebraic}\\
\text{stacks }\mathcal{X}\text{ over }S
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
2\text{-category of pairs }(\mathcal{X}', f)\text{ consisting of an}\\
\text{algebraic stack }\mathcal{X}'\text{ over }S'\text{ and a morphism}\\
f : \mathcal{X}' \to (\Sch/S)_{fppf}\text{ of algebraic stacks over }S'
\end{matrix}
\right\}
$$
\end{lemma}

\begin{proof}
The statement makes sense as the functor
$j : (\Sch/S)_{fppf} \to (\Sch/S')_{fppf}$
is the localization functor associated to the object $S/S'$
of $(\Sch/S')_{fppf}$. By
Stacks, Lemma \ref{stacks-lemma-localize-stacks}
the only thing to show is that the constructions A and B
preserve the subcategories of algebraic stacks.
For example, if $\mathcal{X} = [U/R]$ then construction A
applied to $\mathcal{X}$ just produces
$\mathcal{X}' = \mathcal{X}$. Conversely, if $\mathcal{X}' = [U'/R']$
the morphism $p$ induces morphisms of algebraic spaces
$U' \to S$ and $R' \to S$, and then $\mathcal{X} = [U'/R']$
but now viewed as a stack over $S$. Hence the lemma is clear.
\end{proof}

\begin{definition}
\label{definition-viewed-as}
Let $\Sch_{fppf}$ be a big fppf site.
Let $S \to S'$ be a morphism of this site.
If $p : \mathcal{X} \to (\Sch/S)_{fppf}$
is an algebraic stack over $S$, then
$\mathcal{X}$ {\it viewed as an algebraic stack over $S'$}
is the algebraic stack
$$
\mathcal{X} \longrightarrow (\Sch/S')_{fppf}
$$
gotten by applying construction A of
Lemma \ref{lemma-category-of-spaces-over-smaller-base-scheme}
to $\mathcal{X}$.
\end{definition}

\noindent
Conversely, what if we start with an algebraic stack $\mathcal{X}'$
over $S'$ and we want to get an algebraic stack over $S$?
Well, then we consider the $2$-fibre product
$$
\mathcal{X}'_S
=
(\Sch/S)_{fppf} \times_{(\Sch/S')_{fppf}} \mathcal{X}'
$$
which is an algebraic stack over $S'$ according to
Lemma \ref{lemma-2-fibre-product}.
Moreover, it comes equipped with a natural $1$-morphism
$p : \mathcal{X}'_S \to (\Sch/S)_{fppf}$ and hence by
Lemma \ref{lemma-category-of-spaces-over-smaller-base-scheme}
it corresponds in a canonical way to an algebraic stack over $S$.

\begin{definition}
\label{definition-change-of-base}
Let $\Sch_{fppf}$ be a big fppf site.
Let $S \to S'$ be a morphism of this site.
Let $\mathcal{X}'$ be an algebraic stack over $S'$.
The {\it change of base of $\mathcal{X}'$} is the
algebraic space $\mathcal{X}'_S$ over $S$ described above.
\end{definition}




\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Artin's axioms}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Artin's axioms for the representability of
functors by algebraic spaces. As references we suggest the papers
\cite{ArtinI}, \cite{ArtinII}, \cite{ArtinVersal}.

\medskip\noindent
Some of the notation, conventions and terminology in this chapter is awkward
and may seem backwards to the more experienced reader. This is intentional.
Please see Quot, Section \ref{quot-section-introduction} for an
explanation.






\section{Conventions}
\label{section-conventions}

\noindent
The conventions we use in this chapter are the same as those in the
chapter on algebraic stacks, see
Algebraic Stacks, Section \ref{algebraic-section-conventions}.
In this chapter the base scheme $S$ will often be locally Noetherian
(although we will always reiterate this condition when stating
results).





\section{Predeformation categories}
\label{section-predeformation-categories}

\noindent
Let $S$ be a locally Noetherian base scheme. Let
$$
p : \mathcal{X} \longrightarrow (\Sch/S)_{fppf}
$$
be a category fibred in groupoids. Let $k$ be a field
and let $\Spec(k) \to S$ be a morphism of finite type (see
Morphisms, Lemma \ref{morphisms-lemma-point-finite-type}). We will sometimes
simply say that {\it $k$ is a field of finite type over $S$}. Let
$x_0$ be an object of $\mathcal{X}$ lying over $\Spec(k)$.
Given $S$, $\mathcal{X}$, $k$, and $x_0$ we will construct a
predeformation category, as defined in
Formal Deformation Theory,
Definition \ref{formal-defos-definition-predeformation-category}.
The construction will resemble the construction of
Formal Deformation Theory,
Remark \ref{formal-defos-remark-localize-cofibered-groupoid}.

\medskip\noindent
First, by Morphisms, Lemma \ref{morphisms-lemma-point-finite-type}
we may pick an affine open $\Spec(\Lambda) \subset S$ such that
$\Spec(k) \to S$ factors through $\Spec(\Lambda)$ and the associated
ring map $\Lambda \to k$ is finite. This provides us with the category
$\mathcal{C}_\Lambda$, see
Formal Deformation Theory, Definition \ref{formal-defos-definition-CLambda}.
The category $\mathcal{C}_\Lambda$, up to canonical equivalence,
does not depend on the choice of the affine open $\Spec(\Lambda)$ of $S$.
Namely, $\mathcal{C}_\Lambda$ is equivalent to the opposite
of the category of factorizations
\begin{equation}
\label{equation-factor}
\Spec(k) \to \Spec(A) \to S
\end{equation}
of the structure morphism such that $A$ is an Artinian local ring and
such that $\Spec(k) \to \Spec(A)$ corresponds to a ring map $A \to k$ which
identifies $k$ with the residue field of $A$.

\medskip\noindent
We let $\mathcal{F} = \mathcal{F}_{\mathcal{X}, k, x_0}$ be the
category whose
\begin{enumerate}
\item objects are morphisms $x_0 \to x$ of $\mathcal{X}$ where
$p(x) = \Spec(A)$ with $A$ an Artinian local ring and
$p(x_0) \to p(x) \to S$ a factorization as in (\ref{equation-factor}), and
\item morphisms $(x_0 \to x) \to (x_0 \to x')$ are commutative
diagrams
$$
\xymatrix{
x & & x' \ar[ll] \\
& x_0 \ar[lu] \ar[ru]
}
$$
in $\mathcal{X}$. (Note the reversal of arrows.)
\end{enumerate}
If $x_0 \to x$ is an object of $\mathcal{F}$ then writing $p(x) = \Spec(A)$
we obtain an object $A$ of $\mathcal{C}_\Lambda$. We often say that
$x_0 \to x$ or $x$ lies over $A$. A morphism of $\mathcal{F}$ between objects
$x_0 \to x$ lying over $A$ and $x_0 \to x'$ lying over $A'$
corresponds to a morphism $x' \to x$ of $\mathcal{X}$, hence a morphism
$p(x' \to x) : \Spec(A') \to \Spec(A)$ which in turn corresponds to a
ring map $A \to A'$. As $\mathcal{X}$ is a category
over the category of schemes over $S$ we see that $A \to A'$ is
$\Lambda$-algebra homomorphism. Thus we obtain a functor
\begin{equation}
\label{equation-predeformation-category}
p : \mathcal{F} = \mathcal{F}_{\mathcal{X}, k, x_0}
\longrightarrow
\mathcal{C}_\Lambda.
\end{equation}
We will use the notation $\mathcal{F}(A)$ to denote the fibre category
over an object $A$ of $\mathcal{C}_\Lambda$. An object of $\mathcal{F}(A)$
is simply a morphism $x_0 \to x$ of $\mathcal{X}$ such that
$x$ lies over $\Spec(A)$ and $x_0 \to x$ lies over $\Spec(k) \to \Spec(A)$.

\begin{lemma}
\label{lemma-predeformation-category}
The functor $p : \mathcal{F} \to \mathcal{C}_\Lambda$ defined above
is a predeformation category.
\end{lemma}

\begin{proof}
We have to show that $\mathcal{F}$ is (a) cofibred in groupoids over
$\mathcal{C}_\Lambda$ and (b) that $\mathcal{F}(k)$ is a category equivalent
to a category with a single object and a single morphism.

\medskip\noindent
Proof of (a). The fibre categories of $\mathcal{F}$
over $\mathcal{C}_\Lambda$ are groupoids as the fibre categories
of $\mathcal{X}$ are groupoids. Let $A \to A'$ be a morphism of
$\mathcal{C}_\Lambda$ and let $x_0 \to x$ be an object of $\mathcal{F}(A)$.
Because $\mathcal{X}$ is fibred in groupoids, we can find a morphism
$x' \to x$ lying over $\Spec(A') \to \Spec(A)$. Since the composition
$A \to A' \to k$ is equal the given map $A \to k$ we see (by uniqueness
of pullbacks up to isomorphism) that the pullback via $\Spec(k) \to \Spec(A')$
of $x'$ is $x_0$, i.e., that there exists a morphism $x_0 \to x'$
lying over $\Spec(k) \to \Spec(A')$ compatible with
$x_0 \to x$ and $x' \to x$. This proves that $\mathcal{F}$ has
pushforwards. We conclude by (the dual of)
Categories, Lemma \ref{categories-lemma-fibred-groupoids}.

\medskip\noindent
Proof of (b). If $A = k$, then $\Spec(k) = \Spec(A)$ and since $\mathcal{X}$
is fibred in groupoids over $(\Sch/S)_{fppf}$ we see that given any object
$x_0 \to x$ in $\mathcal{F}(k)$ the morphism $x_0 \to x$ is an isomorphism.
Hence every object of $\mathcal{F}(k)$ is isomorphic to $x_0 \to x_0$.
Clearly the only self morphism of $x_0 \to x_0$ in $\mathcal{F}$ is
the identity.
\end{proof}

\noindent
Let $S$ be a locally Noetherian base scheme. Let
$F : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism between categories
fibred in groupoids over $(\Sch/S)_{fppf}$. Let $k$ is a field
of finite type over $S$. Let $x_0$ be an object of $\mathcal{X}$ lying
over $\Spec(k)$. Set $y_0 = F(x_0)$ which is an object of $\mathcal{Y}$
lying over $\Spec(k)$. Then $F$ induces a functor
\begin{equation}
\label{equation-functoriality}
F :
\mathcal{F}_{\mathcal{X}, k, x_0}
\longrightarrow
\mathcal{F}_{\mathcal{Y}, k, y_0}
\end{equation}
of categories cofibred over $\mathcal{C}_\Lambda$. Namely, to the object
$x_0 \to x$ of $\mathcal{F}_{\mathcal{X}, k, x_0}(A)$ we associate
the object $F(x_0) \to F(x)$ of $\mathcal{F}_{\mathcal{Y}, k, y_0}(A)$.

\begin{lemma}
\label{lemma-formally-smooth-on-deformation-categories}
Let $S$ be a locally Noetherian scheme. Let $F : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume either
\begin{enumerate}
\item $p$ is formally smooth on objects (Criteria for Representability,
Section \ref{criteria-section-formally-smooth}),
\item $p$ is representable by algebraic spaces and formally smooth, or
\item $p$ is representable by algebraic spaces and smooth.
\end{enumerate}
Then for every finite type field $k$ over $S$ and object
$x_0$ of $\mathcal{X}$ over $k$ the functor (\ref{equation-functoriality})
is smooth in the sense of
Formal Deformation Theory, Definition
\ref{formal-defos-definition-smooth-morphism}.
\end{lemma}

\begin{proof}
Case (1) is a matter of unwinding the definitions.
Assumption (2) implies (1) by
Criteria for Representability, Lemma
\ref{criteria-lemma-representable-by-spaces-formally-smooth}.
Assumption (3) implies (2) by
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-smooth-formally-smooth}
and the principle of
Algebraic Stacks, Lemma
\ref{algebraic-lemma-representable-transformations-property-implication}.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-deformation-categories}
Let $S$ be a locally Noetherian scheme. Let
$$
\xymatrix{
\mathcal{W} \ar[d] \ar[r] & \mathcal{Z} \ar[d] \\
\mathcal{X} \ar[r] & \mathcal{Y}
}
$$
be a $2$-fibre product of categories fibred in groupoids over
$(\Sch/S)_{fppf}$. Let $k$ be a finite type field over $S$ and
$w_0$ an object of $\mathcal{W}$ over $k$. Let $x_0, z_0, y_0$ be
the images of $w_0$ under the morphisms in the diagram. Then
$$
\xymatrix{
\mathcal{F}_{\mathcal{W}, k, w_0} \ar[d] \ar[r] &
\mathcal{F}_{\mathcal{Z}, k, z_0} \ar[d] \\
\mathcal{F}_{\mathcal{X}, k, x_0} \ar[r] & \mathcal{F}_{\mathcal{Y}, k, y_0}
}
$$
is a fibre product of predeformation categories.
\end{lemma}

\begin{proof}
This is a matter of unwinding the definitions. Details omitted.
\end{proof}






\section{Pushouts and stacks}
\label{section-pushouts}

\noindent
In this section we show that algebraic stacks behave well with
respect to certain pushouts. The results in this section hold over
any base scheme.

\medskip\noindent
The following lemma is also correct when $Y$, $X'$, $X$, $Y'$ are
algebraic spaces, see (insert future reference here).

\begin{lemma}
\label{lemma-pushout}
Let $S$ be a scheme. Let
$$
\xymatrix{
X \ar[r] \ar[d] & X' \ar[d] \\
Y \ar[r] & Y'
}
$$
be a pushout in the category of schemes over $S$ where $X \to X'$
is a thickening and $X \to Y$ is affine, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
Let $\mathcal{Z}$ be an algebraic stack over $S$.
Then the functor of fibre categories
$$
\mathcal{Z}_{Y'}
\longrightarrow
\mathcal{Z}_Y \times_{\mathcal{Z}_X} \mathcal{Z}_{X'}
$$
is an equivalence of categories.
\end{lemma}

\begin{proof}
Let $y'$ be an object of left hand side. The sheaf
$\mathit{Isom}(y', y')$ on the category of schemes over $Y'$
is representable by an algebraic space $I$ over $Y'$, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
We conclude that the functor of the lemma is fully faithful as
$Y'$ is the pushout in the category of algebraic spaces as
well as the category of schemes, see
Pushouts of Spaces, Lemma
\ref{spaces-pushouts-lemma-pushout-along-thickening-schemes}.

\medskip\noindent
Let $(y, x', f)$ be an object of the right hand side. Here $f : y|_X \to x'|_X$
is an isomorphism. To finish the proof we have to construct an object $y'$ of
$\mathcal{Z}_{Y'}$ whose restrictions to $Y$ and $X'$ agree with $y$ and $x'$
in a manner compatible with $\varphi$. In fact, it suffices to construct $y'$
fppf locally on $Y'$, see
Stacks, Lemma \ref{stacks-lemma-characterize-essentially-surjective-when-ff}.
Choose a representable algebraic stack
$\mathcal{W}$ and a surjective smooth morphism $\mathcal{W} \to \mathcal{Z}$.
Then
$$
(\Sch/Y)_{fppf} \times_{y, \mathcal{Z}} \mathcal{W}
\quad\text{and}\quad
(\Sch/X')_{fppf} \times_{x', \mathcal{Z}} \mathcal{W}
$$
are algebraic stacks representable by algebraic spaces $V$ and $U'$
smooth over $Y$ and $X'$. The isomorphism $f$ induces an isomorphism
$\varphi : V \times_Y X \to U' \times_{X'} X$ over $X$. By
Pushouts of Spaces, Lemmas
\ref{spaces-pushouts-lemma-pushout-along-thickening} and
\ref{spaces-pushouts-lemma-equivalence-categories-spaces-pushout-flat}
we see that the pushout $V' = V \amalg_{V \times_Y X} U'$ is
an algebraic space smooth over $Y'$ whose base change to
$Y$ and $X'$ recovers $V$ and $U'$ in a manner compatible with $\varphi$.

\medskip\noindent
Let $W$ be the algebraic space representing $\mathcal{W}$.
The projections $V \to W$ and $U' \to W$ agree as morphisms
over $V \times_Y X \cong U' \times_{X'} X$ hence the universal
property of the pushout determines a morphism of algebraic spaces
$V' \to W$. Choose a scheme $Y_1'$ and a surjective \'etale morphism
$Y_1' \to V'$. Set $Y_1 = Y \times_{Y'} Y_1'$,
$X_1' = X' \times_{Y'} Y_1'$, $X_1 = X \times_{Y'} Y_1'$.
The composition
$$
(\Sch/Y_1') \to (\Sch/V') \to (\Sch/W) = \mathcal{W} \to \mathcal{Z}
$$
corresponds by the $2$-Yoneda lemma to an object $y_1'$ of $\mathcal{Z}$
over $Y_1'$ whose restriction to $Y_1$ and $X_1'$ agrees with $y|_{Y_1}$
and $x'|_{X_1'}$ in a manner compatible with $f|_{X_1}$. Thus we have
constructed our desired object smooth locally over $Y'$ and we win.
\end{proof}








\section{The Rim-Schlessinger condition}
\label{section-RS}

\noindent
The motivation for the following definition comes from
Lemma \ref{lemma-pushout}
and
Formal Deformation Theory, Definition \ref{formal-defos-definition-RS} and
Lemma \ref{formal-defos-lemma-RS-2-categorical}.

\begin{definition}
\label{definition-RS}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{Z}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. We say $\mathcal{Z}$
satisfies {\it condition (RS)} if for every pushout
$$
\xymatrix{
X \ar[r] \ar[d] & X' \ar[d] \\
Y \ar[r] & Y' = Y \amalg_X X'
}
$$
in the category of schemes over $S$ where
\begin{enumerate}
\item $X$, $X'$, $Y$, $Y'$ are spectra of local Artinian rings,
\item $X$, $X'$, $Y$, $Y'$ are of finite type over $S$, and
\item $X \to X'$ (and hence $Y \to Y'$) is a closed immersion
\end{enumerate}
the functor of fibre categories
$$
\mathcal{Z}_{Y'}
\longrightarrow
\mathcal{Z}_Y \times_{\mathcal{Z}_X} \mathcal{Z}_{X'}
$$
is an equivalence of categories.
\end{definition}

\noindent
If $A$ is an Artinian local ring with residue field $k$, then
any morphism $\Spec(A) \to S$ is affine and of finite type if and
only if the induced morphism $\Spec(k) \to S$ is of finite type, see
Morphisms, Lemmas \ref{morphisms-lemma-Artinian-affine} and
\ref{morphisms-lemma-artinian-finite-type}.

\begin{lemma}
\label{lemma-algebraic-stack-RS}
Let $\mathcal{X}$ be an algebraic stack over a locally Noetherian base
$S$. Then $\mathcal{X}$ satisfies (RS).
\end{lemma}

\begin{proof}
Immediate from the definitions and Lemma \ref{lemma-pushout}.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-RS}
Let $S$ be a scheme. Let $p : \mathcal{X} \to \mathcal{Y}$ and
$q : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. If $\mathcal{X}$, $\mathcal{Y}$,
and $\mathcal{Z}$ satisfy (RS), then so
does $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$.
\end{lemma}

\begin{proof}
This is formal. Let 
$$
\xymatrix{
X \ar[r] \ar[d] & X' \ar[d] \\
Y \ar[r] & Y' = Y \amalg_X X'
}
$$
be a diagram as in Definition \ref{definition-RS}. We have to show that
$$
(\mathcal{X} \times_{\mathcal{Y}} \mathcal{Z})_{Y'}
\longrightarrow
(\mathcal{X} \times_{\mathcal{Y}} \mathcal{Z})_Y
\times_{(\mathcal{X} \times_{\mathcal{Y}} \mathcal{Z})_X}
(\mathcal{X} \times_{\mathcal{Y}} \mathcal{Z})_{X'}
$$
is an equivalence. Using the definition of the $2$-fibre product
this becomes
\begin{equation}
\label{equation-RS-fibre-product}
\mathcal{X}_{Y'} \times_{\mathcal{Y}_{Y'}} \mathcal{Z}_{Y'}
\longrightarrow
(\mathcal{X}_Y \times_{\mathcal{Y}_Y} \mathcal{Z}_Y)
\times_{(\mathcal{X}_X \times_{\mathcal{Y}_X} \mathcal{Z}_X)}
(\mathcal{X}_{X'} \times_{\mathcal{Y}_{X'}} \mathcal{Z}_{X'}).
\end{equation}
We are given that each of the functors
$$
\mathcal{X}_{Y'} \to \mathcal{X}_Y \times_{\mathcal{Y}_Y} \mathcal{Z}_Y,
\quad
\mathcal{Y}_{Y'} \to \mathcal{X}_X \times_{\mathcal{Y}_X} \mathcal{Z}_X,
\quad
\mathcal{Z}_{Y'} \to
\mathcal{X}_{X'} \times_{\mathcal{Y}_{X'}} \mathcal{Z}_{X'}
$$
are equivalences. An object of the right hand side of
(\ref{equation-RS-fibre-product}) is a system
$$
((x_Y, z_Y, \phi_Y), (x_{X'}, z_{X'}, \phi_{X'}), (\alpha, \beta)).
$$
Then $(x_Y, x_{Y'}, \alpha)$ is isomorphic to the image of an object
$x_{Y'}$ in $\mathcal{X}_{Y'}$ and $(z_Y, z_{Y'}, \beta)$ is isomorphic
to the image of an object $z_{Y'}$ of $\mathcal{Z}_{Y'}$. The pair of
morphisms $(\phi_Y, \phi_{X'})$ corresponds to a morphism $\psi$
between the images of $x_{Y'}$ and $z_{Y'}$ in $\mathcal{Y}_{Y'}$.
Then $(x_{Y'}, z_{Y'}, \psi)$ is an object of the left hand side of
(\ref{equation-RS-fibre-product}) mapping to the given object of the
right hand side. This proves that (\ref{equation-RS-fibre-product}) is
essentially surjective. We omit the proof that it is fully faithful.
\end{proof}





\section{Deformation categories}
\label{section-deformation-categories}

\noindent
We match the notation introduced above with the notation from the
chapter ``Formal Deformation Theory''.

\begin{lemma}
\label{lemma-deformation-category}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$ satisfying (RS). For any field
$k$ of finite type over $S$ and any object $x_0$ of $\mathcal{X}$ lying
over $k$ the predeformation category
$p : \mathcal{F}_{\mathcal{X}, k, x_0} \to \mathcal{C}_\Lambda$
(\ref{equation-predeformation-category}) is a deformation category, see
Formal Deformation Theory, Definition
\ref{formal-defos-definition-deformation-category}.
\end{lemma}

\begin{proof}
Set $\mathcal{F} = \mathcal{F}_{\mathcal{X}, k, x_0}$.
Let $f_1 : A_1 \to A$ and $f_2 : A_2 \to A$ be ring maps in
$\mathcal{C}_\Lambda$ with $f_2$ surjective. We have to show that
the functor
$$
\mathcal{F}(A_1 \times_A A_2)
\longrightarrow
\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)
$$
is an equivalence, see
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-RS-2-categorical}.
Set $X = \Spec(A)$, $X' = \Spec(A_2)$, $Y = \Spec(A_1)$ and
$Y' = \Spec(A_1 \times_A A_2)$. Note that $Y' = Y \amalg_X X'$ in the
category of schemes, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
We know that in the diagram of functors of fibre categories
$$
\xymatrix{
\mathcal{X}_{Y'} \ar[r] \ar[d] &
\mathcal{X}_Y \times_{\mathcal{X}_X} \mathcal{X}_{X'} \ar[d] \\
\mathcal{X}_{\Spec(k)} \ar@{=}[r] & \mathcal{X}_{\Spec(k)}
}
$$
the top horizontal arrow is an equivalence by
Definition \ref{definition-RS}.
Since $\mathcal{F}(B)$ is the category of objects of $\mathcal{X}_{\Spec(B)}$
with an identification with $x_0$ over $k$ we win.
\end{proof}

\begin{remark}
\label{remark-deformation-category-implies}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be fibred
in groupoids over $(\Sch/S){fppf}$. Let $k$ be a field of finite type over
$S$ and $x_0$ an object
of $\mathcal{X}$ over $k$. Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$
be as in (\ref{equation-predeformation-category}). If $\mathcal{F}$
is a deformation category, i.e., if $\mathcal{F}$ satisfies the
Rim-Schlessinger condition (RS), then we see that $\mathcal{F}$ satisfies
Schlessinger's conditions (S1) and (S2) by
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-RS-implies-S1-S2}.
Let $\overline{\mathcal{F}}$ be the functor of isomorphism classes, see
Formal Deformation Theory, Remarks
\ref{formal-defos-remarks-cofibered-groupoids}
(\ref{formal-defos-item-associated-functor-isomorphism-classes}).
Then $\overline{\mathcal{F}}$ satisfies (S1) and (S2) as well, see
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-S1-S2-associated-functor}.
This holds in particular in the situation of
Lemma \ref{lemma-deformation-category}.
\end{remark}




\section{Change of field}
\label{section-change-of-field}

\noindent
This section is the analogue of
Formal Deformation Theory, Section \ref{formal-defos-section-change-of-field}.
As pointed out there, to discuss what happens under change of field
we need to write $\mathcal{C}_{\Lambda, k}$ instead of $\mathcal{C}_\Lambda$.
In the following lemma we use the notation $\mathcal{F}_{l/k}$
introduced in Formal Deformation Theory, Situation
\ref{formal-defos-situation-change-of-fields}.

\begin{lemma}
\label{lemma-change-of-field}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Let $k$ be a
field of finite type over $S$ and let $l/k$ be a finite extension.
Let $x_0$ be an object of $\mathcal{F}$ lying over $\Spec(k)$.
Denote $x_{l, 0}$ the restriction of $x_0$ to $\Spec(l)$.
Then there is a canonical functor
$$
(\mathcal{F}_{\mathcal{X}, k , x_0})_{l/k}
\longrightarrow
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
$$
of categories cofibred in groupoids over $\mathcal{C}_{\Lambda, l}$.
If $\mathcal{X}$ satisfies (RS), then this functor is an equivalence.
\end{lemma}

\begin{proof}
Consider a factorization
$$
\Spec(l) \to \Spec(B) \to S
$$
as in (\ref{equation-factor}). By definition we have
$$
(\mathcal{F}_{\mathcal{X}, k , x_0})_{l/k}(B) =
\mathcal{F}_{\mathcal{X}, k, x_0}(B \times_l k)
$$
see Formal Deformation Theory, Situation
\ref{formal-defos-situation-change-of-fields}. Thus an object of this
is a morphism $x_0 \to x$ of $\mathcal{X}$ lying over the morphism
$\Spec(k) \to \Spec(B \times_l k)$. Choosing pullback functor for $\mathcal{X}$
we can associate to $x_0 \to x$ the morphism $x_{l, 0} \to x_B$
where $x_B$ is the restriction of $x$ to $\Spec(B)$ (via the morphism
$\Spec(B) \to \Spec(B \times_l k)$ coming from $B \times_l k \subset B$).
This construction is functorial in $B$ and compatible with morphisms.

\medskip\noindent
Next, assume $\mathcal{X}$ satisfies (RS). Consider the diagrams
$$
\vcenter{
\xymatrix{
l & B \ar[l] \\
k \ar[u] & B \times_l k \ar[l] \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
\Spec(l) \ar[d] \ar[r] & \Spec(B) \ar[d] \\
\Spec(k) \ar[r] & \Spec(B \times_l k)
}
}
$$
The diagram on the left is a fibre product of rings. The diagram on the
right is a pushout in the category of schemes, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
These schemes are all of finite type over $S$ (see remarks following
Definition \ref{definition-RS}). Hence (RS) kicks in to give an equivalence
of fibre categories
$$
\mathcal{X}_{\Spec(B \times_l k)}
\longrightarrow
\mathcal{X}_{\Spec(k)}
\times_{\mathcal{X}_{\Spec(l)}}
\mathcal{X}_{\Spec(B)}
$$
This implies that the functor defined above gives an equivalence of
fibre categories. Hence the functor is an equivalence on categories
cofibred in groupoids by (the dual of)
Categories, Lemma \ref{categories-lemma-equivalence-fibred-categories}.
\end{proof}








\section{Tangent spaces}
\label{section-tangent-spaces}

\noindent
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Let $k$ be a field of finite
type over $S$ and let $x_0$ be an object of $\mathcal{X}$ over $k$.
In Formal Deformation Theory, Section \ref{formal-defos-section-tangent-spaces}
we have defined the {\it tangent space}
\begin{equation}
\label{equation-tangent-space}
T\mathcal{F}_{\mathcal{X}, k, x_0} =
\left\{
\begin{matrix}
\text{isomorphism classes of morphisms}\\
x_0 \to x\text{ over }\Spec(k) \to \Spec(k[\epsilon])
\end{matrix}
\right\}
\end{equation}
of the predeformation category $\mathcal{F}_{\mathcal{X}, k, x_0}$.
In Formal Deformation Theory, Section
\ref{formal-defos-section-infinitesimal-automorphisms}
we have defined
\begin{equation}
\label{equation-infinitesimal-automorphisms}
\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0}) =
\Ker\left(
\text{Aut}_{\Spec(k[\epsilon])}(x'_0) \to \text{Aut}_{\Spec(k)}(x_0)
\right)
\end{equation}
where $x_0'$ is the pullback of $x_0$ to $\Spec(k[\epsilon])$.
If $\mathcal{X}$ satisfies the Rim-Schlessinger condition (RS), then
$T\mathcal{F}_{\mathcal{X}, k, x_0}$ comes equipped with a natural
$k$-vector space structure by Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-tangent-space-vector-space}
(assumptions hold by Lemma \ref{lemma-deformation-category} and
Remark \ref{remark-deformation-category-implies}). Moreover,
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-infaut-vector-space}
shows that $\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0})$ has a
natural $k$-vector space structure such that addition agrees with
composition of automorphisms. A natural condition
is to ask these vector spaces to have finite dimension.

\medskip\noindent
The following lemma tells us this is true if
$\mathcal{X}$ is locally of finite type over $S$ (see
Morphisms of Stacks, Section \ref{stacks-morphisms-section-finite-type}).

\begin{lemma}
\label{lemma-finite-dimension}
Let $S$ be a locally Noetherian scheme. Assume
\begin{enumerate}
\item $\mathcal{X}$ is an algebraic stack,
\item $U$ is a scheme locally of finite type over $S$, and
\item $(\Sch/U)_{fppf} \to \mathcal{X}$ is a smooth surjective
morphism.
\end{enumerate}
Then, for any $\mathcal{F} = \mathcal{F}_{\mathcal{X}, k, x_0}$ as in
Section \ref{section-predeformation-categories}
the tangent space $T\mathcal{F}$ and infinitesimal automorphism space
$\text{Inf}_{x_0}(\mathcal{F})$ have finite dimension over $k$
\end{lemma}

\begin{proof}
Let us write $\mathcal{U} = (\Sch/U)_{fppf}$. By our definition
of algebraic stacks the $1$-morphism $\mathcal{U} \to \mathcal{X}$
is representable by algebraic spaces. Hence in particular the
2-fibre product
$$
\mathcal{U}_{x_0} = (\Sch/\Spec(k))_{fppf} \times_\mathcal{X} \mathcal{U}
$$
is representable by an algebraic space $U_{x_0}$ over $\Spec(k)$. Then
$U_{x_0} \to \Spec(k)$ is smooth and surjective (in particular $U_{x_0}$
is nonempty). By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-smooth-separable-closed-points-dense}
we can find a finite extension $l \supset k$ and a point
$\Spec(l) \to U_{x_0}$ over $k$. We have
$$
(\mathcal{F}_{\mathcal{X}, k , x_0})_{l/k} =
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
$$
by Lemma \ref{lemma-change-of-field} and the fact that $\mathcal{X}$
satisfies (RS). Thus we see that
$$
T\mathcal{F} \otimes_k l \cong T\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
\quad\text{and}\quad
\text{Inf}_{x_0}(\mathcal{F}) \otimes_k l \cong
\text{Inf}_{x_{l, 0}}(\mathcal{F}_{\mathcal{X}, l, x_{l, 0}})
$$
by
Formal Deformation Theory, Lemmas
\ref{formal-defos-lemma-tangent-space-change-of-field} and
\ref{formal-defos-lemma-inf-aut-change-of-field}
(these are applicable by
Lemmas \ref{lemma-algebraic-stack-RS} and
\ref{lemma-deformation-category} and
Remark \ref{remark-deformation-category-implies}).
Hence it suffices to prove that $T\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}$
and $\text{Inf}_{x_{l, 0}}(\mathcal{F}_{\mathcal{X}, l, x_{l, 0}})$
have finite dimension over $l$. Note that $x_{l, 0}$ comes from a point
$u_0$ of $\mathcal{U}$ over $l$.

\medskip\noindent
We interrupt the flow of the argument to show that the lemma for
infinitesimal automorphisms follows from the lemma for tangent spaces.
Namely, let
$\mathcal{R} = \mathcal{U} \times_\mathcal{X} \mathcal{U}$.
Let $r_0$ be the $l$-valued point $(u_0, u_0, \text{id}_{x_0})$ of
$\mathcal{R}$. Combining
Lemma \ref{lemma-fibre-product-deformation-categories} and
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-deformation-functor-diagonal}
we see that
$$
\text{Inf}_{x_{l, 0}}(\mathcal{F}_{\mathcal{X}, l, x_{l, 0}})
\subset
T\mathcal{F}_{\mathcal{R}, k, r_0}
$$
Note that $\mathcal{R}$ is an algebraic stack, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-2-fibre-product-general}.
Also, $\mathcal{R}$ is representable by an algebraic space $R$
smooth over $U$ (via either projection, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-stack-presentation}).
Hence, choose an scheme $U'$ and a surjective \'etale morphism
$U' \to R$ we see that $U'$ is smooth over $U$, hence locally of
finite type over $S$. As $(\Sch/U')_{fppf} \to \mathcal{R}$ is
surjective and smooth, we have reduced the question to the case
of tangent spaces.

\medskip\noindent
The functor (\ref{equation-functoriality})
$$
\mathcal{F}_{\mathcal{U}, l, u_0}
\longrightarrow
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
$$
is smooth by Lemma \ref{lemma-formally-smooth-on-deformation-categories}.
The induced map on tangent spaces
$$
T\mathcal{F}_{\mathcal{U}, l, u_0}
\longrightarrow
T\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
$$
is $l$-linear (by
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-k-linear-differential})
and surjective (as smooth maps of predeformation categories induce
surjective maps on tangent spaces by
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-smooth-morphism-essentially-surjective}).
Hence it suffices to prove that the tangent space of the deformation
space associated to the representable algebraic stack $\mathcal{U}$
at the point $u_0$ is finite dimensional. Let $\Spec(R) \subset U$ be
an affine open such that $u_0 : \Spec(l) \to U$ factors through $\Spec(R)$
and such that $\Spec(R) \to S$ factors through $\Spec(\Lambda) \subset S$.
Let $\mathfrak m_R \subset R$ be the kernel of the $\Lambda$-algebra map
$\varphi_0 : R \to l$ corresponding to $u_0$. Note that $R$, being of finite
type over the Noetherian ring $\Lambda$, is a Noetherian ring. Hence
$\mathfrak m_R = (f_1, \ldots, f_n)$ is a finitely generated ideal.
We have
$$
T\mathcal{F}_{\mathcal{U}, l, u_0}
=
\{\varphi : R \to l[\epsilon] \mid
\varphi \text{ is a } \Lambda\text{-algebra map and }
\varphi \bmod \epsilon = \varphi_0\}
$$
An element of the right hand side is determined by its values on
$f_1, \ldots, f_n$ hence the dimension is at most $n$ and we win.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-tangent-spaces}
Let $S$ be a locally Noetherian scheme. Let $p : \mathcal{X} \to \mathcal{Y}$
and $q : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. Assume $\mathcal{X}$,
$\mathcal{Y}$, $\mathcal{Z}$ satisfy (RS).
Let $k$ be a field of finite type over $S$ and let $w_0$ be an object of
$\mathcal{W} = \mathcal{X} \times_\mathcal{Y} \mathcal{Z}$ over $k$.
Denote $x_0, y_0, z_0$ the objects of $\mathcal{X}, \mathcal{Y}, \mathcal{Z}$
you get from $w_0$. Then there is a $6$-term exact sequence
$$
\xymatrix{
0 \ar[r] &
\text{Inf}_{w_0}(\mathcal{F}_{\mathcal{W}, k, W_0}) \ar[r] &
\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0}) \oplus
\text{Inf}_{z_0}(\mathcal{F}_{\mathcal{Z}, k, z_0}) \ar[r] &
\text{Inf}_{y_0}(\mathcal{F}_{\mathcal{Y}, k, y_0}) \ar[lld] \\
 &
T\mathcal{F}_{\mathcal{W}, k, w_0} \ar[r] &
T\mathcal{F}_{\mathcal{X}, k, x_0} \oplus
T\mathcal{F}_{\mathcal{Z}, k, z_0} \ar[r] &
T\mathcal{F}_{\mathcal{Y}, k, y_0}
}
$$
of $k$-vector spaces.
\end{lemma}

\begin{proof}
Apply Lemmas \ref{lemma-fibre-product-deformation-categories} and
\ref{lemma-deformation-category}
and Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-deformation-categories-fiber-product-morphisms}.
\end{proof}






\section{Formal objects}
\label{section-formal-objects}

\noindent
In this section we transfer some of the notions already defined
in the chapter ``Formal Deformation Theory'' to the current setting.
In the following we will say ``$R$ is an $S$-algebra'' to indicate
that $R$ is a ring endowed with a morphism of schemes $\Spec(R) \to S$.

\begin{definition}
\label{definition-formal-objects}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
\begin{enumerate}
\item A {\it formal object} $\xi = (R, \xi_n, f_n)$ of $\mathcal{X}$ consists
of a Noetherian complete local $S$-algebra $R$, objects $\xi_n$ of
$\mathcal{X}$ lying over $\Spec(R/\mathfrak m_R^n)$, and morphisms
$f_n : \xi_n \to \xi_{n + 1}$ of $\mathcal{X}$ lying over
$\Spec(R/\mathfrak m^n) \to \Spec(R/\mathfrak m^{n + 1})$
such that $R/\mathfrak m$ is a field of finite type over $S$.
\item A {\it morphism of formal objects}
$a : \xi = (R, \xi_n, f_n) \to \eta = (T, \eta_n, g_n)$
is given by morphisms $a_n : \xi_n \to \eta_n$ such that for every $n$
the diagram
$$
\xymatrix{
\xi_{n + 1} \ar[r]_{f_n} \ar[d]_{a_{n + 1}} & \xi_n \ar[d]^{a_n} \\
\eta_{n + 1} \ar[r]^{g_n} & \eta_n
}
$$
is commutative. Applying the functor $p$ we obtain a compatible collection
of morphisms $\Spec(R/\mathfrak m_R^n) \to \Spec(T/\mathfrak m_T^n)$ and
hence a morphism $a_0 : \Spec(R) \to \Spec(T)$ over $S$. We say that
$a$ {\it lies over} $a_0$.
\end{enumerate}
\end{definition}

\noindent
Thus we obtain a category of formal objects of $\mathcal{X}$.

\begin{remark}
\label{remark-formal-objects-match}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Let $\xi = (R, \xi_n, f_n)$ be a formal object. Set $k = R/\mathfrak m$ and
$x_0 = \xi_1$. The formal object $\xi$ defines a formal object
$\xi$ of the predeformation category $\mathcal{F}_{\mathcal{X}, k, x_0}$.
This follows immediately from
Definition \ref{definition-formal-objects} above,
Formal Deformation Theory, Definition
\ref{formal-defos-definition-formal-objects},
and our construction of the predeformation category
$\mathcal{F}_{\mathcal{X}, k, x_0}$ in
Section \ref{section-predeformation-categories}.
\end{remark}

\noindent
If $F : \mathcal{X} \to \mathcal{Y}$ is a $1$-morphism of categories fibred
in groupoids over $(\Sch/S)_{fppf}$, then $F$ induces a functor between
categories of formal objects as well.

\begin{lemma}
\label{lemma-smooth-lift-formal}
Let $S$ be a locally Noetherian scheme. Let $F : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Let $\eta = (R, \eta_n, g_n)$ be a formal object of $\mathcal{Y}$
and let $\xi_1$ be an object of $\mathcal{X}$ with $F(\xi_1) \cong \eta_1$.
If $F$ is formally smooth on objects (see
Criteria for Representability, Section \ref{criteria-section-formally-smooth}),
then there exists a formal object $\xi = (R, \xi_n, f_n)$ of $\mathcal{X}$
such that $F(\xi) \cong \eta$.
\end{lemma}

\begin{proof}
Note that each of the morphisms
$\Spec(R/\mathfrak m^n) \to \Spec(R/\mathfrak m^{n + 1})$ is a first order
thickening of affine schemes over $S$. Hence the assumption on $F$ means
that we can successively lift $\xi_1$ to objects $\xi_2, \xi_3, \ldots$
of $\mathcal{X}$ endowed with compatible isomorphisms
$\eta_n|_{\Spec(R/\mathfrak m^{n - 1})} \cong \eta_{n - 1}$
and $F(\eta_n) \cong \xi_n$.
\end{proof}

\noindent
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Suppose that $x$ is an object of $\mathcal{X}$ over $R$, where $R$ is a
Noetherian complete local $S$-algebra with residue field of finite type
over $S$. Then we can consider the system of restrictions
$\xi_n = x|_{\Spec(R/\mathfrak m^n)}$ endowed with the natural morphisms
$\xi_1 \to \xi_2 \to \ldots$ coming from transitivity of restriction.
Thus $\xi = (R, \xi_n, \xi_n \to \xi_{n + 1})$ is a formal object of
$\mathcal{X}$. This construction is functorial in the object $x$.
Thus we obtain a functor
\begin{equation}
\label{equation-approximation}
\left\{
\begin{matrix}
\text{objects }x\text{ of }\mathcal{X} \text{ such that }p(x) = \Spec(R) \\
\text{where }R\text{ is Noetherian complete local}\\
\text{with }R/\mathfrak m\text{ of finite type over }S
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
\text{formal objects of }\mathcal{X}
\end{matrix}
\right\}
\end{equation}
To be precise the left hand side is the full subcategory of $\mathcal{X}$
consisting of objects as indicated and the right hand side is the category
of formal objects of $\mathcal{X}$ as in
Definition \ref{definition-formal-objects}.

\begin{definition}
\label{definition-effective}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. A formal object
$\xi = (R, \xi_n, f_n)$ of $\mathcal{X}$ is called {\it effective}
if it is in the essential image of the functor
(\ref{equation-approximation}).
\end{definition}

\noindent
If the category fibred in groupoids is an algebraic stack, then every
formal object is effective as follows from the next lemma.

\begin{lemma}
\label{lemma-effective}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be an algebraic
stack over $S$. The functor (\ref{equation-approximation}) is an equivalence.
\end{lemma}

\begin{proof}
Case I: $\mathcal{X}$ is representable (by a scheme). Say
$\mathcal{X} = (\Sch/X)_{fppf}$ for some scheme $X$ over $S$.
Unwinding the definitions we have to prove the following: Given
a Noetherian complete local $S$-algebra $R$ with $R/\mathfrak m$ of
finite type over $S$ we have
$$
\Mor_S(\Spec(R), X) \longrightarrow \lim \Mor_S(\Spec(R/\mathfrak m^n), X)
$$
is bijective. This follows from Formal Spaces, Lemma
\ref{formal-spaces-lemma-map-into-scheme}.

\medskip\noindent
Case II. $\mathcal{X}$ is representable by an algebraic space. Say
$\mathcal{X}$ is representable by $X$. Again we have to show that
$$
\Mor_S(\Spec(R), X) \longrightarrow \lim \Mor_S(\Spec(R/\mathfrak m^n), X)
$$
is bijective for $R$ as above. This is Formal Spaces, Lemma
\ref{formal-spaces-lemma-map-into-algebraic-space}.

\medskip\noindent
Case III: General case of an algebraic stack. A general remark is that
the left and right hand side of (\ref{equation-approximation}) are
categories fibred in groupoids over the category of affine schemes
over $S$ which are spectra of Noetherian complete local rings
with residue field of finite type over $S$. We will also see in the
proof below that they form stacks for a certain topology on this
category.

\medskip\noindent
We first prove fully faithfulness. Let $R$ be a Noetherian complete
local $S$-algebra with $k = R/\mathfrak m$ of finite type over $S$.
Let $x, x'$ be objects of $\mathcal{X}$ over $R$. As $\mathcal{X}$ is
an algebraic stack $\mathit{Isom}(x, x')$ is representable by an
algebraic space $I$ over $\Spec(R)$, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
Applying Case II to $I$ over $\Spec(R)$ implies immediately that
(\ref{equation-approximation}) is fully faithful on fibre categories over
$\Spec(R)$. Hence the functor is fully faithful by
Categories, Lemma \ref{categories-lemma-equivalence-fibred-categories}.

\medskip\noindent
Essential surjectivity. Let $\xi = (R, \xi_n, f_n)$ be a formal object of
$\mathcal{X}$. Choose a scheme $U$ over $S$ and a surjective smooth morphism
$f : (\Sch/U)_{fppf} \to \mathcal{X}$. For every $n$ consider the fibre product
$$
(\Sch/\Spec(R/\mathfrak m^n))_{fppf}
\times_{\xi_n, \mathcal{X}, f}
(\Sch/U)_{fppf}
$$
By assumption this is representable by an algebraic space $V_n$ surjective and
smooth over $\Spec(R/\mathfrak m^n)$. The morphisms
$f_n : \xi_n \to \xi_{n + 1}$ induce cartesian squares
$$
\xymatrix{
V_{n + 1} \ar[d] & V_n \ar[d] \ar[l] \\
\Spec(R/\mathfrak m^{n + 1}) & \Spec(R/\mathfrak m^n) \ar[l]
}
$$
of algebraic spaces. By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-smooth-separable-closed-points-dense}
we can find a finite separable extension $k \subset k'$ and a point
$v'_1 : \Spec(k') \to V_1$ over $k$. Let $R \subset R'$ be the finite \'etale
extension whose residue field extension is $k \subset k'$ (exists and
is unique by
Algebra, Lemmas \ref{algebra-lemma-henselian-cat-finite-etale} and
\ref{algebra-lemma-complete-henselian}).
By the infinitesimal lifting criterion of smoothness (see
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-smooth-formally-smooth})
applied to $V_n \to \Spec(R/\mathfrak m^n)$ for $n = 2, 3, 4, \ldots$
we can successively find morphisms
$v'_n : \Spec(R'/(\mathfrak m')^n) \to V_n$ over $\Spec(R/\mathfrak m^n)$
fitting into commutative diagrams
$$
\xymatrix{
\Spec(R'/(\mathfrak m')^{n + 1}) \ar[d]_{v'_{n + 1}} &
\Spec(R'/(\mathfrak m')^n) \ar[d]^{v'_n} \ar[l] \\
V_{n + 1} & V_n \ar[l]
}
$$
Composing with the projection morphisms $V_n \to U$ we obtain a compatible
system of morphisms $u'_n : \Spec(R'/(\mathfrak m')^n) \to U$.
By Case I the family $(u'_n)$ comes from a unique
morphism $u' : \Spec(R') \to U$. Denote $x'$ the object of $\mathcal{X}$
over $\Spec(R')$ we get by applying the $1$-morphism $f$ to $u'$.
By construction, there exists a morphism of formal objects
$$
(\ref{equation-approximation})(x') =
(R', x'|_{\Spec(R'/(\mathfrak m')^n)}, \ldots)
\longrightarrow
(R, \xi_n, f_n)
$$
lying over $\Spec(R') \to \Spec(R)$. Note that $R' \otimes_R R'$ is a finite
product of spectra of Noetherian complete local rings to which our current
discussion applies. Denote $p_0, p_1 : \Spec(R' \otimes_R R') \to \Spec(R')$
the two projections. By the fully faithfulness shown above there exists
a canonical isomorphism $\varphi : p_0^*x' \to p_1^*x'$ because we have
such isomorphisms over
$\Spec((R' \otimes_R R')/\mathfrak m^n(R' \otimes_R R'))$.
We omit the proof that the isomorphism $\varphi$ satisfies the cocycle
condition (see Stacks, Definition \ref{stacks-definition-descent-data}).
Since $\{\Spec(R') \to \Spec(R)\}$ is an fppf covering we conclude
that $x'$ descends to an object $x$ of $\mathcal{X}$ over $\Spec(R)$.
We omit the proof that $x_n$ is the restriction of $x$ to
$\Spec(R/\mathfrak m^n)$.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-effective}
Let $S$ be a scheme. Let $p : \mathcal{X} \to \mathcal{Y}$ and
$q : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. If the functor
(\ref{equation-approximation}) is an equivalence for 
$\mathcal{X}$, $\mathcal{Y}$, and $\mathcal{Z}$, then it is 
and equivalence for $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$.
\end{lemma}

\begin{proof}
The left and the right hand side of (\ref{equation-approximation})
for $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$ are simply the $2$-fibre
products of the left and the right hand side of (\ref{equation-approximation})
for $\mathcal{X}$, $\mathcal{Z}$ over $\mathcal{Y}$.
Hence the result follows as taking $2$-fibre products is compatible
with equivalences of categories, see
Categories, Lemma \ref{categories-lemma-equivalence-2-fibre-product}.
\end{proof}






\section{Approximation}
\label{section-approximation}

\noindent
A fundamental insight of Michael Artin is that you can approximate
objects of a limit preserving stack. Namely, given an object $x$
of the stack over a Noetherian complete local ring, you can find
an object $x_A$ over an algebraic ring which is ``close to'' $x$.
Here an algebraic ring means a finite type $S$-algebra and close
means adically close. In this section we present this in a simple,
yet general form.

\medskip\noindent
To formulate the result we need to pull together some definitions from
different places in the Stacks project. First, in
Criteria for Representability, Section \ref{criteria-section-limit-preserving}
we introduced {\it limit preserving on objects} for $1$-morphisms
of categories fibred in groupoids over the category of schemes.
In More on Algebra, Definition \ref{more-algebra-definition-G-ring}
we defined the notion of a {\it G-ring}. Let $S$ be a locally Noetherian scheme.
Let $A$ be an $S$-algebra. We say that $A$ is {\it of finite type over $S$}
or is a {\it finite type $S$-algebra} if $\Spec(A) \to S$ is of finite type.
In this case $A$ is a Noetherian ring. Finally, given a ring $A$ and ideal
$I$ we denote $\text{Gr}_I(A) = \bigoplus I^n/I^{n + 1}$.

\begin{lemma}
\label{lemma-approximate}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category
fibred in groupoids. Let $x$ be an object of
$\mathcal{X}$ lying over $\Spec(R)$ where $R$ is a Noetherian complete
local ring with residue field $k$ of finite type over $S$. Let $s \in S$
be the image of $\Spec(k) \to S$. Assume that (a) $\mathcal{O}_{S, s}$ is
a G-ring and (b) $p$ is limit preserving on objects. Then for every
integer $N \geq 1$ there exist
\begin{enumerate}
\item a finite type $S$-algebra $A$,
\item a maximal ideal $\mathfrak m_A \subset A$,
\item an object $x_A$ of $\mathcal{X}$ over $\Spec(A)$,
\item an $S$-isomorphism $R/\mathfrak m_R^N \cong A/\mathfrak m_A^N$,
\item an isomorphism
$x|_{\Spec(R/\mathfrak m_R^N)} \cong x_A|_{\Spec(A/\mathfrak m_A^N)}$
compatible with (4), and
\item an isomorphism
$\text{Gr}_{\mathfrak m_R}(R) \cong \text{Gr}_{\mathfrak m_A}(A)$
of graded $k$-algebras.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose an affine open $\Spec(\Lambda) \subset S$ such that $k$ is a finite
$\Lambda$-algebra, see
Morphisms, Lemma \ref{morphisms-lemma-point-finite-type}.
We may and do replace $S$ by $\Spec(\Lambda)$.

\medskip\noindent
We may write $R$ as a directed colimit $R = \colim C_j$ where each
$C_j$ is a finite type $\Lambda$-algebra (see
Algebra, Lemma \ref{algebra-lemma-ring-colimit-fp}).
By assumption (b) the object $x$ is isomorphic to the restriction of
an object over one of the $C_j$. Hence we may choose a finite type
$\Lambda$-algebra $C$, a $\Lambda$-algebra map $C \to R$, and an object
$x_C$ of $\mathcal{X}$ over $\Spec(C)$ such that $x = x_C|_{\Spec(R)}$.
The choice of $C$ is a bookkeeping device and could be avoided.
For later use, let us write $C = \Lambda[y_1, \ldots, y_u]/(f_1, \ldots, f_v)$
and we denote $\overline{a}_i \in R$ the image of $y_i$ under the
map $C \to R$. Set $\mathfrak m_C = C \cap \mathfrak m_R$.

\medskip\noindent
Choose a $\Lambda$-algebra surjection $\Lambda[x_1, \ldots, x_s] \to k$
and denote $\mathfrak m'$ the kernel.
By the universal property of polynomial rings we may lift this
to a $\Lambda$-algebra map $\Lambda[x_1, \ldots, x_s] \to R$.
We add some variables (i.e., we increase $s$ a bit) mapping to generators
of $\mathfrak m_R$. Having done this we see that
$\Lambda[x_1, \ldots, x_s] \to R/\mathfrak m_R^2$ is surjective.
Then we see that
\begin{equation}
\label{equation-surjection}
P = \Lambda[x_1, \ldots, x_s]_{\mathfrak m'}^\wedge \longrightarrow R
\end{equation}
is a surjective map of Noetherian complete local rings, see for example
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-surjective-cotangent-space}.

\medskip\noindent
Choose lifts $a_i \in P$ of $\overline{a}_i$ we found above.
Choose generators $b_1, \ldots, b_r \in P$ for the kernel of
(\ref{equation-surjection}).
Choose $c_{ji} \in P$ such that
$$
f_j(a_1, \ldots, a_u) = \sum c_{ji} b_i
$$
in $P$ which is possible by the choices made so far. Choose generators
$$
k_1, \ldots, k_t \in
\Ker(P^{\oplus r} \xrightarrow{(b_1, \ldots, b_r)} P)
$$
and write $k_i = (k_{i1}, \ldots, k_{ir})$ and $K = (k_{ij})$
so that
$$
P^{\oplus t} \xrightarrow{K}
P^{\oplus r} \xrightarrow{(b_1, \ldots, b_r)}
P \to R \to 0
$$
is an exact sequence of $P$-modules. In particular we have
$\sum k_{ij} b_j = 0$. After possibly increasing $N$ we may
assume $N - 1$ works in the Artin-Rees lemma for the first two maps of this
exact sequence (see More on Algebra, Section
\ref{more-algebra-section-artin-rees} for terminology).

\medskip\noindent
By assumption $\mathcal{O}_{S, s} = \Lambda_{\Lambda \cap \mathfrak m'}$ is
a G-ring. Hence by More on Algebra, Proposition
\ref{more-algebra-proposition-finite-type-over-G-ring}
the ring $\Lambda[x_1, \ldots, x_s]_{\mathfrak m'}$ is a $G$-ring.
Hence by Smoothing Ring Maps, Theorem
\ref{smoothing-theorem-approximation-property-variant}
there exist an \'etale ring map
$$
\Lambda[x_1, \ldots, x_s]_{\mathfrak m'} \to B,
$$
a maximal ideal $\mathfrak m_B$ of $B$ lying over $\mathfrak m'$, and
elements $a'_i, b'_i, c'_{ij}, k'_{ij} \in B'$ such that
\begin{enumerate}
\item $\kappa(\mathfrak m') = \kappa(\mathfrak m_B)$ which implies
that $\Lambda[x_1, \ldots, x_s]_{\mathfrak m'} \subset B_{\mathfrak m_B}
\subset P$ and $P$ is identified with the completion of $B$ at
$\mathfrak m_B$, see remark preceding Smoothing Ring Maps, Theorem
\ref{smoothing-theorem-approximation-property-variant},
\item $a_i - a'_i, b_i - b'_i, c_{ij} - c'_{ij}, k_{ij} - k'_{ij} \in
(\mathfrak m')^N P$, and
\item $f_j(a'_1, \ldots, a'_u) = \sum c'_{ji} b'_i$ and $\sum k'_{ij}b'_j = 0$.
\end{enumerate}
Set $A = B/(b'_1, \ldots, b'_r)$ and denote $\mathfrak m_A$ the
image of $\mathfrak m_B$ in $A$. (Note that $A$ is essentially of finite
type over $\Lambda$; at the end of the proof we will show how to obtain
an $A$ which is of finite type over $\Lambda$.) There is a ring map
$C \to A$ sending $y_i \mapsto a'_i$ because the $a'_i$ satisfy
the desired equations modulo $(b'_1, \ldots, b'_r)$.
Note that $A/\mathfrak m_A^N = R/\mathfrak m_R^N$ as quotients of
$P = B^\wedge$ by property (2) above. Set $x_A = x_C|_{\Spec(A)}$.
Since the maps
$$
C \to A \to A/\mathfrak m_A^N \cong R/\mathfrak m_R^N
\quad\text{and}\quad
C \to R \to R/\mathfrak m_R^N
$$
are equal we see that $x_A$ and $x$ agree modulo $\mathfrak m_R^N$
via the isomorphism $A/\mathfrak m_A^N = R/\mathfrak m_R^N$. At this
point we have shown properties (1) -- (5) of the statement of the lemma.
To see (6) note that
$$
P^{\oplus t} \xrightarrow{K}
P^{\oplus r} \xrightarrow{(b_1, \ldots, b_r)}
P
\quad\text{and}\quad
P^{\oplus t} \xrightarrow{K'}
P^{\oplus r} \xrightarrow{(b'_1, \ldots, b'_r)}
P
$$
are two complexes of $P$-modules which are congruent modulo
$(\mathfrak m')^N$ with the first one being exact. By our choice of $N$
above we see from
More on Algebra, Lemma \ref{more-algebra-lemma-approximate-complex-graded}
that $R = P/(b_1, \ldots, b_r)$ and
$P/(b'_1, \ldots, b'_r) = B^\wedge/(b'_1, \ldots, b'_r) = A^\wedge$
have isomorphic associated graded algebras, which is what we wanted to show.

\medskip\noindent
This last paragraph of the proof serves to clean up the issue that $A$ is
essentially of finite type over $S$ and not yet of finite type.
The construction above gives $A = B/(b'_1, \ldots, b'_r)$ and
$\mathfrak m_A \subset A$ with $B$ \'etale over
$\Lambda[x_1, \ldots, x_s]_{\mathfrak m'}$. Hence $A$ is of finite
type over the Noetherian ring $\Lambda[x_1, \ldots, x_s]_{\mathfrak m'}$.
Thus we can write $A = (A_0)_{\mathfrak m'}$ for some finite type
$\Lambda[x_1, \ldots, x_n]$ algebra $A_0$. Then
$A = \colim (A_0)_f$ where
$f \in \Lambda[x_1, \ldots, x_n] \setminus \mathfrak m'$, see
Algebra, Lemma \ref{algebra-lemma-localization-colimit}.
Because $p : \mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving on
objects, we see that
$x_A$ comes from some object $x_{(A_0)_f}$ over $\Spec((A_0)_f)$ for
an $f$ as above. After replacing $A$ by $(A_0)_f$ and $x_A$ by
$x_{(A_0)_f}$ and $\mathfrak m_A$ by $(A_0)_f \cap \mathfrak m_A$
the proof is finished.
\end{proof}





\section{Limit preserving}
\label{section-limits}

\noindent
The morphism $p : \mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving
on objects, as defined in Criteria for Representability, Section
\ref{criteria-section-limit-preserving}, if the functor of the definition
below is essentially surjective. However, the example
in Examples, Section \ref{examples-section-limit-preserving}
shows that this isn't equivalent to being limit preserving.

\begin{definition}
\label{definition-limit-preserving}
Let $S$ be a scheme. Let $\mathcal{X}$ be a category fibred in groupoids
over $(\Sch/S)_{fppf}$. We say $\mathcal{X}$ is {\it limit preserving}
if for every affine scheme $T$ over $S$ which is a limit $T = \lim T_i$
of a directed inverse system of affine schemes $T_i$ over $S$, we have
an equivalence
$$
\colim \mathcal{X}_{T_i} \longrightarrow \mathcal{X}_T
$$
of fibre categories.
\end{definition}

\noindent
We spell out what this means. First, given objects $x, y$ of $\mathcal{X}$
over $T_i$ we should have
$$
\Mor_{\mathcal{X}_T}(x|_T, y|_T) =
\colim_{i' \geq i} \Mor_{\mathcal{X}_{T_i'}}(x|_{T_i'}, y|_{T_i'})
$$
and second every object of $\mathcal{X}_T$ is isomorphic to the restriction
of an object over $T_i$ for some $i$. Note that the first condition means
that the presheaves $\mathit{Isom}_\mathcal{X}(x, y)$ (see
Stacks, Definition \ref{stacks-definition-mor-presheaf})
are limit preserving.

\begin{lemma}
\label{lemma-fibre-product-limit-preserving}
Let $S$ be a scheme. Let $p : \mathcal{X} \to \mathcal{Y}$ and
$q : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $(\Sch/S)_{fppf}$.
\begin{enumerate}
\item If $\mathcal{X} \to (\Sch/S)_{fppf}$ and
$\mathcal{Z} \to (\Sch/S)_{fppf}$ are limit preserving on objects and
$\mathcal{Y}$ is limit preserving, then
$\mathcal{X} \times_\mathcal{Y} \mathcal{Z} \to (\Sch/S)_{fppf}$ is
limit preserving on objects.
\item If $\mathcal{X}$, $\mathcal{Y}$,
and $\mathcal{Z}$ are limit preserving, then so
is $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is formal. Proof of (1). Let $T = \lim_{i \in I} T_i$ be the directed
limit of affine schemes $T_i$ over $S$. We will prove that the functor
$\colim \mathcal{X}_{T_i} \to \mathcal{X}_T$ is essentially surjective.
Recall that an object of the fibre product over $T$ is a quadruple
$(T, x, z, \alpha)$ where $x$ is an object of $\mathcal{X}$ lying over $T$,
$z$ is an object of $\mathcal{Z}$ lying over $T$, and
$\alpha : p(x) \to q(z)$ is a morphism in the fibre category of
$\mathcal{Y}$ over $T$. By assumption on $\mathcal{X}$ and $\mathcal{Z}$
we can find an $i$ and objects $x_i$ and $z_i$ over $T_i$ such that
$x_i|_T \cong T$ and $z_i|_T \cong z$. Then $\alpha$ corresponds to
an isomorphism $p(x_i)|_T \to q(z_i)|_T$ which comes from an isomorphism
$\alpha_{i'} : p(x_i)|_{T_{i'}} \to q(z_i)|_{T_{i'}}$ by our assumption on
$\mathcal{Y}$. After replacing $i$ by $i'$, $x_i$ by $x_i|_{T_{i'}}$, and
$z_i$ by $z_i|_{T_{i'}}$ we see that $(T_i, x_i, z_i, \alpha_i)$
is an object of the fibre product over $T_i$ which restricts to
an object isomorphic to $(T, x, z, \alpha)$ over $T$ as desired.

\medskip\noindent
We omit the arguments showing that $\colim \mathcal{X}_{T_i} \to \mathcal{X}_T$
is fully faithful in (2).
\end{proof}

\begin{lemma}
\label{lemma-limit-preserving-algebraic-space}
Let $S$ be a scheme. Let $\mathcal{X}$ be an algebraic stack over $S$.
Then the following are equivalent
\begin{enumerate}
\item $\mathcal{X}$ is a stack in setoids and
$\mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving on objects,
\item $\mathcal{X}$ is a stack in setoids and limit preserving,
\item $\mathcal{X}$ is representable by an algebraic space
locally of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Under each of the three assumptions $\mathcal{X}$ is representable
by an algebraic space $X$ over $S$, see Algebraic Stacks, Proposition
\ref{algebraic-proposition-algebraic-stack-no-automorphisms}.
It is clear that (1) and (2) are equivalent as a functor between
setoids is an equivalence if and only if it is surjective on isomorphism
classes. Finally, (1) and (3) are equivalent by
Limits of Spaces, Proposition
\ref{spaces-limits-proposition-characterize-locally-finite-presentation}.
\end{proof}

\begin{lemma}
\label{lemma-diagonal}
Let $S$ be a scheme. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. Assume
$\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ is
representable by algebraic spaces and $\mathcal{X}$ is limit preserving.
Then $\Delta$ is locally of finite type.
\end{lemma}

\begin{proof}
We apply Criteria for Representability, Lemma
\ref{criteria-lemma-check-property-limit-preserving}.
Let $V$ be an affine scheme $V$ of finite type over $S$
and let $\theta$ be an object of $\mathcal{X} \times \mathcal{X}$
over $V$. Let $F_\theta$ be an algebraic space representing
$\mathcal{X} \times_{\Delta, \mathcal{X} \times \mathcal{X}, \theta}
(\Sch/V)_{fppf}$ and let $f_\theta : Y \to V$ be the canonical morphism
(see Algebraic Stacks, Section
\ref{algebraic-section-morphisms-representable-by-algebraic-spaces}).
It suffices to show that
$F_\theta \to V$ has the corresponding properties. By
Lemmas \ref{lemma-fibre-product-limit-preserving} and
\ref{lemma-limit-preserving-algebraic-space}
we see that $F_\theta \to S$ is locally of finite presentation.
It follows that $F_\theta \to V$ is locally of finite type
by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-permanence-finite-type}.
\end{proof}






\section{Versality}
\label{section-versality}

\noindent
In the previous section we explained how to approximate objects over
complete local rings by algebraic objects. But in order to show that
a stack $\mathcal{X}$ is an algebraic stack, we need to find smooth
$1$-morphisms from schemes towards $\mathcal{X}$. Since we are not going
to assume a priori that $\mathcal{X}$ has a representable diagonal, we
cannot even speak about smooth morphisms towards $\mathcal{X}$. Instead,
borrowing terminology from deformation theory, we will introduce versal
objects.

\begin{definition}
\label{definition-versal-formal-object}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Let $\xi = (R, \xi_n, f_n)$ be a formal object. Set $k = R/\mathfrak m$ and
$x_0 = \xi_1$. We will say that $\xi$ is {\it versal} if $\xi$
as a formal object of $\mathcal{F}_{\mathcal{X}, k, x_0}$
(Remark \ref{remark-formal-objects-match}) is versal in the sense
of Formal Deformation Theory, Definition \ref{formal-defos-definition-versal}.
\end{definition}

\noindent
We briefly spell out what this means. With notation as in the definition,
suppose given morphisms $\xi_1 = x_0 \to y \to z$ of $\mathcal{X}$ lying over
closed immersions
$\Spec(k) \to \Spec(A) \to \Spec(B)$
where $A, B$ are Artinian local rings with residue field $k$.
Suppose given an $n \geq 1$ and a commutative diagram
$$
\vcenter{
\xymatrix{
& y \ar[ld] \\
\xi_n & \xi_1 \ar[u] \ar[l]
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& \Spec(A) \ar[ld] \\
\Spec(R/\mathfrak m^n) & \Spec(k) \ar[u] \ar[l]
}
}
$$
Versality means that for any data as above
there exists an $m \geq n$ and a commutative diagram
$$
\vcenter{
\xymatrix{
& & z \ar[lldd] \\
& & y \ar[ld] \ar[u] \\
\xi_m & \xi_n \ar[l] & \xi_1 \ar[u] \ar[l]
}
}
\quad\text{lying over}
\vcenter{
\xymatrix{
& & \Spec(B) \ar[lldd] \\
& & \Spec(A) \ar[ld] \ar[u] \\
\Spec(R/\mathfrak m^m) &
\Spec(R/\mathfrak m^n) \ar[l] &
\Spec(k) \ar[u] \ar[l]
}
}
$$
Please compare with Formal Deformation Theory, Remark
\ref{formal-defos-remark-versal-object}.

\medskip\noindent
Let $S$ be a locally Noetherian scheme. Let $U$ be a scheme over $S$
with structure morphism $U \to S$ locally of finite type. Let
$u_0 \in U$ be a finite type point of $U$, see
Morphisms, Definition \ref{morphisms-definition-finite-type-point}.
Set $k = \kappa(u_0)$.
Note that the composition $\Spec(k) \to S$ is also of finite type,
see Morphisms, Lemma \ref{morphisms-lemma-composition-finite-type}.
Let $p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Let $x$ be an object of $\mathcal{X}$ which lies over $U$. Denote $x_0$
the pullback of $x$ by $u_0$. By the $2$-Yoneda lemma $x$ corresponds
to a $1$-morphism
$$
x : (\Sch/U)_{fppf} \longrightarrow \mathcal{X},
$$
see Algebraic Stacks, Section \ref{algebraic-section-2-yoneda}. We obtain a
morphism of predeformation categories
\begin{equation}
\label{equation-hat-x}
\hat x :
\mathcal{F}_{(\Sch/U)_{fppf}, k, u_0}
\longrightarrow
\mathcal{F}_{\mathcal{X}, k, x_0},
\end{equation}
over $\mathcal{C}_\Lambda$ see (\ref{equation-functoriality}).

\begin{definition}
\label{definition-versal}
Let $S$ be a locally Noetherian scheme.
Let $\mathcal{X}$ be fibred in groupoids over $(\Sch/S)_{fppf}$.
Let $U$ be a scheme locally of finite type over $S$.
Let $x$ be an object of $\mathcal{X}$ lying over $U$.
Let $u_0$ be finite type point of $U$.
We say $x$ is {\it versal} at $u_0$ if the morphism $\hat x$
(\ref{equation-hat-x}) is smooth, see Formal Deformation Theory, Definition
\ref{formal-defos-definition-smooth-morphism}.
\end{definition}

\noindent
This definition matches our notion of versality for formal objects of
$\mathcal{X}$.

\begin{lemma}
\label{lemma-versality-matches}
With notation as in Definition \ref{definition-versal}.
Let $R = \mathcal{O}_{U, u_0}^\wedge$.
Let $\xi$ be the formal object of $\mathcal{X}$
over $R$ associated to $x|_{\Spec(R)}$, see (\ref{equation-approximation}).
Then
$$
x\text{ is versal at }u_0
\Leftrightarrow
\xi\text{ is versal}
$$
\end{lemma}

\begin{proof}
Observe that $\mathcal{O}_{U, u_0}$ is a Noetherian local $S$-algebra
with residue field $k$. Hence $R = \mathcal{O}_{U, u_0}^\wedge$ is an object of
$\mathcal{C}_\Lambda^\wedge$, see Formal Deformation Theory, Definition
\ref{formal-defos-definition-completion-CLambda}.
Recall that $\xi$ is versal if
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to
\mathcal{F}_{\mathcal{X}, k, x_0}$
is smooth and $x$ is versal at $u_0$ if
$\hat x : \mathcal{F}_{(\Sch/U)_{fppf}, k, u_0}
\to \mathcal{F}_{\mathcal{X}, k, x_0}$ is smooth.
There is an identification of predeformation categories
$$
\underline{R}|_{\mathcal{C}_\Lambda}
=
\mathcal{F}_{(\Sch/U)_{fppf}, k, u_0},
$$
see Formal Deformation Theory, Remark
\ref{formal-defos-remark-formal-objects-yoneda} for notation.
Namely, given an Artinian local $S$-algebra $A$ with residue field
identified with $k$ we have
$$
\Mor_{\mathcal{C}_\Lambda^\wedge}(R, A) =
\{\varphi \in \Mor_S(\Spec(A), U) \mid \varphi|_{\Spec(k)} = u_0\}
$$
Unwinding the definitions the reader verifies that the resulting map
$$
\underline{R}|_{\mathcal{C}_\Lambda} =
\mathcal{F}_{(\Sch/U)_{fppf}, k, u_0}
\xrightarrow{\hat x}
\mathcal{F}_{\mathcal{X}, k, x_0},
$$
is equal to $\underline{\xi}$ and we see that the lemma is true.
\end{proof}

\noindent
Here is a sanity check.

\begin{lemma}
\label{lemma-versal-implies-smooth}
Let $S$ be a locally Noetherian scheme. Let $f : U \to V$
be a morphism of schemes locally of finite type over $S$.
Let $u_0 \in U$ be a finite type point. The following are equivalent
\begin{enumerate}
\item $f$ is smooth at $u_0$,
\item $f$ viewed as an object of $(\Sch/V)_{fppf}$ over $U$ is
versal at $u_0$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a restatement of More on Morphisms, Lemma
\ref{more-morphisms-lemma-lifting-along-artinian-at-point}.
\end{proof}

\noindent
It turns out that this notion is well behaved with respect to field
extensions.

\begin{lemma}
\label{lemma-versal-change-of-field}
Let $S$, $\mathcal{X}$, $U$, $x$, $u_0$ be as in
Definition \ref{definition-versal}. Let $l$ be a field and let
$u_{l, 0} : \Spec(l) \to U$ be a morphism with image $u_0$ such that
$l/k = \kappa(u_0)$ is finite. Set $x_{l, 0} = x_0|_{\Spec(l)}$.
If $\mathcal{X}$ satisfies (RS) and $x$ is versal at $u_0$, then
$$
\mathcal{F}_{(\Sch/U)_{fppf}, l, u_{l, 0}}
\longrightarrow
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
$$
is smooth.
\end{lemma}

\begin{proof}
Note that $(\Sch/U)_{fppf}$ satisfies (RS) by
Lemma \ref{lemma-algebraic-stack-RS}.
Hence the functor of the lemma is the functor
$$
(\mathcal{F}_{(\Sch/U)_{fppf}, k , u_0})_{l/k}
\longrightarrow
(\mathcal{F}_{\mathcal{X}, k , x_0})_{l/k}
$$
associated to $\hat x$, see Lemma \ref{lemma-change-of-field}.
Hence the lemma follows from
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-change-of-fields-smooth}.
\end{proof}

\noindent
The following lemma is another sanity check. It more or less
signifies that if $x$ is versal at $u_0$ as in
Definition \ref{definition-versal},
then $x$ viewed as a morphism from $U$ to $\mathcal{X}$ is
smooth whenever we make a base change by a scheme.

\begin{lemma}
\label{lemma-base-change-versal}
Let $S$, $\mathcal{X}$, $U$, $x$, $u_0$ be as in
Definition \ref{definition-versal}. Assume
\begin{enumerate}
\item $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces,
\item $\mathcal{X}$ is limit preserving, and
\item $\mathcal{X}$ has (RS).
\end{enumerate}
Let $V$ be a scheme locally of finite type over $S$
and let $y$ be an object of $\mathcal{X}$ over $V$.
Form the $2$-fibre product
$$
\xymatrix{
\mathcal{Z} \ar[r] \ar[d] & (\Sch/U)_{fppf} \ar[d]^x \\
(\Sch/V)_{fppf} \ar[r]^y & \mathcal{X}
}
$$
Let $Z$ be the algebraic space representing $\mathcal{W}$
and let $z_0 \in |Z|$ be a finite type point lying over $u_0$.
If $x$ is versal at $u_0$, then
the morphism $Z \to V$ is smooth at $z_0$.
\end{lemma}

\begin{proof}
Observe that $Z$ exists by Algebraic Stacks, Lemma
\ref{algebraic-lemma-representable-diagonal}.
By Lemma \ref{lemma-diagonal} we see that
$Z \to V \times_S U$ is locally of finite type.
Choose a scheme $W$, a closed point $w_0 \in W$, and
an \'etale morphism $W \to Z$ mapping $w_0$ to $z_0$, see
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-finite-type-point}.
Then $W$ is locally of finite type over $S$ and
$w_0$ is a finite type point of $W$.
Let $l = \kappa(z_0)$. Denote $z_{l, 0}$, $v_{l, 0}$,
$u_{l, 0}$, and $x_{l, 0}$ the objects of
$\mathcal{Z}$, $(\Sch/V)_{fppf}$, $(\Sch/U)_{fppf}$,
and $\mathcal{X}$ over $\Spec(l)$ obtained by pullback to $\Spec(l) = w_0$.
Consider
$$
\xymatrix{
\mathcal{F}_{(\Sch/W)_{fppf}, l, w_0} \ar[r] &
\mathcal{F}_{\mathcal{Z}, l, z_{l, 0}} \ar[d] \ar[r] &
\mathcal{F}_{(\Sch/U)_{fppf}, l, u_{l, 0}} \ar[d] \\
& \mathcal{F}_{(\Sch/V)_{fppf}, l, v_{l, 0}} \ar[r] &
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}
}
$$
By Lemma \ref{lemma-fibre-product-deformation-categories}
the square is a fibre product of predeformation categories.
By Lemma \ref{lemma-versal-change-of-field}
we see that the right vertical arrow is smooth.
By Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-smooth-properties}
the left vertical arrow is smooth.
By Lemma \ref{lemma-formally-smooth-on-deformation-categories}
we see that the left horizontal arrow is smooth.
We conclude that the map
$$
\mathcal{F}_{(\Sch/W)_{fppf}, l, w_0} \to
\mathcal{F}_{(\Sch/V)_{fppf}, l, v_{l, 0}}
$$
is smooth by Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-smooth-properties}.
Thus we conclude that $W \to V$ is smooth at $w_0$ by
More on Morphisms, Lemma
\ref{more-morphisms-lemma-lifting-along-artinian-at-point}.
This exactly means that $Z \to V$ is smooth at $z_0$
and the proof is complete.
\end{proof}

\noindent
We restate the approximation result in terms of
versal objects.

\begin{lemma}
\label{lemma-approximate-versal}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Let $\xi = (R, \xi_n, f_n)$ be a formal object of $\mathcal{X}$ with
$\xi_1$ lying over $\Spec(k) \to S$ with image $s \in S$. Assume
\begin{enumerate}
\item $\xi$ is versal,
\item $\xi$ is effective,
\item $\mathcal{O}_{S, s}$ is a G-ring, and
\item $p : \mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving on objects.
\end{enumerate}
Then there exist a morphism of finite type $U \to S$, a finite type
point $u_0 \in U$ with residue field $k$, and an object $x$ of $\mathcal{X}$
over $U$ such that $x$ is versal at $u_0$ and such that
$x|_{\Spec(k)} \cong \xi_1$.
\end{lemma}

\begin{proof}
Choose an object $x_R$ of $\mathcal{X}$ lying over $\Spec(R)$ whose associated
formal object is $\xi$. Let $N = 2$ and apply Lemma \ref{lemma-approximate}.
We obtain $A, \mathfrak m_A, x_A, \ldots$.
Let $\eta = (A^\wedge, \eta_n, g_n)$ be the formal object associated to
$x_A|_{\Spec(A^\wedge)}$. We have a diagram
$$
\vcenter{
\xymatrix{
& \eta \ar[d] \\
\xi \ar[r] \ar@{..>}[ru] & \xi_2 = \eta_2
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& A^\wedge \ar[d] \\
R \ar[r] \ar@{..>}[ru] & R/\mathfrak m_R^2 = A/\mathfrak m_A^2
}
}
$$
The versality of $\xi$ means exactly that we can find the
dotted arrows in the diagrams, because we can successively find
morphisms $\xi \to \eta_3$, $\xi \to \eta_4$, and so on by
Formal Deformation Theory, Remark \ref{formal-defos-remark-versal-object}.
The corresponding ring map $R \to A^\wedge$ is surjective by
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-surjective-cotangent-space}.
On the other hand, we have
$\dim_k \mathfrak m_R^n/\mathfrak m_R^{n + 1} =
\dim_k \mathfrak m_A^n/\mathfrak m_A^{n + 1}$ for all $n$ by construction.
Hence $R/\mathfrak m_R^n$ and $A/\mathfrak m_A^n$ have the same (finite)
length as $\Lambda$-modules by additivity of length and
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-length}.
It follows that $R/\mathfrak m_R^n \to A/\mathfrak m_A^n$ is an isomorphism
for all $n$, hence $R \to A^\wedge$ is an isomorphism. Thus $\eta$ is
isomorphic to a versal object, hence versal itself. By
Lemma \ref{lemma-versality-matches}
we conclude that $x_A$ is versal at the point $u_0$ of
$U = \Spec(A)$ corresponding to $\mathfrak m_A$.
\end{proof}

\begin{example}
\label{example-approximate-versal-implies}
In this example we show that the local ring $\mathcal{O}_{S, s}$ has to be
a G-ring in order for the result of Lemma \ref{lemma-approximate-versal} to
be true. Namely, let $\Lambda$ be a Noetherian ring and let $\mathfrak m$
be a maximal ideal of $\Lambda$. Set $R = \Lambda_\mathfrak m^\wedge$. Let
$\Lambda \to C \to R$ be a factorization with $C$ of finite type over
$\Lambda$. Set $S = \Spec(\Lambda)$, $U = S \setminus \{\mathfrak m\}$, and
$S' = U \amalg \Spec(C)$. Consider the functor
$F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ defined by the rule
$$
F(T) = 
\left\{
\begin{matrix}
* & \text{if }T \to S\text{ factors through }S' \\
\emptyset & \text{else}
\end{matrix}
\right.
$$
Let $\mathcal{X} = \mathcal{S}_F$ is the category fibred in sets associated
to $F$, see Algebraic Stacks, Section \ref{algebraic-section-split}.
Then $\mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving on objects and
there exists an effective, versal formal object $\xi$ over $R$.
Hence if the conclusion of Lemma \ref{lemma-approximate-versal} holds
for $\mathcal{X}$, then there exists a finite type ring map $\Lambda \to A$
and a maximal ideal $\mathfrak m_A$ lying over $\mathfrak m$ such that
\begin{enumerate}
\item $\kappa(\mathfrak m) = \kappa(\mathfrak m_A)$,
\item $\Lambda \to A$ and $\mathfrak m_A$ satisfy condition (4) of
Algebra, Lemma \ref{algebra-lemma-smooth-test-artinian}, and
\item there exists a $\Lambda$-algebra map $C \to A$.
\end{enumerate}
Thus $\Lambda \to A$ is smooth at $\mathfrak m_A$ by the lemma cited.
Slicing $A$ we may assume that $\Lambda \to A$ is \'etale at
$\mathfrak m_A$, see for example
More on Morphisms, Lemma \ref{more-morphisms-lemma-slice-smooth}
or argue directly. Write $C = \Lambda[y_1, \ldots, y_n]/(f_1, \ldots, f_m)$.
Then $C \to R$ corresponds to a solution in $R$ of the system of equations
$f_1 = \ldots = f_m = 0$, see Smoothing Ring Maps, Section
\ref{smoothing-section-approximation-G-rings}.
Thus if the conclusion of
Lemma \ref{lemma-approximate-versal} holds for every $\mathcal{X}$ as
above, then a system of equations which has a solution in $R$ has a
solution in the henselization of $\Lambda_{\mathfrak m}$.
In other words, the approximation property holds for
$\Lambda_{\mathfrak m}^h$. This implies that $\Lambda_{\mathfrak m}^h$
is a G-ring (insert future reference here; see also discussion in
Smoothing Ring Maps, Section \ref{smoothing-section-introduction})
which in turn implies that $\Lambda_{\mathfrak m}$ is a G-ring.
\end{example}






\section{Openness of versality}
\label{section-openness-versality}

\noindent
Next, we come to openness of versality.

\begin{definition}
\label{definition-openness-versality}
Let $S$ be a locally Noetherian scheme.
\begin{enumerate}
\item Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. We say $\mathcal{X}$ satisfies
{\it openness of versality} if given a scheme $U$ locally of finite type
over $S$, an object $x$ of $\mathcal{X}$ over $U$, and a finite type point
$u_0 \in U$ such that $x$ is versal at $u_0$, then there exists an open
neighbourhood $u_0 \in U' \subset U$ such that $x$ is versal at every finite
type point of $U'$.
\item Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. We say $f$ satisfies
{\it openness of versality} if given a scheme $U$ locally of finite type
over $S$, an object $y$ of $\mathcal{Y}$ over $U$, openness
of versality holds for
$(\Sch/U)_{fppf} \times_\mathcal{Y} \mathcal{X}$.
\end{enumerate}
\end{definition}

\noindent
Openness of versality is often the hardest to check. The following example
shows that requiring this is necessary however.

\begin{example}
\label{example-versality}
Let $k$ be a field and set $\Lambda = k[s, t]$. Consider the functor
$F : \Lambda\text{-algebras} \longrightarrow \textit{Sets}$
defined by the rule
$$
F(A) =
\left\{
\begin{matrix}
* & \text{if there exist }f_1, \ldots, f_n \in A\text{ such that } \\
  & A = (s, t, f_1, \ldots, f_n)\text{ and } f_i s = 0\ \forall i \\
\emptyset & \text{else}
\end{matrix}
\right.
$$
Geometrically $F(A) = *$ means there exists a quasi-compact open neighbourhood
$W$ of $V(s, t) \subset \Spec(A)$ such that $s|_W = 0$.
Let $\mathcal{X} \subset (\Sch/\Spec(\Lambda))_{fppf}$ be the full
subcategory consisting of schemes $T$ which have an affine open covering
$T = \bigcup \Spec(A_j)$ with $F(A_j) = *$ for all $j$. Then $\mathcal{X}$
satisfies [0], [1], [2], [3], and [4] but not [5]. Namely, over
$U = \Spec(k[s, t]/(s))$
there exists an object $x$ which is versal at $u_0 = (s, t)$ but not
at any other point. Details omitted.
\end{example}

\noindent
Let $S$ be a locally Noetherian scheme.
Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. Consider the following property
\begin{equation}
\label{equation-smooth}
\begin{matrix}
\text{for all fields }k\text{ of finite type over }S
\text{ and all }x_0 \in \Ob(\mathcal{X}_{\Spec(k)})\text{ the}\\
\text{map }
\mathcal{F}_{\mathcal{X}, k, x_0} \to \mathcal{F}_{\mathcal{Y}, k, f(x_0)}
\text{ of predeformation categories is smooth}
\end{matrix}
\end{equation}
We formulate some lemmas around this concept. First we link it with
(openness of) versality.

\begin{lemma}
\label{lemma-versal-smooth}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Let $U$ be a scheme locally
of finite type over $S$. Let $x$ be an object of $\mathcal{X}$ over $U$.
Assume that $x$ is versal at every finite type point of $U$ and that
$\mathcal{X}$ satisfies (RS). Then $x : (\Sch/U)_{fppf} \to \mathcal{X}$
satisfies (\ref{equation-smooth}).
\end{lemma}

\begin{proof}
Let $\Spec(l) \to U$ be a morphism with $l$ of finite type over $S$.
Then the image $u_0 \in U$ is a finite type point of $U$ and
$\kappa(u_0) \subset l$ is a finite extension, see discussion in
Morphisms, Section \ref{morphisms-section-points-finite-type}.
Hence we see that
$\mathcal{F}_{(\Sch/U)_{fppf}, l, u_{l, 0}} \to
\mathcal{F}_{\mathcal{X}, l, x_{l, 0}}$
is smooth by Lemma \ref{lemma-versal-change-of-field}.
\end{proof}

\begin{lemma}
\label{lemma-composition-smooth}
Let $S$ be a locally Noetherian scheme. Let $f : \mathcal{X} \to \mathcal{Y}$
and $g : \mathcal{Y} \to \mathcal{Z}$ be composable $1$-morphisms of
categories fibred in groupoids over $(\Sch/S)_{fppf}$. If $f$ and $g$
satisfy (\ref{equation-smooth}) so does $g \circ f$.
\end{lemma}

\begin{proof}
This follows formally from Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-smooth-properties}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-smooth}
Let $S$ be a locally Noetherian scheme. Let $f : \mathcal{X} \to \mathcal{Y}$
and $\mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of
categories fibred in groupoids over $(\Sch/S)_{fppf}$. If $f$
satisfies (\ref{equation-smooth}) so does the projection
$\mathcal{X} \times_\mathcal{Y} \mathcal{Z} \to \mathcal{Z}$.
\end{lemma}

\begin{proof}
Follows immediately from
Lemma \ref{lemma-fibre-product-deformation-categories}
and
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-smooth-properties}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-smooth}
Let $S$ be a locally Noetherian scheme. Let $f : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphisms of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
If $f$ is formally smooth on objects, then $f$ satisfies
(\ref{equation-smooth}). If $f$ is representable by algebraic spaces
and smooth, then $f$ satisfies (\ref{equation-smooth}).
\end{lemma}

\begin{proof}
A reformulation of Lemma \ref{lemma-formally-smooth-on-deformation-categories}.
\end{proof}

\begin{lemma}
\label{lemma-implies-smooth}
Let $S$ be a locally Noetherian scheme. Let $f : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume
\begin{enumerate}
\item $f$ is representable by algebraic spaces,
\item $f$ satisfies (\ref{equation-smooth}),
\item $\mathcal{X} \to (\Sch/S)_{fppf}$ is limit preserving on objects, and
\item $\mathcal{Y}$ is limit preserving.
\end{enumerate}
Then $f$ is smooth.
\end{lemma}

\begin{proof}
The key ingredient of the proof is More on Morphisms, Lemma
\ref{more-morphisms-lemma-lifting-along-artinian-at-point}
which (almost) says that a morphism of schemes of finite type over $S$
satisfying (\ref{equation-smooth}) is a smooth morphism. The other
arguments of the proof are essentially bookkeeping.

\medskip\noindent
Let $V$ be a scheme over $S$ and let $y$ be an object of $\mathcal{Y}$ over
$V$. Let $Z$ be an algebraic space representing the $2$-fibre product
$\mathcal{Z} = \mathcal{X} \times_{f, \mathcal{X}, y} (\Sch/V)_{fppf}$.
We have to show that the projection morphism $Z \to V$ is smooth, see
Algebraic Stacks, Definition
\ref{algebraic-definition-relative-representable-property}.
In fact, it suffices to do this when $V$ is an affine scheme
locally of finite presentation over $S$, see
Criteria for Representability, Lemma
\ref{criteria-lemma-check-property-limit-preserving}.
Then $(\Sch/V)_{fppf}$ is limit preserving by
Lemma \ref{lemma-limit-preserving-algebraic-space}.
Hence $Z \to S$ is locally of finite presentation by
Lemmas \ref{lemma-fibre-product-limit-preserving} and
\ref{lemma-limit-preserving-algebraic-space}.
Choose a scheme $W$ and a surjective \'etale morphism $W \to Z$.
Then $W$ is locally of finite presentation over $S$.

\medskip\noindent
Since $f$ satisfies (\ref{equation-smooth}) we see that so does
$\mathcal{Z} \to (\Sch/V)_{fppf}$, see Lemma \ref{lemma-base-change-smooth}.
Next, we see that $(\Sch/W)_{fppf} \to \mathcal{Z}$ satisfies
(\ref{equation-smooth}) by Lemma \ref{lemma-smooth-smooth}.
Thus the composition
$$
(\Sch/W)_{fppf} \to \mathcal{Z} \to (\Sch/V)_{fppf}
$$
satisfies (\ref{equation-smooth}) by Lemma \ref{lemma-composition-smooth}.
More on Morphisms, Lemma
\ref{more-morphisms-lemma-lifting-along-artinian-at-point}
shows that the composition $W \to Z \to V$ is smooth at every finite type
point $w_0$ of $W$. Since the smooth locus is open we conclude
that $W \to V$ is a smooth morphism of schemes by
Morphisms, Lemma \ref{morphisms-lemma-enough-finite-type-points}.
Thus we conclude that $Z \to V$ is a smooth morphism
of algebraic spaces by definition.
\end{proof}

\noindent
The lemma below is how we will use openness of versality.

\begin{lemma}
\label{lemma-get-smooth}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Let $k$ be a finite type field over $S$ and let $x_0$ be an object of
$\mathcal{X}$ over $\Spec(k)$ with image $s \in S$. Assume
\begin{enumerate}
\item $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ is
representable by algebraic spaces,
\item $\mathcal{X}$ satisfies axioms [1], [2], [3] (see
Section \ref{section-axioms}),
\item every formal object of $\mathcal{X}$ is effective,
\item openness of versality holds for $\mathcal{X}$, and
\item $\mathcal{O}_{S, s}$ is a G-ring.
\end{enumerate}
Then there exist a morphism of finite type $U \to S$ and an object
$x$ of $\mathcal{X}$ over $U$ such that
$$
x : (\Sch/U)_{fppf} \longrightarrow \mathcal{X}
$$
is smooth and such that there exists a finite type point $u_0 \in U$
whose residue field is $k$ and such that $x|_{u_0} \cong x_0$.
\end{lemma}

\begin{proof}
By axiom [2], Lemma \ref{lemma-deformation-category}, and
Remark \ref{remark-deformation-category-implies}
we see that $\mathcal{F}_{\mathcal{X}, k, x_0}$ satisfies (S1) and (S2).
Since also the tangent space has finite dimension by axiom [3]
we deduce from Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-versal-object-existence}
that $\mathcal{F}_{\mathcal{X}, k, x_0}$ has a versal formal object $\xi$.
Assumption (3) says $\xi$ is effective. By axiom [1] and
Lemma \ref{lemma-approximate-versal}
there exists a morphism of finite type $U \to S$, an object $x$ of
$\mathcal{X}$ over $U$, and a finite type point $u_0$ of $U$ with residue
field $k$ such that $x$ is versal at $u_0$ and such that
$x|_{\Spec(k)} \cong x_0$. By openness of versality we may shrink
$U$ and assume that $x$ is versal at every finite type point of $U$.
We claim that
$$
x : (\Sch/U)_{fppf} \longrightarrow \mathcal{X}
$$
is smooth which proves the lemma. Namely, by Lemma \ref{lemma-versal-smooth}
$x$ satisfies (\ref{equation-smooth})
whereupon Lemma \ref{lemma-implies-smooth}
finishes the proof.
\end{proof}






\section{Axioms}
\label{section-axioms}

\noindent
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}$ be a category fibred in groupoids.
Here are the axioms we will consider on $\mathcal{X}$.
\begin{enumerate}
\item[{[-1]}] a set theoretic condition\footnote{The condition is the
following: the supremum of all the cardinalities
$|\Ob(\mathcal{X}_{\Spec(k)})/\cong|$ and
$|\text{Arrows}(\mathcal{X}_{\Spec(k)})|$ where $k$ runs over the finite
type fields over $S$ is $\leq$ than the size of some
object of $(\Sch/S)_{fppf}$.} to be ignored by
readers who are not interested in set theoretical issues,
\item[{[0]}] $\mathcal{X}$ is a stack in groupoids for the \'etale topology,
\item[{[1]}] $\mathcal{X}$ is limit preserving,
\item[{[2]}] $\mathcal{X}$ satisfies the Rim-Schlessinger condition (RS),
\item[{[3]}] the spaces $T\mathcal{F}_{\mathcal{X}, k, x_0}$ and
$\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0})$
are finite dimensional
for every $k$ and $x_0$, see
(\ref{equation-tangent-space}) and
(\ref{equation-infinitesimal-automorphisms}),
\item[{[4]}] the functor (\ref{equation-approximation}) is an equivalence,
\item[{[5]}] $\mathcal{X}$ and
$\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ satisfy
openness of versality.
\end{enumerate}










\section{Axioms for functors}
\label{section-axioms-functors}

\noindent
Let $S$ be a scheme. Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a
functor. Denote $\mathcal{X} = \mathcal{S}_F$ the category fibred in sets
associated to $F$, see Algebraic Stacks, Section \ref{algebraic-section-split}.
In this section we provide a translation between the material above
as it applies to $\mathcal{X}$, to statements about $F$.

\medskip\noindent
Let $S$ be a locally Noetherian scheme. Let
$F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor. Let $k$ be
a field of finite type over $S$. Let $x_0 \in F(\Spec(k))$.
The associated predeformation category (\ref{equation-predeformation-category})
corresponds to the functor
$$
F_{k, x_0} : \mathcal{C}_\Lambda \longrightarrow \textit{Sets},
\quad
A \longmapsto \{x \in F(\Spec(A)) \mid x|_{\Spec(k)} = x_0 \}.
$$
Recall that we do not distinguish between
categories cofibred in sets over $\mathcal{C}_\Lambda$
and functor $\mathcal{C}_\Lambda \to \textit{Sets}$,
see Formal Deformation Theory, Remarks
\ref{formal-defos-remarks-cofibered-groupoids}
(\ref{formal-defos-item-convention-cofibered-sets}).
Given a transformation of functors $a : F \to G$, setting
$y_0 = a(x_0)$ we obtain a morphism
$$
F_{k, x_0} \longrightarrow G_{k, y_0}
$$
see (\ref{equation-functoriality}).
Lemma \ref{lemma-formally-smooth-on-deformation-categories} tells us that if
$a : F \to G$ is formally smooth (in the sense of
More on Morphisms of Spaces, Definition
\ref{spaces-more-morphisms-definition-formally-smooth-etale-unramified}), then
$F_{k, x_0} \longrightarrow G_{k, y_0}$ is smooth as
in Formal Deformation Theory, Remark
\ref{formal-defos-remark-compare-smooth-schlessinger}.

\medskip\noindent
Lemma \ref{lemma-pushout} says that if $Y' = Y \amalg_X X'$ in the
category of schemes over $S$ where $X \to X'$ is a thickening and
$X \to Y$ is affine, then the map
$$
F(Y \amalg_X X') \to F(Y) \times_{F(X)} F(X')
$$
is a bijection, provided that $F$ is an algebraic space.
We say a general functor $F$ satisfies the {\it Rim-Schlessinger condition}
or we say $F$ {\it satisfies (RS)} if given any
pushout $Y' = Y \amalg_X X'$ where $Y, X, X'$ are spectra of Artinian
local rings of finite type over $S$, then
$$
F(Y \amalg_X X') \to F(Y) \times_{F(X)} F(X')
$$
is a bijection. Thus every algebraic space satisfies (RS).

\medskip\noindent
Lemma \ref{lemma-deformation-category} says that
given a functor $F$ which satisfies (RS), then all $F_{k, x_0}$
are deformation functors as in
Formal Deformation Theory, Definition
\ref{formal-defos-definition-deformation-category}, i.e., they satisfy
(RS) as in
Formal Deformation Theory, Remark
\ref{formal-defos-remark-compare-schlessinger-H4}.
In particular the tangent space
$$
TF_{k, x_0} = \{x \in F(\Spec(k[\epsilon])) \mid x|_{\Spec(k)} = x_0\}
$$
has the structure of a $k$-vector space by Formal Deformation Theory,
Lemma \ref{formal-defos-lemma-tangent-space-vector-space}.

\medskip\noindent
Lemma \ref{lemma-finite-dimension} says that an algebraic space $F$
locally of finite type over $S$ gives rise to deformation functors
$F_{k, x_0}$ with finite dimensional tangent spaces $TF_{k, x_0}$.

\medskip\noindent
A {\it formal object}\footnote{This is what Artin calls a formal deformation.}
$\xi = (R, \xi_n)$ of $F$ consists of a Noetherian
complete local $S$-algebra $R$ whose residue field is of finite type
over $S$, together with elements $\xi_n \in F(\Spec(R/\mathfrak m^n))$
such that $\xi_{n + 1}|_{\Spec(R/\mathfrak m^n)} = \xi_n$. A formal
object $\xi$ defines a formal object $\xi$ of $F_{R/\mathfrak m, \xi_1}$.
We say $\xi$ is {\it versal} if and only if it is versal in the sense of
Formal Deformation Theory, Definition \ref{formal-defos-definition-versal}.
A formal object $\xi = (R, \xi_n)$ is called {\it effective}
if there exists an $x \in F(\Spec(R))$ such that
$\xi_n = x|_{\Spec(R/\mathfrak m^n)}$ for all $n \geq 1$.
Lemma \ref{lemma-effective} says that if $F$ is an algebraic space,
then every formal object is effective.

\medskip\noindent
Let $U$ be a scheme locally of finite type over $S$ and let $x \in F(U)$.
Let $u_0 \in U$ be a finite type point. We say that $x$ is versal at $u_0$
if and only if
$\xi = (\mathcal{O}_{U, u_0}^\wedge,
x|_{\Spec(\mathcal{O}_{U, u_0}/\mathfrak m_{u_0}^n)})$
is a versal formal object in the sense described above.

\medskip\noindent
Let $S$ be a locally Noetherian scheme. Let
$F : (\Sch/S)_{fppf}^{opp} \to \Sch$ be a functor.
Here are the axioms we will consider on $F$.
\begin{enumerate}
\item[{[-1]}]  a set theoretic condition\footnote{The condition is the
following: the supremum of all the cardinalities
$|F(\Spec(k))|$ where $k$ runs over the finite
type fields over $S$ is $\leq$ than the size of some
object of $(\Sch/S)_{fppf}$.} to be ignored by
readers who are not interested in set theoretical issues,
\item[{[0]}] $F$ is a sheaf for the \'etale topology,
\item[{[1]}] $F$ is limit preserving,
\item[{[2]}] $F$ satisfies the Rim-Schlessinger condition (RS),
\item[{[3]}] every tangent space $TF_{k, x_0}$ is finite dimensional,
\item[{[4]}] every formal object is effective,
\item[{[5]}] $F$ satisfies openness of versality.
\end{enumerate}
Here {\it limit preserving} is the notion defined in
Limits of Spaces, Definition
\ref{spaces-limits-definition-locally-finite-presentation} and
{\it openness of versality} means the following: Given a scheme $U$
locally of finite type over $S$, given $x \in F(U)$, and given
a finite type point $u_0 \in U$ such that $x$ is versal at $u_0$,
then there exists an open neighbourhood $u_0 \in U' \subset U$
such that $x$ is versal at every finite type point of $U'$.






\section{Algebraic spaces}
\label{section-algebraic-spaces}

\noindent
The following is our first main result on algebraic spaces.

\begin{proposition}
\label{proposition-spaces-diagonal-representable}
Let $S$ be a locally Noetherian scheme. Let
$F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor. Assume that
\begin{enumerate}
\item $\Delta : F \to F \times F$ is representable by algebraic spaces,
\item $F$ satisfies axioms [-1], [0], [1], [2], [3], [4], [5]
(see Section \ref{section-axioms-functors}), and
\item $\mathcal{O}_{S, s}$ is a G-ring for all finite type points $s$ of $S$.
\end{enumerate}
Then $F$ is an algebraic space.
\end{proposition}

\begin{proof}
Lemma \ref{lemma-get-smooth} applies to $F$. Using this we
choose, for every finite type field $k$ over $S$ and $x_0 \in F(\Spec(k))$,
an affine scheme $U_{k, x_0}$ of finite type over $S$ and a smooth morphism
$U_{k, x_0} \to F$ such that there exists a finite type point
$u_{k, x_0} \in U_{k, x_0}$ with residue field $k$ such that $x_0$
is the image of $u_{k, x_0}$. Then
$$
U = \coprod\nolimits_{k, x_0} U_{k, x_0} \longrightarrow F
$$
is smooth\footnote{Set theoretical remark: This coproduct is (isomorphic)
to an object of $(\Sch/S)_{fppf}$ as we have a bound on the index set
by axiom [-1], see Sets, Lemma \ref{sets-lemma-what-is-in-it}.}.
To finish the proof it suffices to show this map is surjective,
see Bootstrap, Lemma \ref{bootstrap-lemma-spaces-etale-smooth-cover}
(this is where we use axiom [0]). By Criteria for Representability, Lemma
\ref{criteria-lemma-check-property-limit-preserving}
it suffices to show that $U \times_F V \to V$ is surjective for those
$V \to F$ where $V$ is an affine scheme locally of finite presentation
over $S$. Since $U \times_F V \to V$ is smooth the image is open. Hence
it suffices to show that the image of $U \times_F V \to V$ contains all
finite type points of $V$, see
Morphisms, Lemma \ref{morphisms-lemma-enough-finite-type-points}.
Let $v_0 \in V$ be a finite type point. Then $k = \kappa(v_0)$ is
a finite type field over $S$. Denote $x_0$ the composition
$\Spec(k) \xrightarrow{v_0} V \to F$. Then
$(u_{k, x_0}, v_0) : \Spec(k) \to U \times_F V$ is a point mapping to
$v_0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-monomorphism}
Let $S$ be a locally Noetherian scheme. Let $a : F \to G$ be a transformation
of functors $(\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Assume that
\begin{enumerate}
\item $a$ is injective,
\item $F$ satisfies axioms [0], [1], [2], [4], and [5],
\item $\mathcal{O}_{S, s}$ is a G-ring for all finite type points $s$ of $S$,
\item $G$ is an algebraic space locally of finite type over $S$,
\end{enumerate}
Then $F$ is an algebraic space.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-dimension} the functor $G$ satisfies [3].
As $F \to G$ is injective, we conclude that $F$ also satisfies [3].
Moreover, as $F \to G$ is injective, we see that given schemes
$U$, $V$ and morphisms $U \to F$ and $V \to F$, then
$U \times_F V = U \times_G V$. Hence $\Delta : F \to F \times F$ is
representable (by schemes) as this holds for $G$ by assumption.
Thus Proposition \ref{proposition-spaces-diagonal-representable}
applies\footnote{The set
theoretic condition [-1] holds for $F$ as it holds for $G$. Details
omitted.}.
\end{proof}












\section{Algebraic stacks}
\label{section-algebraic-stacks}

\noindent
Proposition \ref{proposition-second-diagonal-representable} is our first
main result on algebraic stacks.

\begin{lemma}
\label{lemma-diagonal-representable}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}^{opp}$ be a category fibred in groupoids.
Assume that
\begin{enumerate}
\item $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces,
\item $\mathcal{X}$ satisfies axioms [-1], [0], [1], [2], [3] (see
Section \ref{section-axioms}),
\item every formal object of $\mathcal{X}$ is effective,
\item $\mathcal{X}$ satisfies openness of versality, and
\item $\mathcal{O}_{S, s}$ is a G-ring for all finite type points $s$ of $S$.
\end{enumerate}
Then $\mathcal{X}$ is an algebraic stack.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-get-smooth} applies to $\mathcal{X}$. Using this we
choose, for every finite type field $k$ over $S$ and every
isomorphism class of object $x_0 \in \Ob(\mathcal{X}_{\Spec(k)})$,
an affine scheme $U_{k, x_0}$ of finite type over $S$ and a smooth morphism
$(\Sch/U_{k, x_0})_{fppf} \to \mathcal{X}$ such that there exists a finite
type point $u_{k, x_0} \in U_{k, x_0}$ with residue field $k$ such that $x_0$
is the image of $u_{k, x_0}$. Then
$$
(\Sch/U)_{fppf} \to \mathcal{X},
\quad\text{with}\quad
U = \coprod\nolimits_{k, x_0} U_{k, x_0}
$$
is smooth\footnote{Set theoretical remark: This coproduct is (isomorphic to)
an object of $(\Sch/S)_{fppf}$ as we have a bound on the index set
by axiom [-1], see Sets, Lemma \ref{sets-lemma-what-is-in-it}.}.
To finish the proof it suffices to show this map is surjective,
see Criteria for Representability, Lemma \ref{criteria-lemma-stacks-etale}
(this is where we use axiom [0]). By Criteria for Representability, Lemma
\ref{criteria-lemma-check-property-limit-preserving}
it suffices to show that
$(\Sch/U)_{fppf} \times_\mathcal{X} (\Sch/V)_{fppf} \to (\Sch/V)_{fppf}$
is surjective for those $y : (\Sch/V)_{fppf} \to \mathcal{X}$ where
$V$ is an affine scheme locally of finite presentation
over $S$. By assumption (1) the fibre product
$(\Sch/U)_{fppf} \times_\mathcal{X} (\Sch/V)_{fppf}$ is representable
by an algebraic space $W$. Then $W \to V$ is smooth, hence the image is
open. Hence it suffices to show that the image of $W \to V$ contains all
finite type points of $V$, see
Morphisms, Lemma \ref{morphisms-lemma-enough-finite-type-points}.
Let $v_0 \in V$ be a finite type point. Then $k = \kappa(v_0)$ is
a finite type field over $S$. Denote $x_0 = y|_{\Spec(k)}$
the pullback of $y$ by $v_0$. Then $(u_{k, x_0}, v_0)$ will give
a morphism $\Spec(k) \to W$ whose composition with $W \to V$
is $v_0$ and we win.
\end{proof}

\begin{proposition}
\label{proposition-second-diagonal-representable}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}^{opp}$ be a category fibred in groupoids.
Assume that
\begin{enumerate}
\item $\Delta_\Delta : \mathcal{X} \to
\mathcal{X} \times_{\mathcal{X} \times \mathcal{X}} \mathcal{X}$
is representable by algebraic spaces,
\item $\mathcal{X}$ satisfies axioms [-1], [0], [1], [2], [3], [4], and [5]
(see Section \ref{section-axioms}),
\item $\mathcal{O}_{S, s}$ is a G-ring for all finite type points $s$ of $S$.
\end{enumerate}
Then $\mathcal{X}$ is an algebraic stack.
\end{proposition}

\begin{proof}
We first prove that $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
is representable by algebraic spaces. To do this it suffices to show
that
$$
\mathcal{Y} =
\mathcal{X} \times_{\Delta, \mathcal{X} \times \mathcal{X}, y} (\Sch/V)_{fppf}
$$
is representable by an algebraic space for any affine scheme $V$ locally
of finite presentation over $S$ and object $y$ of
$\mathcal{X} \times \mathcal{X}$ over $V$, see
Criteria for Representability, Lemma
\ref{criteria-lemma-check-representable-limit-preserving}\footnote{The
set theoretic condition in Criteria for Representability, Lemma
\ref{criteria-lemma-check-representable-limit-preserving}
will hold: the size of the algebraic space $Y$ representing $\mathcal{Y}$ is
suitably bounded. Namely, $Y \to S$ will be locally of finite type and $Y$
will satisfy axiom [-1]. Details omitted.}.
Observe that $\mathcal{Y}$ is fibred in setoids
(Stacks, Lemma \ref{stacks-lemma-isom-as-2-fibre-product})
and let $Y : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$,
$T \mapsto \Ob(\mathcal{Y}_T)/\cong$ be the functor of isomorphism
classes. We will apply
Proposition \ref{proposition-spaces-diagonal-representable}
to see that $Y$ is an algebraic space.

\medskip\noindent
Note that
$\Delta_\mathcal{Y} : \mathcal{Y} \to \mathcal{Y} \times \mathcal{Y}$
(and hence also $Y \to Y \times Y$)
is representable by algebraic spaces by condition (1) and
Criteria for Representability, Lemma \ref{criteria-lemma-second-diagonal}.
Observe that $Y$ is a sheaf for the \'etale topology by
Stacks, Lemmas \ref{stacks-lemma-stack-in-setoids-characterize} and
\ref{stacks-lemma-2-fibre-product-gives-stack-in-setoids}, i.e.,
axiom [0] holds. Also $Y$ is limit preserving by
Lemma \ref{lemma-fibre-product-limit-preserving}, i.e., we have [1].
Note that $Y$ has (RS), i.e., axiom [2] holds, by
Lemmas \ref{lemma-algebraic-stack-RS} and
\ref{lemma-fibre-product-RS}. Axiom [3] for $Y$ follows
from Lemmas \ref{lemma-finite-dimension} and
\ref{lemma-fibre-product-tangent-spaces}.
Axiom [4] follows from Lemmas \ref{lemma-effective} and
\ref{lemma-fibre-product-effective}.
Axiom [5] for $Y$ follows directly from openness of versality
for $\Delta_\mathcal{X}$ which is part of axiom [5] for $\mathcal{X}$.
Thus all the assumptions of
Proposition \ref{proposition-spaces-diagonal-representable}
are satisfied and $Y$ is an algebraic space.

\medskip\noindent
At this point it follows from Lemma \ref{lemma-diagonal-representable}
that $\mathcal{X}$ is an algebraic stack.
\end{proof}





\section{Strong Rim-Schlessinger}
\label{section-RS-star}

\noindent
In the rest of this chapter the following strictly stronger version
of the Rim-Schlessinger conditions will play an important role.

\begin{definition}
\label{definition-RS-star}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. We say $\mathcal{X}$
satisfies {\it condition (RS*)} if given an affine open
$\Spec(\Lambda) \subset S$ and a fibre product diagram
$$
\xymatrix{
B' \ar[r] & B \\
A' = A \times_B B' \ar[u] \ar[r] & A \ar[u]
}
$$
of $\Lambda$-algebras, with $B' \to B$ surjective with square zero kernel,
the functor of fibre categories
$$
\mathcal{X}_{\Spec(A')}
\longrightarrow
\mathcal{X}_{\Spec(A)} \times_{\mathcal{X}_{\Spec(B)}} \mathcal{X}_{\Spec(B')}
$$
is an equivalence of categories.
\end{definition}

\noindent
We make some observations:
with $A \to B \leftarrow B'$ as in Definition \ref{definition-RS-star}
\begin{enumerate}
\item if $A$, $B$, $B'$ are of finite type over $\Lambda$ and
$B$ is finite over $A$, then $A'$ is of finite type over $\Lambda$, see
More on Algebra, Lemma \ref{more-algebra-lemma-fibre-product-finite-type},
\item we have $\Spec(A') = \Spec(A) \amalg_{\Spec(B)} \Spec(B')$
in the category of schemes, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening},
\item if $\mathcal{X}$ is an algebraic stack, then $\mathcal{X}$ satisfies
(RS*) by Lemma \ref{lemma-pushout}, and
\item if $\mathcal{X}$ satisfies
(RS*), then $\mathcal{X}$ satisfies (RS) because (RS) covers exactly those
cases of (RS*) where $A$, $B$, $B'$ are Artinian local.
\end{enumerate}

\begin{lemma}
\label{lemma-algebraic-stack-RS-star}
Let $\mathcal{X}$ be an algebraic stack over a locally Noetherian base
$S$. Then $\mathcal{X}$ satisfies (RS*).
\end{lemma}

\begin{proof}
Immediate from the definitions, the remarks following
Definition \ref{definition-RS-star}, and
Lemma \ref{lemma-pushout}.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-RS-star}
Let $S$ be a scheme. Let $p : \mathcal{X} \to \mathcal{Y}$ and
$q : \mathcal{Z} \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $(\Sch/S)_{fppf}$. If $\mathcal{X}$, $\mathcal{Y}$,
and $\mathcal{Z}$ satisfy (RS*), then so
does $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$.
\end{lemma}

\begin{proof}
The proof is exactly the same as the proof of
Lemma \ref{lemma-fibre-product-RS}.
\end{proof}






\section{Strong formal effectiveness}
\label{section-strong-formal-effectiveness}

\noindent
In this section we demonstrate how a strong version of effectiveness
of formal objects implies openness of versality.

\begin{lemma}
\label{lemma-infinite-sequence}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$ having (RS*).
Let $x$ be an object of
$\mathcal{X}$ over an affine scheme $U$ of finite type over $S$.
Let $u_n \in U$, $n \geq 1$ be pairwise distinct finite type points
such that $x$ is not versal at $u_n$ for all $n$. After replacing
$u_n$ by a subsequence, there exist morphisms
$$
x \to x_1 \to x_2 \to \ldots
\quad\text{in }\mathcal{X}\text{ lying over }\quad
U \to U_1 \to U_2 \to \ldots
$$
over $S$ such that
\begin{enumerate}
\item for each $n$ the morphism $U \to U_n$ is a first order
thickening,
\item for each $n$ we have a short exact sequence
$$
0 \to \kappa(u_n) \to \mathcal{O}_{U_n} \to \mathcal{O}_{U_{n - 1}} \to 0
$$
with $U_0 = U$ for $n = 1$,
\item for each $n$ there does {\bf not} exist a pair $(W, \alpha)$
consisting of an open neighbourhood $W \subset U_n$ of $u_n$
and a morphism $\alpha : x_n|_W \to x$
such that the composition
$$
x|_{U \cap W} \xrightarrow{\text{restriction of }x \to x_n}
x_n|_W \xrightarrow{\alpha} x
$$
is the canonical morphism $x|_{U \cap W} \to x$.
\end{enumerate}
\end{lemma}

\begin{proof}
After replacing $u_n$, $n \geq 1$ by a subsequence we may and do
assume that there are no specializations among these points, see
Properties, Lemma \ref{properties-lemma-thin-infinite-sequence}.
In particular, for every $n$ we can find an open $U' \subset U$
such that $u_n \in U'$ and $u_i \not \in U'$ for $i = 1, \ldots, n - 1$.
This means that the problem of constructing our system
decomposes into a separate problem for each $n$.
More precisely, suppose that for each $n \geq 1$ we can find
$$
x \to y_n
\quad\text{in }\mathcal{X}\text{ lying over}\quad
U \to T_n
$$
such that
\begin{enumerate}
\item the morphism $U \to T_n$ is a first order thickening,
\item we have a short exact sequence
$$
0 \to \kappa(u_n) \to \mathcal{O}_{T_n} \to \mathcal{O}_U \to 0
$$
\item for each $n$ there does {\bf not} exist a pair $(W, \alpha)$
consisting of an open neighbourhood $W \subset T_n$ of $u_n$
and a morphism $\beta : y_n|_W \to x$ such that the composition
$$
x|_{U \cap W} \xrightarrow{\text{restriction of }x \to y_n}
y_n|_W \xrightarrow{\beta} x
$$
is the canonical morphism $x|_{U \cap W} \to x$.
\end{enumerate}
Then we can define inductively
$$
U_1 = T_1, \quad
U_{n + 1} = U_n \amalg_U T_{n + 1}
$$
Setting $x_1 = y_1$ and using (RS*) we find inductively
$x_{n + 1}$ over $U_{n + 1}$ restricting to
$x_n$ over $U_n$ and $y_{n + 1}$ over $T_{n + 1}$.
Property (1) for $U \to U_n$ follows from the construction
of the pushout in More on Morphisms, Lemma
\ref{more-morphisms-lemma-pushout-along-closed-immersions}.
Property (2) for $U_n$ similarly follows from
property (2) for $T_n$ by the construction of the pushout.
After shrinking to an open neighbourhood $U'$ of $u_n$
as discussed above, property (3) for $(U_n, x_n)$ follows from property (3)
for $(T_n, y_n)$ simply because the corresponding open subschemes
of $T_n$ and $U_n$ are isomorphic. Details omitted.

\medskip\noindent
This reduces us to the following: suppose given a single
finite type point $u \in U$ such that $x$ is not versal at $u$,
we need to construct a morphism $x \to y$ of $\mathcal{X}$ lying
over $U \to T$ satisfying properties (1), (2), and (3) formulated above.
Let $R = \mathcal{O}_{U, u}^\wedge$. Let $k = \kappa(u)$
be the residue field of $R$. Let $\xi$ be the formal object
of $\mathcal{X}$ over $R$ associated to $x$. Since $x$ is not
versal at $u$, we see that $\xi$ is not versal, see
Lemma \ref{lemma-versality-matches}. By the discussion following
Definition \ref{definition-versal-formal-object}
this means we can find
morphisms $\xi_1 \to x_A \to x_B$ of $\mathcal{X}$ lying over
closed immersions $\Spec(k) \to \Spec(A) \to \Spec(B)$
where $A, B$ are Artinian local rings with residue field $k$,
an $n \geq 1$ and a commutative diagram
$$
\vcenter{
\xymatrix{
& x_A \ar[ld] \\
\xi_n & \xi_1 \ar[u] \ar[l]
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& \Spec(A) \ar[ld] \\
\Spec(R/\mathfrak m^n) & \Spec(k) \ar[u] \ar[l]
}
}
$$
such that there does {\bf not} exist an $m \geq n$ and a commutative diagram
$$
\vcenter{
\xymatrix{
& & x_B \ar[lldd] \\
& & x_A \ar[ld] \ar[u] \\
\xi_m & \xi_n \ar[l] & \xi_1 \ar[u] \ar[l]
}
}
\quad\text{lying over}
\vcenter{
\xymatrix{
& & \Spec(B) \ar[lldd] \\
& & \Spec(A) \ar[ld] \ar[u] \\
\Spec(R/\mathfrak m^m) &
\Spec(R/\mathfrak m^n) \ar[l] &
\Spec(k) \ar[u] \ar[l]
}
}
$$
We may moreover assume that $B \to A$ is a small
extension, i.e., that the kernel $I$ of the surjection $B \to A$
is isomorphic to $k$ as an $A$-module.
This follows from Formal Deformation Theory, Remark
\ref{formal-defos-remark-versal-object}.
Then we simply define
$$
T = U \amalg_{\Spec(A)} \Spec(B)
$$
By property (RS*) we find $y$ over $T$ whose restriction to
$\Spec(B)$ is $x_B$ and whose restriction to $U$ is $x$
(this gives the arrow $x \to y$ lying over $U \to T$).
To finish the proof we verify conditions (1), (2), and (3).

\medskip\noindent
By the construction of the pushout we have a commutative diagram
$$
\xymatrix{
0 \ar[r] &
I \ar[r] &
B \ar[r] &
A \ar[r] &
0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
\Gamma(T, \mathcal{O}_T) \ar[r] \ar[u] &
\Gamma(U, \mathcal{O}_U) \ar[r] \ar[u] &
0
}
$$
with exact rows. This immediately proves (1) and (2).
To finish the proof we will argue by contradiction.
Assume we have a pair $(W, \beta)$ as in (3).
Since $\Spec(B) \to T$ factors through $W$ we get the morphism
$$
x_B \to y|_W \xrightarrow{\beta} x
$$
Since $B$ is Artinian local with residue field $k = \kappa(u)$
we see that $x_B \to x$ lies over a morphism $\Spec(B) \to U$
which factors through $\Spec(\mathcal{O}_{U, u}/\mathfrak m_u^m)$
for some $m \geq n$. In other words, $x_B \to x$ factors
through $\xi_m$ giving a map $x_B \to \xi_m$.
The compatibility condition on the morphism $\alpha$
in condition (3) translates into the condition that
$$
\xymatrix{
x_B \ar[d] & x_A \ar[d] \ar[l] \\
\xi_m & \xi_n \ar[l]
}
$$
is commutative. This gives the contradiction we were looking for.
\end{proof}

\begin{remark}[Strong effectiveness]
\label{remark-strong-effectiveness}
Let $S$ be a locally Noetherian scheme.
Let $\mathcal{X}$ be a category fibred in groupoids over $(\Sch/S)_{fppf}$.
Assume we have
\begin{enumerate}
\item an affine open $\Spec(\Lambda) \subset S$,
\item an inverse system $(R_n)$ of $\Lambda$-algebras
with surjective transition maps whose kernels are locally nilpotent,
\item a system $(\xi_n)$ of objects of $\mathcal{X}$ lying
over the system $(\Spec(R_n))$.
\end{enumerate}
In this situation, set $R = \lim R_n$. We say that
$(\xi_n)$ is {\it effective} if there exists an object
$\xi$ of $\mathcal{X}$ over $\Spec(R)$ whose restriction
to $\Spec(R_n)$ gives the system $(\xi_n)$.
\end{remark}

\noindent
It is not the case that every algebraic stack $\mathcal{X}$
over $S$ satisfies a strong effectiveness axiom of the form:
every system $(\xi_n)$ as in Remark \ref{remark-strong-effectiveness}
is effective. An example is given in
Examples, Section \ref{examples-section-non-formal-effectiveness}.

\begin{lemma}
\label{lemma-SGE-implies-openness-versality}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. Assume
\begin{enumerate}
\item $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ is
representable by algebraic spaces,
\item $\mathcal{X}$ has (RS*),
\item $\mathcal{X}$ is limit preserving,
\item systems $(\xi_n)$ as in Remark \ref{remark-strong-effectiveness}
where $\Ker(R_m \to R_n)$ is an ideal of square zero for all $m \geq n$
are effective.
\end{enumerate}
Then $\mathcal{X}$ satisfies openness of versality.
\end{lemma}

\begin{proof}
Choose a scheme $U$ locally of finite type over $S$,
a finite type point $u_0$ of $U$, and an object $x$ of $\mathcal{X}$
over $U$ such that $x$ is versal at $u_0$. After shrinking
$U$ we may assume $U$ is affine and $U$ maps into an affine open
$\Spec(\Lambda)$ of $S$. If openness of versality does not hold,
then we get an infinite sequence of finite type points $u_n$ such
that $u_0$ is a limit point of the sequence and such that $x$ is not versal
at $u_n$ for $n \geq 1$. After passing to a subsequence we
get $x \to x_1 \to x_2 \to \ldots$ lying over
$U \to U_1 \to U_2 \to \ldots$ as in Lemma \ref{lemma-infinite-sequence}.
Write $U_n = \Spec(R_n)$ and $U = \Spec(R_0)$.
Set $R = \lim R_n$. Observe that $R \to R_0$ is surjective
with kernel an ideal of square zero. By assumption (4)
we get $\xi$ over $\Spec(R)$ whose base change to $R_n$ is $x_n$.
By assumption (3) we get that $\xi$ comes from an object $\xi'$ over
$U' = \Spec(R')$ for some finite type $\Lambda$-subalgebra
$R' \subset R$. After increasing $R'$ we may and do assume that
$R' \to R_0$ is surjective, so that $U \subset U'$ is a first order thickening.
Thus we now have
$$
x \to x_1 \to x_2 \to \ldots \to \xi'
\text{ lying over }
U \to U_1 \to U_2 \to \ldots \to U'
$$
By assumption (1) there is an algebraic space $Z$ over $S$ representing
$$
(\Sch/U)_{fppf} \times_{x, \mathcal{X}, \xi'} (\Sch/U')_{fppf}
$$
see Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
By construction of $2$-fibre products, a $T$-valued point of $Z$
corresponds to a triple $(a, a', \alpha)$ consisting of morphisms
$a : T \to U$, $a' : T \to U'$ and a morphism $\alpha : a^*x \to (a')^*\xi'$.
We obtain a commutative diagram
$$
\xymatrix{
U \ar[rd] \ar[rdd] \ar[rrd] \\
& Z \ar[r]_{p'} \ar[d]^p & U' \ar[d] \\
& U \ar[r] & S
}
$$
The morphism $i : U \to Z$ comes the isomorphism $x \to \xi'|_U$.
Let $z_0 = i(u_0) \in Z$. By Lemma \ref{lemma-base-change-versal}
we see that $Z \to U'$ is smooth at $z_0$. After replacing $U$ by an
affine open neighbourhood of $u_0$, replacing $U'$ by the corresponding
open, and replacing $W$ by the intersection of the inverse images
of these opens by $p$ and $p'$, we reach the situation where
$Z \to U'$ is smooth along $i(U)$. Note that this
also involves replacing $u_n$ by a subsequence, namely
by those indices such that $u_n$ is in the open. Moreover, condition
(3) of Lemma \ref{lemma-infinite-sequence}
is clearly preserved by shrinking $U$
(all of the schemes $U$, $U_n$, $U'$ have the same underlying
topological space).
Since $U \to U'$ is a first order thickening of affine schemes,
we can choose a morphism $i' : U' \to Z$
such that $p' \circ i' = \text{id}_{U'}$ and
whose restriction to $U$ is $i$
(More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-smooth-formally-smooth}).
Pulling back the universal morphism
$p^*x \to (p')^*\xi'$ by $i'$ we obtain a morphism
$$
\xi' \to x
$$
lying over $p \circ i' : U' \to U$ such that the composition
$$
x \to \xi' \to x
$$
is the identity. Recall that we have $x_1 \to \xi'$ lying over
the morphism $U_1 \to U'$. Composing we get a morphism
$x_1 \to x$ whose existence contradicts condition
(3) of Lemma \ref{lemma-infinite-sequence}.
This contradiction finishes the proof.
\end{proof}

\begin{remark}
\label{remark-trade-openness-versality-diagonal-with-strong-effectiveness}
There is a way to deduce openness of versality of the diagonal
of an category fibred in groupoids from a strong formal effectiveness
axiom.
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. Assume
\begin{enumerate}
\item $\Delta_\Delta : \mathcal{X} \to
\mathcal{X} \times_{\mathcal{X} \times \mathcal{X}} \mathcal{X}$
is representable by algebraic spaces,
\item $\mathcal{X}$ has (RS*),
\item $\mathcal{X}$ is limit preserving,
\item given an inverse system $(R_n)$ of $S$-algebras
as in Remark \ref{remark-strong-effectiveness}
where $\Ker(R_m \to R_n)$ is an ideal of square zero for all $m \geq n$
the functor
$$
\mathcal{X}_{\Spec(\lim R_n)} \longrightarrow
\lim_n \mathcal{X}_{\Spec(R_n)}
$$
is fully faithful.
\end{enumerate}
Then $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$
satisfies openness of versality. This follows by applying
Lemma \ref{lemma-SGE-implies-openness-versality}
to fibre products of the form
$\mathcal{X} \times_{\Delta, \mathcal{X} \times \mathcal{X}, y}
(\Sch/V)_{fppf}$ for any affine scheme $V$ locally
of finite presentation over $S$ and object $y$ of
$\mathcal{X} \times \mathcal{X}$ over $V$.
If we ever need this, we will change this remark into
a lemma and provide a detailed proof.
\end{remark}











\section{Infinitesimal deformations}
\label{section-inf}

\noindent
In this section we discuss a generalization of the notion of the
tangent space introduced in Section \ref{section-tangent-spaces}.
To do this intelligently, we borrow some notation from
Formal Deformation Theory, Sections
\ref{formal-defos-section-tangent-spaces-functors},
\ref{formal-defos-section-lifts}, and
\ref{formal-defos-section-infinitesimal-automorphisms}.

\medskip\noindent
Let $S$ be a scheme. Let $\mathcal{X}$ be a category fibred in groupoids
over $(\Sch/S)_{fppf}$. Given a homomorphism $A' \to A$ of $S$-algebras
and an object $x$ of $\mathcal{X}$ over $\Spec(A)$ we write
$\textit{Lift}(x, A')$ for the category of lifts of $x$ to $\Spec(A')$.
An object of $\textit{Lift}(x, A')$ is a morphism $x \to x'$ of $\mathcal{X}$
lying over $\Spec(A) \to \Spec(A')$ and morphisms of $\textit{Lift}(x, A')$
are defined as commutative diagrams. The set of isomorphism classes of
$\textit{Lift}(x, A')$ is denoted $\text{Lift}(x, A')$. See
Formal Deformation Theory, Definition \ref{formal-defos-definition-lifts} and
Remark \ref{formal-defos-remark-omit-arrow}.
If $A' \to A$ is surjective with locally nilpotent kernel we call an element
$x'$ of $\text{Lift}(x, A')$ a {\it (infinitesimal) deformation} of $x$.
In this case the {\it group of infinitesimal automorphisms of $x'$ over $x$}
is the kernel
$$
\text{Inf}(x'/x) =
\Ker\left(
\text{Aut}_{\mathcal{X}_{\Spec(A')}}(x') \to
\text{Aut}_{\mathcal{X}_{\Spec(A)}}(x)\right)
$$
Note that an element of $\text{Inf}(x'/x)$ is the same thing as a lift
of $\text{id}_x$ over $\Spec(A')$ for (the category fibred in sets associated
to) $\mathit{Aut}_\mathcal{X}(x')$. Compare with
Formal Deformation Theory, Definition
\ref{formal-defos-definition-relative-infinitesimal-auts} and
Formal Deformation Theory, Remark
\ref{formal-defos-remark-infaut-lifting-equalities}.

\medskip\noindent
If $M$ is an $A$-module we denote $A[M]$ the $A$-algebra whose underlying
$A$-module is $A \oplus M$ and whose multiplication is given by
$(a, m) \cdot (a', m') = (aa', am' + a'm)$. When $M = A$ this is the ring
of dual numbers over $A$, which we denote $A[\epsilon]$ as is customary.
There is an $A$-algebra map $A[M] \to A$. The pullback of $x$ to $\Spec(A[M])$
is called the {\it trivial deformation} of $x$ to $\Spec(A[M])$.

\begin{lemma}
\label{lemma-functoriality}
Let $S$ be a scheme. Let $f : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism
of categories fibred in groupoids over $(\Sch/S)_{fppf}$. Let
$$
\xymatrix{
B' \ar[r] & B \\
A' \ar[u] \ar[r] & A \ar[u]
}
$$
be a commutative diagram of $S$-algebras. Let $x$ be an object of $\mathcal{X}$
over $\Spec(A)$, let $y$ be an object of $\mathcal{Y}$ over $\Spec(B)$,
and let $\phi : f(x)|_{\Spec(B)} \to y$ be a morphism of $\mathcal{Y}$
over $\Spec(B)$. Then there is a canonical functor
$$
\textit{Lift}(x, A') \longrightarrow \textit{Lift}(y, B')
$$
of categories of lifts induced by $f$ and $\phi$. The construction is
compatible with compositions of $1$-morphisms of categories fibred in
groupoids in an obvious manner.
\end{lemma}

\begin{proof}
This lemma proves itself.
\end{proof}

\noindent
Let $S$ be a locally Noetherian base. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. We define a category whose objects are
pairs $(x, A' \to A)$ where
\begin{enumerate}
\item $A' \to A$ is a surjection of $S$-algebras whose kernel
is an ideal of square zero such that $\Spec(A)$ maps into an affine open
of $S$, and
\item $x$ is an object of $\mathcal{X}$ lying over $\Spec(A)$.
\end{enumerate}
A morphism $(y, B' \to B) \to (x, A' \to A)$ is given by a commutative
diagram
$$
\xymatrix{
B' \ar[r] & B \\
A' \ar[u] \ar[r] & A \ar[u]
}
$$
of $S$-algebras together with a morphism $x|_{\Spec(B)} \to y$ over
$\Spec(B)$. Let us call this the category of {\it deformation situations}.

\begin{lemma}
\label{lemma-properties-lift-RS-star}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Assume $\mathcal{X}$ satisfies
condition (RS*). Let $A$ be an $S$-algebra such that
$\Spec(A) \to S$ maps into an affine open and let $x$ be an object of
$\mathcal{X}$ over $\Spec(A)$.
\begin{enumerate}
\item There exists an $A$-linear functor
$\text{Inf}_x : \text{Mod}_A \to \text{Mod}_A$
such that given a deformation situation $(x, A' \to A)$ and a lift $x'$
there is an isomorphism $\text{Inf}_x(I) \to \text{Inf}(x'/x)$ where
$I = \Ker(A' \to A)$.
\item There exists an $A$-linear functor
$T_x : \text{Mod}_A \to \text{Mod}_A$
such that
\begin{enumerate}
\item given $M$ in $\text{Mod}_A$ there is a bijection
$T_x(M) \to \text{Lift}(x, A[M])$,
\item given a deformation situation $(x, A' \to A)$ there is an action
$$
T_x(I) \times \text{Lift}(x, A') \to \text{Lift}(x, A')
$$
where $I = \Ker(A' \to A)$. It is simply transitive if
$\text{Lift}(x, A') \not = \emptyset$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
To define $\text{Inf}_x$, resp.\ $T_x$ we consider the functors
$$
\text{Mod}_A \longrightarrow \textit{Sets},\quad
M \longrightarrow \text{Lift}(\text{id}_x, A[M]),
\quad\text{resp.}\quad
M \longrightarrow \text{Lift}(x, A[M])
$$
(for the first consider lifts of $\text{id}_x$ as automorphisms
of the trivial deformation of $x$ to $A[M]$)
and we apply Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-linear-functor}. This lemma is applicable, since
(RS*) tells us that
$$
\textit{Lift}(x, A[M \times N]) =
\textit{Lift}(x, A[M]) \times \textit{Lift}(x, A[N])
$$
as categories (and trivial deformations match up too).

\medskip\noindent
Let $(x, A' \to A)$ be a deformation situation. Consider the ring map
$g : A' \times_A A' \to A[I]$ defined by the
rule $g(a_1, a_2) = \overline{a_1} \oplus a_2 - a_1$.
There is an isomorphism
$$
A' \times_A A' \longrightarrow A' \times_A A[I]
$$
given by $(a_1, a_2) \mapsto (a_1, g(a_1, a_2))$.
This isomorphism commutes with the projections to $A'$ on the first
factor, and hence with the projections to $A$. Thus applying (RS*)
twice we find equivalences of categories
\begin{align*}
\textit{Lift}(x, A') \times \textit{Lift}(x, A')
& =
\textit{Lift}(x, A' \times_A A') \\
& =
\textit{Lift}(x, A' \times_A A[I]) \\
& =
\textit{Lift}(x, A') \times \textit{Lift}(x, A[I])
\end{align*}
Using these maps and projection onto the last factor of the last product
we see that we obtain ``difference maps''
$$
\text{Inf}(x'/x) \times  \text{Inf}(x'/x)
\longrightarrow
\text{Inf}_x(I)
\quad\text{and}\quad
\text{Lift}(x, A') \times \text{Lift}(x, A')
\longrightarrow
T_x(I)
$$
These difference maps satisfy the transitivity rule
``$(x'_1 - x'_2) + (x'_2 - x'_3) = x'_1 - x'_3$'' because
$$
\xymatrix{
A' \times_A A' \times_A A'
\ar[rrrrr]_-{(a_1, a_2, a_3) \mapsto (g(a_1, a_2), g(a_2, a_3))}
\ar[rrrrrd]_{(a_1, a_2, a_3) \mapsto g(a_1, a_3)} & & & & &
A[I] \times_A A[I] = A[I \times I] \ar[d]^{+} \\
& & & & & A[I]
}
$$
is commutative. Inverting the string of equivalences above we obtain
an action which is free and transitive provided $\text{Inf}(x'/x)$,
resp.\ $\text{Lift}(x, A')$ is nonempty. Note that $\text{Inf}(x'/x)$
is always nonempty as it is a group.
\end{proof}

\begin{remark}[Functoriality]
\label{remark-functoriality}
Assumptions and notation as in Lemma \ref{lemma-properties-lift-RS-star}.
Suppose $A \to B$ is a ring map and $y = x|_{\Spec(B)}$.
Let $M \in \text{Mod}_A$, $N \in \text{Mod}_B$
and let $M \to N$ an $A$-linear map. Then there are canonical maps
$\text{Inf}_x(M) \to \text{Inf}_y(N)$ and
$T_x(M) \to T_y(N)$ simply because there is a pullback functor
$$
\textit{Lift}(x, A[M]) \to \textit{Lift}(y, B[N])
$$
coming from the ring map $A[M] \to B[N]$. Similarly, given a morphism of
deformation situations $(y, B' \to B) \to (x, A' \to A)$ we obtain a pullback
functor $\textit{Lift}(x, A') \to \textit{Lift}(y, B')$. Since the
construction of the action, the addition, and the scalar multiplication
on $\text{Inf}_x$ and $T_x$ use only morphisms in the categories of lifts
(see proof of
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-linear-functor})
we see that the constructions above are functorial. In other words we
obtain $A$-linear maps
$$
\text{Inf}_x(M) \to \text{Inf}_y(N)
\quad\text{and}\quad
T_x(M) \to T_y(N)
$$
such that the diagrams
$$
\vcenter{
\xymatrix{
\text{Inf}_y(J) \ar[r] & \text{Inf}(y'/y) \\
\text{Inf}_x(I) \ar[r] \ar[u] & \text{Inf}(x'/x) \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
T_y(J) \times \text{Lift}(y, B') \ar[r] & \text{Lift}(y, B') \\
T_x(I) \times \text{Lift}(x, A') \ar[r] \ar[u] & \text{Lift}(x, A') \ar[u]
}
}
$$
commute. Here $I = \Ker(A' \to A)$, $J = \Ker(B' \to B)$,
$x'$ is a lift of $x$ to $A'$ (which may not always exist) and
$y' = x'|_{\Spec(B')}$.
\end{remark}

\begin{remark}[Automorphisms]
\label{remark-automorphisms}
Assumptions and notation as in Lemma \ref{lemma-properties-lift-RS-star}.
Let $x', x''$ be lifts of $x$ to $A'$. Then we have a composition
map
$$
\text{Inf}(x''/x) \times
\Mor_{\textit{Lift}(x, A')}(x', x'') \times \text{Inf}(x'/x)
\longrightarrow
\Mor_{\textit{Lift}(x, A')}(x', x'').
$$
Since $\textit{Lift}(x, A')$ is a groupoid, if
$\Mor_{\textit{Lift}(x, A')}(x', x'')$ is nonempty, then this defines
a simply transitive left action of $\text{Inf}(x'/x)$ on
$\Mor_{\textit{Lift}(x, A')}(x', x'')$ and a simply transitive
right action by $\text{Inf}(x'/x)$. Now the lemma says that
$\text{Inf}(x'/x) = \text{Inf}_x(I) = \text{Inf}(x''/x)$.
We claim that the two actions described above agree via these identifications.
Namely, either $x' \not \cong x''$ in which the claim is clear, or
$x' \cong x''$ and in that case we may assume that $x'' = x'$ in which
case the result follows from the fact that $\text{Inf}(x'/x)$ is
commutative. In particular, we obtain a well defined action
$$
\text{Inf}_x(I) \times \Mor_{\textit{Lift}(x, A')}(x', x'')
\longrightarrow
\Mor_{\textit{Lift}(x, A')}(x', x'')
$$
which is simply transitive as soon as $\Mor_{\textit{Lift}(x, A')}(x', x'')$
is nonempty.
\end{remark}

\begin{remark}[Canonical element]
\label{remark-canonical-element}
Assumptions and notation as in Lemma \ref{lemma-properties-lift-RS-star}.
Choose an affine open $\Spec(\Lambda) \subset S$ such that $\Spec(A) \to S$
corresponds to a ring map $\Lambda \to A$. Consider the ring map
$$
A \longrightarrow A[\Omega_{A/\Lambda}],
\quad
a \longmapsto (a, \text{d}_{A/\Lambda}(a))
$$
Pulling back $x$ along the corresponding morphism
$\Spec(A[\Omega_{A/\Lambda}]) \to \Spec(A)$ we obtain a
deformation $x_{can}$ of $x$ over $A[\Omega_{A/\Lambda}]$. We call this
the {\it canonical element}
$$
x_{can} \in T_x(\Omega_{A/\Lambda}) = \text{Lift}(x, A[\Omega_{A/\Lambda}]).
$$
Next, assume that $\Lambda \to A$ is of finite type and let
$k = \kappa(\mathfrak p)$ be a residue field at a finite type point $u_0$
of $U = \Spec(A)$. Let $x_0 = x|_{u_0}$. By (RS*) and the fact that
$A[k] = A \times_k k[k]$ the space $T_x(k)$ is the tangent space to the
deformation functor $\mathcal{F}_{\mathcal{X}, k, x_0}$. Via
$$
T\mathcal{F}_{U, k, u_0} =
\text{Der}_\Lambda(A, k) = \Hom_A(\Omega_{A/\Lambda}, k)
$$
(see Formal Deformation Theory, Example
\ref{formal-defos-example-tangent-space-prorepresentable-functor})
and functoriality of $T_x$ the canonical element produces the map
on tangent spaces induced by the object $x$ over $U$. Namely,
$\theta \in T\mathcal{F}_{U, k, u_0}$ maps to $T_x(\theta)(x_{can})$
in $T_x(k) = T\mathcal{F}_{\mathcal{X}, k, x_0}$.
\end{remark}

\begin{remark}[Canonical automorphism]
\label{remark-canonical-isomorphism}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Assume $\mathcal{X}$ satisfies
condition (RS*). Let $A$ be an $S$-algebra such that
$\Spec(A) \to S$ maps into an affine open and let $x, y$ be objects of
$\mathcal{X}$ over $\Spec(A)$. Further, let $A \to B$ be a ring map and
let $\alpha : x|_{\Spec(B)} \to y|_{\Spec(B)}$ be a morphism of
$\mathcal{X}$ over $\Spec(B)$. Consider the ring map
$$
B \longrightarrow B[\Omega_{B/A}],
\quad
b \longmapsto (b, \text{d}_{B/A}(b))
$$
Pulling back $\alpha$ along the corresponding morphism
$\Spec(B[\Omega_{B/A}]) \to \Spec(B)$ we obtain a
morphism $\alpha_{can}$ between the pullbacks of $x$ and $y$ over
$B[\Omega_{B/A}]$. On the other hand, we can pullback $\alpha$
by the morphism $\Spec(B[\Omega_{B/A}]) \to \Spec(B)$ corresponding
to the injection of $B$ into the first summand of $B[\Omega_{B/A}]$.
By the discussion of Remark \ref{remark-automorphisms}
we can take the difference
$$
\varphi(x, y, \alpha) = \alpha_{can} - \alpha|_{\Spec(B[\Omega_{B/A}])} \in
\text{Inf}_{x|_{\Spec(B)}}(\Omega_{B/A}).
$$
We will call this the {\it canonical automorphism}. It depends
on all the ingredients $A$, $x$, $y$, $A \to B$ and $\alpha$.
\end{remark}

\begin{remark}
\label{remark-short-exact-sequence-thickenings}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Let $A$ be an $S$-algebra
such that $\Spec(A) \to S$ maps into an affine open. There
is a notion of a {\it short exact sequence}
$$
(x, A_1' \to A) \to (x, A_2' \to A) \to (x, A_3' \to A)
$$
of deformation situations: we ask the corresponding maps between
the kernels $I_i = \Ker(A_i' \to A)$ give a short exact sequence
$$
0 \to I_3 \to I_2 \to I_1 \to 0
$$
of $A$-modules. Note that in this case the map $A_3' \to A_1'$
factors through $A$, hence there is a canonical isomorphism
$A_1' = A[I_1]$.
\end{remark}





\section{Obstruction theories}
\label{section-obstruction-theory}

\noindent
In this section we describe what an obstruction theory is.
Contrary to the spaces of infinitesimal deformations and infinitesimal
automorphisms, an obstruction theory is an additional piece of data.
The formulation is motivated by the results of
Lemma \ref{lemma-properties-lift-RS-star}
and Remark \ref{remark-functoriality}.

\begin{definition}
\label{definition-obstruction-theory}
Let $S$ be a locally Noetherian base. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. An {\it obstruction theory} is 
given by the following data
\begin{enumerate}
\item for every $S$-algebra $A$ such that $\Spec(A) \to S$
maps into an affine open and every object $x$ of $\mathcal{X}$ over
$\Spec(A)$ an $A$-linear functor
$$
\mathcal{O}_x : \text{Mod}_A \to \text{Mod}_A
$$
of {\it obstruction modules},
\item for $(x, A)$ as in (1), a ring map $A \to B$,
$M \in \text{Mod}_A$, $N \in \text{Mod}_B$, and an $A$-linear
map $M \to N$ an induced $A$-linear map $\mathcal{O}_x(M) \to \mathcal{O}_y(N)$
where $y = x|_{\Spec(B)}$, and
\item for every deformation situation $(x, A' \to A)$ an
{\it obstruction} element
$o_x(A') \in \mathcal{O}_x(I)$ where $I = \Ker(A' \to A)$.
\end{enumerate}
These data are subject to the following conditions
\begin{enumerate}
\item[(i)] the functoriality maps turn the obstruction modules into a functor
from the category of triples $(x, A, M)$ to sets,
\item[(ii)] for every morphism of deformation situations
$(y, B' \to B) \to (x, A' \to A)$ the element $o_x(A')$ maps
to $o_y(B')$, and
\item[(iii)] we have
$$
\text{Lift}(x, A') \not = \emptyset
\Leftrightarrow
o_x(A') = 0
$$
for every deformation situation $(x, A' \to A)$.
\end{enumerate}
\end{definition}

\noindent
This last condition explains the terminology. The module $\mathcal{O}_x(A')$
is called the {\it obstruction module}. The element $o_x(A')$ is the
{\it obstruction}.
Most obstruction theories have additional properties, and in order to
make them useful additional conditions are needed.
Moreover, this is just a sample definition, for example in the definition
we could consider only deformation situations of finite type over $S$.

\medskip\noindent
One of the main reasons for introducing obstruction theories is to check
openness of versality. An example of this type of result is
Lemma \ref{lemma-get-openness-obstruction-theory} below.
The initial idea to do this is due to Artin, see
the papers of Artin mentioned in the introduction. It has been taken up
for example in the work by Flenner \cite{Flenner},
Hall \cite{Hall-coherent},
Hall and Rydh \cite{rydh_axioms},
Olsson \cite{olsson_deformation},
Olsson and Starr \cite{olsson-starr}, and
Lieblich \cite{lieblich-complexes} (random order of references).
Moreover, for particular categories fibred in groupoids, often
authors develop a little bit of theory adapted to the problem at hand.
We will develop this theory later (insert future reference here).

\begin{lemma}
\label{lemma-get-openness-obstruction-theory}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. Assume
\begin{enumerate}
\item $\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ is
representable by algebraic spaces,
\item $\mathcal{X}$ has (RS*),
\item $\mathcal{X}$ is limit preserving,
\item there exists an obstruction theory\footnote{Analyzing the proof
the reader sees that in fact it suffices to check
the functoriality (ii) of obstruction classes in
Definition \ref{definition-obstruction-theory}
for maps $(y, B' \to B) \to (x, A' \to A)$
with $B = A$ and $y = x$.},
\item for an object $x$ of $\mathcal{X}$ over $\Spec(A)$
and $A$-modules $M_n$, $n \geq 1$ we have
\begin{enumerate}
\item $T_x(\prod M_n) = \prod T_x(M_n)$,
\item $\mathcal{O}_x(\prod M_n) \to \prod \mathcal{O}_x(M_n)$
is injective.
\end{enumerate}
\end{enumerate}
Then $\mathcal{X}$ satisfies openness of versality.
\end{lemma}

\begin{proof}
We prove this by verifying condition (4) of
Lemma \ref{lemma-SGE-implies-openness-versality}.
Let $(\xi_n)$ and $(R_n)$ be as in Remark \ref{remark-strong-effectiveness}
such that $\Ker(R_m \to R_n)$ is an ideal of square zero
for all $m \geq n$. Set $A = R_1$ and $x = \xi_1$.
Denote $M_n = \Ker(R_n \to R_1)$.
Then $M_n$ is an $A$-module. Set $R = \lim R_n$.
Let
$$
\tilde R = \{(r_1, r_2, r_3 \ldots) \in \prod R_n
\text{ such that all have the same image in }A\}
$$
Then $\tilde R \to A$ is surjective with kernel $M = \prod M_n$.
There is a map $R \to \tilde R$ and a map
$\tilde R \to A[M]$, $(r_1, r_2, r_3, \ldots) \mapsto
(r_1, r_2 - r_1, r_3 - r_2, \ldots)$.
Together these give a short exact sequence
$$
(x, R \to A) \to (x, \tilde R \to A) \to (x, A[M])
$$
of deformation situations, see
Remark \ref{remark-short-exact-sequence-thickenings}.
The associated sequence of kernels
$0 \to \lim M_n \to M \to M \to 0$
is the canonical sequence computing the limit
of the system of modules $(M_n)$.

\medskip\noindent
Let $o_x(\tilde R) \in \mathcal{O}_x(M)$ be the obstruction element.
Since we have the lifts $\xi_n$ we see that $o_x(\tilde R)$
maps to zero in $\mathcal{O}_x(M_n)$. By assumption (5)(b)
we see that $o_x(\tilde R) = 0$. Choose a lift $\tilde \xi$
of $x$ to $\Spec(\tilde R)$. Let $\tilde \xi_n$ be the
restriction of $\tilde n$ to $\Spec(R_n)$. There exists
elements $t_n \in T_x(M_n)$ such that
$t_n \cdot \tilde \xi_n = \xi_n$ by
Lemma \ref{lemma-properties-lift-RS-star} part (2)(b).
By assumption (5)(a) we can find $t \in T_x(M)$
mapping to $t_n$ in $T_x(M_n)$. After replacing
$\tilde \xi$ by $t \cdot \tilde \xi$ we find that
$\tilde \xi$ restricts to $\xi_n$ over $\Spec(R_n)$ for all $n$.
In particular, since $\xi_{n + 1}$ restricts to $\xi_n$
over $\Spec(R_n)$, the restriction $\overline{\xi}$ of $\tilde \xi$
to $\Spec(A[M])$ has the property that it restricts to
the trivial deformation over $\Spec(A[M_n])$ for all $n$.
Hence by assumption (5)(a) we find that $\overline{\xi}$
is the trivial deformation of $x$. By axiom (RS*)
applied to $R = \tilde R \times_{A[M]} A$
this implies that $\tilde \xi$ is the pullback
of a deformation $\xi$ of $x$ over $R$. This finishes the proof.
\end{proof}

\begin{example}
\label{example-global-sections}
Let $S = \Spec(\Lambda)$ for some Noetherian ring $\Lambda$.
Let $W \to S$ be a morphism of schemes. Let $\mathcal{F}$
be a quasi-coherent $\mathcal{O}_W$-module flat over $S$.
Consider the functor
$$
F : (\Sch/S)_{fppf}^{opp} \longrightarrow \textit{Sets},
\quad
T/S \longrightarrow H^0(W_T, \mathcal{F}_T)
$$
where $W_T = T \times_S W$ is the base change and $\mathcal{F}_T$ is
the pullback of $\mathcal{F}$ to $W_T$. If $T = \Spec(A)$
we will write $W_T = W_A$, etc. Let $\mathcal{X} \to (\Sch/S)_{fppf}$
be the category fibred in groupoids associated to $F$. Then
$\mathcal{X}$ has an obstruction theory. Namely,
\begin{enumerate}
\item given $A$ over $\Lambda$ and
$x \in H^0(W_A, \mathcal{F}_A)$ we set
$\mathcal{O}_x(M) = H^1(W_A, \mathcal{F}_A \otimes_A M)$,
\item given a deformation situation $(x, A' \to A)$ we let
$o_x(A') \in \mathcal{O}_x(A)$ be the image of $x$ under the boundary map
$$
H^0(W_A, \mathcal{F}_A) \longrightarrow H^1(W_A, \mathcal{F}_A \otimes_A I)
$$
coming from the short exact sequence of modules
$$
0 \to \mathcal{F}_A \otimes_A I \to
\mathcal{F}_{A'} \to \mathcal{F}_A \to 0.
$$
\end{enumerate}
We have omitted some details, in particular the construction of the short
exact sequence above (it uses that $W_A$ and $W_{A'}$ have the same
underlying topological space) and the explanation for why flatness
of $\mathcal{F}$ over $S$ implies that the sequence above is short exact.
\end{example}

\begin{example}[Key example]
\label{example-key}
Let $S = \Spec(\Lambda)$ for some Noetherian ring $\Lambda$.
Say $\mathcal{X} = (\Sch/X)_{fppf}$ with $X = \Spec(R)$ and
$R = \Lambda[x_1, \ldots, x_n]/J$. The naive cotangent
complex $\NL_{R/\Lambda}$ is (canonically) homotopy equivalent to
$$
J/J^2
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} R\text{d}x_i,
$$
see Algebra, Lemma \ref{algebra-lemma-NL-homotopy}.
Consider a deformation situation $(x, A' \to A)$. Denote $I$ the kernel of
$A' \to A$. The object $x$ corresponds to $(a_1, \ldots, a_n)$
with $a_i \in A$ such that $f(a_1, \ldots, a_n) = 0$ in $A$ for all $f \in J$.
Set
\begin{align*}
\mathcal{O}_x(A')
& =
\Hom_R(J/J^2, I)/\Hom_R(R^{\oplus n}, I) \\
& =
\text{Ext}^1_R(\NL_{R/\Lambda}, I) \\
& =
\text{Ext}^1_A(\NL_{R/\Lambda} \otimes_R A, I).
\end{align*}
Choose lifts $a_i' \in A'$ of $a_i$ in $A$. Then $o_x(A')$
is the class of the map $J/J^2 \to I$ defined by sending $f \in J$ to
$f(a_1', \ldots, a'_n) \in I$. We omit the verification that
$o_x(A')$ is independent of choices. It is clear that if $o_x(A') = 0$
then the map lifts. Finally, functoriality is straightforward.
Thus we obtain an obstruction theory. We observe that $o_x(A')$
can be described a bit more canonically as the composition
$$
\NL_{R/\Lambda} \to \NL_{A/\Lambda} \to \NL_{A/A'} = I[1]
$$
in $D(A)$, see Algebra, Lemma \ref{algebra-lemma-NL-surjection}
for the last identification.
\end{example}









\section{Naive obstruction theories}
\label{section-naive-obstruction-theory}

\noindent
The title of this section refers to the fact that we will use the
naive cotangent complex in this section. Let $(x, A' \to A)$
be a deformation situation for a given category fibred in groupoids over a
locally Noetherian scheme $S$. The key Example \ref{example-key}
suggests that any obstruction theory should be closely related to
maps in $D(A)$ with target the naive cotangent complex of $A$.
Working this out we find a criterion for versality in
Lemma \ref{lemma-characterize-versal} which leads to a criterion for
openness of versality in Lemma \ref{lemma-openness}. We introduce a notion of
a naive obstruction theory in
Definition \ref{definition-naive-obstruction-theory} to try to formalize
the notion a bit further.

\medskip\noindent
In the following we will use the naive cotangent complex as
defined in Algebra, Section \ref{algebra-section-netherlander}.
In particular, if $A' \to A$ is a surjection of $\Lambda$-algebras
with square zero kernel $I$, then there are maps
$$
\NL_{A'/\Lambda} \to \NL_{A/\Lambda} \to \NL_{A/A'}
$$
whose composition is homotopy equivalent to zero (see
Algebra, Remark \ref{algebra-remark-composition-homotopy-equivalent-to-zero}).
This doesn't form a distinguished triangle in general as we are using
the naive cotangent complex and not the full one.
There is a homotopy equivalence $\NL_{A/A'} \to I[1]$ (the complex
consisting of $I$ placed in degree $-1$, see
Algebra, Lemma \ref{algebra-lemma-NL-surjection}).
Finally, note that there is a canonical map
$\NL_{A/\Lambda} \to \Omega_{A/\Lambda}$.

\begin{lemma}
\label{lemma-compute-ext-into-field}
Let $A \to k$ be a ring map with $k$ a field. Let $E \in D^-(A)$.
Then $\text{Ext}^i_A(E, k) = \Hom_k(H^{-i}(E \otimes^\mathbf{L} k), k)$.
\end{lemma}

\begin{proof}
Omitted. Hint: Replace $E$ by a bounded above complex of free $A$-modules
and compute both sides.
\end{proof}

\begin{lemma}
\label{lemma-construct-essential-surjection}
Let $\Lambda \to A \to k$ be finite type ring maps of Noetherian rings with
$k = \kappa(\mathfrak p)$ for some prime $\mathfrak p$ of $A$. Let
$\xi : E \to \NL_{A/\Lambda}$ be morphism of $D^{-}(A)$ such that
$H^{-1}(\xi \otimes^{\mathbf{L}} k)$ is not surjective.
Then there exists a surjection $A' \to A$ of $\Lambda$-algebras
such that
\begin{enumerate}
\item[(a)] $I = \Ker(A' \to A)$ has square zero and is isomorphic to $k$
as an $A$-module,
\item[(b)] $\Omega_{A'/\Lambda} \otimes k = \Omega_{A/\Lambda} \otimes k$, and
\item[(c)] $E \to \NL_{A/A'}$ is zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $f \in A$, $f \not \in \mathfrak p$. Suppose that $A'' \to A_f$
satisfies (a), (b), (c) for the induced map
$E \otimes_A A_f \to \NL_{A_f/\Lambda}$, see
Algebra, Lemma \ref{algebra-lemma-localize-NL}.
Then we can set $A' = A'' \times_{A_f} A$ and get a solution.
Namely, it is clear that $A' \to A$ satisfies (a) because
$\Ker(A' \to A) = \Ker(A'' \to A) = I$. Pick
$f'' \in A''$ lifting $f$. Then the localization of $A'$ at
$(f'', f)$ is isomorphic to $A''$
(for example by
More on Algebra, Lemma \ref{more-algebra-lemma-diagram-localize}).
Thus (b) and (c) are clear for $A'$ too.
In this way we see that we may replace $A$ by the localization
$A_f$ (finitely many times).
In particular (after such a replacement) we may assume that $\mathfrak p$
is a maximal ideal of $A$, see
Morphisms, Lemma \ref{morphisms-lemma-point-finite-type}.

\medskip\noindent
Choose a presentation $A = \Lambda[x_1, \ldots, x_n]/J$. Then
$\NL_{A/\Lambda}$ is (canonically) homotopy equivalent to
$$
J/J^2
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} A\text{d}x_i,
$$
see Algebra, Lemma \ref{algebra-lemma-NL-homotopy}. After localizing
if necessary (using Nakayama's lemma) we can choose generators
$f_1, \ldots, f_m$ of $J$ such that $f_j \otimes 1$ form a basis for
$J/J^2 \otimes_A k$. Moreover, after renumbering, we can assume that the
images of $\text{d}f_1, \ldots, \text{d}f_r$ form a
basis for the image of $J/J^2 \otimes k \to \bigoplus k\text{d}x_i$
and that $\text{d}f_{r + 1}, \ldots, \text{d}f_m$ map to zero in
$\bigoplus k\text{d}x_i$. With these choices the space
$$
H^{-1}(\NL_{A/\Lambda} \otimes^{\mathbf{L}}_A k) =
H^{-1}(\NL_{A/\Lambda} \otimes_A k)
$$
has basis $f_{r + 1} \otimes 1, \ldots, f_m \otimes 1$. Changing basis
once again we may assume that the image of $H^{-1}(\xi \otimes^{\mathbf{L}} k)$
is contained in the $k$-span of
$f_{r + 1} \otimes 1, \ldots, f_{m - 1} \otimes 1$.
Set
$$
A' = \Lambda[x_1, \ldots, x_n]/(f_1, \ldots, f_{m - 1}, \mathfrak pf_m)
$$
By construction $A' \to A$ satisfies (a). Since $\text{d}f_m$ maps
to zero in $\bigoplus k\text{d}x_i$ we see that (b) holds. Finally, by
construction the induced map $E \to \NL_{A/A'} = I[1]$ induces the zero map
$H^{-1}(E \otimes_A^\mathbf{L} k) \to I \otimes_A k$. By
Lemma \ref{lemma-compute-ext-into-field}
we see that the composition is zero.
\end{proof}

\noindent
The following lemma is our key technical result.

\begin{lemma}
\label{lemma-characterize-versal}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$ satisfying (RS*).
Let $U = \Spec(A)$ be an
affine scheme of finite type over $S$ which maps into an affine open
$\Spec(\Lambda)$. Let $x$ be an object of $\mathcal{X}$ over $U$.
Let $\xi : E \to \NL_{A/\Lambda}$ be a morphism of $D^{-}(A)$. Assume
\begin{enumerate}
\item[(i)] for every deformation situation $(x, A' \to A)$ we have:
$x$ lifts to $\Spec(A')$ if and only if
$E \to \NL_{A/\Lambda} \to \NL_{A/A'}$ is zero, and
\item[(ii)] there is an isomorphism of functors
$T_x(-) \to \text{Ext}^0_A(E, -)$
such that $E \to \NL_{A/\Lambda} \to \Omega^1_{A/\Lambda}$
corresponds to the canonical element (see
Remark \ref{remark-canonical-element}).
\end{enumerate}
Let $u_0 \in U$ be a finite type point with residue field
$k = \kappa(u_0)$. Consider the following statements
\begin{enumerate}
\item $x$ is versal at $u_0$, and
\item $\xi : E \to \NL_{A/\Lambda}$ induces a surjection
$H^{-1}(E \otimes_A^{\mathbf{L}} k) \to
H^{-1}(\NL_{A/\Lambda} \otimes_A^{\mathbf{L}} k)$
and an injection
$H^0(E \otimes_A^{\mathbf{L}} k) \to
H^0(\NL_{A/\Lambda} \otimes_A^{\mathbf{L}} k)$.
\end{enumerate}
Then we always have (2) $\Rightarrow$ (1) and we have (1) $\Rightarrow$ (2)
if $u_0$ is a closed point.
\end{lemma}

\begin{proof}
Let $\mathfrak p = \Ker(A \to k)$ be the prime corresponding to $u_0$.

\medskip\noindent
Assume that $x$ versal at $u_0$ and that $u_0$ is a closed point of $U$.
If $H^{-1}(\xi \otimes_A^{\mathbf{L}} k)$ is not surjective, then
let $A' \to A$ be an extension with kernel $I$ as in
Lemma \ref{lemma-construct-essential-surjection}.
Because $u_0$ is a closed point, we see that $I$ is a finite $A$-module,
hence that $A'$ is a finite type $\Lambda$-algebra (this fails if
$u_0$ is not closed). In particular $A'$ is Noetherian.
By property (c) for $A'$ and (i) for $\xi$ we see that $x$ lifts to
an object $x'$ over $A'$.
Let $\mathfrak p' \subset A'$ be kernel of the surjective map to $k$.
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists an $n > 1$ such that $(\mathfrak p')^n \cap I = 0$.
Then we see that
$$
B' = A'/(\mathfrak p')^n \longrightarrow A/\mathfrak p^n = B
$$
is a small, essential extension of local Artinian rings, see
Formal Deformation Theory, Lemma
\ref{formal-defos-lemma-essential-surjection}.
On the other hand, as $x$ is versal at $u_0$ and as $x'|_{\Spec(B')}$
is a lift of $x|_{\Spec(B)}$, there exists an integer
$m \geq n$ and a map $q : A/\mathfrak p^m \to B'$
such that the composition
$A/\mathfrak p^m \to B' \to B$ is the quotient map.
Since the maximal ideal of $B'$ has $n$th power equal to zero, this
$q$ factors through $B$ which contradicts the fact that $B' \to B$ is an
essential surjection. This contradiction shows that
$H^{-1}(\xi \otimes_A^{\mathbf{L}} k)$
is surjective.

\medskip\noindent
Assume that $x$ versal at $u_0$. By Lemma \ref{lemma-compute-ext-into-field}
the map $H^0(\xi \otimes_A^{\mathbf{L}} k)$ is dual to the map
$\text{Ext}^0_A(\NL_{A/\Lambda}, k) \to \text{Ext}^0_A(E, k)$. Note that
$$
\text{Ext}^0_A(\NL_{A/\Lambda}, k) = \text{Der}_\Lambda(A, k)
\quad\text{and}\quad
T_x(k) = \text{Ext}^0_A(E, k)
$$
Condition (ii) assures us the map
$\text{Ext}^0_A(\NL_{A/\Lambda}, k) \to \text{Ext}^0_A(E, k)$
sends a tangent vector $\theta$ to $U$ at $u_0$ to the corresponding
infinitesimal deformation of $x_0$, see Remark \ref{remark-canonical-element}.
Hence if $x$ is versal, then this map is surjective, see
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-versal-criterion}.
Hence $H^0(\xi \otimes_A^{\mathbf{L}} k)$ is injective.
This finishes the proof of (1) $\Rightarrow$ (2) in case $u_0$ is a
closed point.

\medskip\noindent
For the rest of the proof assume $H^{-1}(E \otimes_A^\mathbf{L} k) \to
H^{-1}(\NL_{A/\Lambda} \otimes_A^\mathbf{L} k)$
is surjective and
$H^0(E \otimes_A^\mathbf{L} k) \to
H^0(\NL_{A/\Lambda} \otimes_A^\mathbf{L} k)$
injective. Set $R = A_\mathfrak p^\wedge$ and let $\eta$ be the
formal object over $R$ associated to $x|_{\Spec(R)}$.
The map $d\underline{\eta}$ on tangent spaces is surjective
because it is identified with the dual of the injective map
$H^0(E \otimes_A^{\mathbf{L}} k) \to
H^0(\NL_{A/\Lambda} \otimes_A^{\mathbf{L}} k)$
(see previous paragraph). According to
Formal Deformation Theory, Lemma \ref{formal-defos-lemma-versal-criterion}
it suffices to prove the following:
Let $C' \to C$ be a small extension of finite type Artinian local
$\Lambda$-algebras with residue field $k$. Let $R \to C$ be a
$\Lambda$-algebra map compatible with identifications of residue fields.
Let $y = x|_{\Spec(C)}$ and let $y'$ be a lift of $y$ to $C'$.
To show: we can lift the $\Lambda$-algebra map $R \to C$ to $R \to C'$.

\medskip\noindent
Observe that it suffices to lift the $\Lambda$-algebra map $A \to C$.
Let $I = \Ker(C' \to C)$. Note that $I$ is a $1$-dimensional $k$-vector
space. The obstruction $ob$ to lifting $A \to C$ is an element of
$\text{Ext}^1_A(\NL_{A/\Lambda}, I)$, see Example \ref{example-key}.
By Lemma \ref{lemma-compute-ext-into-field} and our assumption the map
$\xi$ induces an injection
$$
\text{Ext}^1_A(\NL_{A/\Lambda}, I)
\longrightarrow
\text{Ext}^1_A(E, I)
$$
By the construction of $ob$ and (i) the image of $ob$ in $\text{Ext}^1_A(E, I)$
is the obstruction to lifting $x$ to $A \times_C C'$. By (RS*) the fact that
$y/C$ lifts to $y'/C'$ implies that $x$ lifts to $A \times_C C'$. Hence
$ob = 0$ and we are done.
\end{proof}

\noindent
The key lemma above allows us to conclude that we have openness of
versality in some cases.

\begin{lemma}
\label{lemma-openness}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$ satisfying (RS*).
Let $U = \Spec(A)$ be an affine scheme of finite type over $S$ which maps
into an affine open $\Spec(\Lambda)$. Let $x$ be an object of $\mathcal{X}$
over $U$. Let $\xi : E \to \NL_{A/\Lambda}$ be a morphism of $D^{-}(A)$.
Assume
\begin{enumerate}
\item[(i)] for every deformation situation $(x, A' \to A)$ we have:
$x$ lifts to $\Spec(A')$ if and only if
$E \to \NL_{A/\Lambda} \to \NL_{A/A'}$ is zero,
\item[(ii)] there is an isomorphism of functors
$T_x(-) \to \text{Ext}^0_A(E, -)$
such that $E \to \NL_{A/\Lambda} \to \Omega^1_{A/\Lambda}$
corresponds to the canonical element (see
Remark \ref{remark-canonical-element}),
\item[(iii)] the cohomology groups of $E$ are finite $A$-modules.
\end{enumerate}
If $x$ is versal at a closed point $u_0 \in U$,
then there exists an open neighbourhood $u_0 \in U' \subset U$
such that $x$ is versal at every finite type point of $U'$.
\end{lemma}

\begin{proof}
Let $C$ be the cone of $\xi$ so that we have a distinguished triangle
$$
E \to \NL_{A/\Lambda} \to C \to E[1]
$$
in $D^{-}(A)$. By Lemma \ref{lemma-characterize-versal}
the assumption that $x$ is versal at $u_0$ implies that
$H^{-1}(C \otimes^\mathbf{L} k) = 0$. By
More on Algebra, Lemma \ref{more-algebra-lemma-cut-complex-in-two}
there exists an $f \in A$ not contained in the prime corresponding to
$u_0$ such that $H^{-1}(C \otimes^\mathbf{L}_A M) = 0$ for
any $A_f$-module $M$. Using
Lemma \ref{lemma-characterize-versal}
again we see that we have versality for all finite type points of
the open $D(f) \subset U$.
\end{proof}

\noindent
The technical lemmas above suggest the following definition.

\begin{definition}
\label{definition-naive-obstruction-theory}
Let $S$ be a locally Noetherian base. Let $\mathcal{X}$ be a category fibred
in groupoids over $(\Sch/S)_{fppf}$. Assume that $\mathcal{X}$
satisfies (RS*). A {\it naive obstruction theory} is 
given by the following data
\begin{enumerate}
\item
\label{item-map}
for every $S$-algebra $A$ such that $\Spec(A) \to S$
maps into an affine open $\Spec(\Lambda) \subset S$ and every object $x$
of $\mathcal{X}$ over $\Spec(A)$ we are given an object $E_x \in D^-(A)$
and a map $\xi_x : E \to \NL_{A/\Lambda}$,
\item
\label{item-inf}
given $(x, A)$ as in (\ref{item-map}) there are transformations of
functors
$$
\text{Inf}_x( - ) \to \text{Ext}^{-1}_A(E_x, -)
\quad\text{and}\quad
T_x(-) \to \text{Ext}^0_A(E_x, -)
$$
\item
\label{item-functoriality}
for $(x, A)$ as in (\ref{item-map}) and a ring map $A \to B$
setting $y = x|_{\Spec(B)}$ there is a functoriality map
$E_x \to E_y$ in $D(A)$.
\end{enumerate}
These data are subject to the following conditions
\begin{enumerate}
\item[(i)]
in the situation of (\ref{item-functoriality}) the diagram
$$
\xymatrix{
E_y \ar[r]_{\xi_y} & \NL_{B/\Lambda} \\
E_x \ar[u] \ar[r]^{\xi_x} & \NL_{A/\Lambda} \ar[u]
}
$$
is commutative in $D(A)$,
\item[(ii)]
given $(x, A)$ as in (\ref{item-map}) and $A \to B \to C$
setting $y = x|_{\Spec(B)}$ and $z = x|_{\Spec(C)}$ the
composition of the functoriality maps $E_x \to E_y$ and $E_y \to E_z$ is
the functoriality map $E_x \to E_z$,
\item[(iii)]
the maps of (\ref{item-inf}) are isomorphisms
compatible with the functoriality
maps and the maps of Remark \ref{remark-functoriality},
\item[(iv)]
the composition $E_x \to \NL_{A/\Lambda} \to \Omega_{A/\Lambda}$
corresponds to the canonical element of
$T_x(\Omega_{A/\Lambda}) = \text{Ext}^0(E_x, \Omega_{A/\Lambda})$, see
Remark \ref{remark-canonical-element},
\item[(v)]
given a deformation situation $(x, A' \to A)$ with $I = \Ker(A' \to A)$
the composition $E_x \to \NL_{A/\Lambda} \to \NL_{A/A'}$ is zero in
$$
\Hom_A(E_x, \NL_{A/\Lambda}) = \text{Ext}^0_A(E_x, \NL_{A/A'}) =
\text{Ext}^1_A(E_x, I)
$$
if and only if $x$ lifts to $A'$.
\end{enumerate}
\end{definition}

\noindent
Thus we see in particular that we obtain an obstruction theory
as in Section \ref{section-obstruction-theory} by setting
$\mathcal{O}_x( - ) = \text{Ext}^1_A(E_x, -)$.

\begin{lemma}
\label{lemma-naive-obstruction-theory-qis}
Let $S$ and $\mathcal{X}$ be as in
Definition \ref{definition-naive-obstruction-theory}
and let $\mathcal{X}$ be endowed with a naive obstruction theory.
Let $A \to B$ and $y \to x$ be as in (\ref{item-functoriality}).
Let $k$ be a $B$-algebra which is a field. Then the functoriality
map $E_x \to E_y$ induces bijections
$$
H^i(E_x \otimes_A^{\mathbf{L}} k) \to H^i(E_y \otimes_B^{\mathbf{L}} k)
$$
for $i = 0, 1$.
\end{lemma}

\begin{proof}
Let $z = x|_{\Spec(k)}$. Then (RS*) implies that
$$
\textit{Lift}(x, A[k]) = \textit{Lift}(z, k[k])
\quad\text{and}\quad
\textit{Lift}(y, B[k]) = \textit{Lift}(z, k[k])
$$
because $A[k] = A \times_k k[k]$ and $B[k] = B \times_k k[k]$.
Hence the properties of a naive obstruction theory imply that the
functoriality map $E_x \to E_y$ induces bijections
$\text{Ext}^i_A(E_x, k) \to \text{Ext}^i_B(E_y, k)$
for $i = -1, 0$. By Lemma \ref{lemma-compute-ext-into-field} our maps
$H^i(E_x \otimes_A^{\mathbf{L}} k) \to H^i(E_y \otimes_B^{\mathbf{L}} k)$,
$i = 0, 1$ induce isomorphisms on dual vector spaces hence are isomorphisms.
\end{proof}

\begin{lemma}
\label{lemma-naive-obstruction-theory-gives-openness}
Let $S$ be a locally Noetherian scheme. Let
$p : \mathcal{X} \to (\Sch/S)_{fppf}^{opp}$ be a category fibred in groupoids.
Assume that $\mathcal{X}$ satisfies (RS*)
and that $\mathcal{X}$ has a naive obstruction theory.
Then openness of versality holds for $\mathcal{X}$ provided the
complexes $E_x$ of Definition \ref{definition-naive-obstruction-theory}
have finitely generated cohomology groups for pairs $(A, x)$ where
$A$ is of finite type over $S$.
\end{lemma}

\begin{proof}
Let $U$ be a scheme locally of finite type over $S$, let $x$ be an object of
$\mathcal{X}$ over $U$, and let $u_0$ be a finite type point of $U$ such that
$x$ is versal at $u_0$. We may first shrink $U$ to an affine scheme such
that $u_0$ is a closed point and such that $U \to S$ maps into an affine
open $\Spec(\Lambda)$. Say $U = \Spec(A)$. Let
$\xi_x : E_x \to \NL_{A/\Lambda}$ be the obstruction map.
At this point we may apply Lemma \ref{lemma-openness} to conclude.
\end{proof}









\section{A dual notion}
\label{section-dual}

\noindent
Let $(x, A' \to A)$ be a deformation situation for a given category
$\mathcal{X}$ fibred in groupoids over a locally Noetherian scheme $S$.
Assume $\mathcal{X}$ has an obstruction theory, see
Definition \ref{definition-obstruction-theory}. In practice
one often has a complex $K^\bullet$ of $A$-modules and isomorphisms of
functors
$$
\text{Inf}_x(-) \to H^0(K^\bullet \otimes_A^\mathbf{L} -),\quad
T_x(-) \to H^1(K^\bullet \otimes_A^\mathbf{L} -),\quad
\mathcal{O}_x(-) \to H^2(K^\bullet \otimes_A^\mathbf{L} -)
$$
In this section we formalize this a little bit and show how this leads
to a verification of openness of versality in some cases.

\begin{example}
\label{example-global-sections-dual}
Let $\Lambda, S, W, \mathcal{F}$ be as in
Example \ref{example-global-sections}.
Assume that $W \to S$ is proper and $\mathcal{F}$ coherent. By
Cohomology of Schemes, Remark
\ref{coherent-remark-explain-perfect-direct-image}
there exists a finite complex of finite projective $\Lambda$-modules
$N^\bullet$ which universally computes the cohomology of $\mathcal{F}$.
In particular the obstruction spaces from Example \ref{example-global-sections}
are $\mathcal{O}_x(M) = H^1(N^\bullet \otimes_\Lambda M)$.
Hence with $K^\bullet = N^\bullet \otimes_\Lambda A[-1]$ we see that
$\mathcal{O}_x(M) = H^2(K^\bullet \otimes_A^\mathbf{L} M)$.
\end{example}

\begin{situation}
\label{situation-dual}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$. Assume that
$\mathcal{X}$ has (RS*) so that we can speak of the functor $T_x(-)$, see
Lemma \ref{lemma-properties-lift-RS-star}.
Let $U = \Spec(A)$ be an affine scheme of finite type over $S$ which maps
into an affine open $\Spec(\Lambda)$. Let $x$ be an object of $\mathcal{X}$
over $U$. Assume we are given
\begin{enumerate}
\item a complex of $A$-modules $K^\bullet$,
\item a transformation of functors
$T_x(-) \to H^1(K^\bullet \otimes_A^\mathbf{L} -)$,
\item for every deformation situation $(x, A' \to A)$ with kernel
$I = \Ker(A' \to A)$ an element
$o_x(A') \in H^2(K^\bullet \otimes_A^\mathbf{L} I)$
\end{enumerate}
satisfying the following (minimal) conditions
\begin{enumerate}
\item[(i)] the transformation
$T_x(-) \to H^1(K^\bullet \otimes_A^\mathbf{L} -)$
is an isomorphism,
\item[(ii)] given a morphism $(x, A'' \to A) \to (x, A' \to A)$ of deformation
situations the element $o_x(A')$ maps to the element $o_x(A'')$
via the map
$H^2(K^\bullet \otimes_A^\mathbf{L} I) \to
H^2(K^\bullet \otimes_A^\mathbf{L} I')$
where $I' = \Ker(A'' \to A)$, and
\item[(iii)] $x$ lifts to an object over $\Spec(A')$ if and only if
$o_x(A') = 0$.
\end{enumerate}
It is possible to incorporate infinitesimal automorphisms as well, but
we refrain from doing so in order to get the sharpest possible result.
\end{situation}

\noindent
In Situation \ref{situation-dual} an important role will be played by
$K^\bullet \otimes_A^\mathbf{L} \NL_{A/\Lambda}$. Suppose we are given an
element $\xi \in H^1(K^\bullet \otimes_A^\mathbf{L} \NL_{A/\Lambda})$.
Then (1) for any surjection $A' \to A$ of $\Lambda$-algebras with kernel
$I$ of square zero the canonical map $\NL_{A/\Lambda} \to \NL_{A/A'} = I[1]$
sends $\xi$ to an element $\xi_{A'} \in H^2(K^\bullet \otimes_A^\mathbf{L} I)$
and (2) the map $\NL_{A/\Lambda} \to \Omega_{A/\Lambda}$ sends
$\xi$ to an element $\xi_{can}$ of
$H^1(K^\bullet \otimes_A^\mathbf{L} \Omega_{A/\Lambda})$.

\begin{lemma}
\label{lemma-dual-obstruction}
In Situation \ref{situation-dual}. Assume furthermore that
\begin{enumerate}
\item[(iv)] given a short exact sequence of deformation situations
as in Remark \ref{remark-short-exact-sequence-thickenings} and
a lift $x'_2 \in \text{Lift}(x, A_2')$ then
$o_x(A_3') \in H^2(K^\bullet \otimes_A^\mathbf{L} I_3)$
equals $\partial\theta$ where
$\theta \in H^1(K^\bullet \otimes_A^\mathbf{L} I_1)$
is the element corresponding to $x'_2|_{\Spec(A_1')}$ via
$A_1' = A[I_1]$ and the given map
$T_x(-) \to H^1(K^\bullet \otimes_A^\mathbf{L} -)$.
\end{enumerate}
In this case there exists an element
$\xi \in H^1(K^\bullet \otimes_A^\mathbf{L} \NL_{A/\Lambda})$
such that
\begin{enumerate}
\item for every deformation situation $(x, A' \to A)$ we have
$\xi_{A'} = o_x(A')$, and
\item $\xi_{can}$ matches the canonical element of
Remark \ref{remark-canonical-element} via the given transformation
$T_x(-) \to H^1(K^\bullet \otimes_A^\mathbf{L} -)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a $\alpha : \Lambda[x_1, \ldots, x_n] \to A$ with kernel $J$.
Write $P = \Lambda[x_1, \ldots, x_n]$. In the rest of this proof we work with
$$
\NL(\alpha) = (J/J^2 \longrightarrow \bigoplus A \text{d}x_i)
$$
which is permissible by
Algebra, Lemma \ref{algebra-lemma-NL-homotopy}
and
More on Algebra, Lemma \ref{more-algebra-lemma-derived-tor-homotopy}.
Consider the element
$o_x(P/J^2) \in H^2(K^\bullet \otimes_A^\mathbf{L} J/J^2)$ and consider
the quotient
$$
C = (P/J^2 \times \bigoplus A \text{d}x_i)/(J/J^2)
$$
where $J/J^2$ is embedded diagonally. Note that $C \to A$ is a surjection
with kernel $\bigoplus A\text{d}x_i$. Moreover there is a section
$A \to C$ to $C \to A$ given by mapping the class of $f \in P$ to the class
of $(f, \text{d}f)$ in the pushout. For later use, denote $x_C$ the
pullback of $x$ along the corresponding morphism $\Spec(C) \to \Spec(A)$.
Thus we see that $o_x(C) = 0$.
We conclude that $o_x(P/J^2)$ maps to zero in
$H^2(K^\bullet \otimes_A^\mathbf{L} \bigoplus A\text{d}x_i)$.
It follows that there exists some element
$\xi \in H^1(K^\bullet \otimes_A^\mathbf{L} \NL(\alpha))$
mapping to $o_x(P/J^2)$.

\medskip\noindent
Note that for any deformation situation $(x, A' \to A)$ there exists
a $\Lambda$-algebra map $P/J^2 \to A'$ compatible with the augmentations
to $A$. Hence the
element $\xi$ satisfies the first property of the lemma by construction
and property (ii) of Situation \ref{situation-dual}.

\medskip\noindent
Note that our choice of $\xi$ was well defined up to the choice of an
element of $H^1(K^\bullet \otimes_A^\mathbf{L} \bigoplus A\text{d}x_i)$.
We will show that after modifying $\xi$ by an element of the aforementioned
group we can arrange it so that the second assertion of the lemma is true.
Let $C' \subset C$ be the image of $P/J^2$ under the
$\Lambda$-algebra map $P/J^2 \to C$ (inclusion of first factor).
Observe that
$\Ker(C' \to A) = \Im(J/J^2 \to \bigoplus A\text{d}x_i)$.
Set $\overline{C} = A[\Omega_{A/\Lambda}]$. The map
$P/J^2 \times \bigoplus A \text{d}x_i \to \overline{C}$,
$(f, \sum f_i \text{d}x_i) \mapsto (f \bmod J, \sum f_i \text{d}x_i)$
factors through a surjective map $C \to \overline{C}$. Then
$$
(x, \overline{C} \to A) \to (x, C \to A) \to (x, C' \to A)
$$
is a short exact sequence of deformation situations. The
associated splitting $\overline{C} = A[\Omega_{A/\Lambda}]$ (from
Remark \ref{remark-short-exact-sequence-thickenings}) equals the given
splitting above. Moreover, the section $A \to C$ composed with the map
$C \to \overline{C}$
is the map $(1, \text{d}) : A \to A[\Omega_{A/\Lambda}]$ of
Remark \ref{remark-canonical-element}.
Thus $x_C$ restricts to the canonical element $x_{can}$ of
$T_x(\Omega_{A/\Lambda}) = \text{Lift}(x, A[\Omega_{A/\Lambda}])$.
By condition (iv) we conclude that $o_x(P/J^2)$ maps to $\partial x_{can}$
in
$$
H^1(K^\bullet \otimes_A^\mathbf{L} \Im(J/J^2 \to \bigoplus A\text{d}x_i))
$$
By construction $\xi$ maps to $o_x(P/J^2)$. It follows that
$x_{can}$ and $\xi_{can}$ map to the same element in the
displayed group which means (by the long exact cohomology sequence)
that they differ by an element of
$H^1(K^\bullet \otimes_A^\mathbf{L} \bigoplus A\text{d}x_i)$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-dual-openness}
In Situation \ref{situation-dual} assume that (iv) of
Lemma \ref{lemma-dual-obstruction} holds and that $K^\bullet$ is a
perfect object of $D(A)$. In this case, if $x$ is versal at a closed
point $u_0 \in U$ then there exists an open neighbourhood
$u_0 \in U' \subset U$ such that $x$ is versal at every finite type
point of $U'$.
\end{lemma}

\begin{proof}
We may assume that $K^\bullet$ is a finite complex of finite projective
$A$-modules. Thus the derived tensor product with $K^\bullet$ is the
same as simply tensoring with $K^\bullet$. Let
$E^\bullet$ be the dual perfect complex to $K^\bullet$, see
More on Algebra, Lemma \ref{more-algebra-lemma-dual-perfect-complex}.
(So $E^n = \Hom_A(K^{-n}, A)$ with differentials the transpose of the
differentials of $K^\bullet$.) Let $E \in D^{-}(A)$ denote the
object represented by the complex $E^\bullet[-1]$.
Let $\xi \in H^1(\text{Tot}(K^\bullet \otimes_A \NL_{A/\Lambda}))$
be the element constructed in Lemma \ref{lemma-dual-obstruction}
and denote $\xi : E = E^\bullet[-1] \to \NL_{A/\Lambda}$ the corresponding
map (loc.cit.). We claim that the pair $(E, \xi)$ satisfies all the
assumptions of Lemma \ref{lemma-openness} which finishes the proof.

\medskip\noindent
Namely, assumption (i) of Lemma \ref{lemma-openness} follows from conclusion
(1) of Lemma \ref{lemma-dual-obstruction}
and the fact that $H^2(K^\bullet \otimes_A^\mathbf{L} -) =
\text{Ext}^1(E, -)$ by loc.cit. Assumption (ii) of
Lemma \ref{lemma-openness} follows from conclusion (2) of
Lemma \ref{lemma-dual-obstruction}
and the fact that $H^1(K^\bullet \otimes_A^\mathbf{L} -) =
\text{Ext}^0(E, -)$ by loc.cit. Assumption (iii) of Lemma \ref{lemma-openness}
is clear.
\end{proof}








\section{Examples of deformation problems}
\label{section-examples}

\noindent
List of things that should go here:
\begin{enumerate}
\item Describe the general outline of an example.
\item Deformations of schemes:
\begin{enumerate}
\item The Rim-Schlessinger condition.
\item Computing the tangent space.
\item Computing the infinitesimal deformations.
\item The deformation category of an affine hypersurface.
\end{enumerate}
\item Deformations of representations of abstract groups.
\item Deformations of representations of topological groups
(e.g., profinite ones).
\item Deformations of sheaves (for example fix $X/S$, a finite type point
$s$ of $S$, and a quasi-coherent sheaf $\mathcal{F}_s$ over $X_s$).
\item Deformations of algebraic spaces (very similar to deformations
of schemes; maybe even easier?).
\item Deformations of maps (eg morphisms between schemes; you can fix
both or one of the target and/or source).
\item Add more here.
\end{enumerate}










\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%

\begin{document}

\title{Bibliography}

\maketitle

\bibliography{my}
\nocite{*}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Bootstrap}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we use the material from the preceding sections to
give criteria under which a presheaf of sets on the category of schemes
is an algebraic space. Some of this material comes from the work
of Artin, see \cite{ArtinI}, \cite{ArtinII},
\cite{Artin-Theorem-Representability},
\cite{Artin-Construction-Techniques},
\cite{Artin-Algebraic-Spaces},
\cite{Artin-Algebraic-Approximation},
\cite{Artin-Implicit-Function},
and \cite{ArtinVersal}.
However, our method will be to use as much as possible arguments
similar to those of the paper by Keel and Mori, see
\cite{K-M}.

\section{Conventions}
\label{section-conventions}

\noindent
The standing assumption is that all schemes are contained in
a big fppf site $\Sch_{fppf}$. And all rings $A$ considered
have the property that $\Spec(A)$ is (isomorphic) to an
object of this big site.

\medskip\noindent
Let $S$ be a scheme and let $X$ be an algebraic space over $S$.
In this chapter and the following we will write $X \times_S X$
for the product of $X$ with itself (in the category of algebraic
spaces over $S$), instead of $X \times X$.




\section{Morphisms representable by algebraic spaces}
\label{section-morphism-representable-by-spaces}

\noindent
Here we define the notion of one presheaf being relatively representable
by algebraic spaces over another, and we prove some properties of this notion.

\begin{definition}
\label{definition-morphism-representable-by-spaces}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F$, $G$ be presheaves on $\Sch_{fppf}/S$.
We say a morphism $a : F \to G$ is
{\it representable by algebraic spaces}
if for every $U \in \Ob((\Sch/S)_{fppf})$ and
any $\xi : U \to G$ the fiber product $U \times_{\xi, G} F$
is an algebraic space.
\end{definition}

\noindent
Here is a sanity check.

\begin{lemma}
\label{lemma-morphism-spaces-is-representable-by-spaces}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Then $f$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
This is formal. It relies on the fact that
the category of algebraic spaces over $S$ has fibre products, see
Spaces, Lemma \ref{spaces-lemma-fibre-product-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-transformation}
\begin{slogan}
A base change of a representable by algebraic spaces morphism of
presheaves is representable by algebraic spaces.
\end{slogan}
Let $S$ be a scheme. Let
$$
\xymatrix{
G' \times_G F \ar[r] \ar[d]^{a'} & F \ar[d]^a \\
G' \ar[r] & G
}
$$
be a fibre square of presheaves on $(\Sch/S)_{fppf}$.
If $a$ is representable by algebraic spaces so is $a'$.
\end{lemma}

\begin{proof}
Omitted. Hint: This is formal.
\end{proof}

\begin{lemma}
\label{lemma-representable-by-spaces-transformation-to-sheaf}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be representable by algebraic spaces.
If $G$ is a sheaf, then so is $F$.
\end{lemma}

\begin{proof}
(Same as the proof of
Spaces, Lemma \ref{spaces-lemma-representable-transformation-to-sheaf}.)
Let $\{\varphi_i : T_i \to T\}$ be a covering of the site
$(\Sch/S)_{fppf}$.
Let $s_i \in F(T_i)$ which satisfy the sheaf condition.
Then $\sigma_i = a(s_i) \in G(T_i)$ satisfy the sheaf condition
also. Hence there exists a unique $\sigma \in G(T)$ such
that $\sigma_i = \sigma|_{T_i}$. By assumption
$F' = h_T \times_{\sigma, G, a} F$ is a sheaf.
Note that $(\varphi_i, s_i) \in F'(T_i)$ satisfy the
sheaf condition also, and hence come from some unique
$(\text{id}_T, s) \in F'(T)$. Clearly $s$ is the section of
$F$ we are looking for.
\end{proof}

\begin{lemma}
\label{lemma-representable-by-spaces-transformation-diagonal}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be representable by algebraic spaces.
Then $\Delta_{F/G} : F \to F \times_G F$ is representable by
algebraic spaces.
\end{lemma}

\begin{proof}
(Same as the proof of
Spaces, Lemma \ref{spaces-lemma-representable-transformation-diagonal}.)
Let $U$ be a scheme. Let $\xi = (\xi_1, \xi_2) \in (F \times_G F)(U)$.
Set $\xi' = a(\xi_1) = a(\xi_2) \in G(U)$.
By assumption there exist an algebraic space $V$ and a morphism $V \to U$
representing the fibre product $U \times_{\xi', G} F$.
In particular, the elements $\xi_1, \xi_2$ give morphisms
$f_1, f_2 : U \to V$ over $U$. Because $V$ represents the
fibre product $U \times_{\xi', G} F$ and because
$\xi' = a \circ \xi_1 = a \circ \xi_2$
we see that if $g : U' \to U$ is a morphism then
$$
g^*\xi_1 = g^*\xi_2
\Leftrightarrow
f_1 \circ g = f_2 \circ g.
$$
In other words, we see that $U \times_{\xi, F \times_G F} F$
is represented by $V \times_{\Delta, V \times V, (f_1, f_2)} U$
which is an algebraic space.
\end{proof}

\noindent
The proof of
Lemma \ref{lemma-representable-by-spaces-over-space}
below is actually slightly tricky. Namely,
we cannot use the argument of the proof of
Spaces, Lemma \ref{spaces-lemma-representable-over-space}
because we do not yet know that a composition of transformations
representable by algebraic spaces is representable by algebraic
spaces. In fact, we will use this lemma to prove that statement.

\begin{lemma}
\label{lemma-representable-by-spaces-over-space}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be representable by algebraic spaces.
If $G$ is an algebraic space, then so is $F$.
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-representable-by-spaces-transformation-to-sheaf}
that $F$ is a sheaf.

\medskip\noindent
Let $U$ be a scheme and let $U \to G$ be a surjective \'etale morphism.
In this case $U \times_G F$ is an algebraic space. Let $W$ be a scheme
and let $W \to U \times_G F$ be a surjective \'etale morphism.

\medskip\noindent
First we claim that $W \to F$ is representable.
To see this let $X$ be a scheme and let $X \to F$ be a morphism.
Then
$$
W \times_F X = W \times_{U \times_G F} U \times_G F \times_F X
= W \times_{U \times_G F} (U \times_G X)
$$
Since both $U \times_G F$ and $G$ are algebraic spaces we see that
this is a scheme.

\medskip\noindent
Next, we claim that $W \to F$ is surjective and \'etale (this makes
sense now that we know it is representable). This follows from the
formula above since both $W \to U \times_G F$ and $U \to G$
are \'etale and surjective, hence
$W \times_{U \times_G F} (U \times_G X) \to U \times_G X$ and
$U \times_G X \to X$ are surjective and \'etale, and the composition of
surjective \'etale morphisms is surjective and \'etale.

\medskip\noindent
Set $R = W \times_F W$. By the above $R$ is a scheme and
the projections $t, s : R \to W$
are \'etale. It is clear that $R$ is an equivalence relation, and
$W \to F$ is a surjection of sheaves. Hence $R$ is an \'etale equivalence
relation and $F = W/R$. Hence $F$ is an algebraic space by
Spaces,
Theorem \ref{spaces-theorem-presentation}.
\end{proof}

\begin{lemma}
\label{lemma-representable-by-spaces}
Let $S$ be a scheme.
Let $a : F \to G$ be a map of presheaves on $(\Sch/S)_{fppf}$.
Suppose $a : F \to G$ is representable by algebraic spaces.
If $X$ is an algebraic space over $S$, and $X \to G$ is a map of presheaves
then $X \times_G F$ is an algebraic space.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-transformation} the transformation
$X \times_G F \to X$ is representable by algebraic spaces. Hence it is
an algebraic space by
Lemma \ref{lemma-representable-by-spaces-over-space}.
\end{proof}

\begin{lemma}
\label{lemma-composition-transformation}
Let $S$ be a scheme.
Let
$$
\xymatrix{
F \ar[r]^a & G \ar[r]^b & H
}
$$
be maps of presheaves on $(\Sch/S)_{fppf}$.
If $a$ and $b$ are representable by algebraic spaces, so is
$b \circ a$.
\end{lemma}

\begin{proof}
Let $T$ be a scheme over $S$, and let $T \to H$ be a morphism.
By assumption $T \times_H G$ is an algebraic space. Hence by
Lemma \ref{lemma-representable-by-spaces}
we see that $T \times_H F = (T \times_H G) \times_G F$ is an
algebraic space as well.
\end{proof}

\begin{lemma}
\label{lemma-product-transformations}
Let $S$ be a scheme.
Let $F_i, G_i : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$, $i = 1, 2$.
Let $a_i : F_i \to G_i$, $i = 1, 2$
be representable by algebraic spaces.
Then
$$
a_1 \times a_2 : F_1 \times F_2 \longrightarrow G_1 \times G_2
$$
is a representable by algebraic spaces.
\end{lemma}

\begin{proof}
Write $a_1 \times a_2$ as the composition
$F_1 \times F_2 \to G_1 \times F_2 \to G_1 \times G_2$.
The first arrow is the base change of $a_1$ by the map
$G_1 \times F_2 \to G_1$, and the second arrow
is the base change of $a_2$ by the map
$G_1 \times G_2 \to G_2$. Hence this lemma is a formal
consequence of Lemmas \ref{lemma-composition-transformation}
and \ref{lemma-base-change-transformation}.
\end{proof}

\begin{lemma}
\label{lemma-representable-by-spaces-permanence}
Let $S$ be a scheme. Let $a : F \to G$ and $b : G \to H$ be
transformations of functors $(\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Assume
\begin{enumerate}
\item $\Delta : G \to G \times_H G$ is representable
by algebraic spaces, and
\item $b \circ a : F \to H$ is representable by algebraic spaces.
\end{enumerate}
Then $a$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Let $U$ be a scheme over $S$ and let $\xi \in G(U)$. Then
$$
U \times_{\xi, G, a} F =
(U \times_{b(\xi), H, b \circ a} F) \times_{(\xi, a), (G \times_H G), \Delta} G
$$
Hence the result using Lemma \ref{lemma-representable-by-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-glueing-sheaves}
Let $S \in \Ob(\Sch_{fppf})$. Let $F$ be a presheaf of sets on
$(\Sch/S)_{fppf}$. Assume
\begin{enumerate}
\item $F$ is a sheaf for the Zariski topology on $(\Sch/S)_{fppf}$,
\item there exists an index set $I$ and subfunctors $F_i \subset F$ such that
\begin{enumerate}
\item each $F_i$ is an fppf sheaf,
\item each $F_i \to F$ is representable by algebraic spaces,
\item $\coprod F_i \to F$ becomes surjective after fppf sheafification.
\end{enumerate}
\end{enumerate}
Then $F$ is an fppf sheaf.
\end{lemma}

\begin{proof}
Let $T \in \Ob((\Sch/S)_{fppf})$ and let $s \in F(T)$. By (2)(c)
there exists an fppf covering $\{T_j \to T\}$ such that
$s|_{T_j}$ is a section of $F_{\alpha(j)}$ for some $\alpha(j) \in I$.
Let $W_j \subset T$ be the image of $T_j \to T$
which is an open subscheme Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
By (2)(b) we see
$F_{\alpha(j)} \times_{F, s|_{W_j}} W_j \to W_j$ is a monomorphism
of algebraic spaces through which $T_j$ factors. Since $\{T_j \to W_j\}$
is an fppf covering, we conclude that
$F_{\alpha(j)} \times_{F, s|_{W_j}} W_j = W_j$, in other words
$s|_{W_j} \in F_{\alpha(j)}(W_j)$. Hence we conclude that
$\coprod F_i \to F$ is surjective for the Zariski topology.

\medskip\noindent
Let $\{T_j \to T\}$ be an fppf covering in $(\Sch/S)_{fppf}$.
Let $s, s' \in F(T)$ with $s|_{T_j} = s'|_{T_j}$ for all $j$.
We want to show that $s, s'$ are equal. As $F$ is a Zariski sheaf by (1)
we may work Zariski locally on $T$. By the result of the previous paragraph
we may assume there exist $i$ such that $s \in F_i(T)$. Then we see that
$s'|_{T_j}$ is a section of $F_i$. By (2)(b) we see
$F_{i} \times_{F, s'} T \to T$ is a monomorphism of algebraic spaces
through which all of the $T_j$ factor. Hence we conclude that
$s' \in F_i(T)$. Since $F_i$ is a sheaf for the fppf topology
we conclude that $s = s'$.

\medskip\noindent
Let $\{T_j \to T\}$ be an fppf covering in $(\Sch/S)_{fppf}$ and let
$s_j \in F(T_j)$ such that
$s_j|_{T_j \times_T T_{j'}} = s_{j'}|_{T_j \times_T T_{j'}}$. By assumption
(2)(b) we may refine the covering and assume that $s_j \in F_{\alpha(j)}(T_j)$
for some $\alpha(j) \in I$. Let $W_j \subset T$ be the image of $T_j \to T$
which is an open subscheme Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
Then $\{T_j \to W_j\}$ is an fppf covering. Since $F_{\alpha(j)}$ is a sub
presheaf of $F$ we see that the two restrictions of $s_j$ to
$T_j \times_{W_j} T_j$ agree as elements of
$F_{\alpha(j)}(T_j \times_{W_j} T_j)$. Hence, the sheaf condition for
$F_{\alpha(j)}$ implies there exists a $s'_j \in F_{\alpha(j)}(W_j)$
whose restriction to $T_j$ is $s_j$. For a pair of indices
$j$ and $j'$ the sections $s'_j|_{W_j \cap W_{j'}}$ and
$s'_{j'}|_{W_j \cap W_{j'}}$ of $F$ agree by the result of the
previous paragraph. This finishes the proof by the fact that
$F$ is a Zariski sheaf.
\end{proof}





\section{Properties of maps of presheaves representable by algebraic spaces}
\label{section-representable-by-spaces-properties}

\noindent
Here is the definition that makes this work.

\begin{definition}
\label{definition-property-transformation}
Let $S$ be a scheme. Let $a : F \to G$ be a map of presheaves on
$(\Sch/S)_{fppf}$ which is representable by algebraic spaces.
Let $\mathcal{P}$ be a property of morphisms of algebraic spaces which
\begin{enumerate}
\item is preserved under any base change, and
\item is fppf local on the base, see
Descent on Spaces,
Definition \ref{spaces-descent-definition-property-morphisms-local}.
\end{enumerate}
In this case we say that $a$ has {\it property $\mathcal{P}$} if for every
scheme $U$ and $\xi : U \to G$ the resulting morphism of algebraic spaces
$U \times_G F \to U$ has property $\mathcal{P}$.
\end{definition}

\noindent
It is important to note that we will only use this definition for
properties of morphisms that are stable under base change, and
local in the fppf topology on the base. This is
not because the definition doesn't make sense otherwise; rather it
is because we may want to give a different definition which is
better suited to the property we have in mind.

\medskip\noindent
The definition above applies\footnote{Being preserved under base
change holds by
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-surjective},
\ref{spaces-morphisms-lemma-base-change-quasi-compact},
\ref{spaces-morphisms-lemma-base-change-etale},
\ref{spaces-morphisms-lemma-base-change-flat},
\ref{spaces-morphisms-lemma-base-change-separated},
\ref{spaces-morphisms-lemma-base-change-finite-type},
\ref{spaces-morphisms-lemma-base-change-quasi-finite},
\ref{spaces-morphisms-lemma-base-change-finite-presentation},
\ref{spaces-morphisms-lemma-base-change-proper}, and
Spaces, Lemma
\ref{spaces-lemma-base-change-immersions}.
Being fppf local on the base holds by
Descent on Spaces, Lemmas
\ref{spaces-descent-lemma-descending-property-surjective},
\ref{spaces-descent-lemma-descending-property-quasi-compact},
\ref{spaces-descent-lemma-descending-property-etale},
\ref{spaces-descent-lemma-descending-property-flat},
\ref{spaces-descent-lemma-descending-property-separated},
\ref{spaces-descent-lemma-descending-property-finite-type},
\ref{spaces-descent-lemma-descending-property-quasi-finite},
\ref{spaces-descent-lemma-descending-property-locally-finite-presentation},
\ref{spaces-descent-lemma-descending-property-proper}, and
\ref{spaces-descent-lemma-descending-property-closed-immersion}.
}
for example to the properties of being
``surjective'',
``quasi-compact'',
``\'etale'',
``flat'',
``separated'',
``(locally) of finite type'',
``(locally) quasi-finite'',
``(locally) of finite presentation'',
``proper'', and
``a closed immersion''.
In other words, $a$ is
{\it surjective}
(resp.\ {\it quasi-compact},
{\it \'etale},
{\it flat},
{\it separated},
{\it (locally) of finite type},
{\it (locally) quasi-finite},
{\it (locally) of finite presentation},
{\it proper},
{\it a closed immersion})
if for every scheme $T$ and map $\xi : T \to G$
the morphism of algebraic spaces $T \times_{\xi, G} F \to T$ is
surjective
(resp.\ quasi-compact,
\'etale,
flat,
separated,
(locally) of finite type,
(locally) quasi-finite,
(locally) of finite presentation,
proper,
a closed immersion).

\medskip\noindent
Next, we check consistency with the already existing notions. By
Lemma \ref{lemma-morphism-spaces-is-representable-by-spaces}
any morphism between algebraic spaces over $S$ is representable by
algebraic spaces. And by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-surjective-local}
(resp.\ \ref{spaces-morphisms-lemma-quasi-compact-local},
\ref{spaces-morphisms-lemma-etale-local},
\ref{spaces-morphisms-lemma-flat-local},
\ref{spaces-morphisms-lemma-separated-local},
\ref{spaces-morphisms-lemma-finite-type-local},
\ref{spaces-morphisms-lemma-quasi-finite-local},
\ref{spaces-morphisms-lemma-finite-presentation-local},
\ref{spaces-morphisms-lemma-proper-local},
\ref{spaces-morphisms-lemma-closed-immersion-local})
the definition of
surjective
(resp.\ quasi-compact,
\'etale,
flat,
separated,
(locally) of finite type,
(locally) quasi-finite,
(locally) of finite presentation,
proper,
closed immersion)
above agrees with the already existing definition of morphisms
of algebraic spaces.

\medskip\noindent
Some formal lemmas follow.

\begin{lemma}
\label{lemma-base-change-transformation-property}
Let $S$ be a scheme.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-property-transformation}.
Let
$$
\xymatrix{
G' \times_G F \ar[r] \ar[d]^{a'} & F \ar[d]^a \\
G' \ar[r] & G
}
$$
be a fibre square of presheaves on $(\Sch/S)_{fppf}$.
If $a$ is representable by algebraic spaces and has $\mathcal{P}$
so does $a'$.
\end{lemma}

\begin{proof}
Omitted. Hint: This is formal.
\end{proof}

\begin{lemma}
\label{lemma-composition-transformation-property}
Let $S$ be a scheme.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-property-transformation},
and assume $\mathcal{P}$ is stable under composition.
Let
$$
\xymatrix{
F \ar[r]^a & G \ar[r]^b & H
}
$$
be maps of presheaves on $(\Sch/S)_{fppf}$.
If $a$, $b$ are representable by algebraic spaces and has
$\mathcal{P}$ so does $b \circ a$.
\end{lemma}

\begin{proof}
Omitted. Hint: See
Lemma \ref{lemma-composition-transformation}
and use stability under composition.
\end{proof}

\begin{lemma}
\label{lemma-product-transformations-property}
Let $S$ be a scheme.
Let $F_i, G_i : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$,
$i = 1, 2$.
Let $a_i : F_i \to G_i$, $i = 1, 2$ be representable by algebraic spaces.
Let $\mathcal{P}$ be a property as in
Definition \ref{definition-property-transformation}
which is stable under composition.
If $a_1$ and $a_2$ have property $\mathcal{P}$ so does
$a_1 \times a_2 : F_1 \times F_2 \longrightarrow G_1 \times G_2$.
\end{lemma}

\begin{proof}
Note that the lemma makes sense by
Lemma \ref{lemma-product-transformations}.
Proof omitted.
\end{proof}

\begin{lemma}
\label{lemma-transformations-property-implication}
Let $S$ be a scheme.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be a transformation of functors representable by
algebraic spaces.
Let $\mathcal{P}$, $\mathcal{P}'$ be properties as in
Definition \ref{definition-property-transformation}.
Suppose that for any morphism $f : X \to Y$ of algebraic spaces over $S$
we have $\mathcal{P}(f) \Rightarrow \mathcal{P}'(f)$.
If $a$ has property $\mathcal{P}$, then
$a$ has property $\mathcal{P}'$.
\end{lemma}

\begin{proof}
Formal.
\end{proof}

\begin{lemma}
\label{lemma-surjective-flat-locally-finite-presentation}
Let $S$ be a scheme.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be sheaves.
Let $a : F \to G$ be representable by algebraic spaces, flat,
locally of finite presentation, and surjective.
Then $a : F \to G$ is surjective as a map of sheaves.
\end{lemma}

\begin{proof}
Let $T$ be a scheme over $S$ and let $g : T \to G$ be a $T$-valued point of
$G$. By assumption $T' = F \times_G T$ is an algebraic space and
the morphism $T' \to T$ is a flat, locally of finite presentation, and
surjective morphism of algebraic spaces.
Let $U \to T'$ be a surjective \'etale morphism, where $U$ is a scheme.
Then by the definition of flat morphisms of algebraic spaces
the morphism of schemes $U \to T$ is flat. Similarly for
``locally of finite presentation''. The morphism $U \to T$ is surjective
also, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-surjective-local}.
Hence we see that $\{U \to T\}$ is an fppf covering such
that $g|_U \in G(U)$ comes from an element of $F(U)$, namely
the map $U \to T' \to F$. This proves the map is surjective as
a map of sheaves, see
Sites, Definition \ref{sites-definition-sheaves-injective-surjective}.
\end{proof}




\section{Bootstrapping the diagonal}
\label{section-bootstrap-diagonal}

\begin{lemma}
\label{lemma-representable-diagonal}
\begin{slogan}
The diagonal of a presheaf is representable by algebraic spaces if and only if
every map from a scheme to the presheaf is representable by algebraic spaces.
\end{slogan}
Let $S$ be a scheme.
If $F$ is a presheaf on $(\Sch/S)_{fppf}$.
The following are equivalent:
\begin{enumerate}
\item $\Delta_F : F \to F \times F$ is representable by algebraic spaces,
\item for every scheme $T$ any map $T \to F$ is representable by algebraic
spaces, and
\item for every algebraic space $X$ any map $X \to F$ is representable
by algebraic spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). Let $X \to F$ be as in (3). Let $T$ be a scheme, and let
$T \to F$ be a morphism. Then we have
$$
T \times_F X = (T \times_S X) \times_{F \times F, \Delta} F
$$
which is an algebraic space by
Lemma \ref{lemma-representable-by-spaces}
and (1). Hence $X \to F$ is representable, i.e., (3) holds.
The implication (3) $\Rightarrow$ (2) is trivial. Assume (2).
Let $T$ be a scheme, and let $(a, b) : T \to F \times F$ be a morphism.
Then
$$
F \times_{\Delta_F, F \times F} T = T \times_{a, F, b} T
$$
which is an algebraic space by assumption. Hence $\Delta_F$ is
representable by algebraic spaces, i.e., (1) holds.
\end{proof}

\noindent
In particular if $F$ is a presheaf satisfying the equivalent conditions of
the lemma, then for any morphism $X \to F$ where $X$ is an algebraic space
it makes sense to say that $X \to F$ is surjective (resp.\ \'etale, flat,
locally of finite presentation) by using
Definition \ref{definition-property-transformation}.

\medskip\noindent
Before we actually do the bootstrap we prove a fun lemma.

\begin{lemma}
\label{lemma-after-fppf-sep-lqf}
Let $S$ be a scheme.
Let
$$
\xymatrix{
E \ar[r]_a \ar[d]_f & F \ar[d]^g \\
H \ar[r]^b & G
}
$$
be a cartesian diagram of sheaves on $(\Sch/S)_{fppf}$, so
$E = H \times_G F$. If
\begin{enumerate}
\item $g$ is representable by algebraic spaces, surjective, flat, and
locally of finite presentation, and
\item $a$ is representable by algebraic spaces, separated, and
locally quasi-finite
\end{enumerate}
then $b$ is representable (by schemes) as well as separated and
locally quasi-finite.
\end{lemma}

\begin{proof}
Let $T$ be a scheme, and let $T \to G$ be a morphism.
We have to show that $T \times_G H$ is a scheme, and that
the morphism $T \times_G H \to T$ is separated and
locally quasi-finite. Thus we may base change the whole diagram to $T$
and assume that $G$ is a scheme. In this case $F$ is an algebraic space.
Let $U$ be a scheme, and let $U \to F$ be a surjective \'etale morphism.
Then $U \to F$ is representable, surjective, flat and
locally of finite presentation by
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-etale-flat} and
\ref{spaces-morphisms-lemma-etale-locally-finite-presentation}.
By
Lemma \ref{lemma-composition-transformation}
$U \to G$ is surjective, flat and locally of finite presentation also.
Note that the base change $E \times_F U \to U$ of $a$ is still
separated and locally quasi-finite (by
Lemma \ref{lemma-base-change-transformation-property}). Hence we
may replace the upper part of the diagram of the lemma by
$E \times_F U \to U$. In other words, we may assume that
$F \to G$ is a surjective, flat morphism of schemes
which is locally of finite presentation.
In particular, $\{F \to G\}$ is an fppf covering of schemes.
By
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
we conclude that $E$ is a scheme also.
By
Descent, Lemma \ref{descent-lemma-descent-data-sheaves}
the fact that $E = H \times_G F$ means that we get a descent datum
on $E$ relative to the fppf covering $\{F \to G\}$.
By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
this descent datum is effective.
By
Descent, Lemma \ref{descent-lemma-descent-data-sheaves}
again this implies that $H$ is a scheme.
By
Descent, Lemmas \ref{descent-lemma-descending-property-separated} and
\ref{descent-lemma-descending-property-quasi-finite}
it now follows that $b$ is separated and locally quasi-finite.
\end{proof}

\noindent
Here is the result that the section title refers to.

\begin{lemma}
\label{lemma-bootstrap-diagonal}
Let $S$ be a scheme.
Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Assume that
\begin{enumerate}
\item the presheaf $F$ is a sheaf,
\item there exists an algebraic space $X$ and a map $X \to F$
which is representable by algebraic spaces, surjective, flat and
locally of finite presentation.
\end{enumerate}
Then $\Delta_F$ is representable (by schemes).
\end{lemma}

\begin{proof}
Let $U \to X$ be a surjective \'etale morphism from a scheme towards $X$.
Then $U \to X$ is representable, surjective, flat and
locally of finite presentation by
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-etale-flat} and
\ref{spaces-morphisms-lemma-etale-locally-finite-presentation}.
By
Lemma \ref{lemma-composition-transformation-property}
the composition $U \to F$ is representable by algebraic spaces,
surjective, flat and locally of finite presentation also.
Thus we see that $R = U \times_F U$ is an algebraic space, see
Lemma \ref{lemma-representable-by-spaces}.
The morphism of algebraic spaces $R \to U \times_S U$ is
a monomorphism, hence separated (as the diagonal of a monomorphism
is an isomorphism, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-monomorphism}).
Since $U \to F$ is locally of finite presentation, both
morphisms $R \to U$ are locally of finite presentation, see
Lemma \ref{lemma-base-change-transformation-property}.
Hence $R \to U \times_S U$ is locally of finite type (use
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-finite-presentation-finite-type} and
\ref{spaces-morphisms-lemma-permanence-finite-type}).
Altogether this means that
$R \to U \times_S U$ is a monomorphism which is locally of finite
type, hence a separated and locally quasi-finite morphism, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-monomorphism-loc-finite-type-loc-quasi-finite}.

\medskip\noindent
Now we are ready to prove that $\Delta_F$ is representable.
Let $T$ be a scheme, and let $(a, b) : T \to F \times F$ be a morphism.
Set
$$
T' = (U \times_S U) \times_{F \times F} T.
$$
Note that $U \times_S U \to F \times F$ is
representable by algebraic spaces, surjective, flat and
locally of finite presentation by
Lemma \ref{lemma-product-transformations-property}.
Hence $T'$ is an algebraic space, and the projection morphism
$T' \to T$ is surjective, flat, and locally of finite presentation.
Consider $Z = T \times_{F \times F} F$ (this is a sheaf) and
$$
Z' = T' \times_{U \times_S U} R
= T' \times_T Z.
$$
We see that $Z'$ is an algebraic space, and
$Z' \to T'$ is separated and locally quasi-finite by the
discussion in the first paragraph of the proof which showed that $R$ is
an algebraic space and that the
morphism $R \to U \times_S U$ has those properties.
Hence we may apply
Lemma \ref{lemma-after-fppf-sep-lqf}
to the diagram
$$
\xymatrix{
Z' \ar[r] \ar[d] & T' \ar[d] \\
Z \ar[r] & T
}
$$
and we conclude.
\end{proof}

\noindent
Here is a variant of the result above.

\begin{lemma}
\label{lemma-bootstrap-locally-quasi-finite}
Let $S$ be a scheme. Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a
functor. Let $X$ be a scheme and let $X \to F$ be representable by algebraic
spaces and locally quasi-finite. Then $X \to F$ is representable
(by schemes).
\end{lemma}

\begin{proof}
Let $T$ be a scheme and let $T \to F$ be a morphism. We have to show that
the algebraic space $X \times_F T$ is representable by a scheme. Consider
the morphism
$$
X \times_F T  \longrightarrow X \times_{\Spec(\mathbf{Z})} T
$$
Since $X \times_F T \to T$ is locally quasi-finite, so is the displayed
arrow (Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-permanence-quasi-finite}).
On the other hand, the displayed arrow is a monomorphism
and hence separated (Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-monomorphism-separated}).
Thus $X \times_F T$ is a scheme by Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}.
\end{proof}











\section{Bootstrap}
\label{section-bootstrap}

\noindent
We warn the reader right away that the result of this section will
be superseded by the stronger
Theorem \ref{theorem-final-bootstrap}.
On the other hand, the theorem in this section is quite a bit easier to
prove and still provides quite a bit of insight into how things work,
especially for those readers mainly interested in Deligne-Mumford
stacks.

\medskip\noindent
In
Spaces, Section \ref{spaces-section-algebraic-spaces}
we defined an algebraic space as a sheaf in the fppf topology whose
diagonal is representable, and such that there exist a surjective \'etale
morphism from a scheme towards it. In this section we show that
a sheaf in the fppf topology whose diagonal is representable by algebraic
spaces and which has an \'etale surjective covering by an algebraic space
is also an algebraic space.
In other words, the category of algebraic spaces is an enlargement of the
category of schemes by those fppf sheaves $F$ which have a representable
diagonal and an \'etale covering by a scheme. The
result of this section says that doing the same process again starting with
the category of algebraic spaces, does not lead to yet another category.

\medskip\noindent
Another motivation for the material in this section is that it will guarantee
later that a Deligne-Mumford stack whose inertia stack is trivial is equivalent
to an algebraic space, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-algebraic-stack-no-automorphisms}.

\medskip\noindent
Here is the main result of this section (as we mentioned above this
will be superseded by the stronger
Theorem \ref{theorem-final-bootstrap}).

\begin{theorem}
\label{theorem-bootstrap}
Let $S$ be a scheme.
Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Assume that
\begin{enumerate}
\item the presheaf $F$ is a sheaf,
\item the diagonal morphism $F  \to F \times F$ is representable by
algebraic spaces, and
\item there exists an algebraic space $X$
and a map $X \to F$ which is surjective, and \'etale.
\end{enumerate}
Then $F$ is an algebraic space.
\end{theorem}

\begin{proof}
We will use the remarks directly below
Definition \ref{definition-property-transformation}
without further mention.
In the situation of the theorem, let $U \to X$ be a surjective \'etale morphism
from a scheme towards $X$.
By Lemma \ref{lemma-composition-transformation}
$U \to F$ is surjective and \'etale also.
Hence the theorem boils down to proving that
$\Delta_F$ is representable.
This follows immediately from
Lemma \ref{lemma-bootstrap-diagonal}.
On the other hand we can circumvent this lemma and show directly $F$
is an algebraic space as in the next paragraph.

\medskip\noindent
Let $U$ be a scheme, and let $U \to F$ be surjective and \'etale.
Set $R = U \times_F U$, which is an algebraic space (see
Lemma \ref{lemma-representable-diagonal}).
The morphism of algebraic spaces $R \to U \times_S U$ is a monomorphism,
hence separated (as the diagonal of a monomorphism is an isomorphism).
Moreover, since $U \to F$ is \'etale, we see that $R \to U$ is \'etale, by
Lemma \ref{lemma-base-change-transformation-property}.
In particular, we see that $R \to U$ is locally quasi-finite, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-locally-quasi-finite}.
We conclude that also $R \to U \times_S U$ is
locally quasi-finite by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-permanence-quasi-finite}.
Hence
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
applies and $R$ is a scheme. Hence $F = U/R$ is an algebraic
space according to
Spaces, Theorem \ref{spaces-theorem-presentation}.
\end{proof}









\section{Finding opens}
\label{section-finding-opens}


\medskip\noindent
First we prove a lemma which is a slight improvement and generalization of
Spaces, Lemma \ref{spaces-lemma-finding-opens}
to quotient sheaves associated to groupoids.

\begin{lemma}
\label{lemma-better-finding-opens}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism.
Assume
\begin{enumerate}
\item the composition
$$
\xymatrix{
U' \times_{g, U, t} R \ar[r]_-{\text{pr}_1} \ar@/^3ex/[rr]^h
& R \ar[r]_s & U
}
$$
has an open image $W \subset U$, and
\item the resulting map $h : U' \times_{g, U, t} R \to W$
defines a surjection of sheaves in the fppf topology.
\end{enumerate}
Let $R' = R|_{U'}$ be the restriction of $R$ to $U$. Then the map
of quotient sheaves
$$
U'/R' \to U/R
$$
in the fppf topology is representable, and is an open immersion.
\end{lemma}

\begin{proof}
Note that $W$ is an $R$-invariant open subscheme of $U$.
This is true because the set of points of $W$ is the set
of points of $U$ which are equivalent in the sense of
Groupoids,
Lemma \ref{groupoids-lemma-pre-equivalence-equivalence-relation-points}
to a point of $g(U') \subset U$ (the lemma applies as $j : R \to U \times_S U$
is a pre-equivalence relation by
Groupoids, Lemma \ref{groupoids-lemma-groupoid-pre-equivalence}).
Also $g : U' \to U$ factors through $W$.
Let $R|_W$ be the restriction of $R$ to $W$.
Then it follows that $R'$ is also the restriction of $R|_W$ to $U'$.
Hence we can factor the map of sheaves of the lemma as
$$
U'/R' \longrightarrow W/R|_W \longrightarrow U/R
$$
By Groupoids, Lemma \ref{groupoids-lemma-quotient-groupoid-restrict}
we see that the first arrow is an isomorphism of sheaves.
Hence it suffices to show the lemma in case $g$ is the immersion
of an $R$-invariant open into $U$.

\medskip\noindent
Assume $U' \subset U$ is an $R$-invariant open and $g$ is the inclusion
morphism. Set $F = U/R$ and $F' = U'/R'$. By
Groupoids,
Lemma \ref{groupoids-lemma-quotient-pre-equivalence-relation-restrict}
or \ref{groupoids-lemma-quotient-groupoid-restrict}
the map $F' \to F$ is injective. Let $\xi \in F(T)$.
We have to show that $T \times_{\xi, F} F'$ is representable
by an open subscheme of $T$.
There exists an fppf covering $\{f_i : T_i \to T\}$ such that
$\xi|_{T_i}$ is the image via $U \to U/R$ of a morphism $a_i : T_i \to U$.
Set $V_i = s_i^{-1}(U')$.
We claim that $V_i \times_T T_j = T_i \times_T V_j$ as open subschemes
of $T_i \times_T T_j$.

\medskip\noindent
As $a_i \circ \text{pr}_0$ and $a_j \circ \text{pr}_1$ are morphisms
$T_i \times_T T_j \to U$ which both map to the section
$\xi|_{T_i \times_T T_j} \in F(T_i \times_T T_j)$ we can find
an fppf covering $\{f_{ijk} : T_{ijk} \to T_i \times_T T_j\}$ and morphisms
$r_{ijk} : T_{ijk} \to R$ such that
$$
a_i \circ \text{pr}_0 \circ f_{ijk} = s \circ r_{ijk},
\quad
a_j \circ \text{pr}_1 \circ f_{ijk} = t \circ r_{ijk},
$$
see
Groupoids, Lemma \ref{groupoids-lemma-quotient-pre-equivalence}.
Since $U'$ is $R$-invariant we have $s^{-1}(U') = t^{-1}(U')$ and
hence $f_{ijk}^{-1}(V_i \times_T T_j) = f_{ijk}^{-1}(T_i \times_T V_j)$.
As $\{f_{ijk}\}$ is surjective this implies the claim above.
Hence by
Descent, Lemma \ref{descent-lemma-open-fpqc-covering}
there exists an open subscheme $V \subset T$ such that
$f_i^{-1}(V) = V_i$. We claim that $V$ represents $T \times_{\xi, F} F'$.

\medskip\noindent
As a first step, we will show that $\xi|_V$ lies in $F'(V) \subset F(V)$.
Namely, the family of morphisms $\{V_i \to V\}$ is an fppf covering,
and by construction we have $\xi|_{V_i} \in F'(V_i)$.
Hence by the sheaf property of $F'$ we get $\xi|_V \in F'(V)$.
Finally, let $T' \to T$ be a morphism of schemes and
that $\xi|_{T'} \in F'(T')$. To finish the proof we have to show that
$T' \to T$ factors through $V$.
We can find a fppf covering $\{T'_j \to T'\}_{j \in J}$ and morphisms
$b_j : T'_j \to U'$ such that $\xi|_{T'_j}$ is the image via
$U' \to U/R$ of $b_j$. Clearly, it is enough to show that the compositions
$T'_j \to T$ factor through $V$. Hence we may assume that $\xi|_{T'}$
is the image of a morphism $b : T' \to U'$. Now, it is enough to show
that $T'\times_T T_i \to T_i$ factors through $V_i$. Over the scheme
$T' \times_T T_i$ the restriction of $\xi$ is the image of two
elements of $(U/R)(T' \times_T T_i)$, namely $a_i \circ \text{pr}_1$, and
$b \circ \text{pr}_0$, the second of which factors through the $R$-invariant
open $U'$. Hence by
Groupoids, Lemma \ref{groupoids-lemma-quotient-pre-equivalence}
there exists a covering $\{h_k : Z_k \to T' \times_T T_i\}$ and morphisms
$r_k : Z_k \to R$ such that $a_i \circ \text{pr}_1 \circ h_k = s \circ r_k$
and $b \circ \text{pr}_0 \circ h_k = t \circ r_k$. As $U'$ is an $R$-invariant
open the fact that $b$ has image in $U'$ then implies that each
$a_i \circ \text{pr}_1 \circ h_k$ has image in $U'$. It follows from this
that $T' \times_T T_i \to T_i$ has image in $V_i$ by definition of $V_i$
which concludes the proof.
\end{proof}












\section{Slicing equivalence relations}
\label{section-slicing}

\noindent
In this section we explain how to ``improve'' a given equivalence
relation by slicing. This is not a kind of ``\'etale slicing'' that you
may be used to but a much coarser kind of slicing.


\begin{lemma}
\label{lemma-slice-equivalence-relation}
Let $S$ be a scheme.
Let $j : R \to U \times_S U$ be an equivalence relation on schemes over $S$.
Assume $s, t : R \to U$ are flat and locally of finite presentation.
Then there exists an equivalence relation $j' : R' \to U'\times_S U'$
on schemes over $S$, and an isomorphism
$$
U'/R' \longrightarrow U/R
$$
induced by a morphism $U' \to U$ which maps $R'$ into $R$ such that
$s', t' : R \to U$ are flat, locally of finite presentation
and locally quasi-finite.
\end{lemma}

\begin{proof}
We will prove this lemma in several steps. We will use without further
mention that an equivalence relation gives rise to a groupoid scheme
and that the restriction of an equivalence relation is an equivalence
relation, see
Groupoids, Lemmas
\ref{groupoids-lemma-restrict-relation},
\ref{groupoids-lemma-equivalence-groupoid}, and
\ref{groupoids-lemma-restrict-groupoid-relation}.

\medskip\noindent
Step 1: We may assume that $s, t : R \to U$ are locally of finite presentation
and Cohen-Macaulay morphisms. Namely, as in
More on Groupoids, Lemma \ref{more-groupoids-lemma-make-CM}
let $g : U' \to U$ be the open subscheme such that
$t^{-1}(U') \subset R$ is the maximal open over which $s : R \to U$ is
Cohen-Macaulay, and denote $R'$ the restriction of $R$ to $U'$.
By the lemma cited above we see that
$$
\xymatrix{
t^{-1}(U') \ar@{=}[r] &
U' \times_{g, U, t} R \ar[r]_-{\text{pr}_1} \ar@/^3ex/[rr]^h &
R \ar[r]_s &
U
}
$$
is surjective. Since $h$ is flat and locally of finite presentation, we
see that $\{h\}$ is a fppf covering. Hence by
Groupoids, Lemma \ref{groupoids-lemma-quotient-groupoid-restrict}
we see that $U'/R' \to U/R$ is an isomorphism. By the construction of $U'$
we see that $s', t'$ are Cohen-Macaulay and locally of finite presentation.

\medskip\noindent
Step 2. Assume $s, t$ are Cohen-Macaulay and locally of finite presentation.
Let $u \in U$ be a point of finite type. By
More on Groupoids, Lemma \ref{more-groupoids-lemma-max-slice-quasi-finite}
there exists an affine scheme $U'$ and a morphism $g : U' \to U$ such that
\begin{enumerate}
\item $g$ is an immersion,
\item $u \in U'$,
\item $g$ is locally of finite presentation,
\item $h$ is flat, locally of finite presentation and locally quasi-finite, and
\item the morphisms $s', t' : R' \to U'$ are flat, locally of finite
presentation and locally quasi-finite.
\end{enumerate}
Here we have used the notation introduced in
More on Groupoids, Situation \ref{more-groupoids-situation-slice}.

\medskip\noindent
Step 3. For each point $u \in U$ which is of finite type
choose a $g_u : U'_u \to U$ as in
Step 2 and denote $R'_u$ the restriction of $R$ to $U'_u$.
Denote $h_u = s \circ \text{pr}_1 : U'_u \times_{g_u, U, t} R \to U$. Set
$U' = \coprod_{u \in U} U'_u$, and $g = \coprod g_u$. Let $R'$ be the
restriction of $R$ to $U$ as above. We claim that
the pair $(U', g)$ works\footnote{Here we should check that $U'$ is not
too large, i.e., that it is isomorphic to an object of the category
$\Sch_{fppf}$, see
Section \ref{section-conventions}.
This is a purely set theoretical matter; let us use the notion of size of
a scheme introduced in
Sets, Section \ref{sets-section-categories-schemes}.
Note that each $U'_u$ has size at most the size of $U$
and that the cardinality of the index set is at most the cardinality of
$|U|$ which is bounded by the size of $U$. Hence $U'$ is isomorphic
to an object of $\Sch_{fppf}$ by
Sets, Lemma \ref{sets-lemma-what-is-in-it} part (6).}.
Note that
\begin{align*}
R' = &
\coprod\nolimits_{u_1, u_2 \in U}
(U'_{u_1} \times_{g_{u_1}, U, t} R)
\times_R
(R \times_{s, U, g_{u_2}} U'_{u_2}) \\
= &
\coprod\nolimits_{u_1, u_2 \in U}
(U'_{u_1} \times_{g_{u_1}, U, t} R) \times_{h_{u_1}, U, g_{u_2}} U'_{u_2}
\end{align*}
Hence the projection $s' : R' \to U' = \coprod U'_{u_2}$
is flat, locally of finite
presentation and locally quasi-finite as a base change of $\coprod h_{u_1}$.
Finally, by construction the morphism
$h : U' \times_{g, U, t} R \to U$ is equal to $\coprod h_u$ hence
its image contains all points of finite type of $U$.
Since each $h_u$ is flat and locally of finite presentation we conclude that
$h$ is flat and locally of finite presentation.
In particular, the image of $h$ is open (see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open})
and since the set of points of finite type is dense (see
Morphisms, Lemma \ref{morphisms-lemma-enough-finite-type-points})
we conclude that the image of $h$ is $U$. This implies that
$\{h\}$ is an fppf covering. By
Groupoids, Lemma \ref{groupoids-lemma-quotient-groupoid-restrict}
this means that $U'/R' \to U/R$ is an isomorphism.
This finishes the proof of the lemma.
\end{proof}










\section{Quotient by a subgroupoid}
\label{section-dividing}

\noindent
We need one more lemma before we can do our final bootstrap.
Let us discuss what is going on in terms of ``plain'' groupoids before
embarking on the scheme theoretic version.

\medskip\noindent
Let $\mathcal{C}$ be a groupoid, see
Categories, Definition \ref{categories-definition-groupoid}.
As discussed in
Groupoids, Section \ref{groupoids-section-groupoids}
this corresponds to a quintuple $(\text{Ob}, \text{Arrows}, s, t, c)$.
Suppose we are given a subset $P \subset \text{Arrows}$ such that
$(\text{Ob}, P, s|_P, t|_P, c|_P)$ is also a groupoid and such
that there are no nontrivial automorphisms in $P$. Then we can construct
the quotient groupoid
$(\overline{\text{Ob}}, \overline{\text{Arrows}}, \overline{s},
\overline{t}, \overline{c})$
as follows:
\begin{enumerate}
\item $\overline{\text{Ob}} = \text{Ob}/P$
is the set of $P$-isomorphism classes,
\item $\overline{\text{Arrows}} = P\backslash \text{Arrows}/P$
is the set of arrows in $\mathcal{C}$ up to pre-composing and
post-composing by arrows of $P$,
\item the source and target maps
$\overline{s}, \overline{t} : P\backslash \text{Arrows}/P \to \text{Ob}/P$
are induced by $s, t$,
\item composition is defined by the rule
$\overline{c}(\overline{a}, \overline{b}) = \overline{c(a, b)}$
which is well defined.
\end{enumerate}
In fact, it turns out that the original groupoid
$(\text{Ob}, \text{Arrows}, s, t, c)$ is canonically
isomorphic to the restriction (see discussion in
Groupoids, Section \ref{groupoids-section-restrict-groupoid})
of the groupoid
$(\overline{\text{Ob}}, \overline{\text{Arrows}}, \overline{s},
\overline{t}, \overline{c})$ via the quotient map
$g : \text{Ob} \to \overline{\text{Ob}}$. Recall that this means
that
$$
\text{Arrows} =
\text{Ob}
\times_{g, \overline{\text{Ob}}, \overline{t}}
\overline{\text{Arrows}}
\times_{\overline{s}, \overline{\text{Ob}}, g}
\text{Ob}
$$
which holds as $P$ has no nontrivial automorphisms.
We omit the details.

\medskip\noindent
The following lemma holds in much greater generality, but this is
the version we use in the proof of the final bootstrap (after which
we can more easily prove the more general versions of this lemma).

\begin{lemma}
\label{lemma-divide-subgroupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $P \to R$ be monomorphism of schemes. Assume that
\begin{enumerate}
\item $(U, P, s|_P, t|_P, c|_{P \times_{s, U, t}P})$ is a groupoid scheme,
\item $s|_P, t|_P : P \to U$ are finite locally free,
\item $j|_P : P \to U \times_S U$ is a monomorphism.
\item $U$ is affine, and
\item $j : R \to U \times_S U$ is separated and locally quasi-finite,
\end{enumerate}
Then $U/P$ is representable by an affine scheme $\overline{U}$, the
quotient morphism $U \to \overline{U}$ is finite locally free, and
$P = U \times_{\overline{U}} U$. Moreover, $R$ is the restriction of a
groupoid scheme
$(\overline{U}, \overline{R}, \overline{s}, \overline{t}, \overline{c})$
on $\overline{U}$ via the quotient morphism $U \to \overline{U}$.
\end{lemma}

\begin{proof}
Conditions (1), (2), (3), and (4) and
Groupoids, Proposition \ref{groupoids-proposition-finite-flat-equivalence}
imply the affine scheme $\overline{U}$ representing $U/P$ exists,
the morphism $U \to \overline{U}$ is finite locally free, and
$P = U \times_{\overline{U}} U$. The identification
$P = U \times_{\overline{U}} U$ is such that $t|_P = \text{pr}_0$ and
$s|_P = \text{pr}_1$, and such that composition is equal to
$\text{pr}_{02} : U \times_{\overline{U}} U \times_{\overline{U}} U
\to U \times_{\overline{U}} U$.
A product of finite locally free morphisms is finite locally free (see
Spaces, Lemma \ref{spaces-lemma-product-representable-transformations-property}
and
Morphisms, Lemmas \ref{morphisms-lemma-base-change-finite-locally-free} and
\ref{morphisms-lemma-composition-finite-locally-free}).
To get $\overline{R}$ we are going to descend
the scheme $R$ via the finite locally free morphism
$U \times_S U \to \overline{U} \times_S \overline{U}$.
Namely, note that
$$
(U \times_S U)
\times_{(\overline{U} \times_S \overline{U})}
(U \times_S U)
=
P \times_S P
$$
by the above. Thus giving a descent datum (see
Descent, Definition \ref{descent-definition-descent-datum})
for $R / U \times_S U / \overline{U} \times_S \overline{U}$
consists of an isomorphism
$$
\varphi :
R \times_{(U \times_S U), t \times t} (P \times_S P)
\longrightarrow
(P \times_S P) \times_{s \times s, (U \times_S U)} R
$$
over $P \times_S P$ satisfying a cocycle condition. We define $\varphi$
on $T$-valued points by the rule
$$
\varphi : (r, (p, p')) \longmapsto ((p, p'), p^{-1} \circ r \circ p')
$$
where the composition is taken in the groupoid category
$(U(T), R(T), s, t, c)$.
This makes sense because for $(r, (p, p'))$ to be a $T$-valued point
of the source of $\varphi$ it needs to be the case that $t(r) = t(p)$
and $s(r) = t(p')$. Note that this map is an isomorphism
with inverse given by
$((p, p'), r') \mapsto (p \circ r' \circ (p')^{-1}, (p, p'))$.
To check the cocycle condition we have to verify that
$\varphi_{02} = \varphi_{12} \circ \varphi_{01}$
as maps over
$$
(U \times_S U)
\times_{(\overline{U} \times_S \overline{U})} (U \times_S U)
\times_{(\overline{U} \times_S \overline{U})} (U \times_S U) =
(P \times_S P) \times_{s \times s, (U \times_S U), t \times t} (P \times_S P)
$$
By explicit calculation we see that
$$
\begin{matrix}
\varphi_{02} & (r, (p_1, p_1'), (p_2, p_2')) & \mapsto &
((p_1, p_1'), (p_2, p_2'),
(p_1 \circ p_2)^{-1} \circ r \circ (p_1' \circ p_2')) \\
\varphi_{01} & (r, (p_1, p_1'), (p_2, p_2')) & \mapsto &
((p_1, p_1'), p_1^{-1} \circ r \circ p_1', (p_2, p_2')) \\
\varphi_{12} & ((p_1, p_1'), r, (p_2, p_2')) & \mapsto &
((p_1, p_1'), (p_2, p_2'), p_2^{-1} \circ r \circ p_2')
\end{matrix}
$$
(with obvious notation) which implies what we want.
As $j$ is separated and locally quasi-finite by (5) we may apply
More on Morphisms, Lemma
\ref{more-morphisms-lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
to get a scheme $\overline{R} \to \overline{U} \times_S \overline{U}$
and an isomorphism
$$
R \to \overline{R} \times_{(\overline{U} \times_S \overline{U})} (U \times_S U)
$$
which identifies the descent datum $\varphi$ with the canonical
descent datum on
$\overline{R} \times_{(\overline{U} \times_S \overline{U})} (U \times_S U)$,
see
Descent, Definition \ref{descent-definition-effective}.

\medskip\noindent
Since $U \times_S U \to \overline{U} \times_S \overline{U}$ is finite
locally free we conclude that $R \to \overline{R}$ is finite locally free
as a base change. Hence $R \to \overline{R}$ is surjective as a map of
sheaves on $(\Sch/S)_{fppf}$.
Our choice of $\varphi$ implies that given $T$-valued points $r, r' \in R(T)$
these have the same image in $\overline{R}$ if and only if
$p^{-1} \circ r \circ p'$ for some $p, p' \in P(T)$. Thus
$\overline{R}$ represents the sheaf
$$
T \longmapsto  \overline{R(T)} = P(T)\backslash R(T)/P(T)
$$
with notation as in the discussion preceding the lemma.
Hence we can define the groupoid structure on
$(\overline{U} = U/P, \overline{R} = P\backslash R/P)$ exactly as in
the discussion of the ``plain'' groupoid case.
It follows from this that $(U, R, s, t, c)$ is the pullback of
this groupoid structure via the morphism $U \to \overline{U}$.
This concludes the proof.
\end{proof}















\section{Final bootstrap}
\label{section-final-bootstrap}

\noindent
The following result goes quite a bit beyond the earlier results.

\begin{theorem}
\label{theorem-final-bootstrap}
Let $S$ be a scheme.
Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Any one of the following conditions implies that $F$ is an algebraic space:
\begin{enumerate}
\item $F = U/R$ where $(U, R, s, t, c)$ is a groupoid in algebraic spaces
over $S$ such that $s, t$ are flat and locally of finite presentation, and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation,
\item $F = U/R$ where $(U, R, s, t, c)$ is a groupoid scheme
over $S$ such that $s, t$ are flat and locally of finite presentation, and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation,
\item $F$ is a sheaf and there exists an algebraic space $U$ and a morphism
$U \to F$ which is representable by algebraic spaces,
surjective, flat and locally of finite presentation,
\item $F$ is a sheaf and there exists a scheme $U$ and a morphism
$U \to F$ which is representable (by algebraic spaces or schemes),
surjective, flat and locally of finite presentation,
\item $F$ is a sheaf, $\Delta_F$ is representable by algebraic spaces,
and there exists an algebraic space $U$ and a morphism $U \to F$ which is
surjective, flat, and locally of finite presentation, or
\item $F$ is a sheaf, $\Delta_F$ is representable,
and there exists a scheme $U$ and a morphism $U \to F$ which is
surjective, flat, and locally of finite presentation.
\end{enumerate}
\end{theorem}

\begin{proof}
Trivial observations: (6) is a special case of (5) and
(4) is a special case of (3).
We first prove that cases (5) and (3) reduce to case (1).
Namely, by bootstrapping the diagonal
Lemma \ref{lemma-bootstrap-diagonal}
we see that (3) implies (5). In case (5) we set $R = U \times_F U$ which
is an algebraic space by assumption. Moreover, by assumption both
projections $s, t : R \to U$ are surjective, flat and locally of
finite presentation. The map $j : R \to U \times_S U$ is clearly an
equivalence relation. By
Lemma \ref{lemma-surjective-flat-locally-finite-presentation}
the map $U \to F$ is a surjection of sheaves. Thus $F = U/R$
which reduces us to case (1).

\medskip\noindent
Next, we show that (1) reduces to (2).
Namely, let $(U, R, s, t, c)$ be a groupoid in algebraic spaces
over $S$ such that $s, t$ are flat and locally of finite presentation, and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation.
Choose a scheme $U'$ and a surjective \'etale morphism $U' \to U$.
Let $R' = R|_{U'}$ be the restriction of $R$ to $U'$. By
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-pre-equivalence-relation-restrict}
we see that $U/R = U'/R'$. Since $s', t' : R' \to U'$ are also
flat and locally of finite presentation (see
More on Groupoids in Spaces,
Lemma \ref{spaces-more-groupoids-lemma-restrict-preserves-type})
this reduces us to the case where $U$ is a scheme.
As $j$ is an equivalence relation we see that $j$ is a monomorphism.
As $s : R \to U$ is locally of finite presentation we see that
$j : R \to U \times_S U$ is locally of finite type, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-permanence-finite-type}.
By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-monomorphism-loc-finite-type-loc-quasi-finite}
we see that $j$ is locally quasi-finite and separated.
Hence if $U$ is a scheme, then $R$ is a scheme by
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}.
Thus we reduce to proving the theorem in case (2).

\medskip\noindent
Assume $F = U/R$ where $(U, R, s, t, c)$ is a groupoid scheme
over $S$ such that $s, t$ are flat and locally of finite presentation, and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation. By
Lemma \ref{lemma-slice-equivalence-relation}
we reduce to that case where $s, t$ are flat,
locally of finite presentation, and locally quasi-finite.
Let $U = \bigcup_{i \in I} U_i$ be an affine open covering
(with index set $I$ of cardinality $\leq$ than the size of $U$ to avoid
set theoretic problems later -- most readers can safely ignore this remark).
Let $(U_i, R_i, s_i, t_i, c_i)$ be the restriction of $R$
to $U_i$. It is clear that $s_i, t_i$ are still flat, locally of finite
presentation, and locally quasi-finite as $R_i$ is the open subscheme
$s^{-1}(U_i) \cap t^{-1}(U_i)$ of $R$
and $s_i, t_i$ are the restrictions of $s, t$ to this open. By
Lemma \ref{lemma-better-finding-opens}
(or the simpler
Spaces, Lemma \ref{spaces-lemma-finding-opens})
the map $U_i/R_i \to U/R$ is representable by open immersions.
Hence if we can show that $F_i = U_i/R_i$ is an algebraic space, then
$\coprod_{i \in I} F_i$ is an algebraic space by
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}.
As $U = \bigcup U_i$ is an open covering it is clear that
$\coprod F_i \to F$ is surjective. Thus
it follows that $U/R$ is an algebraic space, by
Spaces, Lemma \ref{spaces-lemma-glueing-algebraic-spaces}.
In this way we reduce to the case where $U$ is affine and $s, t$ are flat,
locally of finite presentation, and locally quasi-finite and
$j$ is an equivalence.

\medskip\noindent
Assume $(U, R, s, t, c)$ is a groupoid scheme over $S$,
with $U$ affine, such that $s, t$ are flat, locally of finite presentation,
and locally quasi-finite, and $j$ is an equivalence relation.
Choose $u \in U$. We apply
More on Groupoids in Spaces,
Lemma \ref{spaces-more-groupoids-lemma-quasi-splitting-affine-scheme}
to $u \in U, R, s, t, c$. We obtain an affine scheme $U'$, an \'etale
morphism $g : U' \to U$, a point $u' \in U'$ with $\kappa(u) = \kappa(u')$
such that the restriction $R' = R|_{U'}$ is quasi-split over $u'$.
Note that the image $g(U')$ is open as $g$ is \'etale and contains $u'$.
Hence, repeatedly applying the lemma, we can find finitely many
points $u_i \in U$, $i = 1, \ldots, n$,
affine schemes $U'_i$, \'etale morphisms $g_i : U_i' \to U$, points
$u'_i \in U'_i$ with $g(u'_i) = u_i$ such that (a) each
restriction $R'_i$ is quasi-split over some point in $U'_i$ and
(b) $U = \bigcup_{i = 1, \ldots, n} g_i(U'_i)$.
Now we rerun the last part of the argument in the preceding paragraph:
Using
Lemma \ref{lemma-better-finding-opens}
(or the simpler
Spaces, Lemma \ref{spaces-lemma-finding-opens})
the map $U'_i/R'_i \to U/R$ is representable by open immersions.
If we can show that $F_i = U'_i/R'_i$ is an algebraic space, then
$\coprod_{i \in I} F_i$ is an algebraic space by
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}.
As $\{g_i : U'_i \to U\}$ is an \'etale covering
it is clear that $\coprod F_i \to F$ is surjective. Thus
it follows that $U/R$ is an algebraic space, by
Spaces, Lemma \ref{spaces-lemma-glueing-algebraic-spaces}.
In this way we reduce to the case where $U$ is affine and $s, t$ are flat,
locally of finite presentation, and locally quasi-finite,
$j$ is an equivalence, and $R$ is quasi-split over $u$ for some
$u \in U$.

\medskip\noindent
Assume $(U, R, s, t, c)$ is a groupoid scheme over $S$,
with $U$ affine, $u \in U$ such that $s, t$ are flat, locally
of finite presentation, and locally quasi-finite and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation
and $R$ is quasi-split over $u$. Let $P \subset R$ be a quasi-splitting
of $R$ over $u$. By
Lemma \ref{lemma-divide-subgroupoid}
we see that $(U, R, s, t, c)$ is the restriction of a groupoid
$(\overline{U}, \overline{R}, \overline{s}, \overline{t}, \overline{c})$
by a surjective finite locally free morphism $U \to \overline{U}$ such that
$P = U \times_{\overline{U}} U$.
Note that $s, t$ are the base changes of the morphisms
$\overline{s}, \overline{t}$ by $U \to \overline{U}$.
As $\{U \to \overline{U}\}$ is an fppf covering we conclude
$\overline{s}, \overline{t}$ are flat, locally of finite presentation, and
locally quasi-finite, see
Descent, Lemmas \ref{descent-lemma-descending-property-flat},
\ref{descent-lemma-descending-property-locally-finite-presentation}, and
\ref{descent-lemma-descending-property-quasi-finite}.
Consider the commutative diagram
$$
\xymatrix{
U \times_{\overline{U}} U \ar@{=}[r] \ar[rd] & P \ar[r] \ar[d] & R \ar[d] \\
& \overline{U} \ar[r]^{\overline{e}} & \overline{R}
}
$$
It is a general fact about restrictions that the outer four corners
form a cartesian diagram. By the equality we see the inner square is
cartesian. Since $P$ is open in $R$ (by definition of a quasi-splitting)
we conclude that $\overline{e}$ is an open immersion by
Descent, Lemma \ref{descent-lemma-descending-property-open-immersion}.
An application of
Groupoids,
Lemma \ref{groupoids-lemma-quotient-pre-equivalence-relation-restrict}
shows that $U/R = \overline{U}/\overline{R}$. Hence we have reduced to
the case where $(U, R, s, t, c)$ is a groupoid scheme over $S$,
with $U$ affine, $u \in U$ such that $s, t$ are flat, locally
of finite presentation, and locally quasi-finite and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation
and $e : U \to R$ is an open immersion!

\medskip\noindent
But of course, if $e$ is an open immersion and
$s, t$ are flat and locally of finite presentation
then the morphisms $t, s$ are \'etale.
For example you can see this by applying
More on Groupoids, Lemma \ref{more-groupoids-lemma-sheaf-differentials}
which shows that $\Omega_{R/U} = 0$ which in turn implies
that $s, t : R \to U$ is G-unramified (see
Morphisms, Lemma \ref{morphisms-lemma-unramified-omega-zero}),
which in turn implies that $s, t$ are \'etale (see
Morphisms, Lemma \ref{morphisms-lemma-flat-unramified-etale}).
And if $s, t$ are \'etale then finally $U/R$ is an algebraic
space by
Spaces, Theorem \ref{spaces-theorem-presentation}.
\end{proof}





\section{Applications}
\label{section-applications}

\noindent
As a first application we obtain the following fundamental fact:
$$
\fbox{A sheaf which is fppf locally an algebraic space is an algebraic space.}
$$
This is the content of the following lemma.
Note that assumption (2) is equivalent to the condition that
$F|_{(\Sch/S_i)_{fppf}}$ is an algebraic space, see
Spaces, Lemma \ref{spaces-lemma-rephrase}.
Assumption (3) is a set theoretic condition which may be ignored
by those not worried about set theoretic questions.

\begin{lemma}
\label{lemma-locally-algebraic-space}
\begin{slogan}
The definition of an algebraic space is fppf local.
\end{slogan}
Let $S$ be a scheme.
Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Let $\{S_i \to S\}_{i \in I}$ be a covering of $(\Sch/S)_{fppf}$.
Assume that
\begin{enumerate}
\item $F$ is a sheaf,
\item each $F_i = h_{S_i} \times F$ is an algebraic space, and
\item $\coprod_{i \in I} F_i$ is an algebraic space (see
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}).
\end{enumerate}
Then $F$ is an algebraic space.
\end{lemma}

\begin{proof}
Consider the morphism $\coprod F_i \to F$. This is the base change
of $\coprod S_i \to S$ via $F \to S$. Hence it is representable,
locally of finite presentation, flat and surjective by our definition
of an fppf covering and
Lemma \ref{lemma-base-change-transformation-property}.
Thus
Theorem \ref{theorem-final-bootstrap}
applies to show that $F$ is an algebraic space.
\end{proof}

\noindent
As a second application we obtain
$$
\fbox{Any fppf descent datum for algebraic spaces is effective.}
$$
This is the content of the following lemma.

\begin{lemma}
\label{lemma-descend-algebraic-space}
\begin{slogan}
Fppf descent data for algebraic spaces are effective.
\end{slogan}
Let $S$ be a scheme. Let $\{X_i \to X\}_{i \in I}$ be an fppf
covering of algebraic spaces over $S$. Assume $I$ is
countable\footnote{We can allow larger index sets here if
we can bound the size of the algebraic spaces which we are descending.
If we ever need this we will add a more precise statement here.}.
Then any descent datum for algebraic spaces relative to
$\{X_i \to X\}$ is effective.
\end{lemma}

\begin{proof}
By Descent on Spaces, Lemma \ref{spaces-descent-lemma-descent-data-sheaves}
this translates into the statement that an fppf sheaf $F$
endowed with a map $F \to X$ is an algebraic space provided that
each $F \times_X X_i$ is an algebraic space.
The restriction on the cardinality of $I$ implies that
coproducts of algebraic spaces indexed by $I$ are algebraic spaces, see
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}
and
Sets, Lemma \ref{sets-lemma-what-is-in-it}.
The morphism
$$
\coprod F \times_X X_i \longrightarrow F
$$
is representable by algebraic spaces (as the base change of
$\coprod X_i \to X$, see Lemma \ref{lemma-base-change-transformation}),
and surjective, flat, and locally of finite presentation
(as the base change of $\coprod X_i \to X$, see
Lemma \ref{lemma-base-change-transformation-property}).
Hence the lemma follows from Theorem \ref{theorem-final-bootstrap}.
\end{proof}

\noindent
Here is a different type of application.

\begin{lemma}
\label{lemma-representable-by-spaces-cover}
Let $S$ be a scheme. Let $a : F \to G$ and $b : G \to H$ be
transformations of functors $(\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Assume
\begin{enumerate}
\item $F, G, H$ are sheaves,
\item $a : F \to G$ is representable by algebraic spaces, flat,
locally of finite presentation, and surjective, and
\item $b \circ a : F \to H$ is representable by algebraic spaces.
\end{enumerate}
Then $b$ is representable by algebraic spaces.
\end{lemma}

\begin{proof}
Let $U$ be a scheme over $S$ and let $\xi \in H(U)$. We have to show that
$U \times_{\xi, H} G$ is an algebraic space. On the other hand, we know
that $U \times_{\xi, H} F$ is an algebraic space and that
$U \times_{\xi, H} F \to U \times_{\xi, H} G$ is representable by
algebraic spaces, flat, locally of finite presentation, and surjective
as a base change of the morphism $a$ (see
Lemma \ref{lemma-base-change-transformation-property}).
Thus the result follows from Theorem \ref{theorem-final-bootstrap}.
\end{proof}

\noindent
Here is a special case of Lemma \ref{lemma-locally-algebraic-space}
where we do not need to worry about set theoretical issues.

\begin{lemma}
\label{lemma-locally-algebraic-space-finite-type}
Let $S$ be a scheme.
Let $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Let $\{S_i \to S\}_{i \in I}$ be a covering of $(\Sch/S)_{fppf}$.
Assume that
\begin{enumerate}
\item $F$ is a sheaf,
\item each $F_i = h_{S_i} \times F$ is an algebraic space, and
\item the morphisms $F_i \to S_i$ are of finite type.
\end{enumerate}
Then $F$ is an algebraic space.
\end{lemma}

\begin{proof}
We will use
Lemma \ref{lemma-locally-algebraic-space}
above. To do this we will show that the assumption that
$F_i$ is of finite type over $S_i$ to prove that the set theoretic
condition in the lemma is satisfied (after perhaps refining the given
covering of $S$ a bit).
We suggest the reader skip the rest of the proof.

\medskip\noindent
If $S'_i \to S_i$ is a morphism of schemes then
$$
h_{S'_i} \times F =
h_{S'_i} \times_{h_{S_i}} h_{S_i} \times F =
h_{S'_i} \times_{h_{S_i}} F_i
$$
is an algebraic space of finite type over $S'_i$, see
Spaces, Lemma \ref{spaces-lemma-fibre-product-spaces}
and
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-base-change-finite-type}.
Thus we may refine the given covering. After doing this we may assume:
(a) each $S_i$ is affine, and (b) the cardinality of $I$ is at most
the cardinality of the set of points of $S$. (Since to cover
all of $S$ it is enough that each point is in the image of $S_i \to S$
for some $i$.)

\medskip\noindent
Since each $S_i$ is affine and each $F_i$ of finite type over $S_i$
we conclude that $F_i$ is quasi-compact. Hence by
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-quasi-compact-affine-cover}
we can find an affine $U_i \in \Ob((\Sch/S)_{fppf})$
and a surjective \'etale morphism $U_i \to F_i$. The fact that
$F_i \to S_i$ is locally of finite type then implies that
$U_i \to S_i$ is locally of finite type, and in particular
$U_i \to S$ is locally of finite type. By
Sets, Lemma \ref{sets-lemma-bound-finite-type}
we conclude that $\text{size}(U_i) \leq \text{size}(S)$.
Since also $|I| \leq \text{size}(S)$ we conclude that
$\coprod_{i \in I} U_i$ is isomorphic to an object of
$(\Sch/S)_{fppf}$ by
Sets, Lemma \ref{sets-lemma-bound-size}
and the construction of $\Sch$. This implies that
$\coprod F_i$ is an algebraic space by
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}
and we win.
\end{proof}

\begin{lemma}
\label{lemma-quotient-stack-isom}
Assume $B \to S$ and $(U, R, s, t, c)$ are as in
Groupoids in Spaces,
Definition \ref{spaces-groupoids-definition-quotient-stack} (1).
For any scheme $T$ over $S$ and objects $x, y$ of $[U/R]$ over $T$
the sheaf $\mathit{Isom}(x, y)$ on $(\Sch/T)_{fppf}$
is an algebraic space.
\end{lemma}

\begin{proof}
By
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-isom}
there exists an fppf covering $\{T_i \to T\}_{i \in I}$
such that $\mathit{Isom}(x, y)|_{(\Sch/T_i)_{fppf}}$
is an algebraic space for each $i$. By
Spaces, Lemma \ref{spaces-lemma-rephrase}
this means that each $F_i = h_{S_i} \times \mathit{Isom}(x, y)$
is an algebraic space.
Thus to prove the lemma we only have to verify the set theoretic condition
that $\coprod F_i$ is an algebraic space of
Lemma \ref{lemma-locally-algebraic-space}
above to conclude. To do this we use
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}
which requires showing that $I$ and the $F_i$ are not ``too large''.
We suggest the reader skip the rest of the proof.

\medskip\noindent
Choose $U' \in \Ob(\Sch/S)_{fppf}$ and a surjective
\'etale morphism $U' \to U$. Let $R'$ be the restriction of $R$ to $U'$.
Since $[U/R] = [U'/R']$ we may, after replacing $U$ by $U'$,
assume that $U$ is a scheme. (This step is here so that the
fibre products below are over a scheme.)

\medskip\noindent
Note that if we refine the covering $\{T_i \to T\}$ then it remains
true that each $F_i$ is an algebraic space.
Hence we may assume that each $T_i$ is affine. Since
$T_i \to T$ is locally of finite presentation, this then implies that
$\text{size}(T_i) \leq \text{size}(T)$, see
Sets, Lemma \ref{sets-lemma-bound-finite-type}.
We may also assume that the cardinality of the index set $I$ is at most the
cardinality of the set of points of $T$ since to get a
covering it suffices to check that each point of $T$ is in the image.
Hence $|I| \leq \text{size}(T)$.
Choose $W \in \Ob((\Sch/S)_{fppf})$
and a surjective \'etale morphism $W \to R$. Note that in the proof of
Groupoids in Spaces,
Lemma \ref{spaces-groupoids-lemma-quotient-stack-isom}
we showed that $F_i$ is representable by
$T_i \times_{(y_i, x_i), U \times_B U} R$ for some
$x_i, y_i : T_i \to U$. Hence now we see that
$V_i = T_i \times_{(y_i, x_i), U \times_B U} W$ is a
scheme which comes with an \'etale surjection $V_i \to F_i$.
By
Sets, Lemma \ref{sets-lemma-bound-size-fibre-product}
we see that
$$
\text{size}(V_i) \leq \max\{\text{size}(T_i), \text{size}(W)\}
\leq \max\{\text{size}(T), \text{size}(W)\}
$$
Hence, by
Sets, Lemma \ref{sets-lemma-bound-size}
we conclude that
$$
\text{size}(\coprod\nolimits_{i \in I} V_i)
\leq \max\{|I|, \text{size}(T), \text{size}(W)\}.
$$
Hence we conclude by our construction of $\Sch$
that $\coprod_{i \in I} V_i$ is isomorphic to an object
$V$ of $(\Sch/S)_{fppf}$. This verifies the
hypothesis of
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}
and we win.
\end{proof}

\begin{lemma}
\label{lemma-covering-quotient}
Let $S$ be a scheme. Consider an algebraic space $F$ of the form $F = U/R$
where $(U, R, s, t, c)$ is a groupoid in algebraic spaces
over $S$ such that $s, t$ are flat and locally of finite presentation, and
$j = (t, s) : R \to U \times_S U$ is an equivalence relation.
Then $U \to F$ is surjective, flat, and locally of finite presentation.
\end{lemma}

\begin{proof}
This is almost but not quite a triviality. Namely, by
Groupoids in Spaces, Lemma
\ref{spaces-groupoids-lemma-quotient-pre-equivalence}
and the fact that $j$ is a monomorphism we see that $R = U \times_F U$.
Choose a scheme $W$ and a surjective \'etale morphism $W \to F$.
As $U \to F$ is a surjection of sheaves we can find an fppf covering
$\{W_i \to W\}$ and maps $W_i \to U$ lifting the morphisms $W_i \to F$.
Then we see that
$$
W_i \times_F U = W_i \times_U U \times_F U = W_i \times_{U, t} R
$$
and the projection $W_i \times_F U \to W_i$ is the base change of
$t : R \to U$ hence flat and locally of finite presentation, see
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-flat} and
\ref{spaces-morphisms-lemma-base-change-finite-presentation}.
Hence by
Descent on Spaces, Lemmas
\ref{spaces-descent-lemma-descending-property-flat} and
\ref{spaces-descent-lemma-descending-property-locally-finite-presentation}
we see that $U \to F$ is flat and locally of finite presentation.
It is surjective by
Spaces, Remark \ref{spaces-remark-warning}.
\end{proof}

\begin{lemma}
\label{lemma-quotient-free-action}
Let $S$ be a scheme. Let $X \to B$ be a morphism of algebraic spaces over
$S$. Let $G$ be a group algebraic space over $B$ and let
$a : G \times_B X \to X$ be an action of $G$ on $X$ over $B$.
If
\begin{enumerate}
\item $a$ is a free action, and
\item $G \to B$ is flat and locally of finite presentation,
\end{enumerate}
then $X/G$ (see
Groupoids in Spaces, Definition
\ref{spaces-groupoids-definition-quotient-sheaf})
is an algebraic space and $X \to X/G$ is surjective, flat, and locally
of finite presentation.
\end{lemma}

\begin{proof}
The fact that $X/G$ is an algebraic space is immediate from
Theorem \ref{theorem-final-bootstrap}
and the definitions. Namely, $X/G = X/R$ where $R = G \times_B X$.
The morphisms $s, t : G \times_B X \to X$ are flat and locally of
finite presentation (clear for $s$ as a base change of $G \to B$ and
by symmetry using the inverse it follows for $t$) and the morphism
$j : G \times_B X \to X \times_B X$ is a monomorphism by
Groupoids in Spaces, Lemma \ref{spaces-groupoids-lemma-free-action}
as the action is free. The assertions about the morphism $X \to X/G$
follow from
Lemma \ref{lemma-covering-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-descent-torsor}
Let $\{S_i \to S\}_{i \in I}$ be a covering of $(\Sch/S)_{fppf}$.
Let $G$ be a group algebraic space over $S$, and denote
$G_i = G_{S_i}$ the base changes. Suppose given
\begin{enumerate}
\item for each $i \in I$ an fppf $G_i$-torsor $X_i$ over $S_i$,
and
\item for each $i, j \in I$ a $G_{S_i \times_S S_j}$-equivariant isomorphism
$\varphi_{ij} : X_i \times_S S_j \to S_i \times_S X_j$ satisfying the cocycle
condition over every $S_i \times_S S_j \times_S S_j$.
\end{enumerate}
Then there exists an fppf $G$-torsor $X$ over $S$
whose base change to $S_i$ is isomorphic to $X_i$ such that we
recover the descent datum $\varphi_{ij}$.
\end{lemma}

\begin{proof}
We may think of $X_i$ as a sheaf on $(\Sch/S_i)_{fppf}$, see
Spaces, Section \ref{spaces-section-change-base-scheme}.
By
Sites, Section \ref{sites-section-glueing-sheaves}
the descent datum $(X_i, \varphi_{ij})$ is effective in the sense that
there exists a unique sheaf $X$ on $(\Sch/S)_{fppf}$ which
recovers the algebraic spaces $X_i$ after restricting back to
$(\Sch/S_i)_{fppf}$. Hence we see that
$X_i = h_{S_i} \times X$. By
Lemma \ref{lemma-locally-algebraic-space}
we see that $X$ is an algebraic space, modulo verifying that $\coprod X_i$
is an algebraic space which we do at the end of the proof.
By the equivalence of categories in
Sites, Lemma \ref{sites-lemma-mapping-property-glue}
the action maps $G_i \times_{S_i} X_i \to X_i$
glue to give a map $a : G \times_S X \to X$.
Now we have to show that $a$ is an action and that $X$
is a pseudo-torsor, and fppf locally trivial (see
Groupoids in Spaces,
Definition \ref{spaces-groupoids-definition-principal-homogeneous-space}).
These may be checked fppf locally, and
hence follow from the corresponding properties of the actions
$G_i \times_{S_i} X_i \to X_i$. Hence the lemma is true.

\medskip\noindent
We suggest the reader skip the rest of the proof, which is purely set
theoretical. Pick coverings $\{S_{ij} \to S_j\}_{j \in J_i}$ of
$(\Sch/S)_{fppf}$
which trivialize the $G_i$ torsors $X_i$ (possible by assumption, and
Topologies, Lemma \ref{topologies-lemma-fppf-induced} part (1)).
Then $\{S_{ij} \to S\}_{i \in I, j \in J_i}$ is a covering of
$(\Sch/S)_{fppf}$ and hence we may assume that each $X_i$
is the trivial torsor! Of course we may also refine the covering further,
hence we may assume that each $S_i$ is affine and that the index
set $I$ has cardinality bounded by the cardinality of the set of points
of $S$. Choose $U \in \Ob((\Sch/S)_{fppf})$ and a surjective
\'etale morphism $U \to G$. Then we see that $U_i = U \times_S S_i$ comes
with an \'etale surjective morphism to $X_i \cong G_i$. By
Sets, Lemma \ref{sets-lemma-bound-size-fibre-product}
we see $\text{size}(U_i) \leq \max\{\text{size}(U), \text{size}(S_i)\}$. By
Sets, Lemma \ref{sets-lemma-bound-finite-type}
we have $\text{size}(S_i) \leq \text{size}(S)$.
Hence we see that
$\text{size}(U_i) \leq \max\{\text{size}(U), \text{size}(S)\}$
for all $i \in I$. Together with the bound on $|I|$ we found above we
conclude from
Sets, Lemma \ref{sets-lemma-bound-size}
that $\text{size}(\coprod U_i) \leq \max\{\text{size}(U), \text{size}(S)\}$.
Hence
Spaces, Lemma \ref{spaces-lemma-coproduct-algebraic-spaces}
applies to show that $\coprod X_i$ is an algebraic space which is
what we had to prove.
\end{proof}




\section{Algebraic spaces in the \'etale topology}
\label{section-spaces-etale}

\noindent
Let $S$ be a scheme. Instead of working with sheaves over
the big fppf site $(\Sch/S)_{fppf}$ we could work with sheaves
over the big \'etale site $(\Sch/S)_\etale$. All of the material in
Algebraic Spaces, Sections \ref{spaces-section-representable} and
\ref{spaces-section-representable-properties}
makes sense for sheaves over $(\Sch/S)_\etale$.
Thus we get a second notion of algebraic spaces by working in the
\'etale topology. This notion is (a priori) weaker then the notion introduced
in Algebraic Spaces, Definition \ref{spaces-definition-algebraic-space}
since a sheaf in the fppf topology is certainly a sheaf in the \'etale
topology. However, the notions are equivalent as is shown by the following
lemma.

\begin{lemma}
\label{lemma-spaces-etale}
Denote the common underlying category of $\Sch_{fppf}$ and $\Sch_\etale$ by
$\Sch_\alpha$ (see Topologies, Remark \ref{topologies-remark-choice-sites}).
Let $S$ be an object of $\Sch_\alpha$. Let
$$
F : (\Sch_\alpha/S)^{opp} \longrightarrow \textit{Sets}
$$
be a presheaf with the following properties:
\begin{enumerate}
\item $F$ is a sheaf for the \'etale topology,
\item the diagonal $\Delta : F \to F \times F$ is representable, and
\item there exists $U \in \Ob(\Sch_\alpha/S)$
and $U \to F$ which is surjective and \'etale.
\end{enumerate}
Then $F$ is an algebraic space in the sense of
Algebraic Spaces, Definition \ref{spaces-definition-algebraic-space}.
\end{lemma}

\begin{proof}
Note that properties (2) and (3) of the lemma and the corresponding
properties (2) and (3) of
Algebraic Spaces, Definition \ref{spaces-definition-algebraic-space}
are independent of the topology. This is true because these properties
involve only the notion of a fibre product of presheaves, maps of
presheaves, the notion of a representable transformation of functors,
and what it means for such a transformation to be surjective and \'etale.
Thus all we have to prove is that an \'etale sheaf $F$ with properties
(2) and (3) is also an fppf sheaf.

\medskip\noindent
To do this, let $R = U \times_F U$. By (2) the presheaf $R$ is representable
by a scheme and by (3) the projections $R \to U$ are \'etale. Thus
$j : R \to U \times_S U$ is an \'etale equivalence relation. Moreover
$U \to F$ identifies $F$ as the quotient of $U$ by $R$ for the
\'etale topology: (a) if $T \to F$ is a morphism, then $\{T \times_F U \to T\}$
is an \'etale covering, hence $U \to F$ is a surjection of sheaves for the
\'etale topology, (b) if $a, b : T \to U$ map to the same section of $F$,
then $(a, b) : T \to R$ hence $a$ and $b$ have the same image in the quotient
of $U$ by $R$ for the \'etale topology. Next, let $U/R$ denote the quotient
sheaf in the fppf topology which is an algebraic space by
Spaces, Theorem \ref{spaces-theorem-presentation}.
Thus we have morphisms (transformations of functors)
$$
U \to F \to U/R.
$$
By the aforementioned
Spaces, Theorem \ref{spaces-theorem-presentation}
the composition is representable, surjective, and \'etale. Hence for any
scheme $T$ and morphism $T \to U/R$ the fibre product $V = T \times_{U/R} U$
is a scheme surjective and \'etale over $T$. In other words, $\{V \to U\}$
is an \'etale covering. This proves that $U \to U/R$ is surjective as
a map of sheaves in the \'etale topology. It follows that
$F \to U/R$ is surjective as a map of sheaves in the \'etale topology.
On the other hand, the map $F \to U/R$ is injective (as a map of presheaves)
since $R = U \times_{U/R} U$ again by
Spaces, Theorem \ref{spaces-theorem-presentation}.
It follows that $F \to U/R$ is an isomorphism of \'etale sheaves, see
Sites, Lemma \ref{sites-lemma-mono-epi-sheaves}
which concludes the proof.
\end{proof}

\noindent
There is also an analogue of
Spaces, Lemma \ref{spaces-lemma-etale-locally-representable-gives-space}.

\begin{lemma}
\label{lemma-spaces-etale-locally-representable}
Denote the common underlying category of $\Sch_{fppf}$ and $\Sch_\etale$ by
$\Sch_\alpha$ (see Topologies, Remark \ref{topologies-remark-choice-sites}).
Let $S$ be an object of $\Sch_\alpha$. Let
$$
F : (\Sch_\alpha/S)^{opp} \longrightarrow \textit{Sets}
$$
be a presheaf with the following properties:
\begin{enumerate}
\item $F$ is a sheaf for the \'etale topology,
\item there exists an algebraic space $U$ over $S$
and a map $U \to F$ which is representable by
algebraic spaces, surjective, and \'etale.
\end{enumerate}
Then $F$ is an algebraic space in the sense of
Algebraic Spaces, Definition \ref{spaces-definition-algebraic-space}.
\end{lemma}

\begin{proof}
Set $R = U \times_F U$. This is an algebraic space as $U \to F$ is assumed
representable by algebraic spaces. The projections $s, t : R \to U$ are
\'etale morphisms of algebraic spaces as $U \to F$ is assumed \'etale.
The map $j = (t, s) : R \to U \times_S U$ is a monomorphism and an
equivalence relation as $R = U \times_F U$. By
Theorem \ref{theorem-final-bootstrap}
the fppf quotient sheaf $F' = U/R$ is an algebraic space.
The morphism $U \to F'$ is surjective, flat, and locally of finite
presentation by Lemma \ref{lemma-covering-quotient}.
The map $R \to U \times_{F'} U$ is surjective as a map of fppf
sheaves by Groupoids in Spaces, Lemma
\ref{spaces-groupoids-lemma-quotient-pre-equivalence}
and since $j$ is a monomorphism it is an isomorphism.
Hence the base change of $U \to F'$ by $U \to F'$ is \'etale,
and we conclude that $U \to F'$ is \'etale by
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-etale}.
Thus $U \to F'$ is surjective as a map of \'etale sheaves.
This means that $F'$ is equal to the quotient sheaf $U/R$
in the \'etale topology (small check omitted). Hence we obtain
a canonical factorization $U \to F' \to F$ and $F' \to F$ is an injective
map of sheaves. On the other hand, $U \to F$ is surjective as a map
of \'etale sheaves and hence so is $F' \to F$. This means that $F' = F$
and the proof is complete.
\end{proof}

\noindent
In fact, it suffices to have a smooth cover by a scheme and it suffices
to assume the diagonal is representable by algebraic spaces.

\begin{lemma}
\label{lemma-spaces-etale-smooth-cover}
Denote the common underlying category of $\Sch_{fppf}$
and $\Sch_\etale$ by $\Sch_\alpha$ (see
Topologies, Remark \ref{topologies-remark-choice-sites}). Let $S$ be an object
of $\Sch_\alpha$. 
$$
F : (\Sch_\alpha/S)^{opp} \longrightarrow \textit{Sets}
$$
be a presheaf with the following properties:
\begin{enumerate}
\item $F$ is a sheaf for the \'etale topology,
\item the diagonal $\Delta : F \to F \times F$ is representable
by algebraic spaces, and
\item there exists $U \in \Ob(\Sch_\alpha/S)$
and $U \to F$ which is surjective and smooth.
\end{enumerate}
Then $F$ is an algebraic space in the sense of
Algebraic Spaces, Definition \ref{spaces-definition-algebraic-space}.
\end{lemma}

\begin{proof}
The proof mirrors the proof of Lemma \ref{lemma-spaces-etale}. Let
$R = U \times_F U$. By (2) the presheaf $R$ is an algebraic space and by (3)
the projections $R \to U$ are smooth and surjective. Denote $(U, R, s, t, c)$
the groupoid associated to the equivalence relation $j : R \to U \times_S U$
(see Groupoids in Spaces, Lemma
\ref{spaces-groupoids-lemma-equivalence-groupoid}).
By Theorem \ref{theorem-final-bootstrap} we see that $X = U/R$ (quotient
in the fppf-topology) is an algebraic space. Using that the smooth
topology and the \'etale topology have the same sheaves (by
More on Morphisms, Lemma \ref{more-morphisms-lemma-etale-dominates-smooth})
we see the map $U \to F$ identifies $F$ as the quotient of
$U$ by $R$ for the smooth topology (details omitted).
Thus we have morphisms (transformations of functors)
$$
U \to F \to X.
$$
By Lemma \ref{lemma-covering-quotient} we see that $U \to X$ is
surjective, flat and locally of finite presentation. By
Groupoids in Spaces, Lemma
\ref{spaces-groupoids-lemma-quotient-pre-equivalence}
(and the fact that $j$ is a monomorphism) we have $R = U \times_X U$. By
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-smooth}
we conclude that $U \to X$ is smooth and surjective (as the projections
$R \to U$ are smooth and surjective and $\{U \to X\}$ is an fppf
covering). Hence for any scheme $T$ and morphism $T \to X$ the fibre product
$T \times_X U$ is an algebraic space surjective and smooth over $T$.
Choose a scheme $V$ and a surjective \'etale morphism $V \to T \times_X U$.
Then $\{V \to T\}$ is a smooth covering such that $V \to T \to X$
lifts to a morphism $V \to U$. This proves that
$U \to X$ is surjective as a map of sheaves in the smooth topology.
It follows that $F \to X$ is surjective as a map of sheaves in the smooth
topology. On the other hand, the map $F \to X$ is injective (as a map
of presheaves) since $R = U \times_X U$.
It follows that $F \to X$ is an isomorphism of smooth ($=$ \'etale)
sheaves, see Sites, Lemma \ref{sites-lemma-mono-epi-sheaves}
which concludes the proof.
\end{proof}






\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Brauer groups}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
A reference are the lectures by Serre in the Seminaire Cartan, see
\cite{Serre-Cartan}. Serre in turn refers to
\cite{Deuring} and \cite{ANT}. We changed some of the proofs, in particular
we used a fun argument of Rieffel to prove Wedderburn's theorem.
Very likely this change is not an improvement and we strongly
encourage the reader to read the original exposition by Serre.


\section{Noncommutative algebras}
\label{section-algebras}

\noindent
Let $k$ be a field. In this chapter an {\it algebra} $A$ over $k$ is
a possibly noncommutative ring $A$ together with a ring map
$k \to A$ such that $k$ maps into the center of $A$ and such that
$1$ maps to an identity element of $A$. An {\it $A$-module} is a right
$A$-module such that the identity of $A$ acts as the identity.

\begin{definition}
\label{definition-finite}
Let $A$ be a $k$-algebra. We say $A$ is {\it finite} if $\dim_k(A) < \infty$.
In this case we write $[A : k] = \dim_k(A)$.
\end{definition}

\begin{definition}
\label{definition-skew-field}
A {\it skew field} is a possibly noncommutative ring with an identity
element $1$, with $1 \not = 0$, in which every nonzero element
has a multiplicative inverse.
\end{definition}

\noindent
A skew field is a $k$-algebra for some $k$ (e.g., for the prime field
contained in it). We will use below that any module over a skew field
is free because a maximal linearly independent set of vectors forms a
basis and exists by Zorn's lemma.

\begin{definition}
\label{definition-simple}
Let $A$ be a $k$-algebra.
We say an $A$-module $M$ is {\it simple} if it is nonzero and
the only $A$-submodules are $0$ and $M$.
We say $A$ is {\it simple} if the only two-sided ideals of $A$ are
$0$ and $A$.
\end{definition}

\begin{definition}
\label{definition-central}
A $k$-algebra $A$ is {\it central} if the center of $A$ is the image of
$k \to A$.
\end{definition}

\begin{definition}
\label{definition-opposite}
Given a $k$-algebra $A$ we denote $A^{op}$ the $k$-algebra we get by
reversing the order of multiplication in $A$. This is called the
{\it opposite algebra}.
\end{definition}




\section{Wedderburn's theorem}
\label{section-wedderburn}

\noindent
The following cute argument can be found in a paper of Rieffel, see
\cite{Rieffel}. The proof could not be simpler (quote from
Carl Faith's review).

\begin{lemma}
\label{lemma-rieffel}
Let $A$ be a possibly noncommutative ring with $1$ which contains no
nontrivial two-sided ideal. Let $M$ be a nonzero right ideal in $A$,
and view $M$ as a right $A$-module. Then $A$ coincides with the
bicommutant of $M$.
\end{lemma}

\begin{proof}
Let $A' = \text{End}_A(M)$, and let $A'' = \text{End}_{A'}(M)$
(the bicommutant of $M$). Let $R : A \to A''$ be the natural homomorphism
$R(a)(m) = ma$. Then $R$ is injective, since $R(1) = \text{id}_M$
and $A$ contains no nontrivial two-sided ideal. We claim that $R(M)$
is a right ideal in $A''$. Namely, $R(m)a'' = R(ma'')$ for $a'' \in A''$
and $m$ in $M$, because {\it left} multiplication of $M$ by any element $n$
of $M$ represents an element of $A'$, and so
$(nm)a'' = n(ma'')$, that is, $(R(m)a'') (n) = R(ma'') (n)$ for all
$n$ in $M$. Finally, the product ideal $AM$ is a two-sided ideal, and so
$A = AM$. Thus $R(A) = R(A)R(M)$, so that $R(A)$ is a right ideal in $A''$.
But $R(A)$ contains the identity element of $A''$, and so $R(A) = A''$.
\end{proof}

\begin{lemma}
\label{lemma-simple-module}
Let $A$ be a $k$-algebra. If $A$ is finite, then
\begin{enumerate}
\item $A$ has a simple module,
\item any nonzero module contains a simple submodule,
\item a simple module over $A$ has finite dimension over $k$, and
\item if $M$ is a simple $A$-module, then $\text{End}_A(M)$ is a
skew field.
\end{enumerate}
\end{lemma}

\begin{proof}
Of course (1) follows from (2) since $A$ is a nonzero $A$-module.
For (2), any submodule of minimal (finite) dimension as a $k$-vector
space will be simple. There exists a finite dimensional one
because a cyclic submodule is one. If $M$ is simple, then
$mA \subset M$ is a sub-module, hence we see (3). Any nonzero element
of $\text{End}_A(M)$ is an isomorphism, hence (4) holds.
\end{proof}

\begin{theorem}
\label{theorem-wedderburn}
\begin{slogan}
Simple finite algebras over a field are matrix algebras over a skew field.
\end{slogan}
Let $A$ be a simple finite $k$-algebra. Then $A$ is a matrix algebra over
a finite $k$-algebra $K$ which is a skew field.
\end{theorem}

\begin{proof}
We may choose a simple submodule $M \subset A$ and then
the $k$-algebra $K = \text{End}_A(M)$ is a skew field, see
Lemma \ref{lemma-simple-module}.
By
Lemma \ref{lemma-rieffel}
we see that $A = \text{End}_K(M)$. Since $K$ is a skew field and
$M$ is finitely generated (since $\dim_k(M) < \infty$) we see that
$M$ is finite free as a left $K$-module. It follows immediately that
$A \cong \text{Mat}(n \times n, K^{op})$.
\end{proof}






\section{Lemmas on algebras}
\label{section-lemmas}

\noindent
Let $A$ be a $k$-algebra. Let $B \subset A$ be a subalgebra.
The {\it centralizer of $B$ in $A$} is the subalgebra
$$
C  = \{y \in A \mid xy = yx \text{ for all }x \in B\}.
$$
It is a $k$-algebra.

\begin{lemma}
\label{lemma-centralizer}
Let $A$, $A'$ be $k$-algebras. Let $B \subset A$, $B' \subset A'$ be
subalgebras with centralizers $C$, $C'$. Then the centralizer of
$B \otimes_k B'$ in $A \otimes_k A'$ is $C \otimes_k C'$.
\end{lemma}

\begin{proof}
Denote $C'' \subset A \otimes_k A'$ the centralizer of $B \otimes_k B'$.
It is clear that $C \otimes_k C' \subset C''$. Conversely, every element
of $C''$ commutes with $B \otimes 1$ hence is contained in $C \otimes_k A'$.
Similarly $C'' \subset A \otimes_k C'$. Thus
$C'' \subset C \otimes_k A' \cap A \otimes_k C' = C \otimes_k C'$.
\end{proof}

\begin{lemma}
\label{lemma-center-csa}
Let $A$ be a finite simple $k$-algebra. Then the center $k'$ of $A$
is a finite field extension of $k$.
\end{lemma}

\begin{proof}
Write $A = \text{Mat}(n \times n, K)$ for some skew field $K$ finite
over $k$, see
Theorem \ref{theorem-wedderburn}.
By
Lemma \ref{lemma-centralizer}
the center of $A$ is $k \otimes_k k'$ where $k' \subset K$ is the
center of $K$. Since the center of a skew field is a field, we win.
\end{proof}

\begin{lemma}
\label{lemma-generate-two-sided-sub}
Let $V$ be a $k$ vector space. Let $K$ be a central $k$-algebra
which is a skew field. Let $W \subset V \otimes_k K$ be a two-sided
$K$-sub vector space. Then $W$ is generated as a left $K$-vector
space by $W \cap (V \otimes 1)$.
\end{lemma}

\begin{proof}
Let $V' \subset V$ be the $k$-sub vector space generated by $v \in V$
such that $v \otimes 1 \in W$. Then $V' \otimes_k K \subset W$ and
we have
$$
W/(V' \otimes_k K)  \subset  (V/V') \otimes_k K.
$$
If $\overline{v} \in V/V'$ is a nonzero vector such that
$\overline{v} \otimes 1$ is contained in $W/V' \otimes_k K$,
then we see that $v \otimes 1 \in W$ where $v \in V$ lifts $\overline{v}$.
This contradicts our construction of $V'$. Hence we may replace
$V$ by $V/V'$ and $W$ by $W/V' \otimes_k K$ and it suffices to prove
that $W \cap (V \otimes 1)$ is nonzero if $W$ is nonzero.

\medskip\noindent
To see this let $w \in W$ be a nonzero element which can be written
as $w = \sum_{i = 1, \ldots, n} v_i \otimes k_i$ with $n$ minimal.
We may right multiply with $k_1^{-1}$ and assume that $k_1 = 1$.
If $n = 1$, then we win because $v_1 \otimes 1 \in W$.
If $n > 1$, then we see that for any $c \in K$
$$
c v - v c = \sum\nolimits_{i = 2, \ldots, n} v_i \otimes (c k_i - k_i c) \in W
$$
and hence $c k_i - k_i c = 0$ by minimality of $n$.
This implies that $k_i$ is in the center of $K$ which is $k$ by
assumption. Hence $v = (v_1 + \sum k_i v_i) \otimes 1$ contradicting
the minimality of $n$.
\end{proof}

\begin{lemma}
\label{lemma-generate-two-sided-ideal}
Let $A$ be a $k$-algebra. Let $K$ be a central $k$-algebra
which is a skew field. Then any two-sided ideal $I \subset A \otimes_k K$
is of the form $J \otimes_k K$ for some two-sided ideal $J \subset A$.
In particular, if $A$ is simple, then so is $A \otimes_k K$.
\end{lemma}

\begin{proof}
Set $J = \{a \in A \mid a \otimes 1 \in I\}$. This is a two-sided ideal
of $A$. And $I = J \otimes_k K$ by
Lemma \ref{lemma-generate-two-sided-sub}.
\end{proof}

\begin{lemma}
\label{lemma-matrix-algebras}
Let $R$ be a possibly noncommutative ring. Let $n \geq 1$ be an integer.
Let $R_n = \text{Mat}(n \times n, R)$.
\begin{enumerate}
\item The functors $M \mapsto M^{\oplus n}$ and
$N \mapsto Ne_{11}$ define quasi-inverse equivalences of categories
$\text{Mod}_R \leftrightarrow \text{Mod}_{R_n}$.
\item A two-sided ideal of $R_n$ is of the form $IR_n$ for some
two-sided ideal $I$ of $R$.
\item The center of $R_n$ is equal to the center of $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) proves itself. If $J \subset R_n$ is a two-sided ideal, then
$J = \bigoplus e_{ii}Je_{jj}$ and all of the summands $e_{ii}Je_{jj}$ are
equal to each other and are a two-sided ideal $I$ of $R$. This proves (2).
Part (3) is clear.
\end{proof}

\begin{lemma}
\label{lemma-simple-module-unique}
Let $A$ be a finite simple $k$-algebra.
\begin{enumerate}
\item There exists exactly one simple $A$-module $M$ up to isomorphism.
\item Any finite $A$-module is a direct sum of copies of a simple module.
\item Two finite $A$-modules are isomorphic if and only if they
have the same dimension over $k$.
\item If $A = \text{Mat}(n \times n, K)$ with $K$ a finite skew field
extension of $k$, then $M = K^{\oplus n}$ is a simple $A$-module and
$\text{End}_A(M) = K^{op}$.
\item If $M$ is a simple $A$-module, then $L = \text{End}_A(M)$
is a skew field finite over $k$ acting on the left on $M$, we have
$A = \text{End}_L(M)$, and the centers of $A$ and $L$ agree.
Also $[A : k] [L : k] = \dim_k(M)^2$.
\item For a finite $A$-module $N$ the algebra $B = \text{End}_A(N)$ is a
matrix algebra over the skew field $L$ of (5). Moreover $\text{End}_B(N) = A$.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Theorem \ref{theorem-wedderburn}
we can write $A = \text{Mat}(n \times n, K)$ for some finite skew
field extension $K$ of $k$. By
Lemma \ref{lemma-matrix-algebras}
the category of modules over $A$ is equivalent to the category of
modules over $K$. Thus (1), (2), and (3) hold
because every module over $K$ is free. Part (4) holds
because the equivalence transforms the $K$-module $K$
to $M = K^{\oplus n}$. Using $M = K^{\oplus n}$ in (5)
we see that $L = K^{op}$. The statement about the center of $L = K^{op}$
follows from
Lemma \ref{lemma-matrix-algebras}.
The statement about $\text{End}_L(M)$ follows from the explicit form
of $M$. The formula of dimensions is clear.
Part (6) follows as $N$ is isomorphic to a direct sum of
copies of a simple module.
\end{proof}

\begin{lemma}
\label{lemma-tensor-simple}
Let $A$, $A'$ be two simple $k$-algebras one of which is finite and central
over $k$. Then $A \otimes_k A'$ is simple.
\end{lemma}

\begin{proof}
Suppose that $A'$ is finite and central over $k$.
Write $A' = \text{Mat}(n \times n, K')$, see
Theorem \ref{theorem-wedderburn}.
Then the center of $K'$ is $k$ and we conclude that
$A \otimes_k K'$ is simple by
Lemma \ref{lemma-generate-two-sided-ideal}.
Hence $A \otimes_k A' = \text{Mat}(n \times n, A \otimes_k K')$ is simple
by Lemma \ref{lemma-matrix-algebras}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-central-simple}
The tensor product of finite central simple algebras over $k$ is finite,
central, and simple.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-centralizer} and \ref{lemma-tensor-simple}.
\end{proof}

\begin{lemma}
\label{lemma-base-change}
Let $A$ be a finite central simple algebra over $k$.
Let $k \subset k'$ be a field extension. Then $A' = A \otimes_k k'$ is
a finite central simple algebra over $k'$.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-centralizer} and \ref{lemma-tensor-simple}.
\end{proof}

\begin{lemma}
\label{lemma-inverse}
Let $A$ be a finite central simple algebra over $k$.
Then $A \otimes_k A^{op} \cong \text{Mat}(n \times n, k)$
where $n = [A : k]$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-tensor-central-simple} the algebra $A \otimes_k A^{op}$
is simple. Hence the map
$$
A \otimes_k A^{op} \longrightarrow \text{End}_k(A),\quad
a \otimes a' \longmapsto (x \mapsto axa')
$$
is injective. Since both sides of the arrow have the same dimension
we win.
\end{proof}





\section{The Brauer group of a field}
\label{section-brauer}

\noindent
Let $k$ be a field. Consider two finite central simple algebras
$A$ and $B$ over $k$. We say $A$ and $B$ are {\it similar} if there
exist $n, m > 0$ such that
$\text{Mat}(n \times n, A) \cong \text{Mat}(m \times m, B)$
as $k$-algebras.

\begin{lemma}
\label{lemma-similar}
Similarity.
\begin{enumerate}
\item Similarity defines an equivalence relation on the set of isomorphism
classes of finite central simple algebras over $k$.
\item Every similarity class contains a unique (up to isomorphism)
finite central skew field extension of $k$.
\item If $A = \text{Mat}(n \times n, K)$ and $B = \text{Mat}(m \times m, K')$
for some finite central skew fields $K$, $K'$ over $k$
then $A$ and $B$ are similar if and only if $K \cong K'$ as $k$-algebras.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that by Wedderburn's theorem (Theorem \ref{theorem-wedderburn})
we can always write a finite central simple algebra as a matrix
algebra over a finite central skew field. Hence it suffices to prove
the third assertion. To see this it suffices to show that if
$A = \text{Mat}(n \times n, K) \cong \text{Mat}(m \times m, K') = B$
then $K \cong K'$. To see this note that for a simple module $M$ of $A$
we have $\text{End}_A(M) = K^{op}$, see
Lemma \ref{lemma-simple-module-unique}.
Hence $A \cong B$ implies $K^{op} \cong (K')^{op}$ and we win.
\end{proof}

\noindent
Given two finite central simple $k$-algebras $A$, $B$ the tensor
product $A \otimes_k B$ is another, see
Lemma \ref{lemma-tensor-central-simple}.
Moreover if $A$ is similar to $A'$, then $A \otimes_k B$ is similar
to $A' \otimes_k B$ because tensor products and taking matrix
algebras commute. Hence tensor product defines an operation on
equivalence classes of finite central simple algebras which is clearly
associative and commutative. Finally,
Lemma \ref{lemma-inverse}
shows that $A \otimes_k A^{op}$ is isomorphic to a matrix algebra, i.e.,
that $A \otimes_k A^{op}$ is in the similarity class of $k$.
Thus we obtain an abelian group.

\begin{definition}
\label{definition-brauer-group}
Let $k$ be a field. The {\it Brauer group} of $k$ is the abelian group
of similarity classes of finite central simple $k$-algebras defined
above. Notation $\text{Br}(k)$.
\end{definition}

\noindent
For any map of fields $k \to k'$ we obtain a group homomorphism
$$
\text{Br}(k) \longrightarrow \text{Br}(k'),\quad
A \longmapsto A \otimes_k k'
$$
see Lemma \ref{lemma-base-change}. In other words, $\text{Br}(-)$ is
a functor from the category of fields to the category of abelian groups.
Observe that the Brauer group
of a field is zero if and only if every finite central skew field
extension $k \subset K$ is trivial.

\begin{lemma}
\label{lemma-brauer-algebraically-closed}
The Brauer group of an algebraically closed field is zero.
\end{lemma}

\begin{proof}
Let $k \subset K$ be a finite central skew field extension.
For any element $x \in K$ the subring $k[x] \subset K$ is a
commutative finite integral $k$-sub algebra, hence a field, see
Algebra, Lemma \ref{algebra-lemma-integral-over-field}.
Since $k$ is algebraically closed we conclude that
$k[x] = k$. Since $x$ was arbitrary we conclude $k = K$.
\end{proof}

\begin{lemma}
\label{lemma-dimension-square}
Let $A$ be a finite central simple algebra over a field $k$.
Then $[A : k]$ is a square.
\end{lemma}

\begin{proof}
This is true because $A \otimes_k \overline{k}$ is a matrix
algebra over $\overline{k}$ by
Lemma \ref{lemma-brauer-algebraically-closed}.
\end{proof}




\section{Skolem-Noether}
\label{section-skolem-noether}



\begin{theorem}
\label{theorem-skolem-noether}
Let $A$ be a finite central simple $k$-algebra. Let $B$ be a simple
$k$-algebra. Let $f, g : B \to A$ be two $k$-algebra homomorphisms.
Then there exists an invertible element $x \in A$ such that
$f(b) = xg(b)x^{-1}$ for all $b \in B$.
\end{theorem}

\begin{proof}
Choose a simple $A$-module $M$. Set $L = \text{End}_A(M)$.
Then $L$ is a skew field with center $k$ which acts on the left on $M$, see
Lemmas \ref{lemma-simple-module} and \ref{lemma-simple-module-unique}.
Then $M$ has two $B \otimes_k L^{op}$-module structures defined by
$m \cdot_1 (b \otimes l) = lmf(b)$ and $m \cdot_2 (b \otimes l) = lmg(b)$.
The $k$-algebra $B \otimes_k L^{op}$ is simple by
Lemma \ref{lemma-tensor-simple}. Since $B$ is simple, the existence of a
$k$-algebra homomorphism $B \to A$ implies that $B$ is finite. Thus
$B \otimes_k L^{op}$ is finite simple and we conclude the two
$B \otimes_k L^{op}$-module structures on $M$
are isomorphic by Lemma \ref{lemma-simple-module-unique}.
Hence we find $\varphi : M \to M$ intertwining these operations.
In particular $\varphi$ is in the commutant of $L$ which implies that
$\varphi$ is multiplication by some $x \in A$, see
Lemma \ref{lemma-simple-module-unique}. Working out the definitions we see
that $x$ is a solution to our problem.
\end{proof}

\begin{lemma}
\label{lemma-automorphism-inner}
Let $A$ be a finite simple $k$-algebra. Any automorphism of $A$ is
inner. In particular, any automorphism of $\text{Mat}(n \times n, k)$
is inner.
\end{lemma}

\begin{proof}
Note that $A$ is a finite central simple algebra over the center
of $A$ which is a finite field extension of $k$, see
Lemma \ref{lemma-center-csa}.
Hence the Skolem-Noether theorem (Theorem \ref{theorem-skolem-noether})
applies.
\end{proof}



\section{The centralizer theorem}
\label{section-centralizer}


\begin{theorem}
\label{theorem-centralizer}
Let $A$ be a finite central simple algebra over $k$, and let
$B$ be a simple subalgebra of $A$. Then
\begin{enumerate}
\item the centralizer $C$ of $B$ in $A$ is simple,
\item $[A : k] = [B : k][C : k]$, and
\item the centralizer of $C$ in $A$ is $B$.
\end{enumerate}
\end{theorem}

\begin{proof}
Throughout this proof we use the results of
Lemma \ref{lemma-simple-module-unique} freely.
Choose a simple $A$-module $M$. Set $L = \text{End}_A(M)$.
Then $L$ is a skew field with center $k$ which acts on the left on $M$
and $A = \text{End}_L(M)$.
Then $M$ is a right $B \otimes_k L^{op}$-module and
$C = \text{End}_{B \otimes_k L^{op}}(M)$.
Since the algebra $B \otimes_k L^{op}$ is simple by
Lemma \ref{lemma-tensor-simple} we see that $C$ is simple (by
Lemma \ref{lemma-simple-module-unique} again).

\medskip\noindent
Write $B \otimes_k L^{op} = \text{Mat}(m \times m, K)$ for some
skew field $K$ finite over $k$. Then $C = \text{Mat}(n \times n, K^{op})$
if $M$ is isomorphic to a direct sum of $n$ copies of the simple
$B \otimes_k L^{op}$-module $K^{\oplus m}$ (the lemma again). Thus we have
$\dim_k(M) = nm [K : k]$, $[B : k] [L : k] = m^2 [K : k]$,
$[C : k] = n^2 [K : k]$, and $[A : k] [L : k] = \dim_k(M)^2$ (by
the lemma again). We conclude that (2) holds.

\medskip\noindent
Part (3) follows because of (2) applied to $C \subset A$ shows
that $[B : k] = [C' : k]$ where $C'$ is the centralizer of $C$ in $A$
(and the obvious fact that $B \subset C')$.
\end{proof}

\begin{lemma}
\label{lemma-when-tensor-is-equal}
Let $A$ be a finite central simple algebra over $k$, and let
$B$ be a simple subalgebra of $A$. If $B$ is a central
$k$-algebra, then $A = B \otimes_k C$ where $C$ is the (central simple)
centralizer of $B$ in $A$.
\end{lemma}

\begin{proof}
We have $\dim_k(A) = \dim_k(B \otimes_k C)$ by
Theorem \ref{theorem-centralizer}. By
Lemma \ref{lemma-tensor-simple}
the tensor product is simple. Hence the natural map
$B \otimes_k C \to A$ is injective hence an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-self-centralizing-subfield}
Let $A$ be a finite central simple algebra over $k$.
If $K \subset A$ is a subfield, then the following are equivalent
\begin{enumerate}
\item $[A : k] = [K : k]^2$,
\item $K$ is its own centralizer, and
\item $K$ is a maximal commutative subring.
\end{enumerate}
\end{lemma}

\begin{proof}
Theorem \ref{theorem-centralizer}
shows that (1) and (2) are equivalent.
It is clear that (3) and (2) are equivalent.
\end{proof}

\begin{lemma}
\label{lemma-maximal-subfield}
Let $A$ be a finite central skew field over $k$.
Then every maximal subfield $K \subset A$ satisfies
$[A : k] = [K : k]^2$.
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-self-centralizing-subfield}.
\end{proof}





\section{Splitting fields}
\label{section-splitting}


\begin{definition}
\label{definition-splitting}
Let $A$ be a finite central simple $k$-algebra.
We say a field extension $k \subset k'$ {\it splits} $A$, or
$k'$ is a {\it splitting field} for $A$ if $A \otimes_k k'$ is
a matrix algebra over $k'$.
\end{definition}

\noindent
Another way to say this is that the class of $A$ maps to zero
under the map $\text{Br}(k) \to \text{Br}(k')$.

\begin{theorem}
\label{theorem-splitting}
Let $A$ be a finite central simple $k$-algebra.
Let $k \subset k'$ be a finite field extension.
The following are equivalent
\begin{enumerate}
\item $k'$ splits $A$, and
\item there exists a finite central simple algebra $B$ similar to $A$
such that $k' \subset B$ and $[B : k] = [k' : k]^2$.
\end{enumerate}
\end{theorem}

\begin{proof}
Assume (2). It suffices to show that $B \otimes_k k'$ is a matrix
algebra. We know that $B \otimes_k B^{op} \cong \text{End}_k(B)$.
Since $k'$ is the centralizer of $k'$ in $B^{op}$ by
Lemma \ref{lemma-self-centralizing-subfield}
we see that $B \otimes_k k'$ is the centralizer of $k \otimes k'$
in $B \otimes_k B^{op} = \text{End}_k(B)$. Of course this centralizer
is just $\text{End}_{k'}(B)$ where we view $B$ as a $k'$ vector space
via the embedding $k' \to B$. Thus the result.

\medskip\noindent
Assume (1). This means that we have an isomorphism
$A \otimes_k k' \cong \text{End}_{k'}(V)$ for some $k'$-vector space $V$.
Let $B$ be the commutant of $A$ in $\text{End}_k(V)$. Note that
$k'$ sits in $B$. By
Lemma \ref{lemma-when-tensor-is-equal}
the classes of $A$ and $B$ add up to zero in $\text{Br}(k)$.
From the dimension formula in
Theorem \ref{theorem-centralizer}
we see that
$$
[B : k] [A : k] =
\dim_k(V)^2 =
[k' : k]^2 \dim_{k'}(V)^2 =
[k' : k]^2 [A : k].
$$
Hence $[B : k] = [k' : k]^2$. Thus we have proved the result for the
opposite to the Brauer class of $A$. However, $k'$ splits the Brauer
class of $A$ if and only if it splits
the Brauer class of the opposite algebra, so we win anyway.
\end{proof}

\begin{lemma}
\label{lemma-maximal-subfield-splits}
A maximal subfield of a finite central skew field $K$ over $k$ is
a splitting field for $K$.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-maximal-subfield} with
Theorem \ref{theorem-splitting}.
\end{proof}

\begin{lemma}
\label{lemma-splitting-field-degree}
Consider a finite central skew field $K$ over $k$. Let $d^2 = [K : k]$.
For any finite splitting field $k'$ for $K$ the degree $[k' : k]$ is
divisible by $d$.
\end{lemma}

\begin{proof}
By Theorem \ref{theorem-splitting} there exists a finite central
simple algebra $B$ in the Brauer class of $K$ such that
$[B : k] = [k' : k]^2$. By
Lemma \ref{lemma-similar}
we see that $B = \text{Mat}(n \times n, K)$ for some $n$.
Then $[k' : k]^2 = n^2d^2$ whence the result.
\end{proof}

\begin{proposition}
\label{proposition-separable-splitting-field}
Consider a finite central skew field $K$ over $k$.
There exists a maximal subfield $k \subset k' \subset K$ which
is separable over $k$.
In particular, every Brauer class has a finite separable
spitting field.
\end{proposition}

\begin{proof}
Since every Brauer class is represented by a finite central skew
field over $k$, we see that the second statement follows from the
first by
Lemma \ref{lemma-maximal-subfield-splits}.

\medskip\noindent
To prove the first statement, suppose that we are given a separable
subfield $k' \subset K$. Then the centralizer $K'$ of $k'$ in $K$
has center $k'$, and the problem reduces to finding a maximal
subfield of $K'$ separable over $k'$. Thus it suffices to prove, if
$k \not = K$, that we can find an element $x \in K$, $x \not \in k$
which is separable over $k$. This statement is clear in characteristic
zero. Hence we may assume that $k$ has characteristic $p > 0$. If the
ground field $k$ is finite then, the result is clear as well (because
extensions of finite fields are always separable). Thus we may assume
that $k$ is an infinite field of positive characteristic.

\medskip\noindent
To get a contradiction assume no element of $K$ is separable over $k$.
By the discussion in
Fields, Section \ref{fields-section-algebraic}
this means the minimal polynomial of any $x \in K$ is of the form
$T^q - a$ where $q$ is a power of $p$ and $a \in k$. Since it is
clear that every element of $K$ has a minimal polynomial of degree
$\leq \dim_k(K)$ we conclude that there exists a fixed $p$-power
$q$ such that $x^q \in k$ for all $x \in K$.

\medskip\noindent
Consider the map
$$
(-)^q : K \longrightarrow K
$$
and write it out in terms of a $k$-basis $\{a_1, \ldots, a_n\}$ of $K$
with $a_1 = 1$. So
$$
(\sum x_i a_i)^q = \sum f_i(x_1, \ldots, x_n)a_i.
$$
Since multiplication on $A$ is $k$-bilinear we see that each $f_i$
is a polynomial in $x_1, \ldots, x_n$ (details omitted).
The choice of $q$ above and the fact that $k$ is infinite shows that
$f_i$ is identically zero for $i \geq 2$. Hence we see that it remains
zero on extending $k$ to its algebraic closure $\overline{k}$. But the
algebra $A \otimes_k \overline{k}$ is a matrix algebra, which implies
there are some elements whose $q$th power is not central (e.g., $e_{11}$).
This is the desired contradiction.
\end{proof}

\noindent
The results above allow us to characterize finite central simple algebras
as follows.

\begin{lemma}
\label{lemma-finite-central-simple-algebra}
Let $k$ be a field. For a $k$-algebra $A$ the following are equivalent
\begin{enumerate}
\item $A$ is finite central simple $k$-algebra,
\item $A$ is a finite dimensional $k$-vector space, $k$ is the center of $A$,
and $A$ has no nontrivial two-sided ideal,
\item there exists $d \geq 1$ such that
$A \otimes_k \bar k \cong \text{Mat}(d \times d, \bar k)$,
\item there exists $d \geq 1$ such that
$A \otimes_k k^{sep} \cong \text{Mat}(d \times d, k^{sep})$,
\item there exist $d \geq 1$ and a finite Galois extension $k \subset k'$
such that
$A \otimes_k k' \cong \text{Mat}(d \times d, k')$,
\item there exist $n \geq 1$ and a finite central skew field $K$
over $k$ such that $A \cong \text{Mat}(n \times n, K)$.
\end{enumerate}
The integer $d$ is called the {\it degree} of $A$.
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is a consequence of the definitions, see
Section \ref{section-algebras}.
Assume (1). By
Proposition \ref{proposition-separable-splitting-field}
there exists a separable splitting field $k \subset k'$ for $A$.
Of course, then a Galois closure of $k'/k$ is a splitting field also.
Thus we see that (1) implies (5). It is clear that (5) $\Rightarrow$ (4)
$\Rightarrow$ (3). Assume (3). Then $A \otimes_k \overline{k}$
is a finite central simple $\overline{k}$-algebra for example by
Lemma \ref{lemma-matrix-algebras}.
This trivially implies that $A$ is a finite central simple $k$-algebra.
Finally, the equivalence of (1) and (6) is Wedderburn's theorem, see
Theorem \ref{theorem-wedderburn}.
\end{proof}










\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}


% OK, start here.
%
\begin{document}

\title{Categories}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
Categories were first introduced in \cite{GenEqui}.
The category of categories (which is a proper class)
is a $2$-category. Similarly, the category of stacks
forms a $2$-category. If you already know
about categories, but not about $2$-categories you
should read
Section \ref{section-formal-cat-cat}
as an introduction to the formal definitions later on.

\section{Definitions}
\label{section-definition-categories}

\noindent
We recall the definitions, partly to fix notation.

\begin{definition}
\label{definition-category}
A {\it category} $\mathcal{C}$ consists of the following data:
\begin{enumerate}
\item A set of objects $\Ob(\mathcal{C})$.
\item For each pair $x, y \in \Ob(\mathcal{C})$ a set of morphisms
$\Mor_\mathcal{C}(x, y)$.
\item For each triple $x, y, z\in \Ob(\mathcal{C})$ a composition
map $ \Mor_\mathcal{C}(y, z) \times \Mor_\mathcal{C}(x, y)
\to \Mor_\mathcal{C}(x, z) $, denoted $(\phi, \psi) \mapsto
\phi \circ \psi$.
\end{enumerate}
These data are to satisfy the following rules:
\begin{enumerate}
\item For every element $x\in \Ob(\mathcal{C})$ there exists a
morphism $\text{id}_x\in \Mor_\mathcal{C}(x, x)$ such that
$\text{id}_x \circ \phi = \phi$ and $\psi \circ \text{id}_x = \psi $ whenever
these compositions make sense.
\item Composition is associative, i.e., $(\phi \circ \psi) \circ \chi =
\phi \circ ( \psi \circ \chi)$ whenever these compositions make sense.
\end{enumerate}
\end{definition}

\noindent
It is customary to require all the morphism sets
$\Mor_\mathcal{C}(x, y)$ to be disjoint.
In this way a morphism $\phi : x \to y$ has a unique {\it source} $x$
and a unique {\it target} $y$. This is not strictly necessary,
although care has to be taken in formulating condition (2) above
if it is not the case. It is convenient and we will often assume
this is the case. In this case we say that $\phi$ and $\psi$ are
{\it composable} if the source of $\phi$ is equal to the
target of $\psi$, in which case $\phi \circ \psi$ is defined.
An equivalent definition would be to define a category
as a quintuple $(\text{Ob}, \text{Arrows}, s, t, \circ)$
consisting of a set of objects, a set of morphisms (arrows),
source, target and composition subject to a long list of axioms.
We will occasionally use this point of view.

\begin{remark}
\label{remark-big-categories}
Big categories. In some texts a category is allowed to have a proper
class of objects. We will allow this as well in these notes but only
in the following list of cases (to be updated as we go along).
In particular, when we say: ``Let $\mathcal{C}$ be a category''
then it is understood that $\Ob(\mathcal{C})$ is a set.
\begin{enumerate}
\item The category $\textit{Sets}$ of sets.
\item The category $\textit{Ab}$ of abelian groups.
\item The category $\textit{Groups}$ of groups.
\item Given a group $G$ the category $G\textit{-Sets}$ of
sets with a left $G$-action.
\item Given a ring $R$ the category $\text{Mod}_R$ of $R$-modules.
\item Given a field $k$ the category of vector spaces over $k$.
\item The category of rings.
\item The category of schemes.
\item The category $\textit{Top}$ of topological spaces.
\item Given a topological space $X$ the category
$\textit{PSh}(X)$ of presheaves of sets over $X$.
\item Given a topological space $X$ the category
$\Sh(X)$ of sheaves of sets over $X$.
\item Given a topological space $X$ the category
$\textit{PAb}(X)$ of presheaves of abelian groups over $X$.
\item Given a topological space $X$ the category
$\textit{Ab}(X)$ of sheaves of abelian groups over $X$.
\item Given a small category $\mathcal{C}$ the category of functors
from $\mathcal{C}$ to $\textit{Sets}$.
\item Given a category $\mathcal{C}$ the category of presheaves of sets
over $\mathcal{C}$.
\item Given a site $\mathcal{C}$ the category of sheaves
of sets over $\mathcal{C}$.
\end{enumerate}
One of the reason to enumerate these here is to try and avoid
working with something like the ``collection'' of ``big'' categories
which would be like working with the collection of all classes
which I think definitively is a meta-mathematical object.
\end{remark}

\begin{remark}
\label{remark-unique-identity}
It follows directly from the definition that any two identity morphisms
of an object $x$ of $\mathcal{A}$ are the same. Thus we may and will
speak of {\it the} identity morphism $\text{id}_x$ of $x$.
\end{remark}

\begin{definition}
\label{definition-isomorphism}
A morphism $\phi : x \to y$ is an {\it isomorphism} of the category
$\mathcal{C}$ if there exists a morphism $\psi : y \to x$
such that $\phi \circ \psi = \text{id}_y$ and
$\psi \circ \phi = \text{id}_x$.
\end{definition}

\noindent
An isomorphism $\phi$ is also sometimes called an {\it invertible}
morphism, and the morphism $\psi$ of the definition is called the
{\it inverse} and denoted $\phi^{-1}$. It is unique if it exists. Note that
given an object $x$ of a category $\mathcal{A}$ the set of invertible
elements $\text{Aut}_\mathcal{A}(x)$
of $\Mor_\mathcal{A}(x, x)$ forms a group under composition.
This group is called the {\it automorphism} group of $x$ in $\mathcal{A}$.

\begin{definition}
\label{definition-groupoid}
A {\it groupoid} is a category where every morphism is an isomorphism.
\end{definition}

\begin{example}
\label{example-group-groupoid}
A group $G$ gives rise to a groupoid with a single object $x$
and morphisms $\Mor(x, x) = G$, with the composition rule
given by the group law in $G$. Every groupoid with a single
object is of this form.
\end{example}

\begin{example}
\label{example-set-groupoid}
A set $C$ gives rise to a groupoid $\mathcal{C}$ defined as follows:
As objects we take $\Ob(\mathcal{C}) := C$ and for morphisms
we take $\Mor(x, y)$ empty if $x\neq y$ and equal to
$\{\text{id}_x\}$ if $x = y$.
\end{example}

\begin{definition}
\label{definition-functor}
A {\it functor} $F : \mathcal{A} \to \mathcal{B}$
between two categories $\mathcal{A}, \mathcal{B}$ is given by the
following data:
\begin{enumerate}
\item A map $F : \Ob(\mathcal{A}) \to \Ob(\mathcal{B})$.
\item For every $x, y \in \Ob(\mathcal{A})$ a map
$F : \Mor_\mathcal{A}(x, y) \to \Mor_\mathcal{B}(F(x), F(y))$,
denoted $\phi \mapsto F(\phi)$.
\end{enumerate}
These data should be compatible with composition and identity morphisms
in the following manner: $F(\phi \circ \psi) =
F(\phi) \circ F(\psi)$ for a composable pair $(\phi, \psi)$ of
morphisms of $\mathcal{A}$ and $F(\text{id}_x) = \text{id}_{F(x)}$.
\end{definition}

\noindent
Note that every category $\mathcal{A}$ has an
{\it identity} functor $\text{id}_\mathcal{A}$.
In addition, given a functor $G : \mathcal{B} \to \mathcal{C}$
and a functor $F : \mathcal{A} \to \mathcal{B}$ there is
a {\it composition} functor $G \circ F : \mathcal{A} \to \mathcal{C}$
defined in an obvious manner.

\begin{definition}
\label{definition-faithful}
Let $F : \mathcal{A} \to \mathcal{B}$ be a functor.
\begin{enumerate}
\item We say $F$ is {\it faithful} if
for any objects $x, y$ of $\Ob(\mathcal{A})$ the map
$$
F : \Mor_\mathcal{A}(x, y) \to \Mor_\mathcal{B}(F(x), F(y))
$$
is injective.
\item If these maps are all bijective then $F$ is called
{\it fully faithful}.
\item
The functor $F$ is called {\it essentially surjective} if for any
object $y \in \Ob(\mathcal{B})$ there exists an object
$x \in \Ob(\mathcal{A})$ such that $F(x)$ is isomorphic to $y$ in
$\mathcal{B}$.
\end{enumerate}
\end{definition}

\begin{definition}
\label{definition-subcategory}
A {\it subcategory} of a category $\mathcal{B}$ is
a category $\mathcal{A}$ whose objects and arrows
form subsets of the objects and arrows
of $\mathcal{B}$ and such that source, target
and composition in $\mathcal{A}$ agree with those
of $\mathcal{B}$. We say $\mathcal{A}$ is a
{\it full subcategory} of $\mathcal{B}$ if $\Mor_\mathcal{A}(x, y)
= \Mor_\mathcal{B}(x, y)$ for all $x, y \in \Ob(\mathcal{A})$.
We say $\mathcal{A}$ is a {\it strictly full} subcategory of $\mathcal{B}$
if it is a full subcategory and given $x \in \Ob(\mathcal{A})$ any
object of $\mathcal{B}$ which is isomorphic to $x$ is also in $\mathcal{A}$.
\end{definition}

\noindent
If $\mathcal{A} \subset \mathcal{B}$ is a subcategory then the
identity map is a functor from $\mathcal{A}$ to $\mathcal{B}$.
Furthermore a subcategory $\mathcal{A} \subset \mathcal{B}$
is full if and only if the inclusion functor is fully faithful.
Note that given a category $\mathcal{B}$ the set of full subcategories
of $\mathcal{B}$ is the same as the set of subsets of
$\Ob(\mathcal{B})$.

\begin{remark}
\label{remark-functor-into-sets}
Suppose that $\mathcal{A}$ is a category.
A functor $F$ from $\mathcal{A}$ to $\textit{Sets}$
is a mathematical object (i.e., it is a set not a class or a formula
of set theory, see
Sets, Section \ref{sets-section-sets-everything})
even though the category of sets is ``big''.
Namely, the range of $F$ on objects will be
a set $F(\Ob(\mathcal{A}))$ and then we
may think of $F$ as a functor between
$\mathcal{A}$ and the full subcategory
of the category of sets whose
objects are elements of $F(\Ob(\mathcal{A}))$.
\end{remark}

\begin{example}
\label{example-group-homomorphism-functor}
A homomorphism $p : G\to H$ of groups gives rise to a functor
between the associated groupoids in Example \ref{example-group-groupoid}. It is
faithful (resp.\ fully faithful) if and only if $p$ is injective (resp.\ an
isomorphism).
\end{example}

\begin{example}
\label{example-category-over-X}
Given a category $\mathcal{C}$ and an object $X\in \Ob(\mathcal{C})$
we define the {\it category of objects over $X$},
denoted $\mathcal{C}/X$ as follows.
The objects of $\mathcal{C}/X$ are morphisms $Y\to X$ for
some $Y\in \Ob(\mathcal{C})$. Morphisms between objects
$Y\to X$ and $Y'\to X$ are morphisms $Y\to Y'$ in $\mathcal{C}$ that
make the obvious diagram commute.  Note that there is a functor
$p_X : \mathcal{C}/X\to \mathcal{C}$ which simply forgets the
morphism.  Moreover given a morphism $f : X'\to X$ in
$\mathcal{C}$ there is an induced functor
$F : \mathcal{C}/X' \to \mathcal{C}/X$ obtained by composition with $f$,
and $p_X\circ F = p_{X'}$.
\end{example}

\begin{example}
\label{example-category-under-X}
Given a category $\mathcal{C}$ and an object $X\in \Ob(\mathcal{C})$
we define the {\it category of objects under $X$},
denoted $X/\mathcal{C}$ as follows.
The objects of $X/\mathcal{C}$ are morphisms $X\to Y$ for
some $Y\in \Ob(\mathcal{C})$. Morphisms between objects
$X\to Y$ and $X\to Y'$ are morphisms $Y\to Y'$ in $\mathcal{C}$ that
make the obvious diagram commute.  Note that there is a functor
$p_X : X/\mathcal{C}\to \mathcal{C}$ which simply forgets the
morphism.  Moreover given a morphism $f : X'\to X$ in
$\mathcal{C}$ there is an induced functor
$F : X/\mathcal{C} \to X'/\mathcal{C}$
obtained by composition with $f$,
and $p_{X'}\circ F = p_X$.
\end{example}




\begin{definition}
\label{definition-transformation-functors}
Let $F, G : \mathcal{A} \to \mathcal{B}$ be functors.
A {\it natural transformation}, or a {\it morphism of functors}
$t : F \to G$, is a collection $\{t_x\}_{x\in \Ob(\mathcal{A})}$
such that
\begin{enumerate}
\item $t_x : F(x) \to G(x)$ is a morphism in the category $\mathcal{B}$, and
\item for every morphism $\phi : x \to y$ of $\mathcal{A}$ the following
diagram is commutative
$$
\xymatrix{
F(x) \ar[r]^{t_x} \ar[d]_{F(\phi)} & G(x) \ar[d]^{G(\phi)} \\
F(y) \ar[r]^{t_y} & G(y) }
$$
\end{enumerate}
\end{definition}

\noindent
Sometimes we use the diagram
$$
\xymatrix{
\mathcal{A}
\rtwocell^F_G{t}
&
\mathcal{B}
}
$$
to indicate that $t$ is a morphism from $F$ to $G$.

\medskip\noindent
Note that every functor $F$ comes with the {\it identity} transformation
$\text{id}_F : F \to F$. In addition, given a morphism of
functors $t : F \to G$ and a morphism of functors $s : E \to F$
then the {\it composition} $t \circ s$ is defined by the rule
$$
(t \circ s)_x = t_x \circ s_x : E(x) \to G(x)
$$
for $x \in \Ob(\mathcal{A})$.
It is easy to verify that this is indeed a morphism of functors
from $E$ to $G$.
In this way, given categories
$\mathcal{A}$ and $\mathcal{B}$ we obtain a new category,
namely the category of functors between $\mathcal{A}$ and
$\mathcal{B}$.

\begin{remark}
\label{remark-functors-sets-sets}
This is one instance where the same thing does not hold if
$\mathcal{A}$ is a ``big'' category. For example consider
functors $\textit{Sets} \to \textit{Sets}$. As we have currently
defined it such a functor is a class and not a set. In other
words, it is given by a formula in set theory (with some variables
equal to specified sets)! It is not a good idea to try to consider
all possible formulae of set theory as part of the definition of
a mathematical object. The same problem presents itself when
considering sheaves on the category of schemes for example.
We will come back to this point later.
\end{remark}

\begin{definition}
\label{definition-equivalence-categories}
An {\it equivalence of categories}
$F : \mathcal{A} \to \mathcal{B}$ is a functor such that there
exists a functor $G : \mathcal{B} \to \mathcal{A}$ such that
the compositions $F \circ G$ and $G \circ F$ are isomorphic to the
identity functors $\text{id}_\mathcal{B}$,
respectively $\text{id}_\mathcal{A}$.
In this case we say that $G$ is a {\it quasi-inverse} to $F$.
\end{definition}

\begin{lemma}
\label{lemma-construct-quasi-inverse}
Let $F : \mathcal{A} \to \mathcal{B}$ be a fully faithful functor.
Suppose for every $X \in \Ob(\mathcal{B})$ given an
object $j(X)$ of $\mathcal{A}$ and an isomorphism $i_X : X \to F(j(X))$.
Then there is a unique functor $j : \mathcal{B} \to \mathcal{A}$
such that $j$ extends the rule on objects, and the isomorphisms
$i_X$ define an isomorphism of functors
$\text{id}_\mathcal{B} \to F \circ j$. Moreover, $j$ and $F$
are quasi-inverse equivalences of categories.
\end{lemma}

\begin{proof}
This lemma proves itself.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-categories}
A functor is an equivalence of categories if and only if it is both fully
faithful and essentially surjective.
\end{lemma}

\begin{proof}
Let $F : \mathcal{A} \to \mathcal{B}$ be essentially surjective and fully
faithful. As by convention all categories are small and as $F$ is essentially
surjective we can, using the axiom of choice, choose for every
$X \in \Ob(\mathcal{B})$ an object $j(X)$ of $\mathcal{A}$ and an
isomorphism $i_X : X \to F(j(X))$. Then we apply
Lemma \ref{lemma-construct-quasi-inverse}
using that $F$ is fully faithful.
\end{proof}

\begin{definition}
\label{definition-product-category}
Let $\mathcal{A}$, $\mathcal{B}$ be categories.
We define the {\it product category}
$\mathcal{A} \times \mathcal{B}$ to be the category with
objects
$\Ob(\mathcal{A} \times \mathcal{B}) =
\Ob(\mathcal{A}) \times \Ob(\mathcal{B})$
and
$$
\Mor_{\mathcal{A} \times \mathcal{B}}((x, y), (x', y'))
:=
\Mor_\mathcal{A}(x, x')\times
\Mor_\mathcal{B}(y, y').
$$
Composition is defined componentwise.
\end{definition}


\section{Opposite Categories and the Yoneda Lemma}
\label{section-opposite}

\begin{definition}
\label{definition-opposite}
Given a category $\mathcal{C}$ the {\it opposite category}
$\mathcal{C}^{opp}$ is the category with the same objects
as $\mathcal{C}$ but all morphisms reversed.
\end{definition}

\noindent
In other words
$\Mor_{\mathcal{C}^{opp}}(x, y) = \Mor_\mathcal{C}(y, x)$.
Composition in $\mathcal{C}^{opp}$ is the same as in $\mathcal{C}$
except backwards: if $\phi : y \to z$ and $\psi : x \to y$
are morphisms in $\mathcal{C}^{opp}$, in other words arrows
$z \to y$ and $y \to x$ in $\mathcal{C}$,
then $\phi \circ^{opp} \psi$ is the morphism $x \to z$
of $\mathcal{C}^{opp}$ which corresponds to the composition
$z \to y \to x$ in $\mathcal{C}$.

\begin{definition}
\label{definition-contravariant}
Let $\mathcal{C}$, $\mathcal{S}$ be categories.
A {\it contravariant} functor $F$
from $\mathcal{C}$ to $\mathcal{S}$
is a functor $\mathcal{C}^{opp}\to \mathcal{S}$.
\end{definition}

\noindent
Concretely, a contravariant functor $F$ is given
by a map $F : \Ob(\mathcal{C}) \to
\Ob(\mathcal{S})$ and for every morphism
$\psi : x \to y$ in $\mathcal{C}$ a morphism
$F(\psi) : F(y) \to F(x)$. These should satisfy the property
that, given another morphism
$\phi : y \to z$, we have $F(\phi \circ \psi)
= F(\psi) \circ F(\phi)$ as morphisms $F(z) \to F(x)$.
(Note the reverse of order.)

\begin{definition}
\label{definition-presheaf}
Let $\mathcal{C}$ be a category.
\begin{enumerate}
\item A {\it presheaf of sets on $\mathcal{C}$}
or simply a {\it presheaf} is a contravariant functor
$F$ from $\mathcal{C}$ to $\textit{Sets}$.
\item The category of presheaves is denoted $\textit{PSh}(\mathcal{C})$.
\end{enumerate}
\end{definition}

\noindent
Of course the category of presheaves is a proper class.

\begin{example}
\label{example-hom-functor}
Functor of points.
For any $U\in \Ob(\mathcal{C})$ there is a contravariant
functor
$$
\begin{matrix}
h_U & : & \mathcal{C}
&
\longrightarrow
&
\textit{Sets} \\
& &
X
&
\longmapsto
&
\Mor_\mathcal{C}(X, U)
\end{matrix}
$$
which takes an object $X$ to the set
$\Mor_\mathcal{C}(X, U)$. In other words $h_U$ is a presheaf.
Given a morphism $f : X\to Y$ the corresponding map
$h_U(f) :  \Mor_\mathcal{C}(Y, U)\to \Mor_\mathcal{C}(X, U)$
takes $\phi$ to $\phi\circ f$. We will always denote
this presheaf $h_U : \mathcal{C}^{opp} \to \textit{Sets}$.
It is called the {\it representable presheaf} associated to $U$.
If $\mathcal{C}$ is the category of schemes this functor is
sometimes referred to as the
\emph{functor of points} of $U$.
\end{example}

\noindent
Note that given a morphism $\phi : U \to V$ in $\mathcal{C}$ we get a
corresponding natural transformation of functors
$h(\phi) : h_U \to h_V$ defined simply by composing with the morphism
$U \to V$. It is trivial to see that this turns
composition of morphisms in $\mathcal{C}$ into composition of
transformations of functors. In other words we get a functor
$$
h :
\mathcal{C}
\longrightarrow
\text{Fun}(\mathcal{C}^{opp}, \textit{Sets}) = \textit{PSh}(\mathcal{C})
$$
Note that the target is a ``big'' category, see
Remark \ref{remark-big-categories}. On the other hand,
$h$ is an actual mathematical object (i.e.\ a set), compare Remark
\ref{remark-functor-into-sets}.

\begin{lemma}[Yoneda lemma]
\label{lemma-yoneda}
\begin{reference}
Appeared in some form in \cite{Yoneda-homology}. Used by Grothendieck in a
generalized form in \cite{Gr-II}.
\end{reference}
Let $U, V \in \Ob(\mathcal{C})$.
Given any morphism of functors $s : h_U \to h_V$
there is a unique morphism $\phi : U \to V$
such that $h(\phi) = s$. In other words the
functor $h$ is fully faithful. More generally,
given any contravariant functor $F$ and any object
$U$ of $\mathcal{C}$ we have a natural bijection
$$
\Mor_{\textit{PSh}(\mathcal{C})}(h_U, F) \longrightarrow F(U),
\quad
s \longmapsto s_U(\text{id}_U).
$$
\end{lemma}

\begin{proof}
For the first statement, just take
$\phi = s_U(\text{id}_U) \in \Mor_\mathcal{C}(U, V)$.
For the second statement, given $\xi \in F(U)$ define
$s$ by $s_V : h_U(V) \to F(V)$ by sending the element $f : V \to U$
of $h_V(U) = \Mor_\mathcal{C}(V, U)$ to $F(f)(\xi)$.
\end{proof}

\begin{definition}
\label{definition-representable-functor}
A contravariant functor $F : \mathcal{C}\to \textit{Sets}$ is said
to be {\it representable} if it is isomorphic to the functor of
points $h_U$ for some object $U$ of $\mathcal{C}$.
\end{definition}

\noindent
Let $\mathcal{C}$ be a category and let
$F : \mathcal{C}^{opp} \to \textit{Sets}$ be a representable functor.
Choose an object $U$ of $\mathcal{C}$ and an isomorphism $s : h_U \to F$.
The Yoneda lemma guarantees that the pair $(U, s)$
is unique up to unique isomorphism. The object
$U$ is called an object {\it representing} $F$.
By the Yoneda lemma the transformation $s$ corresponds to a unique
element $\xi \in F(U)$. This element is called the {\it universal object}.
It has the property that for $V \in \Ob(\mathcal{C})$ the map
$$
\Mor_\mathcal{C}(V, U) \longrightarrow F(V),\quad
(f : V \to U) \longmapsto F(f)(\xi)
$$
is a bijection. Thus $\xi$ is universal in the sense that every element
of $F(V)$ is equal to the image of $\xi$ via $F(f)$ for a unique morphism
$f : V \to U$ in $\mathcal{C}$.






\section{Products of pairs}
\label{section-products-pairs}

\begin{definition}
\label{definition-products}
Let $x, y\in \Ob(\mathcal{C})$.
A {\it product} of $x$ and $y$ is
an object $x \times y \in \Ob(\mathcal{C})$
together with morphisms
$p\in \Mor_{\mathcal C}(x \times y, x)$ and
$q\in\Mor_{\mathcal C}(x \times y, y)$ such
that the following universal property holds: for
any $w\in \Ob(\mathcal{C})$ and morphisms
$\alpha \in \Mor_{\mathcal C}(w, x)$ and
$\beta \in \Mor_\mathcal{C}(w, y)$
there is a unique
$\gamma\in \Mor_{\mathcal C}(w, x \times y)$ making
the diagram
$$
\xymatrix{
w \ar[rrrd]^\beta \ar@{-->}[rrd]_\gamma \ar[rrdd]_\alpha & & \\
& & x \times y \ar[d]_p \ar[r]_q & y \\
& & x &
}
$$
commute.
\end{definition}

\noindent
If a product exists it is unique up to unique
isomorphism. This follows from the Yoneda lemma as
the definition requires $x \times y$ to be an object
of $\mathcal{C}$ such that
$$
h_{x \times y}(w) = h_x(w) \times h_y(w)
$$
functorially in $w$. In other words the product $x \times y$
is an object representing the functor
$w \mapsto h_x(w) \times h_y(w)$.

\begin{definition}
\label{definition-has-products-of-pairs}
We say the category $\mathcal{C}$ {\it has products of pairs
of objects} if a product $x \times y$
exists for any $x, y \in \Ob(\mathcal{C})$.
\end{definition}

\noindent
We use this terminology to distinguish this notion from the notion
of ``having products'' or ``having finite products'' which usually means
something else (in particular it always implies there exists a
final object).





\section{Coproducts of pairs}
\label{section-coproducts-pairs}

\begin{definition}
\label{definition-coproducts}
Let $x, y \in \Ob(\mathcal{C})$.
A {\it coproduct}, or {\it amalgamated sum} of $x$ and $y$ is
an object $x \amalg y \in \Ob(\mathcal{C})$
together with morphisms
$i \in \Mor_{\mathcal C}(x, x \amalg y)$ and
$j \in \Mor_{\mathcal C}(y, x \amalg y)$ such
that the following universal property holds: for
any $w \in \Ob(\mathcal{C})$ and morphisms
$\alpha \in \Mor_{\mathcal C}(x, w)$ and
$\beta \in \Mor_\mathcal{C}(y, w)$
there is a unique
$\gamma \in \Mor_{\mathcal C}(x \amalg y, w)$ making
the diagram
$$
\xymatrix{
& y \ar[d]^j \ar[rrdd]^\beta \\
x \ar[r]^i \ar[rrrd]_\alpha & x \amalg y \ar@{-->}[rrd]^\gamma \\
& & & w
}
$$
commute.
\end{definition}

\noindent
If a coproduct exists it is unique up to unique
isomorphism. This follows from the Yoneda lemma (applied to the
opposite category) as
the definition requires $x \amalg y$ to be an object
of $\mathcal{C}$ such that
$$
\Mor_\mathcal{C}(x \amalg y, w) =
\Mor_\mathcal{C}(x, w) \times \Mor_\mathcal{C}(y, w)
$$
functorially in $w$.

\begin{definition}
\label{definition-has-coproducts-of-pairs}
We say the category $\mathcal{C}$ {\it has coproducts of pairs
of objects} if a coproduct $x \amalg y$
exists for any $x, y \in \Ob(\mathcal{C})$.
\end{definition}

\noindent
We use this terminology to distinguish this notion from the notion
of ``having coproducts'' or ``having finite coproducts'' which usually means
something else (in particular it always implies there exists an
initial object in $\mathcal{C}$).





\section{Fibre products}
\label{section-fibre-products}

\begin{definition}
\label{definition-fibre-products}
Let $x, y, z\in \Ob(\mathcal{C})$,
$f\in \Mor_\mathcal{C}(x, y)$
and $g\in \Mor_{\mathcal C}(z, y)$.
A {\it fibre product} of $f$ and $g$ is
an object $x \times_y z\in \Ob(\mathcal{C})$
together with morphisms
$p \in \Mor_{\mathcal C}(x \times_y z, x)$ and
$q \in \Mor_{\mathcal C}(x \times_y z, z)$ making the diagram
$$
\xymatrix{
x \times_y z \ar[r]_q \ar[d]_p & z \ar[d]^g \\
x \ar[r]^f & y
}
$$
commute, and such that the following universal property holds: for
any $w\in \Ob(\mathcal{C})$ and morphisms
$\alpha \in \Mor_{\mathcal C}(w, x)$ and
$\beta \in \Mor_\mathcal{C}(w, z)$ with
$f \circ \alpha = g \circ \beta$
there is a unique
$\gamma \in \Mor_{\mathcal C}(w, x \times_y z)$ making
the diagram
$$
\xymatrix{
w \ar[rrrd]^\beta \ar@{-->}[rrd]_\gamma \ar[rrdd]_\alpha & & \\
& & x \times_y z \ar[d]^p \ar[r]_q & z \ar[d]^g \\
& & x \ar[r]^f & y
}
$$
commute.
\end{definition}

\noindent
If a fibre product exists it is unique up to unique
isomorphism. This follows from the Yoneda lemma as
the definition requires $x \times_y z$ to be an object
of $\mathcal{C}$ such that
$$
h_{x \times_y z}(w) = h_x(w) \times_{h_y(w)} h_z(w)
$$
functorially in $w$. In other words the fibre product $x \times_y z$
is an object representing the functor
$w \mapsto h_x(w) \times_{h_y(w)} h_z(w)$.

\begin{definition}
\label{definition-cartesian}
We say a commutative diagram
$$
\xymatrix{
w \ar[r] \ar[d] &
z \ar[d] \\
x \ar[r] &
y
}
$$
in a category is {\it cartesian} if $w$ and the morphisms $w \to x$ and
$w \to z$ form a fibre product of the morphisms $x \to y$ and $z \to y$.
\end{definition}

\begin{definition}
\label{definition-has-fibre-products}
We say the category $\mathcal{C}$ {\it has fibre products} if
the fibre product exists for any $f\in \Mor_{\mathcal C}(x, y)$
and $g\in \Mor_{\mathcal C}(z, y)$.
\end{definition}

\begin{definition}
\label{definition-representable-morphism}
A morphism $f : x \to y$ of a category $\mathcal{C}$ is said to be
{\it representable} if for every morphism $z \to y$
in $\mathcal{C}$ the fibre product $x \times_y z$ exists.
\end{definition}

\begin{lemma}
\label{lemma-composition-representable}
Let $\mathcal{C}$ be a category.
Let $f : x \to y$, and $g : y \to z$ be representable.
Then $g \circ f : x \to z$ is representable.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-representable}
Let $\mathcal{C}$ be a category.
Let $f : x \to y$ be representable.
Let $y' \to y$ be a morphism of $\mathcal{C}$.
Then the morphism $x' := x \times_y y' \to y'$ is representable also.
\end{lemma}

\begin{proof}
Let $z \to y'$ be a morphism. The fibre product
$x' \times_{y'} z$ is supposed to represent the
functor
\begin{eqnarray*}
w & \mapsto & h_{x'}(w)\times_{h_{y'}(w)} h_z(w) \\
& = & (h_x(w) \times_{h_y(w)} h_{y'}(w)) \times_{h_{y'}(w)} h_z(w) \\
& = & h_x(w) \times_{h_y(w)} h_z(w)
\end{eqnarray*}
which is representable by assumption.
\end{proof}

\section{Examples of fibre products}
\label{section-example-fibre-products}

\noindent
In this section we list examples of fibre products and
we describe them.

\medskip\noindent
As a really trivial first example we observe
that the category of sets has fibred products and hence every
morphism is representable. Namely, if $f : X \to Y$
and $g : Z \to Y$ are maps of sets then we define
$X \times_Y Z$ as the subset of $X \times Z$ consisting
of pairs $(x, z)$ such that $f(x) = g(z)$. The morphisms
$p : X \times_Y Z \to X$ and $q : X \times_Y Z \to Z$ are
the projection maps $(x, z) \mapsto x$, and $(x, z) \mapsto z$.
Finally, if $\alpha : W \to X$ and $\beta : W \to Z$
are morphisms such that $f \circ \alpha = g \circ \beta$
then the map $W \to X \times Z$, $w\mapsto (\alpha(w), \beta(w))$
obviously ends up in $X \times_Y Z$ as desired.

\medskip\noindent
In many categories whose objects are sets endowed with certain types of
algebraic structures the fibre product of the underlying sets also
provides the fibre product in the category. For example, suppose
that $X$, $Y$ and $Z$ above are groups and that $f$, $g$ are
homomorphisms of groups. Then the set-theoretic fibre product
$X \times_Y Z$ inherits the structure of a group, simply by
defining the product of two pairs by the formula
$(x, z) \cdot (x', z') = (xx', zz')$. Here we list those categories
for which a similar reasoning works.
\begin{enumerate}
\item The category $\textit{Groups}$ of groups.
\item The category $G\textit{-Sets}$ of sets
endowed with a left $G$-action for some fixed group $G$.
\item The category of rings.
\item The category of $R$-modules given a ring $R$.
\end{enumerate}




\section{Fibre products and representability}
\label{section-representable-map-presheaves}

\noindent
In this section we work out fibre products in the
category of contravariant functors from a category
to the category of sets. This will later be superseded
during the discussion of sites, presheaves, sheaves. Of some
interest is the notion of a ``representable morphism'' between
such functors.

\begin{lemma}
\label{lemma-fibre-product-presheaves}
Let $\mathcal{C}$ be a category.
Let $F, G, H : \mathcal{C}^{opp} \to \textit{Sets}$
be functors. Let $a : F \to G$ and $b : H \to G$ be
transformations of functors. Then the fibre product
$F \times_{a, G, b} H$ in the category
$\text{Fun}(\mathcal{C}^{opp}, \textit{Sets})$
exists and is given by the formula
$$
(F \times_{a, G, b} H)(X) =
F(X) \times_{a_X, G(X), b_X} H(X)
$$
for any object $X$ of $\mathcal{C}$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
As a special case suppose we have a morphism
$a : F \to G$, an object $U \in \Ob(\mathcal{C})$
and an element $\xi \in G(U)$. According to the Yoneda
Lemma \ref{lemma-yoneda} this gives a transformation
$\xi : h_U \to G$. The fibre product in this case
is described by the rule
$$
(h_U \times_{\xi, G, a} F)(X) =
\{ (f, \xi') \mid f : X \to U, \ \xi' \in F(X), \ G(f)(\xi) = a_X(\xi')\}
$$
If $F$, $G$ are also representable, then this is the functor representing the
fibre product, if it exists, see Section \ref{section-fibre-products}.
The analogy with Definition \ref{definition-representable-morphism}
prompts us to define a notion
of representable transformations.

\begin{definition}
\label{definition-representable-map-presheaves}
Let $\mathcal{C}$ be a category.
Let $F, G : \mathcal{C}^{opp} \to \textit{Sets}$
be functors. We say a morphism $a : F \to G$ is
{\it representable}, or that {\it $F$ is relatively representable
over $G$}, if for every $U \in \Ob(\mathcal{C})$
and any $\xi \in G(U)$ the functor
$h_U \times_G F$ is representable.
\end{definition}

\begin{lemma}
\label{lemma-representable-over-representable}
Let $\mathcal{C}$ be a category.
Let $a : F \to G$ be a morphism of contravariant functors
from $\mathcal{C}$ to $\textit{Sets}$. If $a$ is representable,
and $G$ is a representable functor, then $F$ is representable.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-representable-diagonal}
Let $\mathcal{C}$ be a category.
Let $F : \mathcal{C}^{opp} \to \textit{Sets}$ be a functor.
Assume $\mathcal{C}$ has products of pairs of objects and fibre products.
The following are equivalent:
\begin{enumerate}
\item the diagonal $\Delta : F \to F \times F$ is representable,
\item for every $U$ in $\mathcal{C}$,
and any $\xi \in F(U)$ the map $\xi : h_U \to F$ is representable,
\item for every pair $U, V$ in $\mathcal{C}$
and any $\xi \in F(U)$, $\xi' \in F(V)$ the fibre product
$h_U \times_{\xi, F, \xi'} h_V$ is representable.
\end{enumerate}
\end{lemma}

\begin{proof}
We will continue to use the Yoneda lemma to identify $F(U)$
with transformations $h_U \to F$ of functors.

\medskip\noindent
Equivalence of (2) and (3). Let $U, \xi, V, \xi'$ be as in (3).
Both (2) and (3) tell us exactly that $h_U \times_{\xi, F, \xi'} h_V$
is representable; the only difference is that the statement
(3) is symmetric in $U$ and $V$ whereas (2) is not.

\medskip\noindent
Assume condition (1). Let $U, \xi, V, \xi'$
be as in (3). Note that $h_U \times h_V = h_{U \times V}$ is representable.
Denote $\eta : h_{U \times V} \to F \times F$ the map
corresponding to the product $\xi \times \xi' : h_U \times h_V \to F \times F$.
Then the fibre product $F \times_{\Delta, F \times F, \eta} h_{U \times V}$
is representable by assumption. This means there exists
$W \in \Ob(\mathcal{C})$, morphisms
$W \to U$, $W \to V$ and $h_W \to F$ such that
$$
\xymatrix{
h_W \ar[d] \ar[r] & h_U \times h_V \ar[d]^{\xi \times \xi'} \\
F \ar[r] & F \times F
}
$$
is cartesian. Using the explicit description of fibre products
in Lemma \ref{lemma-fibre-product-presheaves} the reader sees that this
implies that $h_W = h_U \times_{\xi, F, \xi'} h_V$ as desired.

\medskip\noindent
Assume the equivalent conditions (2) and (3). Let $U$ be an object
of $\mathcal{C}$ and let $(\xi, \xi') \in (F \times F)(U)$.
By (3) the fibre product $h_U \times_{\xi, F, \xi'} h_U$ is
representable. Choose an object $W$ and an isomorphism
$h_W \to h_U \times_{\xi, F, \xi'} h_U$. The two projections
$\text{pr}_i : h_U \times_{\xi, F, \xi'} h_U \to h_U$
correspond to morphisms $p_i : W \to U$ by Yoneda. Consider
$W' = W \times_{(p_1, p_2), U \times U} U$. It is formal
to show that $W'$ represents $F \times_{\Delta, F \times F} h_U$
because
$$
h_{W'} =  h_W \times_{h_U \times h_U} h_U
= (h_U \times_{\xi, F, \xi'} h_U) \times_{h_U \times h_U} h_U
= F \times_{F \times F} h_U.
$$
Thus $\Delta$ is representable and this finishes the proof.
\end{proof}









\section{Pushouts}
\label{section-pushouts}

\noindent
The dual notion to fibre products is that of pushouts.

\begin{definition}
\label{definition-pushouts}
Let $x, y, z\in \Ob(\mathcal{C})$,
$f\in \Mor_\mathcal{C}(y, x)$
and $g\in \Mor_{\mathcal C}(y, z)$.
A {\it pushout} of $f$ and $g$ is
an object $x\amalg_y z\in \Ob(\mathcal{C})$
together with morphisms
$p\in \Mor_{\mathcal C}(x, x\amalg_y z)$ and
$q\in\Mor_{\mathcal C}(z, x\amalg_y z)$ making the diagram
$$
\xymatrix{
y \ar[r]_g \ar[d]_f & z \ar[d]^q \\
x \ar[r]^p & x\amalg_y z
}
$$
commute, and such that the following universal property holds:
For any $w\in \Ob(\mathcal{C})$ and morphisms
$\alpha \in \Mor_{\mathcal C}(x, w)$ and
$\beta \in \Mor_\mathcal{C}(z, w)$ with
$\alpha \circ f = \beta \circ g$ there is a unique
$\gamma\in \Mor_{\mathcal C}(x\amalg_y z, w)$ making
the diagram
$$
\xymatrix{
y \ar[r]_g \ar[d]_f & z \ar[d]^q \ar[rrdd]^\beta & & \\
x \ar[r]^p \ar[rrrd]^\alpha & x \amalg_y z  \ar@{-->}[rrd]^\gamma & & \\
& & & w
}
$$
commute.
\end{definition}

\noindent
It is possible and straightforward to prove the uniqueness of the triple
$(x\amalg_y z, p, q)$ up to unique isomorphism (if it exists) by direct
arguments. Another possibility is to think of the pushout as the
fibre product in the opposite category, thereby getting this uniqueness for
free from the discussion in Section \ref{section-fibre-products}.

\begin{definition}
\label{definition-cocartesian}
We say a commutative diagram
$$
\xymatrix{
y \ar[r] \ar[d] & z \ar[d] \\
x \ar[r] & w
}
$$
in a category is {\it cocartesian} if $w$ and the morphisms $x \to w$ and
$z \to w$ form a pushout of the morphisms $y \to x$ and $y \to z$.
\end{definition}


\section{Equalizers}
\label{section-equalizers}

\begin{definition}
\label{definition-equalizers}
Suppose that $X$, $Y$ are objects of a category $\mathcal{C}$
and that $a, b : X \to Y$ are morphisms. We say a morphism
$e : Z \to X$ is an {\it equalizer} for the pair $(a, b)$ if
$a \circ e = b \circ e$ and if $(Z, e)$ satisfies the following
universal property: For every morphism $t : W \to X$
in $\mathcal{C}$ such that $a \circ t = b \circ t$ there exists
a unique morphism $s : W \to Z$ such that $t = e \circ s$.
\end{definition}

\noindent
As in the case of the fibre product above, equalizers when
they exist are unique up to unique isomorphism. There is a
straightforward generalization of this definition to the
case where we have more than $2$ morphisms.

\section{Coequalizers}
\label{section-coequalizers}

\begin{definition}
\label{definition-coequalizers}
Suppose that $X$, $Y$ are objects of a category $\mathcal{C}$
and that $a, b : X \to Y$ are morphisms. We say a morphism
$c : Y \to Z$ is a {\it coequalizer} for the pair $(a, b)$ if
$c \circ a = c \circ b$ and if $(Z, c)$ satisfies the following
universal property: For every morphism $t : Y \to W$
in $\mathcal{C}$ such that $t \circ a = t \circ b$ there exists
a unique morphism $s : Z \to W$ such that $t = s \circ c$.
\end{definition}

\noindent
As in the case of the pushouts above, coequalizers when
they exist are unique up to unique isomorphism, and this follows
from the uniqueness of equalizers upon considering the opposite
category. There is a straightforward generalization of this definition
to the case where we have more than $2$ morphisms.

\section{Initial and final objects}
\label{section-initial-final}

\begin{definition}
\label{definition-initial-final}
Let $\mathcal{C}$ be a category.
\begin{enumerate}
\item An object $x$ of the category $\mathcal{C}$ is called
an {\it initial} object if for every object $y$ of $\mathcal{C}$
there is exactly one morphism $x \to y$.
\item An object $x$ of the category $\mathcal{C}$ is called
a {\it final} object if for every object $y$ of $\mathcal{C}$
there is exactly one morphism $y \to x$.
\end{enumerate}
\end{definition}

\noindent
In the category of sets the empty set $\emptyset$ is an
initial object, and in fact the only initial object.
Also, any {\it singleton}, i.e., a set with one element,
is a final object (so it is not unique).




\section{Monomorphisms and Epimorphisms}
\label{section-mono-epi}

\begin{definition}
\label{definition-mono-epi}
Let $\mathcal{C}$ be a category and let $f : X \to Y$ be
a morphism of $\mathcal{C}$.
\begin{enumerate}
\item We say that $f$ is a {\it monomorphism} if for every object
$W$ and every pair of morphisms $a, b : W \to X$ such that
$f \circ a = f \circ b$ we have $a = b$.
\item We say that $f$ is an {\it epimorphism} if for every object
$W$ and every pair of morphisms $a, b : Y \to W$ such that
$a \circ f = b \circ f$ we have $a = b$.
\end{enumerate}
\end{definition}

\begin{example}
\label{example-mono-epi-sets}
In the category of sets the monomorphisms correspond to injective
maps and the epimorphisms correspond to surjective maps.
\end{example}

\begin{lemma}
\label{lemma-characterize-mono-epi}
Let $\mathcal{C}$ be a category, and let $f : X \to Y$ be
a morphism of $\mathcal{C}$. Then
\begin{enumerate}
\item $f$ is a monomorphism if and only if $X$ is the fibre
product $X \times_Y X$, and
\item $f$ is an epimorphism if and only if $Y$ is the pushout
$Y \amalg_X Y$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}





\section{Limits and colimits}
\label{section-limits}

\noindent
Let $\mathcal{C}$ be a category. A {\it diagram} in $\mathcal{C}$ is
simply a functor $M : \mathcal{I} \to \mathcal{C}$. We say that
$\mathcal{I}$ is the {\it index category} or that $M$ is an
$\mathcal{I}$-diagram. We will use the notation $M_i$ to denote the
image of the object
$i$ of $\mathcal{I}$. Hence for $\phi : i \to i'$ a morphism
in $\mathcal{I}$ we have $M(\phi) : M_i \to M_{i'}$.

\begin{definition}
\label{definition-limit}
A {\it limit} of the $\mathcal{I}$-diagram $M$ in the category
$\mathcal{C}$ is given by an object $\lim_\mathcal{I} M$ in $\mathcal{C}$
together with morphisms $p_i : \lim_\mathcal{I} M \to M_i$ such that
\begin{enumerate}
\item for $\phi : i \to i'$ a morphism
in $\mathcal{I}$ we have $p_{i'} =  M(\phi) \circ p_i$, and
\item for any object $W$ in $\mathcal{C}$ and any family of
morphisms $q_i : W \to M_i$ (indexed by $i \in \mathcal{I}$)
such that for all $\phi : i \to i'$
in $\mathcal{I}$ we have $q_{i'} = M(\phi) \circ q_i$ there
exists a unique morphism $q : W \to \lim_\mathcal{I} M$ such that
$q_i = p_i \circ q$ for every object $i$ of $\mathcal{I}$.
\end{enumerate}
\end{definition}

\noindent
Limits $(\lim_\mathcal{I} M, (p_i)_{i\in \Ob(\mathcal{I})})$ are
(if they exist)
unique up to unique isomorphism by the uniqueness requirement
in the definition. Products of pairs, fibred products, and equalizers are
examples of limits. The limit over the empty diagram is a final object
of $\mathcal{C}$.
In the category of sets all limits exist.
The dual notion is that of colimits.

\begin{definition}
\label{definition-colimit}
A {\it colimit} of the $\mathcal{I}$-diagram $M$ in the category
$\mathcal{C}$ is given by an object $\colim_\mathcal{I} M$ in $\mathcal{C}$
together with morphisms $s_i : M_i \to \colim_\mathcal{I} M$ such that
\begin{enumerate}
\item for $\phi : i \to i'$ a morphism
in $\mathcal{I}$ we have $s_i = s_{i'} \circ M(\phi)$, and
\item for any object $W$ in $\mathcal{C}$ and any family of
morphisms $t_i : M_i \to W$ (indexed by $i \in \mathcal{I}$)
such that for all $\phi : i \to i'$
in $\mathcal{I}$ we have $t_i = t_{i'} \circ M(\phi)$ there
exists a unique morphism $t : \colim_\mathcal{I} M \to W$ such that
$t_i = t \circ s_i$ for every object $i$ of $\mathcal{I}$.
\end{enumerate}
\end{definition}

\noindent
Colimits $(\colim_\mathcal{I} M, (s_i)_{i\in \Ob(\mathcal{I})})$ are
(if they exist) unique up to unique isomorphism by the uniqueness requirement
in the definition. Coproducts of pairs, pushouts, and coequalizers are
examples of colimits. The colimit over an empty diagram is an initial object
of $\mathcal{C}$. In the category of sets all colimits exist.

\begin{remark}
\label{remark-diagram-small}
The index category of a (co)limit will never be allowed to have
a proper class of objects. In this project it means that
it cannot be one of the categories listed in
Remark \ref{remark-big-categories}
\end{remark}

\begin{remark}
\label{remark-limit-colim}
We often write $\lim_i M_i$, $\colim_i M_i$,
$\lim_{i\in \mathcal{I}} M_i$, or $\colim_{i\in \mathcal{I}} M_i$
instead of the versions indexed by $\mathcal{I}$.
Using this notation, and using the description of
limits and colimits of sets in Section \ref{section-limit-sets}
below, we can say the following.
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram.
\begin{enumerate}
\item The object $\lim_i M_i$ if it exists satisfies the following property
$$
\Mor_\mathcal{C}(W, \lim_i M_i)
=
\lim_i \Mor_\mathcal{C}(W, M_i)
$$
where the limit on the right takes place in the category of sets.
\item The object $\colim_i M_i$ if it
exists satisfies the following property
$$
\Mor_\mathcal{C}(\colim_i M_i, W)
=
\lim_{i\in \mathcal{I}^\text{opp}} \Mor_\mathcal{C}(M_i, W)
$$
where on the right we have the limit over the opposite category
with value in the category of sets.
\end{enumerate}
By the Yoneda lemma (and its dual) this formula completely determines the
limit, respectively the colimit.
\end{remark}

\noindent
As an application of the notions of limits and colimits
we define products and coproducts.

\begin{definition}
\label{definition-product}
Suppose that $I$ is a set, and suppose given for every $i \in I$ an
object $M_i$ of the category $\mathcal{C}$. A {\it product}
$\prod_{i\in I} M_i$ is by definition $\lim_\mathcal{I} M$
(if it exists)
where $\mathcal{I}$ is the category having only identities as
morphisms and having the elements of $I$ as objects.
\end{definition}

\noindent
An important special case is where $I = \emptyset$ in which case the
product is a final object of the category.
The morphisms $p_i : \prod M_i \to M_i$ are called the
{\it projection morphisms}.

\begin{definition}
\label{definition-coproduct}
Suppose that $I$ is a set, and suppose given for every $i \in I$ an
object $M_i$ of the category $\mathcal{C}$. A {\it coproduct}
$\coprod_{i\in I} M_i$ is by definition $\colim_\mathcal{I} M$
(if it exists) where $\mathcal{I}$ is the category having only
identities as morphisms and having the elements of $I$ as objects.
\end{definition}

\noindent
An important special case is where $I = \emptyset$ in which case the
coproduct is an initial object of the category.
Note that the coproduct comes equipped with morphisms
$M_i \to \coprod M_i$. These are sometimes called the
{\it coprojections}.

\begin{lemma}
\label{lemma-functorial-colimit}
Suppose that $M : \mathcal{I} \to \mathcal{C}$,
and $N : \mathcal{J} \to \mathcal{C}$ are diagrams
whose colimits exist. Suppose
$H : \mathcal{I} \to \mathcal{J}$ is
a functor, and suppose $t : M \to N \circ H$
is a transformation of functors.
Then there is a unique morphism
$$
\theta :
\colim_\mathcal{I} M
\longrightarrow
\colim_\mathcal{J} N
$$
such that all the diagrams
$$
\xymatrix{
M_i \ar[d]_{t_i} \ar[r]
&
\colim_\mathcal{I} M \ar[d]^{\theta}
\\
N_{H(i)} \ar[r]
&
\colim_\mathcal{J} N
}
$$
commute.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-functorial-limit}
Suppose that $M : \mathcal{I} \to \mathcal{C}$,
and $N : \mathcal{J} \to \mathcal{C}$ are diagrams
whose limits exist. Suppose $H : \mathcal{I} \to \mathcal{J}$ is
a functor, and suppose $t : N \circ H \to M$
is a transformation of functors.
Then there is a unique morphism
$$
\theta :
\lim_\mathcal{J} N
\longrightarrow
\lim_\mathcal{I} M
$$
such that all the diagrams
$$
\xymatrix{
\lim_\mathcal{J} N \ar[d]^{\theta} \ar[r]
&
N_{H(i)} \ar[d]_{t_i}
\\
\lim_\mathcal{I} M \ar[r]
&
M_i
}
$$
commute.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


\begin{lemma}
\label{lemma-colimits-commute}
Let $\mathcal{I}$, $\mathcal{J}$ be index categories.
Let $M : \mathcal{I} \times \mathcal{J} \to \mathcal{C}$ be a functor.
We have
$$
\colim_i \colim_j M_{i, j}
=
\colim_{i, j} M_{i, j}
=
\colim_j \colim_i M_{i, j}
$$
provided all the indicated colimits exist. Similar for limits.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-limits-products-equalizers}
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram.
Write $I = \Ob(\mathcal{I})$ and $A = \text{Arrow}(\mathcal{I})$.
Denote $s, t : A \to I$ the source and target maps.
Suppose that $\prod_{i \in I} M_i$ and $\prod_{a \in A} M_{t(a)}$
exist. Suppose that the equalizer of
$$
\xymatrix{
\prod_{i \in I} M_i
\ar@<1ex>[r]^\phi \ar@<-1ex>[r]_\psi
&
\prod_{a \in A} M_{t(a)}
}
$$
exists, where the morphisms are determined by their components
as follows: $p_a \circ \psi = M(a) \circ p_{s(a)}$
and $p_a \circ \phi = p_{t(a)}$. Then this equalizer is the
limit of the diagram.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


\begin{lemma}
\label{lemma-colimits-coproducts-coequalizers}
\begin{slogan}
If all coproducts and coequalizers exist, all colimits exist.
\end{slogan}
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram.
Write $I = \Ob(\mathcal{I})$ and $A = \text{Arrow}(\mathcal{I})$.
Denote $s, t : A \to I$ the source and target maps.
Suppose that $\coprod_{i \in I} M_i$ and $\coprod_{a \in A} M_{s(a)}$
exist. Suppose that the coequalizer of
$$
\xymatrix{
\coprod_{a \in A} M_{s(a)}
\ar@<1ex>[r]^\phi \ar@<-1ex>[r]_\psi
&
\coprod_{i \in I} M_i
}
$$
exists, where the morphisms are determined by their components
as follows: The component $M_{s(a)}$ maps via $\psi$
to the component $M_{t(a)}$ via the morphism $a$.
The component $M_{s(a)}$ maps via $\phi$ to the component
$M_{s(a)}$ by the identity morphism. Then this coequalizer is the
colimit of the diagram.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}







\section{Limits and colimits in the category of sets}
\label{section-limit-sets}

\noindent
Not only do limits and colimits exist in $\textit{Sets}$
but they are also easy to describe. Namely, let $M : \mathcal{I}
\to \textit{Sets}$, $i \mapsto M_i$ be a diagram of sets.
Denote $I = \Ob(\mathcal{I})$.
The limit is described as
$$
\lim_\mathcal{I} M
=
\{
(m_i)_{i\in I} \in \prod\nolimits_{i\in I} M_i
\mid
\forall \phi : i \to i' \text{ in }\mathcal{I},
M(\phi)(m_i) = m_{i'}
\}.
$$
So we think of an element of the limit as a compatible system of elements
of all the sets $M_i$.

\medskip\noindent
On the other hand, the colimit is
$$
\colim_\mathcal{I} M
=
(\coprod\nolimits_{i\in I} M_i)/\sim
$$
where the equivalence relation $\sim$ is the equivalence relation
generated by setting $m_i \sim m_{i'}$ if $m_i \in M_i$,
$m_{i'} \in M_{i'}$ and $M(\phi)(m_i) = m_{i'}$ for some
$\phi : i \to i'$. In other words, $m_i \in M_i$
and $m_{i'} \in M_{i'}$ are equivalent if there is a
chain of morphisms in $\mathcal{I}$
$$
\xymatrix{
&
i_1 \ar[ld] \ar[rd] & &
i_3 \ar[ld] & &
i_{2n-1} \ar[rd] & \\
i = i_0 & &
i_2 & &
\ldots & &
i_{2n} = i'
}
$$
and elements $m_{i_j} \in M_{i_j}$ mapping to each other under
the maps $M_{i_{2k-1}} \to M_{i_{2k-2}}$ and $M_{i_{2k-1}}
\to M_{i_{2k}}$ induced from the maps in $\mathcal{I}$ above.

\medskip\noindent
This is not a very pleasant type of object to work with.
But if the diagram is filtered then it is much easier to
describe. We will explain this in Section \ref{section-directed-colimits}.



\section{Connected limits}
\label{section-connected-limits}

\noindent
A (co)limit is called connected if its index category is connected.

\begin{definition}
\label{definition-category-connected}
We say that a category $\mathcal{I}$ is {\it connected}
if the equivalence relation generated by
$x \sim y \Leftrightarrow \Mor_\mathcal{I}(x, y) \not = \emptyset$
has exactly one equivalence class.
\end{definition}

\noindent
Here we follow the convention of
Topology, Definition \ref{topology-definition-connected-components}
that connected spaces are nonempty.
The following in some vague sense characterizes connected limits.

\begin{lemma}
\label{lemma-connected-limit-over-X}
Let $\mathcal{C}$ be a category.
Let $X$ be an object of $\mathcal{C}$.
Let $M : \mathcal{I} \to \mathcal{C}/X$ be a diagram
in the category of objects over $X$.
If the index category $\mathcal{I}$ is connected
and the limit of $M$ exists in $\mathcal{C}/X$,
then the limit of the composition
$\mathcal{I} \to \mathcal{C}/X \to \mathcal{C}$
exists and is the same.
\end{lemma}

\begin{proof}
Let $M \to X$ be an object representing the limit in $\mathcal{C}/X$.
Consider the functor
$$
W \longmapsto \lim_i \Mor_\mathcal{C}(W, M_i).
$$
Let $(\varphi_i)$ be an element of the set on the right.
Since each $M_i$ comes equipped with a morphism $s_i : M_i \to X$ we
get morphisms $f_i = s_i \circ \varphi_i : W \to X$. But as $\mathcal{I}$
is connected we see that all $f_i$ are equal. Since $\mathcal{I}$
is nonempty there is at least one $f_i$.
Hence this common value $W \to X$ defines the structure of an
object of $W$ in $\mathcal{C}/X$ and $(\varphi_i)$ defines is an
element of $\lim_i \Mor_{\mathcal{C}/X}(W, M_i)$.
Thus we obtain a unique morphism $\phi : W \to M$ such that
$\varphi_i$ is the composition of $\phi$ with $M \to M_i$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-connected-colimit-under-X}
Let $\mathcal{C}$ be a category.
Let $X$ be an object of $\mathcal{C}$.
Let $M : \mathcal{I} \to X/\mathcal{C}$ be a diagram
in the category of objects under $X$.
If the index category $\mathcal{I}$ is connected
and the colimit of $M$ exists in $X/\mathcal{C}$,
then the colimit of the composition
$\mathcal{I} \to X/\mathcal{C} \to \mathcal{C}$
exists and is the same.
\end{lemma}

\begin{proof}
Omitted. Hint: This lemma is dual to Lemma \ref{lemma-connected-limit-over-X}.
\end{proof}




\section{Cofinal and initial categories}
\label{section-cofinal}

\noindent
In the literature sometimes the word ``final'' is used instead of cofinal
in the following definition.

\begin{definition}
\label{definition-cofinal}
Let $H : \mathcal{I} \to \mathcal{J}$ be a functor between categories.
We say {\it $\mathcal{I}$ is cofinal in $\mathcal{J}$} or that
$H$ is {\it cofinal} if
\begin{enumerate}
\item for all $y \in \Ob(\mathcal{J})$ there exists a
$x \in \Ob(\mathcal{I})$ and a morphism $y \to H(x)$, and
\item given $y \in \Ob(\mathcal{J})$, $x, x' \in \Ob(\mathcal{I})$
and morphisms $y \to H(x)$ and $y \to H(x')$ there exists a sequence
of morphisms
$$
x = x_0 \leftarrow x_1 \rightarrow x_2 \leftarrow x_3 \rightarrow \ldots
\rightarrow x_{2n} = x'
$$
in $\mathcal{I}$ and morphisms $y \to H(x_i)$ in $\mathcal{J}$
such that the diagrams
$$
\xymatrix{
& y \ar[ld] \ar[d] \ar[rd] \\
H(x_{2k}) & H(x_{2k + 1}) \ar[l] \ar[r] & H(x_{2k + 2})
}
$$
commute for $k = 0, \ldots, n - 1$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-cofinal}
Let $H : \mathcal{I} \to \mathcal{J}$ be a functor of categories. Assume
$\mathcal{I}$ is cofinal in $\mathcal{J}$. Then for every diagram
$M : \mathcal{J} \to \mathcal{C}$ we have a canonical isomorphism
$$
\colim_\mathcal{I} M \circ H
=
\colim_\mathcal{J} M
$$
if either side exists.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-initial}
Let $H : \mathcal{I} \to \mathcal{J}$ be a functor between categories.
We say {\it $\mathcal{I}$ is initial in $\mathcal{J}$} or that
$H$ is {\it initial} if
\begin{enumerate}
\item for all $y \in \Ob(\mathcal{J})$ there exists a
$x \in \Ob(\mathcal{I})$ and a morphism $H(x) \to y$,
\item for any $y \in \Ob(\mathcal{J})$, $x , x' \in \Ob(\mathcal{I})$ and
morphisms $H(x) \to y$, $H(x') \to y$ in $\mathcal{J}$
there exists a sequence of morphisms
$$
x = x_0 \leftarrow x_1 \rightarrow x_2 \leftarrow x_3 \rightarrow \ldots
\rightarrow x_{2n} = x'
$$
in $\mathcal{I}$ and morphisms $H(x_i) \to y$ in $\mathcal{J}$
such that the diagrams
$$
\xymatrix{
H(x_{2k}) \ar[rd] &
H(x_{2k + 1}) \ar[l] \ar[r] \ar[d] &
H(x_{2k + 2}) \ar[ld] \\
& y
}
$$
commute for $k = 0, \ldots, n - 1$.
\end{enumerate}
\end{definition}

\noindent
This is just the dual notion to ``cofinal'' functors.

\begin{lemma}
\label{lemma-initial}
Let $H : \mathcal{I} \to \mathcal{J}$ be a functor of categories.
Assume $\mathcal{I}$ is initial in $\mathcal{J}$.
Then for every diagram $M : \mathcal{J} \to \mathcal{C}$ we
have a canonical isomorphism
$$
\lim_\mathcal{I} M \circ H = \lim_\mathcal{J} M
$$
if either side exists.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimit-constant-connected-fibers}
Let $F : \mathcal{I} \to \mathcal{I}'$ be a functor.
Assume
\begin{enumerate}
\item the fibre categories (see
Definition \ref{definition-fibre-category})
of $\mathcal{I}$ over $\mathcal{I}'$ are all connected, and
\item for every morphism $\alpha' : x' \to y'$ in $\mathcal{I}'$ there
exist a morphism $\alpha : x \to y$ in $\mathcal{I}$ such that
$F(\alpha) = \alpha'$.
\end{enumerate}
Then for every diagram $M : \mathcal{I}' \to \mathcal{C}$
the colimit $\colim_\mathcal{I} M \circ F$ exists if and only
if $\colim_{\mathcal{I}'} M$ exists and if so these colimits
agree.
\end{lemma}

\begin{proof}
One can prove this by showing that $\mathcal{I}$ is cofinal in
$\mathcal{I}'$ and applying Lemma \ref{lemma-cofinal}.
But we can also prove it directly as follows.
It suffices to show that for any object $T$ of $\mathcal{C}$ we have
$$
\lim_{\mathcal{I}^{opp}} \Mor_\mathcal{C}(M_{F(i)}, T)
=
\lim_{(\mathcal{I}')^{opp}} \Mor_\mathcal{C}(M_{i'}, T)
$$
If $(g_{i'})_{i' \in \Ob(\mathcal{I}')}$ is an element of
the right hand side, then setting $f_i = g_{F(i)}$ we obtain an
element $(f_i)_{i \in \Ob(\mathcal{I})}$ of the left hand side.
Conversely, let $(f_i)_{i \in \Ob(\mathcal{I})}$ be an element of the
left hand side. Note that on each (connected)
fibre category $\mathcal{I}_{i'}$ the functor $M \circ F$
is constant with value $M_{i'}$. Hence the morphisms
$f_i$ for $i \in \Ob(\mathcal{I})$ with $F(i) = i'$
are all the same and determine a well defined morphism
$g_{i'} : M_{i'} \to T$. By assumption (2) the collection
$(g_{i'})_{i' \in \Ob(\mathcal{I}')}$ defines an element
of the right hand side.
\end{proof}

\begin{lemma}
\label{lemma-product-with-connected}
Let $\mathcal{I}$ and $\mathcal{J}$ be a categories and denote
$p : \mathcal{I} \times \mathcal{J} \to \mathcal{J}$ the projection.
If $\mathcal{I}$ is connected, then for a diagram
$M : \mathcal{J} \to \mathcal{C}$ the colimit $\colim_\mathcal{J} M$ exists
if and only if $\colim_{\mathcal{I} \times \mathcal{J}} M \circ p$ exists and
if so these colimits are equal.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-colimit-constant-connected-fibers}.
\end{proof}






\section{Finite limits and colimits}
\label{section-finite-limits}

\noindent
A {\it finite} (co)limit is a (co)limit whose diagram category is finite,
i.e., the diagram category has finitely many objects and finitely many
morphisms. A (co)limit is called {\it nonempty} if the index category is
nonempty. A (co)limit is called {\it connected} if the index category is
connected, see
Definition \ref{definition-category-connected}.
It turns out that there are ``enough'' finite diagram categories.

\begin{lemma}
\label{lemma-finite-diagram-category}
Let $\mathcal{I}$ be a category with
\begin{enumerate}
\item $\Ob(\mathcal{I})$ is finite, and
\item there exist finitely many morphisms
$f_1, \ldots, f_m \in \text{Arrows}(\mathcal{I})$ such
that every morphism of $\mathcal{I}$ is a composition
$f_{j_1} \circ f_{j_2} \circ \ldots \circ f_{j_k}$.
\end{enumerate}
Then there exists a functor $F : \mathcal{J} \to \mathcal{I}$
such that
\begin{enumerate}
\item[(a)] $\mathcal{J}$ is a finite category, and
\item[(b)] for any diagram $M : \mathcal{I} \to \mathcal{C}$ the
(co)limit of $M$ over $\mathcal{I}$ exists if and only if
the (co)limit of $M \circ F$ over $\mathcal{J}$ exists and in this case
the (co)limits are canonically isomorphic.
\end{enumerate}
Moreover, $\mathcal{J}$ is connected (resp.\ nonempty) if and only if
$\mathcal{I}$ is so.
\end{lemma}

\begin{proof}
Say $\Ob(\mathcal{I}) = \{x_1, \ldots, x_n\}$.
Denote $s, t : \{1, \ldots, m\} \to \{1, \ldots, n\}$ the functions
such that $f_j : x_{s(j)} \to x_{t(j)}$.
We set $\Ob(\mathcal{J}) = \{y_1, \ldots, y_n, z_1, \ldots, z_n\}$
Besides the identity morphisms we introduce morphisms
$g_j : y_{s(j)} \to z_{t(j)}$, $j = 1, \ldots, m$ and morphisms
$h_i : y_i \to z_i$, $i = 1, \ldots, n$. Since all of the nonidentity
morphisms in $\mathcal{J}$ go from a $y$ to a $z$ there are no
compositions to define and no associativities to check.
Set $F(y_i) = F(z_i) = x_i$. Set $F(g_j) = f_j$ and $F(h_i) = \text{id}_{x_i}$.
It is clear that $F$ is a functor.
It is clear that $\mathcal{J}$ is finite.
It is clear that $\mathcal{J}$ is connected, resp.\ nonempty
if and only if $\mathcal{I}$ is so.

\medskip\noindent
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram.
Consider an object $W$ of $\mathcal{C}$ and morphisms
$q_i : W \to M(x_i)$ as in
Definition \ref{definition-limit}.
Then by taking $q_i : W \to M(F(y_i)) = M(F(z_i)) = M(x_i)$ we obtain
a family of maps as in
Definition \ref{definition-limit}
for the diagram $M \circ F$.
Conversely, suppose we are given maps
$qy_i : W \to M(F(y_i))$ and $qz_i : W \to M(F(z_i))$
as in
Definition \ref{definition-limit}
for the diagram $M \circ F$. Since
$$
M(F(h_i)) = \text{id} : M(F(y_i)) = M(x_i) \longrightarrow M(x_i) = M(F(z_i))
$$
we conclude that $qy_i = qz_i$ for all $i$. Set $q_i$ equal to this common
value. The compatibility of
$q_{s(j)} = qy_{s(j)}$ and $q_{t(j)} = qz_{t(j)}$ with the morphism
$M(f_j)$ guarantees that the family $q_i$ is compatible with all morphisms
in $\mathcal{I}$ as by assumption every such morphism is a composition
of the morphisms $f_j$. Thus we have found a canonical bijection
$$
\lim_{B \in \Ob(\mathcal{J})} \Mor_\mathcal{C}(W, M(F(B)))
=
\lim_{A \in \Ob(\mathcal{I})} \Mor_\mathcal{C}(W, M(A))
$$
which implies the statement on limits in the lemma. The statement on colimits
is proved in the same way (proof omitted).
\end{proof}

\begin{lemma}
\label{lemma-fibre-products-equalizers-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Connected finite limits exist in $\mathcal{C}$.
\item Equalizers and fibre products exist in $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since equalizers and fibre products are finite connected
limits we see that (1) implies (2). For the converse, let $\mathcal{I}$
be a finite connected diagram category. Let
$F : \mathcal{J} \to \mathcal{I}$
be the functor of diagram categories constructed in the proof of
Lemma \ref{lemma-finite-diagram-category}.
Then we see that we may replace $\mathcal{I}$ by $\mathcal{J}$.
The result is that we may assume that
$\Ob(\mathcal{I}) = \{x_1, \ldots, x_n\} \amalg \{y_1, \ldots, y_m\}$
with $n, m \geq 1$ such that all nonidentity morphisms in $\mathcal{I}$
are morphisms $f : x_i \to y_j$ for some $i$ and $j$.

\medskip\noindent
Suppose that $n > 1$. Since $\mathcal{I}$ is connected there
exist indices $i_1, i_2$ and $j_0$ and morphisms $a : x_{i_1} \to y_{j_0}$
and $b : x_{i_2} \to y_{j_0}$. Consider the category
$$
\mathcal{I}' =
\{x\} \amalg \{x_1, \ldots, \hat x_{i_1}, \ldots, \hat x_{i_2}, \ldots x_n\}
\amalg \{y_1, \ldots, y_m\}
$$
with
$$
\Mor_{\mathcal{I}'}(x, y_j) = \Mor_\mathcal{I}(x_{i_1}, y_j)
\amalg \Mor_\mathcal{I}(x_{i_2}, y_j)
$$
and all other morphism sets the same as in $\mathcal{I}$. For any functor
$M : \mathcal{I} \to \mathcal{C}$ we can construct a functor
$M' : \mathcal{I}' \to \mathcal{C}$ by setting
$$
M'(x) = M(x_{i_1}) \times_{M(a), M(y_j), M(b)} M(x_{i_2})
$$
and for a morphism $f' : x \to y_j$ corresponding to, say,
$f : x_{i_1} \to y_j$ we set $M'(f) = M(f) \circ \text{pr}_1$.
Then the functor $M$ has a limit if and only if the functor $M'$ has
a limit (proof omitted). Hence by induction we reduce to the case $n = 1$.

\medskip\noindent
If $n = 1$, then the limit of any $M : \mathcal{I} \to \mathcal{C}$ is
the successive equalizer of pairs of maps $x_1 \to y_j$ hence
exists by assumption.
\end{proof}

\begin{lemma}
\label{lemma-almost-finite-limits-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Nonempty finite limits exist in $\mathcal{C}$.
\item Products of pairs and equalizers exist in $\mathcal{C}$.
\item Products of pairs and fibre products exist in $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since products of pairs, fibre products, and equalizers are limits with
nonempty index categories we see that (1) implies both (2) and (3).
Assume (2). Then finite nonempty products and equalizers exist. Hence by
Lemma \ref{lemma-limits-products-equalizers}
we see that finite nonempty limits exist, i.e., (1) holds. Assume (3).
If $a, b : A \to B$ are morphisms of $\mathcal{C}$, then the
equalizer of $a, b$ is
$$
(A \times_{a, B, b} A)\times_{(pr_1, pr_2), A \times A, \Delta} A.
$$
Thus (3) implies (2), and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-finite-limits-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Finite limits exist in $\mathcal{C}$.
\item Finite products and equalizers exist.
\item The category has a final object and fibred products exist.
\end{enumerate}
\end{lemma}

\begin{proof}
Since products of pairs, fibre products, equalizers, and final objects
are limits over finite index categories we see that (1) implies both (2)
and (3). By
Lemma \ref{lemma-limits-products-equalizers}
above we see that (2) implies (1). Assume (3).
Note that the product $A \times B$ is the fibre product over the
final object. If $a, b : A \to B$ are morphisms of $\mathcal{C}$, then the
equalizer of $a, b$ is
$$
(A \times_{a, B, b} A)\times_{(pr_1, pr_2), A \times A, \Delta} A.
$$
Thus (3) implies (2) and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-push-outs-coequalizers-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Connected finite colimits exist in $\mathcal{C}$.
\item Coequalizers and pushouts exist in $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: This is dual to
Lemma \ref{lemma-fibre-products-equalizers-exist}.
\end{proof}

\begin{lemma}
\label{lemma-almost-finite-colimits-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Nonempty finite colimits exist in $\mathcal{C}$.
\item Coproducts of pairs and coequalizers exist in $\mathcal{C}$.
\item Coproducts of pairs and pushouts exist in $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: This is the dual of
Lemma \ref{lemma-almost-finite-limits-exist}.
\end{proof}

\begin{lemma}
\label{lemma-colimits-exist}
Let $\mathcal{C}$ be a category.
The following are equivalent:
\begin{enumerate}
\item Finite colimits exist in $\mathcal{C}$,
\item Finite coproducts and coequalizers exist in $\mathcal{C}$, and
\item The category has an initial object and pushouts exist.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: This is dual to Lemma \ref{lemma-finite-limits-exist}.
\end{proof}





\section{Filtered colimits}
\label{section-directed-colimits}

\noindent
Colimits are easier to compute or describe when they
are over a filtered diagram. Here is the definition.

\begin{definition}
\label{definition-directed}
We say that a diagram $M : \mathcal{I} \to \mathcal{C}$ is {\it directed},
or {\it filtered} if the following conditions hold:
\begin{enumerate}
\item the category $\mathcal{I}$ has at least one object,
\item for every pair of objects $x, y$ of $\mathcal{I}$
there exists an object $z$ and morphisms $x \to z$,
$y \to z$, and
\item for every pair of objects $x, y$ of $\mathcal{I}$
and every pair of morphisms $a, b : x \to y$ of $\mathcal{I}$
there exists a morphism $c : y \to z$ of $\mathcal{I}$
such that $M(c \circ a) = M(c \circ b)$ as morphisms in $\mathcal{C}$.
\end{enumerate}
We say that an index category $\mathcal{I}$ is {\it directed}, or
{\it filtered} if $\text{id} : \mathcal{I} \to \mathcal{I}$ is filtered
(in other words you erase the $M$ in part (3) above).
\end{definition}

\noindent
We observe that any diagram with filtered index category is filtered,
and this is how filtered colimits usually come about. In fact, if
$M : \mathcal{I} \to \mathcal{C}$ is a filtered diagram, then we
can factor $M$ as $\mathcal{I} \to \mathcal{I}' \to \mathcal{C}$
where $\mathcal{I}'$ is a filtered index category\footnote{Namely, let
$\mathcal{I}'$ have the same objects as $\mathcal{I}$ but
where $\Mor_{\mathcal{I}'}(x, y)$ is the quotient of $\Mor_\mathcal{I}(x, y)$
by the equivalence relation which identifies
$a, b : x \to y$ if $M(a) = M(b)$.}
such that $\colim_\mathcal{I} M$ exists if and only if
$\colim_{\mathcal{I}'} M'$ exists in which case the colimits are
canonically isomorphic.

\medskip\noindent
Suppose that $M : \mathcal{I} \to \textit{Sets}$ is a filtered diagram. In
this case we may describe the equivalence relation in the formula
$$
\colim_\mathcal{I} M
=
(\coprod\nolimits_{i\in I} M_i)/\sim
$$
simply as follows
$$
m_i \sim m_{i'}
\Leftrightarrow
\exists i'', \phi : i \to i'', \phi': i' \to i'',
M(\phi)(m_i) = M(\phi')(m_{i'}).
$$
In other words, two elements are equal in the colimit if and only if
they ``eventually become equal''.

\begin{lemma}
\label{lemma-directed-commutes}
Let $\mathcal{I}$ and $\mathcal{J}$ be index categories.
Assume that $\mathcal{I}$ is filtered and $\mathcal{J}$ is finite.
Let $M : \mathcal{I} \times \mathcal{J} \to \textit{Sets}$,
$(i, j) \mapsto M_{i, j}$ be a diagram of diagrams of sets.
In this case
$$
\colim_i \lim_j M_{i, j}
=
\lim_j \colim_i M_{i, j}.
$$
In particular, colimits over $\mathcal{I}$ commute with finite products,
fibre products, and equalizers of sets.
\end{lemma}

\begin{proof}
Omitted. In fact, it is a fun exercise to prove that a category is
filtered if and only if colimits over the category commute with finite
limits (into the category of sets).
\end{proof}

\noindent
We give a counter example to the lemma in
the case where $\mathcal{J}$ is infinite. Namely, let
$\mathcal{I}$ consist of $\mathbf{N} = \{1, 2, 3, \ldots\}$
with a unique morphism $i \to i'$ whenever $i \leq i'$.
Let $\mathcal{J}$ consist of the discrete category
$\mathbf{N} = \{1, 2, 3, \ldots\}$ (only morphisms are identities).
Let $M_{i, j} = \{1, 2, \ldots, i\}$ with obvious inclusion maps
$M_{i, j} \to M_{i', j}$ when $i \leq i'$. In this case
$\colim_i M_{i, j} = \mathbf{N}$ and hence
$$
\lim_j \colim_i M_{i, j}
=
\prod\nolimits_j \mathbf{N}
=
\mathbf{N}^\mathbf{N}
$$
On the other hand $\lim_j M_{i, j} = \prod\nolimits_j M_{i, j}$ and
hence
$$
\colim_i \lim_j M_{i, j}
=
\bigcup\nolimits_i \{1, 2, \ldots, i\}^{\mathbf{N}}
$$
which is smaller than the other limit.

\begin{lemma}
\label{lemma-cofinal-in-filtered}
Let $\mathcal{I}$ be a category. Let $\mathcal{J}$ be a full subcategory.
Assume that $\mathcal{I}$ is filtered. Assume also that for any object
$i$ of $\mathcal{I}$, there exists a morphism $i \to j$
to some object $j$ of $\mathcal{J}$. Then $\mathcal{J}$
is filtered and cofinal in $\mathcal{I}$.
\end{lemma}

\begin{proof}
Omitted. Pleasant exercise of the notions involved.
\end{proof}

\noindent
It turns out we sometimes need a more finegrained control over the
possible conditions one can impose on index categories. Thus we add
some lemmas on the possible things one can require.

\begin{lemma}
\label{lemma-preserve-products}
Let $\mathcal{I}$ be an index category, i.e., a category. Assume
that for every pair of objects $x, y$ of $\mathcal{I}$
there exists an object $z$ and morphisms $x \to z$ and $y \to z$.
Then colimits of diagrams of sets over $\mathcal{I}$
commute with finite nonempty products.
\end{lemma}

\begin{proof}
Let $M$ and $N$ be diagrams of sets over $\mathcal{I}$.
To prove the lemma we have to show that the canonical map
$$
\colim (M_i \times N_i) \longrightarrow \colim M_i \times \colim N_i
$$
is an isomorphism.
If $\mathcal{I}$ is empty, then this is true because the colimit
of sets over the empty category is the empty set.
If $\mathcal{I}$ is nonempty, then we construct a map
$\colim M_i \times \colim N_i \to \colim (M_i \times N_i)$ as follows.
Suppose that $m \in M_i$ and $n \in N_j$ give rise to elements
$s$ and $t$ of the respective colimits. By assumption we can find
$a : i \to k$ and $b : j \to k$
in $\mathcal{I}$. Then $(M(a)(m), N(b)(n))$ is an element of
$M_k \times N_k$ and we map $(s, t)$ to the corresponding element
of $\colim M_i \times N_i$. We omit the verification that this map
is well defined and that it is an inverse of the map displayed
above.
\end{proof}

\begin{lemma}
\label{lemma-colimits-abelian-as-sets}
Let $\mathcal{I}$ be an index category, i.e., a category. Assume
that for every pair of objects $x, y$ of $\mathcal{I}$
there exists an object $z$ and morphisms $x \to z$ and $y \to z$.
Let $M : \mathcal{I} \to \textit{Ab}$ be a diagram of abelian
groups over $\mathcal{I}$. Then the set underlying $\colim_i M_i$
is the colimit of $M$ viewed as a diagram of sets over $\mathcal{I}$.
\end{lemma}

\begin{proof}
In this proof all colimits are taken in the category of sets.
By Lemma \ref{lemma-preserve-products} we have
$\colim M_i \times \colim M_i = \colim (M_i \times M_i)$
hence we can use the maps $+ : M_i \times M_i \to M_i$
to define an addition map on $\colim M_i$. A straightforward
argument, which we omit, shows that the set $\colim M_i$ with this
addition is the colimit in the category of abelian groups.
\end{proof}

\begin{lemma}
\label{lemma-split-into-connected}
Let $\mathcal{I}$ be an index category, i.e., a category. Assume
that for every solid diagram
$$
\xymatrix{
x \ar[d] \ar[r] & y \ar@{..>}[d] \\
z \ar@{..>}[r] & w
}
$$
in $\mathcal{I}$ there exists an object $w$ and dotted arrows
making the diagram commute. Then $\mathcal{I}$ is a (possibly empty)
disjoint union of categories satisfying the condition above and
the condition of Lemma \ref{lemma-preserve-products}.
\end{lemma}

\begin{proof}
If $\mathcal{I}$ is the empty category, then the lemma is true.
Otherwise, we define a relation on objects of $\mathcal{I}$ by
saying that $x \sim y$ if there exists a $z$ and
morphisms $x \to z$ and $y \to z$. This is an equivalence
relation by the assumption of the lemma. Hence $\Ob(\mathcal{I})$
is a disjoint union of equivalence classes. Let $\mathcal{I}_j$
be the full subcategories corresponding to these equivalence classes.
Then $\mathcal{I} = \coprod \mathcal{I}_j$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-preserve-injective-maps}
Let $\mathcal{I}$ be an index category, i.e., a category. Assume
that for every solid diagram
$$
\xymatrix{
x \ar[d] \ar[r] & y \ar@{..>}[d] \\
z \ar@{..>}[r] & w
}
$$
in $\mathcal{I}$ there exists an object $w$ and dotted arrows
making the diagram commute. Then an injective morphism $M \to N$
of diagrams of sets (resp.\ abelian groups) over $\mathcal{I}$ gives
rise to an injective map $\colim M_i \to \colim N_i$ of sets
(resp.\ abelian groups).
\end{lemma}

\begin{proof}
We first show that it suffices to prove the lemma for the case of
a diagram of sets. Namely, by Lemma \ref{lemma-split-into-connected}
we can write $\mathcal{I} = \coprod \mathcal{I}_j$ where each
$\mathcal{I}_j$ satisfies the condition of the lemma as well as the
condition of Lemma \ref{lemma-preserve-products}.
Thus, if $M$ is a diagram of abelian groups over $\mathcal{I}$, then
$$
\colim_\mathcal{I} M =
\bigoplus\nolimits_j \colim_{\mathcal{I}_j} M|_{\mathcal{I}_j}
$$
It follows that it suffices to prove the result for the categories
$\mathcal{I}_j$. However, colimits of abelian groups over these categories 
are computed by the colimits of the underlying sets
(Lemma \ref{lemma-colimits-abelian-as-sets})
hence we reduce to the case of an injective map of diagrams of sets.

\medskip\noindent
Here we say that $M \to N$ is injective if all the maps $M_i \to N_i$
are injective. In fact, we will identify $M_i$ with the image of
$M_i \to N_i$, i.e., we will think of $M_i$ as a subset of $N_i$.
We will use the description of the colimits given in
Section \ref{section-limit-sets} without further mention.
Let $s, s' \in \colim M_i$ map to the same element of $\colim N_i$.
Say $s$ comes from an element $m$ of $M_i$ and $s'$ comes from an
element $m'$ of $M_{i'}$. Then we can find a sequence
$i = i_0, i_1, \ldots, i_n = i'$ of objects of $\mathcal{I}$
and morphisms
$$
\xymatrix{
&
i_1 \ar[ld] \ar[rd] & &
i_3 \ar[ld] & &
i_{2n-1} \ar[rd] & \\
i = i_0 & &
i_2 & &
\ldots & &
i_{2n} = i'
}
$$
and elements $n_{i_j} \in N_{i_j}$ mapping to each other under
the maps $N_{i_{2k-1}} \to N_{i_{2k-2}}$ and $N_{i_{2k-1}}
\to N_{i_{2k}}$ induced from the maps in $\mathcal{I}$ above
with $n_{i_0} = m$ and $n_{i_{2n}} = m'$. We will prove by induction
on $n$ that this implies $s = s'$. The base case $n = 0$ is trivial.
Assume $n \geq 1$. Using the assumption on $\mathcal{I}$
we find a commutative diagram
$$
\xymatrix{
& i_1 \ar[ld] \ar[rd] \\
i_0 \ar[rd] & & i_2 \ar[ld] \\
& w
}
$$
We conclude that $m$ and $n_{i_2}$ map to the same element of $N_w$
because both are the image of the element $n_{i_1}$.
In particular, this element is an element $m'' \in M_w$ which
gives rise to the same element as $s$ in $\colim M_i$.
Then we find the chain
$$
\xymatrix{
&
i_3 \ar[ld] \ar[rd] & &
i_5 \ar[ld] & &
i_{2n-1} \ar[rd] & \\
w & &
i_4 & &
\ldots & &
i_{2n} = i'
}
$$
and the elements $n_{i_j}$ for $j \geq 3$ which has a smaller length
than the chain we started with. This proves the induction step and the
proof of the lemma is complete.
\end{proof}



\begin{lemma}
\label{lemma-split-into-directed}
Let $\mathcal{I}$ be an index category, i.e., a category.
Assume
\begin{enumerate}
\item for every pair of morphisms $a : w \to x$ and $b : w \to y$
in $\mathcal{I}$ there exists an object $z$ and morphisms $c : x \to z$
and $d : y \to z$ such that $c \circ a = d \circ b$, and
\item for every pair of morphisms $a, b : x \to y$ there exists
a morphism $c : y \to z$ such that $c \circ a = c \circ b$.
\end{enumerate}
Then $\mathcal{I}$ is a (possibly empty) union
of disjoint filtered index categories $\mathcal{I}_j$.
\end{lemma}

\begin{proof}
If $\mathcal{I}$ is the empty category, then the lemma is true.
Otherwise, we define a relation on objects of $\mathcal{I}$ by
saying that $x \sim y$ if there exists a $z$ and
morphisms $x \to z$ and $y \to z$. This is an equivalence
relation by the first assumption of the lemma. Hence $\Ob(\mathcal{I})$
is a disjoint union of equivalence classes. Let $\mathcal{I}_j$
be the full subcategories corresponding to these equivalence classes.
The rest is clear from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-almost-directed-commutes-equalizers}
Let $\mathcal{I}$ be an index category satisfying the hypotheses of
Lemma \ref{lemma-split-into-directed} above. Then colimits over $\mathcal{I}$
commute with fibre products and equalizers in sets (and more generally
with finite connected limits).
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-split-into-directed}
we may write $\mathcal{I} = \coprod \mathcal{I}_j$ with each $\mathcal{I}_j$
filtered. By
Lemma \ref{lemma-directed-commutes}
we see that colimits of $\mathcal{I}_j$ commute with equalizers and
fibred products. Thus it suffices to show that equalizers and fibre products
commute with coproducts in the category of sets (including empty coproducts).
In other words, given a set $J$ and sets $A_j, B_j, C_j$ and set maps
$A_j \to B_j$, $C_j \to B_j$ for $j \in J$ we have to show that
$$
(\coprod\nolimits_{j \in J} A_j)
\times_{(\coprod\nolimits_{j \in J} B_j)}
(\coprod\nolimits_{j \in J} C_j)
=
\coprod\nolimits_{j \in J} A_j \times_{B_j} C_j
$$
and given $a_j, a'_j : A_j \to B_j$ that
$$
\text{Equalizer}(
\coprod\nolimits_{j \in J} a_j,
\coprod\nolimits_{j \in J} a'_j)
=
\coprod\nolimits_{j \in J}
\text{Equalizer}(a_j, a'_j)
$$
This is true even if $J = \emptyset$. Details omitted.
\end{proof}



\section{Cofiltered limits}
\label{section-codirected-limits}

\noindent
Limits are easier to compute or describe when they
are over a cofiltered diagram. Here is the definition.

\begin{definition}
\label{definition-codirected}
We say that a diagram $M : \mathcal{I} \to \mathcal{C}$ is {\it codirected}
or {\it cofiltered} if the following conditions hold:
\begin{enumerate}
\item the category $\mathcal{I}$ has at least one object,
\item for every pair of objects $x, y$ of $\mathcal{I}$
there exists an object $z$ and morphisms $z \to x$,
$z \to y$, and
\item for every pair of objects $x, y$ of $\mathcal{I}$
and every pair of morphisms $a, b : x \to y$ of $\mathcal{I}$
there exists a morphism $c : w \to x$ of $\mathcal{I}$
such that $M(a \circ c) = M(b \circ c)$ as morphisms in $\mathcal{C}$.
\end{enumerate}
We say that an index category $\mathcal{I}$ is {\it codirected}, or
{\it cofiltered} if $\text{id} : \mathcal{I} \to \mathcal{I}$ is
cofiltered (in other words you erase the $M$ in part (3) above).
\end{definition}

\noindent
We observe that any diagram with cofiltered index category is cofiltered,
and this is how this situation usually occurs.

\medskip\noindent
As an example of why cofiltered limits of sets are ``easier'' than
general ones, we mention the fact that a cofiltered diagram of finite
nonempty sets has nonempty limit (Lemma \ref{lemma-nonempty-limit}).
This result does not hold for a general limit of finite
nonempty sets.












\section{Limits and colimits over preordered sets}
\label{section-posets-limits}

\noindent
A special case of diagrams is given by systems over preordered sets.

\begin{definition}
\label{definition-directed-set}
Let $I$ be a set and let $\leq$ be a binary relation on $I$.
\begin{enumerate}
\item We say $\leq$ is a {\it preorder} if it is
transitive (if $i \leq j$ and $j \leq k$ then $i \leq k$) and
reflexive ($i \leq i$ for all $i \in I$).
\item A {\it preordered set} is a set endowed with a preorder.
\item A {\it directed set} is a preordered set $(I, \leq)$
such that $I$ is not empty and such that $\forall i, j \in I$,
there exists $k \in I$ with $i \leq k, j \leq k$.
\item We say $\leq$ is a {\it partial order} if it is a preorder
which is antisymmetric (if $i \leq j$ and $j \leq i$, then $i = j$).
\item A {\it partially ordered set} is a set endowed with a partial order.
\item A {\it directed partially ordered set} is a direct set
whose ordering is a partial order.
\end{enumerate}
\end{definition}

\noindent
It is customary to drop the $\leq$ from the notation when talking
about preordered sets, that is, one speaks of
the preordered set $I$ rather than of the preordered set $(I, \leq)$.
Given a preordered set $I$ the symbol $\geq$ is defined by
the rule $i \geq j \Leftrightarrow j \leq i$ for all $i, j \in I$.
The phrase ``partially ordered set'' is sometimes abbreviated to ``poset''.

\medskip\noindent
Given a preordered set $I$ we can construct a category: the objects are
the elements of $I$, there is exactly one morphism $i \to i'$
if $i \leq i'$, and otherwise none. Conversely, given a category $\mathcal{C}$
with at most one arrow between any two objects, the set
$\Ob(\mathcal{C})$ is endowed with a preorder defined by the rule
$x \leq y \Leftrightarrow \Mor_\mathcal{C}(x, y) \not = \emptyset$.

\begin{definition}
\label{definition-system-over-poset}
Let $(I, \leq)$ be a preordered set. Let $\mathcal{C}$ be a category.
\begin{enumerate}
\item A {\it system over $I$ in $\mathcal{C}$}, sometimes called a
{\it inductive system over $I$ in $\mathcal{C}$} is given by
objects $M_i$ of $\mathcal{C}$ and for every $i \leq i'$ a
morphism $f_{ii'} : M_i \to M_{i'}$ such that $f_{ii}
= \text{id}$ and such that $f_{ii''} = f_{i'i''} \circ f_{i i'}$
whenever $i \leq i' \leq i''$.
\item An {\it inverse system over $I$ in $\mathcal{C}$},
sometimes called a {\it projective system over $I$ in $\mathcal{C}$}
is given by objects $M_i$ of $\mathcal{C}$ and for every $i' \leq i$ a
morphism $f_{ii'} : M_i \to M_{i'}$ such that $f_{ii}
= \text{id}$ and such that $f_{ii''} = f_{i'i''} \circ f_{i i'}$
whenever $i'' \leq i' \leq i$. (Note reversal of inequalities.)
\end{enumerate}
We will say $(M_i, f_{ii'})$ is a (inverse) system over $I$ to
denote this. The maps $f_{ii'}$ are sometimes
called the {\it transition maps}.
\end{definition}

\noindent
In other words a system over $I$ is just a diagram
$M : \mathcal{I} \to \mathcal{C}$ where $\mathcal{I}$ is the category
we associated to $I$ above: objects are elements of $I$ and
there is a unique arrow $i \to i'$ in $\mathcal{I}$ if and only $i \leq i'$.
An inverse system is a diagram $M : \mathcal{I}^{opp} \to \mathcal{C}$.
From this point of view we could take (co)limits of any (inverse)
system over $I$. However, it is customary to take
{\it only colimits of systems over $I$} and
{\it only limits of inverse systems over $I$}.
More precisely: Given a system $(M_i, f_{ii'})$
over $I$ the colimit of the system
$(M_i, f_{ii'})$ is defined as
$$
\colim_{i \in I} M_i = \colim_\mathcal{I} M,
$$
i.e., as the colimit of the corresponding diagram.
Given a inverse system $(M_i, f_{ii'})$ over $I$ the limit
of the inverse system $(M_i, f_{ii'})$ is defined as
$$
\lim_{i \in I} M_i = \lim_{\mathcal{I}^{opp}} M,
$$
i.e., as the limit of the corresponding diagram.

\begin{remark}
\label{remark-preorder-versus-partial-order}
Let $I$ be a preordered set. From $I$ we can construct a canonical
partially ordered set $\overline{I}$ and an order preserving map
$\pi : I \to \overline{I}$. Namely, we can define an equivalence
relation $\sim$ on $I$ by the rule
$$
i \sim j \Leftrightarrow (i \leq j\text{ and }j \leq i).
$$
We set $\overline{I} = I/\sim$ and we let $\pi : I \to \overline{I}$
be the quotient map. Finally, $\overline{I}$ comes with a unique
partial ordering such that
$\pi(i) \leq \pi(j) \Leftrightarrow i \leq j$.
Observe that if $I$ is a directed set, then $\overline{I}$
is a directed partially ordered set.
Given an (inverse) system $N$ over $\overline{I}$ we obtain an
(inverse) system $M$ over $I$ by setting $M_i = N_{\pi(i)}$.
This construction defines a functor between the category
of inverse systems over $I$ and $\overline{I}$.
In fact, this is an equivalence.
The reason is that if $i \sim j$, then for any system
$M$ over $I$ the maps $M_i \to M_j$ and $M_j \to M_i$ are
mutually inverse isomorphisms. More precisely, choosing
a section $s : \overline{I} \to I$ of $\pi$ a quasi-inverse
of the functor above sends $M$ to $N$ with
$N_{\overline{i}} = M_{s(\overline{i})}$.
Finally, this correspondence is compatible with colimits of systems:
if $M$ and $N$ are related as above and
if either $\colim_{\overline{I}} N$ or $\colim_I M$ exists
then so does the other and
$\colim_{\overline{I}} N = \colim_I M$.
Similar results hold for inverse systems and limits of inverse systems.
\end{remark}

\noindent
The upshot of Remark \ref{remark-preorder-versus-partial-order}
is that while computing a colimit of a system or a limit of
an inverse system, we may always assume the preorder is a partial order.

\begin{definition}
\label{definition-directed-system}
Let $I$ be a preordered set. We say a system (resp.\ inverse system)
$(M_i, f_{ii'})$ is a
{\it directed system} (resp.\ {\it directed inverse system})
if $I$ is a directed set
(Definition \ref{definition-directed-set}): $I$ is nonempty and
for all $i_1, i_2 \in I$ there exists $i\in I$ such that
$i_1 \leq i$ and $i_2 \leq i$.
\end{definition}

\noindent
In this case the colimit is sometimes (unfortunately)
called the ``direct limit''. We will not use this last
terminology. It turns out that diagrams over a filtered
category are no more general than directed systems in the
following sense. Before we do so we discuss the difference
between

\begin{lemma}
\label{lemma-directed-category-system}
Let $\mathcal{I}$ be a filtered index category.
There exists a directed set $I$
and a system $(x_i, \varphi_{ii'})$ over $I$ in $\mathcal{I}$
with the following properties:
\begin{enumerate}
\item For every category $\mathcal{C}$ and every diagram
$M : \mathcal{I} \to \mathcal{C}$ with values in $\mathcal{C}$,
denote $(M(x_i), M(\varphi_{ii'}))$
the corresponding system over $I$. If
$\colim_{i \in I} M(x_i)$ exists then so does
$\colim_\mathcal{I} M$ and the transformation
$$
\theta :
\colim_{i \in I} M(x_i)
\longrightarrow
\colim_\mathcal{I} M
$$
of Lemma \ref{lemma-functorial-colimit} is an isomorphism.
\item For every category $\mathcal{C}$ and every diagram
$M : \mathcal{I}^{opp} \to \mathcal{C}$ in $\mathcal{C}$, denote
$(M(x_i), M(\varphi_{ii'}))$ the corresponding inverse system
over $I$. If $\lim_{i \in I} M(x_i)$ exists then so does
$\lim_\mathcal{I} M$ and the transformation
$$
\theta :
\lim_{\mathcal{I}^{opp}} M
\longrightarrow
\lim_{i \in I} M(x_i)
$$
of Lemma \ref{lemma-functorial-limit} is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
As explained in the text following
Definition \ref{definition-system-over-poset}, we may view
preordered sets as categories and systems as functors.
Throughout the proof, we will freely shift between these two points of view.
We prove the first statement by constructing a category
$\mathcal{I}_0$, corresponding to a directed set\footnote{In fact,
our construction will produce a directed partially ordered set.}, and a cofinal
functor $M_0 : \mathcal{I}_0 \to \mathcal{I}$. Then, by
Lemma \ref{lemma-cofinal}, the colimit of a diagram
$M : \mathcal{I} \to \mathcal{C}$ coincides with the
colimit of the diagram $M \circ M_0 | \mathcal{I}_0 \to \mathcal{C}$,
from which the statement follows. The second statement is dual to the
first and may be proved by interpreting a limit in $\mathcal{C}$ as
a colimit in $\mathcal{C}^{opp}$. We omit the details.

\medskip\noindent
A category $\mathcal{F}$ is called {\em finitely generated} if
there exists a finite set $F$ of arrows in $\mathcal{F}$, such that
each arrow in $\mathcal{F}$ may be obtained by composing
arrows from $F$. In particular, this implies that $\mathcal{F}$ has
finitely many objects. We start the proof by reducing to the case
when $\mathcal{I}$ has the property that every finitely generated
subcategory of $\mathcal{I}$ may be extended to a finitely
generated subcategory with a unique final object.

\medskip\noindent
Let $\omega$ denote the directed set of finite ordinals, which
we view as a filtered category. It is easy to verify that the
product category $\mathcal{I}\times \omega$ is also filtered,
and the projection
$\Pi : \mathcal{I} \times \omega \to \mathcal{I}$
is cofinal.

\medskip\noindent
Now let $\mathcal{F}$ be any finitely generated
subcategory of $\mathcal{I}\times \omega$.
By using the axioms of a filtered category and a simple induction
argument on a finite set of generators of $\mathcal{F}$,
we may construct a cocone $(\{f_i\}, i_\infty)$ in $\mathcal{I}$
for the diagram $\mathcal{F} \to \mathcal{I}$. That is, a morphism
$f_i : i \to i_\infty$ for every object $i$ in $\mathcal{F}$
such that for each arrow $f : i \to i'$ in $\mathcal{F}$
we have $f_i = f\circ f_{i'}$. We can also choose $i_\infty$ such
that there are no arrows from $i_\infty$ to an object in $\mathcal{F}$.
This is possible since
we may always post-compose the arrows $f_i$ with an arrow
which is the identity on the $\mathcal{I}$-component and
strictly increasing on the $\omega$-component.
Now let $\mathcal{F}^+$ denote the category consisting of all
objects and arrows in $\mathcal{F}$
together with the object $i_\infty$, the identity
arrow $\text{id}_{i_\infty}$ and the arrows $f_i$.
Since there are no arrows from $i_\infty$ in $\mathcal{F}^+$
to any object of $\mathcal{F}$, the arrow set in $\mathcal{F}^+$
is closed under composition, so $\mathcal{F}^+$ is indeed
a category. By construction, it is a finitely
generated subcategory of $\mathcal{I}$ which has $i_\infty$ as
unique final object. Since, by Lemma \ref{lemma-cofinal},
the colimit of  any diagram $M : \mathcal{I} \to \mathcal{C}$
coincides with the colimit of $M\circ\Pi$ , this gives the desired
reduction.

\medskip\noindent
The set of all finitely generated subcategories of $\mathcal{I}$
with a unique final object is naturally ordered by inclusion.
We take $\mathcal{I}_0$ to be the category corresponding
to this set. We also have a functor
$M_0 : \mathcal{I}_0 \to \mathcal{I}$, which takes an
arrow $\mathcal{F} \subset \mathcal{F'}$ in
$\mathcal{I}_0$ to the unique map from the final object of
$\mathcal{F}$ to the final object of $\mathcal{F}'$.
Given any two finitely generated subcategories of
$\mathcal{I}$, the category generated by these two categories is
also finitely generated. By our assumption on $\mathcal{I}$, it is
also contained in a finitely generated subcategory of $\mathcal{I}$
with a unique final object. This shows that $\mathcal{I}_0$ is directed.

\medskip\noindent
Finally, we verify that $M_0$ is cofinal. Since any
object of $\mathcal{I}$ is the final object in the subcategory
consisting of only that object and its identity arrow, the functor
$M_0$ is surjective on objects. In particular, Condition (1) of
Definition \ref{definition-cofinal} is satisfied. Given
an object $i$ of $\mathcal{I}$, $\mathcal{F}_1, \mathcal{F}_2$ in
$\mathcal{I}_0$ and maps $\varphi_1 : i \to M_0(\mathcal{F}_1)$
and $\varphi_2 : i \to M_0(\mathcal{F}_2)$ in
$\mathcal{I}$, we can take $\mathcal{F}_{12}$ to be a finitely
generated category with a unique final object containing
$\mathcal{F}_1$, $\mathcal{F}_2$ and the morphisms $\varphi_1, \varphi_2$.
The resulting diagram commutes
$$
\xymatrix{
& M_0(\mathcal{F}_{12}) & \\
M_0(\mathcal{F}_{1}) \ar[ru] & & M_0(\mathcal{F}_{2}) \ar[lu] \\
& i \ar[lu] \ar[ru]
}
$$
since it lives in the category $\mathcal{F}_{12}$ and
$M_0(\mathcal{F}_{12})$ is final in
this category. Hence also Condition (2) is satisfied, which concludes
the proof.
\end{proof}

\begin{remark}
\label{remark-trick-needed}
Note that a finite directed set $(I, \geq)$ always has a greatest object
$i_\infty$. Hence any colimit of a system $(M_i, f_{ii'})$ over such a set
is trivial in the sense that the colimit equals $M_{i_\infty}$. In contrast,
a colimit indexed by a finite filtered category need not
be trivial. For instance, let $\mathcal{I}$ be the category with a single object
$i$ and a single non-trivial morphism $e$ satisfying $e = e \circ e$. The
colimit of a diagram $M : \mathcal{I} \to Sets$ is the image of the
idempotent $M(e)$. This illustrates that something like the trick of passing
to $\mathcal{I}\times \omega$ in the proof of
Lemma \ref{lemma-directed-category-system} is essential.
\end{remark}

\begin{lemma}
\label{lemma-nonempty-limit}
If $S : \mathcal{I} \to \textit{Sets}$ is a cofiltered diagram of sets
and all the $S_i$ are finite nonempty, then $\lim_i S_i$ is nonempty.
In other words, the limit of a directed inverse system of finite nonempty sets
is nonempty.
\end{lemma}

\begin{proof}
The two statements are equivalent by
Lemma \ref{lemma-directed-category-system}.
Let $I$ be a directed set and let $(S_i)_{i \in I}$
be an inverse system of finite nonempty sets over $I$.
Let us say that a {\it subsystem} $T$ is a family $T = (T_i)_{i \in I}$
of nonempty subsets $T_i \subset S_i$ such that $T_{i'}$ is mapped
into $T_i$ by the transition map $S_{i'} \to S_i$ for all $i' \geq i$.
Denote $\mathcal{T}$ the set of subsystems. We order $\mathcal{T}$
by inclusion. Suppose $T_\alpha$, $\alpha \in A$ is a totally ordered family
of elements of $\mathcal{T}$. Say $T_\alpha = (T_{\alpha, i})_{i \in I}$.
Then we can find a lower bound $T = (T_i)_{i \in I}$ by setting
$T_i = \bigcap_{\alpha \in A} T_{\alpha, i}$ which is manifestly a
finite nonempty subset of $S_i$ as all the $T_{\alpha, i}$ are nonempty
and as the $T_\alpha$ form a totally ordered family. Thus we may
apply Zorn's lemma to see that $\mathcal{T}$ has minimal elements.

\medskip\noindent
Let's analyze what a minimal element $T \in \mathcal{T}$ looks like.
First observe that the maps $T_{i'} \to T_i$ are all surjective.
Namely, as $I$ is a directed set and $T_i$ is finite,
the intersection $T'_i = \bigcap_{i' \geq i} \Im(T_{i'} \to T_i)$
is nonempty. Thus $T' = (T'_i)$ is a subsystem contained in $T$ and
by minimality $T' = T$. Finally, we claim that $T_i$ is a singleton
for each $i$. Namely, if $x \in T_i$, then we can define
$T'_{i'} = (T_{i'} \to T_i)^{-1}(\{x\})$ for $i' \geq i$ and
$T'_j = T_j$ if $j \not \geq i$. This is another subsystem as we've seen
above that the transition maps of the subsystem $T$ are surjective.
By minimality we see that $T = T'$ which indeed implies that $T_i$
is a singleton. This holds for every $i \in I$, hence we see that
$T_i = \{x_i\}$ for some $x_i \in S_i$ with $x_{i'} \mapsto x_i$
under the map $S_{i'} \to S_i$ for every $i' \geq i$. In other words,
$(x_i) \in \lim S_i$ and the lemma is proved.
\end{proof}






\section{Essentially constant systems}
\label{section-essentially-constant}

\noindent
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram in a category $\mathcal{C}$.
Assume the index category $\mathcal{I}$ is filtered. In this case
there are three successively stronger notions which pick out an object
$X$ of $\mathcal{C}$. The first is just
$$
X = \colim_{i \in \mathcal{I}} M_i.
$$
Then $X$ comes equipped with the coprojections $M_i \to X$.
A stronger condition would be to require that $X$ is the colimit and
that there exists an $i \in \mathcal{I}$ and a morphism $X \to M_i$ such
that the composition $X \to M_i \to X$ is $\text{id}_X$. A stronger condition
is the following.

\begin{definition}
\label{definition-essentially-constant-diagram}
Let $M : \mathcal{I} \to \mathcal{C}$ be a diagram in a category
$\mathcal{C}$.
\begin{enumerate}
\item Assume the index category $\mathcal{I}$ is filtered.
We say $M$ {\it is essentially constant} with {\it value} $X$ if
$X = \colim_i M_i$ and there exists an $i \in \mathcal{I}$
and a morphism $X \to M_i$ such that
\begin{enumerate}
\item $X \to M_i \to X$ is $\text{id}_X$, and
\item for all $j$ there exist $k$ and morphisms $i \to k$ and $j \to k$
such that the morphism $M_j \to M_k$ equals the composition
$M_j \to X \to M_i \to M_k$.
\end{enumerate}
\item Assume the index category $\mathcal{I}$ is cofiltered. We say
$M$ is {\it essentially constant} with {\it value} $X$ if
$X = \lim_i M_i$ and there exists an $i \in \mathcal{I}$
and a morphism $M_i \to X$ such that
\begin{enumerate}
\item $X \to M_i \to X$ is $\text{id}_X$, and
\item for all $j$ there exist $k$ and morphisms $k \to i$ and $k \to j$
such that the morphism $M_k \to M_j$ equals the composition
$M_k \to M_i \to X \to M_j$.
\end{enumerate}
\end{enumerate}
\end{definition}

\noindent
Which of the two versions is meant will be clear from context. If there is
any confusion we will distinguish between these by saying that the first
version means $M$ is essentially constant as an {\it ind-object}, and in
the second case we will say it is essentially constant as a {\it pro-object}.
This terminology is further explained in
Remarks \ref{remark-ind-category} and \ref{remark-pro-category}.
In fact we will often use the terminology ``essentially constant system''
which formally speaking is only defined for systems over directed sets.

\begin{definition}
\label{definition-essentially-constant-system}
Let $\mathcal{C}$ be a category. A directed system
$(M_i, f_{ii'})$ is an {\it essentially constant system}
if $M$ viewed as a functor $I \to \mathcal{C}$
defines an essentially constant diagram. A directed inverse system
$(M_i, f_{ii'})$ is an {\it essentially constant inverse system} if
$M$ viewed as a functor $I^{opp} \to \mathcal{C}$ defines an
essentially constant inverse diagram.
\end{definition}

\noindent
If $(M_i, f_{ii'})$ is an essentially constant system and the morphisms
$f_{ii'}$ are monomorphisms, then for all $i \leq i'$ sufficiently large the
morphisms $f_{ii'}$ are isomorphisms. In general this need not be the
case however. An example is the system
$$
\mathbf{Z}^2 \to \mathbf{Z}^2 \to \mathbf{Z}^2 \to \ldots
$$
with maps given by $(a, b) \mapsto (a + b, 0)$. This system is essentially
constant with value $\mathbf{Z}$. A non-example is to let
$M = \bigoplus_{n \geq 0} \mathbf{Z}$ and to let $S : M \to M$ be the
shift operator $(a_0, a_1, \ldots) \mapsto (a_1, a_2, \ldots)$. In this
case the system $M \to M \to M \to \ldots$ with transition maps $S$
has colimit $0$ and the composition $0 \to M \to 0$ is the identity,
but the system is not essentially constant.

\begin{remark}
\label{remark-ind-category}
Let $\mathcal{C}$ be a category. There exists a big category
$\text{Ind-}\mathcal{C}$ of {\it ind-objects of} $\mathcal{C}$.
Namely, if $F : \mathcal{I} \to \mathcal{C}$ and
$G : \mathcal{J} \to \mathcal{C}$ are filtered diagrams in $\mathcal{C}$,
then we can define
$$
\Mor_{\text{Ind-}\mathcal{C}}(F, G) =
\lim_i \colim_j \Mor_\mathcal{C}(F(i), G(j)).
$$
There is a canonical functor $\mathcal{C} \to \text{Ind-}\mathcal{C}$
which maps $X$ to the {\it constant system} on $X$. This is a fully
faithful embedding. In this language one sees that a diagram $F$ is
essentially constant if and only $F$ is isomorphic to a constant system.
If we ever need this material, then we will formulate this into a lemma
and prove it here.
\end{remark}

\begin{remark}
\label{remark-pro-category}
Let $\mathcal{C}$ be a category. There exists a big category
$\text{Pro-}\mathcal{C}$ of {\it pro-objects} of $\mathcal{C}$.
Namely, if $F : \mathcal{I} \to \mathcal{C}$ and
$G : \mathcal{J} \to \mathcal{C}$ are cofiltered diagrams in $\mathcal{C}$,
then we can define
$$
\Mor_{\text{Pro-}\mathcal{C}}(F, G) =
\lim_j \colim_i \Mor_\mathcal{C}(F(i), G(j)).
$$
There is a canonical functor $\mathcal{C} \to \text{Pro-}\mathcal{C}$
which maps $X$ to the {\it constant system} on $X$. This is a fully
faithful embedding. In this language one sees that a diagram $F$ is
essentially constant if and only $F$ is isomorphic to a constant system.
If we ever need this material, then we will formulate this into a lemma
and prove it here.
\end{remark}

\begin{lemma}
\label{lemma-image-essentially-constant}
Let $\mathcal{C}$ be a category. Let $M : \mathcal{I} \to \mathcal{C}$
be a diagram with filtered (resp.\ cofiltered) index category $\mathcal{I}$.
Let $F : \mathcal{C} \to \mathcal{D}$ be a functor.
If $M$ is essentially constant as an ind-object (resp.\ pro-object),
then so is $F \circ M : \mathcal{I} \to \mathcal{D}$.
\end{lemma}

\begin{proof}
If $X$ is a value for $M$, then it follows immediately from the
definition that $F(X)$ is a value for $F \circ M$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-essentially-constant-ind}
Let $\mathcal{C}$ be a category. Let $M : \mathcal{I} \to \mathcal{C}$
be a diagram with filtered index category $\mathcal{I}$.
The following are equivalent
\begin{enumerate}
\item $M$ is an essentially constant ind-object, and
\item $X = \colim_i M_i$ exists and for any $W$ in $\mathcal{C}$
the map
$$
\colim_i \Mor_\mathcal{C}(W, M_i) \longrightarrow
\Mor_\mathcal{C}(W, X)
$$
is bijective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2) holds. Then $\text{id}_X \in \Mor_\mathcal{C}(X, X)$
comes from a morphism $X \to M_i$ for some $i$, i.e., $X \to M_i \to X$
is the identity. Then both maps
$$
\Mor_\mathcal{C}(W, X)
\longrightarrow
\colim_i \Mor_\mathcal{C}(W, M_i)
\longrightarrow
\Mor_\mathcal{C}(W, X)
$$
are bijective for all $W$ where the first one is induced by the morphism
$X \to M_i$ we found above, and the composition is the identity. This means
that the composition
$$
\colim_i \Mor_\mathcal{C}(W, M_i)
\longrightarrow
\Mor_\mathcal{C}(W, X)
\longrightarrow
\colim_i \Mor_\mathcal{C}(W, M_i)
$$
is the identity too. Setting $W = M_j$ and starting with $\text{id}_{M_j}$
in the colimit, we see that $M_j \to X \to M_i \to M_k$ is equal to
$M_j \to M_k$ for some $k$ large enough. This proves (1) holds.
The proof of (1) $\Rightarrow$ (2) is omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-essentially-constant-pro}
Let $\mathcal{C}$ be a category. Let $M : \mathcal{I} \to \mathcal{C}$
be a diagram with cofiltered index category $\mathcal{I}$.
The following are equivalent
\begin{enumerate}
\item $M$ is an essentially constant pro-object, and
\item $X = \lim_i M_i$ exists and for any $W$ in $\mathcal{C}$
the map
$$
\colim_{i \in \mathcal{I}^{opp}} \Mor_\mathcal{C}(M_i, W)
\longrightarrow
\Mor_\mathcal{C}(X, W)
$$
is bijective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2) holds. Then $\text{id}_X \in \Mor_\mathcal{C}(X, X)$
comes from a morphism $M_i \to X$ for some $i$, i.e., $X \to M_i \to X$
is the identity. Then both maps
$$
\Mor_\mathcal{C}(X, W)
\longrightarrow
\colim_i \Mor_\mathcal{C}(M_i, W)
\longrightarrow
\Mor_\mathcal{C}(X, W)
$$
are bijective for all $W$ where the first one is induced by the morphism
$M_i \to X$ we found above, and the composition is the identity. This means
that the composition
$$
\colim_i \Mor_\mathcal{C}(M_i, W)
\longrightarrow
\Mor_\mathcal{C}(X, W)
\longrightarrow
\colim_i \Mor_\mathcal{C}(M_i, W)
$$
is the identity too. Setting $W = M_j$ and starting with $\text{id}_{M_j}$
in the colimit, we see that $M_k \to M_i \to X \to M_j$ is equal to
$M_k \to M_j$ for some $k$ large enough. This proves (1) holds.
The proof of (1) $\Rightarrow$ (2) is omitted.
\end{proof}

\begin{lemma}
\label{lemma-cofinal-essentially-constant}
Let $\mathcal{C}$ be a category. Let $H : \mathcal{I} \to \mathcal{J}$
be a functor of filtered index categories. If $H$ is cofinal, then
any diagram $M : \mathcal{J} \to \mathcal{C}$ is essentially constant
if and only if $M \circ H$ is essentially constant.
\end{lemma}

\begin{proof}
This follows formally from
Lemmas \ref{lemma-characterize-essentially-constant-ind} and
\ref{lemma-cofinal}.
\end{proof}

\begin{lemma}
\label{lemma-essentially-constant-over-product}
Let $\mathcal{I}$ and $\mathcal{J}$ be filtered categories and denote
$p : \mathcal{I} \times \mathcal{J} \to \mathcal{J}$ the projection.
Then $\mathcal{I} \times \mathcal{J}$ is filtered and a diagram
$M : \mathcal{J} \to \mathcal{C}$ is essentially constant if and only
if $M \circ p : \mathcal{I} \times \mathcal{J} \to \mathcal{C}$
is essentially constant.
\end{lemma}

\begin{proof}
We omit the verification that $\mathcal{I} \times \mathcal{J}$ is
filtered. The equivalence follows from
Lemma \ref{lemma-cofinal-essentially-constant}
because $p$ is cofinal (verification omitted).
\end{proof}

\begin{lemma}
\label{lemma-initial-essentially-constant}
Let $\mathcal{C}$ be a category. Let $H : \mathcal{I} \to \mathcal{J}$
be a functor of cofiltered index categories. If $H$ is initial, then
any diagram $M : \mathcal{J} \to \mathcal{C}$ is essentially constant
if and only if $M \circ H$ is essentially constant.
\end{lemma}

\begin{proof}
This follows formally from
Lemmas \ref{lemma-characterize-essentially-constant-pro},
\ref{lemma-initial}, \ref{lemma-cofinal}, and
the fact that if $\mathcal{I}$ is initial in $\mathcal{J}$,
then $\mathcal{I}^{opp}$ is cofinal in $\mathcal{J}^{opp}$.
\end{proof}





\section{Exact functors}
\label{section-exact-functor}


\begin{definition}
\label{definition-exact}
Let $F : \mathcal{A} \to \mathcal{B}$ be a functor.
\begin{enumerate}
\item Suppose all finite limits exist in $\mathcal{A}$.
We say $F$ is {\it left exact} if it commutes
with all finite limits.
\item Suppose all finite colimits exist in $\mathcal{A}$.
We say $F$ is {\it right exact} if it commutes
with all finite colimits.
\item We say $F$ is {\it exact} if it is both left and right
exact.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-characterize-left-exact}
Let $F : \mathcal{A} \to \mathcal{B}$ be a functor.
Suppose all finite limits exist in $\mathcal{A}$,
see Lemma \ref{lemma-finite-limits-exist}.
The following are equivalent:
\begin{enumerate}
\item $F$ is left exact,
\item $F$ commutes with finite products and equalizers, and
\item $F$ transforms a final object of $\mathcal{A}$
into a final object of $\mathcal{B}$, and commutes with fibre products.
\end{enumerate}
\end{lemma}

\begin{proof}
Lemma \ref{lemma-limits-products-equalizers} shows that (2) implies (1).
Suppose (3) holds. The fibre product over the final object is the product.
If $a, b : A \to B$ are morphisms of $\mathcal{A}$, then the
equalizer of $a, b$ is
$$
(A \times_{a, B, b} A)\times_{(pr_1, pr_2), A \times A, \Delta} A.
$$
Thus (3) implies (2). Finally (1) implies (3) because
the empty limit is a final object, and fibre products are limits.
\end{proof}


\section{Adjoint functors}
\label{section-adjoint}

\begin{definition}
\label{definition-adjoint}
Let $\mathcal{C}$, $\mathcal{D}$ be categories.
Let $u : \mathcal{C} \to \mathcal{D}$ and
$v : \mathcal{D} \to \mathcal{C}$ be functors.
We say that $u$ is a {\it left adjoint} of $v$, or that
$v$ is a {\it right adjoint} to $u$ if there are bijections
$$
\Mor_\mathcal{D}(u(X), Y)
\longrightarrow
\Mor_\mathcal{C}(X, v(Y))
$$
functorial in $X \in \Ob(\mathcal{C})$, and
$Y \in \Ob(\mathcal{D})$.
\end{definition}

\noindent
In other words, this means that there is a {\it given} isomorphism of functors
$\mathcal{C}^{opp} \times \mathcal{D} \to \textit{Sets}$ from
$\Mor_\mathcal{D}(u(-), -)$ to $\Mor_\mathcal{C}(-, v(-))$. For any object
$X$ of $\mathcal{C}$ we obtain a morphism $X \to v(u(X))$ corresponding to
$\text{id}_{u(X)}$. Similarly, for any object $Y$ of $\mathcal{D}$ we obtain
a morphism $u(v(Y)) \to Y$ corresponding to $\text{id}_{v(Y)}$.
These maps are called the {\it adjunction maps}. The adjunction maps
are functorial in $X$ and $Y$, hence we obtain morphisms of functors
$$
\text{id}_\mathcal{C} \to v \circ u\quad (\text{unit})
\quad\text{and}\quad
u \circ v \to \text{id}_\mathcal{D}\quad (\text{counit}).
$$
Moreover, if $\alpha : u(X) \to Y$
and $\beta : X \to v(Y)$ are morphisms, then the following are equivalent
\begin{enumerate}
\item $\alpha$ and $\beta$ correspond to each other via the
bijection of the definition,
\item $\beta$ is the composition $X \to v(u(X)) \xrightarrow{v(\alpha)} v(Y)$,
and
\item $\alpha$ is the composition $u(X) \xrightarrow{u(\beta)} u(v(Y)) \to Y$.
\end{enumerate}
In this way one can reformulate the notion of adjoint functors in terms
of adjunction maps.

\begin{lemma}
\label{lemma-adjoint-exists}
Let $u : \mathcal{C} \to \mathcal{D}$ be a functor between categories.
If for each $y \in \Ob(\mathcal{D})$ the functor
$x \mapsto \Mor_\mathcal{D}(u(x), y)$ is representable, then
$u$ has a right adjoint.
\end{lemma}

\begin{proof}
For each $y$ choose an object $v(y)$ and an isomorphism
$\Mor_\mathcal{C}(-, v(y)) \to \Mor_\mathcal{D}(u(-), y)$
of functors. By Yoneda's lemma (Lemma \ref{lemma-yoneda})
for any morphism $g : y \to y'$ the transformation of functors
$$
\Mor_\mathcal{C}(-, v(y)) \to \Mor_\mathcal{D}(u(-), y) \to
\Mor_\mathcal{D}(u(-), y') \to \Mor_\mathcal{C}(-, v(y'))
$$
corresponds to a unique morphism $v(g) : v(y) \to v(y')$.
We omit the verification that $v$ is a functor and that
it is right adjoint to $u$.
\end{proof}

\begin{lemma}
\label{lemma-adjoint-fully-faithful}
Let $u$ be a left adjoint to $v$ as in Definition \ref{definition-adjoint}.
Then
\begin{enumerate}
\item $u$ is fully faithful $\Leftrightarrow \text{id} \cong v \circ u$.
\item $v$ is fully faithful $\Leftrightarrow u \circ v \cong \text{id}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $u$ is fully faithful. We have to show the adjunction map
$X \to v(u(X))$ is an isomorphism. Let $X' \to v(u(X))$ be any morphism.
By adjointness this corresponds to a morphism $u(X') \to u(X)$. By fully
faithfulness of $u$ this corresponds to a morphism $X' \to X$. Thus we
see that $X \to v(u(X))$ defines a bijection
$\Mor(X', X) \to \Mor(X', v(u(X)))$. Hence it is an isomorphism.
Conversely, if $\text{id} \cong v \circ u$ then $u$ has to be fully
faithful, as $v$ defines an inverse on morphism sets.

\medskip\noindent
Part (2) is dual to part (1).
\end{proof}

\begin{lemma}
\label{lemma-adjoint-exact}
Let $u$ be a left adjoint to $v$ as in Definition \ref{definition-adjoint}.
\begin{enumerate}
\item Suppose that $M : \mathcal{I} \to \mathcal{C}$ is a diagram,
and suppose that $\colim_\mathcal{I} M$ exists in
$\mathcal{C}$. Then $u(\colim_\mathcal{I} M) =
\colim_\mathcal{I} u \circ M$. In other words,
$u$ commutes with (representable) colimits.
\item Suppose that $M : \mathcal{I} \to \mathcal{D}$ is a diagram,
and suppose that $\lim_\mathcal{I} M$ exists in
$\mathcal{D}$. Then $v(\lim_\mathcal{I} M) =
\lim_\mathcal{I} v \circ M$. In other words $v$ commutes
with representable limits.
\end{enumerate}
\end{lemma}

\begin{proof}
A morphism from a colimit into an object is the same as a compatible
system of morphisms from the constituents of the limit into the
object, see Remark \ref{remark-limit-colim}. So
$$
\begin{matrix}
\Mor_\mathcal{D}(u(\colim_{i \in \mathcal{I}} M_i), Y) &
= & \Mor_\mathcal{C}(\colim_{i \in \mathcal{I}} M_i, v(Y)) \\
& = &
\lim_{i \in \mathcal{I}^{opp}}
\Mor_\mathcal{C}(M_i, v(Y)) \\
& = &
\lim_{i \in \mathcal{I}^{opp}}
\Mor_\mathcal{D}(u(M_i), Y)
\end{matrix}
$$
proves that $u(\colim_{i \in \mathcal{I}} M_i)$ is
the colimit we are looking for.
A similar argument works for the other statement.
\end{proof}

\begin{lemma}
\label{lemma-exact-adjoint}
Let $u$ be a left adjoint of $v$ as in Definition \ref{definition-adjoint}.
\begin{enumerate}
\item If $\mathcal{C}$ has finite colimits, then $u$ is right exact.
\item If $\mathcal{D}$ has finite limits, then $v$ is left exact.
\end{enumerate}
\end{lemma}

\begin{proof}
Obvious from the definitions and Lemma \ref{lemma-adjoint-exact}.
\end{proof}

\begin{lemma}
\label{lemma-transformation-between-functors-and-adjoints}
Let $u_1, u_2 : \mathcal{C} \to \mathcal{D}$ be functors with right
adjoints $v_1, v_2 : \mathcal{D} \to \mathcal{C}$. Let $\beta : u_2 \to u_1$
be a transformation of functors. Let $\beta^\vee : v_1 \to v_2$ be
the corresponding transformation of adjoint functors. Then
$$
\xymatrix{
u_2 \circ v_1 \ar[r]_\beta \ar[d]_{\beta^\vee} &
u_1 \circ v_1 \ar[d] \\
u_2 \circ v_2 \ar[r] & \text{id}
}
$$
is commutative where the unlabeled arrows are the counit transformations.
\end{lemma}

\begin{proof}
This is true because $\beta^\vee_D : v_1D \to v_2D$ is the unique
morphism such that the induced maps $\Mor(C, v_1D) \to \Mor(C, v_2D)$
is the map $\Mor(u_1C, D) \to \Mor(u_2C, D)$ induced by
$\beta_C : u_2C \to u_1C$. Namely, this means the map
$$
\Mor(u_1 v_1 D, D') \to \Mor(u_2 v_1 D, D')
$$
induced by $\beta_{v_1 D}$ is the same as the map
$$
\Mor(v_1 D, v_1 D') \to \Mor(v_1 D, v_2 D')
$$
induced by $\beta^\vee_{D'}$. Taking $D' = D$ we find that the counit
$u_1 v_1 D \to D$ precomposed by $\beta_{v_1D}$ corresponds to $\beta^\vee_D$
under adjunction. This exactly means that the diagram commutes when
evaluated on $D$.
\end{proof}






\section{A criterion for representability}
\label{section-representable}

\noindent
The following lemma is often useful to prove the existence of
universal objects in big categories, please see the discussion
in Remark \ref{remark-how-to-use-it}.

\begin{lemma}
\label{lemma-a-version-of-brown}
Let $\mathcal{C}$ be a big\footnote{See Remark \ref{remark-big-categories}.}
category which has limits. Let $F : \mathcal{C} \to \textit{Sets}$ be a
functor. Assume that
\begin{enumerate}
\item $F$ commutes with limits,
\item there exists a family $\{x_i\}_{i \in I}$ of objects of $\mathcal{C}$
and for each $i \in I$ an element $f_i \in F(x_i)$
such that for $y \in \Ob(\mathcal{C})$ and $g \in F(y)$
there exists an $i$ and a morphism $\varphi : x_i \to y$
with $F(\varphi)(f_i) = g$.
\end{enumerate}
Then $F$ is representable, i.e., there exists an object $x$
of $\mathcal{C}$ such that
$$
F(y) = \Mor_\mathcal{C}(x, y)
$$
functorially in $y$.
\end{lemma}

\begin{proof}
Let $\mathcal{I}$ be the category whose objects are the pairs $(x_i, f_i)$
and whose morphisms $(x_i, f_i) \to (x_{i'}, f_{i'})$ are maps
$\varphi : x_i \to x_{i'}$ in $\mathcal{C}$
such that $F(\varphi)(f_i) = f_{i'}$. Set
$$
x = \lim_{(x_i, f_i) \in \mathcal{I}} x_i
$$
(this will not be the $x$ we are looking for, see below).
The limit exists by assumption. As $F$ commutes with limits
we have
$$
F(x) = \lim_{(x_i, f_i) \in \mathcal{I}} F(x_i).
$$
Hence there is a universal element $f \in F(x)$ which maps to $f_i \in F(x_i)$
under $F$ applied to the projection map $x \to x_i$.
Using $f$ we obtain a transformation of functors
$$
\xi : \Mor_\mathcal{C}(x, - ) \longrightarrow F(-)
$$
see Section \ref{section-opposite}. Let $y$ be an arbitrary object of
$\mathcal{C}$ and let $g \in F(y)$. Choose $x_i \to y$ such that $f_i$
maps to $g$ which is possible by assumption. Then $F$ applied to the maps
$$
x \longrightarrow x_i \longrightarrow y
$$
(the first being the projection map of the limit defining $x$)
sends $f$ to $g$. Hence the transformation $\xi$ is surjective.

\medskip\noindent
In order to find the object representing $F$ we let $e : x' \to x$ be the
equalizer of all self maps $\varphi : x \to x$ with $F(\varphi)(f) = f$.
Since $F$ commutes with limits, it commutes with equalizers, and
we see there exists an $f' \in F(x')$ mapping to $f$ in $F(x)$.
Since $\xi$ is surjective and since $f'$ maps to $f$ we see that
also $\xi' : \Mor_\mathcal{C}(x', -) \to F(-)$ is surjective.
Finally, suppose that $a, b : x' \to y$ are two maps such that
$F(a)(f) = F(b)(f)$. We have to show $a = b$. Consider the equalizer
$e' : x'' \to x'$. Again we find $f'' \in F(x'')$ mapping to $f'$.
Choose a map $\psi : x \to x''$ such that $F(\psi)(f) = f''$.
Then we see that $e \circ e' \circ \psi : x \to x$ is a morphism
with $F(e \circ e' \circ \psi)(f) = f$. Hence
$e \circ e' \circ \psi \circ e = e$. This means that $e : x' \to x$
factors through $e' \circ e : x'' \to x$ and since $e$ and $e'$
are monomorphisms this implies $x'' = x'$, i.e., $a = b$ as desired.
\end{proof}

\begin{remark}
\label{remark-how-to-use-it}
The lemma above is often used to construct the free something on something.
For example the free abelian group on a set, the free group on a set, etc.
The idea, say in the case of the free group on a set $E$ is to
consider the functor
$$
F : \textit{Groups} \to \textit{Sets},\quad
G \longmapsto \text{Map}(E, G)
$$
This functor commutes with limits. As our family of objects
we can take a family $E \to G_i$ consisting of groups $G_i$
of cardinality at most $\max(\aleph_0, |E|)$ and set maps
$E \to G_i$ such that every isomorphism class of such a structure
occurs at least once. Namely, if $E \to G$ is a map from $E$ to
a group $G$, then the subgroup $G'$ generated by the image has
cardinality at most $\max(\aleph_0, |E|)$. The lemma tells us
the functor is representable, hence there exists a group
$F_E$ such that $\Mor_{\textit{Groups}}(F_E, G) = \text{Map}(E, G)$.
In particular, the identity morphism of $F_E$ corresponds to
a map $E \to F_E$ and one can show that $F_E$ is generated by
the image without imposing any relations.

\medskip\noindent
Another typical application is that we can use the lemma to construct
colimits once it is known that limits exist. We illustrate it using
the category of topological spaces which has limits by
Topology, Lemma \ref{topology-lemma-limits}. Namely, suppose
that $\mathcal{I} \to \textit{Top}$, $i \mapsto X_i$ is a functor.
Then we can consider
$$
F : \textit{Top} \longrightarrow \textit{Sets},\quad
Y \longmapsto \lim_\mathcal{I} \Mor_{\textit{Top}}(X_i, Y)
$$
This functor commutes with limits. Moreover, given any topological space
$Y$ and an element $(\varphi_i : X_i \to Y)$ of $F(Y)$, there is
a subspace $Y' \subset Y$ of cardinality at most $|\coprod X_i|$
such that the morphisms $\varphi_i$ map into $Y'$. Namely, we can
take the induced topology on the union of the images of the $\varphi_i$.
Thus it is clear that the hypotheses of the lemma are satisfied and we find a
topological space $X$
representing the functor $F$, which precisely means that $X$ is
the colimit of the diagram $i \mapsto X_i$.
\end{remark}

\begin{theorem}[Adjoint functor theorem]
\label{theorem-adjoint-functor}
Let $G : \mathcal{C} \to \mathcal{D}$ be a functor of big categories.
Assume $\mathcal{C}$ has limits, $G$ commutes with them, and for
every object $y$ of $\mathcal{D}$ there exists a set of pairs
$(x_i, f_i)_{i \in I}$ with $x_i \in \Ob(\mathcal{C})$,
$f_i \in \Mor_\mathcal{D}(y, G(x_i))$ such that for any
pair $(x, f)$ with $x \in \Ob(\mathcal{C})$,
$f \in \Mor_\mathcal{C}(y, G(x))$ there is an $i$ and a morphism
$h : x_i \to x$ such that $f = G(h) \circ f_i$.
Then $G$ has a left adjoint $F$.
\end{theorem}

\begin{proof}
The assumptions imply that for every object $y$ of $\mathcal{D}$
the functor $x \mapsto \Mor_\mathcal{D}(y, G(x))$ satisfies the
assumptions of Lemma \ref{lemma-a-version-of-brown}.
Thus it is representable by an object, let's call it $F(y)$.
An application of Yoneda's lemma (Lemma \ref{lemma-yoneda})
turns the rule $y \mapsto F(y)$ into a functor which
by construction is an adjoint to $G$. We omit the details.
\end{proof}





\section{Localization in categories}
\label{section-localization}

\noindent
The basic idea of this section is given a category $\mathcal{C}$
and a set of arrows $S$ to construct a functor
$F : \mathcal{C} \to S^{-1}\mathcal{C}$
such that all elements of $S$ become invertible in $S^{-1}\mathcal{C}$
and such that $F$ is universal among all functors with this property.
References for this section are \cite[Chapter I, Section 2]{GZ}
and \cite[Chapter II, Section 2]{Verdier}.

\begin{definition}
\label{definition-multiplicative-system}
Let $\mathcal{C}$ be a category. A set of arrows $S$ of $\mathcal{C}$ is
called a {\it left multiplicative system} if it has the following properties:
\begin{enumerate}
\item[LMS1] The identity of every object of $\mathcal{C}$ is in $S$ and
the composition of two composable elements of $S$ is in $S$.
\item[LMS2] Every solid diagram
$$
\xymatrix{
X \ar[d]_t \ar[r]_g & Y \ar@{..>}[d]^s \\
Z \ar@{..>}[r]^f & W
}
$$
with $t \in S$ can be completed to a commutative dotted square with
$s \in S$.
\item[LMS3] For every pair of morphisms $f, g : X \to Y$ and
$t \in S$ with target $X$ such that $f \circ t = g \circ t$
there exists a $s \in S$ with source $Y$ such that
$s \circ f = s \circ g$.
\end{enumerate}
A set of arrows $S$ of $\mathcal{C}$ is
called a {\it right multiplicative system}
if it has the following properties:
\begin{enumerate}
\item[RMS1] The identity of every object of $\mathcal{C}$ is in $S$ and
the composition of two composable elements of $S$ is in $S$.
\item[RMS2] Every solid diagram
$$
\xymatrix{
X \ar@{..>}[d]_t \ar@{..>}[r]_g & Y \ar[d]^s \\
Z \ar[r]^f & W
}
$$
with $s \in S$ can be completed to a commutative dotted square with
$t \in S$.
\item[RMS3] For every pair of morphisms $f, g : X \to Y$ and
$s \in S$ with source $Y$ such that $s \circ f = s \circ g$
there exists a $t \in S$ with target $X$ such that
$f \circ t = g \circ t$.
\end{enumerate}
A set of arrows $S$ of $\mathcal{C}$ is called a {\it multiplicative system}
if it is both a left multiplicative system and a right multiplicative system.
In other words, this means that MS1, MS2, MS3 hold, where
MS1 $=$ LMS1 $+$ RMS1, MS2 $=$ LMS2 $+$ RMS2, and
MS3 $=$ LMS3 $+$ RMS3. (That said, of course LMS1 $=$ RMS1
$=$ MS1.)
\end{definition}

\noindent
These conditions are useful to construct the categories $S^{-1}\mathcal{C}$
as follows.

\medskip\noindent
{\bf Left calculus of fractions.}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system. We define a new category $S^{-1}\mathcal{C}$ as follows
(we verify this works in the proof of
Lemma \ref{lemma-left-localization}):
\begin{enumerate}
\item We set $\Ob(S^{-1}\mathcal{C}) = \Ob(\mathcal{C})$.
\item Morphisms $X \to Y$ of $S^{-1}\mathcal{C}$ are given by pairs
$(f : X \to Y', s : Y \to Y')$ with $s \in S$ up to equivalence.
(The equivalence is defined below. Think of the equivalence class
of a pair $(f, s)$ as $s^{-1}f : X \to Y$.)
\item Two pairs $(f_1 : X \to Y_1, s_1 : Y \to Y_1)$ and
$(f_2 : X \to Y_2, s_2 : Y \to Y_2)$ are said to be equivalent
if there exists a third pair $(f_3 : X \to Y_3, s_3 : Y \to Y_3)$
and morphisms $u : Y_1 \to Y_3$ and $v : Y_2 \to Y_3$ of $\mathcal{C}$
fitting into the commutative diagram
$$
\xymatrix{
 & Y_1 \ar[d]^u & \\
X \ar[ru]^{f_1} \ar[r]^{f_3} \ar[rd]_{f_2} &
Y_3 &
Y \ar[lu]_{s_1} \ar[l]_{s_3} \ar[ld]^{s_2} \\
& Y_2 \ar[u]_v &
}
$$
\item The composition of the equivalence classes of the pairs
$(f : X \to Y', s : Y \to Y')$ and $(g : Y \to Z', t : Z \to Z')$
is defined as the equivalence class of a pair
$(h \circ f : X \to Z'', u \circ t : Z \to Z'')$
where $h$ and $u \in S$ are chosen to fit into a commutative diagram
$$
\xymatrix{
Y \ar[d]_s \ar[r]_g & Z' \ar[d]^u \\
Y' \ar[r]^h & Z''
}
$$
which exists by assumption.
\item The identity morphism $X \to X$ in $S^{-1} \mathcal{C}$ is the
equivalence class of the pair $(\operatorname{id} : X \to X,
\operatorname{id} : X \to X)$.
\end{enumerate}

\begin{lemma}
\label{lemma-left-localization}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system.
\begin{enumerate}
\item The relation on pairs defined above is an equivalence relation.
\item The composition rule given above is well defined on equivalence
classes.
\item Composition is associative (and the identity morphisms satisfy
the identity axioms), and hence $S^{-1}\mathcal{C}$ is a category.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let us say two pairs $p_1 = (f_1 : X \to Y_1, s_1 : Y \to Y_1)$
and $p_2 = (f_2 : X \to Y_2, s_2 : Y \to Y_2)$ are elementary equivalent
if there exists a morphism $a : Y_1 \to Y_2$ of $\mathcal{C}$ such that
$a \circ f_1 = f_2$ and $a \circ s_1 = s_2$. Diagram:
$$
\xymatrix{
X \ar@{=}[d] \ar[r]_{f_1} & Y_1 \ar[d]^a & Y \ar[l]^{s_1} \ar@{=}[d] \\
X \ar[r]^{f_2} & Y_2 & Y \ar[l]_{s_2}
}
$$
Let us denote this property by saying $p_1Ep_2$.
Note that $pEp$ and $aEb, bEc \Rightarrow aEc$.
(Despite its name, $E$ is not an equivalence
relation.)
Part (1) claims that the relation
$p \sim p' \Leftrightarrow \exists q: pEq \wedge p'Eq$
(where $q$ is supposed to be a pair satisfying the
same conditions as $p$ and $p'$)
is an equivalence relation. A simple formal argument, using the properties
of $E$ above, shows that it suffices to prove
$p_3Ep_1, p_3Ep_2 \Rightarrow p_1 \sim p_2$.
Thus suppose that we are given a commutative diagram
$$
\xymatrix{
 & Y_1 & \\
X \ar[ru]^{f_1} \ar[r]^{f_3} \ar[rd]_{f_2} &
Y_3 \ar[u]_{a_{31}} \ar[d]^{a_{32}} &
Y \ar[lu]_{s_1} \ar[l]_{s_3} \ar[ld]^{s_2} \\
& Y_2 &
}
$$
with $s_i \in S$.
First we apply LMS2 to get a commutative diagram
$$
\xymatrix{
Y \ar[d]_{s_1} \ar[r]_{s_2} & Y_2 \ar@{..>}[d]^{a_{24}} \\
Y_1 \ar@{..>}[r]^{a_{14}} & Y_4
}
$$
with $a_{24} \in S$. Then, we have
$$
a_{14} \circ a_{31} \circ s_3 =
a_{14} \circ s_1 =
a_{24} \circ s_2 =
a_{24} \circ a_{32} \circ s_3.
$$
Hence, by LMS3, there exists a
morphism $s_{44} : Y_4 \to Y'_4$ such that $s_{44} \in S$ and
$s_{44} \circ a_{14} \circ a_{31}
= s_{44} \circ a_{24} \circ a_{32}$.
Hence, after replacing $Y_4$, $a_{14}$ and $a_{24}$ by $Y'_4$,
$s_{44} \circ a_{14}$ and $s_{44} \circ a_{24}$, we may assume
that $a_{14} \circ a_{31} = a_{24} \circ a_{32}$ (and
we still have $a_{24} \in S$ and
$a_{14} \circ s_1 = a_{24} \circ s_2$). Set
$$
f_4 =
a_{14} \circ f_1 =
a_{14} \circ a_{31} \circ f_3 =
a_{24} \circ a_{32} \circ f_3 =
a_{24} \circ f_2
$$
and
$s_4 = a_{14} \circ s_1 = a_{24} \circ s_2$. Then, the diagram
$$
\xymatrix{
X \ar@{=}[d] \ar[r]_{f_1} & Y_1 \ar[d]^{a_{14}} & Y \ar[l]^{s_1} \ar@{=}[d] \\
X \ar[r]^{f_4} & Y_4 & Y \ar[l]_{s_4}
}
$$
commutes, and we have $s_4 \in S$ (by LMS1). Thus, $p_1 E p_4$,
where $p_4 = (f_4, s_4)$. Similarly, $p_2 E p_4$. Combining these,
we find $p_1 \sim p_2$.

\medskip\noindent
Proof of (2). Let  $p = (f : X \to Y', s : Y \to Y')$ and
$q = (g : Y \to Z', t : Z \to Z')$ be pairs as in the definition of composition
above. To compose we choose a diagram
$$
\xymatrix{
Y \ar[d]_s \ar[r]_g & Z' \ar[d]^{u_2} \\
Y' \ar[r]^{h_2} & Z_2
}
$$
with $u_2 \in S$. We first show that the equivalence class of the pair
$r_2 = (h_2 \circ f : X \to Z_2, u_2 \circ t : Z \to Z_2)$
is independent of the choice of $(Z_2, h_2, u_2)$. Namely, suppose
that $(Z_3, h_3, u_3)$ is another choice with corresponding composition
$r_3 = (h_3 \circ f : X \to Z_3, u_3 \circ t : Z \to Z_3)$.
Then by LMS2 we can choose a diagram
$$
\xymatrix{
Z' \ar[d]_{u_2} \ar[r]_{u_3} & Z_3 \ar[d]^{u_{34}} \\
Z_2 \ar[r]^{h_{24}} & Z_4
}
$$
with $u_{34} \in S$. We have $h_2 \circ s = u_2 \circ g$
and similarly $h_3 \circ s = u_3 \circ g$. Now,
$$
u_{34} \circ h_3 \circ s
= u_{34} \circ u_3 \circ g
= h_{24} \circ u_2 \circ g
= h_{24} \circ h_2 \circ s.
$$
Hence, LMS3 shows that there
exists a $Z'_4$ and an $s_{44} : Z_4 \to Z'_4$ such that
$s_{44} \circ u_{34} \circ h_3 = s_{44} \circ h_{24} \circ h_2$.
Replacing $Z_4$, $h_{24}$ and $u_{34}$ by $Z'_4$,
$s_{44} \circ h_{24}$ and $s_{44} \circ u_{34}$, we may
assume that $u_{34} \circ h_3 = h_{24} \circ h_2$.
Meanwhile, the relations $u_{34} \circ u_3 = h_{24} \circ u_2$
and $u_{34} \in S$ continue to hold. We can now set
$h_4 = u_{34} \circ h_3 = h_{24} \circ h_2$ and
$u_4 = u_{34} \circ u_3 = h_{24} \circ u_2$. Then, we have a
commutative diagram
$$
\xymatrix{
X \ar@{=}[d] \ar[r]_{h_2\circ f} &
Z_2 \ar[d]^{h_{24}} &
Z \ar[l]^{u_2 \circ t} \ar@{=}[d] \\
X \ar@{=}[d] \ar[r]^{h_4\circ f} &
Z_4 &
Z \ar@{=}[d] \ar[l]_{u_4 \circ t} \\
X \ar[r]^{h_3 \circ f} &
Z_3 \ar[u]^{u_{34}} &
Z \ar[l]_{u_3 \circ t}
}
$$
Hence we obtain a pair
$r_4 =
(h_4 \circ f : X \to Z_4, u_4 \circ t : Z \to Z_4)$
and the above diagram shows that we have $r_2Er_4$ and
$r_3Er_4$, whence $r_2 \sim r_3$, as desired. Thus it now
makes sense to define $p \circ q$ as the equivalence class of
all possible pairs $r$ obtained as above.

\medskip\noindent
To finish the proof of (2) we have to show that given pairs
$p_1, p_2, q$ such that $p_1Ep_2$ then $p_1 \circ q = p_2 \circ q$ and
$q \circ p_1 = q \circ p_2$ whenever the compositions make sense.
To do this, write $p_1 = (f_1 : X \to Y_1, s_1 : Y \to Y_1)$ and
$p_2 = (f_2 : X \to Y_2, s_2 : Y \to Y_2)$ and let
$a : Y_1 \to Y_2$ be a morphism of $\mathcal{C}$ such that
$f_2 = a \circ f_1$ and $s_2 = a \circ s_1$.
First assume that $q = (g : Y \to Z', t : Z \to Z')$.
In this case choose a commutative diagram as the one on the left
$$
\vcenter{
\xymatrix{
Y \ar[d]_{s_2} \ar[r]^g & Z' \ar[d]^u \\
Y_2 \ar[r]^h & Z''
}
}
\quad
\Rightarrow
\quad
\vcenter{
\xymatrix{
Y \ar[d]_{s_1} \ar[r]^g & Z' \ar[d]^u \\
Y_1 \ar[r]^{h \circ a} & Z''
}
}
$$
(with $u \in S$),
which implies the diagram on the right is commutative as well.
Using these diagrams we see that both compositions $q \circ p_1$
and $q \circ p_2$ are the equivalence class of
$(h \circ a \circ f_1 : X \to Z'', u \circ t : Z \to Z'')$.
Thus $q \circ p_1 = q \circ p_2$.
The proof of the other case, in which we have to show
$p_1 \circ q = p_2 \circ q$, is omitted. (It is similar to the
case we did.)

\medskip\noindent
Proof of (3). We have to prove associativity of composition.
Consider a solid diagram
$$
\xymatrix{
& & & Z \ar[d] \\
& & Y \ar[d] \ar[r] & Z' \ar@{..>}[d] \\
& X \ar[d] \ar[r] & Y' \ar@{..>}[d] \ar@{..>}[r] & Z'' \ar@{..>}[d] \\
W \ar[r] & X' \ar@{..>}[r] & Y'' \ar@{..>}[r] & Z'''
}
$$
(whose vertical arrows belong to $S$)
which gives rise to three composable pairs.
Using LMS2 we can choose the dotted arrows making the squares commutative
and such that the vertical arrows are in $S$.
Then it is clear that the composition of the three pairs
is the equivalence class of the pair
$(W \to Z''', Z \to Z''')$ gotten by composing the
horizontal arrows on the bottom row and the vertical arrows
on the right column.

\medskip\noindent
We leave it to the reader to check the identity axioms.
\end{proof}

\begin{remark}
\label{remark-motivation-localization}
The motivation for the construction of $S^{-1} \mathcal{C}$ is to
``force'' the morphisms in $S$ to be invertible by artificially
creating inverses to them (at the cost of some existing morphisms
possibly becoming identified with each other). This is similar to
the localization of a commutative ring at a multiplicative subset,
and more generally to the localization of a noncommutative ring
at a right denominator set (see \cite[Section 10A]{Lam}). This is
more than just a similarity: The construction of
$S^{-1} \mathcal{C}$ (or, more precisely, its version for
additive categories $\mathcal{C}$) actually generalizes the
latter type of localization. Namely, a noncommutative ring can be
viewed as a pre-additive category with a single object (the morphisms
being the elements of the ring); a multiplicative subset of this
ring then becomes a set $S$ of morphisms satisfying LMS1 (aka
RMS1). Then, the conditions RMS2 and RMS3 for this category and
this subset $S$ translate into the two conditions
(``right permutable'' and ``right reversible'') of a right
denominator set (and similarly for LMS and left denominator sets),
and $S^{-1} \mathcal{C}$ (with a properly defined additive
structure) is the one-object category corresponding to the
localization of the ring.
\end{remark}

\begin{definition}
\label{definition-left-localization-as-fraction}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system of morphisms of $\mathcal{C}$. Given any morphism
$f : X \to Y'$ in $\mathcal{C}$ and any morphism $s : Y \to Y'$ in
$S$, we denote by {\it $s^{-1} f$} the equivalence class of the pair
$(f : X \to Y', s : Y \to Y')$. This is a morphism from $X$ to $Y$
in $S^{-1} \mathcal{C}$.
\end{definition}

\noindent
This notation is suggestive, and the things it suggests are true:
Given any morphism $f : X \to Y'$ in $\mathcal{C}$ and any two
morphisms $s : Y \to Y'$ and $t : Y' \to Y''$ in $S$, we have
$\left(t \circ s\right)^{-1} \left(t \circ f\right) = s^{-1} f$.
Also, for any
$f : X \to Y'$ and $g : Y' \to Z'$ in $\mathcal{C}$ and all
$s : Z \to Z'$ in $S$, we have
$s^{-1} \left(g \circ f\right) = \left(s^{-1} g\right) \circ
\left(\operatorname{id}_{Y'}^{-1} f\right)$.
Finally, for any $f : X \to Y'$ in $\mathcal{C}$, all
$s : Y \to Y'$ in $S$, and $t : Z \to Y$ in $S$, we have
$\left(s \circ t\right)^{-1} f
= \left(t^{-1} \operatorname{id}_Y\right)
\circ \left(s^{-1} f\right)$.
This is all clear from the definition.
We can ``write any finite collection of morphisms with the same target
as fractions with common denominator''.

\begin{lemma}
\label{lemma-morphisms-left-localization}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system of morphisms of $\mathcal{C}$. Given any finite collection
$g_i : X_i \to Y$ of morphisms of $S^{-1}\mathcal{C}$
(indexed by $i$),
we can find an element $s : Y \to Y'$ of $S$ and
a family of morphisms $f_i : X_i \to Y'$ of $\mathcal{C}$ such that
each $g_i$ is the equivalence class of the pair
$(f_i : X_i \to Y', s : Y \to Y')$.
\end{lemma}

\begin{proof}
For each $i$ choose a representative $(X_i \to Y_i, s_i : Y \to Y_i)$
of $g_i$.
The lemma follows if we can find a morphism $s : Y \to Y'$ in $S$ such that
for each $i$ there is a morphism $a_i : Y_i \to Y'$ with
$a_i \circ s_i = s$. If we have two indices $i = 1, 2$, then we can
do this by completing the square
$$
\xymatrix{
Y \ar[d]_{s_1} \ar[r]_{s_2} & Y_2 \ar[d]^{t_2} \\
Y_1 \ar[r]^{a_1} & Y'
}
$$
with $t_2 \in S$ as is possible by
Definition \ref{definition-multiplicative-system}.
Then $s = t_2 \circ s_2 \in S$ works.
If we have $n > 2$ morphisms, then we use the above trick to reduce
to the case of $n - 1$ morphisms, and we win by induction.
\end{proof}

\noindent
There is an easy characterization of equality of morphisms if they
have the same denominator.

\begin{lemma}
\label{lemma-equality-morphisms-left-localization}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system of morphisms of $\mathcal{C}$. Let $A, B : X \to Y$ be
morphisms of $S^{-1}\mathcal{C}$ which are the equivalence
classes of $(f : X \to Y', s : Y \to Y')$ and
$(g : X \to Y', s : Y \to Y')$. Then
$A = B$ if and only if there exists a morphism
$a : Y' \to Y''$ with $a \circ s \in S$ and
such that $a \circ f = a \circ g$.
\end{lemma}

\begin{proof}
The equality of $A$ and $B$ means that there exists a commutative diagram
$$
\xymatrix{
 & Y' \ar[d]^u & \\
X \ar[ru]^f \ar[r]^h \ar[rd]_g &
Z &
Y \ar[lu]_s \ar[l]_t \ar[ld]^s \\
& Y' \ar[u]_v &
}
$$
with $t \in S$. In particular $u \circ s = v \circ s$. Hence by LMS3 there
exists a $s' : Z \to Y''$ in $S$ such that $s' \circ u = s' \circ v$.
Setting $a$ equal to this common value does the job.
\end{proof}

\begin{remark}
\label{remark-left-localization-morphisms-colimit}
Let $\mathcal{C}$ be a category. Let $S$ be a left multiplicative system.
Given an object $Y$ of $\mathcal{C}$ we denote $Y/S$ the category whose
objects are $s : Y \to Y'$ with $s \in S$ and whose morphisms are
commutative diagrams
$$
\xymatrix{
& Y \ar[ld]_s \ar[rd]^t & \\
Y' \ar[rr]^a & & Y''
}
$$
where $a : Y' \to Y''$ is arbitrary. We claim that the category
$Y/S$ is filtered (see
Definition \ref{definition-directed}).
Namely, LMS1 implies that $\text{id}_Y : Y \to Y$
is in $Y/S$; hence $Y/S$ is nonempty. LMS2 implies that given
$s_1 : Y \to Y_1$ and $s_2 : Y \to Y_2$ we can find a diagram
$$
\xymatrix{
Y \ar[d]_{s_1} \ar[r]_{s_2} & Y_2 \ar[d]^t \\
Y_1 \ar[r]^a & Y_3
}
$$
with $t \in S$. Hence $s_1 : Y \to Y_1$ and $s_2 : Y \to Y_2$
both have maps to $t \circ s_2 : Y \to Y_3$ in $Y/S$. Finally, given
two morphisms $a, b$ from $s_1 : Y \to Y_1$ to $s_2 : Y \to Y_2$
in $Y/S$ we see that $a \circ s_1 = b \circ s_1$; hence by LMS3
there exists a $t : Y_2 \to Y_3$ in $S$ such that
$t \circ a = t \circ b$.
Now the combined results of
Lemmas \ref{lemma-morphisms-left-localization} and
\ref{lemma-equality-morphisms-left-localization}
tell us that
\begin{equation}
\label{equation-left-localization-morphisms-colimit}
\Mor_{S^{-1}\mathcal{C}}(X, Y) =
\colim_{(s : Y \to Y') \in Y/S} \Mor_\mathcal{C}(X, Y')
\end{equation}
This formula expressing morphism sets in $S^{-1}\mathcal{C}$ as a filtered
colimit of morphism sets in $\mathcal{C}$ is occasionally useful.
\end{remark}

\begin{lemma}
\label{lemma-properties-left-localization}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system of morphisms of $\mathcal{C}$.
\begin{enumerate}
\item The rules $X \mapsto X$ and
$(f : X \to Y) \mapsto (f : X \to Y, \text{id}_Y : Y \to Y)$
define a functor $Q : \mathcal{C} \to S^{-1}\mathcal{C}$.
\item For any $s \in S$ the morphism $Q(s)$ is an isomorphism in
$S^{-1}\mathcal{C}$.
\item If $G : \mathcal{C} \to \mathcal{D}$ is any functor such that
$G(s)$ is invertible for every $s \in S$, then there exists a
unique functor $H : S^{-1}\mathcal{C} \to \mathcal{D}$
such that $H \circ Q = G$.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1) and (2) are clear. (In (2), the inverse of $Q(s)$ is
the equivalence class of the pair $(\operatorname{id}_Y, s)$.)
To see (3) just set $H(X) = G(X)$
and set $H((f : X \to Y', s : Y \to Y')) = G(s)^{-1} \circ G(f)$.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-left-localization-limits}
Let $\mathcal{C}$ be a category and let $S$ be a left multiplicative
system of morphisms of $\mathcal{C}$. The localization functor
$Q : \mathcal{C} \to S^{-1}\mathcal{C}$ commutes with finite colimits.
\end{lemma}

\begin{proof}
Let $\mathcal{I}$ be a finite category and let
$\mathcal{I} \to \mathcal{C}$, $i \mapsto X_i$
be a functor whose colimit exists. Then using
(\ref{equation-left-localization-morphisms-colimit}),
the fact that $Y/S$ is filtered, and
Lemma \ref{lemma-directed-commutes} we have
\begin{align*}
\Mor_{S^{-1}\mathcal{C}}(Q(\colim X_i), Q(Y))
& =
\colim_{(s : Y \to Y') \in Y/S} \Mor_\mathcal{C}(\colim X_i, Y') \\
& =
\colim_{(s : Y \to Y') \in Y/S} \lim_i \Mor_\mathcal{C}(X_i, Y') \\
& =
\lim_i \colim_{(s : Y \to Y') \in Y/S} \Mor_\mathcal{C}(X_i, Y') \\
& =
\lim_i \Mor_{S^{-1}\mathcal{C}}(Q(X_i), Q(Y))
\end{align*}
and this isomorphism commutes with the projections
from both sides to the set
$\Mor_{S^{-1}\mathcal{C}}(Q(X_j), Q(Y))$ for each
$j \in \Ob(\mathcal{I})$. Thus, $Q(\colim X_i)$ satisfies
the universal property for the colimit of the functor
$i \mapsto Q(X_i)$; hence, it is this colimit, as desired.
\end{proof}

\begin{lemma}
\label{lemma-left-localization-diagram}
Let $\mathcal{C}$ be a category. Let $S$ be a left multiplicative
system. If $f : X \to Y$, $f' : X' \to Y'$ are two morphisms of
$\mathcal{C}$ and if
$$
\xymatrix{
Q(X) \ar[d]_{Q(f)} \ar[r]_a & Q(X') \ar[d]^{Q(f')} \\
Q(Y) \ar[r]^b & Q(Y')
}
$$
is a commutative diagram in $S^{-1}\mathcal{C}$, then there exists
a morphism $f'' : X'' \to Y''$ in $\mathcal{C}$ and a commutative
diagram
$$
\xymatrix{
X \ar[d]_f \ar[r]_g & X'' \ar[d]^{f''} & X' \ar[d]^{f'} \ar[l]^s \\
Y \ar[r]^h & Y'' & Y' \ar[l]_t
}
$$
in $\mathcal{C}$ with $s, t \in S$ and $a = s^{-1}g$, $b = t^{-1}h$.
\end{lemma}

\begin{proof}
We choose maps and objects in the following way:
First write $a = s^{-1}g$ for some $s : X' \to X''$ in $S$ and
$g : X \to X''$. By LMS2 we can find $t : Y' \to Y''$ in $S$ and
$f'' : X'' \to Y''$ such that
$$
\xymatrix{
X \ar[d]_f \ar[r]_g & X'' \ar[d]^{f''} & X' \ar[d]^{f'} \ar[l]^s \\
Y & Y'' & Y' \ar[l]_t
}
$$
commutes. Now in this diagram we are going to repeatedly change our
choice of
$$
X'' \xrightarrow{f''} Y'' \xleftarrow{t} Y'
$$
by postcomposing both $t$ and $f''$ by a morphism $d : Y'' \to Y'''$
with the property that $d \circ t \in S$. According to
Remark \ref{remark-left-localization-morphisms-colimit}
we may after such a replacement assume that there exists a morphism
$h : Y \to Y''$ such that $b = t^{-1}h$ holds\footnote{Here is a
more down-to-earth way to see this:
Write $b = q^{-1}i$ for some $q : Y' \to Z$ in $S$ and some
$i : Y \to Z$. By LMS2 we can find $r : Y'' \to Y'''$ in $S$ and
$j : Z \to Y'''$ such that $j \circ q = r \circ t$. Now, set
$d = r$ and $h = j \circ i$.}. At this point we have everything
as in the lemma except that we don't know that the left square of the
diagram commutes.
But the definition of composition in $S^{-1} \mathcal{C}$ shows that
$b \circ Q\left(f\right)$ is the equivalence class of the pair
$(h \circ f : X \to Y'', t : Y' \to Y'')$ (since $b$ is the
equivalence class of the pair $(g : X \to X'', s : X' \to X'')$,
while $Q\left(f\right)$ is the equivalence class of the pair
$(f : X \to Y, \operatorname{id} : Y \to Y)$), while
$Q\left(f'\right) \circ a$ is the equivalence class of the pair
$(f'' \circ g : X \to Y'', t : Y' \to Y'')$ (since $a$ is the
equivalence class of the pair $(h : Y \to Y'', t : Y' \to Y'')$,
while $Q\left(f'\right)$ is the equivalence class of the pair
$(f' : X' \to Y', \operatorname{id} : Y' \to Y')$).
Since we know that
$b \circ Q\left(f\right) = Q\left(f'\right) \circ a$, we thus
conclude that the equivalence classes of the pairs
$(h \circ f : X \to Y'', t : Y' \to Y'')$ and
$(f'' \circ g : X \to Y'', t : Y' \to Y'')$ are equal.
Hence using
Lemma \ref{lemma-equality-morphisms-left-localization}
we can find a morphism $d : Y'' \to Y'''$ such that
$d \circ t \in S$ and $d \circ h \circ f = d \circ f'' \circ g$.
Hence we make one more replacement of the kind described
above and we win.
\end{proof}

\noindent
{\bf Right calculus of fractions.}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system. We define a new category $S^{-1}\mathcal{C}$ as follows
(we verify this works in the proof of
Lemma \ref{lemma-right-localization}):
\begin{enumerate}
\item We set $\Ob(S^{-1}\mathcal{C}) = \Ob(\mathcal{C})$.
\item Morphisms $X \to Y$ of $S^{-1}\mathcal{C}$ are given by pairs
$(f : X' \to Y, s : X' \to X)$ with $s \in S$ up to equivalence.
(The equivalence is defined below. Think of the equivalence class
of a pair $(f, s)$ as $fs^{-1} : X \to Y$.)
\item Two pairs $(f_1 : X_1 \to Y, s_1 : X_1 \to X)$ and
$(f_2 : X_2 \to Y, s_2 : X_2 \to X)$ are said to be equivalent
if there exists a third pair $(f_3 : X_3 \to Y, s_3 : X_3 \to X)$
and morphisms $u : X_3 \to X_1$ and $v : X_3 \to X_2$ of $\mathcal{C}$
fitting into the commutative diagram
$$
\xymatrix{
 & X_1 \ar[ld]_{s_1} \ar[rd]^{f_1} & \\
X &
X_3 \ar[l]_{s_3} \ar[u]_u \ar[d]^v \ar[r]^{f_3} &
Y \\
& X_2 \ar[lu]^{s_2} \ar[ru]_{f_2} &
}
$$
\item The composition of the equivalence classes of the pairs
$(f : X' \to Y, s : X' \to X)$ and $(g : Y' \to Z, t : Y' \to Y)$
is defined as the equivalence class of a pair
$(g \circ h : X'' \to Z, s \circ u : X'' \to X)$
where $h$ and $u \in S$ are chosen to fit into a commutative diagram
$$
\xymatrix{
X'' \ar[d]_u \ar[r]^h & Y' \ar[d]^t \\
X' \ar[r]^f & Y
}
$$
which exists by assumption.
\item The identity morphism $X \to X$ in $S^{-1} \mathcal{C}$ is the
equivalence class of the pair $(\operatorname{id} : X \to X,
\operatorname{id} : X \to X)$.
\end{enumerate}

\begin{lemma}
\label{lemma-right-localization}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system.
\begin{enumerate}
\item The relation on pairs defined above is an equivalence relation.
\item The composition rule given above is well defined on equivalence
classes.
\item Composition is associative (and the identity morphisms satisfy
the identity axioms), and hence $S^{-1}\mathcal{C}$ is a category.
\end{enumerate}
\end{lemma}

\begin{proof}
This lemma is dual to
Lemma \ref{lemma-left-localization}.
It follows formally from that lemma by replacing
$\mathcal{C}$ by its opposite category in which
$S$ is a left multiplicative system.
\end{proof}

\begin{definition}
\label{definition-right-localization-as-fraction}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system of morphisms of $\mathcal{C}$. Given any morphism
$f : X' \to Y$ in $\mathcal{C}$ and any morphism $s : X' \to X$ in
$S$, we denote by {\it $f s^{-1}$} the equivalence class of the pair
$(f : X' \to Y, s : X' \to X)$. This is a morphism from $X$ to $Y$
in $S^{-1} \mathcal{C}$.
\end{definition}

\noindent
Identities similar (actually, dual) to the ones in Definition
\ref{definition-left-localization-as-fraction} hold.
We can ``write any finite collection of morphisms with the same source
as fractions with common denominator''.

\begin{lemma}
\label{lemma-morphisms-right-localization}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system of morphisms of $\mathcal{C}$. Given any finite collection
$g_i : X \to Y_i$ of morphisms of $S^{-1}\mathcal{C}$
(indexed by $i$),
we can find an element $s : X' \to X$ of $S$ and a family
of morphisms $f_i : X' \to Y_i$ of $\mathcal{C}$ such that
$g_i$ is the equivalence class of the pair
$(f_i : X' \to Y_i, s : X' \to X)$.
\end{lemma}

\begin{proof}
This lemma is the dual of
Lemma \ref{lemma-morphisms-left-localization}
and follows formally from that lemma by replacing all
categories in sight by their opposites.
\end{proof}

\noindent
There is an easy characterization of equality of morphisms if they
have the same denominator.

\begin{lemma}
\label{lemma-equality-morphisms-right-localization}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system of morphisms of $\mathcal{C}$. Let $A, B : X \to Y$ be
morphisms of $S^{-1}\mathcal{C}$ which are the equivalence
classes of $(f : X' \to Y, s : X' \to X)$ and
$(g : X' \to Y, s : X' \to X)$. Then
$A = B$ if and only if there exists a morphism
$a : X'' \to X'$ with $s \circ a \in S$ and
such that $f \circ a = g \circ a$.
\end{lemma}

\begin{proof}
This is dual to
Lemma \ref{lemma-equality-morphisms-left-localization}.
\end{proof}

\begin{remark}
\label{remark-right-localization-morphisms-colimit}
Let $\mathcal{C}$ be a category. Let $S$ be a right multiplicative system.
Given an object $X$ of $\mathcal{C}$ we denote $S/X$ the category whose
objects are $s : X' \to X$ with $s \in S$ and whose morphisms are
commutative diagrams
$$
\xymatrix{
X' \ar[rd]_s \ar[rr]_a & & X'' \ar[ld]^t \\
& X
}
$$
where $a : X' \to X''$ is arbitrary. The category
$S/X$ is cofiltered (see
Definition \ref{definition-codirected}).
(This is dual to the corresponding statement in
Remark \ref{remark-left-localization-morphisms-colimit}.)
Now the combined results of
Lemmas \ref{lemma-morphisms-right-localization} and
\ref{lemma-equality-morphisms-right-localization}
tell us that
\begin{equation}
\label{equation-right-localization-morphisms-colimit}
\Mor_{S^{-1}\mathcal{C}}(X, Y) =
\colim_{(s : X' \to X) \in (S/X)^{opp}} \Mor_\mathcal{C}(X', Y)
\end{equation}
This formula expressing morphisms in $S^{-1}\mathcal{C}$ as a filtered
colimit of morphisms in $\mathcal{C}$ is occasionally useful.
\end{remark}

\begin{lemma}
\label{lemma-properties-right-localization}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system of morphisms of $\mathcal{C}$.
\begin{enumerate}
\item The rules $X \mapsto X$ and
$(f : X \to Y) \mapsto (f : X \to Y, \text{id}_X : X \to X)$
define a functor $Q : \mathcal{C} \to S^{-1}\mathcal{C}$.
\item For any $s \in S$ the morphism $Q(s)$ is an isomorphism in
$S^{-1}\mathcal{C}$.
\item If $G : \mathcal{C} \to \mathcal{D}$ is any functor such that
$G(s)$ is invertible for every $s \in S$, then there exists a
unique functor $H : S^{-1}\mathcal{C} \to \mathcal{D}$
such that $H \circ Q = G$.
\end{enumerate}
\end{lemma}

\begin{proof}
This lemma is the dual of
Lemma \ref{lemma-properties-left-localization}
and follows formally from that lemma by replacing all
categories in sight by their opposites.
\end{proof}

\begin{lemma}
\label{lemma-right-localization-limits}
Let $\mathcal{C}$ be a category and let $S$ be a right multiplicative
system of morphisms of $\mathcal{C}$. The localization functor
$Q : \mathcal{C} \to S^{-1}\mathcal{C}$ commutes with finite limits.
\end{lemma}

\begin{proof}
This is dual to Lemma \ref{lemma-left-localization-limits}.
\end{proof}

\begin{lemma}
\label{lemma-right-localization-diagram}
Let $\mathcal{C}$ be a category. Let $S$ be a right multiplicative
system. If $f : X \to Y$, $f' : X' \to Y'$ are two morphisms of
$\mathcal{C}$ and if
$$
\xymatrix{
Q(X) \ar[d]_{Q(f)} \ar[r]_a & Q(X') \ar[d]^{Q(f')} \\
Q(Y) \ar[r]^b & Q(Y')
}
$$
is a commutative diagram in $S^{-1}\mathcal{C}$, then there exists
a morphism $f'' : X'' \to Y''$ in $\mathcal{C}$ and a commutative
diagram
$$
\xymatrix{
X \ar[d]_f & X'' \ar[l]^s \ar[d]^{f''} \ar[r]_g & X' \ar[d]^{f'} \\
Y & Y'' \ar[l]_t \ar[r]^h & Y'
}
$$
in $\mathcal{C}$ with $s, t \in S$ and $a = gs^{-1}$, $b = ht^{-1}$.
\end{lemma}

\begin{proof}
This lemma is dual to
Lemma \ref{lemma-left-localization-diagram}.
\end{proof}

\noindent
{\bf Multiplicative systems and two sided calculus of fractions.}
If $S$ is a multiplicative system then left and right calculus of
fractions give canonically isomorphic categories.

\begin{lemma}
\label{lemma-multiplicative-system}
Let $\mathcal{C}$ be a category and let $S$ be a multiplicative system.
The category of left fractions and the category of right fractions
$S^{-1}\mathcal{C}$ are canonically isomorphic.
\end{lemma}

\begin{proof}
Denote $\mathcal{C}_{left}$, $\mathcal{C}_{right}$ the two categories
of fractions. By the universal properties of
Lemmas \ref{lemma-properties-left-localization} and
\ref{lemma-properties-right-localization}
we obtain functors $\mathcal{C}_{left} \to \mathcal{C}_{right}$
and $\mathcal{C}_{right} \to \mathcal{C}_{left}$.
By the uniqueness statement in the universal properties, these
functors are each other's inverse.
\end{proof}

\begin{definition}
\label{definition-saturated-multiplicative-system}
Let $\mathcal{C}$ be a category and let $S$ be a multiplicative system.
We say $S$ is {\it saturated} if, in addition to MS1, MS2, MS3, we
also have
\begin{enumerate}
\item[MS4] Given three composable morphisms $f, g, h$, if
$fg, gh \in S$, then $g \in S$.
\end{enumerate}
\end{definition}

\noindent
Note that a saturated multiplicative system contains all isomorphisms.
Moreover, if  $f, g, h$ are composable morphisms in a category and
$fg, gh$ are isomorphisms, then $g$ is an isomorphism (because then $g$
has both a left and a right inverse, hence is invertible).

\begin{lemma}
\label{lemma-what-gets-inverted}
Let $\mathcal{C}$ be a category and let $S$ be a multiplicative system.
Denote $Q : \mathcal{C} \to S^{-1}\mathcal{C}$ the localization functor.
The set
$$
\hat S = \{f \in \text{Arrows}(\mathcal{C}) \mid
Q(f) \text{ is an isomorphism}\}
$$
is equal to
$$
S' = \{f \in \text{Arrows}(\mathcal{C}) \mid
\text{there exist }g, h\text{ such that }gf, fh \in S\}
$$
and is the smallest saturated multiplicative system containing $S$.
In particular, if $S$ is saturated, then $\hat S = S$.
\end{lemma}

\begin{proof}
It is clear that $S \subset S' \subset \hat S$ because elements of
$S'$ map to morphisms in $S^{-1}\mathcal{C}$ which have both left
and right inverses. Note that $S'$ satisfies MS4, and that
$\hat S$ satisfies MS1. Next, we prove that $S' = \hat S$.

\medskip\noindent
Let $f \in \hat S$. Let $s^{-1}g = ht^{-1}$ be the inverse morphism
in $S^{-1}\mathcal{C}$. (We may use both left fractions and right
fractions to describe morphisms in $S^{-1}\mathcal{C}$, see
Lemma \ref{lemma-multiplicative-system}.)
The relation $\text{id}_X = s^{-1}gf$ in $S^{-1}\mathcal{C}$ means
there exists a commutative diagram
$$
\xymatrix{
 & X' \ar[d]^u & \\
X \ar[ru]^{gf} \ar[r]^{f'} \ar[rd]_{\text{id}_X} &
X'' &
X \ar[lu]_s \ar[l]_{s'} \ar[ld]^{\text{id}_X} \\
& X \ar[u]_v &
}
$$
for some morphisms $f', u, v$ and $s' \in S$. Hence $ugf = s' \in S$.
Similarly, using that $\text{id}_Y = fht^{-1}$ one proves that
$fhw \in S$ for some $w$. We conclude that $f \in S'$. Thus
$S' = \hat S$. Provided we prove that $S' = \hat S$ is a
multiplicative system it is now clear that this implies that $S' = \hat S$
is the smallest saturated system containing $S$.

\medskip\noindent
Our remarks above take care of MS1 and MS4, so to finish the proof of the
lemma we have to show that LMS2, RMS2, LMS3, RMS3 hold for $\hat S$.
Let us check that LMS2 holds for $\hat S$. Suppose we have a solid diagram
$$
\xymatrix{
X \ar[d]_t \ar[r]_g & Y \ar@{..>}[d]^s \\
Z \ar@{..>}[r]^f & W
}
$$
with $t \in \hat S$. Pick a morphism $a : Z \to Z'$ such that
$at \in S$. Then we can use LMS2 for $S$ to find a commutative diagram
$$
\xymatrix{
X \ar[d]_t \ar[r]_g & Y \ar[dd]^s \\
Z \ar[d]_a  \\
Z' \ar[r]^{f'} & W
}
$$
and setting $f = f' \circ a$ we win. The proof of RMS2 is dual to this.
Finally, suppose given a pair of morphisms $f, g : X \to Y$ and
$t \in \hat S$ with target $X$ such that $ft = gt$.
Then we pick a morphism $b$ such that $tb \in S$. Then
$ftb = gtb$ which implies by LMS3 for $S$ that there exists an $s \in S$
with source $Y$ such that $sf = sg$ as desired. The proof of
RMS3 is dual to this.
\end{proof}








\section{Formal properties}
\label{section-formal-cat-cat}

\noindent
In this section we discuss some formal properties of the
$2$-category of categories. This will lead us to the definition
of a (strict) $2$-category later.

\medskip\noindent
Let us denote $\Ob(\textit{Cat})$ the class of all categories.
For every pair of categories
$\mathcal{A}, \mathcal{B} \in \Ob(\textit{Cat})$
we have the ``small'' category of functors
$\text{Fun}(\mathcal{A}, \mathcal{B})$.
Composition of transformation of functors such as
$$
\xymatrix{
\mathcal{A}
\rruppertwocell^{F''}{t'}
\ar[rr]_(.3){F'}
\rrlowertwocell_F{t}
& &
\mathcal{B}
}
\text{ composes to }
\xymatrix{
\mathcal{A}
\rrtwocell^{F''}_F{\ \ t \circ t'}
& &
\mathcal{B}
}
$$
is called {\it vertical} composition. We will use the usual
symbol $\circ$ for this. Next, we will define {\it horizontal}
composition. In order to do this we explain a bit more
of the structure at hand.

\medskip\noindent
Namely for every triple
of categories $\mathcal{A}$, $\mathcal{B}$, and $\mathcal{C}$
there is a composition law
$$
\circ : \Ob(\text{Fun}(\mathcal{B}, \mathcal{C}))
\times
\Ob(\text{Fun}(\mathcal{A}, \mathcal{B}))
\longrightarrow
\Ob(\text{Fun}(\mathcal{A}, \mathcal{C}))
$$
coming from composition of functors. This composition law
is associative, and identity functors act as units. In other
words -- forgetting about transformations of functors --
we see that $\textit{Cat}$ forms a category. How does
this structure interact with the morphisms between functors?

\medskip\noindent
Well, given $t : F \to F'$ a transformation of
functors $F, F' : \mathcal{A} \to \mathcal{B}$ and
a functor
$G : \mathcal{B} \to \mathcal{C}$ we can define
a transformation of functors
$G\circ F \to G \circ F'$. We will denote this
transformation ${}_Gt$. It is given by the formula
$({}_Gt)_x = G(t_x) : G(F(x)) \to G(F'(x))$
for all $x \in \mathcal{A}$.
In this way composition
with $G$ becomes a functor
$$
\text{Fun}(\mathcal{A}, \mathcal{B})
\longrightarrow
\text{Fun}(\mathcal{A}, \mathcal{C}).
$$
To see this you just have to check that
${}_G(\text{id}_F) = \text{id}_{G \circ F}$ and that
${}_G(t_1 \circ t_2) = {}_Gt_1 \circ {}_Gt_2$.
Of course we also have that ${}_{\text{id}_\mathcal{A}}t = t$.

\medskip\noindent
Similarly, given $s : G \to G'$ a transformation of
functors $G, G' : \mathcal{B} \to \mathcal{C}$ and
$F : \mathcal{A} \to \mathcal{B}$ a functor we can define
$s_F$ to be the transformation of functors
$G\circ F \to G' \circ F$ given by
$(s_F)_x = s_{F(x)} : G(F(x)) \to G'(F(x))$
for all $x \in \mathcal{A}$. In this way
composition with $F$ becomes a functor
$$
\text{Fun}(\mathcal{B}, \mathcal{C})
\longrightarrow
\text{Fun}(\mathcal{A}, \mathcal{C}).
$$
To see this you just have to check that
$(\text{id}_G)_F = \text{id}_{G\circ F}$ and that
$(s_1 \circ s_2)_F = s_{1, F} \circ s_{2, F}$.
Of course we also have that $s_{\text{id}_\mathcal{B}} = s$.

\medskip\noindent
These constructions satisfy the additional properties
$$
{}_{G_1}({}_{G_2}t) = {}_{G_1\circ G_2}t,
\ (s_{F_1})_{F_2} = s_{F_1 \circ F_2},
\text{ and }{}_H(s_F) = ({}_Hs)_F
$$
whenever these make sense.
Finally, given functors $F, F' : \mathcal{A} \to \mathcal{B}$,
and $G, G' : \mathcal{B} \to \mathcal{C}$ and transformations
$t : F \to F'$, and $s : G \to G'$ the following
diagram is commutative
$$
\xymatrix{
G \circ F \ar[r]^{{}_Gt} \ar[d]_{s_F}
&
G \circ F' \ar[d]^{s_{F'}} \\
G' \circ F \ar[r]_{{}_{G'}t}
&
G' \circ F'
}
$$
in other words ${}_{G'}t \circ s_F =  s_{F'}\circ {}_Gt$.
To prove this we just consider what happens on
any object $x \in \Ob(\mathcal{A})$:
$$
\xymatrix{
G(F(x)) \ar[r]^{G(t_x)} \ar[d]_{s_{F(x)}}
&
G(F'(x)) \ar[d]^{s_{F'(x)}} \\
G'(F(x)) \ar[r]_{G'(t_x)}
&
G'(F'(x))
}
$$
which is commutative because $s$ is a transformation
of functors. This compatibility relation allows us
to define horizontal composition.

\begin{definition}
\label{definition-horizontal-composition}
Given a diagram as in the left hand side of:
$$
\xymatrix{
\mathcal{A}
\rtwocell^F_{F'}{t}
&
\mathcal{B}
\rtwocell^G_{G'}{s}
&
\mathcal{C}
}
\text{ gives }
\xymatrix{
\mathcal{A}
\rrtwocell^{G \circ F} _{G' \circ F'}{\ \ s \star t}
& &
\mathcal{C}
}
$$
we define the {\it horizontal} composition $s \star t$ to be the
transformation of functors ${}_{G'}t \circ s_F =  s_{F'}\circ {}_Gt$.
\end{definition}

\noindent
Now we see that we may recover our previously constructed
transformations ${}_Gt$ and $s_F$ as
$ {}_Gt = \text{id}_G \star t $ and $ s_F = s \star \text{id}_F $.
Furthermore, all of the rules we found above are consequences of
the properties stated in the lemma that follows.

\begin{lemma}
\label{lemma-properties-2-cat-cats}
The horizontal and vertical compositions have the following
properties
\begin{enumerate}
\item $\circ$ and $\star$ are associative,
\item the identity transformations $\text{id}_F$
are units for $\circ$,
\item the identity transformations of the identity functors
$\text{id}_{\text{id}_\mathcal{A}}$
are units for $\star$ and $\circ$, and
\item given a diagram
$$
\xymatrix{
\mathcal{A}
\rruppertwocell^F{t}
\ar[rr]_(.3){F'}
\rrlowertwocell_{F''}{t'}
& &
\mathcal{B}
\rruppertwocell^G{s}
\ar[rr]_(.3){G'}
\rrlowertwocell_{G''}{s'}
& &
\mathcal{C}
}
$$
we have $ (s' \circ s) \star (t' \circ t) = (s' \star t') \circ (s \star t)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The last statement turns using our previous notation into the following
equation
$$
s'_{F''}
\circ
{}_{G'}t'
\circ
s_{F'}
\circ
{}_Gt
=
(s' \circ s)_{F''}
\circ
{}_G(t' \circ t).
$$
According to our result above applied to the middle composition
we may rewrite the left hand side as
$
s'_{F''}
\circ
s_{F''}
\circ
{}_Gt'
\circ
{}_Gt
$
which is easily shown to be equal to the right hand side.
\end{proof}

\noindent
Another way of formulating condition (4) of the lemma is
that composition of functors and horizontal composition
of transformation of functors gives rise to a functor
$$
(\circ, \star) :
\text{Fun}(\mathcal{B}, \mathcal{C})
\times
\text{Fun}(\mathcal{A}, \mathcal{B})
\longrightarrow
\text{Fun}(\mathcal{A}, \mathcal{C})
$$
whose source is the product category,
see Definition \ref{definition-product-category}.

\section{2-categories}
\label{section-2-categories}

\noindent
We will give a definition of (strict) $2$-categories as they appear
in the setting of stacks. Before you read this take a look at
Section \ref{section-formal-cat-cat} and
Example \ref{example-2-1-category-of-categories}.
Basically, you take this example
and you write out all the rules satisfied by the objects, $1$-morphisms
and $2$-morphisms in that example.

\begin{definition}
\label{definition-2-category}
A (strict) {\it $2$-category} $\mathcal{C}$ consists of the following data
\begin{enumerate}
\item A set of objects $\Ob(\mathcal{C})$.
\item For each pair $x, y \in \Ob(\mathcal{C})$
a category $\Mor_\mathcal{C}(x, y)$. The objects of
$\Mor_\mathcal{C}(x, y)$ will be called {\it $1$-morphisms}
and denoted $F : x \to y$. The morphisms between these $1$-morphisms
will be called {\it $2$-morphisms} and denoted $t : F' \to F$.
The composition of $2$-morphisms in $\Mor_\mathcal{C}(x, y)$
will be called {\it vertical} composition and will be
denoted $t \circ t'$ for $t : F' \to F$ and $t' : F'' \to F'$.
\item For each triple $x, y, z\in \Ob(\mathcal{C})$ a
functor
$$
(\circ, \star) :
\Mor_\mathcal{C}(y, z) \times \Mor_\mathcal{C}(x, y)
\longrightarrow
\Mor_\mathcal{C}(x, z).
$$
The image of the pair of $1$-morphisms $(F, G)$ on the left hand side
will be called the {\it composition} of $F$ and $G$, and denoted
$F\circ G$. The image of the pair of $2$-morphisms $(t, s)$ will
be called the {\it horizontal} composition and denoted $t \star s$.
\end{enumerate}
These data are to satisfy the following rules:
\begin{enumerate}
\item The set of objects together with the set of $1$-morphisms endowed
with composition of $1$-morphisms forms a category.
\item Horizontal composition of $2$-morphisms is associative.
\item The identity $2$-morphism $\text{id}_{\text{id}_x}$
of the identity $1$-morphism $\text{id}_x$ is a unit for
horizontal composition.
\end{enumerate}
\end{definition}

\noindent
This is obviously not a very pleasant type of object to work with.
On the other hand, there are lots of examples where it is quite clear
how you work with it. The only example we have so far is that of
the $2$-category whose objects are a given collection of categories,
$1$-morphisms are functors between these categories,
and $2$-morphisms are natural transformations of functors, see
Section \ref{section-formal-cat-cat}.
As far as this text is concerned all $2$-categories will be
sub $2$-categories of this example. Here is what it means to be
a sub $2$-category.

\begin{definition}
\label{definition-sub-2-category}
Let $\mathcal{C}$ be a $2$-category.
A {\it sub $2$-category} $\mathcal{C}'$ of $\mathcal{C}$, is given by a subset
$\Ob(\mathcal{C}')$ of $\Ob(\mathcal{C})$
and sub categories $\Mor_{\mathcal{C}'}(x, y)$ of the
categories $\Mor_\mathcal{C}(x, y)$ for all
$x, y \in \Ob(\mathcal{C}')$ such that these, together with
the operations $\circ$ (composition $1$-morphisms), $\circ$ (vertical
composition $2$-morphisms), and $\star$ (horizontal composition)
form a $2$-category.
\end{definition}

\begin{remark}
\label{remark-big-2-categories}
Big $2$-categories.
In many texts a $2$-category is allowed to have a class of
objects (but hopefully a ``class of classes'' is not allowed).
We will allow these ``big'' $2$-categories as well, but only
in the following list of cases (to be updated as we go along):
\begin{enumerate}
\item The $2$-category of categories $\textit{Cat}$.
\item The $(2, 1)$-category of categories $\textit{Cat}$.
\item The $2$-category of groupoids $\textit{Groupoids}$.
\item The $(2, 1)$-category of groupoids $\textit{Groupoids}$.
\item The $2$-category of fibred categories over a fixed category.
\item The $(2, 1)$-category of fibred categories over a fixed category.
\end{enumerate}
See Definition \ref{definition-2-1-category}.
Note that in each case the class of objects of the $2$-category
$\mathcal{C}$ is a proper class, but for all objects $x, y \in \Ob(C)$
the category $\Mor_\mathcal{C}(x, y)$ is ``small'' (according to
our conventions).
\end{remark}

\noindent
The notion of equivalence of categories that we defined in Section
\ref{section-definition-categories} extends to the more general setting of
$2$-categories as follows.

\begin{definition}
\label{definition-equivalence}
Two objects $x, y$ of a $2$-category are {\it equivalent} if there exist
$1$-morphisms $F : x \to y$ and $G : y \to x$ such that $F \circ G$ is
$2$-isomorphic to $\text{id}_y$ and $G \circ F$ is $2$-isomorphic to
$\text{id}_x$.
\end{definition}

\noindent
Sometimes we need to say what it means to have a functor from a
category into a $2$-category.

\begin{definition}
\label{definition-functor-into-2-category}
Let $\mathcal{A}$ be a category and let $\mathcal{C}$ be a $2$-category.
\begin{enumerate}
\item A {\it functor} from an ordinary category into a $2$-category
will ignore the
$2$-morphisms unless mentioned otherwise. In other words, it will be a
``usual'' functor into the category formed out of 2-category by forgetting
all the 2-morphisms.
\item A {\it weak functor}, or
a {\it pseudo functor} $\varphi$ from $\mathcal{A}$ into the 2-category
$\mathcal{C}$ is given by the following data
\begin{enumerate}
\item a map $\varphi : \Ob(\mathcal{A}) \to \Ob(\mathcal{C})$,
\item for every pair $x, y\in \Ob(\mathcal{A})$, and every
morphism $f : x \to y$ a $1$-morphism $\varphi(f) : \varphi(x) \to \varphi(y)$,
\item for every $x\in \Ob(A)$ a $2$-morphism
$\alpha_x : \text{id}_{\varphi(x)} \to \varphi(\text{id}_x)$, and
\item for every pair of composable morphisms $f : x \to y$,
$g : y \to z$ of $\mathcal{A}$ a $2$-morphism
$\alpha_{g, f} : \varphi(g \circ f) \to \varphi(g) \circ \varphi(f)$.
\end{enumerate}
These data are subject to the following conditions:
\begin{enumerate}
\item the $2$-morphisms $\alpha_x$ and $\alpha_{g, f}$ are all
isomorphisms,
\item for any morphism $f : x \to y$ in $\mathcal{A}$ we have
$\alpha_{\text{id}_y, f} = \alpha_y \star \text{id}_{\varphi(f)}$:
$$
\xymatrix{
\varphi(x)
\rrtwocell^{\varphi(f)}_{\varphi(f)}{\ \ \ \ \text{id}_{\varphi(f)}}
& &
\varphi(y)
\rrtwocell^{\text{id}_{\varphi(y)}}_{\varphi(\text{id}_y)}{\alpha_y}
& &
\varphi(y)
}
=
\xymatrix{
\varphi(x)
\rrtwocell^{\varphi(f)}_{\varphi(\text{id}_y) \circ \varphi(f)}{\ \ \ \ \alpha_{\text{id}_y, f}}
& &
\varphi(y)
}
$$
\item for any morphism $f : x \to y$ in $\mathcal{A}$ we have
$\alpha_{f, \text{id}_x} = \text{id}_{\varphi(f)} \star \alpha_x$,
\item for any triple of composable morphisms
$f : w \to x$, $g : x \to y$, and $h : y \to z$ of $\mathcal{A}$
we have
$$
(\text{id}_{\varphi(h)} \star \alpha_{g, f})
\circ
\alpha_{h, g \circ f}
=
(\alpha_{h, g} \star \text{id}_{\varphi(f)})
\circ
\alpha_{h \circ g, f}
$$
in other words the following diagram with objects
$1$-morphisms and arrows $2$-morphisms commutes
$$
\xymatrix{
\varphi(h \circ g \circ f)
\ar[d]_{\alpha_{h, g \circ f}}
\ar[rr]_{\alpha_{h \circ g, f}}
& &
\varphi(h \circ g) \circ \varphi(f)
\ar[d]^{\alpha_{h, g} \star \text{id}_{\varphi(f)}} \\
\varphi(h) \circ \varphi(g \circ f)
\ar[rr]^{\text{id}_{\varphi(h)} \star \alpha_{g, f}}
& &
\varphi(h) \circ \varphi(g) \circ \varphi(f)
}
$$
\end{enumerate}
\end{enumerate}
\end{definition}

\noindent
Again this is not a very workable notion, but it does sometimes come up.
There is a theorem that says that any pseudo-functor is isomorphic to
a functor. Finally, there are the notions of
{\it functor between  $2$-categories}, and
{\it pseudo functor between $2$-categories}.
This last notion leads us into $3$-category territory.
We would like to avoid having to define this at almost any cost!

\section{(2, 1)-categories}
\label{section-2-1-categories}

\noindent
Some $2$-categories have
the property that all $2$-morphisms are isomorphisms. These will
play an important role in the following, and they are easier to work with.

\begin{definition}
\label{definition-2-1-category}
A (strict) {\it $(2, 1)$-category} is a $2$-category in which all
$2$-morphisms are isomorphisms.
\end{definition}

\begin{example}
\label{example-2-1-category-of-categories}
The $2$-category $\textit{Cat}$, see Remark \ref{remark-big-2-categories},
can be turned into a $(2, 1)$-category by only allowing isomorphisms of
functors as $2$-morphisms.
\end{example}

\noindent
In fact, more generally any $2$-category
$\mathcal{C}$ produces a $(2, 1)$-category by considering the sub $2$-category
$\mathcal{C}'$ with the same objects and $1$-morphisms but whose
$2$-morphisms are the invertible $2$-morphisms of $\mathcal{C}$.
In this situation we will say ``{\it let $\mathcal{C}'$ be
the $(2, 1)$-category associated to $\mathcal{C}$}'' or similar.
For example, the $(2, 1)$-category of groupoids means the
$2$-category whose objects are groupoids, whose
$1$-morphisms are functors and whose $2$-morphisms are
isomorphisms of functors. Except that this is a bad example as a
transformation between functors between groupoids is automatically
an isomorphism!

\begin{remark}
\label{remark-other-2-categories}
Thus there are variants of the construction of
Example \ref{example-2-1-category-of-categories}
above where we look at the $2$-category of groupoids,
or categories fibred in groupoids over a fixed
category, or stacks. And so on.
\end{remark}






\section{2-fibre products}
\label{section-2-fibre-products}

\noindent
In this section we introduce $2$-fibre products. Suppose that $\mathcal{C}$
is a 2-category. We say that a diagram
$$
\xymatrix{
w \ar[r] \ar[d] & y \ar[d] \\
x \ar[r] & z }
$$
2-commutes if the two 1-morphisms $w \to y \to z$ and $w \to x \to z$ are
2-isomorphic. In a 2-category it is more natural to ask for 2-commutativity
of diagrams than for actually commuting diagrams. (Indeed, some may say that
we should not work with strict 2-categories at all, and in a ``weak''
2-category the notion of a commutative diagram of 1-morphisms does not even
make sense.) Correspondingly the notion of a fibre product has to be adjusted.

\medskip\noindent
Let $\mathcal{C}$ be a $2$-category. Let $x, y, z\in \Ob(\mathcal{C})$ and
$f\in \Mor_\mathcal{C}(x, z)$ and $g\in \Mor_{\mathcal C}(y, z)$.
In order to define the 2-fibre product of $f$ and $g$ we are going to look at
2-commutative diagrams
$$
\xymatrix{
& w \ar[r]_a \ar[d]_b & x \ar[d]^{f} \\
& y \ar[r]^{g} & z. }
$$
Now in the case of categories, the fibre product is a final object in the
category of such diagrams. Correspondingly a 2-fibre product is a final object
in a 2-category (see definition below). The {\it $2$-category
of $2$-commutative diagrams} is the $2$-category defined as follows:
\begin{enumerate}
\item Objects are quadruples $(w, a, b, \phi)$ as above where $\phi$
is an invertible 2-morphism $\phi : f \circ a \to g \circ b$,
\item 1-morphisms from $(w', a', b', \phi')$ to $(w, a, b, \phi)$ are given by
$(k : w' \to w, \alpha : a' \to a \circ k, \beta : b' \to b \circ k)$
such that
$$
\xymatrix{
f \circ a'
\ar[rr]_{\text{id}_f \star \alpha}
\ar[d]_{\phi'}
& &
f \circ a \circ k
\ar[d]^{\phi \star \text{id}_k}
\\
g \circ b'
\ar[rr]^{\text{id}_g \star \beta}
& &
g \circ b \circ k
}
$$
is commutative,
\item given a second $1$-morphism
$(k', \alpha', \beta') : (w'', a'', b'', \phi'') \to
(w', \alpha', \beta', \phi')$ the composition of $1$-morphisms
is given by the rule
$$
(k, \alpha, \beta) \circ (k', \alpha', \beta') =
(k \circ k',
(\alpha \star \text{id}_{k'}) \circ \alpha',
(\beta \star \text{id}_{k'}) \circ \beta'),
$$
\item a 2-morphism between $1$-morphisms
$(k_i, \alpha_i, \beta_i)$, $i = 1, 2$ with the same source and target
is given by a 2-morphism $\delta : k_1 \to k_2$ such that
$$
\xymatrix{
a'
\ar[rd]_{\alpha_2}
\ar[r]_{\alpha_1} &
a \circ k_1
\ar[d]^{\text{id}_a \star \delta} &
&
b \circ k_1
\ar[d]_{\text{id}_b \star \delta} &
b'
\ar[l]^{\beta_1}
\ar[ld]^{\beta_2}
\\
&
a \circ k_2
&
&
b \circ k_2
&
}
$$
commute,
\item vertical composition of $2$-morphisms is given by
vertical composition of the morphisms $\delta$ in $\mathcal{C}$, and
\item horizontal composition of the diagram
$$
\xymatrix{
(w'', a'', b'', \phi'')
\rrtwocell^{(k'_1, \alpha'_1, \beta'_1)}_{(k'_2, \alpha'_2, \beta'_2)}{\delta'}
& &
(w', a', b', \phi')
\rrtwocell^{(k_1, \alpha_1, \beta_1)}_{(k_2, \alpha_2, \beta_2)}{\delta}
& &
(w, a, b, \phi)
}
$$
is given by the diagram
$$
\xymatrix@C=12pc{
(w'', a'', b'', \phi'')
\rtwocell^{(k_1 \circ k'_1, (\alpha_1 \star \text{id}_{k'_1}) \circ \alpha'_1, (\beta_1 \star \text{id}_{k'_1}) \circ \beta'_1)}_{(k_2 \circ k'_2, (\alpha_2 \star \text{id}_{k'_2}) \circ \alpha'_2, (\beta_2 \star \text{id}_{k'_2}) \circ \beta'_2)}{\ \ \ \delta \star \delta'}
&
(w, a, b, \phi)
}
$$
\end{enumerate}
Note that if $\mathcal{C}$ is actually a $(2, 1)$-category,
the morphisms $\alpha$ and $\beta$ in (2) above are automatically
also isomorphisms\footnote{In fact it seems in the $2$-category case
that one could define another 2-category of 2-commutative diagrams where
the direction of the arrows $\alpha$, $\beta$ is reversed, or even
where the direction of only one of them is reversed. This is why
we restrict to $(2, 1)$-categories later on.}.
In addition the $2$-category of
$2$-commutative diagrams is also a $(2, 1)$-category if $\mathcal{C}$ is
a $(2, 1)$-category.

\begin{definition}
\label{definition-final-object-2-category}
A {\it final object} of a $(2, 1)$-category
$\mathcal{C}$ is an object $x$ such that
\begin{enumerate}
\item for every $y \in \Ob(\mathcal{C})$ there is a morphism $y \to x$,
and
\item every two morphisms $y \to x$ are isomorphic by a unique 2-morphism.
\end{enumerate}
\end{definition}

\noindent
Likely, in the more general case of $2$-categories there are different
flavours of final objects. We do not want to get into this and hence
we only define $2$-fibre products in the $(2, 1)$-case.

\begin{definition}
\label{definition-2-fibre-products}
Let $\mathcal{C}$ be a $(2, 1)$-category.
Let $x, y, z\in \Ob(\mathcal{C})$ and
$f\in \Mor_\mathcal{C}(x, z)$
and $g\in \Mor_{\mathcal C}(y, z)$. A
{\it 2-fibre product of $f$ and $g$} is
a final object in the category of 2-commutative diagrams
described above. If a 2-fibre product exists we
will denote it $x \times_z y\in \Ob(\mathcal{C})$, and denote the
required morphisms $p\in \Mor_{\mathcal C}(x \times_z y, x)$ and
$q\in \Mor_{\mathcal C}(x \times_z y, y)$ making the diagram
$$
\xymatrix{
& x \times_z y \ar[r]^{p} \ar[d]_q & x \ar[d]^{f} \\
& y \ar[r]^{g} & z }
$$
2-commute and we will denote the given invertible
2-morphism exhibiting this by $\psi : f \circ p \to g \circ q$.
\end{definition}

\noindent
Thus the following universal property holds: for any
$w\in \Ob(\mathcal{C})$ and morphisms
$a \in \Mor_{\mathcal C}(w, x)$ and
$b \in \Mor_\mathcal{C}(w, y)$ with a given 2-isomorphism
$\phi : f \circ a \to g\circ b$
there is a $\gamma \in \Mor_{\mathcal C}(w, x \times_z y)$
making the diagram
$$
\xymatrix{
w\ar[rrrd]^a \ar@{-->}[rrd]_\gamma \ar[rrdd]_b & & \\
& & x \times_z y \ar[r]_p \ar[d]_q & x \ar[d]^{f} \\
& & y \ar[r]^{g} & z }
$$
2-commute such that for suitable choices of
$a \to p \circ \gamma$ and $b \to q \circ \gamma$
the diagram
$$
\xymatrix{
f \circ a \ar[r] \ar[d]_\phi &
f \circ p \circ \gamma
\ar[d]^{\psi \star \text{id}_\gamma}
\\
g\circ b
\ar[r]
&
g \circ q \circ \gamma
}
$$
commutes. Moreover $\gamma$ is unique up to isomorphism.
Of course the exact properties are finer than this. All of the
cases of 2-fibre products that we will need later on come from the following
example of 2-fibre products in the 2-category of categories.

\begin{example}
\label{example-2-fibre-product-categories}
Let $\mathcal{A}$, $\mathcal{B}$, and $\mathcal{C}$ be categories.
Let $F : \mathcal{A} \to \mathcal{C}$ and $G : \mathcal{B} \to \mathcal{C}$
be functors. We define a category
$\mathcal{A} \times_\mathcal{C} \mathcal{B}$ as follows:
\begin{enumerate}
\item an object of $\mathcal{A} \times_\mathcal{C} \mathcal{B}$ is a triple
$(A, B, f)$, where $A\in \Ob(\mathcal{A})$, $B\in \Ob(\mathcal{B})$,
and $f : F(A) \to G(B)$ is an isomorphism in $\mathcal{C}$,
\item a morphism $(A, B, f) \to (A', B', f')$ is given by a pair $(a, b)$, where
$a : A \to A'$ is a morphism in $\mathcal{A}$, and $b : B \to B'$ is a
morphism in $\mathcal{B}$ such that the diagram
$$
\xymatrix{
F(A) \ar[r]^f \ar[d]^{F(a)} & G(B) \ar[d]^{G(b)} \\
F(A') \ar[r]^{f'} & G(B')
}
$$
is commutative.
\end{enumerate}
Moreover, we define functors
$p : \mathcal{A} \times_\mathcal{C}\mathcal{B} \to \mathcal{A}$
and
$q : \mathcal{A} \times_\mathcal{C}\mathcal{B} \to \mathcal{B}$
by setting
$$
p(A, B, f) = A, \quad q(A, B, f) = B,
$$
in other words, these are the forgetful functors.
We define a transformation of functors $\psi : F \circ p \to G \circ q$.
On the object $\xi = (A, B, f)$ it is given by
$\psi_\xi = f : F(p(\xi)) = F(A) \to G(B) = G(q(\xi))$.
\end{example}

\begin{lemma}
\label{lemma-2-fibre-product-categories}
In the $(2, 1)$-category of categories $2$-fibre products exist and
are given by the construction of
Example \ref{example-2-fibre-product-categories}.
\end{lemma}

\begin{proof}
Let us check the universal property:
let $\mathcal{W}$ be a category, let
$a : \mathcal{W} \to \mathcal{A}$ and
$b : \mathcal{W} \to \mathcal{B}$ be functors, and
let $t : F \circ a \to G \circ b$ be an isomorphism of functors.

\medskip\noindent
Consider the functor
$\gamma : \mathcal{W} \to \mathcal{A} \times_\mathcal{C}\mathcal{B}$
given by $W \mapsto (a(W), b(W), t_W)$.
(Check this is a functor omitted.)
Moreover, consider $\alpha : a \to p \circ \gamma$ and
$\beta : b \to q \circ \gamma$ obtained from the identities
$p \circ \gamma = a$ and $q \circ \gamma = b$. Then it is
clear that $(\gamma, \alpha, \beta)$ is a morphism
from $(W, a, b, t)$ to
$(\mathcal{A} \times_\mathcal{C} \mathcal{B}, p, q, \psi)$.

\medskip\noindent
Let
$(k, \alpha', \beta') :
(W, a, b, t) \to (\mathcal{A} \times_\mathcal{C} \mathcal{B}, p, q, \psi)$
be a second such morphism. For an object $W$ of $\mathcal{W}$ let us write
$k(W) = (a_k(W), b_k(W), t_{k, W})$. Hence $p(k(W)) = a_k(W)$ and so on.
The map $\alpha'$ corresponds to functorial maps
$\alpha' : a(W) \to a_k(W)$. Since we are working in the
$(2, 1)$-category of categories, in fact each of the maps
$a(W) \to a_k(W)$ is an isomorphism. We can use these
(and their counterparts $b(W) \to b_k(W)$) to get isomorphisms
$$
\delta_W :
\gamma(W) = (a(W), b(W), t_W)
\longrightarrow
(a_k(W), b_k(W), t_{k, W}) = k(W).
$$
It is straightforward to show that $\delta$ defines a
$2$-isomorphism between $\gamma$ and $k$ in the $2$-category
of $2$-commutative diagrams as desired.
\end{proof}

\begin{remark}
\label{remark-other-description-2-fibre-product}
Let $\mathcal{A}$, $\mathcal{B}$, and $\mathcal{C}$ be categories.
Let $F : \mathcal{A} \to \mathcal{C}$ and $G : \mathcal{B} \to \mathcal{C}$
be functors. Another, slightly more symmetrical, construction of a $2$-fibre
product $\mathcal{A} \times_\mathcal{C} \mathcal{B}$ is as follows.
An object is a quintuple $(A, B, C, a, b)$ where $A, B, C$ are objects
of $\mathcal{A}, \mathcal{B}, \mathcal{C}$ and where $a : F(A) \to C$
and $b : G(B) \to C$ are isomorphisms. A morphism
$(A, B, C, a, b) \to (A', B', C', a', b')$ is given by a triple
of morphisms $A \to A', B \to B', C \to C'$ compatible with the morphisms
$a, b, a', b'$. We can prove directly that this leads to a $2$-fibre
product. However, it is easier to observe that the functor
$(A, B, C, a, b) \mapsto (A, B, b^{-1} \circ a)$ gives an equivalence
from the category of quintuples to the category constructed in
Example \ref{example-2-fibre-product-categories}.
\end{remark}

\begin{lemma}
\label{lemma-functoriality-2-fibre-product}
Let
$$
\xymatrix{
& \mathcal{Y} \ar[d]_I \ar[rd]^K & \\
\mathcal{X} \ar[r]^H \ar[rd]^L &
\mathcal{Z} \ar[rd]^M & \mathcal{B} \ar[d]^G \\
& \mathcal{A} \ar[r]^F & \mathcal{C}
}
$$
be a $2$-commutative diagram of categories.
A choice of isomorphisms
$\alpha : G \circ K \to M \circ I$ and
$\beta : M \circ H \to F \circ L$
determines a morphism
$$
\mathcal{X} \times_\mathcal{Z} \mathcal{Y}
\longrightarrow
\mathcal{A} \times_\mathcal{C} \mathcal{B}
$$
of $2$-fibre products associated to this situation.
\end{lemma}

\begin{proof}
Just use the functor
$$
(X, Y, \phi) \longmapsto (L(X), K(Y),
\alpha^{-1}_Y \circ M(\phi) \circ \beta^{-1}_X)
$$
on objects and
$$
(a, b) \longmapsto (L(a), K(b))
$$
on morphisms.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-2-fibre-product}
Assumptions as in Lemma \ref{lemma-functoriality-2-fibre-product}.
\begin{enumerate}
\item If $K$ and $L$ are faithful
then the morphism
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y} \to
\mathcal{A} \times_\mathcal{C} \mathcal{B}$
is faithful.
\item If $K$ and $L$ are fully faithful and $M$ is faithful
then the morphism
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y} \to
\mathcal{A} \times_\mathcal{C} \mathcal{B}$
is fully faithful.
\item If $K$ and $L$ are equivalences and $M$ is fully faithful
then the morphism
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y} \to
\mathcal{A} \times_\mathcal{C} \mathcal{B}$
is an equivalence.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $(X, Y, \phi)$ and $(X', Y', \phi')$ be objects of
$\mathcal{X} \times_\mathcal{Z} \mathcal{Y}$.
Set $Z = H(X)$ and identify it with $I(Y)$ via $\phi$.
Also, identify $M(Z)$ with $F(L(X))$ via $\alpha_X$ and
identify $M(Z)$ with $G(K(Y))$ via $\beta_Y$. Similarly for
$Z' = H(X')$ and $M(Z')$.
The map on morphisms is the map
$$
\xymatrix{
\Mor_\mathcal{X}(X, X')
\times_{\Mor_\mathcal{Z}(Z, Z')}
\Mor_\mathcal{Y}(Y, Y')
\ar[d] \\
\Mor_\mathcal{A}(L(X), L(X'))
\times_{\Mor_\mathcal{C}(M(Z), M(Z'))}
\Mor_\mathcal{B}(K(Y), K(Y'))
}
$$
Hence parts (1) and (2) follow. Moreover, if $K$ and $L$
are equivalences and $M$ is fully faithful, then any object
$(A, B, \phi)$ is in the essential image for the following reasons:
Pick $X$, $Y$ such that $L(X) \cong A$ and $K(Y) \cong B$.
Then the fully faithfulness of $M$ guarantees that we can
find an isomorphism $H(X) \cong I(Y)$. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-associativity-2-fibre-product}
Let
$$
\xymatrix{
\mathcal{A} \ar[rd] & & \mathcal{C} \ar[ld] \ar[rd] & & \mathcal{E} \ar[ld] \\
& \mathcal{B} & & \mathcal{D}
}
$$
be a diagram of categories and functors.
Then there is a canonical isomorphism
$$
(\mathcal{A} \times_\mathcal{B} \mathcal{C}) \times_\mathcal{D} \mathcal{E}
\cong
\mathcal{A} \times_\mathcal{B} (\mathcal{C} \times_\mathcal{D} \mathcal{E})
$$
of categories.
\end{lemma}

\begin{proof}
Just use the functor
$$
((A, C, \phi), E, \psi)
\longmapsto
(A, (C, E, \psi), \phi)
$$
if you know what I mean.
\end{proof}

\noindent
Henceforth we do not write the parentheses when dealing with fibred products
of more than 2 categories.

\begin{lemma}
\label{lemma-triple-2-fibre-product-pr02}
Let
$$
\xymatrix{
\mathcal{A} \ar[rd] & & \mathcal{C} \ar[ld] \ar[rd] & & \mathcal{E} \ar[ld] \\
& \mathcal{B} \ar[rd]_F & & \mathcal{D} \ar[ld]^G \\
& & \mathcal{F} &
}
$$
be a commutative diagram of categories and functors.
Then there is a canonical functor
$$
\text{pr}_{02} :
\mathcal{A} \times_\mathcal{B} \mathcal{C} \times_\mathcal{D} \mathcal{E}
\longrightarrow
\mathcal{A} \times_\mathcal{F} \mathcal{E}
$$
of categories.
\end{lemma}

\begin{proof}
If we write
$\mathcal{A} \times_\mathcal{B} \mathcal{C}
\times_\mathcal{D} \mathcal{E}$
as
$(\mathcal{A} \times_\mathcal{B} \mathcal{C})
\times_\mathcal{D} \mathcal{E}$
then we can just use the functor
$$
((A, C, \phi), E, \psi)
\longmapsto
(A, E, G(\psi) \circ F(\phi))
$$
if you know what I mean.
\end{proof}

\begin{lemma}
\label{lemma-2-fibre-product-erase-factor}
Let
$$
\mathcal{A} \to
\mathcal{B} \leftarrow \mathcal{C} \leftarrow \mathcal{D}
$$
be a diagram of categories and functors.
Then there is a canonical isomorphism
$$
\mathcal{A} \times_\mathcal{B} \mathcal{C} \times_\mathcal{C} \mathcal{D}
\cong
\mathcal{A} \times_\mathcal{B} \mathcal{D}
$$
of categories.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
We claim that this means you can work with these $2$-fibre products
just like with ordinary fibre products. Here are some further lemmas
that actually come up later.

\begin{lemma}
\label{lemma-diagonal-1}
Let
$$
\xymatrix{
\mathcal{C}_3 \ar[r] \ar[d] & \mathcal{S} \ar[d]^\Delta \\
\mathcal{C}_1 \times \mathcal{C}_2 \ar[r]^{G_1 \times G_2} &
\mathcal{S} \times \mathcal{S}
}
$$
be a $2$-fibre product of categories.
Then there is a canonical isomorphism
$\mathcal{C}_3 \cong
\mathcal{C}_1 \times_{G_1, \mathcal{S}, G_2} \mathcal{C}_2$.
\end{lemma}

\begin{proof}
We may assume that $\mathcal{C}_3$ is the category
$(\mathcal{C}_1 \times \mathcal{C}_2)\times_{\mathcal{S} \times \mathcal{S}}
\mathcal{S}$ constructed in Example \ref{example-2-fibre-product-categories}.
Hence an object is a triple
$((X_1, X_2), S, \phi)$ where
$\phi = (\phi_1, \phi_2) : (G_1(X_1), G_2(X_2)) \to (S, S)$
is an isomorphism. Thus we can associate to this the triple
$(X_1, X_2, \phi_2^{-1} \circ \phi_1)$.
Conversely, if $(X_1, X_2, \psi)$ is an object of
$\mathcal{C}_1 \times_{G_1, \mathcal{S}, G_2} \mathcal{C}_2$,
then we can associate to this the triple
$((X_1, X_2), G_2(X_2), (\psi, \text{id}_{G_2(X_2)}))$.
We claim these constructions given mutually inverse functors.
We omit describing how to deal with morphisms
and showing they are mutually inverse.
\end{proof}

\begin{lemma}
\label{lemma-diagonal-2}
Let
$$
\xymatrix{
\mathcal{C}' \ar[r] \ar[d] & \mathcal{S} \ar[d]^\Delta \\
\mathcal{C} \ar[r]^{G_1 \times G_2} &
\mathcal{S} \times \mathcal{S}
}
$$
be a $2$-fibre product of categories.
Then there is a canonical isomorphism
$$
\mathcal{C}' \cong
(\mathcal{C} \times_{G_1, \mathcal{S}, G_2} \mathcal{C})
\times_{(p, q), \mathcal{C} \times \mathcal{C}, \Delta}
\mathcal{C}.
$$
\end{lemma}

\begin{proof}
An object of the right hand side is given by
$((C_1, C_2, \phi), C_3, \psi)$ where
$\phi : G_1(C_1) \to G_2(C_2)$ is an isomorphism
and $\psi = (\psi_1, \psi_2) : (C_1, C_2) \to (C_3, C_3)$ is
an isomorphism. Hence we can associate to this the triple
$(C_3, G_1(C_1), (G_1(\psi_1^{-1}), \phi^{-1} \circ G_2(\psi_2^{-1})))$
which is an object of $\mathcal{C}'$.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-after-map}
Let $\mathcal{A} \to \mathcal{C}$, $\mathcal{B} \to \mathcal{C}$
and $\mathcal{C} \to \mathcal{D}$ be functors between categories.
Then the diagram
$$
\xymatrix{
\mathcal{A} \times_\mathcal{C} \mathcal{B} \ar[d] \ar[r] &
\mathcal{A} \times_\mathcal{D} \mathcal{B} \ar[d] \\
\mathcal{C} \ar[r]^-{\Delta_{\mathcal{C}/\mathcal{D}}} \ar[r] &
\mathcal{C} \times_\mathcal{D} \mathcal{C}
}
$$
is a $2$-fibre product diagram.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-diagonal}
Let
$$
\xymatrix{
\mathcal{U} \ar[d] \ar[r] & \mathcal{V} \ar[d] \\
\mathcal{X} \ar[r] & \mathcal{Y}
}
$$
be a $2$-fibre product of categories. Then the diagram
$$
\xymatrix{
\mathcal{U} \ar[d] \ar[r] &
\mathcal{U} \times_\mathcal{V} \mathcal{U} \ar[d] \\
\mathcal{X} \ar[r] &
\mathcal{X} \times_\mathcal{Y} \mathcal{X}
}
$$
is $2$-cartesian.
\end{lemma}

\begin{proof}
This is a purely $2$-category theoretic statement, valid in any
$(2, 1)$-category with $2$-fibre products. Explicitly, it follows
from the following chain of equivalences:
\begin{align*}
\mathcal{X} \times_{(\mathcal{X} \times_\mathcal{Y} \mathcal{X})}
(\mathcal{U} \times_\mathcal{V} \mathcal{U})
& =
\mathcal{X} \times_{(\mathcal{X} \times_\mathcal{Y} \mathcal{X})}
((\mathcal{X} \times_\mathcal{Y} \mathcal{V})
\times_\mathcal{V} (\mathcal{X} \times_\mathcal{Y} \mathcal{V})) \\
& =
\mathcal{X} \times_{(\mathcal{X} \times_\mathcal{Y} \mathcal{X})}
(\mathcal{X} \times_\mathcal{Y} \mathcal{X}
\times_\mathcal{Y} \mathcal{V}) \\
& =
\mathcal{X} \times_\mathcal{Y} \mathcal{V} = \mathcal{U}
\end{align*}
see
Lemmas \ref{lemma-associativity-2-fibre-product} and
\ref{lemma-2-fibre-product-erase-factor}.
\end{proof}








\section{Categories over categories}
\label{section-categories-over-categories}

\noindent
In this section we have a functor $p : \mathcal{S} \to \mathcal{C}$.
We think of $\mathcal{S}$ as being on top and of $\mathcal{C}$ as being
at the bottom. To make sure that everybody knows what we are talking about
we define the $2$-category of categories over $\mathcal{C}$.

\begin{definition}
\label{definition-categories-over-C}
Let $\mathcal{C}$ be a category.
The {\it $2$-category of categories over $\mathcal{C}$}
is the $2$-category defined as follows:
\begin{enumerate}
\item Its objects will be functors $p : \mathcal{S} \to \mathcal{C}$.
\item Its $1$-morphisms $(\mathcal{S}, p) \to (\mathcal{S}', p')$
will be functors $G : \mathcal{S} \to \mathcal{S}'$ such that
$p' \circ G = p$.
\item Its $2$-morphisms $t : G \to H$ for
$G, H : (\mathcal{S}, p) \to (\mathcal{S}', p')$
will be morphisms of functors
such that $p'(t_x) = \text{id}_{p(x)}$
for all $x \in \Ob(\mathcal{S})$.
\end{enumerate}
In this situation we will denote
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{S}, \mathcal{S}')
$$
the category of $1$-morphisms between
$(\mathcal{S}, p)$ and $(\mathcal{S}', p')$
\end{definition}

\noindent
In this $2$-category we define horizontal and vertical composition
exactly as is done for $\textit{Cat}$ in Section \ref{section-formal-cat-cat}.
The axioms of a $2$-category are satisfied for the same reason
that the hold in $\textit{Cat}$. To see this one can also use that
the axioms hold in $\textit{Cat}$ and verify
things such as ``vertical composition of $2$-morphisms over $\mathcal{C}$
gives another $2$-morphism over $\mathcal{C}$''. This is clear.

\medskip\noindent
Analogously to the fibre of a map of spaces, we have the notion of a
fibre category, and some notions of lifting associated to this
situation.

\begin{definition}
\label{definition-fibre-category}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
\begin{enumerate}
\item The {\it fibre category} over an object $U\in \Ob(\mathcal{C})$
is the category $\mathcal{S}_U$ with objects
$$
\Ob(\mathcal{S}_U) = \{x\in \Ob(\mathcal{S}) :
p(x) = U\}
$$
and morphisms
$$
\Mor_{\mathcal{S}_U}(x, y) = \{ \phi \in \Mor_\mathcal{S}(x, y) :
p(\phi) = \text{id}_U\}.
$$
\item A {\it lift} of an object $U \in \Ob(\mathcal{C})$
is an object $x\in \Ob(\mathcal{S})$ such that $p(x) = U$, i.e.,
$x\in \Ob(\mathcal{S}_U)$. We will also sometime say
that {\it $x$ lies over $U$}.
\item Similarly, a {\it lift} of a morphism $f : V \to U$ in $\mathcal{C}$
is a morphism $\phi : y \to x$ in $\mathcal{S}$ such that $p(\phi) = f$.
We sometimes say that {\it $\phi$ lies over $f$}.
\end{enumerate}
\end{definition}

\noindent
There are some observations we could make here. For example if
$F : (\mathcal{S}, p) \to (\mathcal{S}', p')$ is a $1$-morphism
of categories over $\mathcal{C}$, then $F$ induces functors
of fibre categories $F : \mathcal{S}_U \to \mathcal{S}'_U$.
Similarly for $2$-morphisms.

\medskip\noindent
Here is the obligatory lemma describing the $2$-fibre product in the
$(2, 1)$-category of categories over $\mathcal{C}$.

\begin{lemma}
\label{lemma-2-product-categories-over-C}
Let $\mathcal{C}$ be a category.
The $(2, 1)$-category of categories
over $\mathcal{C}$ has 2-fibre products.
Suppose that
$F : \mathcal{X} \to \mathcal{S}$ and
$G : \mathcal{Y} \to \mathcal{S}$ are morphisms of categories over
$\mathcal{C}$.
An explicit 2-fibre product
$\mathcal{X} \times_\mathcal{S}\mathcal{Y}$ is given by the following
description
\begin{enumerate}
\item an object of $\mathcal{X} \times_\mathcal{S} \mathcal{Y}$ is a quadruple
$(U, x, y, f)$, where $U \in \Ob(\mathcal{C})$,
$x\in \Ob(\mathcal{X}_U)$, $y\in \Ob(\mathcal{Y}_U)$,
and $f : F(x) \to G(y)$ is an isomorphism in $\mathcal{S}_U$,
\item a morphism $(U, x, y, f) \to (U', x', y', f')$ is given by a pair
$(a, b)$, where $a : x \to x'$ is a morphism in $\mathcal{X}$, and
$b : y \to y'$ is a
morphism in $\mathcal{Y}$ such that
\begin{enumerate}
\item $a$ and $b$ induce the same morphism $U \to U'$, and
\item the diagram
$$
\xymatrix{
F(x) \ar[r]^f \ar[d]^{F(a)} & G(y) \ar[d]^{G(b)} \\
F(x') \ar[r]^{f'} & G(y')
}
$$
is commutative.
\end{enumerate}
\end{enumerate}
The functors $p : \mathcal{X} \times_\mathcal{S}\mathcal{Y} \to \mathcal{X}$
and $q : \mathcal{X} \times_\mathcal{S}\mathcal{Y} \to \mathcal{Y}$ are the
forgetful functors in this case. The transformation $\psi : F \circ p \to
G \circ q$ is given on the object $\xi = (U, x, y, f)$ by
$\psi_\xi = f : F(p(\xi)) = F(x) \to G(y) = G(q(\xi))$.
\end{lemma}

\begin{proof}
Let us check the universal property: let
$p_\mathcal{W} : \mathcal{W}\to \mathcal{C}$
be a category over $\mathcal{C}$, let $X : \mathcal{W} \to \mathcal{X}$ and
$Y : \mathcal{W} \to \mathcal{Y}$ be functors over $\mathcal{C}$, and let
$t : F \circ X \to G \circ Y$ be an isomorphism of functors over $\mathcal{C}$.
The desired functor
$\gamma : \mathcal{W} \to \mathcal{X} \times_\mathcal{S} \mathcal{Y}$
is given by $W \mapsto (p_\mathcal{W}(W), X(W), Y(W), t_W)$.
Details omitted; compare with Lemma \ref{lemma-2-fibre-product-categories}.
\end{proof}

\begin{lemma}
\label{lemma-fibre-2-fibre-product-categories-over-C}
Let $\mathcal{C}$ be a category.
Let $f : \mathcal{X} \to \mathcal{S}$ and
$g : \mathcal{Y} \to \mathcal{S}$ be morphisms of categories over
$\mathcal{C}$. For any object $U$ of $\mathcal{C}$ we have
the following identity of
fibre categories
$$
\left(\mathcal{X} \times_\mathcal{S}\mathcal{Y}\right)_U
=
\mathcal{X}_U \times_{\mathcal{S}_U} \mathcal{Y}_U
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}







\section{Fibred categories}
\label{section-fibred-categories}

\noindent
A very brief discussion of fibred categories is warranted.

\medskip\noindent
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
Given an object $x \in \mathcal{S}$ with $p(x) = U$, and given a morphism
$f : V \to U$, we can try to take some kind of ``fibre product
$V \times_U x$'' (or a {\it base change} of $x$ via $V \to U$).
Namely, a morphism from an object $z \in \mathcal{S}$
into ``$V \times_U x$'' should be given by a pair
$(\varphi, g)$, where
$\varphi : z \to x$, $g : p(z) \to V$ such that
$p(\varphi) = f \circ g$. Pictorially:
$$
\xymatrix{
z \ar@{~>}[d]^p \ar@{-}[r] &
? \ar[r] \ar@{~>}[d]^p &
x \ar@{~>}[d]^p \\
p(z) \ar[r] & V \ar[r]^f & U
}
$$
If such a morphism $V \times_U x \to x$ exists then it is called
a strongly cartesian morphism.

\begin{definition}
\label{definition-cartesian-over-C}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
A {\it strongly cartesian morphism}, or more precisely a
{\it strongly $\mathcal{C}$-cartesian morphism} is a
morphism $\varphi : y \to x$ of $\mathcal{S}$ such that
for every $z \in \Ob(\mathcal{S})$ the map
$$
\Mor_\mathcal{S}(z, y)
\longrightarrow
\Mor_\mathcal{S}(z, x)
\times_{\Mor_\mathcal{C}(p(z), p(x))}
\Mor_\mathcal{C}(p(z), p(y)),
$$
given by $\psi \longmapsto (\varphi \circ \psi, p(\psi))$
is bijective.
\end{definition}

\noindent
Note that by the Yoneda Lemma \ref{lemma-yoneda}, given
$x \in \Ob(\mathcal{S})$ lying over $U \in \Ob(\mathcal{C})$
and the morphism $f : V \to U$ of $\mathcal{C}$, if there is a
strongly cartesian morphism $\varphi : y \to x$ with $p(\varphi) = f$,
then $(y, \varphi)$ is unique up to unique isomorphism. This is
clear from the definition above, as the functor
$$
z
\longmapsto
\Mor_\mathcal{S}(z, x)
\times_{\Mor_\mathcal{C}(p(z), U)}
\Mor_\mathcal{C}(p(z), V)
$$
only depends on the data $(x, U, f : V \to U)$. Hence we
will sometimes use $V \times_U x \to x$ or $f^*x \to x$
to denote a strongly cartesian morphism which is a lift of $f$.

\begin{lemma}
\label{lemma-composition-cartesian}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
\begin{enumerate}
\item The composition of two strongly cartesian morphisms
is strongly cartesian.
\item Any isomorphism of $\mathcal{S}$ is strongly cartesian.
\item Any strongly cartesian morphism $\varphi$ such that $p(\varphi)$
is an isomorphism, is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $\varphi : y \to x$ and $\psi : z \to y$ be
strongly cartesian. Let $t$ be an arbitrary object of $\mathcal{S}$.
Then we have
\begin{align*}
& \Mor_\mathcal{S}(t, z) \\
& =
\Mor_\mathcal{S}(t, y)
\times_{\Mor_\mathcal{C}(p(t), p(y))}
\Mor_\mathcal{C}(p(t), p(z)) \\
& =
\Mor_\mathcal{S}(t, x)
\times_{\Mor_\mathcal{C}(p(t), p(x))}
\Mor_\mathcal{C}(p(t), p(y))
\times_{\Mor_\mathcal{C}(p(t), p(y))}
\Mor_\mathcal{C}(p(t), p(z)) \\
& =
\Mor_\mathcal{S}(t, x)
\times_{\Mor_\mathcal{C}(p(t), p(x))}
\Mor_\mathcal{C}(p(t), p(z))
\end{align*}
hence $z \to x$ is strongly cartesian.

\medskip\noindent
Proof of (2). Let $y \to x$ be an isomorphism. Then $p(y) \to p(x)$
is an isomorphism too. Hence
$\Mor_\mathcal{C}(p(z), p(y)) \to
\Mor_\mathcal{C}(p(z), p(x))$
is a bijection. Hence
$\Mor_\mathcal{S}(z, x)
\times_{\Mor_\mathcal{C}(p(z), p(x))}
\Mor_\mathcal{C}(p(z), p(y))$ is bijective to
$\Mor_\mathcal{S}(z, x)$.
Hence the displayed map of
Definition \ref{definition-cartesian-over-C}
is a bijection as $y \to x$ is an isomorphism, and we conclude that
$y \to x$ is strongly cartesian.

\medskip\noindent
Proof of (3). Assume $\varphi : y \to x$ is strongly cartesian with
$p(\varphi) : p(y) \to p(x)$ an isomorphism. Applying the definition with
$z = x$ shows that $(\text{id}_x, p(\varphi)^{-1})$ comes from a unique
morphism $\chi : x \to y$. We omit the verification that $\chi$ is the
inverse of $\varphi$.
\end{proof}

\begin{lemma}
\label{lemma-cartesian-over-cartesian}
Let $F : \mathcal{A} \to \mathcal{B}$ and $G : \mathcal{B} \to \mathcal{C}$
be composable functors between categories. Let $x \to y$ be a morphism of
$\mathcal{A}$. If $x \to y$ is strongly $\mathcal{B}$-cartesian
and $F(x) \to F(y)$ is strongly $\mathcal{C}$-cartesian, then
$x \to y$ is strongly $\mathcal{C}$-cartesian.
\end{lemma}

\begin{proof}
This follows directly from the definition.
\end{proof}

\begin{lemma}
\label{lemma-strongly-cartesian-fibre-product}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
Let $x \to y$ and $z \to y$ be morphisms of $\mathcal{S}$.
Assume
\begin{enumerate}
\item $x \to y$ is strongly cartesian,
\item $p(x) \times_{p(y)} p(z)$ exists, and
\item there exists a strongly cartesian morphism $a : w \to z$ in
$\mathcal{S}$ with $p(w) = p(x) \times_{p(y)} p(z)$ and
$p(a) = \text{pr}_2 : p(x) \times_{p(y)} p(z) \to p(z)$.
\end{enumerate}
Then the fibre product $x \times_y z$ exists and is isomorphic to $w$.
\end{lemma}

\begin{proof}
Since $x \to y$ is strongly cartesian there exists a unique morphism
$b : w \to x$ such that $p(b) = \text{pr}_1$. To see that $w$ is the
fibre product we compute
\begin{align*}
& \Mor_\mathcal{S}(t, w) \\
& = \Mor_\mathcal{S}(t, z)
\times_{\Mor_\mathcal{C}(p(t), p(z))}
\Mor_\mathcal{C}(p(t), p(w)) \\
& = \Mor_\mathcal{S}(t, z)
\times_{\Mor_\mathcal{C}(p(t), p(z))}
(\Mor_\mathcal{C}(p(t), p(x))
\times_{\Mor_\mathcal{C}(p(t), p(y))}
\Mor_\mathcal{C}(p(t), p(z))) \\
& = \Mor_\mathcal{S}(t, z)
\times_{\Mor_\mathcal{C}(p(t), p(y))}
\Mor_\mathcal{C}(p(t), p(x)) \\
& = \Mor_\mathcal{S}(t, z)
\times_{\Mor_\mathcal{S}(t, y)}
\Mor_\mathcal{S}(t, y)
\times_{\Mor_\mathcal{C}(p(t), p(y))}
\Mor_\mathcal{C}(p(t), p(x)) \\
& = \Mor_\mathcal{S}(t, z)
\times_{\Mor_\mathcal{S}(t, y)}
\Mor_\mathcal{S}(t, x)
\end{align*}
as desired. The first equality holds because $a : w \to z$ is strongly
cartesian and the last equality holds because $x \to y$ is strongly
cartesian.
\end{proof}

\begin{definition}
\label{definition-fibred-category}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category over $\mathcal{C}$.
We say $\mathcal{S}$ is a {\it fibred category over $\mathcal{C}$}
if given any $x \in \Ob(\mathcal{S})$ lying over
$U \in \Ob(\mathcal{C})$ and any morphism $f : V \to U$ of
$\mathcal{C}$, there exists a strongly cartesian morphism $f^*x \to x$
lying over $f$.
\end{definition}

\noindent
Assume $p : \mathcal{S} \to \mathcal{C}$ is a fibred category.
For every $f : V \to U$ and $x\in \Ob(\mathcal{S}_U)$
as in the definition we may choose a strongly cartesian morphism
$f^\ast x \to x$ lying over $f$. By the axiom of choice we may choose
$f^*x \to x$ for all $f: V \to U = p(x)$ simultaneously.
We claim that for every morphism $\phi : x \to x'$ in $\mathcal{S}_U$
and $f : V \to U$ there is a unique
morphism $f^\ast \phi : f^\ast x \to f^\ast x'$ in $\mathcal{S}_V$
such that
$$
\xymatrix{
f^\ast x \ar[r]_{f^\ast \phi} \ar[d] & f^\ast x' \ar[d] \\
x \ar[r]^{\phi} & x' }
$$
commutes. Namely, the arrow exists and is unique because $f^*x' \to x'$ is
strongly cartesian. The uniqueness of this arrow guarantees that
$f^\ast$ (now also defined on morphisms) is a
functor $ f^\ast : \mathcal{S}_U \to \mathcal{S}_V$.

\begin{definition}
\label{definition-pullback-functor-fibred-category}
Assume $p : \mathcal{S} \to \mathcal{C}$ is a fibred category.
\begin{enumerate}
\item A {\it choice of pullbacks}\footnote{This is probably nonstandard
terminology. In some texts this is called a ``cleavage''  but it conjures up
the wrong image. Maybe a ``cleaving'' would be a better word.
A related notion is that of a ``splitting'', but in many texts a ``splitting''
means a choice of pullbacks such that $g^*f^* = (f \circ g)^*$
for any composable pair of morphisms. Compare
also with Definition \ref{definition-split-fibred-category}.}
for $p : \mathcal{S} \to \mathcal{C}$
is given by a choice of a strongly cartesian morphism
$f^\ast x \to x$ lying over $f$ for any morphism
$f: V \to U$ of $\mathcal{C}$ and any $x \in \Ob(\mathcal{S}_U)$.
\item Given a choice of pullbacks,
for any morphism $f : V \to U$ of $\mathcal{C}$
the functor $f^* : \mathcal{S}_U \to \mathcal{S}_V$ described
above is called a {\it pullback functor} (associated to the choices
$f^*x \to x$ made above).
\end{enumerate}
\end{definition}

\noindent
Of course we may always assume our choice of pullbacks has the property that
$\text{id}_U^*x = x$, although in practice this is a useless property
without imposing further assumptions on the pullbacks.

\begin{lemma}
\label{lemma-fibred}
Assume $p : \mathcal{S} \to \mathcal{C}$ is a fibred category.
Assume given a choice of pullbacks for $p : \mathcal{S} \to \mathcal{C}$.
\begin{enumerate}
\item For any pair of composable morphisms $f : V \to U$,
$g : W \to V$ there is a unique isomorphism
$$
\alpha_{g, f} :
(f \circ g)^\ast
\longrightarrow
g^\ast \circ f^\ast
$$
as functors $\mathcal{S}_U \to \mathcal{S}_W$
such that for every $y\in \Ob(\mathcal{S}_U)$ the following
diagram commutes
$$
\xymatrix{
g^\ast f^\ast y \ar[r]
&
f^\ast y \ar[d] \\
(f \circ g)^\ast y \ar[r]
\ar[u]^{(\alpha_{g, f})_y}
&
y
}
$$
\item If $f = \text{id}_U$, then there is a canonical isomorphism
$\alpha_U : \text{id} \to (\text{id}_U)^*$ as functors
$\mathcal{S}_U \to \mathcal{S}_U$.
\item The quadruple
$(U \mapsto \mathcal{S}_U, f \mapsto f^*, \alpha_{g, f}, \alpha_U)$
defines a pseudo functor from $\mathcal{C}^{opp}$ to
the $(2, 1)$-category of categories, see
Definition \ref{definition-functor-into-2-category}.
\end{enumerate}
\end{lemma}

\begin{proof}
In fact, it is clear that the commutative diagram of
part (1) uniquely determines the morphism
$(\alpha_{g, f})_y$ in the fibre category
$\mathcal{S}_W$. It is an isomorphism since both
the morphism $(f \circ g)^*y \to y$
and the composition $g^*f^*y \to f^*y \to y$ are strongly
cartesian morphisms lifting $f \circ g$ (see discussion
following Definition \ref{definition-cartesian-over-C} and
Lemma \ref{lemma-composition-cartesian}). In the same way,
since $\text{id}_x : x \to x$ is clearly strongly cartesian
over $\text{id}_U$ (with $U = p(x)$) we see that there exists
an isomorphism $(\alpha_U)_x : x \to (\text{id}_U)^*x$.
(Of course we could have assumed beforehand that $f^*x = x$
whenever $f$ is an identity morphism, but it is better for
the sake of generality not to assume this.)
We omit the verification that $\alpha_{g, f}$ and
$\alpha_U$ so obtained are transformations of functors.
We also omit the verification of (3).
\end{proof}

\begin{lemma}
\label{lemma-fibred-equivalent}
Let $\mathcal{C}$ be a category.
Let $\mathcal{S}_1$, $\mathcal{S}_2$ be categories over $\mathcal{C}$.
Suppose that $\mathcal{S}_1$ and $\mathcal{S}_2$ are equivalent
as categories over $\mathcal{C}$.
Then $\mathcal{S}_1$ is fibred over $\mathcal{C}$ if and only if
$\mathcal{S}_2$ is fibred over $\mathcal{C}$.
\end{lemma}

\begin{proof}
Denote $p_i : \mathcal{S}_i \to \mathcal{C}$ the given functors.
Let $F : \mathcal{S}_1 \to \mathcal{S}_2$,
$G : \mathcal{S}_2 \to \mathcal{S}_1$ be functors over $\mathcal{C}$, and let
$i : F \circ G \to \text{id}_{\mathcal{S}_2}$,
$j : G \circ F \to \text{id}_{\mathcal{S}_1}$ be isomorphisms of
functors over $\mathcal{C}$.
We claim that in this case $F$ maps strongly cartesian morphisms
to strongly cartesian morphisms. Namely, suppose that
$\varphi : y \to x$ is strongly cartesian in $\mathcal{S}_1$.
Set $f : V \to U$ equal to $p_1(\varphi)$. Suppose that
$z' \in \Ob(\mathcal{S}_2)$, with $W = p_2(z')$, and we are given
$g : W \to V$ and $\psi' : z' \to F(x)$ such that
$p_2(\psi') = f \circ g$. Then
$$
\psi = j \circ G(\psi') : G(z') \to G(F(x)) \to x
$$
is a morphism in $\mathcal{S}_1$ with $p_1(\psi) = f \circ g$.
Hence by assumption there exists a unique morphism $\xi : G(z') \to y$
lying over $g$ such that $\psi = \varphi \circ \xi$. This in turn gives a
morphism
$$
\xi' = F(\xi) \circ i^{-1} : z' \to F(G(z')) \to F(y)
$$
lying over $g$ with $\psi' = F(\varphi) \circ \xi'$. We omit the verification
that $\xi'$ is unique.
\end{proof}

\noindent
The conclusion from Lemma \ref{lemma-fibred-equivalent} is that
equivalences map strongly cartesian morphisms to strongly cartesian
morphisms. But this may not be the case for an arbitrary functor between
fibred categories over $\mathcal{C}$. Hence we define the $2$-category
of fibred categories as follows.

\begin{definition}
\label{definition-fibred-categories-over-C}
Let $\mathcal{C}$ be a category.
The {\it $2$-category of fibred categories over $\mathcal{C}$}
is the sub $2$-category of the $2$-category of categories
over $\mathcal{C}$ (see Definition \ref{definition-categories-over-C})
defined as follows:
\begin{enumerate}
\item Its objects will be fibred categories
$p : \mathcal{S} \to \mathcal{C}$.
\item Its $1$-morphisms $(\mathcal{S}, p) \to (\mathcal{S}', p')$
will be functors $G : \mathcal{S} \to \mathcal{S}'$ such that
$p' \circ G = p$ and such that $G$ maps strongly cartesian
morphisms to strongly cartesian morphisms.
\item Its $2$-morphisms $t : G \to H$ for
$G, H : (\mathcal{S}, p) \to (\mathcal{S}', p')$
will be morphisms of functors
such that $p'(t_x) = \text{id}_{p(x)}$
for all $x \in \Ob(\mathcal{S})$.
\end{enumerate}
In this situation we will denote
$$
\Mor_{\textit{Fib}/\mathcal{C}}(\mathcal{S}, \mathcal{S}')
$$
the category of $1$-morphisms between
$(\mathcal{S}, p)$ and $(\mathcal{S}', p')$
\end{definition}

\noindent
Note the condition on $1$-morphisms.
Note also that this is a true $2$-category and
not a $(2, 1)$-category. Hence when taking $2$-fibre
products we first pass to the associated $(2, 1)$-category.

\begin{lemma}
\label{lemma-2-product-fibred-categories-over-C}
Let $\mathcal{C}$ be a category.
The $(2, 1)$-category of fibred categories
over $\mathcal{C}$ has 2-fibre products, and
they are described as in
Lemma \ref{lemma-2-product-categories-over-C}.
\end{lemma}

\begin{proof}
Basically what one has to show here is that given
$F : \mathcal{X} \to \mathcal{S}$ and
$G : \mathcal{Y} \to \mathcal{S}$ morphisms of fibred
categories over $\mathcal{C}$, then the category
$\mathcal{X} \times_\mathcal{S} \mathcal{Y}$
described in Lemma \ref{lemma-2-product-categories-over-C} is fibred.
Let us show that $\mathcal{X} \times_\mathcal{S} \mathcal{Y}$
has plenty of strongly cartesian morphisms.
Namely, suppose we have $(U, x, y, \phi)$ an object of
$\mathcal{X} \times_\mathcal{S} \mathcal{Y}$.
And suppose $f : V \to U$ is a morphism in $\mathcal{C}$.
Choose strongly cartesian morphisms $a : f^*x \to x$ in $\mathcal{X}$
lying over $f$ and $b : f^*y \to y$ in $\mathcal{Y}$ lying over $f$.
By assumption $F(a)$ and $G(b)$ are strongly cartesian.
Since $\phi : F(x) \to G(y)$ is an isomorphism, by the uniqueness
of strongly cartesian morphisms we find a unique isomorphism
$f^*\phi : F(f^*x) \to G(f^*y)$ such that
$G(b) \circ f^*\phi = \phi \circ F(a)$. In other words
$(G(a), G(b)) : (V, f^*x, f^*y, f^*\phi) \to (U, x, y, \phi)$
is a morphism in $\mathcal{X} \times_\mathcal{S} \mathcal{Y}$.
We omit the verification that this is a strongly cartesian morphism
(and that these are in fact the only strongly cartesian morphisms).
\end{proof}

\begin{lemma}
\label{lemma-cute}
Let $\mathcal{C}$ be a category. Let $U \in \Ob(\mathcal{C})$.
If $p : \mathcal{S} \to \mathcal{C}$ is a fibred category
and $p$ factors through $p' : \mathcal{S} \to \mathcal{C}/U$
then $p' : \mathcal{S} \to \mathcal{C}/U$ is a fibred category.
\end{lemma}

\begin{proof}
Suppose that $\varphi : x' \to x$ is strongly cartesian with respect to $p$.
We claim that $\varphi$ is strongly cartesian with respect to $p'$ also.
Set $g = p'(\varphi)$, so that $g : V'/U \to V/U$
for some morphisms $f : V \to U$ and $f' : V' \to U$.
Let $z \in \Ob(\mathcal{S})$. Set $p'(z) = (W \to U)$.
To show that $\varphi$ is strongly cartesian for $p'$ we have to show
$$
\Mor_\mathcal{S}(z, x')
\longrightarrow
\Mor_\mathcal{S}(z, x)
\times_{\Mor_{\mathcal{C}/U}(W/U, V/U)}
\Mor_{\mathcal{C}/U}(W/U, V'/U),
$$
given by $\psi' \longmapsto (\varphi \circ \psi', p'(\psi'))$
is bijective. Suppose given an element $(\psi, h)$ of the
right hand side, then in particular $g \circ h = p(\psi)$,
and by the condition that $\varphi$ is strongly cartesian we
get a unique morphism $\psi' : z \to x'$ with $\psi = \varphi \circ \psi'$
and $p(\psi') = h$. OK, and now $p'(\psi') : W/U \to V/U$
is a morphism whose corresponding map $W \to V$ is $h$, hence
equal to $h$ as a morphism in $\mathcal{C}/U$. Thus $\psi'$ is
a unique morphism $z \to x'$ which maps to the given pair $(\psi, h)$.
This proves the claim.

\medskip\noindent
Finally, suppose given $g : V'/U \to V/U$ and $x$ with $p'(x) = V/U$.
Since $p : \mathcal{S} \to \mathcal{C}$ is a fibred category we
see there exists a strongly cartesian morphism $\varphi : x' \to x$
with $p(\varphi) = g$. By the same argument as above it follows
that $p'(\varphi) = g : V'/U \to V/U$. And as seen above the morphism
$\varphi$ is strongly cartesian. Thus the conditions of
Definition \ref{definition-fibred-category} are satisfied and we win.
\end{proof}

\begin{lemma}
\label{lemma-fibred-over-fibred}
Let $\mathcal{A} \to \mathcal{B} \to \mathcal{C}$ be functors between
categories. If $\mathcal{A}$ is fibred over $\mathcal{B}$ and
$\mathcal{B}$ is fibred over $\mathcal{C}$, then $\mathcal{A}$
is fibred over $\mathcal{C}$.
\end{lemma}

\begin{proof}
This follows from the definitions and
Lemma \ref{lemma-cartesian-over-cartesian}.
\end{proof}

\begin{lemma}
\label{lemma-fibred-category-representable-goes-up}
Let $p : \mathcal{S} \to \mathcal{C}$ be a fibred category.
Let $x \to y$ and $z \to y$ be morphisms of $\mathcal{S}$
with $x \to y$ strongly cartesian. If $p(x) \times_{p(y)} p(z)$ exists,
then $x \times_y z$ exists, $p(x \times_y z) = p(x) \times_{p(y)} p(z)$,
and $x \times_y z \to z$ is strongly cartesian.
\end{lemma}

\begin{proof}
Pick a strongly cartesian morphism
$\text{pr}_2^*z \to z$ lying over
$\text{pr}_2 : p(x) \times_{p(y)} p(z) \to p(z)$. Then
$\text{pr}_2^*z = x \times_y z$ by
Lemma \ref{lemma-strongly-cartesian-fibre-product}.
\end{proof}

\begin{lemma}
\label{lemma-ameliorate-morphism-fibred-categories}
Let $\mathcal{C}$ be a category. Let $F : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of fibred categories over $\mathcal{C}$.
There exist $1$-morphisms of fibred categories over $\mathcal{C}$
$$
\xymatrix{
\mathcal{X} \ar@<1ex>[r]^u &
\mathcal{X}' \ar[r]^v \ar@<1ex>[l]^w & \mathcal{Y}
}
$$
such that $F = v \circ u$ and such that
\begin{enumerate}
\item $u : \mathcal{X} \to \mathcal{X}'$ is fully faithful,
\item $w$ is left adjoint to $u$, and
\item $v : \mathcal{X}' \to \mathcal{Y}$ is a fibred category.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $p : \mathcal{X} \to \mathcal{C}$ and $q : \mathcal{Y} \to \mathcal{C}$
the structure functors. We construct $\mathcal{X}'$ explicitly as follows.
An object of $\mathcal{X}'$ is a quadruple $(U, x, y, f)$ where
$x \in \Ob(\mathcal{X}_U)$, $y \in \Ob(\mathcal{Y}_U)$
and $f : y \to F(x)$ is a morphism in $\mathcal{Y}_U$.
A morphism $(a, b) : (U, x, y, f) \to (U', x', y', f')$ is given
by $a : x \to x'$ and $b : y \to y'$ with $p(a) = q(b) : U \to U'$
and such that $f' \circ b = F(a) \circ f$.

\medskip\noindent
Let us make a choice of pullbacks for both $p$ and $q$ and let us
use the same notation to indicate them.
Let $(U, x, y, f)$ be an object and let $h : V \to U$ be a morphism.
Consider the morphism $c : (V, h^*x, h^*y, h^*f) \to (U, x, y, f)$
coming from the given strongly cartesian maps $h^*x \to x$ and $h^*y \to y$.
We claim $c$ is strongly cartesian in $\mathcal{X}'$ over $\mathcal{C}$.
Namely, suppose we are given an object $(W, x', y', f')$ of $\mathcal{X}'$,
a morphism $(a, b) : (W, x', y', f') \to (U, x, y, f)$ lying over
$W \to U$, and a factorization $W \to V \to U$ of $W \to U$ through $h$.
As $h^*x \to x$ and $h^*y \to y$ are strongly cartesian we obtain morphisms
$a' : x' \to h^*x$ and $b' : y' \to h^*y$ lying over the given morphism
$W \to V$. Consider the diagram
$$
\xymatrix{
y' \ar[d]_{f'} \ar[r] & h^*y \ar[r] \ar[d]_{h^*f} & y \ar[d]_f \\
F(x') \ar[r] & F(h^*x) \ar[r] & F(x)
}
$$
The outer rectangle and the right square commute.
Since $F$ is a $1$-morphism of fibred categories the morphism
$F(h^*x) \to F(x)$ is strongly cartesian.
Hence the left square commutes by the universal property
of strongly cartesian morphisms. This proves that $\mathcal{X}'$
is fibred over $\mathcal{C}$.

\medskip\noindent
The functor $u : \mathcal{X} \to \mathcal{X}'$ is given by
$x \mapsto (p(x), x, F(x), \text{id})$. This is fully faithful.
The functor $\mathcal{X}' \to \mathcal{Y}$ is given by
$(U, x, y, f) \mapsto y$. The functor $w : \mathcal{X}' \to \mathcal{X}$
is given by $(U, x, y, f) \mapsto x$. Each of these functors is
a $1$-morphism of fibred categories over $\mathcal{C}$ by our
description of strongly cartesian morphisms of $\mathcal{X}'$ over
$\mathcal{C}$. Adjointness of $w$ and $u$ means that
$$
\Mor_\mathcal{X}(x, x') =
\Mor_{\mathcal{X}'}((U, x, y, f), (p(x'), x', F(x'), \text{id})),
$$
which follows immediately from the definitions.

\medskip\noindent
Finally, we have to show that $\mathcal{X}' \to \mathcal{Y}$ is a fibred
category. Let $c : y' \to y$ be a morphism in $\mathcal{Y}$
and let $(U, x, y, f)$ be an object of $\mathcal{X}'$ lying over $y$.
Set $V = q(y')$ and let $h = q(c) : V \to U$. Let $a : h^*x \to x$
and $b : h^*y \to y$ be the strongly cartesian morphisms covering $h$.
Since $F$ is a $1$-morphism of fibred categories we may identify
$h^*F(x) = F(h^*x)$ with strongly cartesian morphism
$F(a) : F(h^*x) \to F(x)$. By the universal property
of $b : h^*y \to y$ there is a morphism $c' : y' \to h^*y$ in
$\mathcal{Y}_V$ such that $c = b \circ c'$. We claim that
$$
(a, c) : (V, h^*x, y', h^*f \circ c') \longrightarrow (U, x, y, f)
$$
is strongly cartesian in $\mathcal{X}'$ over $\mathcal{Y}$. To see this
let $(W, x_1, y_1, f_1)$ be an object of $\mathcal{X}'$, let
$(a_1, b_1) : (W, x_1, y_1, f_1) \to (U, x, y, f)$ be a morphism
and let $b_1 = c \circ b_1'$ for some morphism $b_1' : y_1 \to y'$.
Then
$$
(a_1', b_1') : (W, x_1, y_1, f_1) \longrightarrow (V, h^*x, y', h^*f \circ c')
$$
(where $a_1' : x_1 \to h^*x$ is the unique morphism lying over the
given morphism $q(b_1') : W \to V$ such that $a_1 = a \circ a_1'$)
is the desired morphism.
\end{proof}





\section{Inertia}
\label{section-inertia}

\noindent
Given fibred categories $p : \mathcal{S} \to \mathcal{C}$ and
$p' : \mathcal{S}' \to \mathcal{C}$ over a category $\mathcal{C}$
and a $1$-morphism $F : \mathcal{S} \to \mathcal{S}'$
we have the diagonal morphism
$$
\Delta = \Delta_{\mathcal{S}/\mathcal{S}'} :
\mathcal{S} \longrightarrow \mathcal{S} \times_{\mathcal{S}'} \mathcal{S}
$$
in the $(2, 1)$-category of fibred categories over $\mathcal{C}$.

\begin{lemma}
\label{lemma-inertia-fibred-category}
Let $\mathcal{C}$ be a category. Let
$p : \mathcal{S} \to \mathcal{C}$ and
$p' : \mathcal{S}' \to \mathcal{C}$ be fibred categories.
Let $F : \mathcal{S} \to \mathcal{S}'$ be a $1$-morphism of
fibred categories over $\mathcal{C}$. Consider the category
$\mathcal{I}_{\mathcal{S}/\mathcal{S}'}$ over $\mathcal{C}$ whose
\begin{enumerate}
\item objects are pairs $(x, \alpha)$ where $x \in \Ob(\mathcal{S})$
and $\alpha : x \to x$ is an automorphism with $F(\alpha) = \text{id}$,
\item morphisms $(x, \alpha) \to (y, \beta)$ are given by morphisms
$\phi : x \to y$ such that
$$
\xymatrix{
x\ar[r]_\phi\ar[d]_\alpha &
y\ar[d]^{\beta} \\
x\ar[r]^\phi &
y \\
}
$$
commutes, and
\item the functor $\mathcal{I}_{\mathcal{S}/\mathcal{S}'} \to \mathcal{C}$
is given by $(x, \alpha) \mapsto p(x)$.
\end{enumerate}
Then
\begin{enumerate}
\item there is an equivalence
$$
\mathcal{I}_{\mathcal{S}/\mathcal{S}'} \longrightarrow
\mathcal{S}
\times_{\Delta, (\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}), \Delta}
\mathcal{S}
$$
in the $(2, 1)$-category of categories over $\mathcal{C}$, and
\item $\mathcal{I}_{\mathcal{S}/\mathcal{S}'}$ is a fibred category over
$\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that (2) follows from (1) by
Lemmas \ref{lemma-2-product-fibred-categories-over-C} and
\ref{lemma-fibred-equivalent}. Thus it suffices to prove (1).
We will use without further mention the construction of the $2$-fibre product
from
Lemma \ref{lemma-2-product-fibred-categories-over-C}.
In particular an object of
$\mathcal{S}
\times_{\Delta, (\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}), \Delta}
\mathcal{S}$
is a triple $(x, y, (\iota, \kappa))$ where $x$ and $y$ are objects of
$\mathcal{S}$, and
$(\iota, \kappa) : (x, x, \text{id}_{F(x)}) \to (y, y, \text{id}_{F(y)})$
is an isomorphism in $\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}$.
This just means that $\iota, \kappa : x \to y$ are isomorphisms and that
$F(\iota) = F(\kappa)$. Consider the functor
$$
I_{\mathcal{S}/\mathcal{S}'}
\longrightarrow
\mathcal{S}
\times_{\Delta, (\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}), \Delta}
\mathcal{S}
$$
which to an object $(x, \alpha)$ of the left hand side assigns the object
$(x, x, (\alpha, \text{id}_x))$ of the right hand side
and to a morphism $\phi$ of the left hand side
assigns the morphism $(\phi, \phi)$ of the right hand side.
We claim that a quasi-inverse to that morphism is given by the
functor
$$
\mathcal{S}
\times_{\Delta, (\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}), \Delta}
\mathcal{S}
\longrightarrow
I_{\mathcal{S}/\mathcal{S}'}
$$
which to an object $(x, y, (\iota, \kappa))$ of the left hand side
assigns the object $(x, \kappa^{-1} \circ \iota)$ of the right hand side
and to a morphism
$(\phi, \phi') : (x, y, (\iota, \kappa)) \to (z, w, (\lambda, \mu))$
of the left hand side assigns the morphism $\phi$.
Indeed, the endo-functor of $I_{\mathcal{S}/\mathcal{S}'}$ induced
by composing the two functors above is the identity on the nose, and
the endo-functor induced on
$\mathcal{S}
\times_{\Delta, (\mathcal{S} \times_{\mathcal{S}'} \mathcal{S}), \Delta}
\mathcal{S}$
is isomorphic to
the identity via the natural isomorphism
$$
(\text{id}_x, \kappa) :
(x, x, (\kappa^{-1} \circ \iota, \text{id}_x))
\longrightarrow
(x, y, (\iota, \kappa)).
$$
Some details omitted.
\end{proof}

\begin{definition}
\label{definition-inertia-fibred-category}
Let $\mathcal{C}$ be a category.
\begin{enumerate}
\item Let $F : \mathcal{S} \to \mathcal{S}'$ be a $1$-morphism of
fibred categories over $\mathcal{C}$. The {\it relative inertia
of $\mathcal{S}$ over $\mathcal{S}'$} is the fibred category
$\mathcal{I}_{\mathcal{S}/\mathcal{S}'} \to \mathcal{C}$ of
Lemma \ref{lemma-inertia-fibred-category}.
\item By the {\it inertia fibred category $\mathcal{I}_\mathcal{S}$
of $\mathcal{S}$} we mean
$\mathcal{I}_\mathcal{S} = \mathcal{I}_{\mathcal{S}/\mathcal{C}}$.
\end{enumerate}
\end{definition}

\noindent
Note that there are canonical $1$-morphisms
\begin{equation}
\label{equation-inertia-structure-map}
\mathcal{I}_{\mathcal{S}/\mathcal{S}'} \longrightarrow \mathcal{S}
\quad\text{and}\quad
\mathcal{I}_\mathcal{S} \longrightarrow \mathcal{S}
\end{equation}
of fibred categories over $\mathcal{C}$. In terms of the description of
Lemma \ref{lemma-inertia-fibred-category}
these simply map the object $(x, \alpha)$ to the object $x$ and the morphism
$\phi : (x, \alpha) \to (y, \beta)$ to the morphism $\phi : x \to y$.
There is also a {\it neutral section}
\begin{equation}
\label{equation-neutral-section}
e : \mathcal{S} \to \mathcal{I}_{\mathcal{S}/\mathcal{S}'}
\quad\text{and}\quad
e : \mathcal{S} \to \mathcal{I}_\mathcal{S}
\end{equation}
defined by the rules $x \mapsto (x, \text{id}_x)$ and
$(\phi : x \to y) \mapsto \phi$. This is a right inverse to
(\ref{equation-inertia-structure-map}). Given a $2$-commutative
square
$$
\xymatrix{
\mathcal{S}_1 \ar[d]_{F_1} \ar[r]_G & \mathcal{S}_2 \ar[d]^{F_2} \\
\mathcal{S}'_1 \ar[r]^{G'} & \mathcal{S}'_2
}
$$
there is a {\it functoriality map}
\begin{equation}
\label{equation-functorial}
\mathcal{I}_{\mathcal{S}_1/\mathcal{S}'_1}
\longrightarrow
\mathcal{I}_{\mathcal{S}_2/\mathcal{S}'_2}
\quad\text{and}\quad
\mathcal{I}_{\mathcal{S}_1}
\longrightarrow
\mathcal{I}_{\mathcal{S}_2}
\end{equation}
defined by the rules $(x, \alpha) \mapsto (G(x), G(\alpha))$
and $\phi \mapsto G(\phi)$. In particular there is always a
comparison map
\begin{equation}
\label{equation-comparison}
\mathcal{I}_{\mathcal{S}/\mathcal{S}'}
\longrightarrow
\mathcal{I}_\mathcal{S}
\end{equation}
and all the maps above are compatible with this.

\begin{lemma}
\label{lemma-relative-inertia-as-fibre-product}
Let $F : \mathcal{S} \to \mathcal{S}'$ be a $1$-morphism of categories
fibred over a category $\mathcal{C}$. Then the diagram
$$
\xymatrix{
\mathcal{I}_{\mathcal{S}/\mathcal{S}'}
\ar[d]_{F \circ (\ref{equation-inertia-structure-map})}
\ar[rr]_{(\ref{equation-comparison})} & &
\mathcal{I}_\mathcal{S} \ar[d]^{(\ref{equation-functorial})} \\
\mathcal{S}' \ar[rr]^e & &
\mathcal{I}_{\mathcal{S}'}
}
$$
is a $2$-fibre product.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}





\section{Categories fibred in groupoids}
\label{section-fibred-groupoids}

\noindent
In this section we explain how to think about categories fibred in groupoids
and we see how they are basically the same as functors with
values in the $(2, 1)$-category of groupoids.

\begin{definition}
\label{definition-fibred-groupoids}
Let $p : \mathcal{S} \to \mathcal{C}$ be a functor.
We say that $\mathcal{S}$ is {\it fibred in groupoids} over $\mathcal{C}$ if
the following two conditions hold:
\begin{enumerate}
\item For every morphism $f : V \to U$ in $\mathcal{C}$ and every
lift $x$ of $U$ there is a lift $\phi : y \to x$ of $f$ with
target $x$.
\item For every pair of morphisms $\phi : y \to x$ and $ \psi : z \to x$
and any morphism $f : p(z) \to p(y)$ such that $p(\phi) \circ f = p(\psi)$
there exists a unique lift $\chi : z \to y$ of $f$ such that
$\phi \circ \chi = \psi$.
\end{enumerate}
\end{definition}

\noindent
Condition (2) phrased differently says that
applying the functor $p$ gives a bijection between the sets
of dotted arrows in the following commutative diagram below:
$$
\xymatrix{
y \ar[r] & x & p(y) \ar[r] & p(x) \\
z \ar@{-->}[u] \ar[ru] & & p(z) \ar@{-->}[u]\ar[ru] & \\
}
$$
Another way to think about the second condition is the following.
Suppose that $g : W \to V$ and $f : V \to U$ are morphisms in $\mathcal{C}$.
Let $x \in \Ob(\mathcal{S}_U)$. By the first condition we can lift
$f$ to $ \phi : y \to x$ and then we can lift $g$ to $\psi : z \to y$.
Instead of doing this two step process we can directly lift $g \circ f$ to
$\gamma : z' \to x$. This gives the solid arrows in the diagram
\begin{equation}
\label{equation-fibred-groupoids}
\vcenter{
\xymatrix{
z' \ar@{-->}[d]\ar[rrd]^\gamma & & \\
z \ar@{-->}[u] \ar[r]^\psi \ar@{~>}[d]^p &
y \ar[r]^\phi \ar@{~>}[d]^p &
x \ar@{~>}[d]^p
\\
W \ar[r]^g & V \ar[r]^f & U \\
}
}
\end{equation}
where the squiggly arrows represent not morphisms but the functor $p$.
Applying the second condition to the arrows $\phi \circ \psi$, $\gamma$
and $\text{id}_W$ we conclude that there is a unique morphism
$\chi : z \to z'$ in $\mathcal{S}_W$ such that
$\gamma \circ \chi = \phi \circ \psi$. Similarly there is a unique morphism
$z' \to z$. The uniqueness implies that the morphisms $z' \to z$ and
$z\to z'$ are mutually inverse, in other words isomorphisms.

\medskip\noindent
It should be clear from this discussion that a
category fibred in groupoids is very closely related
to a fibred category. Here is the result.

\begin{lemma}
\label{lemma-fibred-groupoids}
Let $p : \mathcal{S} \to \mathcal{C}$ be a functor.
The following are equivalent
\begin{enumerate}
\item $p : \mathcal{S} \to \mathcal{C}$ is a category
fibred in groupoids, and
\item all fibre categories are groupoids and
$\mathcal{S}$ is a fibred category over $\mathcal{C}$.
\end{enumerate}
Moreover, in this case every morphism of $\mathcal{S}$ is
strongly cartesian. In addition, given $f^\ast x \to x$
lying over $f$ for all $f: V \to U = p(x)$ the data
$(U \mapsto \mathcal{S}_U, f \mapsto f^*, \alpha_{f, g}, \alpha_U)$
constructed in Lemma \ref{lemma-fibred}
defines a pseudo functor from $\mathcal{C}^{opp}$ in to
the $(2, 1)$-category of groupoids.
\end{lemma}

\begin{proof}
Assume $p : \mathcal{S} \to \mathcal{C}$ is fibred in groupoids.
To show all fibre categories $\mathcal{S}_U$ for
$U \in \Ob(\mathcal{C})$
are groupoids, we must exhibit for every $f : y \to x$ in $\mathcal{S}_U$ an
inverse morphism.  The diagram on the left (in $\mathcal{S}_U$) is mapped by
$p$ to the diagram on the right:
$$
\xymatrix{
y \ar[r]^f & x & U \ar[r]^{\text{id}_U} & U \\
x \ar@{-->}[u] \ar[ru]_{\text{id}_x} & &
U \ar@{-->}[u]\ar[ru]_{\text{id}_U} & \\
}
$$
Since only $\text{i}d_U$ makes the diagram on the right commute, there is a
unique $g : x \to y$ making the diagram on the left commute, so
$fg = \text{id}_x$. By a similar argument there is a unique $h : y \to x$ so
that $gh = \text{id}_y$. Then $fgh = f : y \to x$.  We have $fg = \text{id}_x$,
so $h = f$. Condition (2) of Definition \ref{definition-fibred-groupoids} says
exactly that every morphism of $\mathcal{S}$ is strongly cartesian. Hence
condition (1) of Definition \ref{definition-fibred-groupoids} implies that
$\mathcal{S}$ is a fibred category over $\mathcal{C}$.

\medskip\noindent
Conversely, assume all fibre categories are groupoids and
$\mathcal{S}$ is a fibred category over $\mathcal{C}$.
We have to check conditions (1) and (2) of
Definition \ref{definition-fibred-groupoids}.
The first condition follows trivially. Let $\phi : y \to x$,
$\psi : z \to x$ and $f : p(z) \to p(y)$ such that
$p(\phi) \circ f = p(\psi)$ be as in condition (2) of
Definition \ref{definition-fibred-groupoids}.
Write $U = p(x)$, $V = p(y)$, $W = p(z)$, $p(\phi) = g : V \to U$,
$p(\psi) = h : W \to U$. Choose a strongly cartesian $g^*x \to x$
lying over $g$. Then we get a morphism $i : y \to g^*x$ in
$\mathcal{S}_V$, which is therefore an isomorphism. We
also get a morphism $j : z \to g^*x$ corresponding to
the pair $(\psi, f)$ as $g^*x \to x$ is strongly cartesian.
Then one checks that $\chi = i^{-1} \circ j$ is a solution.

\medskip\noindent
We have seen in the proof of (1) $\Rightarrow$ (2) that
every morphism of $\mathcal{S}$ is strongly cartesian.
The final statement follows directly from Lemma \ref{lemma-fibred}.
\end{proof}

\begin{lemma}
\label{lemma-fibred-gives-fibred-groupoids}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a fibred category.
Let $\mathcal{S}'$ be the subcategory of $\mathcal{S}$ defined
as follows
\begin{enumerate}
\item $\Ob(\mathcal{S}') = \Ob(\mathcal{S})$, and
\item for $x, y \in \Ob(\mathcal{S}')$ the set of morphisms between $x$
and $y$ in $\mathcal{S}'$ is the set of of strongly cartesian morphisms between
$x$ and $y$ in $\mathcal{S}$.
\end{enumerate}
Let $p' : \mathcal{S}' \to \mathcal{C}$ be the restriction of $p$
to $\mathcal{S}'$. Then $p' : \mathcal{S}' \to \mathcal{C}$ is fibred
in groupoids.
\end{lemma}

\begin{proof}
Note that the construction makes sense since by
Lemma \ref{lemma-composition-cartesian}
the identity morphism of any object of $\mathcal{S}$ is strongly cartesian,
and the composition of strongly cartesian morphisms is strongly cartesian.
The first lifting property of
Definition \ref{definition-fibred-groupoids}
follows from the condition that in a fibred category
given any morphism $f : V \to U$ and $x$ lying over $U$ there exists
a strongly cartesian morphism $\varphi : y \to x$ lying over $f$.
Let us check the second lifting property of
Definition \ref{definition-fibred-groupoids}
for the category $p' : \mathcal{S}' \to \mathcal{C}$ over $\mathcal{C}$.
To do this we argue as in the discussion following
Definition \ref{definition-fibred-groupoids}.
Thus in Diagram \ref{equation-fibred-groupoids} the
morphisms $\phi$, $\psi$ and $\gamma$ are strongly cartesian morphisms
of $\mathcal{S}$.
Hence $\gamma$ and $\phi \circ \psi$ are strongly cartesian morphisms
of $\mathcal{S}$ lying over the same arrow of $\mathcal{C}$ and
having the same target in $\mathcal{S}$. By the discussion following
Definition \ref{definition-cartesian-over-C}
this means these two arrows are isomorphic as desired (here we use also
that any isomorphism in $\mathcal{S}$ is strongly cartesian, by
Lemma \ref{lemma-composition-cartesian} again).
\end{proof}

\begin{example}
\label{example-group-homomorphism-fibreedingroupoids}
A homomorphism of groups $p : G \to H$ gives rise to a functor
$p : \mathcal{S}\to\mathcal{C}$ as in Example
\ref{example-group-homomorphism-functor}. This functor
$p : \mathcal{S}\to\mathcal{C}$ is fibred in groupoids if and only if
$p$ is surjective.  The fibre category $\mathcal{S}_U$ over the (unique)
object $U\in \Ob(\mathcal{C})$ is the category associated to the
kernel of $p$ as in Example \ref{example-group-groupoid}.
\end{example}

\noindent
Given $p : \mathcal{S} \to \mathcal{C}$, we can ask: if the fibre
category $\mathcal{S}_U$ is a groupoid for all $U \in \Ob(\mathcal{C})$,
must $\mathcal{S}$ be fibred in groupoids over $\mathcal{C}$? We can see the
answer is no as follows. Start with a category fibred in groupoids
$p : \mathcal{S} \to \mathcal{C}$. Altering the morphisms in $\mathcal{S}$
which do not map to the identity morphism on some object does not alter the
categories $\mathcal{S}_U$. Hence we can violate the existence and uniqueness
conditions on lifts. One example is the functor from Example
\ref{example-group-homomorphism-fibreedingroupoids} when $G \to H$ is not
surjective. Here is another example.

\begin{example}
\label{example-not-fibred-in-groupoids-but-fibre-cats-are}
Let $\Ob(\mathcal{C}) = \{A, B, T\}$ and
$\Mor_\mathcal{C}(A, B) = \{f\}$, $\Mor_\mathcal{C}(B, T) = \{g\}$,
$\Mor_\mathcal{C}(A, T) = \{h\} = \{gf\}, $ plus the identity morphism
for each object. See the diagram below for a picture of this category. Now let
$\Ob(\mathcal{S}) = \{A', B', T'\}$ and
$\Mor_\mathcal{S}(A', B') = \emptyset$,
$\Mor_\mathcal{S}(B', T') = \{g'\}$,
$\Mor_\mathcal{S}(A', T') = \{h'\}, $ plus the identity morphisms. The
functor $p : \mathcal{S} \to \mathcal{C}$ is obvious. Then for every
$U \in \Ob(\mathcal{C})$, $\mathcal{S}_U$ is the category with one
object and the identity morphism on that object, so a groupoid, but the
morphism $f: A \to B$ cannot be lifted. Similarly, if we declare
$\Mor_\mathcal{S}(A', B') = \{f'_1, f'_2\}$ and
$ \Mor_\mathcal{S}(A', T') = \{h'\} = \{g'f'_1 \} = \{g'f'_2\}$, then
the fibre categories are the same and $f: A \to B$ in the diagram below has
two lifts.
$$
\xymatrix{
B' \ar[r]^{g'} & T' &  & B \ar[r]^g & T & \\
A' \ar@{-->}[u]^{??} \ar[ru]_{h'} & & \ar@{}[u]^{above} &
A \ar[u]^f \ar[ru]_{gf = h} & \\
}
$$
\end{example}

\noindent
Later we would like to make assertions such as ``any category fibred in
groupoids over $\mathcal{C}$ is equivalent to a split one'', or
``any category fibred in groupoids whose fibre categories are setlike
is equivalent to a category fibred in sets''. The notion of equivalence
depends on the $2$-category we are working with.

\begin{definition}
\label{definition-categories-fibred-in-groupoids-over-C}
Let $\mathcal{C}$ be a category.
The {\it $2$-category of categories fibred in groupoids over $\mathcal{C}$}
is the sub $2$-category of the $2$-category of fibred categories
over $\mathcal{C}$ (see Definition \ref{definition-fibred-categories-over-C})
defined as follows:
\begin{enumerate}
\item Its objects will be categories
$p : \mathcal{S} \to \mathcal{C}$ fibred in groupoids.
\item Its $1$-morphisms $(\mathcal{S}, p) \to (\mathcal{S}', p')$
will be functors $G : \mathcal{S} \to \mathcal{S}'$ such that
$p' \circ G = p$ (since every morphism is strongly cartesian
$G$ automatically preserves them).
\item Its $2$-morphisms $t : G \to H$ for
$G, H : (\mathcal{S}, p) \to (\mathcal{S}', p')$
will be morphisms of functors
such that $p'(t_x) = \text{id}_{p(x)}$
for all $x \in \Ob(\mathcal{S})$.
\end{enumerate}
\end{definition}

\noindent
Note that every $2$-morphism is automatically an isomorphism!
Hence this is actually a $(2, 1)$-category and not just a
$2$-category. Here is the obligatory lemma on $2$-fibre products.

\begin{lemma}
\label{lemma-2-product-fibred-categories}
Let $\mathcal{C}$ be a category.
The $2$-category of categories fibred in groupoids
over $\mathcal{C}$ has 2-fibre products, and they are described as in
Lemma \ref{lemma-2-product-categories-over-C}.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-2-product-fibred-categories-over-C}
the fibre product as described in
Lemma \ref{lemma-2-product-categories-over-C} is a fibred category.
Hence it suffices to prove that the fibre categories are
groupoids, see Lemma \ref{lemma-fibred-groupoids}.
By Lemma \ref{lemma-fibre-2-fibre-product-categories-over-C}
it is enough to show that the $2$-fibre product of groupoids
is a groupoid, which is clear (from the construction in
Lemma \ref{lemma-2-fibre-product-categories} for example).
\end{proof}

\begin{lemma}
\label{lemma-equivalence-fibred-categories}
Let $p : \mathcal{S}\to \mathcal{C}$ and
$p' : \mathcal{S'}\to \mathcal{C}$ be categories fibred in groupoids, and
suppose that $G : \mathcal{S}\to \mathcal {S}'$ is a functor over
$\mathcal{C}$.
\begin{enumerate}
\item Then $G$ is faithful (resp.\ fully faithful, resp.\ an equivalence)
if and only if for each $U\in\Ob(\mathcal{C})$ the induced functor
$G_U : \mathcal{S}_U\to \mathcal{S}'_U$ is faithful
(resp.\ fully faithful, resp.\ an equivalence).
\item If $G$ is an equivalence, then $G$ is an equivalence in the
$2$-category of categories fibred in groupoids over $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x, y$ be objects of $\mathcal{S}$ lying over the same object $U$.
Consider the commutative diagram
$$
\xymatrix{
\Mor_\mathcal{S}(x, y) \ar[rd]_p \ar[rr]_G & &
\Mor_{\mathcal{S}'}(G(x), G(y)) \ar[ld]^{p'} \\
& \Mor_\mathcal{C}(U, U) &
}
$$
From this diagram it is clear that if $G$ is faithful (resp.\ fully faithful)
then so is each $G_U$.

\medskip\noindent
Suppose $G$ is an equivalence. For every object
$x'$ of $\mathcal{S}'$ there exists an object $x$ of $\mathcal{S}$
such that $G(x)$ is isomorphic to $x'$. Suppose that $x'$ lies
over $U'$ and $x$ lies over $U$. Then there is an isomorphism
$f : U' \to U$ in $\mathcal{C}$, namely, $p'$ applied to the
isomorphism $x' \to G(x)$. By the axioms of a category fibred
in groupoids there exists an arrow $f^*x \to x$ of $\mathcal{S}$
lying over $f$. Hence there exists an isomorphism
$\alpha : x' \to G(f^*x)$ such that $p'(\alpha) = \text{id}_{U'}$
(this time by the axioms for $\mathcal{S}'$). All in all we conclude
that for every object $x'$ of $\mathcal{S}'$ we can choose
a pair $(o_{x'}, \alpha_{x'})$ consisting of an object
$o_{x'}$ of $\mathcal{S}$ and an isomorphism $\alpha_{x'} : x' \to G(o_{x'})$
with $p'(\alpha_{x'}) = \text{id}_{p'(x')}$.
From this point on we proceed as usual (see proof of
Lemma \ref{lemma-equivalence-categories}) to produce an inverse
functor $F : \mathcal{S}' \to \mathcal{S}$, by taking
$x' \mapsto o_{x'}$ and $\varphi' : x' \to y'$ to the unique
arrow $\varphi_{\varphi'} : o_{x'} \to o_{y'}$ with
$\alpha_{y'}^{-1} \circ G(\varphi_{\varphi'}) \circ \alpha_{x'} = \varphi'$.
With these choices $F$ is a functor over $\mathcal{C}$.
We omit the verification that $G \circ F$ and $F \circ G$ are
$2$-isomorphic to the respective identity functors
(in the $2$-category of categories fibred in groupoids over $\mathcal{C}$).

\medskip\noindent
Suppose that $G_U$ is faithful (resp.\ fully faithful)
for all $U\in\Ob(\mathcal C)$. To
show that $G$ is faithful (resp.\ fully faithful)
we have to show for any objects
$x, y\in\Ob(\mathcal{S})$ that $G$ induces an
injection (resp.\ bijection) between
$\Mor_\mathcal{S}(x, y)$ and
$\Mor_{\mathcal{S}'}(G(x), G(y))$.
Set $U = p(x)$ and $V = p(y)$.
It suffices to prove that $G$
induces an injection (resp.\ bijection) between morphism
$x \to y$ lying over $f$ to morphisms $G(x) \to G(y)$ lying over $f$
for any morphism $f : U \to V$.
Now fix $f : U \to V$. Denote $f^*y \to y$ a pullback.
Then also $G(f^*y) \to G(y)$ is a pullback.
The set of morphisms from $x$ to $y$ lying over $f$
is bijective to the set of morphisms between
$x$ and $f^*y$ lying over $\text{id}_U$. (By the second axiom
of a category fibred in groupoids.) Similarly
the set of morphisms from $G(x)$ to $G(y)$ lying over $f$
is bijective to the set of morphisms between
$G(x)$ and $G(f^*y)$ lying over $\text{id}_U$.
Hence the fact that $G_U$ is faithful (resp.\ fully faithful)
gives the desired result.

\medskip\noindent
Finally suppose for all $G_U$ is an equivalence for all $U$, so it is
fully faithful and essentially surjective.  We have seen this implies $G$ is
fully faithful, and thus to prove it is an equivalence we have to prove that
it is essentially surjective.  This is clear, for if $z'\in
\Ob(\mathcal{S}')$ then $z'\in \Ob(\mathcal{S}'_U)$ where
$U = p'(z')$.  Since $G_U$ is essentially surjective we know that
$z'$ is isomorphic, in $\mathcal{S}'_U$, to an object of the form
$G_U(z)$ for some $z\in \Ob(\mathcal{S}_U)$.  But morphisms
in $\mathcal{S}'_U$ are morphisms in $\mathcal{S}'$ and hence $z'$ is
isomorphic to $G(z)$ in $\mathcal{S}'$.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-diagonal-equivalence}
Let $\mathcal{C}$ be a category. Let $p : \mathcal{S}\to \mathcal{C}$ and
$p' : \mathcal{S'}\to \mathcal{C}$ be categories fibred in groupoids.
Let $G : \mathcal{S}\to \mathcal {S}'$ be a functor over $\mathcal{C}$.
Then $G$ is fully faithful if and only if the diagonal
$$
\Delta_G :
\mathcal{S}
\longrightarrow
\mathcal{S} \times_{G, \mathcal{S}', G} \mathcal{S}
$$
is an equivalence.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-equivalence-fibred-categories}
it suffices to look at fibre categories over an object $U$ of $\mathcal{C}$.
An object of the right hand side is a triple $(x, x', \alpha)$ where
$\alpha : G(x) \to G(x')$ is a morphism in $\mathcal{S}'_U$.
The functor $\Delta_G$ maps the object $x$ of $\mathcal{S}_U$
to the triple $(x, x, \text{id}_{G(x)})$. Note that $(x, x', \alpha)$
is in the essential image of $\Delta_G$ if and only if $\alpha = G(\beta)$
for some morphism $\beta : x \to x'$ in $\mathcal{S}_U$ (details omitted).
Hence in order for $\Delta_G$ to be an equivalence, every $\alpha$ has to
be the image of a morphism $\beta : x \to x'$, and also every two
distinct morphisms $\beta, \beta' : x \to x'$ have to give distinct
morphisms $G(\beta), G(\beta')$. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-morphisms-equivalent-fibred-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{S}_i$, $i = 1, 2, 3, 4$ be categories fibred in
groupoids over $\mathcal{C}$.
Suppose that $\varphi : \mathcal{S}_1 \to \mathcal{S}_2$ and
$\psi : \mathcal{S}_3 \to \mathcal{S}_4$ are equivalences
over $\mathcal{C}$. Then
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{S}_2, \mathcal{S}_3)
\longrightarrow
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{S}_1, \mathcal{S}_4),
\quad \alpha \longmapsto \psi \circ \alpha \circ \varphi
$$
is an equivalence of categories.
\end{lemma}

\begin{proof}
This is a generality and holds in any $2$-category.
\end{proof}

\begin{lemma}
\label{lemma-inertia-fibred-groupoids}
Let $\mathcal{C}$ be a category.
If $p : \mathcal{S} \to \mathcal{C}$ is fibred in groupoids, then
so is the inertia fibred category $\mathcal{I}_\mathcal{S} \to \mathcal{C}$.
\end{lemma}

\begin{proof}
Clear from the construction in
Lemma \ref{lemma-inertia-fibred-category}
or by using (from the same lemma) that
$I_\mathcal{S} \to \mathcal{S}
\times_{\Delta, \mathcal{S} \times_\mathcal{C} \mathcal{S}, \Delta}\mathcal{S}$
is an equivalence and appealing to
Lemma \ref{lemma-2-product-fibred-categories}.
\end{proof}

\begin{lemma}
\label{lemma-cute-groupoids}
Let $\mathcal{C}$ be a category. Let $U \in \Ob(\mathcal{C})$.
If $p : \mathcal{S} \to \mathcal{C}$ is a category fibred in groupoids
and $p$ factors through $p' : \mathcal{S} \to \mathcal{C}/U$
then $p' : \mathcal{S} \to \mathcal{C}/U$ is fibred in groupoids.
\end{lemma}

\begin{proof}
We have already seen in Lemma \ref{lemma-cute} that $p'$ is a fibred
category. Hence it suffices to prove the fibre categories are groupoids,
see Lemma \ref{lemma-fibred-groupoids}.
For $V \in \Ob(\mathcal{C})$ we have
$$
\mathcal{S}_V = \coprod\nolimits_{f : V \to U} \mathcal{S}_{(f : V \to U)}
$$
where the left hand side is the fibre category of $p$ and the right hand side
is the disjoint union of the fibre categories of $p'$.
Hence the result.
\end{proof}

\begin{lemma}
\label{lemma-fibred-in-groupoids-over-fibred-in-groupoids}
Let $\mathcal{A} \to \mathcal{B} \to \mathcal{C}$ be functors between
categories. If $\mathcal{A}$ is fibred in groupoids over $\mathcal{B}$
and $\mathcal{B}$ is fibred in groupoids over $\mathcal{C}$, then
$\mathcal{A}$ is fibred in groupoids over $\mathcal{C}$.
\end{lemma}

\begin{proof}
One can prove this directly from the definition. However, we will argue
using the criterion of Lemma \ref{lemma-fibred-groupoids}.
By Lemma \ref{lemma-fibred-over-fibred} we see that $\mathcal{A}$
is fibred over $\mathcal{C}$. To finish the proof we show that the fibre
category $\mathcal{A}_U$ is a groupoid for $U$ in $\mathcal{C}$.
Namely, if $x \to y$ is a morphism of $\mathcal{A}_U$, then its
image in $\mathcal{B}$ is an isomorphism as $\mathcal{B}_U$ is
a groupoid. But then $x \to y$ is an isomorphism, for example by
Lemma \ref{lemma-composition-cartesian} and the fact that every
morphism of $\mathcal{A}$ is strongly $\mathcal{B}$-cartesian
(see Lemma \ref{lemma-fibred-groupoids}).
\end{proof}

\begin{lemma}
\label{lemma-fibred-groupoids-fibre-product-goes-up}
Let $p : \mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
Let $x \to y$ and $z \to y$ be morphisms of $\mathcal{S}$.
If $p(x) \times_{p(y)} p(z)$ exists, then
$x \times_y z$ exists and $p(x \times_y z) = p(x) \times_{p(y)} p(z)$.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-fibred-category-representable-goes-up}.
\end{proof}

\begin{lemma}
\label{lemma-ameliorate-morphism-categories-fibred-groupoids}
Let $\mathcal{C}$ be a category. Let $F : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $\mathcal{C}$.
There exists a factorization $\mathcal{X} \to \mathcal{X}' \to \mathcal{Y}$
by $1$-morphisms of categories fibred in groupoids over $\mathcal{C}$ such
that $\mathcal{X} \to \mathcal{X}'$ is an equivalence over $\mathcal{C}$
and such that $\mathcal{X}'$ is a category fibred in groupoids over
$\mathcal{Y}$.
\end{lemma}

\begin{proof}
Denote $p : \mathcal{X} \to \mathcal{C}$ and $q : \mathcal{Y} \to \mathcal{C}$
the structure functors. We construct $\mathcal{X}'$ explicitly as follows.
An object of $\mathcal{X}'$ is a quadruple $(U, x, y, f)$ where
$x \in \Ob(\mathcal{X}_U)$, $y \in \Ob(\mathcal{Y}_U)$
and $f : F(x) \to y$ is an isomorphism in $\mathcal{Y}_U$.
A morphism $(a, b) : (U, x, y, f) \to (U', x', y', f')$ is given
by $a : x \to x'$ and $b : y \to y'$ with $p(a) = q(b)$ and
such that $f' \circ F(a) = b \circ f$. In other words
$\mathcal{X}' = \mathcal{X} \times_{F, \mathcal{Y}, \text{id}} \mathcal{Y}$
with the construction of the $2$-fibre product from
Lemma \ref{lemma-2-product-categories-over-C}.
By
Lemma \ref{lemma-2-product-fibred-categories}
we see that $\mathcal{X}'$ is a category fibred in groupoids over
$\mathcal{C}$ and that $\mathcal{X}' \to \mathcal{Y}$ is a morphism of
categories over $\mathcal{C}$. As functor $\mathcal{X} \to \mathcal{X}'$ we take
$x \mapsto (p(x), x, F(x), \text{id}_{F(x)})$ on objects and
$(a : x \to x') \mapsto (a, F(a))$ on morphisms. It is clear that
the composition $\mathcal{X} \to \mathcal{X}' \to \mathcal{Y}$
equals $F$. We omit the verification that
$\mathcal{X} \to \mathcal{X}'$ is an equivalence of fibred categories over
$\mathcal{C}$.

\medskip\noindent
Finally, we have to show that $\mathcal{X}' \to \mathcal{Y}$ is a category
fibred in groupoids. Let $b : y' \to y$ be a morphism in $\mathcal{Y}$
and let $(U, x, y, f)$ be an object of $\mathcal{X}'$ lying over $y$.
Because $\mathcal{X}$ is fibred in groupoids over $\mathcal{C}$ we
can find a morphism $a : x' \to x$ lying over $U' = q(y') \to q(y) = U$.
Since $\mathcal{Y}$ is fibred in groupoids over $\mathcal{C}$ and since
both $F(x') \to F(x)$ and $y' \to y$ lie over the same morphism $U' \to U$
we can find $f' : F(x') \to y'$ lying over $\text{id}_{U'}$ such that
$f \circ F(a) = b \circ f'$. Hence we obtain
$(a, b) : (U', x', y', f') \to (U, x, y, f)$.
This verifies the first condition (1) of
Definition \ref{definition-fibred-groupoids}.
To see (2) let
$(a, b) : (U', x', y', f') \to (U, x, y, f)$ and
$(a', b') : (U'', x'', y'', f'') \to (U, x, y, f)$ be morphisms of
$\mathcal{X}'$ and let $b'' : y' \to y''$ be a morphism of $\mathcal{Y}$
such that $b' \circ b'' = b$. We have to show that there exists
a unique morphism $a'' : x' \to x''$ such that
$f'' \circ F(a'') = b'' \circ f'$ and such that
$(a', b') \circ (a'', b'') = (a, b)$. Because $\mathcal{X}$ is fibred
in groupoids we know there exists a unique morphism
$a'' : x' \to x''$ such that $a' \circ a'' = a$ and $p(a'') = q(b'')$.
Because $\mathcal{Y}$ is fibred in groupoids we see that
$F(a'')$ is the unique morphism $F(x') \to F(x'')$ such that
$F(a') \circ F(a'') = F(a)$ and $q(F(a'')) = q(b'')$. The relation
$f'' \circ F(a'') = b'' \circ f'$ follows from this and the given
relations $f \circ F(a) = b \circ f'$ and $f \circ F(a') = b' \circ f''$.
\end{proof}

\begin{lemma}
\label{lemma-amelioration-unique}
Let $\mathcal{C}$ be a category. Let $F : \mathcal{X} \to \mathcal{Y}$
be a $1$-morphism of categories fibred in groupoids over $\mathcal{C}$.
Assume we have a $2$-commutative diagram
$$
\xymatrix{
\mathcal{X}' \ar[rd]_f &
\mathcal{X} \ar[l]^a \ar[d]^F \ar[r]_b &
\mathcal{X}'' \ar[ld]^g \\
& \mathcal{Y}
}
$$
where $a$ and $b$ are equivalences of categories over $\mathcal{C}$
and $f$ and $g$ are categories fibred in groupoids. Then there exists
an equivalence $h : \mathcal{X}'' \to \mathcal{X}'$ of categories over
$\mathcal{Y}$ such that $h \circ b$ is $2$-isomorphic to $a$ as $1$-morphisms
of categories over $\mathcal{C}$. If the diagram above actually commutes, then
we can arrange it so that $h \circ b$ is $2$-isomorphic to $a$ as
$1$-morphisms of categories over $\mathcal{Y}$.
\end{lemma}

\begin{proof}
We will show that both $\mathcal{X}'$ and $\mathcal{X}''$ over $\mathcal{Y}$
are equivalent to the category fibred in groupoids
$\mathcal{X} \times_{F, \mathcal{Y}, \text{id}} \mathcal{Y}$
over $\mathcal{Y}$, see proof of
Lemma \ref{lemma-ameliorate-morphism-categories-fibred-groupoids}.
Choose a quasi-inverse $b^{-1} : \mathcal{X}'' \to \mathcal{X}$ in the
$2$-category of categories over $\mathcal{C}$.
Since the right triangle of the diagram is $2$-commutative we see that
$$
\xymatrix{
\mathcal{X} \ar[d]_F & \mathcal{X}'' \ar[l]^{b^{-1}} \ar[d]^g \\
\mathcal{Y} & \mathcal{Y} \ar[l]
}
$$
is $2$-commutative. Hence we obtain a $1$-morphism
$c : \mathcal{X}'' \to
\mathcal{X} \times_{F, \mathcal{Y}, \text{id}} \mathcal{Y}$
by the universal property of the $2$-fibre product. Moreover $c$
is a morphism of categories over $\mathcal{Y}$ (!) and an equivalence
(by the assumption that $b$ is an equivalence, see
Lemma \ref{lemma-equivalence-2-fibre-product}).
Hence $c$ is an equivalence in the $2$-category of categories fibred
in groupoids over $\mathcal{Y}$ by
Lemma \ref{lemma-equivalence-fibred-categories}.

\medskip\noindent
We still have to construct a $2$-isomorphism between $c \circ b$ and
the functor $d : \mathcal{X} \to
\mathcal{X} \times_{F, \mathcal{Y}, \text{id}} \mathcal{Y}$,
$x \mapsto (p(x), x, F(x), \text{id}_{F(x)})$
constructed in the proof of
Lemma \ref{lemma-ameliorate-morphism-categories-fibred-groupoids}.
Let $\alpha : F \to g \circ b$ and $\beta : b^{-1} \circ b \to \text{id}$
be $2$-isomorphisms between $1$-morphisms of categories over $\mathcal{C}$.
Note that $c \circ b$ is given by the rule
$$
x \mapsto (p(x), b^{-1}(b(x)), g(b(x)), \alpha_x \circ F(\beta_x))
$$
on objects. Then we see that
$$
(\beta_x, \alpha_x) :
(p(x), x, F(x), \text{id}_{F(x)})
\longrightarrow
(p(x), b^{-1}(b(x)), g(b(x)), \alpha_x \circ F(\beta_x))
$$
is a functorial isomorphism which gives our $2$-morphism
$d \to b \circ c$. Finally, if the diagram commutes then
$\alpha_x$ is the identity for all $x$ and we see that this
$2$-morphism is a $2$-morphism in the $2$-category of categories
over $\mathcal{Y}$.
\end{proof}

































\section{Presheaves of categories}
\label{section-presheaves-categories}

\noindent
In this section we compare the notion of fibred categories
with the closely related notion of a ``presheaf of categories''.
The basic construction is explained in the following example.

\begin{example}
\label{example-functor-categories}
Let $\mathcal{C}$ be a category.
Suppose that $F : \mathcal{C}^{opp} \to \textit{Cat}$ is a functor
to the $2$-category of categories, see
Definition \ref{definition-functor-into-2-category}.
For $f : V \to U$ in $\mathcal{C}$ we will
suggestively write $F(f) = f^\ast$ for the functor from $F(U)$ to $F(V)$.
From this we can construct a fibred category $\mathcal{S}_F$ over
$\mathcal{C}$ as follows. Define
$$
\Ob(\mathcal{S}_F) =
\{(U, x) \mid U\in \Ob(\mathcal{C}), x\in \Ob(F(U))\}.
$$
For $(U, x), (V, y) \in \Ob(\mathcal{S}_F)$ we define
\begin{align*}
\Mor_{\mathcal{S}_F}((V, y), (U, x)) & =
\{ (f, \phi) \mid f \in \Mor_\mathcal{C}(V, U),
\phi \in \Mor_{F(V)}(y, f^\ast x)\} \\
& =
\coprod\nolimits_{f \in \Mor_\mathcal{C}(V, U)}
\Mor_{F(V)}(y, f^\ast x)
\end{align*}
In order to define composition we use that $g^\ast \circ f^\ast =
(f \circ g)^\ast$ for a pair of composable morphisms of $\mathcal{C}$
(by definition of a functor into a $2$-category).
Namely, we define the composition of $\psi : z \to g^\ast y$ and
$ \phi : y \to f^\ast x$ to be $ g^\ast(\phi) \circ \psi$. The functor
$p_F : \mathcal{S}_F \to \mathcal{C}$ is given by the rule
$(U, x) \mapsto U$.
Let us check that this is indeed a fibred category.
Given $f: V \to U$ in $\mathcal{C}$ and $(U, x)$ a lift of $U$, then
we claim $(f, \text{id}_{f^\ast x}): (V, {f^\ast x}) \to (U, x)$ is a
strongly cartesian lift of $f$.
We have to show a $h$ in the diagram on the left
determines $(h, \nu)$ on the right:
$$
\xymatrix{
V \ar[r]^f &
U &
(V, f^*x) \ar[r]^{(f, \text{id}_{f^*x})} &
(U, x) \\
W \ar@{-->}[u]^h \ar[ru]_g & &
(W, z) \ar@{-->}[u]^{(h, \nu)} \ar[ru]_{(g, \psi)} &
}
$$
Just take $\nu = \psi$ which works because $f \circ h = g$
and hence $g^*x = h^*f^*x$. Moreover, this is the only lift
making the diagram (on the right) commute.
\end{example}

\begin{definition}
\label{definition-split-fibred-category}
Let $\mathcal{C}$ be a category.
Suppose that $F : \mathcal{C}^{opp} \to \textit{Cat}$ is a functor
to the $2$-category of categories.
We will write $p_F : \mathcal{S}_F \to \mathcal{C}$ for the
fibred category constructed in
Example \ref{example-functor-categories}.
A {\it split fibred category} is a fibred category isomorphic (!)
over $\mathcal{C}$ to one of these categories {\it $\mathcal{S}_F$}.
\end{definition}

\begin{lemma}
\label{lemma-when-split}
Let $\mathcal{C}$ be a category.
Let $\mathcal{S}$ be a fibred category over $\mathcal{C}$.
Then $\mathcal{S}$ is split if and only if for some choice
of pullbacks (see Definition \ref{definition-pullback-functor-fibred-category})
the pullback functors
$(f \circ g)^*$ and $g^* \circ f^*$ are equal.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-fibred-strict}
Let $ p : \mathcal{S} \to \mathcal{C}$ be a fibred category.
There exists a contravariant functor $F : \mathcal{C} \to \textit{Cat}$
such that $\mathcal{S}$ is equivalent to $\mathcal{S}_F$
in the $2$-category of fibred categories over $\mathcal{C}$. In other
words, every fibred category is equivalent to a split one.
\end{lemma}

\begin{proof}
Let us make a choice of pullbacks (see
Definition \ref{definition-pullback-functor-fibred-category}).
By Lemma \ref{lemma-fibred} we get pullback functors $f^*$ for
every morphism $f$ of $\mathcal{C}$.

\medskip\noindent
We construct a new category $\mathcal{S}'$ as follows.
The objects of $\mathcal{S}'$ are pairs $(x, f)$
consisting of a morphism $f : V \to U$ of $\mathcal{C}$
and an object $x$ of $\mathcal{S}$ over $U$, i.e.,
$x\in \Ob(\mathcal{S}_U)$. The functor
$p' : \mathcal{S}' \to \mathcal{C}$ will map the pair $(x, f)$ to the source
of the morphism $f$, in other words $p'(x, f : V\to U) = V$. A morphism
$\varphi : (x_1, f_1: V_1 \to U_1) \to (x_2, f_2 : V_2 \to U_2)$ is given by a
pair $(\varphi, g)$ consisting of a morphism $g : V_1 \to V_2$ and a morphism
$\varphi : f_1^\ast x_1 \to f_2^\ast x_2$ with $p(\varphi) = g$. It is no
problem to define the composition law: $(\varphi, g) \circ (\psi, h) =
(\varphi \circ \psi, g\circ h)$ for any pair of composable morphisms.
There is a natural functor $\mathcal{S} \to \mathcal{S}'$ which simply maps
$x$ over $U$ to the pair $(x, \text{id}_U)$.

\medskip\noindent
At this point we need to check that $p'$ makes $\mathcal{S}'$ into a
fibred category over $\mathcal{C}$, and we need to check that
$\mathcal{S} \to \mathcal{S}'$ is an equivalence of categories over
$\mathcal{C}$ which maps strongly cartesian morphisms to strongly
cartesian morphisms. We omit the verifications.

\medskip\noindent
Finally, we can define pullback functors on $\mathcal{S}'$
by setting $g^\ast(x, f) = (x, f \circ g)$ on objects if
$g : V' \to V$ and $f : V \to U$. On morphisms
$(\varphi, \text{id}_V) : (x_1, f_1) \to (x_2, f_2)$
between morphisms in $\mathcal{S}'_V$ we set $g^\ast(\varphi, \text{id}_V) =
(g^\ast\varphi, \text{id}_{V'})$ where we use the unique identifications
$g^\ast f_i^\ast x_i = (f_i \circ g)^\ast x_i$ from Lemma
\ref{lemma-fibred} to think of $g^\ast\varphi$ as a morphism from
$(f_1 \circ g)^\ast x_1$ to $(f_2 \circ g)^\ast x_2$. Clearly, these pullback
functors $g^\ast$ have the property that
$g_1^\ast \circ g_2^\ast = (g_2\circ g_1)^\ast$, in other words $\mathcal{S}'$
is split as desired.
\end{proof}


















\section{Presheaves of groupoids}
\label{section-presheaves-groupoids}

\noindent
In this section we compare the notion of categories fibred in groupoids
with the closely related notion of a ``presheaf of groupoids''. The basic
construction is explained in the following example.

\begin{example}
\label{example-functor-groupoids}
This example is the analogue of
Example \ref{example-functor-categories},
for ``presheaves of groupoids'' instead of ``presheaves of categories''.
The output will be a category fibred in groupoids instead of a fibred category.
Suppose that $F : \mathcal{C}^{opp} \to \text{Groupoids}$ is a functor
to the category of groupoids, see
Definition \ref{definition-functor-into-2-category}.
For $f : V \to U$ in $\mathcal{C}$ we will
suggestively write $F(f) = f^\ast$ for the functor from $F(U)$ to $F(V)$.
We construct a category $\mathcal{S}_F$ fibred in groupoids over $\mathcal{C}$
as follows. Define
$$
\Ob(\mathcal{S}_F) =
\{(U, x) \mid U\in \Ob(\mathcal{C}), x\in \Ob(F(U))\}.
$$
For $(U, x), (V, y) \in \Ob(\mathcal{S}_F)$ we define
\begin{align*}
\Mor_{\mathcal{S}_F}((V, y), (U, x))
& =
\{ (f, \phi) \mid f \in \Mor_\mathcal{C}(V, U),
\phi \in \Mor_{F(V)}(y, f^\ast x)\} \\
& =
\coprod\nolimits_{f \in \Mor_\mathcal{C}(V, U)}
\Mor_{F(V)}(y, f^\ast x)
\end{align*}
In order to define composition we use that $g^\ast \circ f^\ast =
(f \circ g)^\ast$ for a pair of composable morphisms of $\mathcal{C}$
(by definition of a functor into a $2$-category).
Namely, we define the composition of $\psi : z \to g^\ast y$ and
$ \phi : y \to f^\ast x$ to be $ g^\ast(\phi) \circ \psi$. The functor
$p_F : \mathcal{S}_F \to \mathcal{C}$ is given by the rule $(U, x) \mapsto U$.
The condition that $F(U)$ is a groupoid for every $U$ guarantees that
$\mathcal{S}_F$ is fibred in groupoids over $\mathcal{C}$, as we have
already seen in
Example \ref{example-functor-categories}
that $\mathcal{S}_F$ is a fibred category, see
Lemma \ref{lemma-fibred-groupoids}.
But we can also prove conditions (1), (2) of
Definition \ref{definition-fibred-groupoids}
directly as follows: (1) Lifts of
morphisms exist since given $f: V \to U$ in $\mathcal{C}$ and $(U, x)$
an object of $\mathcal{S}_F$ over $U$, then
$(f, \text{id}_{f^\ast x}): (V, {f^\ast x}) \to (U, x)$ is a lift of $f$.
(2) Suppose given solid diagrams as follows
$$
\xymatrix{
V \ar[r]^f & U & (V, y) \ar[r]^{(f, \phi)} & (U, x) \\
W \ar@{-->}[u]^h \ar[ru]_g & &
(W, z) \ar@{-->}[u]^{(h, \nu)} \ar[ru]_{(g, \psi)} & \\
}
$$
Then for the dotted arrows we have $\nu = (h^\ast \phi)^{-1} \circ \psi$
so given $h$ there exists a $\nu$ which is unique by uniqueness of inverses.
\end{example}

\begin{definition}
\label{definition-split-category-fibred-in-groupoids}
Let $\mathcal{C}$ be a category.
Suppose that $F : \mathcal{C}^{opp} \to \textit{Groupoids}$ is a functor
to the $2$-category of groupoids.
We will write $p_F : \mathcal{S}_F \to \mathcal{C}$ for the
category fibred in groupoids constructed in
Example \ref{example-functor-groupoids}.
A {\it split category fibred in groupoids} is a
category fibred in groupoids isomorphic (!)
over $\mathcal{C}$ to one of these categories {\it $\mathcal{S}_F$}.
\end{definition}

\begin{lemma}
\label{lemma-fibred-groupoids-strict}
Let $ p : \mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
There exists a contravariant functor $F : \mathcal{C} \to \text{Groupoids}$
such that $\mathcal{S}$ is equivalent to $\mathcal{S}_F$ over $\mathcal{C}$.
In other words, every category fibred in groupoids is equivalent to a split one.
\end{lemma}

\begin{proof}
Make a choice of pullbacks (see
Definition \ref{definition-pullback-functor-fibred-category}).
By Lemmas \ref{lemma-fibred} and \ref{lemma-fibred-groupoids}
we get pullback functors $f^*$ for
every morphism $f$ of $\mathcal{C}$.

\medskip\noindent
We construct a new category $\mathcal{S}'$ as follows.
The objects of $\mathcal{S}'$ are pairs $(x, f)$
consisting of a morphism $f : V \to U$ of $\mathcal{C}$
and an object $x$ of $\mathcal{S}$ over $U$, i.e.,
$x\in \Ob(\mathcal{S}_U)$. The functor
$p' : \mathcal{S}' \to \mathcal{C}$ will map the pair $(x, f)$ to the source
of the morphism $f$, in other words $p'(x, f : V\to U) = V$. A morphism
$\varphi : (x_1, f_1: V_1 \to U_1) \to (x_2, f_2 : V_2 \to U_2)$ is given by a
pair $(\varphi, g)$ consisting of a morphism $g : V_1 \to V_2$ and a morphism
$\varphi : f_1^\ast x_1 \to f_2^\ast x_2$ with $p(\varphi) = g$. It is no
problem to define the composition law: $(\varphi, g) \circ (\psi, h) =
(\varphi \circ \psi, g\circ h)$ for any pair of composable morphisms.
There is a natural functor $\mathcal{S} \to \mathcal{S}'$ which simply maps
$x$ over $U$ to the pair $(x, \text{id}_U)$.

\medskip\noindent
At this point we need to check that $p'$ makes $\mathcal{S}'$ into a category
fibred in groupoids over $\mathcal{C}$, and we need to check that
$\mathcal{S} \to \mathcal{S}'$ is an equivalence of categories over
$\mathcal{C}$. We omit the verifications.

\medskip\noindent
Finally, we can define pullback functors on $\mathcal{S}'$
by setting $g^\ast(x, f) = (x, f \circ g)$ on objects if
$g : V' \to V$ and $f : V \to U$. On morphisms
$(\varphi, \text{id}_V) : (x_1, f_1) \to (x_2, f_2)$
between morphisms in $\mathcal{S}'_V$ we set $g^\ast(\varphi, \text{id}_V) =
(g^\ast\varphi, \text{id}_{V'})$ where we use the unique identifications
$g^\ast f_i^\ast x_i = (f_i \circ g)^\ast x_i$ from Lemma
\ref{lemma-fibred-groupoids} to think of $g^\ast\varphi$ as a morphism from
$(f_1 \circ g)^\ast x_1$ to $(f_2 \circ g)^\ast x_2$. Clearly, these pullback
functors $g^\ast$ have the property that
$g_1^\ast \circ g_2^\ast = (g_2\circ g_1)^\ast$, in other words $\mathcal{S}'$
is split as desired.
\end{proof}

\noindent
We will see an alternative proof of this lemma in
Section \ref{section-representable-1-morphisms}.








\section{Categories fibred in sets}
\label{section-fibred-in-sets}

\begin{definition}
\label{definition-discrete}
A category is called {\it discrete} if the only morphisms are the identity
morphisms.
\end{definition}

\noindent
A discrete category has only one interesting piece of information:
its set of objects. Thus we sometime confuse discrete categories
with sets.

\begin{definition}
\label{definition-category-fibred-sets}
Let $\mathcal{C}$ be a category.
A {\it category fibred in sets}, or a {\it category fibred
in discrete categories} is a category fibred in groupoids all
of whose fibre categories are discrete.
\end{definition}

\noindent
We want to clarify the relationship between categories fibred in sets
and presheaves (see Definition \ref{definition-presheaf}).
To do this it makes sense to first make the following definition.

\begin{definition}
\label{definition-categories-fibred-in-sets-over-C}
Let $\mathcal{C}$ be a category.
The {\it $2$-category of categories fibred in sets over $\mathcal{C}$}
is the sub $2$-category of the category of categories fibred in groupoids
over $\mathcal{C}$ (see
Definition \ref{definition-categories-fibred-in-groupoids-over-C})
defined as follows:
\begin{enumerate}
\item Its objects will be categories
$p : \mathcal{S} \to \mathcal{C}$ fibred in sets.
\item Its $1$-morphisms $(\mathcal{S}, p) \to (\mathcal{S}', p')$
will be functors $G : \mathcal{S} \to \mathcal{S}'$ such that
$p' \circ G = p$ (since every morphism is strongly cartesian
$G$ automatically preserves them).
\item Its $2$-morphisms $t : G \to H$ for
$G, H : (\mathcal{S}, p) \to (\mathcal{S}', p')$
will be morphisms of functors
such that $p'(t_x) = \text{id}_{p(x)}$
for all $x \in \Ob(\mathcal{S})$.
\end{enumerate}
\end{definition}

\noindent
Note that every $2$-morphism is automatically an isomorphism.
Hence this $2$-category is actually a $(2, 1)$-category.
Here is the obligatory lemma on the existence of $2$-fibre products.

\begin{lemma}
\label{lemma-2-product-categories-fibred-sets}
Let $\mathcal{C}$ be a category.
The 2-category of categories fibred in sets over $\mathcal{C}$
has 2-fibre products. More precisely, the 2-fibre product described in
Lemma \ref{lemma-2-product-categories-over-C}
returns a category fibred in sets if one starts out with such.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{example}
\label{example-presheaf}
This example is the analogue of
Examples \ref{example-functor-categories} and
\ref{example-functor-groupoids}
for presheaves instead of ``presheaves of categories''.
The output will be a category fibred in sets instead of a fibred category.
Suppose that $F : \mathcal{C}^{opp} \to \textit{Sets}$ is a presheaf.
For $f : V \to U$ in $\mathcal{C}$ we will
suggestively write $F(f) = f^\ast : F(U) \to F(V)$.
We construct a category $\mathcal{S}_F$ fibred in sets over $\mathcal{C}$
as follows. Define
$$
\Ob(\mathcal{S}_F) =
\{(U, x) \mid U \in \Ob(\mathcal{C}), x \in \Ob(F(U))\}.
$$
For $(U, x), (V, y) \in \Ob(\mathcal{S}_F)$ we define
\begin{align*}
\Mor_{\mathcal{S}_F}((V, y), (U, x))
& =
\{f \in \Mor_\mathcal{C}(V, U) \mid f^*x = y\}
\end{align*}
Composition is inherited from composition in $\mathcal{C}$
which works as $g^\ast \circ f^\ast = (f \circ g)^\ast$
for a pair of composable morphisms of $\mathcal{C}$.
The functor $p_F : \mathcal{S}_F \to \mathcal{C}$
is given by the rule $(U, x) \mapsto U$.
As every fibre category $\mathcal{S}_{F, U}$ is discrete with underlying
set $F(U)$ and we have already see in
Example \ref{example-functor-groupoids}
that $\mathcal{S}_F$ is a category fibred in groupoids,
we conclude that $\mathcal{S}_F$ is fibred in sets.
\end{example}

\begin{lemma}
\label{lemma-2-category-fibred-sets}
\begin{slogan}
Categories fibred in sets are precisely presheaves.
\end{slogan}
Let $\mathcal{C}$ be a category.
The only $2$-morphisms between categories fibred in sets are identities.
In other words, the $2$-category of categories fibred in sets is a category.
Moreover, there is an equivalence of categories
$$
\left\{
\begin{matrix}
\text{the category of presheaves}\\
\text{of sets over }\mathcal{C}
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
\text{the category of categories}\\
\text{fibred in sets over }\mathcal{C}
\end{matrix}
\right\}
$$
The functor from left to right is the construction
$F \to \mathcal{S}_F$ discussed in
Example \ref{example-presheaf}.
The functor from right to left assigns to $p : \mathcal{S} \to \mathcal{C}$
the presheaf of objects $U \mapsto \Ob(\mathcal{S}_U)$.
\end{lemma}

\begin{proof}
The first assertion is clear, as the only morphisms in the fibre
categories are identities.

\medskip\noindent
Suppose that $p :
\mathcal{S} \to \mathcal{C}$ is fibred in sets. Let $f : V \to U$
be a morphism in $\mathcal{C}$ and let $x \in \Ob(\mathcal{S}_U)$.
Then there is exactly one choice for the object $f^\ast x$. Thus we see that
$(f \circ g)^\ast x = g^\ast(f^\ast x)$ for $f, g$ as in Lemma
\ref{lemma-fibred-groupoids}. It follows that we may think of the
assignments $U \mapsto \Ob(\mathcal{S}_U)$ and $f \mapsto f^\ast$
as a presheaf on $\mathcal{C}$.
\end{proof}

\noindent
Here is an important example of a category fibred in sets.

\begin{example}
\label{example-fibred-category-from-functor-of-points}
Let $\mathcal{C}$ be a category. Let $X \in \Ob(\mathcal{C})$.
Consider the representable presheaf $h_X = \Mor_\mathcal{C}(-, X)$
(see Example \ref{example-hom-functor}).
On the other hand, consider the category $p : \mathcal{C}/X \to \mathcal{C}$
from Example \ref{example-category-over-X}.
The fibre category $(\mathcal{C}/X)_U$ has as objects morphisms
$h : U \to X$, and only identities as morphisms. Hence we see that
under the correspondence of
Lemma \ref{lemma-2-category-fibred-sets}
we have
$$
h_X \longleftrightarrow \mathcal{C}/X.
$$
In other words, the category $\mathcal{C}/X$ is canonically equivalent
to the category $\mathcal{S}_{h_X}$ associated
to $h_X$ in
Example \ref{example-presheaf}.
\end{example}

\noindent
For this reason it is tempting to define a ``representable'' object in the
2-category of categories fibred in groupoids to be a category fibred in
sets whose associated presheaf is representable. However, this is would not
be a good definition for use since we prefer to have a notion which is
invariant under equivalences. To make this precise we study exactly
which categories fibred in groupoids are equivalent to categories
fibred in sets.









\section{Categories fibred in setoids}
\label{section-fibred-in-setoids}

\begin{definition}
\label{definition-setoid}
Let us call a category a {\it setoid}\footnote{A set on steroids!?}
if it is a groupoid where every object
has exactly one automorphism: the identity.
\end{definition}

\noindent
If $C$ is a set with an equivalence relation $\sim$, then we can make a setoid
$\mathcal{C}$ as follows: $\Ob(\mathcal{C}) = C$ and
$\Mor_\mathcal{C}(x, y) = \emptyset$ unless $x \sim y$ in which
case we set $\Mor_\mathcal{C}(x, y) = \{1\}$. Transitivity of
$\sim$ means that we can compose morphisms. Conversely any setoid
category defines an equivalence relation on its objects (isomorphism)
such that you recover the category (up to unique isomorphism -- not
equivalence) from the procedure just described.

\medskip\noindent
Discrete categories are setoids. For any setoid $\mathcal{C}$ there is a
canonical procedure to make a discrete category equivalent to it, namely
one replaces $\Ob(\mathcal{C})$ by the set of isomorphism
classes (and adds identity morphisms). In terms of sets endowed
with an equivalence relation this corresponds to taking the quotient
by the equivalence relation.

\begin{definition}
\label{definition-category-fibred-setoids}
Let $\mathcal{C}$ be a category. A {\it category fibred in setoids}
is a category fibred in groupoids all of whose fibre categories are
setoids.
\end{definition}

\noindent
Below we will clarify the relationship between categories fibred in setoids
and categories fibred in sets.

\begin{definition}
\label{definition-categories-fibred-in-setoids-over-C}
Let $\mathcal{C}$ be a category.
The {\it $2$-category of categories fibred in setoids over $\mathcal{C}$}
is the sub $2$-category of the category of categories fibred in groupoids
over $\mathcal{C}$ (see
Definition \ref{definition-categories-fibred-in-groupoids-over-C})
defined as follows:
\begin{enumerate}
\item Its objects will be categories
$p : \mathcal{S} \to \mathcal{C}$ fibred in setoids.
\item Its $1$-morphisms $(\mathcal{S}, p) \to (\mathcal{S}', p')$
will be functors $G : \mathcal{S} \to \mathcal{S}'$ such that
$p' \circ G = p$ (since every morphism is strongly cartesian
$G$ automatically preserves them).
\item Its $2$-morphisms $t : G \to H$ for
$G, H : (\mathcal{S}, p) \to (\mathcal{S}', p')$
will be morphisms of functors
such that $p'(t_x) = \text{id}_{p(x)}$
for all $x \in \Ob(\mathcal{S})$.
\end{enumerate}
\end{definition}

\noindent
Note that every $2$-morphism is automatically an isomorphism.
Hence this $2$-category is actually a $(2, 1)$-category.

\noindent
Here is the obligatory lemma on the existence of $2$-fibre products.

\begin{lemma}
\label{lemma-2-product-categories-fibred-setoids}
Let $\mathcal{C}$ be a category.
The 2-category of categories fibred in setoids over $\mathcal{C}$
has 2-fibre products. More precisely, the 2-fibre product described in
Lemma \ref{lemma-2-product-categories-over-C} returns a category fibred in
setoids if one starts out with such.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-setoid-fibres}
Let $\mathcal{C}$ be a category. Let $\mathcal{S}$ be a category
over $\mathcal{C}$.
\begin{enumerate}
\item If $\mathcal{S} \to \mathcal{S}'$ is an equivalence
over $\mathcal{C}$ with $\mathcal{S}'$ fibred in sets over $\mathcal{C}$,
then
\begin{enumerate}
\item $\mathcal{S}$ is fibred in setoids over $\mathcal{C}$, and
\item for each $U \in \Ob(\mathcal{C})$ the map
$\Ob(\mathcal{S}_U) \to \Ob(\mathcal{S}'_U)$
identifies the target as the set of isomorphism classes of the source.
\end{enumerate}
\item If $p : \mathcal{S} \to \mathcal{C}$ is a category fibred in setoids,
then there exists a category fibred in sets
$p' : \mathcal{S}' \to \mathcal{C}$ and an equivalence
$\text{can} : \mathcal{S} \to \mathcal{S}'$ over $\mathcal{C}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (2).
An object of the category $\mathcal{S}'$ will be a pair $(U, \xi)$, where
$U \in \Ob(\mathcal{C})$ and $\xi$ is an isomorphism class of objects
of $\mathcal{S}_U$. A morphism $(U, \xi) \to (V , \psi)$ is given by a
morphism $x \to y$, where $x \in \xi$ and $y \in \psi$. Here we identify
two morphisms $x \to y$ and $x' \to y'$ if they induce the same morphism
$U \to V$, and if for some choices of isomorphisms $x \to x'$ in
$\mathcal{S}_U$ and $y \to y'$ in $\mathcal{S}_V$ the compositions
$x \to x' \to y'$ and $x \to y \to y'$ agree. By construction there are
surjective maps on objects and morphisms from $\mathcal{S} \to
\mathcal{S}'$. We define composition of morphisms in $\mathcal{S}'$ to
be the unique law that turns $\mathcal{S} \to \mathcal{S}'$ into a functor.
Some details omitted.
\end{proof}

\noindent
Thus categories fibred in setoids are exactly the categories fibred
in groupoids which are equivalent to categories fibred in sets.
Moreover, an equivalence of categories fibred in sets is an isomorphism
by Lemma \ref{lemma-2-category-fibred-sets}.

\begin{lemma}
\label{lemma-2-category-fibred-setoids}
Let $\mathcal{C}$ be a category. The construction of
Lemma \ref{lemma-setoid-fibres}
part (2) gives a functor
$$
F :
\left\{
\begin{matrix}
\text{the 2-category of categories}\\
\text{fibred in setoids over }\mathcal{C}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
\text{the category of categories}\\
\text{fibred in sets over }\mathcal{C}
\end{matrix}
\right\}
$$
(see
Definition \ref{definition-functor-into-2-category}).
This functor is an equivalence in the following sense:
\begin{enumerate}
\item for any two 1-morphisms $f, g : \mathcal{S}_1 \to \mathcal{S}_2$
with $F(f) = F(g)$ there exists a unique 2-isomorphism $f \to g$,
\item for any morphism $h : F(\mathcal{S}_1) \to F(\mathcal{S}_2)$
there exists a 1-morphism $f : \mathcal{S}_1 \to \mathcal{S}_2$
with $F(f) = h$, and
\item any category fibred in sets $\mathcal{S}$ is equal to $F(\mathcal{S})$.
\end{enumerate}
In particular, defining $F_i \in \textit{PSh}(\mathcal{C})$ by the
rule $F_i(U) = \Ob(\mathcal{S}_{i, U})/\cong$, we have
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{S}_1, \mathcal{S}_2)
\Big/
2\text{-isomorphism}
=
\Mor_{\textit{PSh}(\mathcal{C})}(F_1, F_2)
$$
More precisely, given any map $\phi : F_1 \to F_2$ there exists a
$1$-morphism $f : \mathcal{S}_1 \to \mathcal{S}_2$ which induces
$\phi$ on isomorphism classes of objects and
which is unique up to unique $2$-isomorphism.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-2-category-fibred-sets}
the target of $F$ is a category hence the assertion makes sense.
The construction of
Lemma \ref{lemma-setoid-fibres} part (2)
assigns to $\mathcal{S}$ the category fibred in sets whose value over
$U$ is the set of isomorphism classes in $\mathcal{S}_U$. Hence it
is clear that it defines a functor as indicated.
Let $f, g : \mathcal{S}_1 \to \mathcal{S}_2$
with $F(f) = F(g)$ be as in (1). For each object $U$ of $\mathcal{C}$
and each object $x$ of $\mathcal{S}_{1, U}$ we see that $f(x) \cong g(x)$
by assumption. As $\mathcal{S}_2$ is fibred in setoids there exists
a unique isomorphism $t_x : f(x) \to g(x)$ in $\mathcal{S}_{2, U}$.
Clearly the rule $x \mapsto t_x$ gives the desired $2$-isomorphism
$f \to g$. We omit the proofs of (2) and (3).
To see the final assertion use
Lemma \ref{lemma-2-category-fibred-sets}
to see that the right hand side is equal to
$\Mor_{\textit{Cat}/\mathcal{C}}(F(\mathcal{S}_1), F(\mathcal{S}_2))$
and apply (1) and (2) above.
\end{proof}

\noindent
Here is another characterization of categories fibred in setoids
among all categories fibred in groupoids.

\begin{lemma}
\label{lemma-characterize-fibred-setoids-inertia}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
The following are equivalent:
\begin{enumerate}
\item $p : \mathcal{S} \to \mathcal{C}$ is a category fibred in setoids, and
\item the canonical $1$-morphism $\mathcal{I}_\mathcal{S} \to \mathcal{S}$,
see (\ref{equation-inertia-structure-map}), is an equivalence (of categories
over $\mathcal{C}$).
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2). The category $\mathcal{I}_\mathcal{S}$ has objects
$(x, \alpha)$ where $x \in \mathcal{S}$, say with $p(x) = U$, and
$\alpha : x \to x$ is a morphism in $\mathcal{S}_U$. Hence if
$\mathcal{I}_\mathcal{S} \to \mathcal{S}$ is an equivalence over $\mathcal{C}$
then every pair of objects $(x, \alpha)$, $(x, \alpha')$ are isomorphic
in the fibre category of $\mathcal{I}_\mathcal{S}$ over $U$.
Looking at the definition of morphisms in $\mathcal{I}_\mathcal{S}$
we conclude that $\alpha$, $\alpha'$ are conjugate in the group
of automorphisms of $x$. Hence taking $\alpha' = \text{id}_x$ we conclude
that every automorphism of $x$ is equal to the identity.
Since $\mathcal{S} \to \mathcal{C}$ is fibred in groupoids this
implies that $\mathcal{S} \to \mathcal{C}$ is fibred in setoids.
We omit the proof of (1) $\Rightarrow$ (2).
\end{proof}

\begin{lemma}
\label{lemma-category-fibred-setoids-presheaves-products}
Let $\mathcal{C}$ be a category.
The construction of
Lemma \ref{lemma-2-category-fibred-setoids}
which associates to a category fibred in setoids a presheaf is
compatible with products, in the sense that the presheaf associated
to a $2$-fibre product $\mathcal{X} \times_\mathcal{Y} \mathcal{Z}$
is the fibre product of the presheaves associated to
$\mathcal{X}, \mathcal{Y}, \mathcal{Z}$.
\end{lemma}

\begin{proof}
Let $U \in \Ob(\mathcal{C})$. The lemma just says that
$$
\Ob((\mathcal{X} \times_\mathcal{Y} \mathcal{Z})_U)/\!\cong
\quad \text{equals} \quad
\Ob(\mathcal{X}_U)/\!\cong
\ \times_{\Ob(\mathcal{Y}_U)/\!\cong}
\ \Ob(\mathcal{Z}_U)/\!\cong
$$
the proof of which we omit. (But note that this would not be true
in general if the category $\mathcal{Y}_U$ is not a setoid.)
\end{proof}










\section{Representable categories fibred in groupoids}
\label{section-representable-fibred-groupoids}

\noindent
Here is our definition of a representable category fibred in groupoids.
As promised this is invariant under equivalences.

\begin{definition}
\label{definition-representable-fibred-category}
Let $\mathcal{C}$ be a category.
A category fibred in groupoids $p : \mathcal{S} \to \mathcal{C}$ is
called {\it representable} if there exists an object
$X$ of $\mathcal{C}$ and an equivalence $j : \mathcal{S} \to \mathcal{C}/X$
(in the $2$-category of groupoids over $\mathcal{C}$).
\end{definition}

\noindent
The usual abuse of notation is to say that {\it $X$ represents $\mathcal{S}$}
and not mention the equivalence $j$. We spell out what this entails.

\begin{lemma}
\label{lemma-characterize-representable-fibred-category}
Let $\mathcal{C}$ be a category.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
\begin{enumerate}
\item $\mathcal{S}$ is representable if and only if
the following conditions are satisfied:
\begin{enumerate}
\item $\mathcal{S}$ is fibred in setoids, and
\item the presheaf $U \mapsto \Ob(\mathcal{S}_U)/\cong$ is
representable.
\end{enumerate}
\item If $\mathcal{S}$ is representable the pair $(X, j)$, where $j$ is the
equivalence $j : \mathcal{S} \to \mathcal{C}/X$, is uniquely determined
up to isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion follows immediately from
Lemma \ref{lemma-setoid-fibres}.
For the second, suppose that $j' : \mathcal{S} \to \mathcal{C}/X'$ is
a second such pair. Choose a $1$-morphism
$t' : \mathcal{C}/X' \to \mathcal{S}$ such that
$j' \circ t' \cong \text{id}_{\mathcal{C}/X'}$ and
$t' \circ j' \cong \text{id}_\mathcal{S}$. Then
$j \circ t' : \mathcal{C}/X' \to \mathcal{C}/X$ is an equivalence.
Hence it is an isomorphism, see Lemma \ref{lemma-2-category-fibred-sets}.
Hence by the Yoneda Lemma \ref{lemma-yoneda} (via
Example \ref{example-fibred-category-from-functor-of-points} for example)
it is given by an isomorphism $X' \to X$.
\end{proof}

\begin{lemma}
\label{lemma-morphisms-representable-fibred-categories}
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$. Assume that $\mathcal{X}$, $\mathcal{Y}$
are representable by objects $X$, $Y$ of $\mathcal{C}$.
Then
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{X}, \mathcal{Y})
\Big/
2\text{-isomorphism}
=
\Mor_\mathcal{C}(X, Y)
$$
More precisely, given $\phi : X \to Y$ there exists a
$1$-morphism $f : \mathcal{X} \to \mathcal{Y}$ which induces
$\phi$ on isomorphism classes of objects and
which is unique up to unique $2$-isomorphism.
\end{lemma}

\begin{proof}
By
Example \ref{example-fibred-category-from-functor-of-points}
we have $\mathcal{C}/X = \mathcal{S}_{h_X}$ and
$\mathcal{C}/Y = \mathcal{S}_{h_Y}$. By
Lemma \ref{lemma-2-category-fibred-setoids}
we have
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{X}, \mathcal{Y})
\Big/
2\text{-isomorphism}
=
\Mor_{\textit{PSh}(\mathcal{C})}(h_X, h_Y)
$$
By the Yoneda
Lemma \ref{lemma-yoneda}
we have $\Mor_{\textit{PSh}(\mathcal{C})}(h_X, h_Y)
= \Mor_\mathcal{C}(X, Y)$.
\end{proof}







\section{Representable 1-morphisms}
\label{section-representable-1-morphisms}

\noindent
Let $\mathcal{C}$ be a category.
In this section we explain what it means for a $1$-morphism
between categories fibred in groupoids over $\mathcal{C}$
to be representable. Note that the $2$-category of categories
fibred in groupoids over $\mathcal{C}$ is a
``full'' sub $2$-category of the $2$-category of categories over
$\mathcal{C}$ (see
Definition \ref{definition-categories-fibred-in-groupoids-over-C}).
Hence if $\mathcal{S}$, $\mathcal{S}'$ are fibred in groupoids
over $\mathcal{C}$ then
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{S}, \mathcal{S}')
$$
denotes the category of $1$-morphisms in this $2$-category
(see Definition \ref{definition-categories-over-C}).
These are all groupoids, see remarks following
Definition \ref{definition-categories-fibred-in-groupoids-over-C}.
Here is the $2$-category analogue of the Yoneda lemma.

\begin{lemma}[2-Yoneda lemma]
\label{lemma-yoneda-2category}
Let $\mathcal{S}\to \mathcal{C}$ be fibred in groupoids.
Let $U \in \Ob(\mathcal{C})$.
The functor
$$
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{C}/U, \mathcal{S})
\longrightarrow
\mathcal{S}_U
$$
given by $G \mapsto G(\text{id}_U)$ is an equivalence.
\end{lemma}

\begin{proof}
Make a choice of pullbacks for $\mathcal{S}$
(see Definition \ref{definition-pullback-functor-fibred-category}).
We define a functor
$$
\mathcal{S}_U
\longrightarrow
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{C}/U, \mathcal{S})
$$
as follows. Given
$x \in \Ob(\mathcal{S}_U)$
the associated functor is
\begin{enumerate}
\item on objects: $(f : V \to U) \mapsto f^*x$, and
\item on morphisms: the arrow $(g : V'/U \to V/U)$ maps to
the composition
$$
(f \circ g)^*x \xrightarrow{(\alpha_{g, f})_x} g^*f^*x \rightarrow f^*x
$$
where $\alpha_{g, f}$ is as in Lemma \ref{lemma-fibred-groupoids}.
\end{enumerate}
We omit the verification that this is an inverse to the functor
of the lemma.
\end{proof}

\begin{remark}
\label{remark-alternative-fibred-groupoids-strict}
We can use the $2$-Yoneda lemma to give an alternative proof of
Lemma \ref{lemma-fibred-groupoids-strict}.
Let $p : \mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
We define a contravariant functor $F$ from $\mathcal{C}$ to the
category of groupoids as follows: for $U\in \Ob(\mathcal{C})$
let
$$
F(U) = \Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{C}/U, \mathcal{S}).
$$
If $f : U \to V$ the induced functor $\mathcal{C}/U \to \mathcal{C}/V$
induces the morphism $F(f) : F(V) \to F(U)$. Clearly $F$ is a functor.
Let $\mathcal{S}'$ be the associated category fibred in groupoids from
Example \ref{example-functor-groupoids}.
There is an obvious functor $G : \mathcal{S}' \to \mathcal{S}$
over $\mathcal{C}$ given by taking the pair $(U, x)$, where
$U \in \Ob(\mathcal{C})$ and $x \in F(U)$, to
$x(\text{id}_U) \in \mathcal{S}$.  Now
Lemma \ref{lemma-yoneda-2category}
implies that for each $U$,
$$
G_U : \mathcal{S}'_U = F(U)=
\Mor_{\textit{Cat}/\mathcal{C}}(\mathcal{C}/U, \mathcal{S})
\to
\mathcal{S}_U
$$
is an equivalence, and thus $G$ is an equivalence between $\mathcal{S}$ and
$\mathcal{S}'$ by Lemma \ref{lemma-equivalence-fibred-categories}.
\end{remark}

\noindent
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$.
Let $U \in \Ob(\mathcal{C})$.
Let $F : \mathcal{X} \to \mathcal{Y}$ and
$G : \mathcal{C}/U \to \mathcal{Y}$ be $1$-morphisms of categories
fibred in groupoids over $\mathcal{C}$.
We want to describe
the $2$-fibre product
$$
\xymatrix{
(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X} \ar[r] \ar[d] &
\mathcal{X} \ar[d]^F \\
\mathcal{C}/U \ar[r]^G &
\mathcal{Y}
}
$$
Let $y = G(\text{id}_U) \in \mathcal{Y}_U$.
Make a choice of pullbacks for $\mathcal{Y}$
(see Definition \ref{definition-pullback-functor-fibred-category}).
Then $G$ is isomorphic to the functor $(f : V \to U) \mapsto f^*y$,
see Lemma \ref{lemma-yoneda-2category} and its proof.
We may think of an object of
$(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X}$
as a quadruple $(V, f : V \to U, x, \phi)$, see
Lemma \ref{lemma-2-product-categories-over-C}.
Using the description of $G$ above we may think of $\phi$ as
an isomorphism $\phi : f^*y \to F(x)$ in $\mathcal{Y}_V$.

\begin{lemma}
\label{lemma-identify-fibre-product}
In the situation above the fibre category of
$(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X}$ over
an object $f : V \to U$ of $\mathcal{C}/U$
is the category described as follows:
\begin{enumerate}
\item objects are pairs $(x, \phi)$,
where $x \in \Ob(\mathcal{X}_V)$, and
$\phi : f^*y \to F(x)$ is a morphism in $\mathcal{Y}_V$,
\item the set of morphisms between $(x, \phi)$ and $(x', \phi')$
is the set of morphisms $\psi : x \to x'$ in $\mathcal{X}_V$
such that $F(\psi) = \phi' \circ \phi^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\begin{lemma}
\label{lemma-prepare-representable-map-stack-in-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$.
Let $F : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism.
Let $G : \mathcal{C}/U \to \mathcal{Y}$ be a $1$-morphism.
Then
$$
(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X}
\longrightarrow
\mathcal{C}/U
$$
is a category fibred in groupoids.
\end{lemma}

\begin{proof}
We have already seen in Lemma \ref{lemma-2-product-fibred-categories}
that the composition
$$
(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X}
\longrightarrow
\mathcal{C}/U
\longrightarrow
\mathcal{C}
$$
is a category fibred in groupoids. Then the lemma follows from
Lemma \ref{lemma-cute-groupoids}.
\end{proof}

\begin{definition}
\label{definition-representable-map-categories-fibred-in-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$.
Let $F : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism.
We say $F$ is {\it representable}, or that
{\it $\mathcal{X}$ is relatively representable over $\mathcal{Y}$},
if for every $U \in \Ob(\mathcal{C})$
and any $G : \mathcal{C}/U \to \mathcal{Y}$
the category fibred in groupoids
$$
(\mathcal{C}/U) \times_\mathcal{Y} \mathcal{X}
\longrightarrow
\mathcal{C}/U
$$
is representable.
\end{definition}

\begin{lemma}
\label{lemma-spell-out-representable-map-stack-in-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$.
Let $F : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism.
If $F$ is representable then every one of the functors
$$
F_U : \mathcal{X}_U \longrightarrow \mathcal{Y}_U
$$
between fibre categories is faithful.
\end{lemma}

\begin{proof}
Clear from the description of fibre categories in
Lemma \ref{lemma-identify-fibre-product} and the characterization
of representable fibred categories in
Lemma \ref{lemma-characterize-representable-fibred-category}.
\end{proof}

\begin{lemma}
\label{lemma-criterion-representable-map-stack-in-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{X}$, $\mathcal{Y}$ be categories fibred in groupoids
over $\mathcal{C}$.
Let $F : \mathcal{X} \to \mathcal{Y}$ be a $1$-morphism.
Make a choice of pullbacks for $\mathcal{Y}$.
Assume
\begin{enumerate}
\item each functor $F_U : \mathcal{X}_U \longrightarrow \mathcal{Y}_U$
between fibre categories is faithful, and
\item for each $U$ and each $y \in \mathcal{Y}_U$ the presheaf
$$
(f : V \to U)
\longmapsto
\{(x, \phi) \mid x \in \mathcal{X}_V, \phi : f^*y \to F(x)\}/\cong
$$
is a representable presheaf on $\mathcal{C}/U$.
\end{enumerate}
Then $F$ is representable.
\end{lemma}

\begin{proof}
Clear from the description of fibre categories in
Lemma \ref{lemma-identify-fibre-product} and the characterization
of representable fibred categories in
Lemma \ref{lemma-characterize-representable-fibred-category}.
\end{proof}

\noindent
Before we state the next lemma we point out that the $2$-category
of categories fibred in groupoids is a $(2, 1)$-category, and hence
we know what it means to say that it has a final object (see
Definition \ref{definition-final-object-2-category}). And it has
a final object namely $\text{id} : \mathcal{C} \to \mathcal{C}$.
Thus we define {\it $2$-products} of categories fibred in groupoids
over $\mathcal{C}$ as the $2$-fibred products
$$
\mathcal{X} \times \mathcal{Y} :=
\mathcal{X} \times_\mathcal{C} \mathcal{Y}.
$$
With this definition in place the following lemma makes sense.

\begin{lemma}
\label{lemma-representable-diagonal-groupoids}
Let $\mathcal{C}$ be a category.
Let $\mathcal{S} \to \mathcal{C}$ be a category fibred in groupoids.
Assume $\mathcal{C}$ has products of pairs of objects and fibre products.
The following are equivalent:
\begin{enumerate}
\item The diagonal $\mathcal{S} \to \mathcal{S} \times \mathcal{S}$
is representable.
\item For every $U$ in $\mathcal{C}$, any $G : \mathcal{C}/U \to \mathcal{S}$
is representable.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose the diagonal is representable, and let $U, G$ be given.
Consider any $V \in \Ob(\mathcal{C})$ and any
$G' : \mathcal{C}/V \to \mathcal{S}$.
Note that $\mathcal{C}/U \times \mathcal{C}/V = \mathcal{C}/U \times V$
is representable. Hence the fibre product
$$
\xymatrix{
(\mathcal{C}/U \times V)
\times_{(\mathcal{S} \times \mathcal{S})}
\mathcal{S}
\ar[r] \ar[d] &
\mathcal{S} \ar[d] \\
\mathcal{C}/U \times V \ar[r]^{(G, G')} &
\mathcal{S} \times \mathcal{S}
}
$$
is representable by assumption.
This means there exists $W \to U \times V$ in $\mathcal{C}$,
such that
$$
\xymatrix{
\mathcal{C}/W \ar[d] \ar[r] & \mathcal{S} \ar[d] \\
\mathcal{C}/U \times \mathcal{C}/V \ar[r] & \mathcal{S} \times \mathcal{S}
}
$$
is cartesian. This implies that
$\mathcal{C}/W \cong \mathcal{C}/U \times_\mathcal{S} \mathcal{C}/V$
(see Lemma \ref{lemma-diagonal-1})
as desired.

\medskip\noindent
Assume (2) holds. Consider any $V \in \Ob(\mathcal{C})$
and any $(G, G') : \mathcal{C}/V \to \mathcal{S} \times \mathcal{S}$.
We have to show that
$\mathcal{C}/V \times_{\mathcal{S} \times \mathcal{S}} \mathcal{S}$
is representable. What we know is that
$\mathcal{C}/V \times_{G, \mathcal{S}, G'} \mathcal{C}/V$
is representable, say by $a : W \to V$ in $\mathcal{C}/V$.
The equivalence
$$
\mathcal{C}/W \to \mathcal{C}/V \times_{G, \mathcal{S}, G'} \mathcal{C}/V
$$
followed by the second projection to $\mathcal{C}/V$ gives a
second morphism $a' : W \to V$. Consider
$W' = W \times_{(a, a'), V \times V} V$.
There exists an equivalence
$$
\mathcal{C}/W' \cong
\mathcal{C}/V \times_{\mathcal{S} \times \mathcal{S}} \mathcal{S}
$$
namely
\begin{eqnarray*}
\mathcal{C}/W' & \cong &
\mathcal{C}/W \times_{(\mathcal{C}/V \times \mathcal{C}/V)} \mathcal{C}/V \\
& \cong &
\left(\mathcal{C}/V \times_{(G, \mathcal{S}, G')} \mathcal{C}/V\right)
\times_{(\mathcal{C}/V \times \mathcal{C}/V)} \mathcal{C}/V \\
& \cong &
\mathcal{C}/V \times_{(\mathcal{S} \times \mathcal{S})} \mathcal{S}
\end{eqnarray*}
(for the last isomorphism see Lemma \ref{lemma-diagonal-2})
which proves the lemma.
\end{proof}

\noindent
{\bf Bibliographic notes:}
Parts of this have been taken from Vistoli's notes \cite{Vis2}.



\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\begin{multicols}{2}[\section{Other chapters}]
\noindent
Preliminaries
\begin{enumerate}
\item \hyperref[introduction-section-phantom]{Introduction}
\item \hyperref[conventions-section-phantom]{Conventions}
\item \hyperref[sets-section-phantom]{Set Theory}
\item \hyperref[categories-section-phantom]{Categories}
\item \hyperref[topology-section-phantom]{Topology}
\item \hyperref[sheaves-section-phantom]{Sheaves on Spaces}
\item \hyperref[sites-section-phantom]{Sites and Sheaves}
\item \hyperref[stacks-section-phantom]{Stacks}
\item \hyperref[fields-section-phantom]{Fields}
\item \hyperref[algebra-section-phantom]{Commutative Algebra}
\item \hyperref[brauer-section-phantom]{Brauer Groups}
\item \hyperref[homology-section-phantom]{Homological Algebra}
\item \hyperref[derived-section-phantom]{Derived Categories}
\item \hyperref[simplicial-section-phantom]{Simplicial Methods}
\item \hyperref[more-algebra-section-phantom]{More on Algebra}
\item \hyperref[smoothing-section-phantom]{Smoothing Ring Maps}
\item \hyperref[modules-section-phantom]{Sheaves of Modules}
\item \hyperref[sites-modules-section-phantom]{Modules on Sites}
\item \hyperref[injectives-section-phantom]{Injectives}
\item \hyperref[cohomology-section-phantom]{Cohomology of Sheaves}
\item \hyperref[sites-cohomology-section-phantom]{Cohomology on Sites}
\item \hyperref[dga-section-phantom]{Differential Graded Algebra}
\item \hyperref[dpa-section-phantom]{Divided Power Algebra}
\item \hyperref[hypercovering-section-phantom]{Hypercoverings}
\end{enumerate}
Schemes
\begin{enumerate}
\setcounter{enumi}{24}
\item \hyperref[schemes-section-phantom]{Schemes}
\item \hyperref[constructions-section-phantom]{Constructions of Schemes}
\item \hyperref[properties-section-phantom]{Properties of Schemes}
\item \hyperref[morphisms-section-phantom]{Morphisms of Schemes}
\item \hyperref[coherent-section-phantom]{Cohomology of Schemes}
\item \hyperref[divisors-section-phantom]{Divisors}
\item \hyperref[limits-section-phantom]{Limits of Schemes}
\item \hyperref[varieties-section-phantom]{Varieties}
\item \hyperref[topologies-section-phantom]{Topologies on Schemes}
\item \hyperref[descent-section-phantom]{Descent}
\item \hyperref[perfect-section-phantom]{Derived Categories of Schemes}
\item \hyperref[more-morphisms-section-phantom]{More on Morphisms}
\item \hyperref[flat-section-phantom]{More on Flatness}
\item \hyperref[groupoids-section-phantom]{Groupoid Schemes}
\item \hyperref[more-groupoids-section-phantom]{More on Groupoid Schemes}
\item \hyperref[etale-section-phantom]{\'Etale Morphisms of Schemes}
\end{enumerate}
Topics in Scheme Theory
\begin{enumerate}
\setcounter{enumi}{40}
\item \hyperref[chow-section-phantom]{Chow Homology}
\item \hyperref[intersection-section-phantom]{Intersection Theory}
\item \hyperref[pic-section-phantom]{Picard Schemes of Curves}
\item \hyperref[adequate-section-phantom]{Adequate Modules}
\item \hyperref[dualizing-section-phantom]{Dualizing Complexes}
\item \hyperref[curves-section-phantom]{Algebraic Curves}
\item \hyperref[resolve-section-phantom]{Resolution of Surfaces}
\item \hyperref[models-section-phantom]{Semistable Reduction}
\item \hyperref[pione-section-phantom]{Fundamental Groups of Schemes}
\item \hyperref[etale-cohomology-section-phantom]{\'Etale Cohomology}
\item \hyperref[crystalline-section-phantom]{Crystalline Cohomology}
\item \hyperref[proetale-section-phantom]{Pro-\'etale Cohomology}
\end{enumerate}
Algebraic Spaces
\begin{enumerate}
\setcounter{enumi}{52}
\item \hyperref[spaces-section-phantom]{Algebraic Spaces}
\item \hyperref[spaces-properties-section-phantom]{Properties of Algebraic Spaces}
\item \hyperref[spaces-morphisms-section-phantom]{Morphisms of Algebraic Spaces}
\item \hyperref[decent-spaces-section-phantom]{Decent Algebraic Spaces}
\item \hyperref[spaces-cohomology-section-phantom]{Cohomology of Algebraic Spaces}
\item \hyperref[spaces-limits-section-phantom]{Limits of Algebraic Spaces}
\item \hyperref[spaces-divisors-section-phantom]{Divisors on Algebraic Spaces}
\item \hyperref[spaces-over-fields-section-phantom]{Algebraic Spaces over Fields}
\item \hyperref[spaces-topologies-section-phantom]{Topologies on Algebraic Spaces}
\item \hyperref[spaces-descent-section-phantom]{Descent and Algebraic Spaces}
\item \hyperref[spaces-perfect-section-phantom]{Derived Categories of Spaces}
\item \hyperref[spaces-more-morphisms-section-phantom]{More on Morphisms of Spaces}
\item \hyperref[spaces-pushouts-section-phantom]{Pushouts of Algebraic Spaces}
\item \hyperref[spaces-flat-section-phantom]{Flatness on Algebraic Spaces}
\item \hyperref[spaces-groupoids-section-phantom]{Groupoids in Algebraic Spaces}
\item \hyperref[spaces-more-groupoids-section-phantom]{More on Groupoids in Spaces}
\item \hyperref[bootstrap-section-phantom]{Bootstrap}
\end{enumerate}
Topics in Geometry
\begin{enumerate}
\setcounter{enumi}{69}
\item \hyperref[groupoids-quotients-section-phantom]{Quotients of Groupoids}
\item \hyperref[spaces-simplicial-section-phantom]{Simplicial Spaces}
\item \hyperref[formal-spaces-section-phantom]{Formal Algebraic Spaces}
\item \hyperref[restricted-section-phantom]{Restricted Power Series}
\item \hyperref[spaces-resolve-section-phantom]{Resolution of Surfaces Revisited}
\end{enumerate}
Deformation Theory
\begin{enumerate}
\setcounter{enumi}{74}
\item \hyperref[formal-defos-section-phantom]{Formal Deformation Theory}
\item \hyperref[defos-section-phantom]{Deformation Theory}
\item \hyperref[cotangent-section-phantom]{The Cotangent Complex}
\end{enumerate}
Algebraic Stacks
\begin{enumerate}
\setcounter{enumi}{77}
\item \hyperref[algebraic-section-phantom]{Algebraic Stacks}
\item \hyperref[examples-stacks-section-phantom]{Examples of Stacks}
\item \hyperref[stacks-sheaves-section-phantom]{Sheaves on Algebraic Stacks}
\item \hyperref[criteria-section-phantom]{Criteria for Representability}
\item \hyperref[artin-section-phantom]{Artin's Axioms}
\item \hyperref[quot-section-phantom]{Quot and Hilbert Spaces}
\item \hyperref[stacks-properties-section-phantom]{Properties of Algebraic Stacks}
\item \hyperref[stacks-morphisms-section-phantom]{Morphisms of Algebraic Stacks}
\item \hyperref[stacks-limits-section-phantom]{Limits of Algebraic Stacks}
\item \hyperref[stacks-cohomology-section-phantom]{Cohomology of Algebraic Stacks}
\item \hyperref[stacks-perfect-section-phantom]{Derived Categories of Stacks}
\item \hyperref[stacks-introduction-section-phantom]{Introducing Algebraic Stacks}
\item \hyperref[stacks-more-morphisms-section-phantom]{More on Morphisms of Stacks}
\end{enumerate}
Miscellany
\begin{enumerate}
\setcounter{enumi}{90}
\item \hyperref[examples-section-phantom]{Examples}
\item \hyperref[exercises-section-phantom]{Exercises}
\item \hyperref[guide-section-phantom]{Guide to Literature}
\item \hyperref[desirables-section-phantom]{Desirables}
\item \hyperref[coding-section-phantom]{Coding Style}
\item \hyperref[obsolete-section-phantom]{Obsolete}
\item \hyperref[fdl-section-phantom]{GNU Free Documentation License}
\item \hyperref[index-section-phantom]{Auto Generated Index}
\end{enumerate}
\end{multicols}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Chow Homology and Chern Classes}

\maketitle

\phantomsection
\label{section-phantom}


\tableofcontents


\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Chow homology groups and the construction
of chern classes of vector bundles as elements of operational
Chow cohomology groups (everything with $\mathbf{Z}$-coefficients).

\medskip\noindent
In the first part of this chapter we work on determinants of finite
length modules, we define periodic complexes, their determinants,
and properties of these. All of this is done to give a direct proof
of the Key Lemma \ref{lemma-secondary-ramification}.
Presumably a more standard approach to this lemma would be to
use K-theory of local Noetherian rings.

\medskip\noindent
Next, we introduce the basic setup we work with in the rest of this
chapter in Section \ref{section-setup}. To make the material a little
bit more challenging we decided to treat a somewhat more general case
than is usually done. Namely we assume our schemes $X$ are locally of
finite type over a fixed locally Noetherian base scheme which is universally
catenary and is endowed with a dimension function. These assumption suffice
to be able to define the Chow homology groups $A_*(X)$ and the action of
capping with chern classes on them. This is an indication that we should
be able to define these also for algebraic stacks locally of finite type
over such a base.

\medskip\noindent
Next, we follow the first few chapters of \cite{F} in order to define
cycles, flat pullback, proper pushforward, and rational equivalence,
except that we have been less precise about the supports of the cycles
involved.

\medskip\noindent
We diverge from the presentation given in \cite{F} by using the
Key lemma mentioned above to prove a basic commutativity relation in
Section \ref{section-key}. Using this we prove that the operation
of intersecting with an invertible sheaf passes through rational
equivalence and is commutative, see Section \ref{section-commutativity}.
One more application of the Key
lemma proves that the Gysin map of an effective Cartier divisor
passes through rational equivalence, see Section \ref{section-gysin}.
Having proved this, it is straightforward to define chern
classes of vector bundles, prove additivity, prove the splitting principle,
introduce chern characters, Todd classes, and state the
Grothendieck-Riemann-Roch theorem.

\medskip\noindent
In the appendix we collect some hints to different approaches to this material.

\medskip\noindent
We will return to the Chow groups $A_*(X)$ for smooth projective varieties
over algebraically closed fields in the next chapter. Using a moving
lemma as in \cite{Samuel}, \cite{ChevalleyI}, and \cite{ChevalleyII}
and Serre's Tor-formula
(see \cite{Serre_local_algebra} or \cite{Serre_algebre_locale})
we will define a ring structure on $A_*(X)$. See
Intersection Theory, Section \ref{intersection-section-introduction} ff.



\section{Determinants of finite length modules}
\label{section-determinants-finite-length}

\noindent
The material in this section is related to the material in
the paper \cite{determinant} and to the material in the
thesis \cite{Joe}.

\medskip\noindent
Given any field $\kappa$ and any finite dimensional $\kappa$-vector space
$V$ we set $\det_\kappa(V) = \wedge^n(V)$ where $n = \dim_\kappa(V)$.
We will generalize this to finite length modules over local rings.
If the local ring contains a field, then the determinant constructed
below is a ``usual'' determinant, see
Remark \ref{remark-explain-determinant}.

\begin{definition}
\label{definition-determinant}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
Say $l = \text{length}_R(M)$.
\begin{enumerate}
\item Given elements $x_1, \ldots, x_r \in M$ we denote
$\langle x_1, \ldots, x_r \rangle = Rx_1 + \ldots + Rx_r$ the
$R$-submodule of $M$ generated by $x_1, \ldots, x_r$.
\item We will say an $l$-tuple of elements
$(e_1, \ldots, e_l)$ of $M$ is {\it admissible} if
$\mathfrak m e_i \in \langle e_1, \ldots, e_{i - 1} \rangle$
for $i = 1, \ldots, l$.
\item A {\it symbol} $[e_1, \ldots, e_l]$ will mean
$(e_1, \ldots, e_l)$ is an admissible $l$-tuple.
\item An {\it admissible relation} between symbols is one of the following:
\begin{enumerate}
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$[e_1, \ldots, e_l] = 0$,
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have $e_a = \lambda e'_a + x$
with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$$
[e_1, \ldots, e_l] =
\overline{\lambda} [e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
$$
where $\overline{\lambda} \in \kappa^*$ is the image of $\lambda$ in
the residue field, and
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$ then
$$
[e_1, \ldots, e_l] =
- [e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l].
$$
\end{enumerate}
\item
We define the {\it determinant of the finite length $R$-module $M$} to be
$$
\det\nolimits_\kappa(M) =
\left\{
\frac{\kappa\text{-vector space generated by symbols}}
{\kappa\text{-linear combinations of admissible relations}}
\right\}
$$
\end{enumerate}
\end{definition}

\noindent
We stress that always $l = \text{length}_R(M)$. We also stress that
it does not follow that the symbol $[e_1, \ldots, e_l]$ is
additive in the entries (this will typically not be the case).
Before we can show that the determinant $\det_\kappa(M)$ actually
has dimension $1$ we have to show that it has dimension at most $1$.

\begin{lemma}
\label{lemma-dimension-at-most-one}
With notations as above we have $\dim_\kappa(\det_\kappa(M)) \leq 1$.
\end{lemma}

\begin{proof}
Fix an admissible sequence $(f_1, \ldots, f_l)$ of $M$ such that
$$
\text{length}_R(\langle f_1, \ldots, f_i\rangle) = i
$$
for $i = 1, \ldots, l$. Such an admissible sequence exists exactly because
$M$ has length $l$. We will show that any element of
$\det_\kappa(M)$ is a $\kappa$-multiple of the symbol
$[f_1, \ldots, f_l]$. This will prove the lemma.

\medskip\noindent
Let $(e_1, \ldots, e_l)$ be an admissible sequence of $M$.
It suffices to show that $[e_1, \ldots, e_l]$ is a multiple
of $[f_1, \ldots, f_l]$. First assume that
$\langle e_1, \ldots, e_l\rangle \not = M$. Then there exists
an $i \in [1, \ldots, l]$ such that
$e_i \in \langle e_1, \ldots, e_{i - 1}\rangle$. It immediately
follows from the first admissible relation that
$[e_1, \ldots, e_n] = 0$ in $\det_\kappa(M)$.
Hence we may assume that $\langle e_1, \ldots, e_l\rangle = M$.
In particular there exists a smallest index $i \in \{1, \ldots, l\}$
such that $f_1 \in \langle e_1, \ldots, e_i\rangle$. This means
that $e_i = \lambda f_1 + x$ with
$x \in \langle e_1, \ldots, e_{i - 1}\rangle$ and $\lambda \in R^*$.
By the second admissible relation this means that
$[e_1, \ldots, e_l] =
\overline{\lambda}[e_1, \ldots, e_{i - 1}, f_1, e_{i + 1}, \ldots, e_l]$.
Note that $\mathfrak m f_1 = 0$. Hence by applying the third
admissible relation $i - 1$ times we see that
$$
[e_1, \ldots, e_l] =
(-1)^{i - 1}\overline{\lambda}
[f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l].
$$
Note that it is also the case that
$ \langle f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l\rangle = M$.
By induction suppose we have proven that our original
symbol is equal to a scalar times
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
$$
for some admissible sequence $(f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l)$
whose elements generate $M$, i.e., \ with
$\langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l\rangle = M$.
Then we find the smallest $i$ such that
$f_{j + 1} \in \langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_i\rangle$
and we go through the same process as above to see that
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
=
(\text{scalar}) [f_1, \ldots, f_j, f_{j + 1}, e_{j + 1},
\ldots, \hat{e_i}, \ldots, e_l]
$$
Continuing in this vein we obtain the desired result.
\end{proof}

\noindent
Before we show that $\det_\kappa(M)$ always has dimension $1$,
let us show that it agrees with the usual top exterior power in
the case the module is a vector space over $\kappa$.

\begin{lemma}
\label{lemma-compare-det}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module
which is annihilated by $\mathfrak m$. Let $l = \dim_\kappa(M)$.
Then the map
$$
\det\nolimits_\kappa(M) \longrightarrow \wedge^l_\kappa(M),
\quad
[e_1, \ldots, e_l] \longmapsto e_1 \wedge \ldots \wedge e_l
$$
is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the rule described in the lemma gives a $\kappa$-linear
map since all of the admissible relations are satisfied by the usual
symbols $e_1 \wedge \ldots \wedge e_l$. It is also clearly a surjective
map. Since by Lemma \ref{lemma-dimension-at-most-one} the left hand side
has dimension at most one
we see that the map is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-determinant-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
The determinant $\det_\kappa(M)$ defined above is a $\kappa$-vector
space of dimension $1$. It is generated by the symbol
$[f_1, \ldots, f_l]$ for any admissible sequence such
that $\langle f_1, \ldots f_l \rangle = M$.
\end{lemma}

\begin{proof}
We know $\det_\kappa(M)$ has dimension at most $1$, and in fact that it
is generated by $[f_1, \ldots, f_l]$, by
Lemma \ref{lemma-dimension-at-most-one} and its proof.
We will show by induction on $l = \text{length}(M)$
that it is nonzero. For $l = 1$ it follows from Lemma \ref{lemma-compare-det}.
Choose a nonzero element $f \in M$
with $\mathfrak m f = 0$. Set $\overline{M} = M /\langle f \rangle$,
and denote the quotient map $x \mapsto \overline{x}$.
We will define a surjective map
$$
\psi : \det\nolimits_k(M) \to \det\nolimits_\kappa(\overline{M})
$$
which will prove the lemma since by induction the determinant of
$\overline{M}$ is nonzero.

\medskip\noindent
We define $\psi$ on symbols as follows.
Let $(e_1, \ldots, e_l)$ be an admissible sequence.
If $f \not \in \langle e_1, \ldots, e_l \rangle$ then
we simply set $\psi([e_1, \ldots, e_l]) = 0$.
If $f \in \langle e_1, \ldots, e_l \rangle$ then we choose
an $i$ minimal such that $f \in \langle e_1, \ldots, e_i \rangle$.
We may write $e_i = \lambda f + x$ for some unit $\lambda \in R$
and $x \in \langle e_1, \ldots, e_{i - 1} \rangle$.
In this case we set
$$
\psi([e_1, \ldots, e_l]) =
(-1)^i
\overline{\lambda}[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l].
$$
Note that it is indeed the case that
$(\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l)$
is an admissible sequence in $\overline{M}$, so this makes sense.
Let us show that extending this rule $\kappa$-linearly to
linear combinations of symbols does indeed lead to a map on
determinants. To do this we have to show that the admissible
relations are mapped to zero.

\medskip\noindent
Type (a) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Then $i \not = a$ and
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\hat{\overline{e}_i}, \ldots, \overline{e}_{a - 1}\rangle$ if $i < a$
or
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\overline{e}_{a - 1}\rangle$ if $i > a$.
Thus the same admissible relation for $\det_\kappa(\overline{M})$ forces
the symbol $[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]$
to be zero as desired.

\medskip\noindent
Type (b) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a = \lambda e'_a + x$ with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \mu f + y$ with $y \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
If $i > a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
The interesting case is when $i = a$. In this case we have
$e_a = \lambda e'_a + x = \mu f + y$. Hence also
$e'_a = \lambda^{-1}(\mu f + y - x)$. Thus we see that
$$
\psi([e_1, \ldots, e_l])
= (-1)^i \overline{\mu}
[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]
=
\psi(
\overline{\lambda}
[e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
)
$$
as desired.

\medskip\noindent
Type (c) relations. Suppose that $(e_1, \ldots, e_l)$
is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \lambda f + x$ with $x \in \langle e_1, \ldots, e_{i - 1}\rangle$.
We distinguish $4$ cases:

\medskip\noindent
Case 1: $i < a - 1$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 2: $i > a$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 3: $i = a$. We write $e_a = \lambda f + \mu e_{a - 1} + y$
with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$. Then
$$
\psi([e_1, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. If $\overline{\mu}$ is nonzero, then we have
$e_{a - 1} = - \mu^{-1} \lambda f + \mu^{-1}e_a - \mu^{-1} y$
and we obtain
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\mu^{-1}\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. Since in $\overline{M}$ we have
$\overline{e}_a = \mu \overline{e}_{a - 1} + \overline{y}$ we see
the two outcomes are equal by relation (a) for $\det_\kappa(\overline{M})$.
If on the other hand $\overline{\mu}$ is zero, then we can write
$e_a = \lambda f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
and we have
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is equal to $\psi([e_1, \ldots, e_l])$.

\medskip\noindent
Case 4: $i = a - 1$. Here we have
$$
\psi([e_1, \ldots, e_l]) =
(-1)^{a - 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
by definition. If $f \not \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$
then
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^{a + 1}\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
Since $(-1)^{a - 1} = (-1)^{a + 1}$ the two expressions are the same.
Finally, assume $f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$.
In this case we see that $e_{a - 1} = \lambda f + x$ with
$x \in \langle e_1, \ldots, e_{a - 2}\rangle$ and
$e_a = \mu f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
for units $\lambda, \mu \in R$.
We conclude that both
$e_a \in \langle e_1, \ldots, e_{a - 1} \rangle$ and
$e_{a - 1} \in \langle e_1, \ldots, e_{a - 2}, e_a\rangle$.
In this case a relation of type (a) applies to both
$[e_1, \ldots, e_l]$ and
$[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]$
and the compatibility of $\psi$ with these shown above to see that both
$$
\psi([e_1, \ldots, e_l])
\quad\text{and}\quad
\psi([e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l])
$$
are zero, as desired.

\medskip\noindent
At this point we have shown that $\psi$ is well defined, and all that remains
is to show that it is surjective. To see this let
$(\overline{f}_2, \ldots, \overline{f}_l)$ be an admissible sequence
in $\overline{M}$. We can choose lifts $f_2, \ldots, f_l \in M$, and
then $(f, f_2, \ldots, f_l)$ is an admissible sequence in $M$.
Since $\psi([f, f_2, \ldots, f_l]) = [f_2, \ldots, f_l]$ we win.
\end{proof}

\noindent
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Note that if $\varphi : M \to N$ is an
isomorphism of finite length $R$-modules, then we get an
isomorphism
$$
\det\nolimits_\kappa(\varphi) :
\det\nolimits_\kappa(M)
\to
\det\nolimits_\kappa(N)
$$
simply by the rule
$$
\det\nolimits_\kappa(\varphi)([e_1, \ldots, e_l])
=
[\varphi(e_1), \ldots, \varphi(e_l)]
$$
for any symbol $[e_1, \ldots, e_l]$ for $M$.
Hence we see that $\det\nolimits_\kappa$ is a functor
\begin{equation}
\label{equation-functor}
\left\{
\begin{matrix}
\text{finite length }R\text{-modules}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\end{equation}
This is typical for a ``determinant functor''
(see \cite{Knudsen}), as is the following additivity
property.

\begin{lemma}
\label{lemma-det-exact-sequences}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For every short exact sequence
$$
0 \to K \to L \to M \to 0
$$
of finite length $R$-modules there exists a canonical isomorphism
$$
\gamma_{K \to L \to M} :
\det\nolimits_\kappa(K) \otimes_\kappa \det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(L)
$$
defined by the rule on nonzero symbols
$$
[e_1, \ldots, e_k]
\otimes
[\overline{f}_1, \ldots, \overline{f}_m]
\longrightarrow
[e_1, \ldots, e_k, f_1, \ldots, f_m]
$$
with the following properties:
\begin{enumerate}
\item For every isomorphism of short exact sequences, i.e., for
every commutative diagram
$$
\xymatrix{
0 \ar[r] &
K \ar[r] \ar[d]^u &
L \ar[r] \ar[d]^v &
M \ar[r] \ar[d]^w &
0 \\
0 \ar[r] &
K' \ar[r] &
L' \ar[r] &
M' \ar[r] &
0
}
$$
with short exact rows and isomorphisms $u, v, w$ we have
$$
\gamma_{K' \to L' \to M'} \circ
(\det\nolimits_\kappa(u) \otimes \det\nolimits_\kappa(w))
=
\det\nolimits_\kappa(v) \circ
\gamma_{K \to L \to M},
$$
\item for every commutative square of finite length $R$-modules
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] & A \ar[r] \ar[d] & B \ar[r] \ar[d] & C \ar[r] \ar[d] & 0 \\
0 \ar[r] & D \ar[r] \ar[d] & E \ar[r] \ar[d] & F \ar[r] \ar[d] & 0 \\
0 \ar[r] & G \ar[r] \ar[d] & H \ar[r] \ar[d] & I \ar[r] \ar[d] & 0 \\
& 0  & 0  & 0  &
}
$$
the following diagram is commutative
$$
\xymatrix{
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(I)
\ar[dd]_{\epsilon}
\ar[rrr]_-{\gamma_{A \to B \to C} \otimes \gamma_{G \to H \to I}}
& & &
\det\nolimits_\kappa(B) \otimes
\det\nolimits_\kappa(H)
\ar[d]^{\gamma_{B \to E \to H}}
\\
& & & \det\nolimits_\kappa(E)
\\
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(I)
\ar[rrr]^-{\gamma_{A \to D \to G} \otimes \gamma_{C \to F \to I}}
& & &
\det\nolimits_\kappa(D) \otimes
\det\nolimits_\kappa(F)
\ar[u]_{\gamma_{D \to E \to F}}
}
$$
where $\epsilon$ is the switch of the factors in the tensor product
times $(-1)^{cg}$ with $c = \text{length}_R(C)$ and $g = \text{length}_R(G)$,
and
\item the map $\gamma_{K \to L \to M}$ agrees with the usual isomorphism
if $0 \to K \to L \to M \to 0$ is actually a short exact sequence
of $\kappa$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
The significance of taking nonzero symbols in the explicit description
of the map $\gamma_{K \to L \to M}$ is simply that if $(e_1, \ldots, e_l)$
is an admissible sequence in $K$, and
$(\overline{f}_1, \ldots, \overline{f}_m)$ is an admissible sequence in
$M$, then it is not guaranteed that $(e_1, \ldots, e_l, f_1, \ldots, f_m)$
is an admissible sequence in $L$ (where of course $f_i \in L$ signifies
a lift of $\overline{f}_i$). However, if the symbol
$[e_1, \ldots, e_l]$ is nonzero in $\det_\kappa(K)$, then
necessarily $K = \langle e_1, \ldots, e_k\rangle$ (see
proof of Lemma \ref{lemma-dimension-at-most-one}), and
in this case it is true that $(e_1, \ldots, e_k, f_1, \ldots, f_m)$
is an admissible sequence.
Moreover, by the admissible relations of type (b) for $\det_\kappa(L)$
we see that the value of $[e_1, \ldots, e_k, f_1, \ldots, f_m]$ in
$\det_\kappa(L)$ is independent of the choice of the lifts
$f_i$ in this case also. Given this remark, it is clear
that an admissible relation for $e_1, \ldots, e_k$ in $K$
translates into an admissible relation among
$e_1, \ldots, e_k, f_1, \ldots, f_m$ in $L$, and
similarly for an admissible relation among the
$\overline{f}_1, \ldots, \overline{f}_m$.
Thus $\gamma$ defines a linear map of vector spaces as claimed in the lemma.

\medskip\noindent
By Lemma \ref{lemma-determinant-dimension-one} we know
$\det_\kappa(L)$ is generated by any single
symbol $[x_1, \ldots, x_{k + m}]$ such that
$(x_1, \ldots, x_{k + m})$ is an admissible sequence
with $L = \langle x_1, \ldots, x_{k + m}\rangle$. Hence it is
clear that the map $\gamma_{K \to L \to M}$ is surjective and
hence an isomorphism.

\medskip\noindent
Property (1) holds because
\begin{eqnarray*}
& & \det\nolimits_\kappa(v)([e_1, \ldots, e_k, f_1, \ldots, f_m]) \\
& = &
[v(e_1), \ldots, v(e_k), v(f_1), \ldots, v(f_m)] \\
& = &
\gamma_{K' \to L' \to M'}([u(e_1), \ldots, u(e_k)]
\otimes [w(f_1), \ldots, w(f_m)]).
\end{eqnarray*}
Property (2) means that given a symbol
$[\alpha_1, \ldots, \alpha_a]$ generating $\det_\kappa(A)$,
a symbol $[\gamma_1, \ldots, \gamma_c]$ generating $\det_\kappa(C)$,
a symbol $[\zeta_1, \ldots, \zeta_g]$ generating $\det_\kappa(G)$, and
a symbol $[\iota_1, \ldots, \iota_i]$ generating $\det_\kappa(I)$
we have
\begin{eqnarray*}
& & [\alpha_1, \ldots, \alpha_a, \tilde\gamma_1, \ldots, \tilde\gamma_c,
\tilde\zeta_1, \ldots, \tilde\zeta_g, \tilde\iota_1, \ldots, \tilde\iota_i] \\
& = &
(-1)^{cg} [\alpha_1, \ldots, \alpha_a, \tilde\zeta_1, \ldots, \tilde\zeta_g,
\tilde\gamma_1, \ldots, \tilde\gamma_c, \tilde\iota_1, \ldots, \tilde\iota_i]
\end{eqnarray*}
(for suitable lifts $\tilde{x}$ in $E$) in $\det_\kappa(E)$.
This holds because we may use the admissible relations of type (c)
$cg$ times in the following order: move the
$\tilde\zeta_1$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_1 \subset A$),
then move $\tilde\zeta_2$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_2 \subset A + R\tilde\zeta_1$),
and so on.

\medskip\noindent
Part (3) of the lemma is obvious.
This finishes the proof.
\end{proof}

\noindent
We can use the maps $\gamma$ of the lemma to define more general maps
$\gamma$ as follows. Suppose that $(R, \mathfrak m, \kappa)$ is a
local ring. Let $M$ be a finite length $R$-module and suppose we
are given a finite filtration (see
Homology, Definition \ref{homology-definition-filtered})
$$
M = F^n \supset F^{n + 1} \supset \ldots \supset F^{m - 1} \supset F^m = 0.
$$
Then there is a canonical isomorphism
$$
\gamma_{(M, F)} :
\bigotimes\nolimits_i \det\nolimits_\kappa(F^i/F^{i + 1})
\longrightarrow
\det\nolimits_\kappa(M)
$$
well defined up to sign(!). One can make the sign explicit either by
giving a well defined order of the terms in the tensor product (starting with
higher indices unfortunately), and by thinking of the target category for
the functor $\det_\kappa$ as the category of
$1$-dimensional super vector spaces. See \cite[Section 1]{determinant}.

\medskip\noindent
Here is another typical result for determinant functors.
It is not hard to show. The tricky part is usually to show the
existence of a determinant functor.

\begin{lemma}
\label{lemma-uniqueness-det}
Let $(R, \mathfrak m, \kappa)$ be any local ring.
The functor
$$
\det\nolimits_\kappa :
\left\{
\begin{matrix}
\text{finite length }R\text{-modules} \\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces} \\
\text{with isomorphisms}
\end{matrix}
\right\}
$$
endowed with the maps $\gamma_{K \to L \to M}$ is characterized by
the following properties
\begin{enumerate}
\item its restriction to the subcategory of modules annihilated
by $\mathfrak m$ is isomorphic to the usual determinant functor
(see Lemma \ref{lemma-compare-det}), and
\item (1), (2) and (3) of Lemma \ref{lemma-det-exact-sequences}
hold.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-determinant-quotient-ring}
Let $(R', \mathfrak m') \to (R, \mathfrak m)$ be a local ring
homomorphism which induces an isomorphism on residue fields $\kappa$.
Then for every finite length $R$-module the restriction $M_{R'}$
is a finite length $R'$-module and there is a canonical isomorphism
$$
\det\nolimits_{R, \kappa}(M)
\longrightarrow
\det\nolimits_{R', \kappa}(M_{R'})
$$
This isomorphism is functorial in $M$ and compatible with the
isomorphisms $\gamma_{K \to L \to M}$ of Lemma \ref{lemma-det-exact-sequences}
defined for $\det_{R, \kappa}$ and $\det_{R', \kappa}$.
\end{lemma}

\begin{proof}
If the length of $M$ as an $R$-module is $l$, then the length
of $M$ as an $R'$-module (i.e., $M_{R'}$) is $l$ as well, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
Note that an admissible sequence $x_1, \ldots, x_l$ of $M$
over $R$ is an admissible sequence of $M$ over $R'$ as $\mathfrak m'$
maps into $\mathfrak m$.
The isomorphism is obtained by mapping the symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R, \kappa}(M)$
to the corresponding symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R', \kappa}(M)$.
It is immediate to verify that this is functorial for
isomorphisms and compatible with the isomorphisms
$\gamma$ of Lemma \ref{lemma-det-exact-sequences}.
\end{proof}

\begin{remark}
\label{remark-explain-determinant}
Let $(R, \mathfrak m, \kappa)$ be a local ring and assume either
the characteristic of $\kappa$ is zero or it is $p$ and $p R = 0$.
Let $M_1, \ldots, M_n$ be finite length $R$-modules.
We will show below that there exists an
ideal $I \subset \mathfrak m$ annihilating $M_i$ for $i = 1, \ldots, n$
and a section $\sigma : \kappa \to R/I$ of the canonical surjection
$R/I \to \kappa$. The restriction $M_{i, \kappa}$ of $M_i$ via $\sigma$
is a $\kappa$-vector space of dimension $l_i = \text{length}_R(M_i)$ and
using Lemma \ref{lemma-determinant-quotient-ring} we see that
$$
\det\nolimits_\kappa(M_i) = \wedge_\kappa^{l_i}(M_{i, \kappa})
$$
These isomorphisms are compatible with the isomorphisms
$\gamma_{K \to M \to L}$ of Lemma \ref{lemma-det-exact-sequences}
for short exact sequences of finite length $R$-modules annihilated
by $I$. The conclusion is that verifying a property of
$\det_\kappa$ often reduces to verifying corresponding properties
of the usual determinant on the category finite dimensional vector
spaces.

\medskip\noindent
For $I$ we can take the annihilator
(Algebra, Definition \ref{algebra-definition-annihilator})
of the module $M = \bigoplus M_i$. In this case we see that
$R/I \subset \text{End}_R(M)$ hence has finite length.
Thus $R/I$ is an Artinian local ring with residue field $\kappa$.
Since an Artinian local ring is complete we see that $R/I$
has a coefficient ring by the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem})
which is a field by our assumption on $R$.
\end{remark}

\noindent
Here is a case where we can compute the determinant of a linear map.
In fact there is nothing mysterious about this in any case, see
Example \ref{example-determinant-map} for a random example.

\begin{lemma}
\label{lemma-times-u-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $u \in R^*$ be a unit.
Let $M$ be a module of finite length over $R$.
Denote $u_M : M \to M$ the map multiplication by $u$.
Then
$$
\det\nolimits_\kappa(u_M) :
\det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is multiplication by $\overline{u}^l$ where $l = \text{length}_R(M)$
and $\overline{u} \in \kappa^*$ is the image of $u$.
\end{lemma}

\begin{proof}
Denote $f_M \in \kappa^*$ the element such that
$\det\nolimits_\kappa(u_M) = f_M \text{id}_{\det\nolimits_\kappa(M)}$.
Suppose that $0 \to K \to L \to M \to 0$ is a short
exact sequence of finite $R$-modules. Then we see that
$u_k$, $u_L$, $u_M$ give an isomorphism of short exact sequences.
Hence by Lemma \ref{lemma-det-exact-sequences} (1) we conclude that
$f_K f_M = f_L$.
This means that by induction on length it suffices to prove the
lemma in the case of length $1$ where it is trivial.
\end{proof}

\begin{example}
\label{example-determinant-map}
Consider the local ring $R = \mathbf{Z}_p$.
Set $M = \mathbf{Z}_p/(p^2) \oplus \mathbf{Z}_p/(p^3)$.
Let $u : M \to M$ be the map given by the matrix
$$
u =
\left(
\begin{matrix}
a & b \\
pc & d
\end{matrix}
\right)
$$
where $a, b, c, d \in \mathbf{Z}_p$, and $a, d \in \mathbf{Z}_p^*$.
In this case $\det_\kappa(u)$ equals multiplication by
$a^2d^3 \bmod p \in \mathbf{F}_p^*$. This can easily be seen
by consider the effect of $u$ on the symbol
$[p^2e, pe, pf, e, f]$ where $e = (0 , 1) \in M$ and
$f = (1, 0) \in M$.
\end{example}








\section{Periodic complexes and Herbrand quotients}
\label{section-periodic-complexes}

\noindent
Of course there is a very general notion of periodic complexes.
We can require periodicity of the maps, or periodicity of the objects.
We will add these here as needed. For the moment we only need
the following cases.

\begin{definition}
\label{definition-periodic-complex}
Let $R$ be a ring.
\begin{enumerate}
\item A {\it $2$-periodic complex} over $R$ is given
by a quadruple $(M, N, \varphi, \psi)$ consisting of
$R$-modules $M$, $N$ and $R$-module maps $\varphi : M \to N$,
$\psi : N \to M$ such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
N \ar[r]^\psi &
M \ar[r]^\varphi &
N \ar[r] & \ldots
}
$$
is a complex. In this setting we define the {\it cohomology modules}
of the complex to be the $R$-modules
$$
H^0(M, N, \varphi, \psi) = \Ker(\varphi)/\Im(\psi)
, \quad\text{and}\quad
H^1(M, N, \varphi, \psi) = \Ker(\psi)/\Im(\varphi).
$$
We say the $2$-periodic complex is {\it exact} if the cohomology
groups are zero.
\item A {\it $(2, 1)$-periodic complex} over $R$ is given
by a triple $(M, \varphi, \psi)$ consisting of an $R$-module $M$ and
$R$-module maps $\varphi : M \to M$, $\psi : M \to M$
such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
M \ar[r]^\psi &
M \ar[r]^\varphi &
M \ar[r] & \ldots
}
$$
is a complex. Since this is a special case of a $2$-periodic complex
we have its {\it cohomology modules} $H^0(M, \varphi, \psi)$,
$H^1(M, \varphi, \psi)$ and a notion of exactness.
\end{enumerate}
\end{definition}

\noindent
In the following we will use any result proved for $2$-periodic
complexes without further mention for $(2, 1)$-periodic complexes.
It is clear that the collection of $2$-periodic complexes
(resp.\ $(2, 1)$-periodic complexes) forms a category with morphisms
$(f, g) : (M, N, \varphi, \psi) \to (M', N', \varphi', \psi')$
pairs of morphisms $f : M \to M'$ and $g : N \to N'$ such
that $\varphi' \circ f = f \circ \varphi$ and $\psi' \circ g = g \circ \psi$.
In fact it is an abelian category, with kernels and cokernels as in
Homology, Lemma \ref{homology-lemma-cat-chain-abelian}.
Also, note that a special case are the
$(2, 1)$-periodic complexes of the form $(M, 0, \psi)$. In this
special case we have
$$
H^0(M, 0, \psi) = \Coker(\psi)
, \quad\text{and}\quad
H^1(M, 0, \psi) = \Ker(\psi).
$$

\begin{definition}
\label{definition-periodic-length}
Let $R$ be a local ring.
Let $(M, N, \varphi, \psi)$ be a $2$-periodic complex over $R$
whose cohomology groups have finite length over $R$.
In this case we define the {\it multiplicity} of $(M, N, \varphi, \psi)$
to be the integer
$$
e_R(M, N, \varphi, \psi) =
\text{length}_R(H^0(M, N, \varphi, \psi))
-
\text{length}_R(H^1(M, N, \varphi, \psi))
$$
We will sometimes (especially in the case of a $(2, 1)$-periodic complex with
$\varphi = 0$) call this the {\it Herbrand quotient}\footnote{If the residue
field of $R$ is finite with $q$ elements
it is customary to call the Herbrand quotient
$h(M, N, \varphi, \psi) = q^{e_R(M, N, \varphi, \psi)}$ which is equal to
the number of elements of $H^0$ divided by the number of elements of
$H^1$.}.
\end{definition}

\begin{lemma}
\label{lemma-periodic-length}
Let $R$ be a local ring.
\begin{enumerate}
\item If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length. Then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
\item If $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length. Then
$e_R(M, \varphi, \psi) = 0$.
\item Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (3). Abbreviate $A = (M_1, N_1, \varphi_1, \psi_1)$,
$B = (M_2, N_2, \varphi_2, \psi_2)$ and $C = (M_3, N_3, \varphi_3, \psi_3)$.
We have a long exact cohomology sequence
$$
\ldots
\to H^1(C)
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to H^1(C)
\to \ldots
$$
This gives a finite exact sequence
$$
0 \to I
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to K \to 0
$$
with $0 \to K \to H^1(C) \to I \to 0$ a filtration. By additivity of
the length function (Algebra, Lemma \ref{algebra-lemma-length-additive})
we see the result.
The proofs of (1) and (2) are omitted.
\end{proof}





\section{Periodic complexes and determinants}
\label{section-periodic-complexes-determinants}

\noindent
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. We are going to use the determinant construction to define
an invariant of this situation. See
Section \ref{section-determinants-finite-length}.
Let us abbreviate
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
The short exact sequences
$$
0 \to K_\varphi \to M \to I_\varphi \to 0, \quad
0 \to K_\psi \to M \to I_\psi \to 0
$$
give isomorphisms
$$
\gamma_\varphi :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M), \quad
\gamma_\psi :
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
\longrightarrow
\det\nolimits_\kappa(M),
$$
see Lemma \ref{lemma-det-exact-sequences}.
On the other hand the exactness of the complex gives equalities
$K_\varphi = I_\psi$, and $K_\psi = I_\varphi$
and hence an isomorphism
$$
\sigma :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
$$
by switching the factors. Using this notation we can define our invariant.

\begin{definition}
\label{definition-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. The {\it determinant of $(M, \varphi, \psi)$} is
the element
$$
\det\nolimits_\kappa(M, \varphi, \psi) \in \kappa^*
$$
such that the composition
$$
\det\nolimits_\kappa(M)
\xrightarrow{\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}}
\det\nolimits_\kappa(M)
$$
is multiplication by
$(-1)^{\text{length}_R(I_\varphi)\text{length}_R(I_\psi)}
\det\nolimits_\kappa(M, \varphi, \psi)$.
\end{definition}

\begin{remark}
\label{remark-more-elementary}
Here is a more down to earth description of the determinant
introduced above. Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Let us abbreviate $I_\varphi = \Im(\varphi)$,
$I_\psi = \Im(\psi)$ as above.
Assume that $\text{length}_R(I_\varphi) = a$ and
$\text{length}_R(I_\psi) = b$, so that $a + b = \text{length}_R(M)$
by exactness. Choose admissible sequences
$x_1, \ldots, x_a \in I_\varphi$ and $y_1, \ldots, y_b \in I_\psi$
such that the symbol $[x_1, \ldots, x_a]$ generates $\det_\kappa(I_\varphi)$
and the symbol $[x_1, \ldots, x_b]$ generates $\det_\kappa(I_\psi)$.
Choose $\tilde x_i \in M$ such that $\varphi(\tilde x_i) = x_i$.
Choose $\tilde y_j \in M$ such that $\psi(\tilde y_j) = y_j$.
Then $\det_\kappa(M, \varphi, \psi)$ is characterized
by the equality
$$
[x_1, \ldots, x_a, \tilde y_1, \ldots, \tilde y_b]
=
(-1)^{ab} \det\nolimits_\kappa(M, \varphi, \psi)
[y_1, \ldots, y_b, \tilde x_1, \ldots, \tilde x_a]
$$
in $\det_\kappa(M)$. This also explains the sign.
\end{remark}

\begin{lemma}
\label{lemma-periodic-determinant-shift}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
\det\nolimits_\kappa(M, \psi, \varphi)
= 1.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-sign}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \varphi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \varphi)$ is
exact. Then $\text{length}_R(M) = 2 \text{length}_R(\Im(\varphi))$
and
$$
\det\nolimits_\kappa(M, \varphi, \varphi)
=
(-1)^{\text{length}_R(\Im(\varphi))}
=
(-1)^{\frac{1}{2}\text{length}_R(M)}
$$
\end{lemma}

\begin{proof}
Follows directly from the sign rule in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-easy-case}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
\begin{enumerate}
\item if $\varphi : M \to M$ is an isomorphism then
$\det_\kappa(M, \varphi, 0) = \det_\kappa(\varphi)$.
\item if $\psi : M \to M$ is an isomorphism then
$\det_\kappa(M, 0, \psi) = \det_\kappa(\psi)^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (1). Set $\psi = 0$. Then we may, with notation
as above Definition \ref{definition-periodic-determinant}, identify
$K_\varphi = I_\psi = 0$, $I_\varphi = K_\psi = M$.
With these identifications, the map
$$
\gamma_\varphi :
\kappa \otimes \det\nolimits_\kappa(M)
=
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is identified with $\det_\kappa(\varphi^{-1})$. On the other hand the
map $\gamma_\psi$ is identified with the identity map. Hence
$\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$ is equal
to $\det_\kappa(\varphi)$ in this case. Whence the result.
We omit the proof of (2).
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, \varphi_1, \psi_1)
\to (M_2, \varphi_2, \psi_2)
\to (M_3, \varphi_3, \psi_3)
\to 0
$$
with all $M_i$ of finite length, and each $(M_1, \varphi_1, \psi_1)$ exact.
Then
$$
\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3).
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
Let us abbreviate
$I_{\varphi, i} = \Im(\varphi_i)$,
$K_{\varphi, i} = \Ker(\varphi_i)$,
$I_{\psi, i} = \Im(\psi_i)$, and
$K_{\psi, i} = \Ker(\psi_i)$.
Observe that we have a commutative square
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] &
K_{\varphi, 1} \ar[r] \ar[d] &
K_{\varphi, 2} \ar[r] \ar[d] &
K_{\varphi, 3} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] \ar[d] &
M_2 \ar[r] \ar[d] &
M_3 \ar[r] \ar[d] &
0 \\
0 \ar[r] &
I_{\varphi, 1} \ar[r] \ar[d] &
I_{\varphi, 2} \ar[r] \ar[d] &
I_{\varphi, 3} \ar[r] \ar[d] &
0 \\
& 0  & 0  & 0  &
}
$$
of finite length $R$-modules with exact rows and columns.
The top row is exact since it can be identified with the
sequence $I_{\psi, 1} \to I_{\psi, 2} \to I_{\psi, 3} \to 0$
of images, and similarly for the bottom row. There is a similar diagram
involving the modules $I_{\psi, i}$ and $K_{\psi, i}$.
By definition $\det_\kappa(M_2, \varphi_2, \psi_2)$
corresponds, up to a sign, to the composition of the left vertical maps
in the following diagram
$$
\xymatrix{
\det_\kappa(M_1) \otimes
\det_\kappa(M_3) \ar[r]^\gamma
\ar[d]^{\gamma^{-1} \otimes \gamma^{-1}} &
\det_\kappa(M_2)
\ar[d]^{\gamma^{-1}} \\
\det\nolimits_\kappa(K_{\varphi, 1})
\otimes
\det\nolimits_\kappa(I_{\varphi, 1})
\otimes
\det\nolimits_\kappa(K_{\varphi, 3})
\otimes
\det\nolimits_\kappa(I_{\varphi, 3})
\ar[d]^{\sigma \otimes \sigma}
\ar[r]^-{\gamma \otimes \gamma} &
\det\nolimits_\kappa(K_{\varphi, 2})
\otimes
\det\nolimits_\kappa(I_{\varphi, 2})
\ar[d]^\sigma
\\
\det\nolimits_\kappa(K_{\psi, 1})
\otimes
\det\nolimits_\kappa(I_{\psi, 1})
\otimes
\det\nolimits_\kappa(K_{\psi, 3})
\otimes
\det\nolimits_\kappa(I_{\psi, 3})
\ar[d]^{\gamma \otimes \gamma}
\ar[r]^-{\gamma \otimes \gamma}
&
\det\nolimits_\kappa(K_{\psi, 2})
\otimes
\det\nolimits_\kappa(I_{\psi, 2})
\ar[d]^\gamma \\
\det_\kappa(M_1)
\otimes
\det_\kappa(M_3) \ar[r]^\gamma
&
\det_\kappa(M_2)
}
$$
The top and bottom squares are commutative up to sign
by applying Lemma \ref{lemma-det-exact-sequences} (2).
The middle square is trivially
commutative (we are just switching factors). Hence we see
that
$\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\epsilon \det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3)
$
for some sign $\epsilon$. And the sign can be worked out, namely
the outer rectangle in the diagram above commutes up to
\begin{eqnarray*}
\epsilon & = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(K_{\varphi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(K_{\psi, 3})} \\
& = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(I_{\psi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(I_{\varphi, 3})}
\end{eqnarray*}
(proof omitted). It follows easily from this that the signs
work out as well.
\end{proof}

\begin{example}
\label{example-dual-numbers}
Let $k$ be a field.
Consider the ring $R = k[T]/(T^2)$ of dual numbers over $k$.
Denote $t$ the class of $T$ in $R$.
Let $M = R$ and $\varphi = ut$, $\psi = vt$ with $u, v \in k^*$.
In this case $\det_k(M)$ has generator $e = [t, 1]$.
We identify $I_\varphi = K_\varphi = I_\psi = K_\psi = (t)$.
Then $\gamma_\varphi(t \otimes t) = u^{-1}[t, 1]$
(since $u^{-1} \in M$ is a lift of $t \in I_\varphi$)
and $\gamma_\psi(t \otimes t) = v^{-1}[t, 1]$ (same reason).
Hence we see that $\det_k(M, \varphi, \psi) = -u/v \in k^*$.
\end{example}

\begin{example}
\label{example-Zp}
Let $R = \mathbf{Z}_p$ and let $M = \mathbf{Z}_p/(p^l)$.
Let $\varphi = p^b u$ and $\varphi = p^a v$ with $a, b \geq 0$,
$a + b = l$ and $u, v \in \mathbf{Z}_p^*$.
Then a computation as in Example \ref{example-dual-numbers}
shows that
\begin{eqnarray*}
\det\nolimits_{\mathbf{F}_p}(\mathbf{Z}_p/(p^l), p^bu, p^av) & = &
(-1)^{ab}u^a/v^b \bmod p \\
& = &
(-1)^{\text{ord}_p(\alpha)\text{ord}_p(\beta)}
\frac{\alpha^{\text{ord}_p(\beta)}}{\beta^{\text{ord}_p(\alpha)}} \bmod p
\end{eqnarray*}
with $\alpha = p^bu, \beta = p^av \in \mathbf{Z}_p$.
See Lemma \ref{lemma-symbol-is-usual-tame-symbol}
for a more general case (and a proof).
\end{example}

\begin{example}
\label{example-generic-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus b}$ be $l = a + b$ dimensional.
Let $\varphi$ and $\psi$ be the following diagonal matrices
$$
\varphi = \text{diag}(u_1, \ldots, u_a, 0, \ldots, 0),
\quad
\psi = \text{diag}(0, \ldots, 0, v_1, \ldots, v_b)
$$
with $u_i, v_j \in k^*$. In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
\frac{u_1 \ldots u_a}{v_1 \ldots v_b}.
$$
This can be seen by a direct computation or by computing in case $l = 1$
and using the additivity of Lemma \ref{lemma-periodic-determinant}.
\end{example}

\begin{example}
\label{example-special-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus a}$ be $l = 2a$ dimensional.
Let $\varphi$ and $\psi$ be the following block matrices
$$
\varphi =
\left(
\begin{matrix}
0 & U \\
0 & 0
\end{matrix}
\right),
\quad
\psi =
\left(
\begin{matrix}
0 & V \\
0 & 0
\end{matrix}
\right),
$$
with $U, V \in \text{Mat}(a \times a, k)$ invertible.
In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
(-1)^a\frac{\det(U)}{\det(V)}.
$$
This can be seen by a direct computation.
The case $a = 1$ is similar to the computation in
Example \ref{example-dual-numbers}.
\end{example}

\begin{example}
\label{example-a-la-oort}
Let $R = k$ be a field.
Let $M = k^{\oplus 4}$.
Let
$$
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
u_1 &   0 &   0 &   0 \\
  0 &   0 &   0 &   0 \\
  0 &   0 & u_2 &   0
\end{matrix}
\right)
\quad
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
  0 &   0 & v_2 &   0 \\
  0 &   0 &   0 &   0 \\
v_1 &   0 &   0 &   0
\end{matrix}
\right)
\quad
$$
with $u_1, u_2, v_1, v_2 \in k^*$.
Then we have
$$
\det\nolimits_k(M, \varphi, \psi) = -\frac{u_1u_2}{v_1v_2}.
$$
\end{example}

\noindent
Next we come to the analogue of the fact that the determinant
of a composition of linear endomorphisms is the product of
the determinants. To avoid very long formulae we
write $I_\varphi = \Im(\varphi)$, and
$K_\varphi = \Ker(\varphi)$
for any $R$-module map $\varphi : M \to M$.
We also denote $\varphi\psi = \varphi \circ \psi$
for a pair of morphisms $\varphi, \psi : M \to M$.

\begin{lemma}
\label{lemma-multiplicativity-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
Let $\alpha, \beta, \gamma$ be endomorphisms of $M$.
Assume that
\begin{enumerate}
\item $I_\alpha = K_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$,
\item $K_\alpha = I_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$.
\end{enumerate}
Then
\begin{enumerate}
\item The triple $(M, \alpha, \beta\gamma)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(I_\gamma, \alpha, \beta)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(M/K_\beta, \alpha, \gamma)$
is an exact $(2, 1)$-periodic complex.
\item We have
$$
\det\nolimits_\kappa(M, \alpha, \beta\gamma)
=
\det\nolimits_\kappa(I_\gamma, \alpha, \beta)
\det\nolimits_\kappa(M/K_\beta, \alpha, \gamma).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that the assumptions imply part (1) of the lemma.

\medskip\noindent
To see part (1) note that the assumptions imply that
$I_{\gamma\alpha} = I_{\alpha\gamma}$, and similarly for kernels
and any other pair of morphisms.
Moreover, we see that
$I_{\gamma\beta} =I_{\beta\gamma} = K_\alpha \subset I_\gamma$ and
similarly for any other pair. In particular we get a short exact sequence
$$
0 \to I_{\beta\gamma} \to I_\gamma \xrightarrow{\alpha} I_{\alpha\gamma} \to 0
$$
and similarly we get a short exact sequence
$$
0 \to I_{\alpha\gamma} \to I_\gamma \xrightarrow{\beta} I_{\beta\gamma} \to 0.
$$
This proves $(I_\gamma, \alpha, \beta)$ is an exact $(2, 1)$-periodic
complex. Hence part (2) of the lemma holds.

\medskip\noindent
To see that $\alpha$, $\gamma$ give well defined endomorphisms
of $M/K_\beta$ we have to check that $\alpha(K_\beta) \subset K_\beta$
and $\gamma(K_\beta) \subset K_\beta$. This is true because
$\alpha(K_\beta) = \alpha(I_{\gamma\alpha}) = I_{\alpha\gamma\alpha}
\subset I_{\alpha\gamma} = K_\beta$, and similarly in the other case.
The kernel of the map $\alpha : M/K_\beta \to M/K_\beta$ is
$K_{\beta\alpha}/K_\beta = I_\gamma/K_\beta$. Similarly,
the kernel of $\gamma : M/K_\beta \to M/K_\beta$ is equal to
$I_\alpha/K_\beta$. Hence we conclude that (3) holds.

\medskip\noindent
We introduce $r = \text{length}_R(K_\alpha)$,
$s = \text{length}_R(K_\beta)$ and $t = \text{length}_R(K_\gamma)$.
By the exact sequences above and our hypotheses we have
$\text{length}_R(I_\alpha) = s + t$, $\text{length}_R(I_\beta) = r + t$,
$\text{length}_R(I_\gamma) = r + s$, and
$\text{length}(M) = r + s + t$.
Choose
\begin{enumerate}
\item an admissible sequence $x_1, \ldots, x_r \in K_\alpha$
generating $K_\alpha$
\item an admissible sequence $y_1, \ldots, y_s \in K_\beta$
generating $K_\beta$,
\item an admissible sequence $z_1, \ldots, z_t \in K_\gamma$
generating $K_\gamma$,
\item elements $\tilde x_i \in M$ such that $\beta\gamma\tilde x_i = x_i$,
\item elements $\tilde y_i \in M$ such that $\alpha\gamma\tilde y_i = y_i$,
\item elements $\tilde z_i \in M$ such that $\beta\alpha\tilde z_i = z_i$.
\end{enumerate}
With these choices the sequence
$y_1, \ldots, y_s, \alpha\tilde z_1, \ldots, \alpha\tilde z_t$
is an admissible sequence in $I_\alpha$ generating it.
Hence, by Remark \ref{remark-more-elementary} the determinant
$D = \det_\kappa(M, \alpha, \beta\gamma)$ is the
unique element of $\kappa^*$ such that
\begin{align*}
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_s,
\tilde x_1, \ldots, \tilde x_r] \\
= (-1)^{r(s + t)} D
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
\end{align*}
By the same remark, we see that
$D_1 = \det_\kappa(M/K_\beta, \alpha, \gamma)$
is characterized by
$$
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_t,
\tilde x_1, \ldots, \tilde x_r]
=
(-1)^{rt} D_1
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
$$
By the same remark, we see that
$D_2 = \det_\kappa(I_\gamma, \alpha, \beta)$ is characterized by
$$
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
=
(-1)^{rs} D_2
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
$$
Combining the formulas above we see that $D = D_1 D_2$
as desired.
\end{proof}


\begin{lemma}
\label{lemma-tricky}
Let $R$ be a local ring with residue field $\kappa$.
Let $\alpha : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a morphism of $(2, 1)$-periodic complexes over $R$.
Assume
\begin{enumerate}
\item $M$, $M'$ have finite length,
\item $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact,
\item the maps $\varphi$, $\psi$ induce the zero map on
$K = \Ker(\alpha)$, and
\item the maps $\varphi$, $\psi$ induce the zero map on
$Q = \Coker(\alpha)$.
\end{enumerate}
Denote $N = \alpha(M) \subset M'$. We obtain two short exact sequences
of $(2, 1)$-periodic complexes
$$
\begin{matrix}
0 \to (N, \varphi', \psi') \to (M', \varphi', \psi') \to (Q, 0, 0) \to 0 \\
0 \to (K, 0, 0) \to (M, \varphi, \psi) \to (N, \varphi', \psi') \to 0
\end{matrix}
$$
which induce two isomorphisms $\alpha_i : Q \to K$, $i = 0, 1$. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
=
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
\det\nolimits_\kappa(M', \varphi', \psi')
$$
In particular, if $\alpha_0 = \alpha_1$, then
$\det\nolimits_\kappa(M, \varphi, \psi) =
\det\nolimits_\kappa(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
There are (at least) two ways to prove this lemma. One is to produce an
enormous commutative diagram using the properties of the determinants.
The other is to use the characterization of the determinants in terms
of admissible sequences of elements. It is the second approach that we
will use.

\medskip\noindent
First let us explain precisely what the maps $\alpha_i$ are.
Namely, $\alpha_0$ is the composition
$$
\alpha_0 : Q = H^0(Q, 0, 0) \to H^1(N, \varphi', \psi') \to H^2(K, 0, 0) = K
$$
and $\alpha_1$ is the composition
$$
\alpha_1 : Q = H^1(Q, 0, 0) \to H^2(N, \varphi', \psi') \to H^3(K, 0, 0) = K
$$
coming from the boundary maps of the short exact sequences of complexes
displayed in the lemma. The fact that the
complexes $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact
implies these maps are isomorphisms.

\medskip\noindent
We will use the notation $I_\varphi = \Im(\varphi)$,
$K_\varphi = \Ker(\varphi)$ and similarly for the other maps.
Exactness for $M$ and $M'$
means that $K_\varphi = I_\psi$ and three similar equalities.
We introduce $k = \text{length}_R(K)$, $a = \text{length}_R(I_\varphi)$,
$b = \text{length}_R(I_\psi)$. Then we see that $\text{length}_R(M) = a + b$,
and $\text{length}_R(N) = a + b - k$, $\text{length}_R(Q) = k$
and $\text{length}_R(M') = a + b$. The exact sequences below will show
that also $\text{length}_R(I_{\varphi'}) = a$ and
$\text{length}_R(I_{\psi'}) = b$.

\medskip\noindent
The assumption that $K \subset K_\varphi = I_\psi$ means that
$\varphi$ factors through $N$ to give an exact sequence
$$
0 \to \alpha(I_\psi) \to N \xrightarrow{\varphi\alpha^{-1}} I_\psi \to 0.
$$
Here $\varphi\alpha^{-1}(x') = y$ means $x' = \alpha(x)$ and $y = \varphi(x)$.
Similarly, we have
$$
0 \to \alpha(I_\varphi) \to N \xrightarrow{\psi\alpha^{-1}} I_\varphi \to 0.
$$
The assumption that $\psi'$ induces the zero map on
$Q$ means that $I_{\psi'} = K_{\varphi'} \subset N$.
This means the quotient $\varphi'(N) \subset I_{\varphi'}$
is identified with $Q$. Note that $\varphi'(N) = \alpha(I_\varphi)$.
Hence we conclude there is an isomorphism
$$
\varphi' : Q \to I_{\varphi'}/\alpha(I_\varphi)
$$
simply described by
$\varphi'(x' \bmod N) = \varphi'(x') \bmod \alpha(I_\varphi)$.
In exactly the same way we get
$$
\psi' : Q \to I_{\psi'}/\alpha(I_\psi)
$$
Finally, note that $\alpha_0$ is the composition
$$
\xymatrix{
Q \ar[r]^-{\varphi'} &
I_{\varphi'}/\alpha(I_\varphi)
\ar[rrr]^-{\psi\alpha^{-1}|_{I_{\varphi'}/\alpha(I_\varphi)}} & & &
K
}
$$
and similarly
$\alpha_1 = \varphi\alpha^{-1}|_{I_{\psi'}/\alpha(I_\psi)} \circ \psi'$.

\medskip\noindent
To shorten the formulas below we are going to write $\alpha x$ instead
of $\alpha(x)$ in the following. No confusion should result since
all maps are indicated by Greek letters and elements by Roman letters.
We are going to choose
\begin{enumerate}
\item an admissible sequence $z_1, \ldots, z_k \in K$
generating $K$,
\item elements $z'_i \in M$ such that $\varphi z'_i = z_i$,
\item elements $z''_i \in M$ such that $\psi z''_i = z_i$,
\item elements $x_{k + 1}, \ldots, x_a \in I_\varphi$ such
that $z_1, \ldots, z_k, x_{k + 1}, \ldots, x_a$ is an admissible
sequence generating $I_\varphi$,
\item elements $\tilde x_i \in M$ such that $\varphi \tilde x_i = x_i$,
\item elements $y_{k + 1}, \ldots, y_b \in I_\psi$ such that
$z_1, \ldots, z_k, y_{k + 1}, \ldots, y_b$ is an admissible
sequence generating $I_\psi$,
\item elements $\tilde y_i \in M$ such that $\psi \tilde y_i = y_i$, and
\item elements $w_1, \ldots, w_k \in M'$ such that
$w_1 \bmod N, \ldots, w_k \bmod N$ are an admissible sequence
in $Q$ generating $Q$.
\end{enumerate}
By Remark \ref{remark-more-elementary} the element
$D = \det_\kappa(M, \varphi, \psi) \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[z_1, \ldots, z_k,
x_{k + 1}, \ldots, x_a,
z''_1, \ldots, z''_k,
\tilde y_{k + 1}, \ldots, \tilde y_b] \\
& = &
(-1)^{ab} D
[z_1, \ldots, z_k,
y_{k + 1}, \ldots, y_b,
z'_1, \ldots, z'_k,
\tilde x_{k + 1}, \ldots, \tilde x_a]
\end{eqnarray*}
Note that by the discussion above
$\alpha x_{k + 1}, \ldots, \alpha x_a, \varphi w_1, \ldots, \varphi w_k$
is an admissible sequence generating $I_{\varphi'}$ and
$\alpha y_{k + 1}, \ldots, \alpha y_b, \psi w_1, \ldots, \psi w_k$
is an admissible sequence generating $I_{\psi'}$.
Hence by Remark \ref{remark-more-elementary} the element
$D' = \det_\kappa(M', \varphi', \psi') \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b,
w_1, \ldots, w_k]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a,
w_1, \ldots, w_k]
\end{eqnarray*}
Note how in the first, resp.\ second displayed formula the
the first, resp.\ last $k$ entries of the symbols on both sides
are the same. Hence these formulas are really equivalent to the
equalities
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
(-1)^{ab} D
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
in $\det_\kappa(N)$. Note that
$\varphi' w_1, \ldots, \varphi' w_k$
and
$\alpha z''_1, \ldots, z''_k$
are admissible sequences generating the module
$I_{\varphi'}/\alpha(I_\varphi)$. Write
$$
[\varphi' w_1, \ldots, \varphi' w_k]
= \lambda_0 [\alpha z''_1, \ldots, \alpha z''_k]
$$
in $\det_\kappa(I_{\varphi'}/\alpha(I_\varphi))$
for some $\lambda_0 \in \kappa^*$. Similarly,
write
$$
[\psi' w_1, \ldots, \psi' w_k]
= \lambda_1 [\alpha z'_1, \ldots, \alpha z'_k]
$$
in $\det_\kappa(I_{\psi'}/\alpha(I_\psi))$
for some $\lambda_1 \in \kappa^*$. On the one hand
it is clear that
$$
\alpha_i([w_1, \ldots, w_k]) = \lambda_i[z_1, \ldots, z_k]
$$
for $i = 0, 1$ by our description of $\alpha_i$ above,
which means that
$$
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
=
\lambda_1/\lambda_0
$$
and
on the other hand it is clear that
\begin{eqnarray*}
& &
\lambda_0 [\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
\lambda_1[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a] \\
& = &
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
which imply $\lambda_0 D = \lambda_1 D'$. The lemma follows.
\end{proof}








\section{Symbols}
\label{section-symbols}

\noindent
The correct generality for this construction is perhaps the
situation of the following lemma.

\begin{lemma}
\label{lemma-pre-symbol}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Assume $\varphi, \psi : M \to M$ are two injective
$A$-module maps, and assume $\varphi(\psi(M)) = \psi(\varphi(M))$,
for example if $\varphi$ and $\psi$ commute.
Then $\text{length}_R(M/\varphi\psi M) < \infty$
and $(M/\varphi\psi M, \varphi, \psi)$ is an exact
$(2, 1)$-periodic complex.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a minimal prime of the support of $M$.
Then $M_{\mathfrak q}$ is a finite length $A_{\mathfrak q}$-module,
see Algebra, Lemma \ref{algebra-lemma-support-point}.
Hence both $\varphi$ and $\psi$
induce isomorphisms $M_{\mathfrak q} \to M_{\mathfrak q}$.
Thus the support of $M/\varphi\psi M$ is $\{\mathfrak m_A\}$
and hence it has finite length (see lemma cited above).
Finally, the kernel of $\varphi$ on $M/\varphi\psi M$
is clearly $\psi M/\varphi\psi M$, and hence the kernel
of $\varphi$ is the image of $\psi$ on $M/\varphi\psi M$.
Similarly the other way since $M/\varphi\psi M = M/\psi\varphi M$
by assumption.
\end{proof}

\begin{lemma}
\label{lemma-symbol-defined}
Let $A$ be a Noetherian local ring. Let $a, b \in A$.
\begin{enumerate}
\item If $M$ is a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$, then
$\text{length}_A(M/abM) < \infty$ and
$(M/abM, a, b)$ is a $(2, 1)$-periodic exact complex.
\item If $a, b$ are nonzerodivisors and $\dim(A) = 1$
then $\text{length}_A(A/(ab)) < \infty$ and
$(A/(ab), a, b)$ is a $(2, 1)$-periodic exact complex.
\end{enumerate}
In particular, in these cases
$\det_\kappa(M/abM, a, b) \in \kappa^*$,
resp.\ $\det_\kappa(A/(ab), a, b) \in \kappa^*$
are defined.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pre-symbol}.
\end{proof}

\begin{definition}
\label{definition-symbol-M}
Let $A$ be a Noetherian local ring with residue field $\kappa$.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$.
We define the {\it symbol associated to $M, a, b$}
to be the element
$$
d_M(a, b) =
\det\nolimits_\kappa(M/abM, a, b) \in \kappa^*
$$
\end{definition}

\begin{lemma}
\label{lemma-multiplicativity-symbol}
Let $A$ be a Noetherian local ring.
Let $a, b, c \in A$. Let $M$ be a finite $A$-module
with $\dim(\text{Supp}(M)) = 1$. Assume $a, b, c$ are nonzerodivisors on $M$.
Then
$$
d_M(a, bc) = d_M(a, b) d_M(a, c)
$$
and $d_M(a, b)d_M(b, a) = 1$.
\end{lemma}

\begin{proof}
The first statement follows from Lemma \ref{lemma-multiplicativity-determinant}
applied to $M/abcM$ and endomorphisms $\alpha, \beta, \gamma$ given by
multiplication by $a, b, c$.
The second comes from Lemma \ref{lemma-periodic-determinant-shift}.
\end{proof}

\begin{definition}
\label{definition-tame-symbol}
Let $A$ be a Noetherian local domain of dimension $1$
with residue field $\kappa$.
Let $K$ be the fraction field of $A$.
We define the {\it tame symbol} of $A$ to be the map
$$
K^* \times K^* \longrightarrow \kappa^*,
\quad
(x, y) \longmapsto d_A(x, y)
$$
where $d_A(x, y)$ is extended to $K^* \times K^*$ by the multiplicativity of
Lemma \ref{lemma-multiplicativity-symbol}.
\end{definition}

\noindent
It is clear that we may extend more generally $d_M(-, -)$ to
certain rings of fractions of $A$ (even if $A$ is not a domain).

\begin{lemma}
\label{lemma-symbol-when-equal}
Let $A$ be a Noetherian local ring and $M$ a finite $A$-module of
dimension $1$. Let $a \in A$ be a nonzerodivisor on $M$.
Then $d_M(a, a) = (-1)^{\text{length}_A(M/aM)}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-periodic-determinant-sign}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-when-one-is-a-unit}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Let $b \in A$ be a nonzerodivisor on $M$, and let $u \in A^*$.
Then
$$
d_M(u, b) = u^{\text{length}_A(M/bM)} \bmod \mathfrak m_A.
$$
In particular, if $M = A$, then
$d_A(u, b) = u^{\text{ord}_A(b)} \bmod \mathfrak m_A$.
\end{lemma}

\begin{proof}
Note that in this case $M/ubM = M/bM$ on which multiplication
by $b$ is zero. Hence $d_M(u, b) = \det_\kappa(u|_{M/bM})$
by Lemma \ref{lemma-periodic-determinant-easy-case}. The lemma
then follows from Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-short-exact-sequence}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let
$$
0 \to M \to M' \to M'' \to 0
$$
be a short exact sequence of $A$-modules of dimension $1$
such that $a, b$ are nonzerodivisors on
all three $A$-modules.
Then
$$
d_{M'}(a, b) = d_M(a, b) d_{M''}(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
It is easy to see that this leads to a short exact sequence
of exact $(2, 1)$-periodic complexes
$$
0 \to
(M/abM, a, b) \to
(M'/abM', a, b) \to
(M''/abM'', a, b) \to 0
$$
Hence the lemma follows from Lemma \ref{lemma-periodic-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-compare-modules}
Let $A$ be a Noetherian local ring.
Let $\alpha : M \to M'$ be a homomorphism of
finite $A$-modules of dimension $1$.
Let $a, b \in A$. Assume
\begin{enumerate}
\item $a$, $b$ are nonzerodivisors on both $M$ and $M'$, and
\item $\dim(\Ker(\alpha)), \dim(\Coker(\alpha)) \leq 0$.
\end{enumerate}
Then $d_M(a, b) = d_{M'}(a, b)$.
\end{lemma}

\begin{proof}
If $a \in A^*$, then the equality follows from the
equality $\text{length}(M/bM) = \text{length}(M'/bM')$
and Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Similarly if $b$ is a unit the lemma holds as well
(by the symmetry of Lemma \ref{lemma-multiplicativity-symbol}).
Hence we may assume that $a, b \in \mathfrak m_A$.
This in particular implies that $\mathfrak m$ is not
an associated prime of $M$, and hence $\alpha : M \to M'$
is injective. This permits us to think of $M$ as a submodule of $M'$.
By assumption $M'/M$ is a finite $A$-module with support
$\{\mathfrak m_A\}$ and hence has finite length.
Note that for any third module $M''$ with $M \subset M'' \subset M'$
the maps $M \to M''$ and $M'' \to M'$ satisfy the assumptions of the lemma
as well. This reduces us, by induction on the length of $M'/M$,
to the case where $\text{length}_A(M'/M) = 1$.
Finally, in this case consider the map
$$
\overline{\alpha} : M/abM \longrightarrow M'/abM'.
$$
By construction the cokernel $Q$ of $\overline{\alpha}$ has
length $1$. Since $a, b \in \mathfrak m_A$, they act trivially on
$Q$. It also follows that the kernel $K$ of $\overline{\alpha}$ has
length $1$ and hence also $a$, $b$ act trivially on $K$.
Hence we may apply Lemma \ref{lemma-tricky}. Thus it suffices to see
that the two maps $\alpha_i : Q \to K$ are the same.
In fact, both maps are equal to the map
$q = x' \bmod \Im(\overline{\alpha}) \mapsto abx' \in K$.
We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-compute-symbol-M}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module with $\dim(\text{Supp}(M)) = 1$.
Let $a, b \in A$ nonzerodivisors on $M$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
d_M(a, b)
=
\prod\nolimits_{i = 1, \ldots, t}
d_{A/\mathfrak q_i}(a, b)^{
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})}
$$
as elements of $\kappa^*$.
\end{lemma}

\begin{proof}
Choose a filtration by $A$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_j/M_{j - 1}$ is isomorphic
to $A/\mathfrak p_j$ for some prime ideal $\mathfrak p_j$
of $A$. See Algebra, Lemma \ref{algebra-lemma-filter-Noetherian-module}.
For each $j$ we have either $\mathfrak p_j = \mathfrak q_i$
for some $i$, or $\mathfrak p_j = \mathfrak m_A$. Moreover,
for a fixed $i$, the number of $j$ such that
$\mathfrak p_j = \mathfrak q_i$ is equal to
$\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})$ by
Algebra, Lemma \ref{algebra-lemma-filter-minimal-primes-in-support}.
Hence $d_{M_j}(a, b)$ is defined for each $j$ and
$$
d_{M_j}(a, b)
=
\left\{
\begin{matrix}
d_{M_{j - 1}}(a, b) d_{A/\mathfrak q_i}(a, b) &
\text{if} & \mathfrak p_j = \mathfrak q_i \\
d_{M_{j - 1}}(a, b) & \text{if} & \mathfrak p_j = \mathfrak m_A
\end{matrix}
\right.
$$
by Lemma \ref{lemma-symbol-short-exact-sequence} in the first instance
and Lemma \ref{lemma-symbol-compare-modules} in the second. Hence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-usual-tame-symbol}
Let $A$ be a discrete valuation ring with fraction field $K$.
For nonzero $x, y \in K$ we have
$$
d_A(x, y)
=
(-1)^{\text{ord}_A(x)\text{ord}_A(y)}
\frac{x^{\text{ord}_A(y)}}{y^{\text{ord}_A(x)}} \bmod \mathfrak m_A,
$$
in other words the symbol is equal to the usual tame symbol.
\end{lemma}

\begin{proof}
By multiplicativity it suffices to prove this when $x, y \in A$.
Let $t \in A$ be a uniformizer.
Write $x = t^bu$ and $y = t^bv$ for some $a, b \geq 0$
and $u, v \in A^*$. Set $l = a + b$. Then
$t^{l - 1}, \ldots, t^b$ is an admissible sequence in
$(x)/(xy)$ and $t^{l - 1}, \ldots, t^a$ is an admissible
sequence in $(y)/(xy)$. Hence by Remark \ref{remark-more-elementary}
we see that $d_A(x, y)$ is characterized by the equation
$$
[t^{l - 1}, \ldots, t^b, v^{-1}t^{b - 1}, \ldots, v^{-1}]
=
(-1)^{ab} d_A(x, y)
[t^{l - 1}, \ldots, t^a, u^{-1}t^{a - 1}, \ldots, u^{-1}].
$$
Hence by the admissible relations for the
symbols $[x_1, \ldots, x_l]$ we see that
$$
d_A(x, y) = (-1)^{ab} u^a/v^b \bmod \mathfrak m_A
$$
as desired.
\end{proof}

\noindent
We add the following lemma here. It is very similar to
Algebra, Lemma \ref{algebra-lemma-nonregular-dimension-one}.

\begin{lemma}
\label{lemma-Noetherian-domain-dim-1-two-elements}
Let $R$ be a local Noetherian domain of dimension $1$
with maximal ideal $\mathfrak m$.
Let $a, b \in \mathfrak m$ be nonzero. There exists a finite
ring extension $R \subset R'$ with same field of fractions,
and $t, a', b' \in R'$ such that $a = ta'$ and $b = tb'$ and
$R' = a'R' + b'R'$.
\end{lemma}

\begin{proof}
Set $I = (a, b)$. The idea is to blow up $R$ in $I$.
Instead of doing the algebraic argument we work geometrically.
Let $X = \text{Proj}(\bigoplus_{d \geq 0} I^d)$.
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
this is an integral scheme.
The morphism $X \to \Spec(R)$ is projective by
Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}.
By Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1} and the fact that
$X$ is quasi-compact we see that the fibre of $X \to \Spec(R)$
over $\mathfrak m$ is finite.
By Properties, Lemma \ref{properties-lemma-ample-finite-set-in-affine}
there exists an affine open $U \subset X$
containing this fibre.
Hence $X = U$ because $X \to \Spec(R)$ is closed.
In other words $X$ is affine, say $X = \Spec(R')$.
By Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we see that $R \to R'$ is of finite type. Since $X \to \Spec(R)$ is
proper and affine it is integral (see
Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed}).
Hence $R \to R'$ is of finite type and integral, hence finite
(Algebra, Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}).
By Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
we see that $IR'$ is a locally principal ideal.
Since $R'$ is semi-local we see that $IR'$ is principal,
see Algebra, Lemma \ref{algebra-lemma-locally-free-semi-local-free},
say $IR' = (t)$. Then we have $a = a't$ and $b = b't$ and everything is
clear.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-steinberg-prepare}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$ on
which each of $a$, $b$, $b - a$ are nonzerodivisors.
Then
$$
d_M(a, b - a)d_M(b, b) = d_M(b, b - a)d_M(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compute-symbol-M} it suffices to show the relation when
$M = A/\mathfrak q$ for some prime $\mathfrak q \subset A$ with
$\dim(A/\mathfrak q) = 1$.

\medskip\noindent
In case $M = A/\mathfrak q$ we may replace $A$ by $A/\mathfrak q$ and
$a, b$ by their images in $A/\mathfrak q$. Hence we may assume $A = M$
and $A$ a local Noetherian domain of dimension $1$. The reason is
that the residue field $\kappa$ of $A$ and $A/\mathfrak q$ are
the same and that for any $A/\mathfrak q$-module $M$ the determinant
taken over $A$ or over $A/\mathfrak q$ are canonically identified.
See Lemma \ref{lemma-determinant-quotient-ring}.

\medskip\noindent
It suffices to show the relation when both
$a, b$ are in the maximal ideal. Namely, the case where one
or both are units follows from Lemmas \ref{lemma-symbol-when-one-is-a-unit}
and \ref{lemma-symbol-when-equal}.

\medskip\noindent
Choose an extension $A \subset A'$ and factorizations
$a = ta'$, $b = tb'$ as in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}.
Note that also $b - a = t(b' - a')$ and that
$A' = (a', b') = (a', b' - a') = (b' - a', b')$.
Here and in the following we think of $A'$ as an $A$-module and
$a, b, a', b', t$ as $A$-module endomorphisms of $A'$.
We will use the notation $d^A_{A'}(a', b')$ and so on to indicate
$$
d^A_{A'}(a', b')
=
\det\nolimits_\kappa(A'/a'b'A', a', b')
$$
which is defined by Lemma \ref{lemma-pre-symbol}. The upper index ${}^A$
is used to distinguish this from the already defined symbol
$d_{A'}(a', b')$ which is different (for example because it has values
in the residue field of $A'$ which may be different from $\kappa$).
By Lemma \ref{lemma-symbol-compare-modules} we see that
$d_A(a, b) = d^A_{A'}(a, b)$,
and similarly for the other combinations.
Using this and multiplicativity we see that it suffices to prove
$$
d^A_{A'}(a', b' - a') d^A_{A'}(b', b')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
Now, since $(a', b') = A'$ and so on we have
$$
\begin{matrix}
A'/(a'(b' - a')) & \cong & A'/(a') \oplus A'/(b' - a') \\
A'/(b'(b' - a')) & \cong & A'/(b') \oplus A'/(b' - a') \\
A'/(a'b') & \cong & A'/(a') \oplus A'/(b')
\end{matrix}
$$
Moreover, note that multiplication by $b' - a'$ on
$A/(a')$ is equal to multiplication by $b'$, and that
multiplication by $b' - a'$ on $A/(b')$ is equal to multiplication by $-a'$.
Using Lemmas
\ref{lemma-periodic-determinant-easy-case} and
\ref{lemma-periodic-determinant}
we conclude
$$
\begin{matrix}
d^A_{A'}(a', b' - a') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b' - a')}) \\
d^A_{A'}(b', b' - a') & = &
\det\nolimits_\kappa(-a'|_{A'/(b')})^{-1}
\det\nolimits_\kappa(b'|_{A'/(b' - a')}) \\
d^A_{A'}(a', b') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b')})
\end{matrix}
$$
Hence we conclude that
$$
(-1)^{\text{length}_A(A'/(b'))}
d^A_{A'}(a', b' - a')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
the sign coming from the $-a'$ in the second equality above.
On the other hand, by Lemma \ref{lemma-periodic-determinant-sign} we have
$d^A_{A'}(b', b') = (-1)^{\text{length}_A(A'/(b'))}$ and the lemma
is proved.
\end{proof}

\noindent
The tame symbol is a Steinberg symbol.

\begin{lemma}
\label{lemma-symbol-is-steinberg}
Let $A$ be a Noetherian local domain of dimension $1$.
Let $K = f.f.(A)$. For $x \in K \setminus \{0, 1\}$
we have
$$
d_A(x, 1 -x) = 1
$$
\end{lemma}

\begin{proof}
Write $x = a/b$ with $a, b \in A$.
The hypothesis implies, since $1 - x = (b - a)/b$,
that also $b - a \not = 0$. Hence we compute
$$
d_A(x, 1 - x)
=
d_A(a, b - a)d_A(a, b)^{-1}d_A(b, b - a)^{-1}d_A(b, b)
$$
Thus we have to show that
$d_A(a, b - a) d_A(b, b) = d_A(b, b - a) d_A(a, b)$.
This is Lemma \ref{lemma-symbol-is-steinberg-prepare}.
\end{proof}










\section{Lengths and determinants}
\label{section-length-determinant}

\noindent
In this section we use the determinant to compare lattices.
The key lemma is the following.

\begin{lemma}
\label{lemma-key-lemma}
Let $R$ be a noetherian local ring.
Let $\mathfrak q \subset R$ be a prime with $\dim(R/\mathfrak q) = 1$.
Let $\varphi : M \to N$ be a homomorphism of finite $R$-modules.
Assume there exist $x_1, \ldots, x_l \in M$ and $y_1, \ldots, y_l \in M$
with the following properties
\begin{enumerate}
\item $M = \langle x_1, \ldots, x_l\rangle$,
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$,
\item $N = \langle y_1, \ldots, y_l\rangle$, and
\item $\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Then $\varphi$ is injective if and only if $\varphi_{\mathfrak q}$ is an
isomorphism, and in this case we have
$$
\text{length}_R(\Coker(\varphi)) = \text{ord}_{R/\mathfrak q}(f)
$$
where $f \in \kappa(\mathfrak q)$ is the element such that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l]
$$
in $\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$.
\end{lemma}

\begin{proof}
First, note that the lemma holds in case $l = 1$.
Namely, in this case $x_1$ is a basis of $M$ over $R/\mathfrak q$
and $y_1$ is a basis of $N$ over $R/\mathfrak q$ and we have
$\varphi(x_1) = fy_1$ for some $f \in R$. Thus $\varphi$ is injective
if and only if $f \not \in \mathfrak q$. Moreover,
$\Coker(\varphi) = R/(f, \mathfrak q)$ and hence the lemma
holds by definition of $\text{ord}_{R/q}(f)$
(see Algebra, Definition \ref{algebra-definition-ord}).

\medskip\noindent
In fact, suppose more generally that $\varphi(x_i) = f_iy_i$ for some
$f_i \in R$, $f_i \not \in \mathfrak q$. Then the induced maps
$$
\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\longrightarrow
\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
$$
are all injective and have cokernels isomorphic to
$R/(f_i, \mathfrak q)$. Hence we see that
$$
\text{length}_R(\Coker(\varphi)) = \sum \text{ord}_{R/\mathfrak q}(f_i).
$$
On the other hand it is clear that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f_1 \ldots f_l [y_1, \ldots, y_l]
$$
in this case from the admissible relation (b) for symbols.
Hence we see the result holds in this case also.

\medskip\noindent
We prove the general case by induction on $l$. Assume $l > 1$.
Let $i \in \{1, \ldots, l\}$ be minimal such that
$\varphi(x_1) \in \langle y_1, \ldots, y_i\rangle$.
We will argue by induction on $i$.
If $i = 1$, then we get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\langle x_1 \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle / \langle x_1 \rangle \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\langle y_1 \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle / \langle y_1 \rangle \ar[r] &
0
}
$$
and the lemma follows from the snake lemma and induction on $l$.
Assume now that $i > 1$.
Write $\varphi(x_1) = a_1 y_1 + \ldots + a_{i - 1} y_{i - 1} + a y_i$
with $a_j, a \in R$ and $a \not \in \mathfrak q$ (since otherwise
$i$ was not minimal). Set
$$
x'_j =
\left\{
\begin{matrix}
x_j & \text{if} & j = 1 \\
ax_j & \text{if} & j \geq 2
\end{matrix}
\right.
\quad\text{and}\quad
y'_j =
\left\{
\begin{matrix}
y_j & \text{if} & j < i \\
ay_j & \text{if} & j \geq i
\end{matrix}
\right.
$$
Let $M' = \langle x'_1, \ldots, x'_l \rangle$ and
$N' = \langle y'_1, \ldots, y'_l \rangle$.
Since $\varphi(x'_1) = a_1 y'_1 + \ldots + a_{i - 1} y'_{i - 1} + y'_i$
by construction and since for $j > 1$ we have
$\varphi(x'_j) = a\varphi(x_i) \in \langle y'_1, \ldots, y'_l\rangle$
we get a commutative diagram of $R$-modules and maps
$$
\xymatrix{
M' \ar[d] \ar[r]_{\varphi'} & N' \ar[d] \\
M \ar[r]^\varphi & N
}
$$
By the result of the second paragraph of the proof we know
that $\text{length}_R(M/M') = (l - 1)\text{ord}_{R/\mathfrak q}(a)$
and similarly
$\text{length}_R(M/M') = (l - i + 1)\text{ord}_{R/\mathfrak q}(a)$.
By a diagram chase this implies that
$$
\text{length}_R(\Coker(\varphi')) =
\text{length}_R(\Coker(\varphi)) + i\ \text{ord}_{R/\mathfrak q}(a).
$$
On the other hand, it is clear that writing
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l],
\quad
[\varphi'(x'_1), \ldots, \varphi(x'_l)] = f' [y'_1, \ldots, y'_l]
$$
we have $f' = a^if$. Hence it suffices to prove the lemma for the
case that $\varphi(x_1) = a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i$,
i.e., in the case that $a = 1$. Next, recall that
$$
[y_1, \ldots, y_l] = [y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l]
$$
by the admissible relations for symbols. The sequence
$y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots + a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l$
satisfies the conditions (3), (4) of the lemma also.
Hence, we may actually
assume that $\varphi(x_1) = y_i$. In this case, note that we have
$\mathfrak q x_1 = 0$ which implies also $\mathfrak q y_i = 0$.
We have
$$
[y_1, \ldots, y_l] =
- [y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l]
$$
by the third of the admissible relations defining
$\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$. Hence we may
replace $y_1, \ldots, y_l$ by
the sequence
$y'_1, \ldots, y'_l =
y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l$
(which also satisfies conditions (3) and (4) of the lemma).
Clearly this decreases the invariant $i$ by $1$ and we win by induction
on $i$.
\end{proof}

\noindent
To use the previous lemma we show that often sequences of elements
with the required properties exist.

\begin{lemma}
\label{lemma-good-sequence-exists}
Let $R$ be a local Noetherian ring.
Let $\mathfrak q \subset R$ be a prime ideal.
Let $M$ be a finite $R$-module such that
$\mathfrak q$ is one of the minimal primes of the support of $M$.
Then there exist $x_1, \ldots, x_l \in M$ such that
\begin{enumerate}
\item the support of $M / \langle x_1, \ldots, x_l\rangle$ does not contain
$\mathfrak q$, and
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Moreover, in this case $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$.
\end{lemma}

\begin{proof}
The condition that $\mathfrak q$ is a minimal prime in the support
of $M$ implies that $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$
is finite (see Algebra, Lemma \ref{algebra-lemma-support-point}).
Hence we can find $y_1, \ldots, y_l \in M_{\mathfrak q}$
such that
$\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
We can find $f_i \in R$, $f_i \not \in \mathfrak q$ such that
$f_i y_i$ is the image of some element $z_i \in M$.
Moreover, as $R$ is Noetherian we can write
$\mathfrak q = (g_1, \ldots, g_t)$ for some $g_j \in R$.
By assumption $g_j y_i \in \langle y_1, \ldots, y_{i - 1} \rangle$
inside the module $M_{\mathfrak q}$.
By our choice of $z_i$ we can find some further elements
$f_{ji} \in R$, $f_{ij} \not \in \mathfrak q$ such that
$f_{ij} g_j z_i \in \langle z_1, \ldots, z_{i - 1} \rangle$
(equality in the module $M$).
The lemma follows by taking
$$
x_1 = f_{11}f_{12}\ldots f_{1t}z_1,
\quad
x_2 = f_{11}f_{12}\ldots f_{1t}f_{21}f_{22}\ldots f_{2t}z_2,
$$
and so on. Namely, since all the elements $f_i, f_{ij}$ are invertible
in $R_{\mathfrak q}$ we still have that
$R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_i /
R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_{i - 1}
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
By construction, $\mathfrak q x_i \in \langle x_1, \ldots, x_{i - 1}\rangle$.
Thus $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle$
is an $R$-module generated by one element, annihilated $\mathfrak q$
such that localizing at $\mathfrak q$ gives a $q$-dimensional
vector space over $\kappa(\mathfrak q)$.
Hence it is isomorphic to $R/\mathfrak q$.
\end{proof}

\noindent
Here is the main result of this section.
We will see below the various different
consequences of this proposition.
The reader is encouraged to first prove the easier
Lemma \ref{lemma-application-herbrand-quotient} his/herself.

\begin{proposition}
\label{proposition-length-determinant-periodic-complex}
Let $R$ be a local Noetherian ring with residue field $\kappa$.
Suppose that $(M, \varphi, \psi)$ is a $(2, 1)$-periodic
complex over $R$. Assume
\begin{enumerate}
\item $M$ is a finite $R$-module,
\item the cohomology modules of $(M, \varphi, \psi)$ are of finite length, and
\item $\dim(\text{Supp}(M)) = 1$.
\end{enumerate}
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the minimal
primes of the support of $M$. Then we have\footnote{
Obviously we could get rid of the minus sign by redefining
$\det_\kappa(M, \varphi, \psi)$ as the inverse of its
current value, see Definition \ref{definition-periodic-determinant}.}
$$
- e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{\mathfrak q_i}, \varphi_{\mathfrak q_i}, \psi_{\mathfrak q_i})
\right)
$$
\end{proposition}

\begin{proof}
We first reduce to the case $t = 1$ in the following way.
Note that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$,
where $\mathfrak m \subset R$ is the maximal ideal.
Let $M_i$ denote the image of $M \to M_{\mathfrak q_i}$,
so $\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The map $\varphi$ (resp.\ $\psi$) induces an $R$-module map
$\varphi_i : M_i \to M_i$ (resp.\ $\psi_i : M_i \to M_i$).
Thus we get a morphism of $(2, 1)$-periodic complexes
$$
(M, \varphi, \psi) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, t} (M_i, \varphi_i, \psi_i).
$$
The kernel and cokernel of this map have support equal to
$\{\mathfrak m\}$ (or are zero). Hence by Lemma \ref{lemma-periodic-length}
these $(2, 1)$-periodic complexes have multiplicity $0$.
In other words we have
$$
e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
e_R(M_i, \varphi_i, \psi_i)
$$
On the other hand we clearly have $M_{\mathfrak q_i} = M_{i, \mathfrak q_i}$,
and hence the terms of the right hand side of the formula of the
lemma are equal to the expressions
$$
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{i, \mathfrak q_i}, \varphi_{i, \mathfrak q_i}, \psi_{i, \mathfrak q_i})
\right)
$$
In other words, if we can prove the lemma for each of the modules
$M_i$, then the lemma holds. This reduces us to the case $t = 1$.

\medskip\noindent
Assume we have a $(2, 1)$-periodic complex $(M, \varphi, \psi)$
over a Noetherian local ring with $M$ a finite $R$-module,
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$, and
finite length cohomology modules. The proof in this case
follows from Lemma \ref{lemma-key-lemma} and careful bookkeeping.
Denote
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
Since $R$ is Noetherian these are all finite $R$-modules.
Set
$$
a = \text{length}_{R_{\mathfrak q}}(I_{\varphi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\psi, \mathfrak q}),
\quad
b = \text{length}_{R_{\mathfrak q}}(I_{\psi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\varphi, \mathfrak q}).
$$
Equalities because the complex becomes exact after localizing at
$\mathfrak q$. Note that $l = \text{length}_{R_{\mathfrak q}}(M_{\mathfrak q})$
is equal to $l = a + b$.

\medskip\noindent
We are going to use Lemma \ref{lemma-good-sequence-exists}
to choose sequences of elements in finite $R$-modules
$N$ with support contained in $\{\mathfrak m, \mathfrak q\}$.
In this case $N_{\mathfrak q}$ has finite length, say $n \in \mathbf{N}$.
Let us call a sequence $w_1, \ldots, w_n \in N$
with properties (1) and (2) of Lemma \ref{lemma-good-sequence-exists}
a ``good sequence''. Note that the quotient
$N/\langle w_1, \ldots, w_n \rangle$ of $N$ by the submodule generated by
a good sequence has support (contained in) $\{\mathfrak m\}$
and hence has finite length (Algebra, Lemma \ref{algebra-lemma-support-point}).
Moreover, the symbol
$[w_1, \ldots, w_n] \in \det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$
is a generator, see Lemma \ref{lemma-determinant-dimension-one}.

\medskip\noindent
Having said this we choose good sequences
$$
\begin{matrix}
x_1, \ldots, x_b & \text{in} & K_\varphi, &
t_1, \ldots, t_a & \text{in} & K_\psi, \\
y_1, \ldots, y_a & \text{in} & I_\varphi \cap \langle t_1, \ldots t_a\rangle, &
s_1, \ldots, s_b & \text{in} & I_\psi \cap \langle x_1, \ldots, x_b\rangle.
\end{matrix}
$$
We will adjust our choices a little bit as follows.
Choose lifts $\tilde y_i \in M$ of $y_i \in I_\varphi$
and $\tilde s_i \in M$ of $s_i \in I_\psi$. It may not be the case
that $\mathfrak q \tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and it may not be the case that
$\mathfrak q \tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
However, using that $\mathfrak q$ is finitely generated (as in the proof
of Lemma \ref{lemma-good-sequence-exists}) we can find a
$d \in R$, $d \not \in \mathfrak q$ such that
$\mathfrak q d\tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and
$\mathfrak q d\tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
Thus after replacing $y_i$ by $dy_i$,
$\tilde y_i$ by $d\tilde y_i$, $s_i$ by $ds_i$ and $\tilde s_i$
by $d\tilde s_i$ we see that we may assume also that
$x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_b$
and $t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b$
are good sequences in $M$.

\medskip\noindent
Finally, we choose a good sequence
$z_1, \ldots, z_l$ in the finite $R$-module
$$
\langle
x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a
\rangle
\cap
\langle
t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b
\rangle.
$$
Note that this is also a good sequence in $M$.

\medskip\noindent
Since $I_{\varphi, \mathfrak q} = K_{\psi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[y_1, \ldots, y_a] = h [t_1, \ldots, t_a]$
inside $\det_{\kappa(\mathfrak q)}(K_{\psi, \mathfrak q})$.
Similarly, as $I_{\psi, \mathfrak q} = K_{\varphi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[s_1, \ldots, s_b] = g [x_1, \ldots, x_b]$
inside $\det_{\kappa(\mathfrak q)}(K_{\varphi, \mathfrak q})$.
We can also do this with the three good sequences we have
in $M$. All in all we get the following identities
\begin{align*}
[y_1, \ldots, y_a]
& =
h [t_1, \ldots, t_a] \\
[s_1, \ldots, s_b]
& =
g [x_1, \ldots, x_b] \\
[z_1, \ldots, z_l]
& =
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
[z_1, \ldots, z_l]
& =
f_\psi [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b]
\end{align*}
for some $g, h, f_\varphi, f_\psi \in \kappa(\mathfrak q)$.

\medskip\noindent
Having set up all this
notation let us compute $\det_{\kappa(\mathfrak q)}(M, \varphi, \psi)$.
Namely, consider the element $[z_1, \ldots, z_l]$.
Under the map $\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$
of Definition \ref{definition-periodic-determinant} we have
\begin{eqnarray*}
[z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
& \mapsto & f_\varphi [x_1, \ldots, x_b] \otimes [y_1, \ldots, y_a] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a] \otimes [s_1, \ldots, s_b] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b] \\
& = &
f_\varphi h/f_\psi g [z_1, \ldots, z_l]
\end{eqnarray*}
This means that
$\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
is equal to $f_\varphi h/f_\psi g$ up to a sign.

\medskip\noindent
We abbreviate the following quantities
\begin{eqnarray*}
k_\varphi & = & \text{length}_R(K_\varphi/\langle x_1, \ldots, x_b\rangle) \\
k_\psi    & = & \text{length}_R(K_\psi/\langle t_1, \ldots, t_a\rangle) \\
i_\varphi & = & \text{length}_R(I_\varphi/\langle y_1, \ldots, y_a\rangle) \\
i_\psi    & = & \text{length}_R(I_\psi/\langle s_1, \ldots, s_a\rangle) \\
m_\varphi & = & \text{length}_R(M/
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle) \\
m_\psi    & = & \text{length}_R(M/
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle) \\
\delta_\varphi & = & \text{length}_R(
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle
\langle z_1, \ldots, z_l\rangle) \\
\delta_\psi & = & \text{length}_R(
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle
\langle z_1, \ldots, z_l\rangle)
\end{eqnarray*}
Using the exact sequences $0 \to K_\varphi \to M \to I_\varphi \to 0$
we get $m_\varphi = k_\varphi + i_\varphi$. Similarly we have
$m_\psi = k_\psi + i_\psi$. We have
$\delta_\varphi + m_\varphi = \delta_\psi + m_\psi$ since this
is equal to the colength of $\langle z_1, \ldots, z_l \rangle$
in $M$. Finally, we have
$$
\delta_\varphi = \text{ord}_{R/\mathfrak q}(f_\varphi),
\quad
\delta_\psi = \text{ord}_{R/\mathfrak q}(f_\psi)
$$
by our first application of the key Lemma \ref{lemma-key-lemma}.

\medskip\noindent
Next, let us compute the multiplicity of the periodic complex
\begin{eqnarray*}
e_R(M, \varphi, \psi) & = &
\text{length}_R(K_\varphi/I_\psi) - \text{length}_R(K_\psi/I_\varphi) \\
& = &
\text{length}_R(
\langle x_1, \ldots, x_b\rangle/
\langle s_1, \ldots, s_b\rangle)
+ k_\varphi - i_\psi \\
& & -
\text{length}_R(
\langle t_1, \ldots, t_a\rangle/
\langle y_1, \ldots, y_a\rangle)
- k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + k_\varphi - i_\psi - k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + m_\varphi - m_\psi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + \delta_\psi - \delta_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(f_\psi g/f_\varphi h)
\end{eqnarray*}
where we used the key Lemma \ref{lemma-key-lemma} twice in the third equality.
By our computation of $\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
this proves the proposition.
\end{proof}

\noindent
In most applications the following lemma suffices.

\begin{lemma}
\label{lemma-application-herbrand-quotient}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module, and let $\psi : M \to M$ be an
$R$-module map. Assume that
\begin{enumerate}
\item $\Ker(\psi)$ and $\Coker(\psi)$ have finite length, and
\item $\dim(\text{Supp}(M)) \leq 1$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$
and denote $f_i \in \kappa(\mathfrak q_i)^*$ the element such that
$\det_{\kappa(\mathfrak q_i)}(\psi_{\mathfrak q_i}) :
\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})
\to \det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})$
is multiplication by $f_i$. Then
we have
$$
\text{length}_R(\Coker(\psi))
-
\text{length}_R(\Ker(\psi))
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(f_i).
$$
\end{lemma}

\begin{proof}
Recall that $H^0(M, 0, \psi) = \Coker(\psi)$ and
$H^1(M, 0, \psi) = \Ker(\psi)$, see remarks above
Definition \ref{definition-periodic-length}.
The lemma follows by combining
Proposition \ref{proposition-length-determinant-periodic-complex} with
Lemma \ref{lemma-periodic-determinant-easy-case}.

\medskip\noindent
Alternative proof. Reduce to the case
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$
as in the proof of
Proposition \ref{proposition-length-determinant-periodic-complex}.
Then directly combine
Lemmas \ref{lemma-key-lemma} and
\ref{lemma-good-sequence-exists}
to prove this specific case of
Proposition \ref{proposition-length-determinant-periodic-complex}.
There is much less bookkeeping in this case, and the reader is
encouraged to work this out. Details omitted.
\end{proof}











\section{Application to tame symbol}
\label{section-application-tame-symbol}

\noindent
In this section we apply the results above to show the following key lemma.
This lemma is a low degree case of the statement that there is a complex
for Milnor K-theory similar to the Gersten-Quillen complex in Quillen's
K-theory. See \cite{Kato-Milnor-K}.

\begin{lemma}[Key Lemma]
\label{lemma-secondary-ramification}
\begin{reference}
When $A$ is an excellent ring this is \cite[Proposition 1]{Kato-Milnor-K}.
\end{reference}
Let $A$ be a $2$-dimensional Noetherian local domain.
Let $K = f.f.(A)$. Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(d_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(d_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height one prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $d_{A_{\mathfrak q}}(f, g) = 1$ by
Lemma \ref{lemma-symbol-when-one-is-a-unit}.
\end{lemma}

\begin{proof}
Since the tame symbols $d_{A_{\mathfrak q}}(f, g)$ are additive
(Lemma \ref{lemma-multiplicativity-symbol}) and the order
functions $\text{ord}_{A/\mathfrak q}$
are additive (Algebra, Lemma \ref{algebra-lemma-ord-additive})
it suffices to prove the formula when $f = a \in A$ and
$g = b \in A$. In this case we see that we have to show
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\det\nolimits_\kappa(A_{\mathfrak q}/(ab), a, b))
= 0
$$
By Proposition \ref{proposition-length-determinant-periodic-complex}
this is equivalent to showing that
$$
e_A(A/(ab), a, b) = 0.
$$
Since the complex
$A/(ab) \xrightarrow{a} A/(ab) \xrightarrow{b} A/(ab) \xrightarrow{a} A/(ab)$
is exact we win.
\end{proof}






















\section{Setup}
\label{section-setup}

\noindent
We will throughout work over a locally Noetherian universally
catenary base $S$ endowed with a dimension function $\delta$.
Although it is likely possible to generalize (parts of) the
discussion in the chapter, it seems that this is a good first
approximation. We usually do not assume our schemes are
separated or quasi-compact. Many interesting algebraic stacks
are non-separated and/or non-quasi-compact and this is a good
case study to see how to develop a reasonable theory for those as well.
In order to reference these hypotheses we give it a number.

\begin{situation}
\label{situation-setup}
Here $S$ is a locally Noetherian, and universally catenary scheme.
Moreover, we assume $S$ is endowed with a dimension function
$\delta : S \longrightarrow \mathbf{Z}$.
\end{situation}

\noindent
See Morphisms, Definition \ref{morphisms-definition-universally-catenary}
for the notion of a universally catenary scheme, and see
Topology, Definition \ref{topology-definition-dimension-function}
for the notion of a dimension function. Recall that any locally
Noetherian catenary scheme locally has a dimension function, see
Properties, Lemma \ref{properties-lemma-catenary-dimension-function}.
Moreover, there are lots of schemes which are universally catenary,
see Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Any scheme $X$ locally of finite type over $S$ is locally Noetherian
and catenary. In fact, $X$ has a canonical dimension function
$$
\delta = \delta_{X/S} : X \longrightarrow \mathbf{Z}
$$
associated to $(f : X \to S, \delta)$ given by the rule
$\delta_{X/S}(x) = \delta(f(x)) + \text{trdeg}_{\kappa(f(x))}\kappa(x)$.
See Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
Moreover, if $h : X \to Y$ is a morphism of schemes locally of finite
type over $S$, and $x \in X$, $y = h(x)$,
then obviously
$\delta_{X/S}(x) = \delta_{Y/S}(y) + \text{trdeg}_{\kappa(y)}\kappa(x)$.
We will freely use this function and its properties in the following.

\medskip\noindent
Here are the basic examples of setups as above.
In fact, the main interest lies in the case where the base
is the spectrum of a field, or the case where the base
is the spectrum of a Dedekind ring (e.g.\ $\mathbf{Z}$,
or a discrete valuation ring).

\begin{example}
\label{example-field}
Here $S = \Spec(k)$ and $k$ is a field.
We set $\delta(pt) = 0$ where $pt$ indicates the unique point of $S$.
The pair $(S, \delta)$ is an example of a situation as in
Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-domain-dimension-1}
Here $S = \Spec(A)$, where $A$ is a Noetherian domain
of dimension $1$.
For example we could consider $A = \mathbf{Z}$.
We set $\delta(\mathfrak p) = 0$ if
$\mathfrak p$ is a maximal ideal and $\delta(\mathfrak p) = 1$
if $\mathfrak p = (0)$ corresponds to the generic point.
This is an example of Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\noindent
In good cases $\delta$ corresponds to the dimension function.

\begin{lemma}
\label{lemma-delta-is-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Assume in addition $S$ is a Jacobson scheme, and $\delta(s) = 0$ for every
closed point $s$ of $S$. Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be an integral closed subscheme and let
$\xi \in Z$ be its generic point. The following integers are the same:
\begin{enumerate}
\item $\delta_{X/S}(\xi)$,
\item $\dim(Z)$, and
\item $\dim(\mathcal{O}_{Z, z})$ where $z$ is a closed point of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X \to S$, $\xi \in Z \subset X$ be as in the lemma.
Since $X$ is locally of finite type over $S$ we see that
$X$ is Jacobson, see
Morphisms, Lemma \ref{morphisms-lemma-Jacobson-universally-Jacobson}.
Hence closed points of $X$ are dense in every closed subset of $Z$
and map to closed points of $S$. Hence given any chain
of irreducible closed subsets of $Z$ we can end it with a closed point of $Z$.
It follows that $\dim(Z) = \sup_z(\dim(\mathcal{O}_{Z, z})$
(see Properties, Lemma \ref{properties-lemma-codimension-local-ring})
where $z \in Z$ runs over the closed points of $Z$.
Note that $\dim(\mathcal{O}_{Z, z}) = \delta(\xi) - \delta(z))$
by the properties of a dimension function.
For each closed $z \in Z$ the field extension
$\kappa(z) \supset \kappa(f(z))$ is finite, see Morphisms,
Lemma \ref{morphisms-lemma-jacobson-finite-type-points}.
Hence $\delta_{X/S}(z) = \delta(f(z)) = 0$ for $z \in Z$ closed.
It follows that all three integers are equal.
\end{proof}

\noindent
In the situation of the lemma above the
value of $\delta$ at the generic point of a closed irreducible subset
is the dimension of the irreducible closed subset.
However, in general we cannot expect the equality to hold.
For example if $S = \Spec(\mathbf{C}[[t]])$ and
$X = \Spec(\mathbf{C}((t)))$ then we would get
$\delta(x) = 1$ for the unique point of $X$, but $\dim(X) = 0$.
Still we want to think of $\delta_{X/S}$ as giving the
dimension of the irreducible closed subschemes. Thus we introduce
the following terminology.

\begin{definition}
\label{definition-delta-dimension}
Let $(S, \delta)$ as in Situation \ref{situation-setup}.
For any scheme $X$ locally of finite type over $S$
and any irreducible closed subset $Z \subset X$ we define
$$
\dim_\delta(Z) = \delta(\xi)
$$
where $\xi \in Z$ is the generic point of $Z$.
We will call this the {\it $\delta$-dimension of $Z$}.
If $Z$ is a closed subscheme of $X$, then we define
$\dim_\delta(Z)$ as the supremum of the $\delta$-dimensions
of its irreducible components.
\end{definition}







\section{Cycles}
\label{section-cycles}

\noindent
Since we are not assuming our schemes are quasi-compact we have
to be a little careful when defining cycles. We have to allow
infinite sums because a rational function may have infinitely many
poles for example. In any case, if $X$ is quasi-compact then a
cycle is a finite sum as usual.

\begin{definition}
\label{definition-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item A {\it cycle on $X$} is a formal sum
$$
\alpha = \sum n_Z [Z]
$$
where the sum is over integral closed subschemes $Z \subset X$,
each $n_Z \in \mathbf{Z}$, and the collection
$\{Z; n_Z \not = 0\}$ is locally finite
(Topology, Definition \ref{topology-definition-locally-finite}).
\item A {\it $k$-cycle}, on $X$ is
a cycle
$$
\alpha = \sum n_Z [Z]
$$
where $n_Z \not = 0 \Rightarrow \dim_\delta(Z) = k$.
\item The abelian group of all $k$-cycles on $X$ is denoted $Z_k(X)$.
\end{enumerate}
\end{definition}

\noindent
In other words, a $k$-cycle on $X$
is a locally finite formal $\mathbf{Z}$-linear
combination of integral closed subschemes of $\delta$-dimension $k$.
Addition of $k$-cycles $\alpha = \sum n_Z[Z]$ and
$\beta = \sum m_Z[Z]$ is given by
$$
\alpha + \beta = \sum (n_Z + m_Z)[Z],
$$
i.e., by adding the coefficients.




\section{Cycle associated to a closed subscheme}
\label{section-cycle-of-closed-subscheme}

\begin{lemma}
\label{lemma-multiplicity-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item Let $Z' \subset Z$ be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi} < \infty
$$
\item If $\dim_\delta(Z) \leq k$ and $\xi \in Z$ with
$\delta(\xi) = k$, then $\xi$ is a generic point of an
irreducible component of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $Z' \subset Z$, $\xi \in Z'$ be as in (1).
Then $\dim(\mathcal{O}_{Z, \xi}) = 0$ (for example by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}).
Hence $\mathcal{O}_{Z, \xi}$ is Noetherian
local ring of dimension zero, and hence has finite length over
itself (see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}).
Hence, it also has finite length over $\mathcal{O}_{X, \xi}$, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.

\medskip\noindent
Assume $\xi \in Z$ and $\delta(\xi) = k$.
Consider the closure $Z' = \overline{\{\xi\}}$. It is an irreducible
closed subscheme with $\dim_\delta(Z') = k$ by definition.
Since $\dim_\delta(Z) = k$ it must be an irreducible component
of $Z$. Hence we see (2) holds.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-closed-subscheme}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item For any irreducible component $Z' \subset Z$ with generic point $\xi$
the integer
$m_{Z', Z} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi}$
(Lemma \ref{lemma-multiplicity-finite})
is called the {\it multiplicity of $Z'$ in $Z$}.
\item Assume $\dim_\delta(Z) \leq k$.
The {\it $k$-cycle associated to $Z$} is
$$
[Z]_k
=
\sum m_{Z', Z}[Z']
$$
where the sum is over the irreducible components of $Z$
of $\delta$-dimension $k$. (This is a $k$-cycle by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[Z]_k$ if the $\delta$-dimension
of $Z$ does not exceed $k$. In other words, by convention, if we write
$[Z]_k$ then this implies that $\dim_\delta(Z) \leq k$.



\section{Cycle associated to a coherent sheaf}
\label{section-cycle-of-coherent-sheaf}



\begin{lemma}
\label{lemma-length-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The collection of irreducible components of the support of
$\mathcal{F}$ is locally finite.
\item Let $Z' \subset \text{Supp}(\mathcal{F})$
be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi < \infty
$$
\item If $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$
and $\xi \in Z$ with $\delta(\xi) = k$, then $\xi$ is a
generic point of an irreducible component of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
the support $Z$ of $\mathcal{F}$ is a closed subset of $X$.
We may think of $Z$ as a reduced closed subscheme of $X$
(Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
Hence (1) follows from
Divisors, Lemma \ref{divisors-lemma-components-locally-finite} applied to $Z$
and (3) follows from
Lemma \ref{lemma-multiplicity-finite} applied to $Z$.

\medskip\noindent
Let $\xi \in Z'$ be as in (2). In this case for any specialization
$\xi' \leadsto \xi$ in $X$ we have $\mathcal{F}_{\xi'} = 0$.
Recall that the non-maximal primes of $\mathcal{O}_{X, \xi}$ correspond
to the points of $X$ specializing to $\xi$
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\mathcal{F}_\xi$ is a finite $\mathcal{O}_{X, \xi}$-module
whose support is $\{\mathfrak m_\xi\}$. Hence it has finite length
by Algebra, Lemma \ref{algebra-lemma-support-point}.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-coherent-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any irreducible component $Z' \subset \text{Supp}(\mathcal{F})$
with generic point $\xi$ the integer
$m_{Z', \mathcal{F}} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi$
(Lemma \ref{lemma-length-finite})
is called the {\it multiplicity of $Z'$ in $\mathcal{F}$}.
\item Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
The {\it $k$-cycle associated to $\mathcal{F}$} is
$$
[\mathcal{F}]_k
=
\sum m_{Z', \mathcal{F}}[Z']
$$
where the sum is over the irreducible components of
$\text{Supp}(\mathcal{F})$ of $\delta$-dimension $k$.
(This is a $k$-cycle by Lemma \ref{lemma-length-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[\mathcal{F}]_k$
if $\mathcal{F}$ is coherent and the $\delta$-dimension
of $\text{Supp}(\mathcal{F})$ does not exceed $k$. In other words,
by convention, if we write $[\mathcal{F}]_k$ then this implies that
$\mathcal{F}$ is coherent on $X$ and
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-cycle-closed-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
If $\dim_\delta(Z) \leq k$, then $[Z]_k = [{\mathcal O}_Z]_k$.
\end{lemma}

\begin{proof}
This is because in this case the multiplicities $m_{Z', Z}$ and
$m_{Z', \mathcal{O}_Z}$ agree by definition.
\end{proof}

\begin{lemma}
\label{lemma-additivity-sheaf-cycle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of coherent sheaves on $X$.
Assume that the $\delta$-dimension of the supports
of $\mathcal{F}$, $\mathcal{G}$, and $\mathcal{H}$ is $\leq k$.
Then $[\mathcal{G}]_k = [\mathcal{F}]_k + [\mathcal{H}]_k$.
\end{lemma}

\begin{proof}
Follows immediately from additivity of lengths, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
\end{proof}









\section{Preparation for proper pushforward}
\label{section-preparation-pushforward}

\begin{lemma}
\label{lemma-equal-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $X$, $Y$ integral and $\dim_\delta(X) = \dim_\delta(Y)$.
Then either $f(X)$ is contained in a proper closed subscheme
of $Y$, or $f$ is dominant and the extension of function fields
$R(Y) \subset R(X)$ is finite.
\end{lemma}

\begin{proof}
The closure $\overline{f(X)} \subset Y$ is irreducible as $X$
is irreducible (Topology, Lemmas
\ref{topology-lemma-image-irreducible-space} and
\ref{topology-lemma-irreducible}).
If $\overline{f(X)} \not = Y$, then we are done.
If $\overline{f(X)} = Y$, then $f$ is dominant and by
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}
we see that the generic point $\eta_Y$ of $Y$ is in the image of $f$.
Of course this implies that $f(\eta_X) = \eta_Y$, where $\eta_X \in X$
is the generic point of $X$. Since $\delta(\eta_X) = \delta(\eta_Y)$
we see that $R(Y) = \kappa(\eta_Y) \subset \kappa(\eta_X) = R(X)$
is an extension of transcendence degree $0$.
Hence $R(Y) \subset R(X)$ is a finite extension by
Morphisms, Lemma \ref{morphisms-lemma-finite-degree}
(which applies by
Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is quasi-compact, and $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $X$.
Then $\{\overline{f(Z_i)}\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open subset.
Since $f$ is quasi-compact the open $f^{-1}(V)$ is
quasi-compact. Hence the set
$\{i \in I \mid Z_i \cap f^{-1}(V) \not = \emptyset \}$
is finite by a simple topological argument which we omit.
Since this is the same as the set
$$
\{i \in I \mid f(Z_i) \cap V \not = \emptyset \} =
\{i \in I \mid \overline{f(Z_i)} \cap V \not = \emptyset \}
$$
the lemma is proved.
\end{proof}









\section{Proper pushforward}
\label{section-proper-pushforward}

\begin{definition}
\label{definition-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = k$. We define
$$
f_*[Z] =
\left\{
\begin{matrix}
0 & \text{if} & \dim_\delta(f(Z))< k, \\
\deg(Z/f(Z)) [f(Z)] & \text{if} & \dim_\delta(f(Z)) = k.
\end{matrix}
\right.
$$
Here we think of $f(Z) \subset Y$ as an integral closed subscheme.
The degree of $Z$ over $f(Z)$ is finite if
$\dim_\delta(f(Z)) = \dim_\delta(Z)$
by Lemma \ref{lemma-equal-dimension}.
\item Let $\alpha = \sum n_Z [Z]$ be a $k$-cycle on $X$. The
{\it pushforward} of $\alpha$ as the sum
$$
f_* \alpha = \sum n_Z f_*[Z]
$$
where each $f_*[Z]$ is defined as above. The sum is locally finite
by Lemma \ref{lemma-quasi-compact-locally-finite} above.
\end{enumerate}
\end{definition}

\noindent
By definition the proper pushforward of cycles
$$
f_* : Z_k(X) \longrightarrow Z_k(Y)
$$
is a homomorphism of abelian groups. It turns $X \mapsto Z_k(X)$
into a covariant functor on the category of schemes locally of
finite type over $S$ with morphisms equal to proper morphisms.

\begin{lemma}
\label{lemma-compose-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$, and $Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be proper morphisms.
Then $g_* \circ f_* = (g \circ f)_*$ as maps $Z_k(X) \to Z_k(Z)$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Consider $W' = f(Z) \subset Y$ and $W'' = g(f(Z)) \subset Z$.
Since $f$, $g$ are proper we see that $W'$ (resp.\ $W''$) is
an integral closed subscheme of $Y$ (resp.\ $Z$).
We have to show that $g_*(f_*[W]) = (f \circ g)_*[W]$.
If $\dim_\delta(W'') < k$, then both sides are zero.
If $\dim_\delta(W'') = k$, then we see the induced morphisms
$$
W \longrightarrow
W' \longrightarrow
W''
$$
both satisfy the hypotheses of Lemma \ref{lemma-equal-dimension}. Hence
$$
g_*(f_*[W]) = \deg(W/W')\deg(W'/W'')[W''],
\quad
(f \circ g)_*[W] = \deg(W/W'')[W''].
$$
Then we can apply
Morphisms, Lemma \ref{morphisms-lemma-degree-composition}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-cycle-push-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a proper morphism of schemes which are
locally of finite type over $S$.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with $\dim_\delta(Z) \leq k$.
Then
$$
f_*[Z]_k = [f_*{\mathcal O}_Z]_k.
$$
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ such that
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$. Then
$$
f_*[\mathcal{F}]_k = [f_*{\mathcal F}]_k.
$$
\end{enumerate}
Note that the statement makes sense since $f_*\mathcal{F}$ and
$f_*\mathcal{O}_Z$ are coherent $\mathcal{O}_Y$-modules by
Cohomology of Schemes, Proposition
\ref{coherent-proposition-proper-pushforward-coherent}.
\end{lemma}

\begin{proof}
Part (1) follows from (2) and Lemma \ref{lemma-cycle-closed-coherent}.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
there exists a closed subscheme $i : Z \to X$ and a coherent
$\mathcal{O}_Z$-module $\mathcal{G}$ such that
$i_*\mathcal{G} \cong \mathcal{F}$ and such that the support
of $\mathcal{F}$ is $Z$. Let $Z' \subset Y$ be the scheme theoretic image
of $f|_Z : Z \to Y$. Consider the commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_i \ar[d]_{f|_Z} &
X \ar[d]^f \\
Z' \ar[r]^{i'} & Y
}
$$
We have $f_*\mathcal{F} = f_*i_*\mathcal{G} = i'_*(f|_Z)_*\mathcal{G}$
by going around the diagram in two ways. Suppose we know the result holds
for closed immersions and for $f|_Z$. Then we see that
$$
f_*[\mathcal{F}]_k = f_*i_*[\mathcal{G}]_k
= (i')_*(f|_Z)_*[\mathcal{G}]_k =
(i')_*[(f|_Z)_*\mathcal{G}]_k =
[(i')_*(f|_Z)_*\mathcal{G}]_k = [f_*\mathcal{F}]_k
$$
as desired. The case of a closed immersion is straightforward (omitted).
Note that $f|_Z : Z \to Z'$ is a dominant morphism (see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Thus we have reduced to the case where
$\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.

\medskip\noindent
Assume $\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.
Since $f$ is dominant, for every irreducible component $Z \subset Y$
with generic point $\eta$ there exists a point $\xi \in X$ such
that $f(\xi) = \eta$. Hence $\delta(\eta) \leq \delta(\xi) \leq k$.
Thus we see that in the expressions
$$
f_*[\mathcal{F}]_k = \sum n_Z[Z],
\quad
\text{and}
\quad
[f_*\mathcal{F}]_k = \sum m_Z[Z].
$$
whenever $n_Z \not = 0$, or $m_Z \not = 0$ the integral closed
subscheme $Z$ is actually an irreducible component of $Y$ of
$\delta$-dimension $k$. Pick such an integral closed subscheme
$Z \subset Y$ and denote $\eta$ its generic point. Note that for
any $\xi \in X$ with $f(\xi) = \eta$ we have $\delta(\xi) \geq k$
and hence $\xi$ is a generic point of an irreducible component
of $X$ of $\delta$-dimension $k$ as well
(see Lemma \ref{lemma-multiplicity-finite}). Since $f$ is quasi-compact
and $X$ is locally Noetherian, there can be only finitely many of
these and hence $f^{-1}(\{\eta\})$ is finite.
By Morphisms, Lemma \ref{morphisms-lemma-generically-finite} there exists
an open neighbourhood $\eta \in V \subset Y$ such that $f^{-1}(V) \to V$
is finite. Replacing $Y$ by $V$ and $X$ by $f^{-1}(V)$ we reduce to the
case where $Y$ is affine, and $f$ is finite.

\medskip\noindent
Write $Y = \Spec(R)$ and $X = \Spec(A)$ (possible as
a finite morphism is affine).
Then $R$ and $A$ are Noetherian rings and $A$ is finite over $R$.
Moreover $\mathcal{F} = \widetilde{M}$ for some finite $A$-module
$M$. Note that $f_*\mathcal{F}$ corresponds to $M$ viewed as an $R$-module.
Let $\mathfrak p \subset R$ be the minimal prime corresponding
to $\eta \in Y$. The coefficient of $Z$ in $[f_*\mathcal{F}]_k$
is clearly $\text{length}_{R_{\mathfrak p}}(M_{\mathfrak p})$.
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the primes of $A$
lying over $\mathfrak p$. Then $A_{\mathfrak p} = \prod A_{\mathfrak q_i}$
since $A_{\mathfrak p}$ is an Artinian ring being finite over the
dimension zero local Noetherian ring $R_{\mathfrak p}$.
Clearly the coefficient of $Z$ in $f_*[\mathcal{F}]_k$ is
$$
\sum\nolimits_{i = 1, \ldots, t}
[\kappa(\mathfrak q_i) : \kappa(\mathfrak p)]
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
$$
Hence the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}




















\section{Preparation for flat pullback}
\label{section-preparation-flat-pullback}


\noindent
Recall that a morphism $f : X \to Y$ which is locally of finite type
is said to have relative dimension $r$ if every nonempty fibre
is equidimensional of dimension $r$. See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.

\begin{lemma}
\label{lemma-flat-inverse-image-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
For any closed subset $Z \subset Y$ we have
$$
\dim_\delta(f^{-1}(Z)) = \dim_\delta(Z) + r.
$$
If $Z$ is irreducible and $Z' \subset f^{-1}(Z)$ is an irreducible
component, then $Z'$ dominates $Z$ and
$\dim_\delta(Z') = \dim_\delta(Z) + r$.
\end{lemma}

\begin{proof}
It suffices to prove the final statement.
We may replace $Y$ by the integral closed subscheme $Z$ and
$X$ by the scheme theoretic inverse image $f^{-1}(Z) = Z \times_Y X$.
Hence we may assume $Z = Y$ is integral and $f$ is a flat morphism
of relative dimension $r$. Since $Y$ is locally Noetherian the
morphism $f$ which is locally of finite type,
is actually locally of finite presentation. Hence
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
applies and we see that $f$ is open.
Let $\xi \in X$ be a generic point of an irreducible component
of $X$. By the openness of $f$ we see that $f(\xi)$ is the
generic point $\eta$ of $Z = Y$. Note that $\dim_\xi(X_\eta) = r$
by assumption that $f$ has relative dimension $r$. On the other
hand, since $\xi$ is a generic point of $X$ we see that
$\mathcal{O}_{X, \xi} = \mathcal{O}_{X_\eta, \xi}$ has only one
prime ideal and hence has dimension $0$. Thus by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that the transcendence
degree of $\kappa(\xi)$ over $\kappa(\eta)$ is $r$.
In other words, $\delta(\xi) = \delta(\eta) + r$ as desired.
\end{proof}

\noindent
Here is the lemma that we will use to prove that the flat pullback
of a locally finite collection of closed subschemes is locally finite.

\begin{lemma}
\label{lemma-inverse-image-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $Y$.
Then $\{f^{-1}(Z_i)\}_{i \in I}$ is a locally finite
collection of closed subsets of $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subset.
Since the image $f(U) \subset Y$ is a quasi-compact subset
there exists a quasi-compact open $V \subset Y$ such that
$f(U) \subset V$. Note that
$$
\{i \in I \mid f^{-1}(Z_i) \cap U \not = \emptyset \}
\subset
\{i \in I \mid Z_i \cap V \not = \emptyset \}.
$$
Since the right hand side is finite by assumption we win.
\end{proof}



\section{Flat pullback}
\label{section-flat-pullback}

\noindent
In the following we use $f^{-1}(Z)$ to denote the
{\it scheme theoretic inverse image} of a closed subscheme
$Z \subset Y$ for a morphism of schemes $f : X \to Y$.
We recall that the scheme theoretic inverse image is the fibre product
$$
\xymatrix{
f^{-1}(Z) \ar[r] \ar[d] & X \ar[d] \\
Z \ar[r] & Y
}
$$
and it is also the closed subscheme of $X$ cut out by the
quasi-coherent sheaf of ideals $f^{-1}(\mathcal{I})\mathcal{O}_X$, if
$\mathcal{I} \subset \mathcal{O}_Y$ is the quasi-coherent sheaf of ideals
corresponding to $Z$ in $Y$.
(This is discussed in
Schemes, Section \ref{schemes-section-closed-immersion} and
Lemma \ref{schemes-lemma-fibre-product-immersion}
and Definition \ref{schemes-definition-inverse-image-closed-subscheme}.)

\begin{definition}
\label{definition-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. We define $f^*[Z]$ to be the
$(k+r)$-cycle on $X$ to the scheme theoretic inverse image
$$
f^*[Z] = [f^{-1}(Z)]_{k+r}.
$$
This makes sense since $\dim_\delta(f^{-1}(Z)) = k + r$
by Lemma \ref{lemma-flat-inverse-image-dimension}.
\item Let $\alpha = \sum n_i [Z_i]$ be
a $k$-cycle on $Y$. The {\it flat pullback of $\alpha$ by $f$}
is the sum
$$
f^* \alpha = \sum n_i f^*[Z_i]
$$
where each $f^*[Z_i]$ is defined as above.
The sum is locally finite by Lemma \ref{lemma-inverse-image-locally-finite}.
\item We denote $f^* : Z_k(Y) \to Z_{k + r}(X)$ the map of abelian
groups so obtained.
\end{enumerate}
\end{definition}

\noindent
An open immersion is flat. This is an important though trivial special
case of a flat morphism. If $U \subset X$ is open then sometimes the
pullback by $j : U \to X$ of a cycle is called the {\it restriction} of the
cycle to $U$. Note that in this case the maps
$$
j^* : Z_k(X) \longrightarrow Z_k(U)
$$
are all {\it surjective}. The reason is that given any integral closed
subscheme $Z' \subset U$, we can take the closure of $Z$ of $Z'$ in $X$
and think of it as a reduced closed subscheme of $X$ (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
And clearly $Z \cap U = Z'$, in other words
$j^*[Z] = [Z']$ whence the surjectivity. In fact a little bit more
is true.

\begin{lemma}
\label{lemma-exact-sequence-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
For every $k \in \mathbf{Z}$ the sequence
$$
\xymatrix{
Z_k(Y) \ar[r]^{i_*} & Z_k(X) \ar[r]^{j^*} & Z_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
First assume $X$ is quasi-compact. Then $Z_k(X)$ is a free $\mathbf{Z}$-module
with basis given by the elements $[Z]$ where $Z \subset X$ is integral
closed of $\delta$-dimension $k$. Such a basis element maps
either to the basis element $[Z \cap U]$ or to zero if $Z \subset Y$.
Hence the lemma is clear in this case. The general case is similar
and the proof is omitted.
\end{proof}

\begin{lemma}
\label{lemma-compose-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y, Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be flat morphisms of relative dimensions
$r$ and $s$. Then $g \circ f$ is flat of relative dimension
$r + s$ and
$$
f^* \circ g^* = (g \circ f)^*
$$
as maps $Z_k(Z) \to Z_{k + r + s}(X)$.
\end{lemma}

\begin{proof}
The composition is flat of relative dimension $r + s$ by
Morphisms, Lemma \ref{morphisms-lemma-composition-relative-dimension-d}.
Suppose that
\begin{enumerate}
\item $W \subset Z$ is a closed integral subscheme of $\delta$-dimension $k$,
\item $W' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s$ with $W' \subset g^{-1}(W)$, and
\item $W'' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s + r$ with $W'' \subset f^{-1}(W')$.
\end{enumerate}
We have to show that the coefficient $n$ of $[W'']$ in
$(g \circ f)^*[W]$ agrees with the coefficient $m$ of
$[W'']$ in $f^*(g^*[W])$. That it suffices to check the lemma in these
cases follows from Lemma \ref{lemma-flat-inverse-image-dimension}.
Let $\xi'' \in W''$, $\xi' \in W'$
and $\xi \in W$ be the generic points. Consider the local rings
$A = \mathcal{O}_{Z, \xi}$, $B = \mathcal{O}_{Y, \xi'}$
and $C = \mathcal{O}_{X, \xi''}$. Then we have local flat ring maps
$A \to B$, $B \to C$ and moreover
$$
n = \text{length}_C(C/\mathfrak m_AC),
\quad
\text{and}
\quad
m = \text{length}_C(C/\mathfrak m_BC) \text{length}_B(B/\mathfrak m_AB)
$$
Hence the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be a closed subscheme with
$\dim_\delta(Z) \leq k$. Then we have
$\dim_\delta(f^{-1}(Z)) \leq k + r$
and $[f^{-1}(Z)]_{k + r} = f^*[Z]_k$ in $Z_{k + r}(X)$.
\item Let $\mathcal{F}$ be a coherent sheaf on $Y$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
Then we have $\dim_\delta(\text{Supp}(f^*\mathcal{F})) \leq k + r$
and
$$
f^*[{\mathcal F}]_k = [f^*{\mathcal F}]_{k+r}
$$
in $Z_{k + r}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that $f^*\mathcal{O}_Z = \mathcal{O}_{f^{-1}(Z)}$.

\medskip\noindent
Proof of (2).
As $X$, $Y$ are locally Noetherian we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $f^*\mathcal{F}$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $f^*\mathcal{F}$ is coherent
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset Y$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X$ be
an integral closed subscheme of dimension $k + r$ mapping into $W$
under $f$. We have to show that the coefficient $n$ of
$[W]$ in $f^*[{\mathcal F}]_k$ agrees with the coefficient
$m$ of $[W]$ in $[f^*{\mathcal F}]_{k+r}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{Y, \xi}$, $B = \mathcal{O}_{X, \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $f^*\mathcal{F}_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-module}.
\end{proof}



\section{Push and pull}
\label{section-push-pull}

\noindent
In this section we verify that proper pushforward and flat pullback
are compatible when this makes sense. By the work we did above this
is a consequence of cohomology and base change.

\begin{lemma}
\label{lemma-flat-pullback-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a fibre product diagram of schemes locally of finite type over $S$.
Assume $f : X \to Y$ proper and $g : Y' \to Y$ flat of relative dimension $r$.
Then also $f'$ is proper and $g'$ is flat of relative dimension $r$.
For any $k$-cycle $\alpha$ on $X$ we have
$$
g^*f_*\alpha = f'_*(g')^*\alpha
$$
in $Z_{k + r}(Y')$.
\end{lemma}

\begin{proof}
The assertion that $f'$ is proper follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
The assertion that $g'$ is flat of relative dimension $r$ follows from
Morphisms, Lemmas \ref{morphisms-lemma-base-change-relative-dimension-d}
and \ref{morphisms-lemma-base-change-flat}.
It suffices to prove the equality of cycles when $\alpha = [W]$
for some integral closed subscheme $W \subset X$ of $\delta$-dimension $k$.
Note that in this case we have $\alpha = [\mathcal{O}_W]_k$, see
Lemma \ref{lemma-cycle-closed-coherent}.
By Lemmas \ref{lemma-cycle-push-sheaf} and
\ref{lemma-pullback-coherent} it therefore suffices
to show that $f'_*(g')^*\mathcal{O}_W$ is isomorphic to
$g^*f_*\mathcal{O}_W$. This follows from cohomology and
base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a finite locally free morphism
of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then $f$ is both proper and flat of relative dimension $0$, and
$$
f_*f^*\alpha = d\alpha
$$
for every $\alpha \in Z_k(Y)$.
\end{lemma}

\begin{proof}
A finite locally free morphism is flat and finite by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat},
and a finite morphism is proper
by Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
We omit showing that a finite
morphism has relative dimension $0$. Thus the formula makes sense.
To prove it, let $Z \subset Y$ be an integral closed subscheme
of $\delta$-dimension $k$. It suffices to prove the formula
for $\alpha = [Z]$. Since the base change of a finite locally free
morphism is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-locally-free})
we see that $f_*f^*\mathcal{O}_Z$ is a finite locally free sheaf of
rank $d$ on $Z$. Hence
$$
f_*f^*[Z] = f_*f^*[\mathcal{O}_Z]_k =
[f_*f^*\mathcal{O}_Z]_k = d[Z]
$$
where we have used Lemmas \ref{lemma-pullback-coherent} and
\ref{lemma-cycle-push-sheaf}.
\end{proof}








\section{Preparation for principal divisors}
\label{section-preparation-principal-divisors}

\noindent
Some of the material in this section partially overlaps with the
discussion in Divisors, Section \ref{divisors-section-Weil-divisors}.

\begin{lemma}
\label{lemma-divisor-delta-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral.
\begin{enumerate}
\item If $Z \subset X$ is an integral closed subscheme, then
the following are equivalent:
\begin{enumerate}
\item $Z$ is a prime divisor,
\item $Z$ has codimension $1$ in $X$, and
\item $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\item If $Z$ is an irreducible component of an effective Cartier
divisor on $X$, then $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the definition of a prime divisor
(Divisors, Definition \ref{divisors-definition-Weil-divisor})
and the definition of a dimension function
(Topology, Definition \ref{topology-definition-dimension-function}).
Let $\xi \in Z$ be the generic point of an irreducible component $Z$ of
an effective Cartier divisor $D \subset X$.
Then $\dim(\mathcal{O}_{D, \xi}) = 0$ and
$\mathcal{O}_{D, \xi} = \mathcal{O}_{X, \xi}/(f)$ for some
nonzerodivisor $f \in \mathcal{O}_{X, \xi}$ (Divisors,
Lemma \ref{divisors-lemma-effective-Cartier-in-points}).
Then $\dim(\mathcal{O}_{X, \xi}) = 1$ by
Algebra, Lemma \ref{algebra-lemma-one-equation}. Hence $Z$ is as in (1) by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codimension-one}
Let $f : X \to Y$ be a morphism of schemes.
Let $\xi \in Y$ be a point.
Assume that
\begin{enumerate}
\item $X$, $Y$ are integral,
\item $Y$ is locally Noetherian
\item $f$ is proper, dominant and $R(X) \subset R(Y)$ is finite, and
\item $\dim(\mathcal{O}_{Y, \xi}) = 1$.
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $\xi$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
This lemma is a special case of
Varieties, Lemma \ref{varieties-lemma-finite-in-codim-1}.
Here is a direct argument in this case.
By Cohomology of Schemes,
Lemma \ref{coherent-lemma-proper-finite-fibre-finite-in-neighbourhood}
it suffices to prove that $f^{-1}(\{\xi\})$ is finite.
We replace $Y$ by an affine open, say $Y = \Spec(R)$.
Note that $R$ is Noetherian, as $Y$ is assumed locally Noetherian.
Since $f$ is proper it is quasi-compact. Hence we can find a finite
affine open covering $X = U_1 \cup \ldots \cup U_n$ with
each $U_i = \Spec(A_i)$. Note that $R \to A_i$ is a
finite type injective homomorphism of domains with
$f.f.(R) \subset f.f.(A_i)$ finite. Thus the lemma follows
from Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1}.
\end{proof}


\section{Principal divisors}
\label{section-principal-divisors}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-principal-divisor}
in our current setup.

\begin{definition}
\label{definition-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f \in R(X)^*$. The {\it principal divisor
associated to $f$} is the $(n - 1)$-cycle
$$
\text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z]
$$
defined in Divisors, Definition \ref{divisors-definition-principal-divisor}.
This makes sense because prime divisors have $\delta$-dimension $n - 1$ by
Lemma \ref{lemma-divisor-delta-dimension}.
\end{definition}

\noindent
In the situation of the definition for $f, g \in R(X)^*$ we have
$$
\text{div}_X(fg) = \text{div}_X(f) + \text{div}_X(g)
$$
in $Z_{n - 1}(X)$. See Divisors, Lemma \ref{divisors-lemma-div-additive}.
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-rational-equivalence}.

\begin{lemma}
\label{lemma-flat-pullback-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $g \in R(Y)^*$. Then
$$
f^*(\text{div}_Y(g)) = \text{div}_X(g)
$$
in $Z_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Note that since $f$ is flat it is dominant so that
$f$ induces an embedding $R(Y) \subset R(X)$, and hence
we may think of $g$ as an element of $R(X)^*$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n + r - 1$. Let $\xi \in Z$
be its generic point. If $\dim_\delta(f(Z)) > n - 1$,
then we see that the coefficient of $[Z]$ in the left and
right hand side of the equation is zero.
Hence we may assume that $Z' = \overline{f(Z)}$ is an
integral closed subscheme of $Y$ of $\delta$-dimension $n - 1$.
Let $\xi' = f(\xi)$. It is the generic point of $Z'$.
Set $A = \mathcal{O}_{Y, \xi'}$, $B = \mathcal{O}_{X, \xi}$.
The ring map $A \to B$ is a flat local homomorphism of
Noetherian local domains of dimension $1$.
We have $g \in f.f.(A)$. What we have to show is that
$$
\text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
=
\text{ord}_B(g).
$$
This follows from Algebra, Lemma \ref{algebra-lemma-pullback-module}
(details omitted).
\end{proof}











\section{Principal divisors and pushforward}
\label{section-two-fun}

\noindent
The first lemma implies that the pushforward of a principal
divisor along a generically finite morphism is a principal divisor.

\begin{lemma}
\label{lemma-proper-pushforward-alteration}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(X) = \dim_\delta(Y)$.
Let $p : X \to Y$ be a dominant proper morphism.
Let $f \in R(X)^*$. Set
$$
g = \text{Nm}_{R(X)/R(Y)}(f).
$$
Then we have
$p_*\text{div}(f) = \text{div}(g)$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in
$p_*\text{div}(f)$ and $\text{div}(g)$ are equal. We may apply
Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : X \to Y$ and the generic point $\xi \in Z$.
Hence we may replace $Y$ by an
affine open neighbourhood of $\xi$ and assume that $p : X \to Y$ is finite.
Write $Y = \Spec(R)$ and $X = \Spec(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an finite field extension $f.f.(R) \subset f.f.(A)$ of fraction fields.
Now we have $f \in f.f.(A)$, $g = \text{Nm}(f) \in f.f.(R)$,
and a prime $\mathfrak p \subset R$ with $\dim(R_{\mathfrak p}) = 1$.
The coefficient of $[Z]$ in $\text{div}_Y(g)$ is
$\text{ord}_{R_\mathfrak p}(g)$.
The coefficient of $[Z]$ in $p_*\text{div}_X(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
\end{proof}

\noindent
An important role in the discussion of principal divisors
is played by the ``universal'' principal divisor $[0] - [\infty]$
on $\mathbf{P}^1_S$. To make this more precise, let us denote
$$
D_0, D_\infty \subset
\mathbf{P}^1_S = \underline{\text{Proj}}_S(\mathcal{O}_S[T_0, T_1])
$$
the closed subscheme cut out by the section $T_1$, resp.\ $T_0$
of $\mathcal{O}(1)$. These are effective Cartier divisors, see
Divisors, Definition \ref{divisors-definition-effective-Cartier-divisor}
and Lemma \ref{divisors-lemma-characterize-OD}.
The following lemma says that loosely speaking we have
``$\text{div}(T_1/T_0) = [D_0] - [D_1]$'' and that this is the
universal principal divisor.

\begin{lemma}
\label{lemma-rational-function}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$. Let $f \in R(X)^*$.
Let $U \subset X$ be a nonempty open such that $f$
corresponds to a section $f \in \Gamma(U, \mathcal{O}_X^*)$.
Let $Y \subset X \times_S \mathbf{P}^1_S$ be the
closure of the graph of $f : U \to \mathbf{P}^1_S$.
Then
\begin{enumerate}
\item the projection morphism $p : Y \to X$ is proper,
\item $p|_{p^{-1}(U)} : p^{-1}(U) \to U$ is an isomorphism,
\item the pullbacks $Y_0 = q^{-1}D_0$ and $Y_\infty = q^{-1}D_\infty$
via the morphism $q : Y \to \mathbf{P}^1_S$ are defined
(Divisors, Definition
\ref{divisors-definition-pullback-effective-Cartier-divisor}),
\item we have
$$
\text{div}_Y(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\item we have
$$
\text{div}_X(f) = p_*\text{div}_Y(f)
$$
\item if we view $Y_0$ and $Y_\infty$ as closed subschemes of $X$
via the morphism $p$ then we have
$$
\text{div}_X(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ is integral, we see that $U$ is integral.
Hence $Y$ is integral, and $(1, f)(U) \subset Y$ is an open dense subscheme.
Also, note that the closed subscheme $Y \subset X \times_S \mathbf{P}^1_S$
does not depend on the choice of the open $U$, since after all it is
the closure of the one point set $\{\eta'\} = \{(1, f)(\eta)\}$
where $\eta \in X$ is the generic point. Having said this let us
prove the assertions of the lemma.

\medskip\noindent
For (1) note that $p$ is the composition of the closed immersion
$Y \to X \times_S \mathbf{P}^1_S = \mathbf{P}^1_X$ with the proper
morphism $\mathbf{P}^1_X \to X$. As a composition of proper morphisms
is proper (Morphisms, Lemma \ref{morphisms-lemma-composition-proper})
we conclude.

\medskip\noindent
It is clear that $Y \cap U \times_S \mathbf{P}^1_S = (1, f)(U)$.
Thus (2) follows. It also follows that $\dim_\delta(Y) = n$.

\medskip\noindent
Note that $q(\eta') = f(\eta)$ is not contained in $D_0$ or $D_\infty$
since $f \in R(X)^*$. Hence (3) by
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}.
We obtain $\dim_\delta(Y_0) = n - 1$
and $\dim_\delta(Y_\infty) = n - 1$ from
Lemma \ref{lemma-divisor-delta-dimension}.

\medskip\noindent
Consider the effective Cartier divisor $Y_0$.
At every point $\xi \in Y_0$ we have $f \in \mathcal{O}_{Y, \xi}$ and
the local equation for $Y_0$ is given by $f$.
In particular, if $\delta(\xi) = n - 1$ so $\xi$ is the generic point
of a integral closed subscheme $Z$ of $\delta$-dimension $n - 1$,
then we see that the coefficient of $[Z]$ in $\text{div}_Y(f)$ is
$$
\text{ord}_Z(f) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y, \xi}/f\mathcal{O}_{Y, \xi}) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y_0, \xi})
$$
which is the coefficient of $[Z]$ in $[Y_0]_{n - 1}$. A similar
argument using the rational function $1/f$ shows that
$-[Y_\infty]$ agrees with the terms with negative coefficients in
the expression for $\text{div}_Y(f)$. Hence (4) follows.

\medskip\noindent
Note that $D_0 \to S$ is an isomorphism. Hence we see that
$X \times_S D_0 \to X$ is an isomorphism as well. Clearly
we have $Y_0 = Y \cap X \times_S D_0$ (scheme theoretic intersection)
inside $X \times_S \mathbf{P}^1_S$. Hence it is really the case that
$Y_0 \to X$ is a closed immersion. It follows that
$$
p_*\mathcal{O}_{Y_0} = \mathcal{O}_{Y'_0}
$$
where $Y'_0 \subset X$ is the image of $Y_0 \to X$.
By Lemma \ref{lemma-cycle-push-sheaf} we
have $p_*[Y_0]_{n - 1} = [Y'_0]_{n - 1}$. The same
is true for $D_\infty$ and $Y_\infty$. Hence (6) is a consequence of (5).
Finally, (5) follows immediately from
Lemma \ref{lemma-proper-pushforward-alteration}.
\end{proof}

\noindent
The following lemma says that the degree of a principal divisor on
a proper curve is zero.

\begin{lemma}
\label{lemma-curve-principal-divisor}
Let $K$ be any field. Let $X$ be a $1$-dimensional integral scheme
endowed with a proper morphism $c : X \to \Spec(K)$.
Let $f \in K(X)^*$ be an invertible rational function.
Then
$$
\sum\nolimits_{x \in X \text{ closed}}
[\kappa(x) : K] \text{ord}_{\mathcal{O}_{X, x}}(f)
=
0
$$
where $\text{ord}$ is as in
Algebra, Definition \ref{algebra-definition-ord}.
In other words, $c_*\text{div}(f) = 0$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
Y \ar[r]_p \ar[d]_q & X \ar[d]^c \\
\mathbf{P}^1_K \ar[r]^-{c'} & \Spec(K)
}
$$
that we constructed in Lemma \ref{lemma-rational-function}
starting with $X$ and the rational function $f$ over $S = \Spec(K)$.
We will use all the results of this lemma without further mention.
We have to show that $c_*\text{div}_X(f) = c_*p_*\text{div}_Y(f) = 0$.
This is the same as proving that $c'_*q_*\text{div}_Y(f) = 0$.
If $q(Y)$ is a closed point of $\mathbf{P}^1_K$ then we
see that $\text{div}_X(f) = 0$ and the lemma holds.
Thus we may assume that $q$ is dominant.
Suppose we can show that $q : Y \to \mathbf{P}^1_K$ is finite
locally free of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Since $\text{div}_Y(f) = [q^{-1}D_0]_0 - [q^{-1}D_\infty]_0$
we see (by definition of flat pullback) that
$\text{div}_Y(f) = q^*([D_0]_0 - [D_\infty]_0)$.
Then by Lemma \ref{lemma-finite-flat} we get
$q_*\text{div}_Y(f) = d([D_0]_0 - [D_\infty]_0)$.
Since clearly $c'_*[D_0]_0 = c'_*[D_\infty]_0$ we win.

\medskip\noindent
It remains to show that $q$ is finite locally free.
(It will automatically have some given degree as $\mathbf{P}^1_K$
is connected.)
Since $\dim(\mathbf{P}^1_K) = 1$ we see that $q$ is finite for example
by Lemma \ref{lemma-finite-in-codimension-one}.
All local rings of $\mathbf{P}^1_K$ at
closed points are regular local rings of dimension $1$
(in other words discrete valuation rings), since they are
localizations of $K[T]$ (see
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}).
Hence for $y\in Y$ closed the local ring $\mathcal{O}_{Y, y}$
will be flat over $\mathcal{O}_{\mathbf{P}^1_K, q(y)}$ as soon as
it is torsion free (More on Algebra, Lemma
\ref{more-algebra-lemma-dedekind-torsion-free-flat}).
This is obviously the case as
$\mathcal{O}_{Y, y}$ is a domain and $q$ is dominant.
Thus $q$ is flat. Hence $q$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}





\section{Rational equivalence}
\label{section-rational-equivalence}

\noindent
In this section we define {\it rational equivalence} on $k$-cycles.
We will allow locally finite sums of images of
principal divisors (under closed immersions). This leads to some
pretty strange phenomena, see Example \ref{example-weird}.
However, if we do not allow these then we do not know how to prove that
capping with chern classes of line bundles factors through rational
equivalence.

\begin{definition}
\label{definition-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item Given any locally finite collection $\{W_j \subset X\}$
of integral closed subschemes with $\dim_\delta(W_j) = k + 1$,
and any $f_j \in R(W_j)^*$ we may consider
$$
\sum (i_j)_*\text{div}(f_j) \in Z_k(X)
$$
where $i_j : W_j \to X$ is the inclusion morphism.
This makes sense as the morphism
$\coprod i_j : \coprod W_j \to X$ is proper.
\item We say that $\alpha \in Z_k(X)$ is {\it rationally equivalent to zero}
if $\alpha$ is a cycle of the form displayed above.
\item We say $\alpha, \beta \in Z_k(X)$ are
{\it rationally equivalent} and we write $\alpha \sim_{rat} \beta$
if $\alpha - \beta$ is rationally equivalent to zero.
\item We define
$$
A_k(X) = Z_k(X) / \sim_{rat}
$$
to be the {\it Chow group of $k$-cycles on $X$}. This is sometimes called
the {\it Chow group of $k$-cycles modulo rational equivalence on $X$}.
\end{enumerate}
\end{definition}

\noindent
There are many other interesting (adequate) equivalence relations.
Rational equivalence is the coarsest one of them all.
A very simple but important lemma is the following.

\begin{lemma}
\label{lemma-restrict-to-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
Let $k \in \mathbf{Z}$.
Suppose $\alpha, \beta \in Z_k(X)$.
If $\alpha|_U \sim_{rat} \beta|_U$ then there exist a cycle
$\gamma \in Z_k(Y)$ such that
$$
\alpha \sim_{rat} \beta + i_*\gamma.
$$
In other words, the sequence
$$
\xymatrix{
A_k(Y) \ar[r]^{i_*} & A_k(X) \ar[r]^{j^*} & A_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be a locally finite collection of integral closed
subschemes of $U$ of $\delta$-dimension $k + 1$, and let $f_j \in R(W_j)^*$
be elements such that $(\alpha - \beta)|_U = \sum (i_j)_*\text{div}(f_j)$
as in the definition. Set $W_j' \subset X$ equal
to the closure of $W_j$. Suppose that $V \subset X$ is a quasi-compact
open. Then also $V \cap U$ is quasi-compact open in $U$ as
$V$ is Noetherian. Hence the set
$\{j \in J \mid W_j \cap V \not = \emptyset\}
= \{j \in J \mid W'_j \cap V \not = \emptyset\}$
is finite since $\{W_j\}$ is locally finite. In other words we see that
$\{W'_j\}$ is also locally finite. Since $R(W_j) = R(W'_j)$ we see
that
$$
\alpha - \beta - \sum (i'_j)_*\text{div}(f_j)
$$
is a cycle supported on $Y$ and the lemma follows (see
Lemma \ref{lemma-exact-sequence-open}).
\end{proof}

\begin{example}
\label{example-weird}
Here is a ``strange'' example.
Suppose that $S$ is the spectrum of a field $k$
with $\delta$ as in Example \ref{example-field}.
Suppose that $X = C_1 \cup C_2 \cup \ldots$ is an infinite
union of curves $C_j \cong \mathbf{P}^1_k$ glued together
in the following way: The point $\infty \in C_j$ is glued
transversally to the point $0 \in C_{j + 1}$ for $j = 1, 2, 3, \ldots$.
Take the point $0 \in C_1$. This gives a zero cycle
$[0] \in Z_0(X)$. The ``strangeness'' in this situation is
that actually $[0] \sim_{rat} 0$! Namely we can choose
the rational function $f_j \in R(C_j)$ to be the function
which has a simple zero at $0$ and a simple pole at $\infty$
and no other zeros or poles. Then we see that the sum
$\sum (i_j)_*\text{div}(f_j)$ is exactly the $0$-cycle
$[0]$. In fact it turns out that $A_0(X) = 0$ in this example.
If you find this too bizarre, then you can just
make sure your spaces are always quasi-compact
(so $X$ does not even exist for you).
\end{example}

\begin{remark}
\label{remark-infinite-sums-rational-equivalences}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose we have infinite collections $\alpha_i, \beta_i \in Z_k(X)$,
$i \in I$ of $k$-cycles on $X$. Suppose that the supports
of $\alpha_i$ and $\beta_i$ form locally finite collections
of closed subsets of $X$ so that $\sum \alpha_i$
and $\sum \beta_i$ are defined as cycles. Moreover, assume that
$\alpha_i \sim_{rat} \beta_i$ for each $i$. Then it is not
clear that $\sum \alpha_i \sim_{rat} \sum \beta_i$. Namely,
the problem is that the rational equivalences may be
given by locally finite
families $\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
but the union $\{W_{i, j}\}_{i \in I, j\in J_i}$ may not
be locally finite.

\medskip\noindent
In many cases in practice, one has a locally finite family of closed
subsets $\{T_i\}_{i \in I}$ such that $\alpha_i, \beta_i$
are supported on $T_i$ and such that $\alpha_i = \beta_i$
in $A_k(T_i)$, in other words, the families
$\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
consist of subschemes $W_{i, j} \subset T_i$. In this case it is true that
$\sum \alpha_i \sim_{rat} \sum \beta_i$ on $X$, simply because
the family $\{W_{i, j}\}_{i \in I, j\in J_i}$ is automatically
locally finite in this case.
\end{remark}






\section{Rational equivalence and push and pull}
\label{section-properties-rational-equivalence}

\noindent
In this section we show that flat pullback and proper pushforward
commute with rational equivalence.

\begin{lemma}
\label{lemma-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha \sim_{rat} \beta$ be rationally equivalent $k$-cycles on $Y$.
Then $f^*\alpha \sim_{rat} f^*\beta$ as $(k + r)$-cycles on $X$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow Y
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $Y$.
Then we have to show that
$$
f^*(\sum i_{j, *}\text{div}(f_j))
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Consider the fibre products
$$
i'_j :
W'_j = W_j \times_Y X
\longrightarrow
X.
$$
For each $j$, consider the collection $\{W'_{j, l}\}_{l \in L_j}$
of irreducible components $W'_{j, l} \subset W'_j$ having $\delta$-dimension
$k + 1$. We may write
$$
[W'_j]_{k + 1} = \sum\nolimits_{l \in L_j} n_{j, l}[W'_{j, l}]_{k + 1}
$$
for some $n_{j, l} > 0$.
By Lemma \ref{lemma-flat-inverse-image-dimension}
we see that $W'_{j, l} \to W_j$ is
dominant and hence we can let $f_{j, l} \in R(W'_{j, l})^*$ denote the
image of $f_j$ under the map of fields $R(W_j) \to R(W'_{j, l})$.
We claim that
\begin{enumerate}
\item the collection $\{W'_{j, l}\}_{j \in J, l \in L_j}$ is
locally finite on $X$, and
\item with obvious notation
$f^*(\sum i_{j, *}\text{div}(f_j))
=
\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
\end{enumerate}
Clearly this claim implies the lemma.

\medskip\noindent
To show (1), note that $\{W'_j\}$ is a locally finite collection
of closed subschemes of $X$ by Lemma \ref{lemma-inverse-image-locally-finite}.
Hence if $U \subset X$ is quasi-compact, then $U$ meets only finitely
many $W'_j$. By Divisors, Lemma \ref{divisors-lemma-components-locally-finite}
the collection of
irreducible components of each $W_j$ is locally finite as well. Hence
we see only finitely many $W'_{j, l}$ meet $U$ as desired.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$k + r$. We have to show that the coefficient $n$ of $[Z]$ in
$f^*(\sum i_{j, *}\text{div}(f_j))$ is equal to the coefficient
$m$ of $[Z]$ in $\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
Let $Z'$ be the closure of $f(Z)$ which is an integral closed
subscheme of $Y$. By Lemma \ref{lemma-flat-inverse-image-dimension}
we have $\dim_\delta(Z') \geq k$.
If $\dim_\delta(Z') > k$, then the coefficients $n$ and $m$ are
both zero, since the generic point of $Z$ will not be contained
in any $W'_j$ or $W'_{j, l}$. Hence we may assume that $\dim_\delta(Z') = k$.

\medskip\noindent
We are going to translate the equality of $n$ and $m$ into algebra.
Namely, let $\xi' \in Z'$ and $\xi \in Z$ be the generic points.
Set $A = \mathcal{O}_{Y, \xi'}$ and $B = \mathcal{O}_{X, \xi}$.
Note that $A$, $B$ are Noetherian, $A \to B$ is flat, local,
and that $\mathfrak m_AB$ is an ideal of definition of the local ring $B$.
There are finitely many $j$ such that $W_j$ passes through
$\xi'$, and these correspond to prime ideals
$$
\mathfrak p_1, \ldots, \mathfrak p_T \subset A
$$
with the property that $\dim(A/\mathfrak p_t) = 1$ for each
$t = 1, \ldots, T$. The rational functions $f_j$ correspond
to elements $f_t \in \kappa(\mathfrak p_t)^*$.
Say $\mathfrak p_t$ corresponds to $W_j$.
By construction, the closed subschemes $W'_{j, l}$ which meet
$\xi$ correspond $1 - 1$ with minimal primes
$$
\mathfrak p_tB
\subset
\mathfrak q_{t, 1}, \ldots, \mathfrak q_{t, S_t}
\subset
B
$$
over $\mathfrak p_tB$.
The integers $n_{j, l}$ correspond to the integers
$$
n_{t, s} = \text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
The rational functions $f_{j, l}$ correspond to the images
$f_{t, s} \in \kappa(\mathfrak q_{t, s})^*$ of the elements
$f_t \in \kappa(\mathfrak p_t)^*$. Putting everything together
we see that
$$
n = \sum \text{ord}_{A/\mathfrak p_t}(f_t)\text{length}_B(B/\mathfrak m_AB)
$$
and that
$$
m = \sum \text{ord}_{B/\mathfrak q_{t, s}}(f_{t, s})
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
Note that it suffices to prove the equality for each
$t \in \{1, \ldots, T\}$ separately. Writing $f_t = x/y$
for some nonzero $\overline{x}, \overline{y} \in A/\mathfrak p_t$
coming from $x, y\in A$ we see that it suffices
to prove
$$
\text{length}_{A/\mathfrak p_t}(A/(\mathfrak p_t, x))
\text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(B/(x, \mathfrak p_t)B)
$$
(equality uses Algebra, Lemma \ref{algebra-lemma-pullback-module})
equals
$$
\sum\nolimits_{s = 1, \ldots, S_t}
\text{ord}_{B/\mathfrak q_{t, s}}(B/(x, \mathfrak q_{t, s}))
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
and similarly for $y$. Note that as $x \not \in \mathfrak p_t$ we
see that $x$ is a nonzerodivisor on $A/\mathfrak p_t$. As $A \to B$
is flat it follows that $x$ is a nonzerodivisor on the module
$M = B/\mathfrak p_tB$. Hence the equality above follows from
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-proper-pushforward-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Suppose $\alpha, \beta \in Z_k(X)$ are rationally equivalent.
Then $p_*\alpha$ is rationally equivalent to $p_*\beta$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow X
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $X$.
Then we have to show that
$$
p_*\left(\sum i_{j, *}\text{div}(f_j)\right)
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Note that the sum is equal to
$$
\sum p_*i_{j, *}\text{div}(f_j).
$$
Let $W'_j \subset Y$ be the integral closed subscheme which is the
image of $p \circ i_j$. The collection $\{W'_j\}$ is locally finite
in $Y$ by Lemma \ref{lemma-quasi-compact-locally-finite}.
Hence it suffices to show, for a given $j$, that either
$p_*i_{j, *}\text{div}(f_j) = 0$ or that it
is equal to $i'_{j, *}\text{div}(g_j)$ for some $g_j \in R(W'_j)^*$.

\medskip\noindent
The arguments above therefore reduce us to the case of a since
integral closed subscheme $W \subset X$ of $\delta$-dimension $k + 1$.
Let $f \in R(W)^*$. Let $W' = p(W)$ as above.
We get a commutative diagram of morphisms
$$
\xymatrix{
W \ar[r]_i \ar[d]_{p'} & X \ar[d]^p \\
W' \ar[r]^{i'} & Y
}
$$
Note that $p_*i_*\text{div}(f) = i'_*(p')_*\text{div}(f)$ by
Lemma \ref{lemma-compose-pushforward}. As explained above
we have to show that $(p')_*\text{div}(f)$
is the divisor of a rational function on $W'$ or zero.
There are three cases to distinguish.

\medskip\noindent
The case $\dim_\delta(W') < k$. In this case automatically
$(p')_*\text{div}(f) = 0$ and there is nothing to prove.

\medskip\noindent
The case $\dim_\delta(W') = k$. Let us show that $(p')_*\text{div}(f) = 0$
in this case. Let $\eta \in W'$ be the generic point.
Note that $c : W_\eta \to \Spec(K)$
is a proper integral curve over $K = \kappa(\eta)$
whose function field $K(W_\eta)$ is identified with $R(W)$.
Here is a diagram
$$
\xymatrix{
W_\eta \ar[r] \ar[d]_c & W \ar[d]^{p'} \\
\Spec(K) \ar[r] & W'
}
$$
Let us denote $f_\eta \in K(W_\eta)^*$ the rational function
corresponding to $f \in R(W)^*$.
Moreover, the closed points $\xi$ of $W_\eta$ correspond $1 - 1$ to the
closed integral subschemes $Z = Z_\xi \subset W$ of $\delta$-dimension $k$
with $p'(Z) = W'$. Note that the multiplicity
of $Z_\xi$ in $\text{div}(f)$ is equal to
$\text{ord}_{\mathcal{O}_{W_\eta, \xi}}(f_\eta)$ simply because the
local rings $\mathcal{O}_{W_\eta, \xi}$ and $\mathcal{O}_{W, \xi}$
are identified (as subrings of their fraction fields).
Hence we see that the multiplicity of $[W']$ in
$(p')_*\text{div}(f)$ is equal to the multiplicity of
$[\Spec(K)]$ in $c_*\text{div}(f_\eta)$.
By Lemma \ref{lemma-curve-principal-divisor} this is zero.

\medskip\noindent
The case $\dim_\delta(W') = k + 1$. In this case
Lemma \ref{lemma-proper-pushforward-alteration} applies,
and we see that indeed $p'_*\text{div}(f) = \text{div}(g)$
for some $g \in R(W')^*$ as desired.
\end{proof}















\section{Rational equivalence and the projective line}
\label{section-different-rational-equivalence}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Given any closed subscheme
$Z \subset X \times_S \mathbf{P}^1_S = X \times \mathbf{P}^1$
we let $Z_0$, resp.\ $Z_\infty$ be the scheme theoretic closed
subscheme $Z_0 = \text{pr}_2^{-1}(D_0)$,
resp.\ $Z_\infty = \text{pr}_2^{-1}(D_\infty)$.
Here $D_0$, $D_\infty$ are as defined just above
Lemma \ref{lemma-rational-function}.

\begin{lemma}
\label{lemma-rational-equivalence-family}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $W \subset X \times_S \mathbf{P}^1_S$ be an integral
closed subscheme of $\delta$-dimension $k + 1$.
Assume $W \not = W_0$, and $W \not = W_\infty$. Then
\begin{enumerate}
\item $W_0$, $W_\infty$ are effective Cartier divisors of $W$,
\item $W_0$, $W_\infty$ can be viewed as closed subschemes
of $X$ and
$$
[W_0]_k \sim_{rat} [W_\infty]_k,
$$
\item for any locally finite family of
integral closed subschemes
$W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$ with $W_i \not = (W_i)_0$ and
$W_i \not = (W_i)_\infty$ we have
$\sum ([(W_i)_0]_k - [(W_i)_\infty]_k) \sim_{rat} 0$
on $X$, and
\item for any $\alpha \in Z_k(X)$ with $\alpha \sim_{rat} 0$
there exists a locally finite family of
integral closed subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
as above such that $\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}
since the generic point
of $W$ is not mapped into $D_0$ or $D_\infty$ under the projection
$X \times_S \mathbf{P}^1_S \to \mathbf{P}^1_S$ by assumption.

\medskip\noindent
Since $X \times_S D_0 \to X$ is an isomorphism we see that $W_0$
is isomorphic to a closed subscheme of $X$. Similarly for $W_\infty$.
Consider the morphism $p : W \to X$. It is proper and on $W$ we have
$[W_0]_k \sim_{rat} [W_\infty]_k$. Hence part (2) follows from
Lemma \ref{lemma-proper-pushforward-rational-equivalence} as clearly
$p_*[W_0]_k = [W_0]_k$ and similarly for $W_\infty$.

\medskip\noindent
The only content of statement (3) is, given parts (1) and (2), that
the collection $\{(W_i)_0, (W_i)_\infty\}$ is a locally finite collection
of closed subschemes of $X$. This is clear.

\medskip\noindent
Suppose that $\alpha \sim_{rat} 0$.
By definition this means there exist integral closed subschemes
$V_i \subset X$ of $\delta$-dimension $k + 1$ and rational
functions $f_i \in R(V_i)^*$ such that the family
$\{V_i\}_{i \in I}$ is locally finite in $X$ and such that
$\alpha = \sum (V_i \to X)_*\text{div}(f_i)$.
Let
$$
W_i \subset V_i \times_S \mathbf{P}^1_S \subset X \times_S \mathbf{P}^1_S
$$
be the closure of the graph of the rational map $f_i$ as in
Lemma \ref{lemma-rational-function}.
Then we have that $(V_i \to X)_*\text{div}(f_i)$
is equal to $[(W_i)_0]_k - [(W_i)_\infty]_k$ by that same lemma.
Hence the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $Z$ be a closed subscheme of $X \times \mathbf{P}^1$.
Assume $\dim_\delta(Z) \leq k + 1$, $\dim_\delta(Z_0) \leq k$,
$\dim_\delta(Z_\infty) \leq k$ and assume
any embedded point $\xi$
(Divisors, Definition \ref{divisors-definition-embedded})
of $Z$ has $\delta(\xi) < k$. Then
$$
[Z_0]_k \sim_{rat} [Z_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $Z$ which have $\delta$-dimension $k + 1$.
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.
We claim that
$$
[Z_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[Z_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[Z_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $I \subset A$ be the ideal cutting out $Z$, in other words so that
$A/I = \mathcal{O}_{Z, \xi}$. Let $t \in A$ be the element cutting
out $X \times_S D_0$ (i.e., the coordinate of $\mathbf{P}^1$ at zero
pulled back). By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(A/I) = 1$. Since $\xi$ is not an embedded point by
definition we see that $A/I$ is Cohen-Macaulay. Since $\dim_\delta(Z_0)
= k$ we see that $\dim(A/(t, I)) = 0$ which implies that $t$
is a nonzerodivisor on $A/I$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$I \subset \mathfrak q_i$ over $I$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(A/(t, I))
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i))
\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}
$$
Thus the result follows from
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X \times \mathbf{P}^1$.
Let $i_0, i_\infty : X \to X \times \mathbf{P}^1$ be the closed immersion
such that $i_t(x) = (x, t)$. Denote $\mathcal{F}_0 = i_0^*\mathcal{F}$ and
$\mathcal{F}_\infty = i_\infty^*\mathcal{F}$.
Assume
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$,
\item $\dim_\delta(\text{Supp}(\mathcal{F}_0)) \leq k$,
$\dim_\delta(\text{Supp}(\mathcal{F}_\infty)) \leq k$, and
\item any embedded associated point $\xi$ of $\mathcal{F}$ has
$\delta(\xi) < k$.
\end{enumerate}
Then
$$
[\mathcal{F}_0]_k \sim_{rat} [\mathcal{F}_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$.
Write
$$
[\mathcal{F}]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-length-finite}.
We claim that
$$
[\mathcal{F}_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[\mathcal{F}_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[\mathcal{F}_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Let $t \in A$ be the element cutting out $X \times_S D_0$
(i.e., the coordinate of $\mathbf{P}^1$ at zero pulled back).
By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$. Since $\xi$ is not an associated point
of $\mathcal{F}$ by definition we see that $M$ is Cohen-Macaulay module.
Since $\dim_\delta(\text{Supp}(\mathcal{F}_0)) = k$
we see that $\dim(\text{Supp}(M/tM)) = 0$ which implies that $t$
is a nonzerodivisor on $M$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Ass}(M)$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(M/tM)
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)A)
\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}
$$
Thus the result follows from
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}.
\end{proof}
















\section{The divisor associated to an invertible sheaf}
\label{section-divisor-invertible-sheaf}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-divisor-invertible-sheaf}
in our current setup.

\begin{definition}
\label{definition-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any nonzero meromorphic section $s$ of $\mathcal{L}$
we define the {\it Weil divisor associated to $s$} is the
$(n - 1)$-cycle
$$
\text{div}_\mathcal{L}(s) =
\sum \text{ord}_{Z, \mathcal{L}}(s) [Z]
$$
defined in Divisors, Definition
\ref{divisors-definition-divisor-invertible-sheaf}.
This makes sense because Weil divisors have $\delta$-dimension $n - 1$
by Lemma \ref{lemma-divisor-delta-dimension}.
\item We define {\it Weil divisor associated to $\mathcal{L}$} as
$$
c_1(\mathcal{L}) \cap [X] =
\text{class of }\text{div}_\mathcal{L}(s) \in A_{n - 1}(X)
$$
where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over
$X$. This is well defined by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}.
\end{enumerate}
\end{definition}

\noindent
There are some cases where it is easy to compute the
Weil divisor associated to an invertible sheaf.

\begin{lemma}
\label{lemma-compute-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a nonzero global section.
Then
$$
\text{div}_\mathcal{L}(s) = [Z(s)]_{n - 1}
$$
in $Z_{n - 1}(X)$ and
$$
c_1(\mathcal{L}) \cap [X] = [Z(s)]_{n - 1}
$$
in $A_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $s = fs_\xi$ for some $f \in \mathcal{O}_{X, \xi}$.
By definition of $Z(s)$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}
we see that $Z(s)$ is cut out by a quasi-coherent
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ such
that $\mathcal{I}_\xi = (f)$. Hence
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{Z(s), \xi})
=
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{X, \xi}/(f))
=
\text{ord}_{\mathcal{O}_{X, x}}(f)$ as desired.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-cap-c1}.

\begin{lemma}
\label{lemma-flat-pullback-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$. Then
$$
f^*(c_1(\mathcal{L}) \cap [Y]) = c_1(f^*\mathcal{L}) \cap [X]
$$
in $A_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
We will show that actually
$f^*\text{div}_\mathcal{L}(s) = \text{div}_{f^*\mathcal{L}}(f^*s)$
and hence the lemma holds.
To see this let $\xi \in Y$ be a point and let $s_\xi \in \mathcal{L}_\xi$
be a generator. Write $s = gs_\xi$ with $g \in R(X)^*$.
Then there is an open neighbourhood $V \subset Y$ of $\xi$
such that $s_\xi \in \mathcal{L}(V)$ and such that $s_\xi$ generates
$\mathcal{L}|_V$. Hence we see that
$$
\text{div}_\mathcal{L}(s)|_V = \text{div}(g)|_V.
$$
In exactly the same way, since $f^*s_\xi$ generates $\mathcal{L}$
over $f^{-1}(V)$ and since $f^*s = g f^*s_\xi$ we also
have
$$
\text{div}_\mathcal{L}(f^*s)|_{f^{-1}(V)}
=
\text{div}(g)|_{f^{-1}(V)}.
$$
Thus the desired equality of cycles over $f^{-1}(V)$ follows from the
corresponding result for pullbacks of principal divisors, see
Lemma \ref{lemma-flat-pullback-principal-divisor}.
\end{proof}



\section{Intersecting with an invertible sheaf}
\label{section-intersecting-with-divisors}

\noindent
In this section we study the following construction.

\begin{definition}
\label{definition-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We define, for every integer $k$, an operation
$$
c_1(\mathcal{L}) \cap - :
Z_{k + 1}(X) \to A_k(X)
$$
called {\it intersection with the first chern class of $\mathcal{L}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ with
$\dim_\delta(W) = k + 1$ we define
$$
c_1(\mathcal{L}) \cap [W] = i_*(c_1({i^*\mathcal{L}}) \cap [W])
$$
where the right hand side is defined in
Definition \ref{definition-divisor-invertible-sheaf}.
\item For a general $(k + 1)$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_1(\mathcal{L}) \cap \alpha = \sum n_i c_1(\mathcal{L}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Write each $c_1(\mathcal{L}) \cap W_i = \sum_j n_{i, j} [Z_{i, j}]$
with $\{Z_{i, j}\}_j$ a locally finite sum
of integral closed subschemes of $W_i$. Since $\{W_i\}$ is a locally
finite collection of integral closed subschemes on $X$, it follows
easily that $\{Z_{i, j}\}_{i, j}$ is a locally finite collection
of closed subschemes of $X$. Hence
$c_1(\mathcal{L}) \cap \alpha = \sum n_in_{i, j}[Z_{i, j}]$
is a cycle. Another, more convenient, way to think about this
is to observe that the morphism $\coprod W_i \to X$ is
proper. Hence $c_1(\mathcal{L}) \cap \alpha$ can be viewed
as the pushforward of a class in $A_k(\coprod W_i) = \prod A_k(W_i)$.
This also explains why the result is well defined up to rational
equivalence on $X$.

\medskip\noindent
The main goal for the next few sections is to show that intersecting with
$c_1(\mathcal{L})$ factors through rational equivalence.
This is not a triviality.

\begin{lemma}
\label{lemma-c1-cap-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be an invertible sheaves on $X$.
Then
$$
c_1(\mathcal{L}) \cap \alpha  + c_1(\mathcal{N}) \cap \alpha =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap \alpha
$$
in $A_k(X)$ for every $\alpha \in Z_{k - 1}(X)$. Moreover,
$c_1(\mathcal{O}_X) \cap \alpha = 0$ for all $\alpha$.
\end{lemma}

\begin{proof}
The additivity follows directly from
Divisors, Lemma \ref{divisors-lemma-c1-additive}
and the definitions. To see that $c_1(\mathcal{O}_X) \cap \alpha = 0$
consider the section $1 \in \Gamma(X, \mathcal{O}_X)$. This restricts
to an everywhere nonzero section on any integral closed subscheme
$W \subset X$. Hence $c_1(\mathcal{O}_X) \cap [W] = 0$ as desired.
\end{proof}

\noindent
The following lemma is a useful result in order to compute the intersection
product of the $c_1$ of an invertible sheaf and the cycle associated
to a closed subscheme.
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $Z \subset X$ be a closed subscheme.
Assume $\dim_\delta(Z) \leq k + 1$.
Let $s \in \Gamma(Z, \mathcal{L}|_Z)$.
Assume
\begin{enumerate}
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of dimension $k$ the multiplication by $s$
induces an injection $\mathcal{O}_{Z, \xi} \to (\mathcal{L}|_Z)_\xi$.
\end{enumerate}
This holds for example if $s$ is a regular section of $\mathcal{L}|_Z$.
Then
$$
[Z(s)]_k = c_1(\mathcal{L}) \cap [Z]_{k + 1}
$$
in $A_k(X)$.
\end{lemma}

\begin{proof}
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
where $W_i \subset Z$ are the irreducible components of
$Z$ of $\delta$-dimension $k + 1$ and $n_i > 0$.
By assumption the restriction
$s_i = s|_{W_i} \in \Gamma(W_i, \mathcal{L}|_{W_i})$ is not
zero, and hence is a regular section. By Lemma \ref{lemma-compute-c1}
we see that $[Z(s_i)]_k$ represents $c_1(\mathcal{L}|_{W_i})$.
Hence by definition
$$
c_1(\mathcal{L}) \cap [Z]_{k + 1} = \sum n_i[Z(s_i)]_k
$$
In fact, the proof below will show that we have
\begin{equation}
\label{equation-equal-as-cycles}
[Z(s)]_k =  \sum n_i[Z(s_i)]_k
\end{equation}
as $k$-cycles on $X$.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of
$\delta$-dimension $k$. Let $\xi' \in Z'$ be its generic point.
We want to compare the coefficient $n$ of $[Z']$ in the expression
$\sum n_i[Z(s_i)]_k$ with the coefficient $m$ of $[Z']$ in the
expression $[Z(s)]_k$. Choose a generator $s_{\xi'} \in \mathcal{L}_\xi$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$.
Write $A = \mathcal{O}_{X, \xi'}$, $L = \mathcal{L}_{\xi'}$
and $I = \mathcal{I}_{\xi'}$. Then $L = As_{\xi'}$ and
$L/IL = (A/I)s_{\xi'} = (\mathcal{L}|_Z)_{\xi'}$.
Write $s = f s_{\xi'}$ for some (unique) $f \in A/I$.
Hypothesis (2) means that $f : A/I \to A/I$ is injective.
Since $\dim_\delta(Z) \leq k + 1$ and $\dim_\delta(Z') = k$
we have $\dim(A/I) = 0$ or $1$. We have
$$
m = \text{length}_A(A/(f, I))
$$
which is finite in either case.

\medskip\noindent
If $\dim(A/I) = 0$, then $f : A/I \to A/I$ being injective
implies that $f \in (A/I)^*$. Hence in this case $m$ is zero.
Moreover, the condition $\dim(A/I) = 0$ means that $\xi'$
does not lie on any irreducible component of $\delta$-dimension
$k + 1$, i.e., $n = 0$ as well.

\medskip\noindent
Now, let $\dim(A/I) = 1$.
Since $A$ is a Noetherian local ring there are finitely
many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t \supset I$
over $I$. These correspond 1-1 with $W_i$ passing through $\xi'$.
Moreover $n_i = \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})$.
Also, the multiplicity of $[Z']$ in $[Z(s_i)]_k$ is
$\text{length}_A(A/(f, \mathfrak q_i))$.
Hence the equation to prove in this case is
$$
\text{length}_A(A/(f, I))
=
\sum \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})
\text{length}_A(A/(f, \mathfrak q_i))
$$
which follows from
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}.
\end{proof}




\section{Intersecting with an invertible sheaf and push and pull}
\label{section-intersecting-with-divisors-push-pull}

\noindent
In this section we prove that the operation $c_1(\mathcal{L}) \cap -$
commutes with flat pullback and proper pushforward.

\begin{lemma}
\label{lemma-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_1(\mathcal{L}) \cap \alpha) = c_1(f^*\mathcal{L}) \cap f^*\alpha
$$
in $A_{k + r - 1}(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_i[W_i]$. We claim it suffices to show that
$f^*(c_1(\mathcal{L}) \cap [W_i]) = c_1(f^*\mathcal{L}) \cap f^*[W_i]$
for each $i$. Proof of this claim is omitted.
(Remarks: it is clear in the quasi-compact case.
Something similar happened in the proof of
Lemma \ref{lemma-flat-pullback-rational-equivalence}, and one
can copy the method used there here. Another possibility
is to check the cycles and rational equivalences used
for all $W_i$ combined at each step form a locally finite collection).

\medskip\noindent
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
We have to show that
$f^*(c_1(\mathcal{L}) \cap [W]) = c_1(f^*\mathcal{L}) \cap f^*[W]$.
Consider the following fibre product diagram
$$
\xymatrix{
W' = W \times_Y X \ar[r] \ar[d] & X \ar[d] \\
W \ar[r] & Y
}
$$
and let $W'_i \subset W'$ be the irreducible components of
$\delta$-dimension $k + r$. Write
$[W']_{k + r} = \sum n_i[W'_i]$ with $n_i > 0$ as per definition.
So $f^*[W] = \sum n_i[W'_i]$. Choose a nonzero meromorphic section
$s$ of $\mathcal{L}|_W$. Since each $W'_i \to W$ is dominant we
see that $s_i = s|_{W'_i}$ is a nonzero meromorphic section for
each $i$. We claim that we have the following equality of
cycles
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
f^*\text{div}_{\mathcal{L}|_W}(s)
$$
in $Z_{k + r - 1}(X)$.

\medskip\noindent
Having formulated the problem as an equality of cycles
we may work locally on $Y$. Hence we may assume
$Y$ and also $W$ affine, and $s = p/q$ for some
nonzero sections $p \in \Gamma(W, \mathcal{L})$
and $q \in \Gamma(W, \mathcal{O})$. If we can show both
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(p_i)
=
f^*\text{div}_{\mathcal{L}|_W}(p),
\quad\text{and}\quad
\sum n_i\text{div}_{\mathcal{O}|_{W_i}}(q_i)
=
f^*\text{div}_{\mathcal{O}|_W}(q)
$$
(with obvious notations) then we win by the
additivity, see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
Thus we may assume that $s \in \Gamma(W, \mathcal{L}|_W)$.
In this case we may apply the equality
(\ref{equation-equal-as-cycles}) obtained in the proof of
Lemma \ref{lemma-geometric-cap} to see that
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
[Z(s')]_{k + r - 1}
$$
where $s' \in f^*\mathcal{L}|_{W'}$ denotes the pullback
of $s$ to $W'$. On the other hand we have
$$
f^*\text{div}_{\mathcal{L}|_W}(s) = f^*[Z(s)]_{k - 1}
= [f^{-1}(Z(s))]_{k + r - 1},
$$
by Lemmas \ref{lemma-compute-c1} and \ref{lemma-pullback-coherent}.
Since $Z(s') = f^{-1}(Z(s))$ we win.
\end{proof}

\begin{lemma}
\label{lemma-equal-c1-as-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $s$ be a nonzero meromorphic section $s$ of $\mathcal{L}$ on $Y$.
Assume $X$, $Y$ integral, $f$ dominant, and $\dim_\delta(X) = \dim_\delta(Y)$.
Then
$$
f_*\left(\text{div}_{f^*\mathcal{L}}(f^*s)\right) =
[R(X) : R(Y)]\text{div}_\mathcal{L}(s).
$$
as cycles on $Y$. In particular
$$
f_*(c_1(f^*\mathcal{L}) \cap [X]) = c_1(\mathcal{L}) \cap f_*[Y].
$$
\end{lemma}

\begin{proof}
The last equation follows from the first since $f_*[X] = [R(X) : R(Y)][Y]$
by definition. It turns out that we can re-use
Lemma \ref{lemma-proper-pushforward-alteration}
to prove this. Namely, since we are trying to prove an equality
of cycles, we may work locally on $Y$. Hence we may assume
that $\mathcal{L} = \mathcal{O}_Y$. In this case $s$
corresponds to a rational function $g \in R(Y)$, and
we are simply trying to prove
$$
f_*\left(\text{div}_X(g)\right) =
[R(X) : R(Y)]\text{div}_Y(g).
$$
Comparing with the result of the aforementioned
Lemma \ref{lemma-proper-pushforward-alteration}
we see this true since
$\text{Nm}_{R(X)/R(Y)}(g) = g^{[R(X) : R(Y)]}$
as $g \in R(Y)^*$.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha \in Z_{k + 1}(X)$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Then
$$
p_*(c_1(p^*\mathcal{L}) \cap \alpha) = c_1(\mathcal{L}) \cap p_*\alpha
$$
in $A_k(Y)$.
\end{lemma}

\begin{proof}
Suppose that $p$ has the property that for every integral
closed subscheme $W \subset X$ the map $p|_W : W \to Y$
is a closed immersion. Then, by definition of capping
with $c_1(\mathcal{L})$ the lemma holds.

\medskip\noindent
We will use this remark to reduce to a special case. Namely,
write $\alpha = \sum n_i[W_i]$ with $n_i \not = 0$ and $W_i$ pairwise
distinct. Let $W'_i \subset Y$ be the image of $W_i$ (as an integral
closed subscheme). Consider the diagram
$$
\xymatrix{
X' = \coprod W_i \ar[r]_-q \ar[d]_{p'} & X \ar[d]^p \\
Y' = \coprod W'_i \ar[r]^-{q'} & Y.
}
$$
Since $\{W_i\}$ is locally finite on $X$, and $p$ is proper
we see that $\{W'_i\}$ is locally finite on $Y$ and that
$q, q', p'$ are also proper morphisms.
We may think of $\sum n_i[W_i]$ also as a $k$-cycle
$\alpha' \in Z_k(X')$. Clearly $q_*\alpha' = \alpha$.
We have
$q_*(c_1(q^*p^*\mathcal{L}) \cap \alpha')
= c_1(p^*\mathcal{L}) \cap q_*\alpha'$
and
$(q')_*(c_1((q')^*\mathcal{L}) \cap p'_*\alpha') =
c_1(\mathcal{L}) \cap q'_*p'_*\alpha'$ by the initial
remark of the proof. Hence it suffices to prove the lemma
for the morphism $p'$ and the cycle $\sum n_i[W_i]$.
Clearly, this means we may assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.
In this case the result follows from
Lemma \ref{lemma-equal-c1-as-cycles}.
\end{proof}






\section{The key formula}
\label{section-key}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume
$X$ is integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$ and $\mathcal{N}$ be invertible sheaves on $X$.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$ and
let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Let $Z_i \subset X$, $i \in I$ be a set of locally finite set of irreducible
closed subsets of codimension $1$ with the following property:
If $Z \not \in \{Z_i\}$ with generic point $\xi$, then $s$ is a generator
for $\mathcal{L}_\xi$ and $t$ is a generator for $\mathcal{N}_\xi$.
Such a set exists by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-locally-finite}.
Then
$$
\text{div}_\mathcal{L}(s) = \sum \text{ord}_{Z_i, \mathcal{L}}(s) [Z_i]
$$
and similarly
$$
\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t) [Z_i]
$$
Unwinding the definitions more, we pick for each $i$ generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{N}_{\xi_i}$
where $\xi_i$ is the generic point of $Z_i$. Then we can write
$$
s = f_i s_i
\quad\text{and}\quad
t = g_i t_i
$$
Set $B_i = \mathcal{O}_{X, \xi_i}$. Then by definition
$$
\text{ord}_{Z_i, \mathcal{L}}(s) = \text{ord}_{B_i}(f_i)
\quad\text{and}\quad
\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)
$$
Since $t_i$ is a generator of $\mathcal{N}_{\xi_i}$ we see that
its image in the fibre $\mathcal{N}_{\xi_i} \otimes \kappa(\xi_i)$
is a nonzero meromorphic section of $\mathcal{N}|_{Z_i}$. We will denote
this image $t_i|_{Z_i}$. From our definitions it follows that
$$
c_1(\mathcal{N}) \cap \text{div}_\mathcal{L}(s) =
\sum \text{ord}_{B_i}(f_i)
(Z_i \to X)_*\text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
and similarly
$$
c_1(\mathcal{L}) \cap \text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i)
(Z_i \to X)_*\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
in $A_{n - 2}(X)$. We are going to find a rational equivalence between
these two cycles. To do this we consider the tame symbol
$$
d_{B_i}(f_i, g_i) \in \kappa(\xi_i)^*
$$
see Definition \ref{definition-tame-symbol}.

\begin{lemma}[Key formula]
\label{lemma-key-formula}
In the situation above the cycle
$$
\sum
(Z_i \to X)_*\left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right)
$$
is equal to the cycle
$$
\sum (Z_i \to X)_*\text{div}(d_{B_i}(f_i, g_i))
$$
\end{lemma}

\begin{proof}
First, let us examine what happens if we replace $s_i$ by $us_i$
for some unit $u$ in $B_i$. Then $f_i$ gets replaced by $u^{-1} f_i$.
Thus the first part of the first expression of the lemma is unchanged
and in the second part we add
$$
-\text{ord}_{B_i}(g_i)\text{div}(u|_Z)
$$
(where $u|_{Z_i}$ is the image of $a_i$ in the residue field) by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}
and in the second expression we add
$$
\text{div}(d_{B_i}(u^{-1}, g_i))
$$
by bi-linearity of the tame symbol. These terms agree by
Lemma \ref{lemma-symbol-when-one-is-a-unit}.

\medskip\noindent
Let $Z \subset X$ be an irreducible closed with $\dim_\delta(Z) = n - 2$.
To show that the coefficients of $Z$ of the two cycles of the lemma
is the same, we may do a replacement $s_i \mapsto us_i$ as in the previous
paragraph. In exactly the same way one shows that we may do a replacement
$t_i \mapsto vt_i$ for some unit $v$ of $B_i$.

\medskip\noindent
Since we are proving the equality of cycles we may argue one coefficient
at a time. Thus we choose an irreducible closed $Z \subset X$
with $\dim_\delta(Z) = n - 2$ and compare coefficients. Let $\xi \in Z$
be the generic point and set $A = \mathcal{O}_{X, \xi}$. This is a Noetherian
local domain of dimension $2$. Choose generators $\sigma$ and $\tau$
for $\mathcal{L}_\xi$ and $\mathcal{N}_\xi$. After shrinking $X$, we may
and do assume $\sigma$ and $\tau$ define trivializations
of the invertible sheaves $\mathcal{L}$ and $\mathcal{N}$ over all of $X$.
Because $Z_i$ is locally
finite after shrinking $X$ we may assume $Z \subset Z_i$ for all $i \in I$
and that $I$ is finite. Then $\xi_i$ corresponds to a prime
$\mathfrak q_i \subset A$ of height $1$.
We may write $s_i = a_i \sigma$ and $t_i = b_i \tau$
for some $a_i$ and $b_i$ units in $A_{\mathfrak q_i}$.
By the remarks above, it suffices to prove the lemma when
$a_i = b_i = 1$ for all $i$.

\medskip\noindent
Assume $a_i = b_i = 1$ for all $i$. Then the first expression of the
lemma is zero, because we choose $\sigma$ and $\tau$ to be trivializing
sections. Write $s = f\sigma$ and $t = g \tau$ with $f$ and $g$ in the
fraction field of $A$. By the previous paragraph we have reduced to the case
$f_i = f$ and $g_i = g$ for all $i$. Moreover, for a height $1$ prime
$\mathfrak q$ of $A$ which is not in $\{\mathfrak q_i\}$ we have
that both $f$ and $g$ are units in $A_\mathfrak q$ (by our choice of
the family $\{Z_i\}$ in the discussion preceding the lemma). Thus
the coefficient of $Z$ in the second expression of the lemma is
$$
\sum\nolimits_i \text{ord}_{A/\mathfrak q_i}(d_{B_i}(f, g))
$$
which is zero by the key Lemma \ref{lemma-secondary-ramification}.
\end{proof}






\section{Intersecting with an invertible sheaf and rational equivalence}
\label{section-commutativity}

\noindent
Applying the key lemma we obtain the fundamental properties of intersecting
with invertible sheaves. In particular, we will see that
$c_1(\mathcal{L}) \cap -$ factors through rational equivalence and
that these operations for different invertible sheaves commute.

\begin{lemma}
\label{lemma-commutativity-on-integral}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}$
and a nonzero meromorphic section $t$ of $\mathcal{N}$.
Set $\alpha = \text{div}_\mathcal{L}(s)$ and
$\beta = \text{div}_\mathcal{N}(t)$.
Then
$$
c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{L}) \cap \beta
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
Immediate from the key Lemma \ref{lemma-key-formula}
and the discussion preceding it.
\end{proof}

\begin{lemma}
\label{lemma-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
The operation $\alpha \mapsto c_1(\mathcal{L}) \cap \alpha$
factors through rational equivalence to give an operation
$$
c_1(\mathcal{L}) \cap - : A_{k + 1}(X) \to A_k(X)
$$
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$, and $\alpha \sim_{rat} 0$.
We have to show that $c_1(\mathcal{L}) \cap \alpha$
as defined in Definition \ref{definition-cap-c1} is zero.
By Definition \ref{definition-rational-equivalence} there
exists a locally finite family $\{W_j\}$ of integral closed
subschemes with $\dim_\delta(W_j) = k + 2$ and rational functions
$f_j \in R(W_j)^*$ such that
$$
\alpha = \sum (i_j)_*\text{div}_{W_j}(f_j)
$$
Note that $p : \coprod W_j \to X$ is a proper morphism,
and hence $\alpha = p_*\alpha'$ where $\alpha' \in Z_{k + 1}(\coprod W_j)$
is the sum of the principal divisors $\text{div}_{W_j}(f_j)$.
By Lemma \ref{lemma-pushforward-cap-c1} we have
$c_1(\mathcal{L}) \cap \alpha = p_*(c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to show that each
$c_1(\mathcal{L}|_{W_j}) \cap \text{div}_{W_j}(f_j)$ is zero.
In other words we may assume that $X$ is integral and
$\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.
We can think of $f$ as a regular meromorphic section of the invertible
sheaf $\mathcal{N} = \mathcal{O}_X$. Choose a meromorphic section
$s$ of $\mathcal{L}$ and denote $\beta = \text{div}_\mathcal{L}(s)$.
By Lemma \ref{lemma-commutativity-on-integral}
we conclude that
$$
c_1(\mathcal{L}) \cap \alpha = c_1(\mathcal{O}_X) \cap \beta.
$$
However, by Lemma \ref{lemma-c1-cap-additive} we see that the right hand side
is zero in $A_k(X)$ as desired.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
We will denote
$$
c_1(\mathcal{L})^s \cap - : A_{k + s}(X) \to A_k(X)
$$
the operation $c_1(\mathcal{L}) \cap - $. This makes sense by
Lemma \ref{lemma-factors}. We will denote $c_1(\mathcal{L}^s \cap -$
the $s$-fold iterate of this operation for all $s \geq 0$.

\begin{lemma}
\label{lemma-cap-commutative}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
For any $\alpha \in A_{k + 2}(X)$ we have
$$
c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
$$
as elements of $A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum m_j[Z_j]$ for some locally finite
collection of integral closed subschemes $Z_j \subset X$
with $\dim_\delta(Z_j) = k + 2$.
Consider the proper morphism $p : \coprod Z_j \to X$.
Set $\alpha' = \sum m_j[Z_j]$ as a $(k + 2)$-cycle on
$\coprod Z_j$. By several applications of
Lemma \ref{lemma-pushforward-cap-c1} we see that
$c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
= p_*(c_1(p^*\mathcal{L}) \cap c_1(p^*\mathcal{N}) \cap \alpha')$
and
$c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
= p_*(c_1(p^*\mathcal{N}) \cap c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to prove the formula in case $X$ is integral
and $\alpha = [X]$. In this case the result follows
from Lemma \ref{lemma-commutativity-on-integral} and the definitions.
\end{proof}




\section{Intersecting with effective Cartier divisors}
\label{section-intersecting-effective-Cartier}

\noindent
In this section we define the gysin map for the zero locus of a
section of an invertible sheaf. The most interesting case is that
of an effective Cartier divisor; the reason for the generalization
is to be able to formulate various compatibilities, see
Remark \ref{remark-pullback-pairs} and
Lemmas \ref{lemma-closed-in-X-gysin},
\ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
These results can be generalized to deal with locally principal
closed subschemes with a virtual normal bundle
(Remark \ref{remark-generalize-to-virtual}).
A generalization in a different direction comes from looking
at pseudo-divisors (Remark \ref{remark-generalize-to-pseudo-divisor}).

\medskip\noindent
Recall that effective Cartier divisors correspond $1$-to-$1$ to
isomorphism classes of pairs $(\mathcal{L}, s)$ where $\mathcal{L}$
is an invertible sheaf and $s$ is a global section, see
Divisors, Lemma \ref{divisors-lemma-characterize-OD}.
If $D$ corresponds to $(\mathcal{L}, s)$, then
$\mathcal{L} = \mathcal{O}_X(D)$. Please keep this in mind while
reading this section.

\begin{definition}
\label{definition-gysin-homomorphism}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s)$ be a pair consisting of an invertible
sheaf and a global section $s \in \Gamma(X, \mathcal{L})$.
Let $D = Z(s)$ be the zero scheme of $s$, and
denote $i : D \to X$ the closed immersion.
We define, for every integer $k$, a (refined) {\it Gysin homomorphism}
$$
i^* : Z_{k + 1}(X) \to A_k(D).
$$
by the following rules:
\begin{enumerate}
\item Given a integral closed subscheme $W \subset X$ with
$\dim_\delta(W) = k + 1$ we define
\begin{enumerate}
\item if $W \not \subset D$, then $i^*[W] = [D \cap W]_k$ as a
$k$-cycle on $D$, and
\item if $W \subset D$, then
$i^*[W] = i'_*(c_1(\mathcal{L}|_W) \cap [W])$,
where $i' : W \to D$ is the induced closed immersion.
\end{enumerate}
\item For a general $(k + 1)$-cycle $\alpha = \sum n_j[W_j]$
we set
$$
i^*\alpha = \sum n_j i^*[W_j]
$$
\item If $D$ is an effective Cartier divisor, then we denote
$D \cdot \alpha = i_*i^*\alpha$ the pushforward of
the class to a class on $X$.
\end{enumerate}
\end{definition}

\noindent
In fact, as we will see later, this Gysin homomorphism $i^*$ can be viewed
as an example of a non-flat pullback. Thus we will sometimes informally
call the class $i^*\alpha$ the {\it pullback} of the class $\alpha$.

\begin{remark}
\label{remark-pullback-pairs}
Let $f : X' \to X$ be a morphism of schemes locally of finite type over $S$
as in Situation \ref{situation-setup}. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Then we can set $\mathcal{L}' = f^*\mathcal{L}$, $s' = f^*s$, and
$D' = X' \times_X D = Z(s')$. This gives a commutative diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
and we can ask for various compatibilities between $i^*$ and $(i')^*$.
\end{remark}

\begin{remark}
\label{remark-on-cycles}
Let $X \to S$, $\mathcal{L}$, $s$, $i : D \to X$ be as in
Definition \ref{definition-gysin-homomorphism} and assume
that $\mathcal{L}|_D \cong \mathcal{O}_D$. In this case we
can define a canonical map $i^* : Z_{k + 1}(X) \to Z_k(D)$
on cycles, by requiring that $i^*[W] = 0$ whenever $W \subset D$.
The possibility to do this will be useful later on.
\end{remark}

\begin{remark}
\label{remark-generalize-to-virtual}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. Let $(D, \mathcal{N}, \sigma)$
be a triple consisting of a locally principal (Divisors, Definition
\ref{divisors-definition-effective-Cartier-divisor}) closed subscheme
$i : D \to X$, an invertible $\mathcal{O}_D$-module $\mathcal{N}$, and
a surjection $\sigma : \mathcal{N}^{\otimes -1} \to i^*\mathcal{I}_D$
of $\mathcal{O}_D$-modules. Here $\mathcal{N}$ should be thought of as
a {\it virtual normal bundle of $D$ in $X$}. The construction of
$i^* : Z_{k + 1}(X) \to A_k(D)$ in
Definition \ref{definition-gysin-homomorphism}
generalizes to such triples and it is perhaps the correct generality
for the definition.
\end{remark}

\begin{remark}
\label{remark-generalize-to-pseudo-divisor}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. In \cite{F} a {\it pseudo-divisor} on $X$
is defined as a triple $D = (\mathcal{L}, Z, s)$ where $\mathcal{L}$
is an invertible $\mathcal{O}_X$-module, $Z \subset X$ is a closed subset,
and $s \in \Gamma(X \setminus Z, \mathcal{L})$ is a nowhere vanishing
section. Similarly to the above, one can define for every $\alpha$
in $A_k(X)$ a product $D \cdot \alpha$ in $A_k(Z \cap |\alpha|)$
where $|\alpha|$ is the support of $\alpha$.
\end{remark}

\begin{lemma}
\label{lemma-support-cap-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Let $\alpha$ be a
$(k + 1)$-cycle on $X$. Then $i_*i^*\alpha = c_1(\mathcal{L}) \cap \alpha$
in $A_k(X)$. In particular, if $D$ is an effective Cartier divisor, then
$D \cdot \alpha = c_1(\mathcal{O}_X(D)) \cap \alpha$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_j[W_j]$ where $i_j : W_j \to X$ are integral closed
subschemes with $\dim_\delta(W_j) = k$.
Since $D$ is the zero scheme of $s$ we see that $D \cap W_j$ is the zero scheme
of the restriction $s|_{W_j}$. Hence for each $j$ such that
$W_j \not \subset D$ we have
$c_1(\mathcal{L}) \cap [W_j] = [D \cap W_j]_k$
by Lemma \ref{lemma-geometric-cap}. So we have
$$
c_1(\mathcal{L}) \cap \alpha
=
\sum\nolimits_{W_j \not \subset D} n_j[D \cap W_j]_k
+
\sum\nolimits_{W_j \subset D}
n_j i_{j, *}(c_1(\mathcal{L})|_{W_j}) \cap [W_j])
$$
in $A_k(X)$ by Definition \ref{definition-cap-c1}.
The right hand side matches (termwise) the pushforward of the class
$i^*\alpha$ on $D$ from Definition \ref{definition-gysin-homomorphism}.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-closed-in-X-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X' \to X$ be a proper morphism of schemes
locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha'$ on $X'$ we have
$i^*f_*\alpha' = g_*(i')^*\alpha'$ in $A_k(D)$
(this makes sense as $f_*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W']$ for some integral closed subscheme
$W' \subset X'$. Let $W = f(W') \subset X$. In case $W' \not \subset D'$,
then $W \not \subset D$ and we see that
$$
[W' \cap D']_k = \text{div}_{\mathcal{L}'|_{W'}}({s'|_{W'}})
\quad\text{and}\quad
[W \cap D]_k = \text{div}_{\mathcal{L}|_W}(s|_W)
$$
and hence $f_*$ of the first cycle equals the second cycle by
Lemma \ref{lemma-equal-c1-as-cycles}. Hence the
equality holds as cycles. In case $W' \subset D'$, then
$W \subset D$ and $f_*(c_1(\mathcal{L}|_{W'}) \cap [W'])$
is equal to $c_1(\mathcal{L}|_W) \cap [W]$ in $A_k(W)$ by the second
assertion of Lemma \ref{lemma-equal-c1-as-cycles}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}

\begin{lemma}
\label{lemma-gysin-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $f : X' \to X$
be a flat morphism of relative dimension $r$ of schemes locally of finite type
over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha$ on $X$ we have
$(i')^*f^*\alpha = g^*i^*\alpha'$ in $A_{k + r}(D)$
(this makes sense as $f^*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W]$ for some integral closed subscheme
$W \subset X$. Let $W' = f^{-1}(W) \subset X'$. In case $W \not \subset D$,
then $W' \not \subset D'$ and we see that
$$
W' \cap D' = g^{-1}(W \cap D)
$$
as closed subschemes of $D'$. Hence the
equality holds as cycles, see Lemma \ref{lemma-pullback-coherent}.
In case $W \subset D$, then $W' \subset D'$ and $W' = g^{-1}(W)$
with $[W']_{k + 1 + r} = g^*[W]$ and equality holds in
$A_{k + r}(D')$ by Lemma \ref{lemma-flat-pullback-cap-c1}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}

\begin{lemma}
\label{lemma-easy-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme such
that $\dim_\delta(Z) \leq k + 1$ and such that
$D \cap Z$ is an effective Cartier divisor on $Z$. Then
$i^*[Z]_{k + 1} = [D \cap Z]_k$.
\item Let $\mathcal{F}$ be a coherent sheaf on $X$
such that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$ and
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Then
$$
i^*[\mathcal{F}]_{k + 1} = [i^*\mathcal{F}]_k
$$
in $A_k(D)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $Z \subset X$ as in (1). Then set $\mathcal{F} = \mathcal{O}_Z$.
The assumption that $D \cap Z$ is an effective Cartier divisor is
equivalent to the assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Moreover $[Z]_{k + 1} = [\mathcal{F}]_{k + 1}]$
and $[D \cap Z]_k = [\mathcal{O}_{D \cap Z}]_k = [i^*\mathcal{F}]_k$.
See Lemma \ref{lemma-cycle-closed-coherent}.
Hence part (1) follows from part (2).

\medskip\noindent
Write $[\mathcal{F}]_{k + 1} = \sum m_j[W_j]$ with $m_j > 0$
and pairwise distinct integral closed subschemes $W_j \subset X$
of $\delta$-dimension $k + 1$. The assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective implies that $W_j \not \subset D$ for all $j$.
By definition we see that
$$
i^*[\mathcal{F}]_{k + 1} = \sum [D \cap W_j]_k.
$$
We claim that
$$
\sum [D \cap W_j]_k = [i^*\mathcal{F}]_k
$$
as cycles.
Let $Z \subset D$ be an integral closed subscheme of $\delta$-dimension
$k$. Let $\xi \in Z$ be its generic point. Let $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$. Let $f \in A$ be an element generating the
ideal of $D$, i.e., such that $\mathcal{O}_{D, \xi} = A/fA$.
By assumption $\dim(\text{Supp}(M)) = 1$, $f : M \to M$ is injective, and
$\text{length}_A(M/fM) < \infty$. Moreover, $\text{length}_A(M/fM)$
is the coefficient of $[Z]$ in $[i^*\mathcal{F}]_k$. On the
other hand, let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(f)
$$
is the coefficient of $[Z]$ in $\sum [D \cap W_j]_k$.
Hence we see the equality by
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}.
\end{proof}








\section{Gysin homomorphisms}
\label{section-gysin}

\noindent
In this section we use the key formula to show the Gysin homomorphism
factor through rational equivalence.

\begin{lemma}
\label{lemma-gysin-factors-general}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $i : D \to X$ be an effective Cartier divisor.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module
and let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Then $i^*\text{div}_\mathcal{N}(t) = c_1(\mathcal{N}) \cap [D]_{n - 1}$
in $A_{n - 2}(D)$.
\end{lemma}

\begin{proof}
Write $\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t)[Z_i]$
for some integral closed subschemes $Z_i \subset X$ of $\delta$-dimension
$n - 1$. We may assume that the family $\{Z_i\}$ is locally
finite, that $t \in \Gamma(U, \mathcal{N}|_U)$ is a generator
where $U = X \setminus \bigcup Z_i$, and that every irreducible component
of $D$ is one of the $Z_i$, see
Divisors, Lemmas \ref{divisors-lemma-components-locally-finite},
\ref{divisors-lemma-divisor-locally-finite}, and
\ref{divisors-lemma-divisor-meromorphic-locally-finite}.

\medskip\noindent
Set $\mathcal{L} = \mathcal{O}_X(D)$. Denote
$s \in \Gamma(X, \mathcal{O}_X(D)) = \Gamma(X, \mathcal{L})$
the canonical section. We will apply the discussion of
Section \ref{section-key} to our current situation.
For each $i$ let $\xi_i \in Z_i$ be its generic point. Let
$B_i = \mathcal{O}_{X, \xi_i}$. For each $i$ we pick generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{L}_{\xi_i}$
over $B_i$ but we insist that we pick $s_i = s$ if $Z_i \not \subset D$.
Write $s = f_i s_i$ and $t = g_i t_i$ with $f_i, g_i \in B_i$.
Then $\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)$.
On the other hand, we have $f_i \in B_i$ and
$$
[D]_{n - 1} = \sum \text{ord}_{B_i}(f_i)[Z_i]
$$
because of our choices of $s_i$. We claim that
$$
i^*\text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
as cycles. More precisely, the right hand side is a cycle
representing the left hand side. Namely, this is clear by our
formula for $\text{div}_\mathcal{N}(t)$ and the fact that
$\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) = [Z(s_i|_{Z_i})]_{n - 2} =
[Z_i \cap D]_{n - 2}$ when $Z_i \not \subset D$ because in
that case $s_i|_{Z_i} = s|_{Z_i}$ is a regular section, see
Lemma \ref{lemma-compute-c1}. Similarly,
$$
c_1(\mathcal{N}) \cap [D]_{n - 1} =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right)
= \sum \text{div}_{Z_i}(d_{B_i}(f_i, g_i)
$$
of cycles. If $Z_i \not \subset D$, then $f_i = 1$ and hence
$\text{div}_{Z_i}(d_{B_i}(f_i, g_i) = 0$. Thus we get a rational
equivalence between our specific cycles representing
$i^*\text{div}_\mathcal{N}(t)$ and $c_1(\mathcal{N}) \cap [D]_{n - 1}$
on $D$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-gysin-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
The Gysin homomorphism factors through rational equivalence to
give a map $i^* : A_{k + 1}(X) \to A_k(D)$.
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$ and assume that $\alpha \sim_{rat} 0$.
This means there exists a locally finite collection of integral
closed subschemes $W_j \subset X$ of $\delta$-dimension $k + 2$
and $f_j \in R(W_j)^*$ such that
$\alpha = \sum i_{j, *}\text{div}_{W_j}(f_j)$.
Set $X' = \coprod W_i$ and consider the diagram
$$
\xymatrix{
D' \ar[d]_q \ar[r]_{i'} & X' \ar[d]^p \\
D \ar[r]^i & X
}
$$
of Remark \ref{remark-pullback-pairs}. Since $X' \to X$ is proper
we see that $i^*p_* = q_*(i')^*$ by Lemma \ref{lemma-closed-in-X-gysin}.
As we know that $q_*$ factors through rational equivalence
(Lemma \ref{lemma-proper-pushforward-rational-equivalence}), it suffices
to prove the result for $\alpha' = \sum \text{div}_{W_j}(f_j)$
on $X'$. Clearly this reduces us to the case where $X$ is integral
and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.
If $X = D$, then we see that $i^*\alpha$ is equal
to $c_1(\mathcal{L}) \cap \alpha$.
This is rationally equivalent to zero by Lemma \ref{lemma-factors}.
If $D \not = X$, then we see that $i^*\text{div}_X(f)$ is equal to
$c_1(\mathcal{O}_D) \cap [D]_{n - 1}$ in $A_k(D)$ by
Lemma \ref{lemma-gysin-factors-general}. Of course
capping with $c_1(\mathcal{O}_D)$ is the zero map.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module.
Then $i^*(c_1(\mathcal{N}) \cap \alpha) = c_1(i^*\mathcal{N}) \cap i^*\alpha$
in $A_{k - 2}(D)$ for all $\alpha \in A_k(Z)$.
\end{lemma}

\begin{proof}
With exactly the same proof as in Lemma \ref{lemma-gysin-factors}
this follows from Lemmas
\ref{lemma-pushforward-cap-c1},
\ref{lemma-cap-commutative}, and
\ref{lemma-gysin-factors-general}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ and
$(\mathcal{L}', s', i' : D' \to X)$ be two triples as in
Definition \ref{definition-gysin-homomorphism}. Then the diagram
$$
\xymatrix{
A_k(X) \ar[r]_{i^*} \ar[d]_{(i')^*} & A_{k - 1}(D) \ar[d] \\
A_{k - 1}(D') \ar[r] & A_{k - 2}(D \cap D')
}
$$
commutes where each of the maps is a gysin map.
\end{lemma}

\begin{proof}
Denote $j : D \cap D' \to D$ and $j' : D \cap D' \to D'$ the closed
immersions corresponding to $(\mathcal{L}|_{D'}, s|_{D'}$ and
$(\mathcal{L}'_D, s|_D)$. We have to show that
$(j')^*i^*\alpha = j^* (i')^*\alpha$ for all $\alpha \in A_k(X)$.
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Let us prove the equality in case $\alpha = [W]$. We will deduce
it from the key formula.

\medskip\noindent
We let $\sigma$ be a nonzero meromorphic section of $\mathcal{L}|_W$
which we require to be equal to $s|_W$ if $W \not \subset D$.
We let $\sigma'$ be a nonzero meromorphic section of $\mathcal{L}'|_W$
which we require to be equal to $s'|_W$ if $W \not \subset D'$.
Write
$$
\text{div}_{\mathcal{L}|_W}(\sigma) =
\sum \text{ord}_{Z_i, \mathcal{L}|_W}(\sigma)[Z_i] = \sum n_i[Z_i]
$$
and similarly
$$
\text{div}_{\mathcal{L}'|_W}(\sigma') =
\sum \text{ord}_{Z_i, \mathcal{L}'|_W}(\sigma')[Z_i] = \sum n'_i[Z_i]
$$
as in the discussion in Section \ref{section-key}.
Then we see that $Z_i \subset D$ if $n_i \not = 0$ and
$Z'_i \subset D'$ if $n'_i \not = 0$. For each $i$, let $\xi_i \in Z_i$
be the generic point. As in Section \ref{section-key} we choose
for each $i$ an element
$\sigma_i \in \mathcal{L}_{\xi_i}$, resp.\ $\sigma'_i \in \mathcal{L}'_{\xi_i}$
which generates over $B_i = \mathcal{O}_{W, \xi_i}$
and which is equal to the image of
$s$, resp.\ $s'$ if $Z_i \not \subset D$, resp.\ $Z_i \not \subset D'$.
Write $\sigma = f_i \sigma_i$ and $\sigma' = f'_i\sigma'_i$ so that
$n_i = \text{ord}_{B_i}(f_i)$ and
$n'_i = \text{ord}_{B_i}(f'_i)$.
From our definitions it follows that
$$
(j')^*i^*[W] =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i})
$$
as cycles and
$$
j^*(i')^*[W] =
\sum \text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) now gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i}) -
\text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
\right) =
\sum \text{div}_{Z_i}(d_{B_i}(f_i, f'_i))
$$
of cycles. Note that $\text{div}_{Z_i}(d_{B_i}(f_i, f'_i)) = 0$ if
$Z_i \not \subset D \cap D'$ because in this case either $f_i = 1$
or $f'_i = 1$. Thus we get a rational equivalence between our specific
cycles representing $(j')^*i^*[W]$ and $j^*(i')^*[W]$ on $D \cap D' \cap W$.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha$.
\end{proof}







\section{Relative effective Cartier divisors}
\label{section-relative-effective-cartier}

\noindent
Relative effective Cartier divisors are defined and studied
in Divisors, Section \ref{divisors-section-effective-Cartier-morphisms}.
To develop the basic results on chern classes of vector bundles
we only need the case where both the ambient scheme and the effective
Cartier divisor are flat over the base.

\begin{lemma}
\label{lemma-relative-effective-cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $i : D \to X$ be a relative effective Cartier divisor
(Divisors, Definition
\ref{divisors-definition-relative-effective-Cartier-divisor}).
Let $\mathcal{L} = \mathcal{O}_X(D)$.
For any $\alpha \in A_{k + 1}(Y)$ we have
$$
i^*p^*\alpha = (p|_D)^*\alpha
$$
in $A_{k + r}(D)$ and
$$
c_1(\mathcal{L}) \cap p^*\alpha = i_* ((p|_D)^*\alpha)
$$
in $A_{k + r}(X)$.
\end{lemma}

\begin{proof}
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension
$k + 1$. By Divisors, Lemma \ref{divisors-lemma-relative-Cartier}
we see that $D \cap p^{-1}W$ is an effective
Cartier divisor on $p^{-1}W$. By Lemma \ref{lemma-easy-gysin}
we get the first equality in
$$
i^*[p^{-1}W]_{k + r + 1} =
[D \cap p^{-1}W]_{k + r} =
[(p|_D)^{-1}(W)]_{k + r}.
$$
and the second because $D \cap p^{-1}(W) = (p|_D)^{-1}(W)$ as schemes.
Since by definition $p^*[W] = [p^{-1}W]_{k + r + 1}$ we see that
$i^*p^*[W] = (p|_D)^*[W]$ as cycles. If $\alpha = \sum m_j[W_j]$ is a
general $k + 1$ cycle, then we get
$i^*\alpha = \sum m_j i^*p^*[W_j] = \sum m_j(p|_D)^*[W_j]$ as cycles.
This proves then first equality. To deduce the second from the
first apply Lemma \ref{lemma-support-cap-effective-Cartier}.
\end{proof}








\section{Affine bundles}
\label{section-affine-vector}

\noindent
For an affine bundle the pullback map is surjective on Chow groups.

\begin{lemma}
\label{lemma-pullback-affine-fibres-surjective}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Assume that for every $y \in Y$, there exists an open neighbourhood
$U \subset Y$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is identified with the morphism $U \times \mathbf{A}^r \to U$.
Then $f^* : A_k(Y) \to A_{k + r}(X)$ is surjective for all
$k \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $\alpha \in A_{k + r}(X)$.
Write $\alpha = \sum m_j[W_j]$ with $m_j \not = 0$ and
$W_j$ pairwise distinct integral closed subschemes of
$\delta$-dimension $k + r$. Then the family $\{W_j\}$
is locally finite in $X$. For any quasi-compact open
$V \subset Y$ we see that $f^{-1}(V) \cap W_j$
is nonempty only for finitely many $j$. Hence the
collection $Z_j = \overline{f(W_j)}$ of closures
of images is a locally finite collection of integral
closed subschemes of $Y$.

\medskip\noindent
Consider the fibre product diagrams
$$
\xymatrix{
f^{-1}(Z_j) \ar[r] \ar[d]_{f_j} & X \ar[d]^f \\
Z_j \ar[r] & Y
}
$$
Suppose that $[W_j] \in Z_{k + r}(f^{-1}(Z_j))$
is rationally equivalent to $f_j^*\beta_j$ for some
$k$-cycle $\beta_j \in A_k(Z_j)$. Then
$\beta = \sum m_j \beta_j$ will be a $k$-cycle on $Y$
and $f^*\beta = \sum m_j f_j^*\beta_j$ will be rationally
equivalent to $\alpha$ (see
Remark \ref{remark-infinite-sums-rational-equivalences}).
This reduces us to the case $Y$ integral, and
$\alpha = [W]$ for some integral closed subscheme
of $X$ dominating $Y$. In particular we may
assume that $d = \dim_\delta(Y) < \infty$.

\medskip\noindent
Hence we can use induction on $d = \dim_\delta(Y)$.
If $d < k$, then $A_{k + r}(X) = 0$ and the lemma holds.
By assumption there exists a dense open $V \subset Y$ such
that $f^{-1}(V) \cong V \times \mathbf{A}^r$ as schemes over $V$.
Suppose that we can show that $\alpha|_{f^{-1}(V)} = f^*\beta$
for some $\beta \in Z_k(V)$. By Lemma \ref{lemma-exact-sequence-open}
we see that
$\beta = \beta'|_V$ for some $\beta' \in Z_k(Y)$.
By the exact sequence
$A_k(f^{-1}(Y \setminus V)) \to A_k(X) \to A_k(f^{-1}(V))$
of Lemma \ref{lemma-restrict-to-open}
we see that $\alpha - f^*\beta'$ comes from
a cycle $\alpha' \in A_{k + r}(f^{-1}(Y \setminus V))$.
Since $\dim_\delta(Y \setminus V) < d$ we win by
induction on $d$.

\medskip\noindent
Thus we may assume that $X = Y \times \mathbf{A}^r$.
In this case we can factor $f$ as
$$
X = Y \times \mathbf{A}^r \to
Y \times \mathbf{A}^{r - 1} \to \ldots \to
Y \times \mathbf{A}^1 \to Y.
$$
Hence it suffices to do the case $r = 1$. By the argument in the
second paragraph of the proof we are reduced to the case
$\alpha = [W]$, $Y$ integral, and $W \to Y$ dominant.
Again we can do induction on $d = \dim_\delta(Y)$.
If $W = Y \times \mathbf{A}^1$, then $[W] = f^*[Y]$.
Lastly, $W \subset Y \times \mathbf{A}^1$ is a proper inclusion,
then $W \to Y$ induces a finite field extension $R(Y) \subset R(W)$.
Let $P(T) \in R(Y)[T]$ be the monic irreducible polynomial such
that the generic fibre of $W \to Y$ is cut out by $P$ in
$\mathbf{A}^1_{R(Y)}$. Let $V \subset Y$ be a nonempty open such
that $P \in \Gamma(V, \mathcal{O}_Y)[T]$, and such that
$W \cap f^{-1}(V)$ is still cut out by $P$. Then we see that
$\alpha|_{f^{-1}(V)} \sim_{rat} 0$ and hence $\alpha \sim_{rat} \alpha'$
for some cycle $\alpha'$ on $(Y \setminus V) \times \mathbf{A}^1$.
By induction on the dimension we win.
\end{proof}

\begin{lemma}
\label{lemma-linebundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let
$$
p :
L = \underline{\Spec}(\text{Sym}^*(\mathcal{L}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + 1}(L)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $o : X \to L$ be the zero section of $L \to X$, i.e., the morphism
corresponding to the surjection $\text{Sym}^*(\mathcal{L}) \to \mathcal{O}_X$
which maps $\mathcal{L}^{\otimes n}$ to zero for all $n > 0$.
Then $p \circ o = \text{id}_X$ and $o(X)$ is an effective
Cartier divisor on $L$. Hence by Lemma \ref{lemma-relative-effective-cartier}
we see that $o^* \circ p^* = \text{id}$ and we conclude that $p^*$ is
injective too.
\end{proof}

\begin{remark}
\label{remark-when-isomorphism}
We will see later (Lemma \ref{lemma-vectorbundle}) that if $X$ is a
vector bundle of rank $r$ over $Y$ then the pullback map
$A_k(Y) \to A_{k + r}(X)$
is an isomorphism. This is true whenever $X \to Y$ satisfies
the assumptions of Lemma \ref{lemma-pullback-affine-fibres-surjective}, see
\cite[Lemma 2.2]{Totaro-group}.
\end{remark}







\section{Bivariant intersection theory}
\label{section-bivariant}

\noindent
In order to intelligently talk about higher chern classes of vector
bundles we introduce the following notion, following \cite{FM}.
It follows from \cite[Theorem 17.1]{F} that our definition agrees
with that of \cite{F} modulo the caveat that we are working in different
settings.

\begin{definition}
\label{definition-bivariant-class}
\begin{reference}
Similar to \cite[Definition 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$.
A {\it bivariant class $c$ of degree $p$ for $f$} is given by a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : A_k(X') \longrightarrow A_{k - p}(Y')
$$
where $Y' = X' \times_X Y$, satisfying the following conditions
\begin{enumerate}
\item if $Y'' \to Y'$ is a proper, then
$c \cap (Y'' \to Y')_*\alpha'' = (X'' \to X')_*(c \cap \alpha'')$
for all $\alpha''$ on $Y''$,
\item if $Y'' \to Y'$ is flat locally of finite type of
fixed relative dimension, then
$c \cap (X'' \to X')^*\alpha' = (Y'' \to Y')^*(c \cap \alpha')$
for all $\alpha'$ on $Y'$, and
\item if $(\mathcal{L}', s', i' : D' \to X')$ is as in
Definition \ref{definition-gysin-homomorphism}
with pullback $(\mathcal{N}', t', j' : E' \to Y')$ to $Y'$,
then we have $c \cap (i')^*\alpha' = (j')^*(c \cap \alpha')$
for all $\alpha'$ on $X'$.
\end{enumerate}
The collection of all bivariant classes of degree $p$ for $f$ is
denoted $A^p(X \to Y)$.
\end{definition}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $f : X \to Y$
be a morphism of schemes locally of finite type over $S$. Let
$p \in \mathbf{Z}$. It is clear that $A^p(X \to Y)$ is an abelian group.
Moreover, it is clear that we have a bilinear composition
$$
A^p(X \to Y) \times A^q(Y \to Z) \to A^{p + q}(X \to Z)
$$
which is associative.
We will be most interested in $A^p(X) = A^p(X \to X)$, which will always mean
the bivariant cohomology classes for $\text{id}_X$. Namely, that is where
chern classes will live.

\begin{definition}
\label{definition-chow-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The {\it Chow cohomology}
of $X$ is the graded $\mathbf{Z}$-algebra $A^*(X)$ whose degree
$p$ component is $A^p(X \to X)$.
\end{definition}

\noindent
Warning: It is not clear that a priori that the $\mathbf{Z}$-algebra structure
on $A^*(X)$ is commutative, but we will see that chern classes live
in its center.

\begin{remark}
\label{remark-pullback-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Then there is a canonical $\mathbf{Z}$-algebra map $A^*(Y) \to A^*(X)$.
Namely, given $c \in A^p(Y)$ and $X' \to X$, then we can let $f^*c$
be defined by the map $c \cap - : A_k(X') \to A_{k - p}(X')$ which is
given by thinking of $X'$ as a scheme over $Y$.
\end{remark}

\begin{lemma}
\label{lemma-cap-c1-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then the rule that to $f : X' \to X$ assignes
$c_1(f^*\mathcal{L}) \cap - : A_k(X') \to A_{k - 1}(X')$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-factors},
\ref{lemma-pushforward-cap-c1},
\ref{lemma-flat-pullback-cap-c1}, and
\ref{lemma-gysin-commutes-cap-c1}.
\end{proof}

\noindent
Having said this we see that we can define $c_1(\mathcal{L})$ as the element
of $A^1(X)$ constructed in Lemma \ref{lemma-cap-c1-bivariant}.
We will return to this in Section \ref{section-relations-chern-classes}.

\begin{lemma}
\label{lemma-flat-pullback-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$
between schemes locally of finite type over $S$.
Then the rule that to $Y' \to Y$ assignes
$(f')^* : A_k(Y') \to A_{k + r}(X')$ where $X' = X \times_Y Y'$
is a bivariant class of degree $-r$.
\end{lemma}

\begin{proof}
This follows from
Lemmas \ref{lemma-flat-pullback-rational-equivalence},
\ref{lemma-compose-flat-pullback},
\ref{lemma-flat-pullback-proper-pushforward}, and
\ref{lemma-gysin-flat-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be a triple as in
Definition \ref{definition-gysin-homomorphism}.
Then the rule that to $f : X' \to X$ assignes
$(i')^* : A_k(X') \to A_{k - 1}(D')$ where $D' = D \times_X X'$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-gysin-factors},
\ref{lemma-closed-in-X-gysin},
\ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
\end{proof}

\noindent
Here is a criterion to see that an operation
passes through rational equivalence.

\begin{lemma}
\label{lemma-factors-through-rational-equivalence}
\begin{reference}
Very weak form of \cite[Theorem 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$. Suppose given a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : Z_k(X') \longrightarrow A_{k - p}(Y')
$$
where $Y' = X' \times_X Y$, satisfying condition (3) of
Definition \ref{definition-bivariant-class}
whenever $\mathcal{L}'|_{D'} \cong \mathcal{O}_{D'}$. Then
$c \cap -$ factors through rational equivalence.
\end{lemma}

\begin{proof}
The statement makes sense because given a triple
$(\mathcal{L}, s, i : D \to X)$ as in
Definition \ref{definition-gysin-homomorphism}
such that $\mathcal{L}|_D \cong \mathcal{O}_D$, then
the operation $i^*$ is defined on the level of cycles, see
Remark \ref{remark-on-cycles}.
Let $\alpha \in Z_k(X')$ be a cycle which is rationally equivalent to zero.
We have to show that $c \cap \alpha = 0$. By
Lemma \ref{lemma-rational-equivalence-family}
there exists a cycle $\beta \in Z_{k + 1}(X' \times \mathbf{P}^1)$
such that $\alpha = i_0^*\beta - i_\infty^*\beta$
where $i_0, i_\infty : X' \to X' \times \mathbf{P}^1$ are the
closed immersions of $X'$ over $0, \infty$. Since these are
examples of effective Cartier divisors with trivial normal
bundles, we see that $c \cap i_0^*\beta = j_0^*(c \cap \beta)$
and $c \cap i_\infty^*\beta = j_\infty^*(c \cap \beta)$
where $j_0, j_\infty : Y' \to Y' \times \mathbf{P}^1$ are
closed immersions as before. Since
$j_0^*(c \cap \beta) \sim_{rat} j_\infty^*(c \cap \beta)$
(follows from Lemma \ref{lemma-rational-equivalence-family}) we conclude.
\end{proof}

\noindent
Here we see that $c_1(\mathcal{L})$ is in the center of $A^*(X)$.

\begin{lemma}
\label{lemma-c1-center}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then $c_1(\mathcal{L}) \in A^1(X)$ commutes with every
element $c \in A^p(X)$.
\end{lemma}

\begin{proof}
Let $p : L \to X$ be as in Lemma \ref{lemma-linebundle} and let $o : X \to L$
be the zero section. Observe that $p^*\mathcal{L}^{\otimes -1}$ has a
canonical section whose zero scheme is exactly the effective Cartier divisor
$o(X)$. Let $\alpha \in A_k(X)$. Then we see that
$$
p^*(c_1(\mathcal{L}^{\otimes -1}) \cap \alpha) =
c_1(p^*\mathcal{L}^{\otimes -1}) \cap p^*\alpha =
o_* o^* p^*\alpha
$$
by Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-relative-effective-cartier}.
Since $c$ is a bivariant class we have
\begin{align*}
p^*(c \cap c_1(\mathcal{L}^{\otimes -1}) \cap \alpha)
& =
c \cap p^*(c_1(\mathcal{L}^{\otimes -1}) \cap \alpha) \\
& =
c \cap o_* o^* p^*\alpha \\
& =
o_* o^* p^*(c \cap \alpha) \\
& =
p^*(c_1(\mathcal{L}^{\otimes -1}) \cap c \cap \alpha)
\end{align*}
(last equality by the above applied to $c \cap \alpha$).
Since $p^*$ is injective by a lemma cited above we get that
$c_1(\mathcal{L}^{\otimes -1})$
is in the center of $A^*(X)$. This proves the lemma.
\end{proof}

\noindent
Here a criterion for when a bivariant class is zero.

\begin{lemma}
\label{lemma-bivariant-zero}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $c \in A^p(X)$.
Then $c$ is zero if and only if $c \cap [Y] = 0$ in $A_*(Y)$
for every integral scheme $Y$ locally of finite type over $X$.
\end{lemma}

\begin{proof}
The if direction is clear. For the converse, assume that $c \cap [Y] = 0$ in
$A_*(Y)$ for every integral scheme $Y$ locally of finite type over $X$.
Let $X' \to X$ be locally of finite type. Let $\alpha \in A_k(X')$.
Write $\alpha = \sum n_i [Y_i]$ with $Y_i \subset X'$ a locally finite
collection of integral closed subschemes of $\delta$-dimension $k$.
Then we see that $\alpha$ is pushforward of the cycle
$\alpha' = \sum n_i[Y_i]$ on $X'' = \coprod Y_i$ under the
proper morphism $X'' \to X'$. By the properties of bivariant
classes it suffices to prove that $c \cap \alpha' = 0$ in $A_{k - p}(X'')$.
We have $A_{k - p}(X'') = \prod A_{k - p}(Y_i)$ as follows immediately
from the definitions. The projection maps $A_{k - p}(X'') \to A_{k - p}(Y_i)$
are given by flat pullback. Since capping with $c$ commutes with
flat pullback, we see that it suffices to show that $c \cap [Y_i]$
is zero in $A_{k - p}(Y_i)$ which is true by assumption.
\end{proof}





\section{Projective space bundle formula}
\label{section-projective-space-bundle-formula}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Consider a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$.
Our convention is that the {\it projective bundle associated to
$\mathcal{E}$} is the morphism
$$
\xymatrix{
\mathbf{P}(\mathcal{E}) =
\underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{E}))
\ar[r]^-\pi
& X
}
$$
over $X$ with
$\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$ normalized so that
$\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) = \mathcal{E}$.
In particular there is a surjection
$\pi^*\mathcal{E} \to \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
We will say informally ``let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$'' to denote
the situation where $P = \mathbf{P}(\mathcal{E})$ and
$\mathcal{O}_P(1) = \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.

\begin{lemma}
\label{lemma-cap-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
For any $\alpha \in A_k(X)$ the element
$$
\pi_*\left(
c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha
\right)
\in
A_{k + r - 1 - s}(X)
$$
is $0$ if $s < r - 1$ and is equal to $\alpha$ when $s = r - 1$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
Note that $\pi^*[Z] = [\pi^{-1}(Z)]$ as $\pi^{-1}(Z)$ is integral of
$\delta$-dimension $r - 1$.
If $s < r - 1$, then by construction
$c_1(\mathcal{O}_P(1))^s \cap \pi^*[Z]$
is represented by a $(k + r - 1 - s)$-cycle supported on
$\pi^{-1}(Z)$. Hence the pushforward of this cycle
is zero for dimension reasons.

\medskip\noindent
Let $s = r - 1$. By the argument given above we see that
$\pi_*(c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha) = n [Z]$
for some $n \in \mathbf{Z}$. We want to show that $n = 1$.
For the same dimension reasons
as above it suffices to prove this result after replacing $X$ by
$X \setminus T$ where $T \subset Z$ is a proper closed subset.
Let $\xi$ be the generic point of $Z$.
We can choose elements $e_1, \ldots, e_{r - 1} \in \mathcal{E}_\xi$
which form part of a basis of $\mathcal{E}_\xi$.
These give rational sections $s_1, \ldots, s_{r - 1}$
of $\mathcal{O}_P(1)|_{\pi^{-1}(Z)}$ whose common zero set
is the closure of the image a rational section of
$\mathbf{P}(\mathcal{E}|_Z) \to Z$ union a closed subset whose
support maps to a proper closed subset $T$ of $Z$.
After removing $T$ from $X$ (and correspondingly $\pi^{-1}(T)$
from $P$), we see that $s_1, \ldots, s_n$ form a sequence
of global sections
$s_i \in \Gamma(\pi^{-1}(Z), \mathcal{O}_{\pi^{-1}(Z)}(1))$
whose common zero set is the image of a section $Z \to \pi^{-1}(Z)$.
Hence we see successively that
\begin{eqnarray*}
\pi^*[Z] & = & [\pi^{-1}(Z)] \\
c_1(\mathcal{O}_P(1)) \cap \pi^*[Z] & = & [Z(s_1)] \\
c_1(\mathcal{O}_P(1))^2 \cap \pi^*[Z] & = & [Z(s_1) \cap Z(s_2)] \\
\ldots & = & \ldots \\
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*[Z] & = &
[Z(s_1) \cap \ldots \cap Z(s_{r - 1})]
\end{eqnarray*}
by repeated applications of Lemma \ref{lemma-geometric-cap}.
Since the pushforward by $\pi$ of the image of a
section of $\pi$ over $Z$ is clearly $[Z]$ we see the result
when $\alpha = [Z]$. We omit the verification that these
arguments imply the result for a general cycle $\alpha = \sum n_j [Z_j]$.
\end{proof}

\begin{lemma}[Projective space bundle formula]
\label{lemma-chow-ring-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
The map
$$
\bigoplus\nolimits_{i = 0}^{r - 1}
A_{k + i}(X)
\longrightarrow
A_{k + r - 1}(P),
$$
$$
(\alpha_0, \ldots, \alpha_{r-1})
\longmapsto
\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1}
$$
is an isomorphism.
\end{lemma}

\begin{proof}
Fix $k \in \mathbf{Z}$. We first show the map is injective.
Suppose that $(\alpha_0, \ldots, \alpha_{r - 1})$ is an element
of the left hand side that maps to zero.
By Lemma \ref{lemma-cap-projective-bundle} we see that
$$
0 = \pi_*(\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1})
= \alpha_{r - 1}
$$
Next, we see that
$$
0 = \pi_*(c_1(\mathcal{O}_P(1)) \cap (\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 2} \cap \pi^*\alpha_{r - 2}))
= \alpha_{r - 2}
$$
and so on. Hence the map is injective.

\medskip\noindent
It remains to show the map is surjective.
Let $X_i$, $i \in I$ be the irreducible components of $X$.
Then $P_i = \mathbf{P}(\mathcal{E}|_{X_i})$, $i \in I$
are the irreducible components of $P$. Consider the commutative
diagram
$$
\xymatrix{
\coprod P_i \ar[d]_{\coprod \pi_i} \ar[r]_p & P \ar[d]^\pi \\
\coprod X_i \ar[r]^q & X
}
$$
Observe that $p_*$ is surjective. If $\beta \in A_k(\coprod X_i)$
then $\pi^* q_* \beta = p_*(\coprod \pi_i)^* \beta$, see
Lemma \ref{lemma-flat-pullback-proper-pushforward}. Similarly for
capping with $c_1(\mathcal{O}(1))$ by
Lemma \ref{lemma-pushforward-cap-c1}.
Hence, if the map of the lemma is surjective for each
of the morphisms $\pi_i : P_i \to X_i$, then the map is
surjective for $\pi : P \to X$. Hence we may assume $X$ is irreducible.
Thus $\dim_\delta(X) < \infty$ and in particular we may use
induction on $\dim_\delta(X)$.

\medskip\noindent
The result is clear if $\dim_\delta(X) < k$.
Let $\alpha \in A_{k + r - 1}(P)$.
For any locally closed subscheme $T \subset X$ denote
$\gamma_T : \bigoplus A_{k + i}(T) \to A_{k + r - 1}(\pi^{-1}(T))$
the map
$$
\gamma_T(\alpha_0, \ldots, \alpha_{r - 1})
= \pi^*\alpha_0 + \ldots +
c_1(\mathcal{O}_{\pi^{-1}(T)}(1))^{r - 1} \cap \pi^*\alpha_{r - 1}.
$$
Suppose for some nonempty open $U \subset X$ we have
$\alpha|_{\pi^{-1}(U)} = \gamma_U(\alpha_0, \ldots, \alpha_{r - 1})$.
Then we may choose lifts $\alpha'_i \in A_{k + i}(X)$ and we
see that $\alpha - \gamma_X(\alpha'_0, \ldots, \alpha'_{r - 1})$
is by Lemma \ref{lemma-restrict-to-open}
rationally equivalent to a $k$-cycle on $P_Y = \mathbf{P}(\mathcal{E}|_Y)$
where $Y = X \setminus U$ as a reduced closed subscheme.
Note that $\dim_\delta(Y) < \dim_\delta(X)$.
By induction the result holds
for $P_Y \to Y$ and hence the result holds for $\alpha$.
Hence we may replace $X$ by any nonempty open of $X$.

\medskip\noindent
In particular we may assume that $\mathcal{E} \cong \mathcal{O}_X^{\oplus r}$.
In this case $\mathbf{P}(\mathcal{E}) = X \times \mathbf{P}^{r - 1}$.
Let us use the stratification
$$
\mathbf{P}^{r - 1} = \mathbf{A}^{r - 1}
\amalg \mathbf{A}^{r - 2}
\amalg \ldots
\amalg \mathbf{A}^0
$$
The closure of each stratum is a $\mathbf{P}^{r - 1 - i}$ which is a
representative of $c_1(\mathcal{O}(1))^i \cap [\mathbf{P}^{r - 1}]$.
Hence $P$ has a similar stratification
$$
P = U^{r - 1} \amalg U^{r - 2} \amalg \ldots \amalg U^0
$$
Let $P^i$ be the closure of $U^i$. Let $\pi^i : P^i \to X$
be the restriction of $\pi$ to $P^i$.
Let $\alpha \in A_{k + r - 1}(P)$. By
Lemma \ref{lemma-pullback-affine-fibres-surjective}
we can write $\alpha|_{U^{r - 1}} = \pi^*\alpha_0|_{U^{r - 1}}$
for some $\alpha_0 \in A_k(X)$. Hence the difference
$\alpha - \pi^*\alpha_0$ is the image of some
$\alpha' \in A_{k + r - 1}(P^{r - 2})$.
By Lemma \ref{lemma-pullback-affine-fibres-surjective}
again we can write
$\alpha'|_{U^{r - 2}} = (\pi^{r - 2})^*\alpha_1|_{U^{r - 2}}$
for some $\alpha_1 \in A_{k + 1}(X)$.
By Lemma \ref{lemma-relative-effective-cartier}
we see that the image of $(\pi^{r - 2})^*\alpha_1$
represents $c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$.
We also see that
$\alpha - \pi^*\alpha_0 - c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$
is the image of some $\alpha'' \in A_{k + r - 1}(P^{r - 3})$.
And so on.
\end{proof}

\begin{lemma}
\label{lemma-vectorbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let
$$
p :
E = \underline{\Spec}(\text{Sym}^*(\mathcal{E}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + r}(E)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
(For the case of linebundles, see Lemma \ref{lemma-linebundle}.)
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $(\pi  : P \to X, \mathcal{O}_P(1))$
be the projective space bundle associated
to the finite locally free sheaf $\mathcal{E} \oplus \mathcal{O}_X$.
Let $s \in \Gamma(P, \mathcal{O}_P(1))$ correspond to the global
section $(0, 1) \in \Gamma(X, \mathcal{E} \oplus \mathcal{O}_X)$.
Let $D = Z(s) \subset P$. Note that
$(\pi|_D : D \to X , \mathcal{O}_P(1)|_D)$
is the projective space bundle associated
to $\mathcal{E}$. We denote $\pi_D = \pi|_D$ and
$\mathcal{O}_D(1) = \mathcal{O}_P(1)|_D$.
Moreover, $D$ is an effective
Cartier divisor on $P$. Hence $\mathcal{O}_P(D) = \mathcal{O}_P(1)$
(see Divisors, Lemma \ref{divisors-lemma-characterize-OD}).
Also there is an isomorphism
$E \cong P \setminus D$. Denote $j : E \to P$ the
corresponding open immersion.
For injectivity we use that the kernel of
$$
j^* :
A_{k + r}(P)
\longrightarrow
A_{k + r}(E)
$$
are the cycles supported in the effective Cartier divisor $D$,
see Lemma \ref{lemma-restrict-to-open}. So if $p^*\alpha = 0$, then
$\pi^*\alpha = i_*\beta$ for some $\beta \in A_{k + r}(D)$.
By Lemma \ref{lemma-chow-ring-projective-bundle} we may write
$$
\beta = \pi_D^*\beta_0 +
\ldots + c_1(\mathcal{O}_D(1))^{r - 1} \cap \pi_D^* \beta_{r - 1}.
$$
for some $\beta_i \in A_{k + i}(X)$.
By Lemmas \ref{lemma-relative-effective-cartier}
and \ref{lemma-pushforward-cap-c1}
this implies
$$
\pi^*\alpha = i_*\beta =
c_1(\mathcal{O}_P(1)) \cap \pi^*\beta_0 +
\ldots +
c_1(\mathcal{O}_D(1))^r \cap \pi^*\beta_{r - 1}.
$$
Since the rank of $\mathcal{E} \oplus \mathcal{O}_X$ is $r + 1$
this contradicts Lemma \ref{lemma-pushforward-cap-c1} unless all
$\alpha$ and all $\beta_i$ are zero.
\end{proof}








\section{The Chern classes of a vector bundle}
\label{section-chern-classes-vector-bundles}

\noindent
We can use the projective space bundle formula to define the
chern classes of a rank $r$ vector bundle in terms of the expansion
of $c_1(\mathcal{O}(1))^r$ in terms of the lower powers, see
formula (\ref{equation-chern-classes}).
The reason for the signs will be explained later.

\begin{definition}
\label{definition-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$
on $X$. Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective space
bundle associated to $\mathcal{E}$.
\begin{enumerate}
\item By Lemma \ref{lemma-chow-ring-projective-bundle} there are
elements $c_i \in A_{n - i}(X)$, $i = 0, \ldots, r$
such that $c_0 = [X]$, and
\begin{equation}
\label{equation-chern-classes}
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
\item With notation as above we set
$c_i(\mathcal{E}) \cap [X] = c_i$
as an element of $A_{n - i}(X)$.
We call these the {\it chern classes of $\mathcal{E}$ on $X$}.
\item The {\it total chern class of $\mathcal{E}$ on $X$}
is the combination
$$
c({\mathcal E}) \cap [X] =
c_0({\mathcal E}) \cap [X]
+ c_1({\mathcal E}) \cap [X] + \ldots
+ c_r({\mathcal E}) \cap [X]
$$
which is an element of
$A_*(X) = \bigoplus_{k \in \mathbf{Z}} A_k(X)$.
\end{enumerate}
\end{definition}

\noindent
Let us check that this does not give a new notion in case the
vector bundle has rank $1$.

\begin{lemma}
\label{lemma-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The first chern class of $\mathcal{L}$ on $X$ of
Definition \ref{definition-chern-classes}
is equal to the Weil divisor associated to $\mathcal{L}$
by Definition \ref{definition-divisor-invertible-sheaf}.
\end{lemma}

\begin{proof}
In this proof we use $c_1(\mathcal{L}) \cap [X]$ to denote the
construction of Definition \ref{definition-divisor-invertible-sheaf}.
Since $\mathcal{L}$ has rank $1$ we have
$\mathbf{P}(\mathcal{L}) = X$ and
$\mathcal{O}_{\mathbf{P}(\mathcal{L})}(1) = \mathcal{L}$
by our normalizations. Hence (\ref{equation-chern-classes})
reads
$$
(-1)^1 c_1(\mathcal{L}) \cap c_0 + (-1)^0 c_1 = 0
$$
Since $c_0 = [X]$, we conclude $c_1 = c_1(\mathcal{L}) \cap [X]$
as desired.
\end{proof}

\begin{remark}
\label{remark-equation-signs}
We could also rewrite equation \ref{equation-chern-classes} as
\begin{equation}
\label{equation-signs}
\sum\nolimits_{i = 0}^r
c_1(\mathcal{O}_P(-1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
but we find it easier to work with the tautological quotient
sheaf $\mathcal{O}_P(1)$ instead of
its dual.
\end{remark}




\section{Intersecting with chern classes}
\label{section-intersecting-chern-classes}

\noindent
In this section we study the operation of capping with chern
classes of vector bundles. Our definition follows the familiar
pattern of first defining the operation on prime cycles and then
summing, but in Lemma \ref{lemma-determine-intersections} we show
that the result is determined by the usual formula on the associated
projective bundle.

\begin{definition}
\label{definition-cap-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
We define, for every integer $k$ and any $0 \leq j \leq r$,
an operation
$$
c_j(\mathcal{E}) \cap - : Z_k(X) \to A_{k - j}(X)
$$
called {\it intersection with the $j$th chern class of $\mathcal{E}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ of $\delta$-dimension
$k$ we define
$$
c_j(\mathcal{E}) \cap [W] = i_*(c_j({i^*\mathcal{E}}) \cap [W])
\in
A_{k - j}(X)
$$
where $c_j({i^*\mathcal{E}}) \cap [W]$ is as defined in
Definition \ref{definition-chern-classes}.
\item For a general $k$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_j(\mathcal{E}) \cap \alpha = \sum n_i c_j(\mathcal{E}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Again, if $\mathcal{E}$ has rank $1$ then this agrees with our
previous definition.

\begin{lemma}
\label{lemma-determine-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective bundle
associated to $\mathcal{E}$.
For $\alpha \in Z_k(X)$ the elements
$c_j(\mathcal{E}) \cap \alpha$ are the unique elements
$\alpha_j$ of $A_{k - j}(X)$
such that $\alpha_0 = \alpha$ and
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
holds in the Chow group of $P$.
\end{lemma}

\begin{proof}
The uniqueness of $\alpha_0, \ldots, \alpha_r$ such that
$\alpha_0 = \alpha$ and such that
the displayed equation holds follows from
the projective space bundle formula
Lemma \ref{lemma-chow-ring-projective-bundle}.
The identity holds by definition for $\alpha = [W]$ where $W$
is an integral closed subscheme of $X$.
For a general $k$-cycle $\alpha$ on $X$ write
$\alpha = \sum n_a[W_a]$ with $n_a \not = 0$, and
$i_a : W_a \to X$ pairwise distinct integral closed subschemes.
Then the family $\{W_a\}$ is locally finite on $X$.
Set $P_a = \pi^{-1}(W_a) = \mathbf{P}(\mathcal{E}|_{W_a})$.
Denote $i'_a : P_a \to P$ the corresponding closed immersions.
Consider the fibre product diagram
$$
\xymatrix{
P' \ar@{=}[r] \ar[d]_{\pi'} &
\coprod P_a \ar[d]_{\coprod \pi_a} \ar[r]_{\coprod i'_a} &
P \ar[d]^\pi \\
X' \ar@{=}[r] &
\coprod W_a \ar[r]^{\coprod i_a} &
X
}
$$
The morphism $p : X' \to X$ is proper. Moreover
$\pi' : P' \to X'$ together with the invertible sheaf
$\mathcal{O}_{P'}(1) = \coprod \mathcal{O}_{P_a}(1)$
which is also the pullback of $\mathcal{O}_P(1)$
is the projective bundle associated to
$\mathcal{E}' = p^*\mathcal{E}$. By definition
$$
c_j(\mathcal{E}) \cap [\alpha]
=
\sum i_{a, *}(c_j(\mathcal{E}|_{W_a}) \cap [W_a]).
$$
Write $\beta_{a, j} = c_j(\mathcal{E}|_{W_a}) \cap [W_a]$
which is an element of $A_{k - j}(W_a)$. We have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_a}(1))^i \cap \pi_a^*(\beta_{a, r - i}) = 0
$$
for each $a$ by definition. Thus clearly we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P'}(1))^i \cap (\pi')^*(\beta_{r - i}) = 0
$$
with $\beta_j = \sum n_a\beta_{a, j} \in A_{k - j}(X')$. Denote
$p' : P' \to P$ the morphism $\coprod i'_a$.
We have $\pi^*p_*\beta_j = p'_*(\pi')^*\beta_j$
by Lemma \ref{lemma-flat-pullback-proper-pushforward}.
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
we conclude that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*(p_*\beta_j) = 0
$$
Since $p_*\beta_j$ is a representative of $c_j(\mathcal{E}) \cap \alpha$
we win.
\end{proof}

\noindent
We will consistently use this characterization of chern classes
to prove many more properties.

\begin{lemma}
\label{lemma-cap-chern-class-factors-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
If $\alpha \sim_{rat} \beta$ are rationally equivalent $k$-cycles
on $X$ then $c_j(\mathcal{E}) \cap \alpha = c_j(\mathcal{E}) \cap \beta$
in $A_{k - j}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-determine-intersections} the elements
$\alpha_j = c_j(\mathcal{E}) \cap \alpha$, $j \geq 1$ and
$\beta_j = c_j(\mathcal{E}) \cap \beta$, $j \geq 1$ are uniquely determined
by the {\it same} equation in the chow group of the projective
bundle associated to $\mathcal{E}$. (This of course relies on the fact that
flat pullback is compatible with rational equivalence, see
Lemma \ref{lemma-flat-pullback-rational-equivalence}.) Hence they are equal.
\end{proof}

\noindent
In other words capping with chern classes of
finite locally free sheaves factors through rational equivalence
to give maps
$$
c_j(\mathcal{E}) \cap - : A_k(X) \to A_{k - j}(X).
$$
Our next task is to show that chern classes are bivariant classes, see
Definition \ref{definition-bivariant-class}.

\begin{lemma}
\label{lemma-pushforward-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha$ be a $k$-cycle on $X$.
Let $\mathcal{E}$ be a finite locally free sheaf on $Y$.
Then
$$
p_*(c_j(p^*\mathcal{E}) \cap \alpha) = c_j(\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Let $(\pi : P \to Y, \mathcal{O}_P(1))$ be the projective bundle associated
to $\mathcal{E}$. Then $P_X = X \times_Y P$ is the projective bundle associated
to $p^*\mathcal{E}$ and $\mathcal{O}_{P_X}(1)$ is the pullback of
$\mathcal{O}_P(1)$. Write $\alpha_j = c_j(p^*\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi_X^*(\alpha_{r - i}) = 0
$$
in the chow group of $P_X$. Consider the fibre product diagram
$$
\xymatrix{
P_X \ar[r]_-{p'} \ar[d]_{\pi_X} & P \ar[d]^\pi \\
X \ar[r]^p & Y
}
$$
Apply proper pushforward $p'_*$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
to the displayed equality above. Using
Lemmas \ref{lemma-pushforward-cap-c1} and
\ref{lemma-flat-pullback-proper-pushforward} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(p_*\alpha_{r - i}) = 0
$$
in the chow group of $P$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $Y$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_j(\mathcal{E}) \cap \alpha) = c_j(f^*\mathcal{E}) \cap f^*\alpha
$$
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_X = \mathbf{P}(f^*\mathcal{E}) \ar[r]_-{f'} \ar[d]_{\pi_X} &
P \ar[d]^\pi \\
X \ar[r]^f & Y
}
$$
Note that $\mathcal{O}_{P_X}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply flat pullback $(f')^*$
(Lemma \ref{lemma-flat-pullback-rational-equivalence}) to the displayed
equation above. By Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-compose-flat-pullback} we see that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_X}(1))^i \cap
\pi_X^*(f^*\alpha_{r - i}) = 0
$$
holds in the chow group of $P_X$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-cap-chern-class-commutes-with-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Then $c_j(\mathcal{E}|_D) \cap i^*\alpha = i^*(c_j(\mathcal{E}) \cap \alpha)$
for all $\alpha \in A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to X, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_D = \mathbf{P}(\mathcal{E}|_D) \ar[r]_-{i'} \ar[d]_{\pi_D} &
P \ar[d]^\pi \\
D \ar[r]^i & X
}
$$
Note that $\mathcal{O}_{P_D}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply the gysin map $(i')^*$ (Lemma \ref{lemma-gysin-factors}) to the
displayed equation above.
Applying Lemmas \ref{lemma-gysin-commutes-cap-c1} and
\ref{lemma-gysin-flat-pullback} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_D}(1))^i \cap
\pi_D^*(i^*\alpha_{r - i}) = 0
$$
in the chow group of $P_D$.
By the characterization of Lemma \ref{lemma-determine-intersections}
we conclude.
\end{proof}

\noindent
At this point we have enough material to be able to prove that
capping with chern classes defines a bivariant class.

\begin{lemma}
\label{lemma-cap-cp-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. Let $0 \leq p \leq r$.
Then the rule that to $f : X' \to X$ assignes
$c_p(f^*\mathcal{E}) \cap - : A_k(X') \to A_{k - 1}(X')$
is a bivariant class of degree $p$.
\end{lemma}

\begin{proof}
Immediate from Lemmas
\ref{lemma-cap-chern-class-factors-rational-equivalence},
\ref{lemma-pushforward-cap-cj},
\ref{lemma-flat-pullback-cap-cj}, and
\ref{lemma-cap-chern-class-commutes-with-gysin}
and Definition \ref{definition-bivariant-class}.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. At this point we define the {\it chern classes}
of $\mathcal{E}$ to be the elements
$$
c_j(\mathcal{E}) \in A^j(X)
$$
constructed in Lemma \ref{lemma-cap-cp-bivariant}. The
{\it total chern class} of $\mathcal{E}$ is the element
$$
c(\mathcal{E}) = 
c_0(\mathcal{E}) + c_1(\mathcal{E}) + \ldots + c_r(\mathcal{E})
\in A^*(X)
$$
Next we see that chern classes are in the center of the bivariant
Chow cohomology ring $A^*(X)$.

\begin{lemma}
\label{lemma-cap-commutative-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module of rank $r$.
Then $c_j(\mathcal{L}) \in A^j(X)$ commutes with every
element $c \in A^p(X)$. In particular, if $\mathcal{F}$ is a
second locally free $\mathcal{O}_X$-module on $X$ of rank $s$, then
$$
c_i(\mathcal{E}) \cap c_j(\mathcal{F}) \cap \alpha
=
c_j(\mathcal{F}) \cap c_i(\mathcal{E}) \cap \alpha
$$
as elements of $A_{k - i - j}(X)$ for all $\alpha \in A_k(X)$.
\end{lemma}

\begin{proof}
Let $\alpha \in A_k(X)$. Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Applying $c \cap -$ and using
Lemma \ref{lemma-c1-center} and the properties of bivariant classes we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(c \cap \alpha_{r - i}) = 0
$$
in the Chow group of $P$. Hence we see that $c \cap \alpha_j$ is
equal to $c_j(\mathcal{E}) \cap (c \cap \alpha)$ by the characterization
of Lemma \ref{lemma-determine-intersections}.
This proves the lemma.
\end{proof}









\section{Polynomial relations among chern classes}
\label{section-relations-chern-classes}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of finite
locally free sheaves on $X$. By Lemma \ref{lemma-cap-commutative-chern}
we see that the chern classes
$$
c_j(\mathcal{E}_i) \in A^*(X)
$$
generate a commutative (and even central) $\mathbf{Z}$-subalgebra of the
Chow cohomology algebra $A^*(X)$.
Thus we can say what it means for a polynomial in these chern classes
to be zero, or for two polynomials to be the same. As an example, saying that
$c_1(\mathcal{E}_1)^5 + c_2(\mathcal{E}_2)c_3(\mathcal{E}_3) = 0$
means that the operations
$$
A_k(Y) \longrightarrow A_{k - 5}(Y), \quad
\alpha \longmapsto
c_1(\mathcal{E}_1)^5 \cap \alpha +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap \alpha
$$
are zero for all morphisms $f : Y \to X$ which are locally of finite type.
By Lemma \ref{lemma-bivariant-zero}
this is equivalent to the requirement that given any morphism
$f : Y \to X$  where $Y$ is an integral scheme
locally of finite type over $S$ the cycle
$$
c_1(\mathcal{E}_1)^5 \cap [Y] +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap [Y]
$$
is zero in $A_{\dim(Y) - 5}(Y)$.

\medskip\noindent
A specific example is the relation
$$
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N})
=
c_1(\mathcal{L}) + c_1(\mathcal{N})
$$
proved in Lemma \ref{lemma-c1-cap-additive}.
More generally, here is what happens when we tensor an
arbitrary locally free sheaf by an invertible sheaf.

\begin{lemma}
\label{lemma-chern-classes-E-tensor-L}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of
rank $r$ on $X$. Let $\mathcal{L}$ be an invertible
sheaf on $X$. Then we have
\begin{equation}
\label{equation-twist}
c_i({\mathcal E} \otimes {\mathcal L})
=
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
\end{equation}
in $A^*(X)$.
\end{lemma}

\begin{proof}
This should hold for any triple $(X, \mathcal{E}, \mathcal{L})$.
In particular it should hold when $X$ is integral and by
Lemma \ref{lemma-bivariant-zero}
it is enough to prove
it holds when capping with $[X]$ for such $X$. Thus assume
that $X$ is integral. Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp.\ $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ be the
projective space bundle associated to $\mathcal{E}$,
resp.\ $\mathcal{E} \otimes \mathcal{L}$. Consider the canonical morphism
$$
\xymatrix{
P \ar[rd]_\pi \ar[rr]_g & & P' \ar[ld]^{\pi'} \\
& X &
}
$$
see Constructions, Lemma \ref{constructions-lemma-twisting-and-proj}.
It has the property that
$g^*\mathcal{O}_{P'}(1)
= \mathcal{O}_P(1) \otimes \pi^* {\mathcal L}$.
This means that we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i
(\xi + x)^i \cap \pi^*(c_{r - i}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
=
0
$$
in $A_*(P)$, where $\xi$ represents
$c_1(\mathcal{O}_P(1))$ and $x$
represents $c_1(\pi^*\mathcal{L})$. By simple algebra this
is equivalent to
$$
\sum\nolimits_{i = 0}^r
(-1)^i \xi^i \left(
\sum\nolimits_{j = i}^r
(-1)^{j - i}
\binom{j}{i}
x^{j - i} \cap
\pi^*(c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
\right)
=
0
$$
Comparing with
Equation (\ref{equation-chern-classes}) it follows from this that
$$
c_{r - i}(\mathcal{E}) \cap [X] =
\sum\nolimits_{j = i}^r
\binom{j}{i}
(-c_1(\mathcal{L}))^{j - i} \cap
c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X]
$$
Reworking this (getting rid of minus signs, and renumbering) we get
the desired relation.
\end{proof}

\noindent
Some example cases of (\ref{equation-twist}) are
\begin{align*}
c_1(\mathcal{E} \otimes \mathcal{L})
& =
c_1(\mathcal{E}) +
r c_1(\mathcal{L}) \\
c_2(\mathcal{E} \otimes \mathcal{L})
& =
c_2(\mathcal{E}) +
(r - 1) c_1(\mathcal{E}) c_1(\mathcal{L}) +
\binom{r}{2} c_1(\mathcal{L})^2 \\
c_3(\mathcal{E} \otimes \mathcal{L})
& =
c_3(\mathcal{E}) +
(r - 2) c_2(\mathcal{E})c_1(\mathcal{L}) +
\binom{r - 1}{2} c_1(\mathcal{E})c_1(\mathcal{L})^2 +
\binom{r}{3} c_1(\mathcal{L})^3
\end{align*}








\section{Additivity of chern classes}
\label{section-additivity-chern-classes}

\noindent
All of the preliminary lemmas follow trivially from the
final result.

\begin{lemma}
\label{lemma-get-rid-of-trivial-subbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{F} \to 0
$$
Then we have
$$
c_r(\mathcal{E}) = 0, \quad
c_j(\mathcal{E}) = c_j(\mathcal{F}), \quad j = 0, \ldots, r - 1
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero}
it suffices to show that if $X$ is integral
then $c_j(\mathcal{E}) \cap [X] = c_j(\mathcal{F}) \cap [X]$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp. $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ denote the
projective space bundle associated to $\mathcal{E}$, resp.\ $\mathcal{F}$.
The surjection $\mathcal{E} \to \mathcal{F}$ gives rise
to a closed immersion
$$
i : P' \longrightarrow P
$$
over $X$. Moreover, the element
$1 \in \Gamma(X, \mathcal{O}_X) \subset \Gamma(X, \mathcal{E})$
gives rise to a global section $s \in \Gamma(P, \mathcal{O}_P(1))$
whose zero set is exactly $P'$. Hence $P'$ is an effective Cartier
divisor on $P$ such that $\mathcal{O}_P(P') \cong \mathcal{O}_P(1)$.
Hence we see that
$$
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha = i_*((\pi')^*\alpha)
$$
for any cycle class $\alpha$ on $X$ by
Lemma \ref{lemma-relative-effective-cartier}.
By Lemma \ref{lemma-determine-intersections} we see that
$\alpha_j = c_j(\mathcal{F}) \cap [X]$, $j = 0, \ldots, r - 1$
satisfy
$$
\sum\nolimits_{j = 0}^{r - 1} (-1)^jc_1(\mathcal{O}_{P'}(1))^j
\cap (\pi')^*\alpha_j = 0
$$
Pushing this to $P$ and using the remark above as well as
Lemma \ref{lemma-pushforward-cap-c1} we get
$$
\sum\nolimits_{j = 0}^{r - 1}
(-1)^j c_1(\mathcal{O}_P(1))^{j + 1}
\cap \pi^*\alpha_j = 0
$$
By the uniqueness of Lemma \ref{lemma-determine-intersections}
we conclude that
$c_r(\mathcal{E}) \cap [X] = 0$ and
$c_j(\mathcal{E}) \cap [X] = \alpha_j = c_j(\mathcal{F}) \cap [X]$
for $j = 0, \ldots, r - 1$. Hence the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-additivity-invertible-subsheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{L} \to \mathcal{E} \to \mathcal{F} \to 0
$$
where $\mathcal{L}$ is an invertible sheaf.
Then
$$
c(\mathcal{E}) = c(\mathcal{L}) c(\mathcal{F})
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
This relation really just says that
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$.
By Lemma \ref{lemma-get-rid-of-trivial-subbundle}
we have $c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})
= c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})$ for
$j = 0, \ldots, r$ (were we set $c_r(\mathcal{F}) = 0$ by
convention).
Applying Lemma \ref{lemma-chern-classes-E-tensor-L} we deduce
$$
\sum_{j = 0}^i
\binom{r - i + j}{j} (-1)^j c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
=
\sum_{j = 0}^i
\binom{r - 1 - i + j}{j} (-1)^j c_{i - j}({\mathcal F}) c_1({\mathcal L})^j
$$
Setting
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$
gives a ``solution'' of this equation. The lemma follows if we show
that this is the only possible solution. We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-additivity-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose that ${\mathcal E}$ sits in an
exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
of finite locally free sheaves $\mathcal{E}_i$ of rank $r_i$.
The total chern classes satisfy
$$
c({\mathcal E}) = c({\mathcal E}_1) c({\mathcal E}_2)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero} we may assume that $X$ is integral
and we have to show the identity when capping against $[X]$.
By induction on $r_1$. The case $r_1 = 1$ is
Lemma \ref{lemma-additivity-invertible-subsheaf}.
Assume $r_1 > 1$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
denote the projective space bundle associated to $\mathcal{E}_1$. Note that
\begin{enumerate}
\item $\pi^* : A_*(X) \to A_*(P)$ is injective, and
\item $\pi^*\mathcal{E}_1$ sits in a short exact sequence
$0 \to \mathcal{F} \to \pi^*\mathcal{E}_1 \to \mathcal{L} \to 0$
where $\mathcal{L}$ is invertible.
\end{enumerate}
The first assertion follows from the projective space bundle formula
and the second follows from the definition of a projective space bundle.
(In fact $\mathcal{L} = \mathcal{O}_P(1)$.)
Let $Q = \pi^*\mathcal{E}/\mathcal{F}$, which sits in an
exact sequence $0 \to \mathcal{L} \to Q \to \pi^*\mathcal{E}_2 \to 0$.
By induction we have
\begin{eqnarray*}
c(\pi^*\mathcal{E}) \cap [P]
& = &
c(\mathcal{F}) \cap c(\pi^*\mathcal{E}/\mathcal{F}) \cap [P] \\
& = &
c(\mathcal{F}) \cap c(\mathcal{L}) \cap c(\pi^*\mathcal{E}_2) \cap [P] \\
& = &
c(\pi^*\mathcal{E}_1) \cap c(\pi^*\mathcal{E}_2) \cap [P]
\end{eqnarray*}
Since $[P] = \pi^*[X]$ we
win by Lemma \ref{lemma-flat-pullback-cap-cj}.
\end{proof}

\begin{lemma}
\label{lemma-chern-filter-by-linebundles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let ${\mathcal L}_i$, $i = 1, \ldots, r$ be invertible
$\mathcal{O}_X$-modules on $X$.
Let $\mathcal{E}$ be a locally free rank
$\mathcal{O}_X$-module endowed with a filtration
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$.
Set $c_1({\mathcal L}_i) = x_i$. Then
$$
c(\mathcal{E})
=
\prod\nolimits_{i = 1}^r (1 + x_i)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-additivity-invertible-subsheaf} and induction.
\end{proof}





\section{The splitting principle}
\label{section-splitting-principle}

\noindent
In our setting it is not so easy to say what the splitting principle
exactly says/is. Here is a possible formulation.

\begin{lemma}
\label{lemma-splitting-principle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of
locally free $\mathcal{O}_X$-modules of rank $r_i$. There exists a projective
flat morphism $\pi : P \to X$ of relative dimension $d$ such that
\begin{enumerate}
\item for any morphism $f : Y \to X$ the map
$\pi_Y^* : A_*(Y) \to A_{* + d}(Y \times_X P)$ is injective, and
\item each $\pi^*\mathcal{E}_i$ has a filtration
whose successive quotients $\mathcal{L}_{i, 1}, \ldots, \mathcal{L}_{i, r_i}$
are invertible ${\mathcal O}_P$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use a composition of projective space bundles.
\end{proof}

\noindent
Let $(S, \delta)$, $X$, and $\mathcal{E}_i$ be as in
Lemma \ref{lemma-splitting-principle}.
The {\it splitting principle} refers to the practice of symbolically writing
$$
c(\mathcal{E}_i) = \prod (1 + x_{i, j})
$$
The symbols $x_{i, 1}, \ldots, x_{i, r_i}$ are called the {\it Chern roots}
of $\mathcal{E}_i$. We think of $x_{i, j}$ as the first chern classes
of some (unknown) invertible sheaves whose direct sum equals $\mathcal{E}_i$.
The usefulness of the splitting principle comes from the assertion
that in order to prove a polynomial relation
among chern classes of the $\mathcal{E}_i$ it is enough to prove the
corresponding relation among the chern roots.

\medskip\noindent
Namely, let $\pi : P \to X$ be as in Lemma \ref{lemma-splitting-principle}.
Recall that there is a canonical $\mathbf{Z}$-algebra map
$\pi^* : A^*(X) \to A^*(P)$, see
Remark \ref{remark-pullback-cohomology}. The injectivity of $\pi_Y^*$
on Chow groups for every $Y$ over $X$, implies that the map
$\pi^* : A^*(X) \to A^*(P)$ is injective (details omitted).
We have
$$
\pi^*c(\mathcal{E}_i) = \prod (1 + c_1(\mathcal{L}_{i, j}))
$$
by Lemma \ref{lemma-chern-filter-by-linebundles}. Thus we may identify
the chern roots $x_{i, j}$ with $c_1(\mathcal{L}_{i, j})$ at least after
applying the injective map $\pi^* : A^*(X) \to A^*(P)$.

\medskip\noindent
To see how this works, it is best to give an example. Let us calculate the
chern classes of the dual $\mathcal{E}^\wedge$ of a locally
free $\mathcal{O}_X$-module $\mathcal{E}$ of rank $r$. Note that
if $\pi^*\mathcal{E}$ has a filtration with subquotients the invertible
modules $\mathcal{L}_1, \ldots, \mathcal{L}_r$, then
$\pi^*\mathcal{E}^\wedge$ has a filtration with subquotients invertible
sheaves $\mathcal{L}_r^{-1}, \ldots, \mathcal{L}_1^{\otimes -1}$.
Hence if $x_i$ are the chern roots of $\mathcal{E}$, in other words,
if $x_i = c_1(\mathcal{L}_i)$, then the $-x_i$ are the chern roots of
$\mathcal{E}^\wedge$ by Lemma \ref{lemma-c1-cap-additive}. It follows that
$$
\pi^*c(\mathcal{E}^\wedge) = \prod (1 - x_i)
$$
in $A^*(P)$ and hence by elementary algebra that
$$
c_j(\mathcal{E}^\wedge) = (-1)^jc_j(\mathcal{E})
$$
in $A^*(X)$ by the injectivity above.

\medskip\noindent
It should be said here that in any application of the splitting principle
it is no longer necessary to choose an actual $\pi : P \to X$ and to use
the pullback map; it suffices to know that one exists. In a way this is an
abuse of language, more than anything else. In the following
paragraph we give an example.

\medskip\noindent
Let us compute the chern classes of a tensor product of vector bundles.
Namely, suppose that $\mathcal{E}$, $\mathcal{F}$
are finite locally free of ranks $r$, $s$.
Write
$$
c(\mathcal{E}) = \prod\nolimits_{i = 1}^r (1 + x_i),
\quad
c(\mathcal{E}) = \prod\nolimits_{j = 1}^s (1 + y_j)
$$
where $x_i$, $y_j$ are the chern roots of $\mathcal{E}$,
$\mathcal{F}$. Then we see that
$$
c(\mathcal{E} \otimes_{\mathcal{O}_X} \mathcal{F})
=
\prod\nolimits_{i, j} (1 + x_i + y_j)
$$
because if $\mathcal{E}$ is the direct sum of invertible sheaves
$\mathcal{L}_i$ and $\mathcal{F}$ is the direct sum of invertible
sheaves $\mathcal{N}_j$, then $\mathcal{E} \otimes \mathcal{F}$
is the direct sum of the invertible sheaves
$\mathcal{L}_i \otimes \mathcal{N}_j$.
Here are some examples of what this means in terms of
chern classes
$$
c_1(\mathcal{E} \otimes \mathcal{F})
=
r c_1(\mathcal{F}) + s c_1(\mathcal{E})
$$
$$
c_2(\mathcal{E} \otimes \mathcal{F})
=
r^2 c_2(\mathcal{F}) +
rs c_1(\mathcal{F})c_1(\mathcal{E}) +
s^2 c_2(\mathcal{E})
$$



\section{Chern classes and tensor product}
\label{section-chern-classes-tensor}

\noindent
We define the {\it Chern character} of a finite locally free
sheaf of rank $r$ to be the formal expression
$$
ch({\mathcal E}) = \sum\nolimits_{i=1}^r e^{x_i}
$$
if the $x_i$ are the chern roots of ${\mathcal E}$. Writing this in
terms of chern classes $c_i = c_i(\mathcal{E})$
we see that
$$
ch(\mathcal{E}) =
r
+
c_1
+
\frac{1}{2}(c_1^2 - 2c_2)
+
\frac{1}{6}(c_1^3 - 3c_1c_2 + 3c_3)
+
\frac{1}{24}(c_1^4 - 4c_1^2c_2 + 4c_1c_3 + 2c_2^2 - 4c_4)
+
\ldots
$$
What does it mean that the coefficients are rational numbers?
Well this simply means that we think of
$ch_j(\mathcal{E})$ as an element of $A^j(X) \otimes \mathbf{Q}$.
By the above we have in case of an exact sequence
$$
0 \to \mathcal{E}_1 \to \mathcal{E} \to \mathcal{E}_2 \to 0
$$
that
$$
ch(\mathcal{E}) = ch(\mathcal{E}_1) + ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$.
Using the Chern character we can express the compatibility
of the chern classes and tensor product as follows:
$$
ch(\mathcal{E}_1 \otimes_{\mathcal{O}_X} \mathcal{E}_2) =
ch(\mathcal{E}_1) ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$.
This follows directly from the discussion of the chern roots
of the tensor product in the previous section.




\section{Todd classes}
\label{section-todd-classes}

\noindent
A final class associated to a vector bundle $\mathcal{E}$
of rank $r$ is its {\it Todd class} $Todd(\mathcal{E})$.
In terms of the chern roots $x_1, \ldots, x_r$ it is
defined as
$$
Todd(\mathcal{E})
=
\prod\nolimits_{i = 1}^r
\frac{x_i}{1 - e^{-x_i}}
$$
In terms of the chern classes $c_i = c_i(\mathcal{E})$
we have
$$
Todd(\mathcal{E})
=
1
+
\frac{1}{2}c_1
+
\frac{1}{12}(c_1^2 + c_2)
+
\frac{1}{24}c_1c_2
+
\frac{1}{720}(-c_1^4 + 4c_1^2c_2 + 3c_2^2 + c_1c_3 - c_4)
+
\ldots
$$
We have made the appropriate remarks about denominators
in the previous section. It is the case that
given an exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
we have
$$
Todd({\mathcal E}) = Todd({\mathcal E}_1) Todd({\mathcal E}_2).
$$




\section{Degrees of zero cycles}
\label{section-degree-zero-cycles}

\noindent
We start defining the degree of a zero cycle on a proper scheme over a field.
One approach is to define it directly as in
Lemma \ref{lemma-spell-out-degree-zero-cycle} and then show
it is well defined by
Lemma \ref{lemma-curve-principal-divisor}.
Instead we define it as follows.

\begin{definition}
\label{definition-degree-zero-cycle}
Let $k$ be a field (Example \ref{example-field}). Let $p : X \to \Spec(k)$
be proper. The {\it degree of a zero cycle} on $X$ is given by proper
pushforward
$$
p_* : A_0(X) \to A_0(\Spec(k))
$$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
combined with the natural isomorphism $A_0(\Spec(k)) = \mathbf{Z}$
which maps $[\Spec(k)]$ to $1$. Notation: $\deg(\alpha)$.
\end{definition}

\noindent
Let us spell this out further.

\begin{lemma}
\label{lemma-spell-out-degree-zero-cycle}
Let $k$ be a field. Let $X$ be proper over $k$. Let $\alpha = \sum n_i[Z_i]$
be in $Z_0(X)$. Then
$$
\deg(\alpha) = \sum n_i\deg(Z_i)
$$
where $\deg(Z_i)$ is the degree of $Z_i \to \Spec(k)$, i.e.,
$\deg(Z_i) = \dim_k \Gamma(Z_i, \mathcal{O}_{Z_i})$.
\end{lemma}

\begin{proof}
This is the definition of proper pushforward
(Definition \ref{definition-proper-pushforward}).
\end{proof}

\noindent
Next, we make the connection with degrees of vector bundles
over $1$-dimensional proper schemes over fields as defined in
Varieties, Section \ref{varieties-section-divisors-curves}.

\begin{lemma}
\label{lemma-degree-vector-bundle}
Let $k$ be a field. Let $X$ be a proper scheme over $k$ of dimension $\leq 1$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module of constant
rank. Then
$$
\deg(\mathcal{E}) = \deg(c_1(\mathcal{E}) \cap [X]_1)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf}.
\end{lemma}

\begin{proof}
Let $C_i \subset X$, $i = 1, \ldots, t$ be the irreducible components
of dimension $1$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $C_i$ in $X$. Then $[X]_1 = \sum m_i[C_i]$ and
$c_1(\mathcal{E}) \cap [X]_1$ is the sum of the pushforwards of the cycles
$m_i c_1(\mathcal{E}|_{C_i}) \cap [C_i]$. Since we have a similar decomposition
of the degree of $\mathcal{E}$ by
Varieties, Lemma \ref{varieties-lemma-degree-in-terms-of-components}
it suffices to prove the lemma in case $X$ is a proper curve over $k$.

\medskip\noindent
Assume $X$ is a proper curve over $k$.
By Divisors, Lemma \ref{divisors-lemma-filter-after-modification}
there exists a modification $f : X' \to X$ such that $f^*\mathcal{E}$
has a filtration whose successive quotients are invertible
$\mathcal{O}_{X'}$-modules. Since $f_*[X']_1 = [X]_1$ we conclude
from Lemma \ref{lemma-pushforward-cap-cj} that
$$
\deg(c_1(\mathcal{E}) \cap [X]_1) = \deg(c_1(f^*\mathcal{E}) \cap [X']_1)
$$
Since we have a similar relationship for the degree by
Varieties, Lemma \ref{varieties-lemma-degree-birational-pullback}
we reduce to the case where $\mathcal{E}$ has a filtration whose
successive quotients are invertible $\mathcal{O}_X$-modules.
In this case, we may use additivity of the degree
(Varieties, Lemma \ref{varieties-lemma-degree-additive})
and of first chern classes (Lemma \ref{lemma-additivity-chern-classes})
to reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is a proper curve over $k$ and $\mathcal{E}$ is an
invertible $\mathcal{O}_X$-module. By
Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}
we see that $\mathcal{E}$ is isomorphic to
$\mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D'$ on $X$ (this also uses
that $X$ is projective, see
Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective} for example).
By additivity of degree under tensor product of invertible sheaves
(Varieties, Lemma \ref{varieties-lemma-degree-tensor-product})
and additivity of $c_1$ under tensor product of invertible sheaves
(Lemma \ref{lemma-c1-cap-additive} or \ref{lemma-chern-classes-E-tensor-L})
we reduce to the case $\mathcal{E} = \mathcal{O}_X(D)$.
In this case the left hand side gives $\deg(D)$
(Varieties, Lemma \ref{varieties-lemma-degree-effective-Cartier-divisor})
and the right hand side gives $\deg([D]_0)$ by
Lemma \ref{lemma-geometric-cap}.
Since
$$
[D]_0 = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{D, x}) [x] =
\sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [x]
$$
by definition, we see
$$
\deg([D]_0) = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [\kappa(x) : k] =
\dim_k \Gamma(D, \mathcal{O}_D) = \deg(D)
$$
The penultimate equality by
Algebra, Lemma \ref{algebra-lemma-pushdown-module}
using that $D$ is affine.
\end{proof}

\noindent
Finally, we can tie everything up with the numerical intersections
defined in Varieties, Section \ref{varieties-section-num}.

\begin{lemma}
\label{lemma-degrees-and-numerical-intersections}
Let $k$ be a field. Let $X$ be a proper scheme over $k$.
Let $Z \subset X$ be a closed subscheme of dimension $d$.
Let $\mathcal{L}_1, \ldots, \mathcal{L}_d$ be invertible
$\mathcal{O}_X$-modules. Then
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z) =
\deg(
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_1) \cap [Z]_d)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-intersection-number}.
In particular,
$$
\deg_\mathcal{L}(Z) = \deg(c_1(\mathcal{L})^d \cap [Z]_d)
$$
if $\mathcal{L}$ is an ample invertible $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
We will prove this by induction on $d$. If $d = 0$, then the result is
true by Varieties, Lemma \ref{varieties-lemma-chi-tensor-finite}.
Assume $d > 0$.

\medskip\noindent
Let $Z_i \subset Z$, $i = 1, \ldots, t$ be the irreducible components
of dimension $d$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $Z_i$ in $Z$. Then $[Z]_d = \sum m_i[Z_i]$ and
$c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z]_d$
is the sum of the cycles
$m_i c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z_i]$.
Since we have a similar decomposition for
$(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z)$ by
Varieties, Lemma \ref{varieties-lemma-numerical-polynomial-leading-term}
it suffices to prove the lemma in case $Z = X$
is a proper variety of dimension $d$ over $k$.

\medskip\noindent
By Chow's lemma there exists a birational proper morphism $f : Y \to X$
with $Y$ H-projective over $k$. See Cohomology of Schemes, Lemma
\ref{coherent-lemma-chow-Noetherian} and Remark
\ref{coherent-remark-chow-Noetherian}. Then
$$
(f^*\mathcal{L}_1 \cdots f^*\mathcal{L}_d \cdot Y) =
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X)
$$
by Varieties, Lemma \ref{varieties-lemma-intersection-number-and-pullback}
and we have
$$
f_*(c_1(f^*\mathcal{L}_1) \cap \ldots \cap c_1(f^*\mathcal{L}_d) \cap [Y]) =
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X]
$$
by Lemma \ref{lemma-pushforward-cap-c1}. Thus we may replace $X$ by $Y$
and assume that $X$ is projective over $k$.

\medskip\noindent
If $X$ is a proper $d$-dimensional projective variety, then we can
write $\mathcal{L}_1 = \mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D' \subset X$
by Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}.
By additivity for both sides of the equation
(Varieties, Lemma \ref{varieties-lemma-intersection-number-additive} and
Lemma \ref{lemma-c1-cap-additive})
we reduce to the case $\mathcal{L}_1 = \mathcal{O}_X(D)$ for some
effective Cartier divisor $D$.
By Varieties, Lemma
\ref{varieties-lemma-numerical-intersection-effective-Cartier-divisor}
we have
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X) =
(\mathcal{L}_2 \cdots \mathcal{L}_d \cdot D)
$$
and by Lemma \ref{lemma-geometric-cap} we have
$$
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X] =
c_1(\mathcal{L}_2) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [D]_{d - 1}
$$
Thus we obtain the result from our induction hypothesis.
\end{proof}







\section{Grothendieck-Riemann-Roch}
\label{section-grr}

\noindent
Let $(S, \delta)$ be as in
Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf
${\mathcal E}$ on $X$ of rank $r$.
Let $f : X \to Y$ be a proper smooth morphism.
Assume that $R^if_*\mathcal{E}$ are locally free
sheaves on $Y$ of finite rank.
The Grothendieck-Riemann-Roch theorem say in this
case that
$$
f_*(Todd(T_{X/Y}) ch(\mathcal{E}))
=
\sum (-1)^i ch(R^if_*\mathcal{E})
$$
Here
$$
T_{X/Y} = \SheafHom_{\mathcal{O}_X}(\Omega_{X/Y}, \mathcal{O}_X)
$$
is the relative tangent bundle of $X$ over $Y$. If $Y = \Spec(k)$
where $k$ is a field, then we can restate this as
$$
\chi(X, \mathcal{E}) = \deg(Todd(T_{X/k}) ch(\mathcal{E}))
$$
The theorem is more general and becomes easier to prove
when formulated in correct generality. We will return to
this elsewhere (insert future reference here).





\section{Appendix}
\label{section-appendix-chow}

\noindent
In this appendix we present some alternative approaches to the material
explained above.


\subsection{Rational equivalence and K-groups}
\label{subsection-rational-equivalence-K-groups}

\noindent
In this section we compare the cycle groups $Z_k(X)$ and
the Chow groups $A_k(X)$ with certain $K_0$-groups of
abelian categories of coherent sheaves on $X$. We avoid having
to talk about $K_1(\mathcal{A})$ for an abelian category
$\mathcal{A}$ by dint of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.
In particular, the motivation for the precise form of
Lemma \ref{lemma-maps-between-coherent-sheaves} is that lemma.

\medskip\noindent
Let us introduce the following notation.
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We denote $\textit{Coh}(X) = \textit{Coh}(\mathcal{O}_X)$
the category of coherent sheaves on $X$.
It is an abelian category, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
For any $k \in \mathbf{Z}$ we let $\textit{Coh}_{\leq k}(X)$
be the full subcategory of $\textit{Coh}(X)$
consisting of those coherent sheaves $\mathcal{F}$
having $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-Serre-subcategories}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The categories $\textit{Coh}_{\leq k}(X)$ are Serre subcategories
of the abelian category $\textit{Coh}(X)$.
\end{lemma}

\begin{proof}
Omitted. The definition of a Serre subcategory is
Homology, Definition \ref{homology-definition-serre-subcategory}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-k-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
There are maps
$$
Z_k(X)
\longrightarrow
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
Z_k(X)
$$
whose composition is the identity. The first is the map
$$
\sum n_Z[Z] \mapsto
\left[\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}\right]
-
\left[\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}\right]
$$
and the second comes from the map $\mathcal{F} \mapsto [\mathcal{F}]_k$.
If $X$ is quasi-compact, then both maps are isomorphisms.
\end{lemma}

\begin{proof}
Note that the direct sum
$\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}$
is indeed a coherent sheaf on $X$ since the family $\{Z \mid n_Z > 0\}$
is locally finite on $X$.
The map $\mathcal{F} \to [\mathcal{F}]_k$ is additive
on $\textit{Coh}_{\leq k}(X)$, see
Lemma \ref{lemma-additivity-sheaf-cycle}. And $[\mathcal{F}]_k = 0$
if $\mathcal{F} \in \textit{Coh}_{\leq k - 1}(X)$.
This implies we have the left map as shown in the lemma.
It is clear that their composition is the identity.

\medskip\noindent
In case $X$ is quasi-compact we will show that the right arrow
is injective.
Suppose that $q \in K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k + 1}(X))$
maps to zero in $Z_k(X)$. By
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
we can find
a $\tilde q \in K_0(\textit{Coh}_{\leq k}(X))$ mapping to $q$.
Write $\tilde q = [\mathcal{F}] - [\mathcal{G}]$ for some
$\mathcal{F}, \mathcal{G} \in K_0(\textit{Coh}_{\leq k}(X))$.
Since $X$ is quasi-compact we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-filter}.
This shows that there exist integral closed subschemes
$Z_j, T_i \subset X$ and (nonzero) ideal sheaves
$\mathcal{I}_j \subset \mathcal{O}_{Z_j}$,
$\mathcal{I}_i \subset \mathcal{O}_{T_i}$ such that
$\mathcal{F}$, resp.\ $\mathcal{G}$ have filtrations whose successive
quotients are the sheaves $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$.
In particular we see that $\dim_\delta(Z_j), \dim_\delta(T_i) \leq k$.
In other words we have
$$
[\mathcal{F}] = \sum\nolimits_j [\mathcal{I}_j],
\quad
[\mathcal{G}] = \sum\nolimits_i [\mathcal{I}_i],
$$
in $K_0(\textit{Coh}_{\leq k}(X))$. Our assumption is that
$\sum_j [\mathcal{I}_j]_k - \sum_i [\mathcal{I}_i]_k = 0$.
It is clear that we may throw out the indices $j$, resp.\ $i$
such that $\dim_\delta(Z_j) < k$, resp.\ $\dim_\delta(T_i) < k$,
since the corresponding sheaves are in $\textit{Coh}_{k - 1}(X)$ and
also do not contribute to the cycle. Moreover, the exact sequences
$0 \to \mathcal{I}_j \to \mathcal{O}_{Z_j} \to
\mathcal{O}_{Z_j}/\mathcal{I}_j \to 0$
and
$0 \to \mathcal{I}_i \to \mathcal{O}_{T_i} \to
\mathcal{O}_{Z_i}/\mathcal{I}_i \to 0$
show similarly that we may replace $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$
by $\mathcal{O}_{Z_j}$, resp.\ $\mathcal{O}_{T_i}$.
OK, and finally, at this point it is clear that our assumption
$$
\sum\nolimits_j [\mathcal{O}_{Z_j}]_k - \sum\nolimits_i [\mathcal{O}_{T_i}]_k
= 0
$$
implies that in $K_0(\textit{Coh}_k(X))$ we have also
$\sum\nolimits_j [\mathcal{O}_{Z_j}] - \sum\nolimits_i [\mathcal{O}_{T_i}]
= 0$
as desired.
\end{proof}

\begin{remark}
\label{remark-not-true-not-quasi-compact}
It seems likely that the arrows of Lemma \ref{lemma-cycles-k-group}
are not isomorphisms if $X$ is not quasi-compact. For example, suppose $X$ is
an infinite disjoint union $X = \coprod_{n \in \mathbf{N}} \mathbf{P}^1_k$
over a field $k$. Let $\mathcal{F}$, resp.\ $\mathcal{G}$ be the coherent
sheaf on $X$ whose restriction to the $n$th summand is equal to the skyscraper
sheaf at $0$ associated to $\mathcal{O}_{\mathbf{P}^1_k, 0}/\mathfrak m_0^n$,
resp.\ $\kappa(0)^{\oplus n}$. The cycle associated to $\mathcal{F}$ is
equal to the cycle associated to $\mathcal{G}$, namely both are equal to
$\sum n[0_n]$ where $0_n \in X$ denotes $0$ on the $n$th component of $X$.
But there seems to be no way to show that
$[\mathcal{F}] = [\mathcal{G}]$ in $K_0(\textit{Coh}(X))$ since
any proof we can envision uses infinitely many relations.
\end{remark}

\begin{lemma}
\label{lemma-maps-between-coherent-sheaves}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let
$$
\xymatrix{
\ldots \ar[r] &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r]^\psi &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r] & \ldots
}
$$
be a complex as in Homology, Equation (\ref{homology-equation-cyclic-complex}).
Assume that
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
\item $\dim_\delta(\text{Supp}(H^i(\mathcal{F}, \varphi, \psi))) \leq k$
for $i = 0, 1$.
\end{enumerate}
Then we have
$$
[H^0(\mathcal{F}, \varphi, \psi)]_k
\sim_{rat}
[H^1(\mathcal{F}, \varphi, \psi)]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$. Note that $\{W_j\}$
is a locally finite collection of closed subsets of
$X$ by Lemma \ref{lemma-length-finite}.
For every $j$, let $\xi_j \in W_j$ be the generic point.
Set
$$
f_j = \det\nolimits_{\kappa(\xi_j)}
(\mathcal{F}_{\xi_j}, \varphi_{\xi_j}, \psi_{\xi_j})
\in
R(W_j)^*.
$$
See Definition \ref{definition-periodic-determinant} for notation.
We claim that
$$
- [H^0(\mathcal{F}, \varphi, \psi)]_k + [H^1(\mathcal{F}, \varphi, \psi)]_k
=
\sum (W_j \to X)_*\text{div}(f_j)
$$
If we prove this then the lemma follows.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z]$ in
$
[H^0(\mathcal{F}, \varphi, \psi)]_k - [H^1(\mathcal{F}, \varphi, \psi)]_k
$
is the same as the coefficient $m$ of $[Z]$ in
$
\sum (W_j \to X)_*\text{div}(f_j)
$.
Let $\xi \in Z$ be the generic point.
Consider the local ring $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Denote $\varphi, \psi : M \to M$ the action of $\varphi, \psi$ on
the stalk.
By our choice of $\xi \in Z$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$.
Finally, the integral closed subschemes
$W_j$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Supp}(M)$.
In each case the element $f_j \in R(W_j)^*$ corresponds to
the element $\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi)$
in $\kappa(\mathfrak q_i)^*$. Hence we see that
$$
n = - e_A(M, \varphi, \psi)
$$
and
$$
m =
\sum
\text{ord}_{A/\mathfrak q_i}
(\det\nolimits_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi))
$$
Thus the result follows from
Proposition \ref{proposition-length-determinant-periodic-complex}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-rational-equivalence-K-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Denote $B_k(X)$ the image of the map
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
There is a commutative diagram
$$
\xymatrix{
K_0\left(\frac{\textit{Coh}_{\leq k}(X)}{\textit{Coh}_{\leq k - 1}(X)}\right)
\ar[r] \ar[d] &
B_k(X) \ar[d] \ar@{^{(}->}[r] &
K_0\left(\frac{\textit{Coh}_{\leq k + 1}(X)}{\textit{Coh}_{\leq k - 1}(X)}\right)
\\
Z_k(X) \ar[r] & A_k(X)
}
$$
where the left vertical arrow is the one from
Lemma \ref{lemma-cycles-k-group}. If $X$ is quasi-compact
then both vertical arrows are isomorphisms.
\end{lemma}

\begin{proof}
Suppose we have an element $[A] - [B]$ of
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$
which maps to zero in $B_k(X)$, i.e., in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Suppose $[A] = [\mathcal{A}]$ and $[B] = [\mathcal{B}]$
for some coherent sheaves $\mathcal{A}, \mathcal{B}$ on
$X$ supported in $\delta$-dimension $\leq k$.
The assumption that $[A] - [B]$ maps to zero in the group
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
means that there exists coherent sheaves
$\mathcal{A}', \mathcal{B}'$ on $X$ supported in
$\delta$-dimension $\leq k - 1$ such that
$[\mathcal{A} \oplus \mathcal{A}'] - [\mathcal{B} \oplus \mathcal{B}']$
is zero in $K_0(\textit{Coh}_{k + 1}(X))$ (use part (1) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}).
By part (2) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this means there exists a $(2, 1)$-periodic complex
$(\mathcal{F}, \varphi, \psi)$ in the category $\textit{Coh}_{\leq k + 1}(X)$
such that
$\mathcal{A} \oplus \mathcal{A}' = H^0(\mathcal{F}, \varphi, \psi)$
and $\mathcal{B} \oplus \mathcal{B}' = H^1(\mathcal{F}, \varphi, \psi)$.
By Lemma \ref{lemma-maps-between-coherent-sheaves}
this implies that
$$
[\mathcal{A} \oplus \mathcal{A}']_k
\sim_{rat}
[\mathcal{B} \oplus \mathcal{B}']_k
$$
This proves that $[A] - [B]$ maps to zero via the composition
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow Z_k(X)
\longrightarrow A_k(X).
$$
In other words this proves the
commutative diagram exists.

\medskip\noindent
Next, assume that $X$ is quasi-compact. By Lemma \ref{lemma-cycles-k-group}
the left vertical arrow is bijective. Hence it suffices to show
any $\alpha \in Z_k(X)$ which is rationally equivalent to zero
maps to zero in $B_k(X)$ via the inverse of the left vertical
arrow composed with the horizontal arrow.
By Lemma \ref{lemma-rational-equivalence-family} we see that
$\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$ for some
closed integral subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$. Moreover the family
$\{W_i\}$ is finite because $X$ is quasi-compact.
Note that the ideal sheaves
$\mathcal{I}_i, \mathcal{J}_i \subset \mathcal{O}_{W_i}$
of the effective Cartier divisors $(W_i)_0, (W_i)_\infty$
are isomorphic (as $\mathcal{O}_{W_i}$-modules). This is true
because the ideal sheaves of $D_0$ and $D_\infty$ on $\mathbf{P}^1$
are isomorphic and $\mathcal{I}_i, \mathcal{J}_i$ are the pullbacks of
these. (Some details omitted.) Hence we have
short exact sequences
$$
0 \to \mathcal{I}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_0} \to 0,
\quad
0 \to \mathcal{J}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_\infty} \to 0
$$
of coherent $\mathcal{O}_{W_i}$-modules.
Also, since $[(W_i)_0]_k = [p_*\mathcal{O}_{(W_i)_0}]_k$ in
$Z_k(X)$ we see that the inverse of the left vertical arrow
maps $[(W_i)_0]_k$ to the element $[p_*\mathcal{O}_{(W_i)_0}]$ in
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Thus we have
\begin{eqnarray*}
\alpha
& = &
\sum \left([(W_i)_0]_k - [(W_i)_\infty]_k\right) \\
& \mapsto &
\sum \left([p_*\mathcal{O}_{(W_i)_0}] - [p_*\mathcal{O}_{(W_i)_\infty}]\right)
\\
& = &
\sum \left([p_*\mathcal{O}_{W_i}] - [p_*\mathcal{I}_i]
- [p_*\mathcal{O}_{W_i}] + [p_*\mathcal{J}_i]\right)
\end{eqnarray*}
in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
By what was said above this is zero, and we win.
\end{proof}

\begin{remark}
\label{remark-good-cases-K-A}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Assume $X$ is quasi-compact.
The result of Lemma \ref{lemma-cycles-rational-equivalence-K-group}
in particular gives a map
$$
A_k(X)
\longrightarrow
K_0(\textit{Coh}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
We have not been able to find a statement or conjecture in the
literature as to whether this map is should be injective or not.
If $X$ is connected nonsingular, then, using the
isomorphism $K_0(X) = K^0(X)$ (see insert future reference here)
and chern classes (see below), one can show that
the map is an isomorphism up to $(p - 1)!$-torsion where
$p = \dim_\delta(X) - k$.
\end{remark}















\subsection{Cartier divisors and K-groups}
\label{subsection-cartier-coherent}

\noindent
In this section we describe how the intersection with the
first chern class of an invertible sheaf $\mathcal{L}$
corresponds to tensoring with $\mathcal{L} - \mathcal{O}$
in $K$-groups.

\begin{lemma}
\label{lemma-no-embedded-points-modules}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module.
Let $a, b \in A$.
Assume
\begin{enumerate}
\item $\dim(A) = 1$,
\item both $a$ and $b$ are nonzerodivisors in $A$,
\item $A$ has no embedded primes,
\item $M$ has no embedded associated primes,
\item $\text{Supp}(M) = \Spec(A)$.
\end{enumerate}
Let $I = \{x \in A \mid x(a/b) \in A\}$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes of $A$. Then $(a/b)IM \subset M$ and
$$
\text{length}_A(M/(a/b)IM)
-
\text{length}_A(M/IM)
=
\sum\nolimits_i
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
\end{lemma}

\begin{proof}
Since $M$ has no embedded associated primes, and since
the support of $M$ is $\Spec(A)$ we see that
$\text{Ass}(M) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$.
Hence $a$, $b$ are nonzerodivisors on $M$. Note that
\begin{align*}
& \text{length}_A(M/(a/b)IM) \\
& = \text{length}_A(bM/aIM) \\
& = \text{length}_A(M/aIM)
-
\text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(aM/aIM) - \text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(M/IM) - \text{length}_A(M/bM)
\end{align*}
as the injective map $b : M \to bM$ maps $(a/b)IM$ to $aIM$
and the injective map $a : M \to aM$ maps $IM$ to $aIM$.
Hence the left hand side of the equation of the lemma is
equal to
$$
\text{length}_A(M/aM) - \text{length}_A(M/bM).
$$
Applying the second formula of
Algebra, Lemma \ref{algebra-lemma-additivity-divisors-restricted}
with $x = a, b$ respectively
and using Algebra, Definition \ref{algebra-definition-ord}
of the $\text{ord}$-functions we get the result.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$ be a
meromorphic section of $\mathcal{L}$.
Assume
\begin{enumerate}
\item $\dim_\delta(X) \leq k + 1$,
\item $X$ has no embedded points,
\item $\mathcal{F}$ has no embedded associated points,
\item the support of $\mathcal{F}$ is $X$, and
\item the section $s$ is regular meromorphic.
\end{enumerate}
In this situation let $\mathcal{I} \subset \mathcal{O}_X$
be the ideal of denominators of $s$, see
Divisors,
Definition \ref{divisors-definition-regular-meromorphic-ideal-denominators}.
Then we have the following:
\begin{enumerate}
\item there are short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{1} &
\mathcal{F} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{s} &
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
\item the coherent sheaves $\mathcal{Q}_1$, $\mathcal{Q}_2$
are supported in $\delta$-dimension $\leq k$,
\item the section $s$ restricts to a regular meromorphic
section $s_i$ on every irreducible component $X_i$ of
$X$ of $\delta$-dimension $k + 1$, and
\item writing $[\mathcal{F}]_{k + 1} = \sum m_i[X_i]$ we have
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_k(X)$, in particular
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
$$
in $A_k(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall from Divisors, Lemma \ref{divisors-lemma-make-maps-regular-section}
the existence of injective maps
$1 : \mathcal{I}\mathcal{F} \to \mathcal{F}$ and
$s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L}$
whose cokernels are supported on a closed nowhere dense subsets $T$.
Denote $\mathcal{Q}_i$ there cokernels as in the lemma.
We conclude that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$.
By Divisors, Lemmas \ref{divisors-lemma-pullback-meromorphic-sections-defined}
and \ref{divisors-lemma-meromorphic-sections-pullback} the pullbacks $s_i$
are defined and are regular meromorphic sections for $\mathcal{L}|_{X_i}$.
The equality of cycles in (4) implies the equality of cycle classes
in (4). Hence the only remaining thing to show is that
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
holds in $Z_k(X)$. To see this, let $Z \subset X$ be an integral closed
subscheme of $\delta$-dimension $k$. Let $\xi \in Z$ be the generic point.
Let $A = \mathcal{O}_{X, \xi}$ and $M = \mathcal{F}_\xi$.
Moreover, choose a generator $s_\xi \in \mathcal{L}_\xi$.
Then we can write $s = (a/b) s_\xi$ where $a, b \in A$ are
nonzerodivisors. In this case
$I = \mathcal{I}_\xi = \{x \in A \mid x(a/b) \in A\}$.
In this case the coefficient of $[Z]$ in the left hand side is
$$
\text{length}_A(M/(a/b)IM) - \text{length}_A(M/IM)
$$
and the coefficient of $[Z]$ in the right hand side
is
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the minimal
primes of the $1$-dimensional local ring $A$. Hence the result
follows from Lemma \ref{lemma-no-embedded-points-modules}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
Then the element
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
\in
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
lies in the subgroup $B_k(X)$ of
Lemma \ref{lemma-cycles-rational-equivalence-K-group} and maps to
the element $c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}$ via
the map $B_k(X) \to A_k(X)$.
\end{lemma}

\begin{proof}
Let
$$
0 \to \mathcal{K} \to \mathcal{F} \to \mathcal{F}' \to 0
$$
be the short exact sequence constructed in
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}.
This in particular means that $\mathcal{F}'$ has no embedded
associated points.
Since the support of $\mathcal{K}$ is nowhere dense in the
support of $\mathcal{F}$ we see that
$\dim_\delta(\text{Supp}(\mathcal{K})) \leq k$. We may
re-apply
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}
starting with $\mathcal{K}$ to get a short exact sequence
$$
0 \to \mathcal{K}'' \to \mathcal{K} \to \mathcal{K}' \to 0
$$
where now $\dim_\delta(\text{Supp}(\mathcal{K}'')) < k$
and $\mathcal{K}'$ has no embedded associated points.
Suppose we can prove the lemma for the coherent sheaves
$\mathcal{F}'$ and $\mathcal{K}'$. Then we see
from the equations
$$
[\mathcal{F}]_{k + 1}
=
[\mathcal{F}']_{k + 1}
+ [\mathcal{K}']_{k + 1}
+ [\mathcal{K}'']_{k + 1}
$$
(use Lemma \ref{lemma-additivity-sheaf-cycle}),
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[\mathcal{F}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}']
+
[\mathcal{K}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}']
+
[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}'']
$$
(use the $\otimes \mathcal{L}$ is exact)
and the trivial vanishing of $[\mathcal{K}'']_{k + 1}$ and
$[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
- [\mathcal{K}'']$ in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
that the result holds
for $\mathcal{F}$. What this means is that we may assume that
the sheaf $\mathcal{F}$ has no embedded associated points.

\medskip\noindent
Assume $X$, $\mathcal{F}$ as in the lemma, and assume in addition
that $\mathcal{F}$ has no embedded associated points. Consider the
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$, the corresponding
closed subscheme $i : Z \to X$ and the coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ constructed in
Divisors, Lemma \ref{divisors-lemma-no-embedded-points-endos}.
Recall that $Z$ is a locally Noetherian scheme without embedded points,
$\mathcal{G}$ is a coherent sheaf without embedded
associated points, with $\text{Supp}(\mathcal{G}) = Z$
and such that $i_*\mathcal{G} = \mathcal{F}$.
Moreover, set $\mathcal{N} = \mathcal{L}|_Z$.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-regular-meromorphic-section-exists}
the invertible sheaf $\mathcal{N}$ has a regular meromorphic section $s$
over $Z$. Let us denote $\mathcal{J} \subset \mathcal{O}_Z$ the sheaf
of denominators of $s$. By Lemma \ref{lemma-no-embedded-points}
there exist short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{1} &
\mathcal{G} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{s} &
\mathcal{G} \otimes_{\mathcal{O}_Z} \mathcal{N} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
such that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$ and
such that the cycle
$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
$
is a representative of $c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1}$.
We see (using the fact that
$i_*(\mathcal{G} \otimes \mathcal{N}) = \mathcal{F} \otimes \mathcal{L}$
by the projection formula, see
Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
that
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[i_*\mathcal{Q}_2] - [i_*\mathcal{Q}_1]
$$
in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
This already shows that
$[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}] - [\mathcal{F}]$
is an element of $B_k(X)$. Moreover we have
\begin{eqnarray*}
[i_*\mathcal{Q}_2]_k - [i_*\mathcal{Q}_1]_k
& = &
i_*\left( [\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k \right) \\
& = &
i_*\left(c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1} \right) \\
& = &
c_1(\mathcal{L}) \cap i_*[\mathcal{G}]_{k + 1} \\
& = &
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
\end{eqnarray*}
by the above and Lemmas \ref{lemma-pushforward-cap-c1}
and \ref{lemma-cycle-push-sheaf}. And this agree with the
image of the element under $B_k(X) \to A_k(X)$ by definition.
Hence the lemma is proved.
\end{proof}



















\subsection{Blowing up lemmas}
\label{subsection-blowing-up-lemmas}

\noindent
In this section we prove some lemmas on representing
Cartier divisors by suitable effective Cartier divisors
on blow-ups. These lemmas can be found in \cite[Section 2.4]{F}.
We have adapted the formulation so they also work
in the non-finite type setting. It may happen that the morphism $b$
of Lemma \ref{lemma-blowing-up-intersections} is a composition of
infinitely many blow ups, but over any given quasi-compact open
$W \subset X$ one needs only finitely many blow-ups
(and this is the result of loc.\ cit.).

\begin{lemma}
\label{lemma-push-pull-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $D \subset Y$ be an effective Cartier divisor.
Assume $X$, $Y$ integral, $n = \dim_\delta(X) = \dim_\delta(Y)$ and
$f$ dominant. Then
$$
f_*[f^{-1}(D)]_{n - 1} = [R(X) : R(Y)] [D]_{n - 1}.
$$
In particular if $f$ is birational then $f_*[f^{-1}(D)]_{n - 1} = [D]_{n - 1}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-equal-c1-as-cycles}
and the fact that $D$ is the zero
scheme of the canonical section $1_D$ of $\mathcal{O}_X(D)$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-denominators}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral with $\dim_\delta(X) = n$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Let $U \subset X$ be the maximal open subscheme such that
$s$ corresponds to a section of $\mathcal{L}$ over $U$.
There exists a projective morphism
$$
\pi : X' \longrightarrow X
$$
such that
\begin{enumerate}
\item $X'$ is integral,
\item $\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ is an isomorphism,
\item there exist effective Cartier divisors $D, E \subset X'$
such that
$$
\pi^*\mathcal{L} = \mathcal{O}_{X'}(D - E),
$$
\item the meromorphic section $s$ corresponds, via the isomorphism above,
to the meromorphic section $1_D \otimes (1_E)^{-1}$ (see
Divisors, Definition
\ref{divisors-definition-invertible-sheaf-effective-Cartier-divisor}),
\item we have
$$
\pi_*([D]_{n - 1} - [E]_{n - 1}) = \text{div}_\mathcal{L}(s)
$$
in $Z_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent ideal sheaf
of denominators of $s$. Namely, we declare a local section
$f$ of $\mathcal{O}_X$ to be a local section of $\mathcal{I}$
if and only if $fs$ is a local section of $\mathcal{L}$.
On any affine open $U = \Spec(A)$
of $X$ write $\mathcal{L}|_U = \widetilde{L}$ for some invertible
$A$-module $L$. Then $A$ is a Noetherian domain with fraction field
$K = R(X)$ and we may think of $s|_U$ as an element of
$L \otimes_A K$ (see
Divisors, Lemma \ref{divisors-lemma-locally-Noetherian-K}).
Let $I = \{x \in A \mid xs \in L\}$. Then we see that
$\mathcal{I}|_U = \widetilde{I}$ (details omitted) and hence
$\mathcal{I}$ is quasi-coherent.

\medskip\noindent
Consider the closed subscheme $Z \subset X$ defined by $\mathcal{I}$.
It is clear that $U = X \setminus Z$. This suggests we should blow
up $Z$. Let
$$
\pi : X' =
\underline{\text{Proj}}_X
\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right)
\longrightarrow
X
$$
be the blowing up of $X$ along $Z$. The quasi-coherent
sheaf of $\mathcal{O}_X$-algebras
$\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n$
is generated in degree $1$ over $\mathcal{O}_X$.
Moreover, the degree $1$ part is a coherent $\mathcal{O}_X$-module,
in particular of finite type. Hence we see that $\pi$
is projective and $\mathcal{O}_{X'}(1)$ is relatively very ample.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
we have $X'$ is integral. By
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
there exists an effective Cartier divisor $E \subset X'$ such that
$\pi^{-1}\mathcal{I} \cdot \mathcal{O}_{X'} = \mathcal{I}_E$.
Also, by the same lemma we see that $\pi^{-1}(U) \cong U$.

\medskip\noindent
Denote $s'$ the pullback of the meromorphic section $s$ to a meromorphic
section of $\mathcal{L}' = \pi^*\mathcal{L}$ over $X'$.
It follows from the fact that $\mathcal{I}s \subset \mathcal{L}$
that $\mathcal{I}_Es' \subset \mathcal{L}'$. In other words,
$s'$ gives rise to an $\mathcal{O}_{X'}$-linear map
$\mathcal{I}_E \to \mathcal{L}'$, or in other words
a section $t \in \mathcal{L}' \otimes \mathcal{O}_{X'}(E)$.
By Divisors, Lemma \ref{divisors-lemma-characterize-OD} we obtain a unique
effective Cartier divisor $D \subset X'$ such that
$\mathcal{L}' \otimes \mathcal{O}_{X'}(E) \cong \mathcal{O}_{X'}(D)$
with $t$ corresponding to $1_D$. Reversing this procedure
we conclude that
$\mathcal{L}' = \mathcal{O}_{X'}(-E) \cong \mathcal{O}_{X'}(D)$
with $s'$ corresponding to $1_D \otimes 1_E^{-1}$ as in (4).

\medskip\noindent
We still have to prove (5).
By Lemma \ref{lemma-equal-c1-as-cycles} we have
$$
\pi_*(\text{div}_{\mathcal{L}'}(s')) = \text{div}_\mathcal{L}(s).
$$
Hence it suffices to show that
$\text{div}_{\mathcal{L}'}(s') = [D]_{n - 1} - [E]_{n - 1}$.
This follows from the equality
$s' = 1_D \otimes 1_E^{-1}$ and additivity, see
Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{definition}
\label{definition-epsilon}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = n - 1$. The {\it $\epsilon$-invariant}
of this situation is
$$
\epsilon_Z(D_1, D_2) = n_Z \cdot m_Z
$$
where $n_Z$, resp.\ $m_Z$ is the coefficient of
$Z$ in the $(n - 1)$-cycle $[D_1]_{n - 1}$, resp.\ $[D_2]_{n - 1}$.
\end{definition}

\begin{lemma}
\label{lemma-two-divisors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z$ be an open and closed subscheme of the scheme $D_1 \cap D_2$.
Assume $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Then there exists a morphism
$b : X' \to X$, and Cartier divisors
$D_1', D_2', E$ on $X'$ with the following properties
\begin{enumerate}
\item $X'$ is integral,
\item $b$ is projective,
\item $b$ is the blow up of $X$ in the closed subscheme $Z$,
\item $E = b^{-1}(Z)$,
\item $b^{-1}(D_1) = D'_1 + E$, and $b^{-1}D_2 = D_2' + E$,
\item $\dim_\delta(D'_1 \cap D'_2) \leq n - 2$, and if
$Z = D_1 \cap D_2$ then $D'_1 \cap D'_2 = \emptyset$,
\item for every integral closed subscheme $W'$
with $\dim_\delta(W') = n - 1$ we have
\begin{enumerate}
\item if $\epsilon_{W'}(D'_1, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_1, E) < \epsilon_W(D_1, D_2),
$$
\item if $\epsilon_{W'}(D'_2, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_2, E) < \epsilon_W(D_1, D_2),
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the quasi-coherent ideal sheaf
$\mathcal{I} = \mathcal{I}_{D_1} + \mathcal{I}_{D_2}$
defines the scheme theoretic intersection $D_1 \cap D_2 \subset X$.
Since $Z$ is a union of connected components of $D_1 \cap D_2$
we see that for every $z \in Z$ the kernel of
$\mathcal{O}_{X, z} \to \mathcal{O}_{Z, z}$ is equal to $\mathcal{I}_z$.
Let $b : X' \to X$ be the blow up of $X$ in $Z$. (So Zariski locally
around $Z$ it is the blow up of $X$ in $\mathcal{I}$.)
Denote $E = b^{-1}(Z)$ the corresponding effective Cartier divisor, see
Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Since $Z \subset D_1$ we have $E \subset f^{-1}(D_1)$ and hence
$D_1 = D_1' + E$ for some effective Cartier divisor $D'_1 \subset X'$,
see Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
Similarly $D_2 = D_2' + E$. This takes care of assertions (1) -- (5).

\medskip\noindent
Note that if $W'$ is as in (7) (a) or (7) (b), then the image $W$
of $W'$ is contained in $D_1 \cap D_2$. If $W$ is not contained in
$Z$, then $b$ is an isomorphism at the generic point of $W$ and
we see that $\dim_\delta(W) = \dim_\delta(W') = n - 1$ which
contradicts the assumption that
$\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Hence $W \subset Z$. This means that
to prove (6) and (7) we may work locally around $Z$ on $X$.

\medskip\noindent
Thus we may assume that $X = \Spec(A)$ with
$A$ a Noetherian domain, and $D_1 = \Spec(A/a)$,
$D_2 = \Spec(A/b)$ and $Z = D_1 \cap D_2$.
Set $I = (a, b)$. Since $A$ is a domain and $a, b \not = 0$ we can
cover the blow up by two patches, namely
$U = \Spec(A[s]/(as - b))$ and $V = \Spec(A[t]/(bt -a))$.
These patches are glued using the isomorphism
$A[s, s^{-1}]/(as - b) \cong A[t, t^{-1}]/(bt - a)$
which maps $s$ to $t^{-1}$.
The effective Cartier divisor $E$ is described by
$\Spec(A[s]/(as - b, a)) \subset U$ and
$\Spec(A[t]/(bt - a, b)) \subset V$.
The closed subscheme $D'_1$ corresponds to
$\Spec(A[t]/(bt - a, t)) \subset U$.
The closed subscheme $D'_2$ corresponds to
$\Spec(A[s]/(as -b, s)) \subset V$.
Since ``$ts = 1$'' we see that $D'_1 \cap D'_2 = \emptyset$.

\medskip\noindent
Suppose we have a prime $\mathfrak q \subset A[s]/(as - b)$
of height one with $s, a \in \mathfrak q$.
Let $\mathfrak p \subset A$ be the corresponding prime of $A$.
Observe that $a, b \in \mathfrak p$.
By the dimension formula we see that $\dim(A_{\mathfrak p}) = 1$
as well. The final assertion to be shown is that
$$
\text{ord}_{A_{\mathfrak p}}(a)
\text{ord}_{A_{\mathfrak p}}(b)
>
\text{ord}_{B_{\mathfrak q}}(a)
\text{ord}_{B_{\mathfrak q}}(s)
$$
where $B = A[s]/(as - b)$. By
Algebra, Lemma \ref{algebra-lemma-quasi-finite-extension-dim-1}
we have $\text{ord}_{A_{\mathfrak p}}(x) \geq \text{ord}_{B_{\mathfrak q}}(x)$
for $x = a, b$. Since $\text{ord}_{B_{\mathfrak q}}(s) > 0$ we win
by additivity of the $\text{ord}$ function and the fact that
$as = b$.
\end{proof}

\begin{definition}
\label{definition-locally-finite-sum-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given a function
$I \to \mathbf{Z}_{\geq 0}$, $i \mapsto n_i$.
The {\it sum of the effective Cartier divisors}
$D = \sum n_i D_i$, is the unique effective Cartier divisor
$D \subset X$ such that on any quasi-compact open $U \subset X$
we have $D|_U = \sum_{D_i \cap U \not = \emptyset} n_iD_i|_U$
is the sum as in Divisors,
Definition \ref{divisors-definition-sum-effective-Cartier-divisors}.
\end{definition}

\begin{lemma}
\label{lemma-sum-divisors-associated-Weil}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given $n_i \geq 0$ for $i \in I$.
Then
$$
[D]_{n - 1} = \sum\nolimits_i n_i[D_i]_{n - 1}
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Since we are proving an equality of cycles we may work locally on $X$.
Hence this reduces to a finite sum, and by induction to a sum of
two effective Cartier divisors $D = D_1 + D_2$.
By Lemma \ref{lemma-compute-c1} we see that
$D_1 = \text{div}_{\mathcal{O}_X(D_1)}(1_{D_1})$ where
$1_{D_1}$ denotes the canonical section of $\mathcal{O}_X(D_1)$.
Of course we have the same statement for $D_2$ and $D$.
Since $1_D = 1_{D_1} \otimes 1_{D_2}$ via the identification
$\mathcal{O}_X(D) = \mathcal{O}_X(D_1) \otimes \mathcal{O}_X(D_2)$
we win by Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = d$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection of
effective Cartier divisors on $X$.
Assume that for all $\{i, j, k\} \subset I$, $\#\{i, j, k\} = 3$
we have $D_i \cap D_j \cap D_k = \emptyset$.
Then there exist
\begin{enumerate}
\item an open subscheme $U \subset X$ with
$\dim_\delta(X \setminus U) \leq d - 3$,
\item a morphism $b : U' \to U$, and
\item effective Cartier divisors $\{D'_j\}_{j \in J}$ on $U'$
\end{enumerate}
with the following properties:
\begin{enumerate}
\item $b$ is proper morphism $b : U' \to U$,
\item $U'$ is integral,
\item $b$ is an isomorphism over the complement of the union of the pairwise
intersections of the $D_i|_U$,
\item $\{D'_j\}_{j \in J}$ is a locally finite collection of effective
Cartier divisors on $U'$,
\item $\dim_\delta(D'_j \cap D'_{j'}) \leq d - 2$ if $j \not = j'$, and
\item $b^{-1}(D_i|_U) = \sum n_{ij} D'_j$ for certain $n_{ij} \geq 0$.
\end{enumerate}
Moreover, if $X$ is quasi-compact, then we may assume $U = X$ in the above.
\end{lemma}

\begin{proof}
Let us first prove this in the quasi-compact case, since it is perhaps
the most interesting case. In this case we produce inductively a sequence
of blowups
$$
X = X_0 \xleftarrow{b_0} X_1 \xleftarrow{b_1} X_2 \leftarrow \ldots
$$
and finite sets of effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$. Finally, we will have
$$
b_n^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$
We conclude that for each $n \geq 0$ we have
$(b_0 \circ \ldots \circ b_n)^{-1}(D_i)$ is a nonnegative
integer combination of the divisors $D_{n + 1, j}$, $j \in I_{n + 1}$.

\medskip\noindent
To start the induction we set $X_0 = X$ and
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\}_{i \in I_n})$ let $X_{n + 1}$ be the
blow up of $X_n$ in the closed subscheme
$Z_n = \bigcup_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Note that the closed subschemes $D_{n, i} \cap D_{n, i'}$ are pairwise
disjoint by our assumption on triple intersections.
In other words we may write
$Z_n = \coprod_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Moreover, in a Zariski neighbourhood of $D_{n, i} \cap D_{n, i'}$ the
morphism $b_n$ is equal to the blow up of the scheme $X_n$
in the closed subscheme $D_{n, i} \cap D_{n, i'}$, and the results
of Lemma \ref{lemma-two-divisors} apply.
Hence setting $D_{n + 1, \{i, i'\}} = b_n^{-1}(D_i \cap D_{i'})$
we get an effective Cartier divisor.
The Cartier divisors $D_{n + 1, \{i, i'\}}$ are pairwise disjoint.
Clearly we have
$b_n^{-1}(D_{n, i}) \supset D_{n + 1, \{i, i'\}}$ for
every $i' \in I_n$, $i' \not = i$. Hence, applying
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}
we see that indeed $b^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$
for some effective Cartier divisor $D_{n + 1, i}$ on $X_{n + 1}$.
In a neighbourhood of $D_{n + 1, \{i, i'\}}$ these divisors
$D_{n + 1, i}$ play the role of the primed divisors of
Lemma \ref{lemma-two-divisors}. In particular we conclude that
$D_{n + 1, i} \cap D_{n + 1, i'} = \emptyset$ if $i \not = i'$,
$i, i' \in I_n$ by part (6) of Lemma \ref{lemma-two-divisors}.
This already implies that triple intersections
of the divisors $D_{n + 1, i}$ are zero.

\medskip\noindent
OK, and at this point we can use the quasi-compactness of $X$
to conclude that the invariant
\begin{equation}
\label{equation-invariant}
\epsilon(X, \{D_i\}_{i \in I}) =
\max\{\epsilon_Z(D_i, D_{i'}) \mid
Z \subset X,
\dim_\delta(Z) = d - 1,
\{i, i'\} \in P(I)\}
\end{equation}
is finite, since after all each $D_i$ has at most finitely many irreducible
components. We claim that for some $n$ the invariant
$\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ is zero. Namely, if not then
by Lemma \ref{lemma-two-divisors} we have a strictly decreasing sequence
$$
\epsilon(X, \{D_i\}_{i \in I})
=
\epsilon(X_0, \{D_{0, i}\}_{i \in I_0})
>
\epsilon(X_1, \{D_{1, i}\}_{i \in I_1})
>
\ldots
$$
of positive integers which is a contradiction. Take $n$ with
invariant $\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ equal to zero.
This means that there is no integral closed subscheme $Z \subset X_n$
and no pair of indices $i, i' \in I_n$
such that $\epsilon_Z(D_{n, i}, D_{n, i'}) > 0$.
In other words, $\dim_\delta(D_{n, i}, D_{n, i'}) \leq d - 2$ for
all pairs $\{i, i'\} \in P(I_n)$ as desired.

\medskip\noindent
Next, we come to the general case where we no longer assume that
the scheme $X$ is quasi-compact. The problem with the idea from
the first part of the proof is that we may get and infinite sequence
of blow ups with centers dominating a fixed point of $X$. In order to
avoid this we cut out suitable closed subsets of codimension $\geq 3$
at each stage. Namely, we will construct by induction
a sequence of morphisms having the following shape
$$
\xymatrix{
X = X_0 \\
U_0 \ar[u]^{j_0} & X_1 \ar[l]_{b_0} \\
 & U_1 \ar[u]^{j_1} & X_2 \ar[l]_{b_1} \\
 & & U_2 \ar[u]^{j_2} & X_3 \ar[l]_{b_2}
}
$$
Each of the morphisms $j_n : U_n \to X_n$ will be an open immersion.
Each of the morphisms $b_n : X_{n + 1} \to U_n$ will be a proper birational
morphism of integral schemes. As in the quasi-compact case we will have
effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$ on $X_n$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$.
Finally, we will arrange it so that
$$
b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$

\medskip\noindent
We start the induction by setting $X_0 = X$,
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\})$ we construct the open subscheme
$U_n$ as follows. For each pair $\{i, i'\} \in P(I_n)$ consider
the closed subscheme $D_{n, i} \cap D_{n, i'}$. This has ``good''
irreducible components which have $\delta$-dimension $d - 2$ and
``bad'' irreducible components which have $\delta$-dimension $d - 1$.
Let us set
$$
\text{Bad}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 1} W
$$
and similarly
$$
\text{Good}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 2} W.
$$
Then $D_{n, i} \cap D_{n, i'} = \text{Bad}(i, i') \cup \text{Good}(i, i')$
and moreover we have
$\dim_\delta(\text{Bad}(i, i') \cap \text{Good}(i, i')) \leq d - 3$.
Here is our choice of $U_n$:
$$
U_n
=
X_n
\setminus
\bigcup\nolimits_{\{i, i'\} \in P(I_n)}
\text{Bad}(i, i') \cap \text{Good}(i, i').
$$
By our condition on triple intersections of the divisors $D_{n, i}$
we see that the union is actually a disjoint union. Moreover,
we see that (as a scheme)
$$
D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}
=
Z_{n, i, i'} \amalg G_{n, i, i'}
$$
where $Z_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 1$
and $G_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 2$.
(So topologically $Z_{n, i, i'}$ is the union of the bad components
but throw out intersections with good components.) Finally we set
$$
Z_n =
\bigcup\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'} =
\coprod\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'},
$$
and we let $b_n : X_{n + 1} \to X_n$ be the blow up in $Z_n$.
Note that Lemma \ref{lemma-two-divisors}
applies to the morphism $b_n : X_{n + 1} \to X_n$ locally around
each of the loci $D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}$. Hence,
exactly as in the first part of the proof we obtain effective
Cartier divisors $D_{n + 1, \{i, i'\}}$ for $\{i, i'\} \in P(I_n)$
and effective Cartier divisors $D_{n + 1, i}$ for $i \in I_n$
such that
$b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$.
For each $n$ denote $\pi_n : X_n \to X$ the morphism obtained
as the composition $j_0 \circ \ldots \circ j_{n - 1} \circ b_{n - 1}$.

\medskip\noindent
{\bf Claim:} given any quasi-compact open $V \subset X$
for all sufficiently large $n$ the maps
$$
\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V) \leftarrow \ldots
$$
are all isomorphisms. Namely, if the map
$\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V)$ is not an isomorphism,
then $Z_{n, i, i'} \cap \pi_n^{-1}(V) \not = \emptyset$ for some
$\{i, i'\} \in P(I_n)$. Hence there exists an irreducible component
$W \subset D_{n, i} \cap D_{n, i'}$ with $\dim_\delta(W) = d - 1$.
In particular we see that $\epsilon_W(D_{n, i}, D_{n, i'}) > 0$.
Applying Lemma \ref{lemma-two-divisors} repeatedly we see that
$$
\epsilon_W(D_{n, i}, D_{n, i'})
<
\epsilon(V, \{D_i|_V\}) - n
$$
with $\epsilon(V, \{D_i|_V\})$ as in (\ref{equation-invariant}).
Since $V$ is quasi-compact, we have
$\epsilon(V, \{D_i|_V\}) < \infty$ and taking $n > \epsilon(V, \{D_i|_V\})$
we see the result.

\medskip\noindent
Note that by construction the difference $X_n \setminus U_n$
has $\dim_\delta(X_n \setminus U_n) \leq d - 3$.
Let $T_n = \pi_n(X_n \setminus U_n)$ be its image in $X$.
Traversing in the diagram of maps above using each $b_n$ is closed
it follows that $T_0 \cup \ldots \cup T_n$ is a closed subset of $X$
for each $n$. Any $t \in T_n$ satisfies $\delta(t) \leq d - 3$
by construction. Hence $\overline{T_n} \subset X$ is a closed subset
with $\dim_\delta(T_n) \leq d - 3$. By the claim above we see
that for any quasi-compact open $V \subset X$ we have
$T_n \cap V \not = \emptyset$ for at most finitely many $n$.
Hence $\{\overline{T_n}\}_{n \geq 0}$ is a locally finite
collection of closed subsets, and we may set
$U = X \setminus \bigcup \overline{T_n}$. This will be
$U$ as in the lemma.

\medskip\noindent
Note that $U_n \cap \pi_n^{-1}(U) = \pi_n^{-1}(U)$ by construction
of $U$. Hence all the morphisms
$$
b_n : \pi_{n + 1}^{-1}(U) \longrightarrow \pi_n^{-1}(U)
$$
are proper. Moreover, by the claim they eventually become isomorphisms
over each quasi-compact open of $X$. Hence we can define
$$
U' = \lim_n \pi_n^{-1}(U).
$$
The induced morphism $b : U' \to U$ is proper since this is local
on $U$, and over each compact open the limit stabilizes. Similarly
we set $J = \bigcup_{n \geq 0} I_n$ using the inclusions
$I_n \to I_{n + 1}$ from the construction. For $j \in J$ choose
an $n_0$ such that $j$ corresponds to $i \in I_{n_0}$ and define
$D'_j = \lim_{n \geq n_0} D_{n, i}$. Again this makes sense
as locally over $X$ the morphisms stabilize.
The other claims of the lemma are verified as in the case
of a quasi-compact $X$.
\end{proof}


\subsection{Commutativity}
\label{subsection-commutativity}

\noindent
The results of this subsection can be used to provide an alternative
proof of the lemmas of Section \ref{section-commutativity} as was
done in an earlier version of this chapter. See also the discussion
preceding Lemma \ref{lemma-commutativity-effective-Cartier}.

\begin{lemma}
\label{lemma-improved-additivity}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\{i_j : D_j \to X \}_{j \in J}$ be a locally finite collection
of effective Cartier divisors on $X$. Let $n_j > 0$, $j\in J$.
Set $D = \sum_{j \in J} n_j D_j$, and denote $i : D \to X$ the
inclusion morphism. Let $\alpha \in Z_{k + 1}(X)$. Then
$$
p : \coprod\nolimits_{j \in J} D_j \longrightarrow D
$$
is proper and
$$
i^*\alpha = p_*\left(\sum n_j i_j^*\alpha\right)
$$
in $A_k(D)$.
\end{lemma}

\begin{proof}
The proof of this lemma is made a bit longer than expected
by a subtlety concerning infinite sums of rational equivalences.
In the quasi-compact case the family $D_j$ is finite and the result
is altogether easy and a straightforward consequence of
Lemmas \ref{lemma-compute-c1} and
Divisors, \ref{divisors-lemma-c1-additive} and the definitions.

\medskip\noindent
The morphism $p$ is proper since the family $\{D_j\}_{j \in J}$
is locally finite. Write $\alpha = \sum_{a \in A} m_a [W_a]$
with $W_a \subset X$ an integral closed subscheme of
$\delta$-dimension $k + 1$.
Denote $i_a : W_a \to X$ the closed immersion.
We assume that $m_a \not = 0$ for all $a \in A$ such that
$\{W_a\}_{a \in A}$ is locally finite on $X$.

\medskip\noindent
Observe that
by Definition \ref{definition-gysin-homomorphism}
the class $i^*\alpha$ is the class of a cycle
$\sum m_a\beta_a$ for certain $\beta_a \in Z_k(W_a \cap D)$.
Namely, if $W_a \not \subset D$ then $\beta_a = [D \cap W_a]_k$
and if $W_a \subset D$, then $\beta_a$ is a cycle
representing $c_1(\mathcal{O}_X(D)) \cap [W_a]$.

\medskip\noindent
For each $a \in A$ write $J = J_{a, 1} \amalg J_{a, 2} \amalg J_{a, 3}$
where
\begin{enumerate}
\item $j \in J_{a, 1}$ if and only if $W_a \cap D_j = \emptyset$,
\item $j \in J_{a, 2}$ if and only if
$W_a \not = W_a \cap D_1 \not = \emptyset$, and
\item $j \in J_{a, 3}$ if and only if $W_a \subset D_j$.
\end{enumerate}
Since the family $\{D_j\}$ is locally finite we see that
$J_{a, 3}$ is a finite set. For every $a \in A$ and $j \in J$
we choose a cycle $\beta_{a, j} \in Z_k(W_a \cap D_j)$ as follows
\begin{enumerate}
\item if $j \in J_{a, 1}$ we set $\beta_{a, j} = 0$,
\item if $j \in J_{a, 2}$ we set $\beta_{a, j} = [D_j \cap W_a]_k$, and
\item if $j \in J_{a, 3}$ we choose $\beta_{a, j} \in Z_k(W_a)$
representing $c_1(i_a^*\mathcal{O}_X(D_j)) \cap [W_j]$.
\end{enumerate}
We claim that
$$
\beta_a \sim_{rat}
\sum\nolimits_{j \in J} n_j \beta_{a, j}
$$
in $A_k(W_a \cap D)$.

\medskip\noindent
Case I: $W_a \not \subset D$. In this case $J_{a, 3} = \emptyset$.
Thus it suffices to show that
$[D \cap W_a]_k = \sum n_j [D_j \cap W_a]_k$ as cycles.
This is Lemma \ref{lemma-sum-divisors-associated-Weil}.

\medskip\noindent
Case II: $W_a \subset D$. In this case $\beta_a$ is a cycle representing
$c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a]$.
Write $D = D_{a, 1} + D_{a, 2} + D_{a, 3}$ with
$D_{a, s} = \sum_{j \in J_{a, s}} n_jD_j$.
By Divisors, Lemma \ref{divisors-lemma-c1-additive} we have
\begin{eqnarray*}
c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a] & = &
c_1(i_a^*\mathcal{O}_X(D_{a, 1})) \cap [W_a] +
c_1(i_a^*\mathcal{O}_X(D_{a, 2})) \cap [W_a] \\
& &
 + c_1(i_a^*\mathcal{O}_X(D_{a, 3})) \cap [W_a].
\end{eqnarray*}
It is clear that the first term of the sum is zero.
Since $J_{a, 3}$ is finite we see that the last term agrees
with $\sum\nolimits_{j \in J_{a, 3}} n_jc_1(i_a^*\mathcal{L}_j) \cap [W_a]$,
see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
This is represented by $\sum_{j \in J_{a, 3}} n_j \beta_{a, j}$.
Finally, by Case I we see that the middle term is represented by the cycle
$\sum\nolimits_{j \in J_{a, 2}} n_j[D_j \cap W_a]_k =
\sum_{j \in J_{a, 2}} n_j\beta_{a, j}$.
Whence the claim in this case.

\medskip\noindent
At this point we are ready to finish the proof of the lemma.
Namely, we have $i^*D \sim_{rat} \sum m_a\beta_a$ by our
choice of $\beta_a$. For each $a$ we have
$\beta_a \sim_{rat} \sum_j \beta_{a, j}$ with the rational
equivalence taking place on $D \cap W_a$.
Since the collection of closed subschemes $D \cap W_a$
is locally finite on $D$, we see that also
$\sum m_a \beta_a \sim_{rat} \sum_{a, j} m_a\beta_{a, j}$
on $D$! (See Remark \ref{remark-infinite-sums-rational-equivalences}.)
Ok, and now it is clear that $\sum_a m_a\beta_{a, j}$ (viewed
as a cycle on $D_j$) represents $i_j^*\alpha$ and hence
$\sum_{a, j} m_a\beta_{a, j}$ represents $p_* \sum_j i_j^*\alpha$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Assume $\dim_\delta(D \cap D') = n - 2$. Let $i : D \to X$,
resp.\ $i' : D' \to X$ be the corresponding closed immersions.
Then
\begin{enumerate}
\item there exists a cycle $\alpha \in Z_{n - 2}(D \cap D')$
whose pushforward to $D$ represents
$i^*[D']_{n - 1} \in A_{n - 2}(D)$
and whose pushforward to $D'$ represents
$(i')^*[D]_{n - 1} \in A_{n - 2}(D')$, and
\item we have
$$
D \cdot [D']_{n - 1}
=
D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) is a trivial consequence of part (1).
Let us write $[D]_{n - 1} = \sum n_a[Z_a]$ and
$[D']_{n - 1} = \sum m_b[Z_b]$ with $Z_a$ the irreducible
components of $D$ and $[Z_b]$ the irreducible
components of $D'$.
According to Definition \ref{definition-gysin-homomorphism},
we have $i^*D' = \sum m_b i^*[Z_b]$ and $(i')^*D = \sum n_a(i')^*[Z_a]$.
By assumption, none of the irreducible components $Z_b$
is contained in $D$, and hence $i^*[Z_b] = [Z_b\cap D]_{n - 2}$
by definition. Similarly $(i')^*[Z_a] = [Z_a \cap D']_{n - 2}$.
Hence we are trying to prove the equality of cycles
$$
\sum n_a[Z_a \cap D']_{n - 2} = \sum m_b[Z_b \cap D]_{n - 2}
$$
which are indeed supported on $D \cap D'$.
Let $W \subset X$ be an integral closed subscheme
with $\dim_\delta(W) = n - 2$. Let $\xi \in W$ be its generic point.
Set $R = \mathcal{O}_{X, \xi}$. It is a Noetherian local domain.
Note that $\dim(R) = 2$. Let $f \in R$, resp.\ $f' \in R$
be an element defining the ideal of $D$, resp.\ $D'$.
By assumption $\dim(R/(f, f')) = 0$. Let
$\mathfrak q'_1, \ldots, \mathfrak q'_t \subset R$ be the minimal
primes over $(f')$, let $\mathfrak q_1, \ldots, \mathfrak q_s \subset R$
be the minimal primes over $(f)$.
The equality above comes down to the equality
$$
\sum_{i = 1, \ldots, s}
\text{length}_{R_{\mathfrak q_i}}(R_{\mathfrak q_i}/(f))
\text{ord}_{R/\mathfrak q_i}(f')
=
\sum_{j = 1, \ldots, t}
\text{length}_{R_{\mathfrak q'_j}}(R_{\mathfrak q'_j}/(f'))
\text{ord}_{R/\mathfrak q'_j}(f).
$$
By Algebra, Lemma \ref{algebra-lemma-length-multiplication}
applied with $M = R/(f)$ the left hand side of
this equation is equal to
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R(\Ker(f' : R/(f) \to R/(f)))
$$
OK, and now we note that
$\Ker(f' : R/(f) \to R/(f))$ is canonically isomorphic
to $((f) \cap (f'))/(ff')$ via the map $x \bmod (f) \mapsto
f'x \bmod (ff')$. Hence the left hand side is
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R((f) \cap (f')/(ff'))
$$
Since this is symmetric in $f$ and $f'$ we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_j\}_{j \in J}$ be a locally finite collection of
effective Cartier divisors on $X$. Let $n_j, m_j \geq 0$ be
collections of nonnegative integers. Set
$D = \sum n_j D_j$ and $D' = \sum m_j D_j$.
Assume that $\dim_\delta(D_j \cap D_{j'}) = n - 2$ for every
$j \not = j'$. Then $D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}$ in
$A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
This lemma is a trivial consequence of
Lemmas \ref{lemma-sum-divisors-associated-Weil} and
\ref{lemma-commutativity-effective-Cartier-proper-intersection}
in case the sums are finite, e.g., if $X$ is quasi-compact.
Hence we suggest the reader skip the proof.

\medskip\noindent
Here is the proof in the general case.
Let $i_j : D_j \to X$ be the closed immersions
Let $p : \coprod D_j \to X$ denote coproduct of the morphisms $i_j$.
Let $\{Z_a\}_{a \in A}$ be the collection of irreducible components of
$\bigcup D_j$. For each $j$ we write
$$
[D_j]_{n - 1} = \sum d_{j, a}[Z_a].
$$
By Lemma \ref{lemma-sum-divisors-associated-Weil} we have
$$
[D]_{n - 1} = \sum n_j d_{j, a} [Z_a],
\quad
[D']_{n - 1} = \sum m_j d_{j, a} [Z_a].
$$
By Lemma \ref{lemma-improved-additivity}
we have
$$
D \cdot [D']_{n - 1} = p_*\left(\sum n_j i_j^*[D']_{n - 1} \right),
\quad
D' \cdot [D]_{n - 1} = p_*\left(\sum m_{j'} i_{j'}^*[D]_{n - 1} \right).
$$
As in the definition of the Gysin homomorphisms (see
Definition \ref{definition-gysin-homomorphism})
we choose cycles $\beta_{a, j}$ on $D_j \cap Z_a$ representing
$i_j^*[Z_a]$. (Note that in fact $\beta_{a, j} = [D_j \cap Z_a]_{n - 2}$
if $Z_a$ is not contained in $D_j$, i.e., there is no choice in that case.)
Now since $p$ is a closed immersion when restricted to each of the $D_j$
we can (and we will) view $\beta_{a, j}$ as a cycle on $X$.
Plugging in the formulas for $[D]_{n - 1}$ and $[D']_{n - 1}$ obtained
above we see that
$$
D \cdot [D']_{n - 1} =
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j},
\quad
D' \cdot [D]_{n - 1} =
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'}.
$$
Moreover, with the same conventions we also have
$$
D_j \cdot [D_{j'}]_{n - 1} = \sum d_{j', a} \beta_{a, j}.
$$
In these terms
Lemma \ref{lemma-commutativity-effective-Cartier-proper-intersection}
(see also its proof)
says that for $j \not = j'$ the cycles
$\sum d_{j', a} \beta_{a, j}$ and $\sum d_{j, a} \beta_{a, j'}$
are equal as cycles! Hence we see that
\begin{eqnarray*}
D \cdot [D']_{n - 1}
& = &
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j', a} \beta_{a, j}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j, a} \beta_{a, j'}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'} \\
& = &
D' \cdot [D]_{n - 1}
\end{eqnarray*}
and we win.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ integral
and $\dim_\delta(X) = n$. Let $D$, $D'$ be effective Cartier divisors on $X$.
A stronger (and more useful) version of the following lemma
asserts that
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
\quad\text{in}\quad
A_{n - 2}(D \cap D')
$$
for suitable representatives of the dot products involved. The first proof
of the lemma together with
Lemmas \ref{lemma-improved-additivity},
\ref{lemma-commutativity-effective-Cartier-proper-intersection}, and
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
can be modified to show this (see \cite{F}). It is
not so clear how to modify the second proof to prove the refined
version. An application of the refined version is a proof that the
Gysin homomorphism factors through rational equivalence which we proved
by a different method in Lemma \ref{lemma-gysin-factors}.

\begin{lemma}
\label{lemma-commutativity-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Then
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
First, let us prove this in case $X$ is quasi-compact.
In this case, apply Lemma \ref{lemma-blowing-up-intersections} to $X$ and the
two element set $\{D, D'\}$ of effective Cartier divisors.
Thus we get a proper morphism $b : X' \to X$,
a finite collection of effective Cartier
divisors $D'_j \subset X'$ intersecting pairwise in codimension $\geq 2$,
with $b^{-1}(D) = \sum n_j D'_j$, and $b^{-1}(D') = \sum m_j D'_j$.
Note that $b_*[b^{-1}(D)]_{n - 1} = [D]_{n - 1}$ in $Z_{n - 1}(X)$
and similarly for $D'$,
see Lemma \ref{lemma-push-pull-effective-Cartier}.
Hence, by Lemma \ref{lemma-pushforward-cap-c1} we have
$$
D \cdot [D']_{n - 1} = b_*\left(b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1}\right)
$$
in $A_{n - 2}(X)$ and similarly for the other term. Hence the
lemma follows from the equality
$b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1} = b^{-1}(D') \cdot [b^{-1}(D)]_{n - 1}$
in $A_{n - 2}(X')$ of Lemma
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}.

\medskip\noindent
Note that in the proof above, each referenced lemma works also
in the general case (when $X$ is not assumed quasi-compact). The
only minor change in the general case is that the morphism
$b : U' \to U$ we get from applying Lemma \ref{lemma-blowing-up-intersections}
has as its target
an open $U \subset X$ whose complement has codimension $\geq 3$.
Hence by Lemma \ref{lemma-restrict-to-open} we see that
$A_{n - 2}(U) = A_{n - 2}(X)$
and after replacing $X$ by $U$ the rest of the proof goes through
unchanged.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
Let $\mathcal{I} = \mathcal{O}_X(-D)$ and
$\mathcal{I}' = \mathcal{O}_X(-D')$ be the invertible
ideal sheaves of $D$ and $D'$.
We denote
$\mathcal{I}_{D'} = \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{O}_{D'}$
and
$\mathcal{I}'_D = \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{O}_D$.
We can restrict the inclusion map $\mathcal{I} \to \mathcal{O}_X$
to $D'$ to get a map
$$
\varphi : \mathcal{I}_{D'} \longrightarrow \mathcal{O}_{D'}
$$
and similarly
$$
\psi : \mathcal{I}'_D \longrightarrow \mathcal{O}_D
$$
It is clear that
$$
\Coker(\varphi)
\cong
\mathcal{O}_{D \cap D'}
\cong
\Coker(\psi)
$$
and
$$
\Ker(\varphi)
\cong
\frac{\mathcal{I} \cap \mathcal{I}'}{\mathcal{I}\mathcal{I}'}
\cong
\Ker(\psi).
$$
Hence we see that
$$
\gamma =
[\mathcal{I}_{D'}] - [\mathcal{O}_{D'}]
=
[\mathcal{I}'_D] - [\mathcal{O}_D]
$$
in $K_0(\textit{Coh}_{\leq n - 1}(X))$. On the other hand it is clear that
$$
[\mathcal{I}'_D]_{n - 1} = [D]_{n - 1}, \quad
[\mathcal{I}_{D'}]_{n - 1} = [D']_{n - 1}.
$$
and that
$$
\mathcal{O}_X(D') \otimes \mathcal{I}'_D = \mathcal{O}_D, \quad
\mathcal{O}_X(D) \otimes \mathcal{I}_{D'} = \mathcal{O}_{D'}.
$$
By Lemma \ref{lemma-coherent-sheaf-cap-c1} (applied two times)
this means that the element $\gamma$ is an element of $B_{n - 2}(X)$, and
maps to both $c_1(\mathcal{O}_X(D')) \cap [D]_{n - 1}$ and to
$c_1(\mathcal{O}_X(D)) \cap [D']_{n - 1}$ and we win (since the
map $B_{n - 2}(X) \to A_{n - 2}(X)$ is well defined -- which is
the key to this proof).
\end{proof}













\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Coding Style}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{List of style comments}
\label{section-style}

\noindent
These will be changed over time, but having some here now
will hopefully encourage a consistent LaTeX style.
We will call ``code\footnote{It is all Knuth's fault. See \cite{Knuth}.}''
the contents of the source files.

\begin{enumerate}
\item Keep all lines in all tex files to at most 80 characters.
\item Do not use indentation in the tex file. Use syntax highlighting in your
editor, instead of indentation, to visualize environments, etc.
\item Use
\begin{verbatim}
\medskip\noindent
\end{verbatim}
to start a new paragraph, and use
\begin{verbatim}
\noindent
\end{verbatim}
to start a new paragraph just after an environment.
\item Do not break the code for mathematical formulas across
lines if possible. If the complete code complete with enclosing
dollar signs does not fit on the line, then start with the first
dollar sign on the first character of the next line. If it still
does not fit, find a mathematically reasonable spot to break
the code.
\item Displayed math equations should be coded as follows
\begin{verbatim}
$$
...
...
$$
\end{verbatim}
In other words, start with a double dollar sign on a line by itself
and end similarly.
\item {\it Do not use any macros}. Rationale: This makes it easier
to read the tex file, and start editing an arbitrary part
without having to learn innumerable macros.
And it doesn't make it harder or more timeconsuming to write.
Of course the disadvantage is that the same mathematical object
may be TeXed differently in different places in the text, but
this should be easy to spot.
\item The theorem environments we use are:
``theorem'', ``proposition'', ``lemma'' (plain),
``definition'', ``example'', ``exercise'', ``situation'' (definition),
``remark'', ``remarks'' (remark). Of course there is also
a ``proof'' environment.
\item An environment ``foo'' should be coded as follows
\begin{verbatim}
\begin{foo}
...
...
\end{foo}
\end{verbatim}
similarly to the way displayed equations are coded.
\item Instead of a ``corollary'', just use ``lemma'' environment
since likely the result will be used to prove the next bigger
theorem anyway.
\item Directly following each lemma, proposition, or theorem
is the proof of said lemma, proposition, or theorem. No nested
proofs please.
\item The files preamble.tex, chapters.tex and fdl.tex are special
tex files. Apart from these, each tex file
has the following structure
\begin{verbatim}
\input{preamble}
\begin{document}
\title{Title}
\maketitle
\tableofcontents
...
...
\input{chapters}
\bibliography{my}
\bibliographystyle{amsalpha}
\end{document}
\end{verbatim}
\item Try to add labels to lemmas, propositions, theorems, and even
remarks, exercise, and other environments.
If labelling a lemma use something like
\begin{verbatim}
\begin{lemma}
\label{lemma-bar}
...
\end{lemma}
\end{verbatim}
Similarly for all other environments. In other words, the label
of a environment named ``foo'' starts with ``foo-''. In addition to
this please make all labels consist only of lower case letters,
digits, and the symbol ``-''.
\item Never refer to ``the lemma above'' (or proposition, etc).
Instead use:
\begin{verbatim}
Lemma \ref{lemma-bar} above
\end{verbatim}
This means that later
moving lemmas around is basically harmless.
\item Cross-file referencing. To reference a lemma labeled
``lemma-bar'' in the file foo.tex which has title
``Foo'', please use the following code
\begin{verbatim}
Foo, Lemma \ref{foo-lemma-bar}
\end{verbatim}
If this does not work, then take a look at the file
preamble.tex to find the correct expression to use.
This will produce the ``Foo, Lemma $<$link$>$'' in the
output file so it will be clear that the link points
out of the file.
\item If at all possible avoid forward references in proof
environments. (It should be possible to write an automated
test for this.)
\item Do not start any sentence with a mathematical symbol.
\item Do not have a sentence of the type ``This follows from
the following'' just before a lemma, proposition, or theorem.
Every sentence ends with a period.
\item State all hypotheses in each lemma, proposition, theorem.
This makes it easier for readers to see if a given
lemma, proposition, or theorem applies to their particular
problem.
\item Keep proofs short; less than 1 page in pdf or dvi.
You can always achieve this by splitting out the proof in lemmas
etc.
\item In a defining property foobar use
\begin{verbatim}
{\it foobar}
\end{verbatim}
in the code inside the definition environment.
Similarly if the definition occurs in the text of the document.
This will make it easier for the reader to see what it is
that is being defined.
\item Put any definition that will be used outside the section
it is in, in its own definition environment. Temporary definitions
may be made in the text. A tricky case is that of mathematical
constructions (which are often definitions involving interrelated
lemmas). Maybe a good solution is to have them in their own
short section so users can refer to the section instead of
a definition.
\item Do not number equations unless they are actually being
referenced somewhere in the text. We can always add labels later.
\item In statements of lemmas, propositions and theorems and
in proofs keep the sentences short. For example, instead of
``Let $R$ be a ring and let $M$ be an $R$-module.'' write
``Let $R$ be a ring. Let $M$ be an $R$-module.''. Rationale:
This makes it easier to parse the trickier parts of proofs and
statements.
\item Use the
\begin{verbatim}
\section
\end{verbatim}
command to make sections, but try to avoid using subsections
and subsubsections.
\item Avoid using complicated latex constructions.
\end{enumerate}





\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Cohomology of Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we first prove a number of results on the cohomology of
quasi-coherent sheaves. A fundamental reference is \cite{EGA}.
Having done this we will elaborate on cohomology of
coherent sheaves in the Noetherian setting. See \cite{FAC}.







\section{{\v C}ech cohomology of quasi-coherent sheaves}
\label{section-cech-quasi-coherent}

\noindent
Let $X$ be a scheme.
Let $U \subset X$ be an affine open.
Recall that a {\it standard open covering} of $U$ is a covering
of the form $\mathcal{U} : U = \bigcup_{i = 1}^n D(f_i)$
where $f_1, \ldots, f_n \in \Gamma(U, \mathcal{O}_X)$ generate
the unit ideal, see
Schemes, Definition \ref{schemes-definition-standard-covering}.

\begin{lemma}
\label{lemma-cech-cohomology-quasi-coherent-trivial}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $\mathcal{U} : U = \bigcup_{i = 1}^n D(f_i)$ be a standard
open covering of an affine open of $X$.
Then $\check{H}^p(\mathcal{U}, \mathcal{F}) = 0$ for
all $p > 0$.
\end{lemma}

\begin{proof}
Write $U = \Spec(A)$ for some ring $A$.
In other words, $f_1, \ldots, f_n$ are elements of $A$
which generate the unit ideal of $A$.
Write $\mathcal{F}|_U = \widetilde{M}$ for some $A$-module $M$.
Clearly the {\v C}ech complex
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})$
is identified with the complex
$$
\prod\nolimits_{i_0} M_{f_{i_0}} \to
\prod\nolimits_{i_0i_1} M_{f_{i_0}f_{i_1}} \to
\prod\nolimits_{i_0i_1i_2} M_{f_{i_0}f_{i_1}f_{i_2}} \to
\ldots
$$
We are asked to show that the extended complex
\begin{equation}
\label{equation-extended}
0 \to
M \to
\prod\nolimits_{i_0} M_{f_{i_0}} \to
\prod\nolimits_{i_0i_1} M_{f_{i_0}f_{i_1}} \to
\prod\nolimits_{i_0i_1i_2} M_{f_{i_0}f_{i_1}f_{i_2}} \to
\ldots
\end{equation}
(whose truncation we have studied in
Algebra, Lemma \ref{algebra-lemma-cover-module}) is exact.
It suffices to show that (\ref{equation-extended})
is exact after localizing at a prime $\mathfrak p$, see
Algebra, Lemma \ref{algebra-lemma-characterize-zero-local}.
In fact we will show that the extended complex localized
at $\mathfrak p$ is homotopic to zero.

\medskip\noindent
There exists an index $i$ such that $f_i \not \in \mathfrak p$.
Choose and fix such an element $i_{\text{fix}}$. Note that
$M_{f_{i_{\text{fix}}}, \mathfrak p} = M_{\mathfrak p}$. Similarly
for a localization at a product $f_{i_0} \ldots f_{i_p}$ and $\mathfrak p$
we can drop any $f_{i_j}$ for which $i_j = i_{\text{fix}}$.
Let us define a homotopy
$$
h :
\prod\nolimits_{i_0 \ldots i_{p + 1}}
M_{f_{i_0} \ldots f_{i_{p + 1}}, \mathfrak p}
\longrightarrow
\prod\nolimits_{i_0 \ldots i_p}
M_{f_{i_0} \ldots f_{i_p}, \mathfrak p}
$$
by the rule
$$
h(s)_{i_0 \ldots i_p} = s_{i_{\text{fix}} i_0 \ldots i_p}
$$
(This is ``dual'' to the homotopy in the proof of
Cohomology, Lemma \ref{cohomology-lemma-homology-complex}.)
In other words, $h : \prod_{i_0} M_{f_{i_0}, \mathfrak p} \to M$
is projection onto the factor
$M_{f_{i_{\text{fix}}}, \mathfrak p} = M_{\mathfrak p}$ and in general
the map $h$ equal projection onto the factors
$M_{f_{i_{\text{fix}}} f_{i_1} \ldots f_{i_{p + 1}}, \mathfrak p}
= M_{f_{i_1} \ldots f_{i_{p + 1}}, \mathfrak p}$. We compute
\begin{align*}
(dh + hd)(s)_{i_0 \ldots i_p}
& =
\sum\nolimits_{j = 0}^p
(-1)^j
h(s)_{i_0 \ldots \hat i_j \ldots i_p}
+
d(s)_{i_{\text{fix}} i_0 \ldots i_p}\\
& =
\sum\nolimits_{j = 0}^p
(-1)^j
s_{i_{\text{fix}} i_0 \ldots \hat i_j \ldots i_p}
+
s_{i_0 \ldots i_p}
+
\sum\nolimits_{j = 0}^p
(-1)^{j + 1}
s_{i_{\text{fix}} i_0 \ldots \hat i_j \ldots i_p} \\
& =
s_{i_0 \ldots i_p}
\end{align*}
This proves the identity map is homotopic to zero as desired.
\end{proof}

\noindent
The following lemma says in particular that for any affine scheme
$X$ and any quasi-coherent sheaf $\mathcal{F}$ on $X$ we have
$$
H^p(X, \mathcal{F}) = 0
$$
for all $p > 0$.

\begin{lemma}
\label{lemma-quasi-coherent-affine-cohomology-zero}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
For any affine open $U \subset X$ we have
$H^p(U, \mathcal{F}) = 0$ for all $p > 0$.
\end{lemma}

\begin{proof}
We are going to apply
Cohomology, Lemma \ref{cohomology-lemma-cech-vanish-basis}.
As our basis $\mathcal{B}$ for the topology of $X$ we are going to use
the affine opens of $X$.
As our set $\text{Cov}$ of open coverings we are going to use the standard
open coverings of affine opens of $X$.
Next we check that conditions (1), (2) and (3) of
Cohomology, Lemma \ref{cohomology-lemma-cech-vanish-basis}
hold. Note that the intersection of standard opens in an affine is
another standard open. Hence property (1) holds.
The coverings form a cofinal system of open coverings of any element
of $\mathcal{B}$, see
Schemes, Lemma \ref{schemes-lemma-standard-open}.
Hence (2) holds.
Finally, condition (3) of the lemma follows from
Lemma \ref{lemma-cech-cohomology-quasi-coherent-trivial}.
\end{proof}

\noindent
Here is a relative version of the vanishing of cohomology of quasi-coherent
sheaves on affines.

\begin{lemma}
\label{lemma-relative-affine-vanishing}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $f$ is affine then $R^if_*\mathcal{F} = 0$ for all $i > 0$.
\end{lemma}

\begin{proof}
According to
Cohomology, Lemma \ref{cohomology-lemma-describe-higher-direct-images}
the sheaf
$R^if_*\mathcal{F}$ is the sheaf associated to the presheaf
$V \mapsto H^i(f^{-1}(V), \mathcal{F}|_{f^{-1}(V)})$.
By assumption, whenever $V$ is affine we have that $f^{-1}(V)$ is
affine, see Morphisms, Definition \ref{morphisms-definition-affine}.
By Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero} we conclude that
$H^i(f^{-1}(V), \mathcal{F}|_{f^{-1}(V)}) = 0$
whenever $V$ is affine. Since $S$ has a basis consisting of affine
opens we win.
\end{proof}

\begin{lemma}
\label{lemma-relative-affine-cohomology}
Let $f : X \to S$ be an affine morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $H^i(X, \mathcal{F}) = H^i(S, f_*\mathcal{F})$ for all $i \geq 0$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-relative-affine-vanishing}
and the Leray spectral sequence. See
Cohomology, Lemma \ref{cohomology-lemma-apply-Leray}.
\end{proof}

\noindent
The following two lemmas explain when {\v C}ech cohomology
can be used to compute cohomology of quasi-coherent modules.

\begin{lemma}
\label{lemma-affine-diagonal}
Let $X$ be a scheme. The following are equivalent
\begin{enumerate}
\item $X$ has affine diagonal $\Delta : X \to X \times X$,
\item for $U, V \subset X$ affine open, the intersection
$U \cap V$ is affine, and
\item there exists an open covering $\mathcal{U} : X = \bigcup_{i \in I} U_i$
such that $U_{i_0 \ldots i_p}$ is affine open for all $p \ge 0$ and all
$i_0, \ldots, i_p \in I$.
\end{enumerate}
In particular this holds if $X$ is separated.
\end{lemma}

\begin{proof}
Assume $X$ has affine diagonal. Let $U, V \subset X$ be affine opens.
Then $U \cap V = \Delta^{-1}(U \times V)$ is affine. Thus (2) holds.
It is immediate that (2) implies (3). Conversely, if there is a
covering of $X$ as in (3), then $X \times X = \bigcup U_i \times U_{i'}$
is an affine open covering, and we see that
$\Delta^{-1}(U_i \times U_{i'}) = U_i \cap U_{i'}$
is affine. Then $\Delta$ is an affine morphism by
Morphisms, Lemma \ref{morphisms-lemma-characterize-affine}.
The final assertion follows from Schemes, Lemma
\ref{schemes-lemma-characterize-separated}.
\end{proof}

\begin{lemma}
\label{lemma-cech-cohomology-quasi-coherent}
Let $X$ be a scheme.
Let $\mathcal{U} : X = \bigcup_{i \in I} U_i$ be an open covering such that
$U_{i_0 \ldots i_p}$ is affine open for all $p \ge 0$ and all
$i_0, \ldots, i_p \in I$.
In this case for any quasi-coherent sheaf $\mathcal{F}$ we have
$$
\check{H}^p(\mathcal{U}, \mathcal{F}) = H^p(X, \mathcal{F})
$$
as $\Gamma(X, \mathcal{O}_X)$-modules for all $p$.
\end{lemma}

\begin{proof}
In view of
Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}
this is a special case of
Cohomology, Lemma
\ref{cohomology-lemma-cech-spectral-sequence-application}.
\end{proof}







\section{Vanishing of cohomology}
\label{section-vanishing}

\noindent
We have seen that on an affine scheme the higher cohomology groups
of any quasi-coherent sheaf vanish
(Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}).
It turns out that this also
characterizes affine schemes. We give two versions.

\begin{lemma}
\label{lemma-quasi-compact-h1-zero-covering}
\begin{reference}
\cite{Serre-criterion}
\end{reference}
\begin{slogan}
Serre's criterion for affineness.
\end{slogan}
Let $X$ be a scheme.
Assume that
\begin{enumerate}
\item $X$ is quasi-compact,
\item for every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$ we have $H^1(X, \mathcal{I}) = 0$.
\end{enumerate}
Then $X$ is affine.
\end{lemma}

\begin{proof}
Let $x \in X$ be a closed point. Let $U \subset X$ be an affine open
neighbourhood of $x$. Write $U = \Spec(A)$ and let
$\mathfrak m \subset A$ be the maximal ideal corresponding to $x$.
Set $Z = X \setminus U$ and $Z' = Z \cup \{x\}$.
By Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme} there
are quasi-coherent sheaves of ideals
$\mathcal{I}$, resp.\ $\mathcal{I}'$ cutting out
the reduced closed subschemes $Z$, resp.\ $Z'$.
Consider the short exact sequence
$$
0 \to \mathcal{I}' \to \mathcal{I} \to \mathcal{I}/\mathcal{I}' \to 0.
$$
Since $x$ is a closed point of $X$ and $x \not \in Z$ we see that
$\mathcal{I}/\mathcal{I}'$ is supported at $x$. In fact, the restriction
of $\mathcal{I}/\mathcal{I'}$ to $U$ corresponds to the $A$-module
$A/\mathfrak m$. Hence we see that $\Gamma(X, \mathcal{I}/\mathcal{I'})
= A/\mathfrak m$. Since by assumption $H^1(X, \mathcal{I}') = 0$
we see there exists a global section $f \in \Gamma(X, \mathcal{I})$
which maps to the element $1 \in A/\mathfrak m$ as a section of
$\mathcal{I}/\mathcal{I'}$. Clearly we have
$x \in X_f \subset U$. This implies that $X_f = D(f_A)$ where
$f_A$ is the image of $f$ in $A = \Gamma(U, \mathcal{O}_X)$.
In particular $X_f$ is affine.

\medskip\noindent
Consider the union $W = \bigcup X_f$ over all $f \in \Gamma(X, \mathcal{O}_X)$
such that $X_f$ is affine. Obviously $W$ is open in $X$.
By the arguments above every closed point of
$X$ is contained in $W$. The closed subset $X \setminus W$ of $X$
is also quasi-compact
(see Topology, Lemma \ref{topology-lemma-closed-in-quasi-compact}).
Hence it has a closed point if it is nonempty (see
Topology, Lemma \ref{topology-lemma-quasi-compact-closed-point}).
This would contradict the fact that all closed points are in
$W$. Hence we conclude $X = W$.

\medskip\noindent
Choose finitely many $f_1, \ldots, f_n \in \Gamma(X, \mathcal{O}_X)$
such that $X = X_{f_1} \cup \ldots \cup X_{f_n}$ and such that each
$X_{f_i}$ is affine. This is possible as we've seen above.
By Properties, Lemma \ref{properties-lemma-characterize-affine}
to finish the proof it suffices
to show that $f_1, \ldots, f_n$ generate the unit ideal in
$\Gamma(X, \mathcal{O}_X)$. Consider the short exact sequence
$$
\xymatrix{
0 \ar[r] &
\mathcal{F} \ar[r] &
\mathcal{O}_X^{\oplus n} \ar[rr]^{f_1, \ldots, f_n} & &
\mathcal{O}_X \ar[r] &
0
}
$$
The arrow defined by $f_1, \ldots, f_n$ is surjective since the
opens $X_{f_i}$ cover $X$. We let $\mathcal{F}$ be the kernel
of this surjective map.
Observe that $\mathcal{F}$ has a filtration
$$
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset
\ldots \subset \mathcal{F}_n = \mathcal{F}
$$
so that each subquotient $\mathcal{F}_i/\mathcal{F}_{i - 1}$ is
isomorphic to a quasi-coherent sheaf of ideals.
Namely we can take $\mathcal{F}_i$ to be the intersection of
$\mathcal{F}$ with the first $i$ direct summands of
$\mathcal{O}_X^{\oplus n}$.
The assumption
of the lemma implies that $H^1(X, \mathcal{F}_i/\mathcal{F}_{i - 1}) = 0$
for all $i$. This implies that
$H^1(X, \mathcal{F}_2) = 0$ because it is sandwiched between
$H^1(X, \mathcal{F}_1)$ and $H^1(X, \mathcal{F}_2/\mathcal{F}_1)$.
Continuing like this we deduce that $H^1(X, \mathcal{F}) = 0$.
Therefore we conclude that the map
$$
\xymatrix{
\bigoplus\nolimits_{i = 1, \ldots, n} \Gamma(X, \mathcal{O}_X)
\ar[rr]^{f_1, \ldots, f_n} & &
\Gamma(X, \mathcal{O}_X)
}
$$
is surjective as desired.
\end{proof}

\noindent
Note that if $X$ is a Noetherian scheme then every quasi-coherent
sheaf of ideals is automatically a coherent sheaf of ideals and a
finite type quasi-coherent sheaf of ideals. Hence
the preceding lemma and the next lemma both apply in this case.

\begin{lemma}
\label{lemma-quasi-separated-h1-zero-covering}
\begin{reference}
\cite{Serre-criterion}
\end{reference}
\begin{slogan}
Serre's criterion for affineness.
\end{slogan}
Let $X$ be a scheme. Assume that
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ is quasi-separated, and
\item $H^1(X, \mathcal{I}) = 0$ for every quasi-coherent sheaf
of ideals $\mathcal{I}$ of finite type.
\end{enumerate}
Then $X$ is affine.
\end{lemma}

\begin{proof}
By
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
every quasi-coherent sheaf of ideals is a directed colimit of
quasi-coherent sheaves of ideals of finite type.
By Cohomology, Lemma \ref{cohomology-lemma-quasi-separated-cohomology-colimit}
taking cohomology on $X$ commutes with directed colimits.
Hence we see that $H^1(X, \mathcal{I}) = 0$
for every quasi-coherent sheaf of ideals on $X$. In other words
we see that Lemma \ref{lemma-quasi-compact-h1-zero-covering} applies.
\end{proof}

\noindent
We can use the arguments given above to find a sufficient criterion to
see when an invertible sheaf is ample. However, we warn the reader that
this criterion is not necessary.

\begin{lemma}
\label{lemma-quasi-compact-h1-zero-invertible}
Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume that
\begin{enumerate}
\item $X$ is quasi-compact,
\item for every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$
there exists an $n \geq 1$ such that
$H^1(X, \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}) = 0$.
\end{enumerate}
Then $\mathcal{L}$ is ample.
\end{lemma}

\begin{proof}
This is proved in exactly the same way as
Lemma \ref{lemma-quasi-compact-h1-zero-covering}.
Let $x \in X$ be a closed point. Let $U \subset X$ be an affine open
neighbourhood of $x$ such that $\mathcal{L}|_U \cong \mathcal{O}_U$.
Write $U = \Spec(A)$ and let
$\mathfrak m \subset A$ be the maximal ideal corresponding to $x$.
Set $Z = X \setminus U$ and $Z' = Z \cup \{x\}$.
By Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme} there
are quasi-coherent sheaves of ideals
$\mathcal{I}$, resp.\ $\mathcal{I}'$ cutting out
the reduced closed subschemes $Z$, resp.\ $Z'$.
Consider the short exact sequence
$$
0 \to \mathcal{I}' \to \mathcal{I} \to \mathcal{I}/\mathcal{I}' \to 0.
$$
For every $n \geq 1$ we obtain a short exact sequence
$$
0 \to \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}
\to \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n} \to
\mathcal{I}/\mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n} \to 0.
$$
By our assumption we may pick $n$ such that
$H^1(X, \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}) = 0$.
Since $x$ is a closed point of $X$ and $x \not \in Z$ we see that
$\mathcal{I}/\mathcal{I}'$ is supported at $x$. In fact, the restriction
of $\mathcal{I}/\mathcal{I'}$ to $U$ corresponds to the $A$-module
$A/\mathfrak m$. Since $\mathcal{L}$ is trivial on $U$
we see that the restriction of
$\mathcal{I}/\mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}$
to $U$ also corresponds to the $A$-module $A/\mathfrak m$.
Hence we see that
$\Gamma(X, \mathcal{I}/\mathcal{I'} \otimes_{\mathcal{O}_X}
\mathcal{L}^{\otimes n}) = A/\mathfrak m$.
By our choice of $n$ we see there exists a global section
$s \in \Gamma(X, \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n})$
which maps to the element $1 \in A/\mathfrak m$. Clearly we have
$x \in X_s \subset U$ because $s$ vanishes at points of $Z$.
This implies that $X_s = D(f)$ where
$f \in A$ is the image of $s$ in $A \cong \Gamma(U, \mathcal{L}^{\otimes n})$.
In particular $X_s$ is affine.

\medskip\noindent
Consider the union $W = \bigcup X_s$ over all
$s \in \Gamma(X, \mathcal{L}^{\otimes n})$ for $n \geq 1$
such that $X_s$ is affine. Obviously $W$ is open in $X$.
By the arguments above every closed point of
$X$ is contained in $W$. The closed subset $X \setminus W$ of $X$
is also quasi-compact
(see Topology, Lemma \ref{topology-lemma-closed-in-quasi-compact}).
Hence it has a closed point if it is nonempty (see
Topology, Lemma \ref{topology-lemma-quasi-compact-closed-point}).
This would contradict the fact that all closed points are in
$W$. Hence we conclude $X = W$. This means that $\mathcal{L}$
is ample by Properties, Definition \ref{properties-definition-ample}.
\end{proof}

\noindent
There is a variant of Lemma \ref{lemma-quasi-compact-h1-zero-invertible}
with finite type ideal sheaves which we will formulate and prove here if
we ever need it.












\section{Quasi-coherence of higher direct images}
\label{section-quasi-coherence}

\noindent
We have seen that the higher cohomology groups of a quasi-coherent module on
an affine is zero. For (quasi-)separated quasi-compact schemes $X$ this implies
vanishing of cohomology groups of quasi-coherent sheaves beyond a certain
degree. However, it may not be the case that $X$ has finite cohomological
dimension, because that is defined in terms of vanishing of cohomology
of {\it all} $\mathcal{O}_X$-modules.

\begin{lemma}
\label{lemma-induction-principle}
Let $X$ be a quasi-compact and quasi-separated scheme. Let $P$ be a property
of the quasi-compact opens of $X$. Assume that
\begin{enumerate}
\item $P$ holds for every affine open of $X$,
\item if $U$ is quasi-compact open, $V$ affine open,
$P$ holds for $U$, $V$, and $U \cap V$, then
$P$ holds for $U \cup V$.
\end{enumerate}
Then $P$ holds for every quasi-compact open of $X$
and in particular for $X$.
\end{lemma}

\begin{proof}
First we argue by induction that $P$ holds for {\it separated} quasi-compact
opens $W \subset X$. Namely, such an open can be written as
$W = U_1 \cup \ldots \cup U_n$ and we can do induction on $n$ using
property (2) with $U = U_1 \cup \ldots \cup U_{n - 1}$ and $V = U_n$.
This is allowed because
$U \cap V = (U_1 \cap U_n) \cup \ldots \cup (U_{n - 1} \cap U_n)$
is also a union of $n - 1$ affine open subschemes by
Schemes, Lemma \ref{schemes-lemma-characterize-separated}
applied to the affine opens $U_i$ and $U_n$ of $W$.
Having said this, for any quasi-compact open $W \subset X$ we can
do induction on the number of affine opens needed to cover $W$
using the same trick as before and using that the quasi-compact open
$U_i \cap U_n$ is separated as an open subscheme of the affine scheme $U_n$.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-nr-affines}
Let $X$ be a quasi-compact scheme with affine diagonal (for example
if $X$ is separated).
Let $t = t(X)$ be the minimal number of affine opens needed to
cover $X$. Then $H^n(X, \mathcal{F}) = 0$ for all $n \geq t$ and all
quasi-coherent sheaves $\mathcal{F}$.
\end{lemma}

\begin{proof}
First proof.
By induction on $t$.
If $t = 1$ the result follows from
Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}.
If $t > 1$ write $X = U \cup V$ with $V$ affine open and
$U = U_1 \cup \ldots \cup U_{t - 1}$ a union of $t - 1$ open affines.
Note that in this case
$U \cap V =  (U_1 \cap V) \cup \ldots (U_{t - 1} \cap V)$
is also a union of $t - 1$ affine open subschemes.
Namely, since the diagonal is affine, the intersection of two
affine opens is affine, see Lemma \ref{lemma-affine-diagonal}.
We apply the Mayer-Vietoris long exact sequence
$$
0 \to
H^0(X, \mathcal{F}) \to
H^0(U, \mathcal{F}) \oplus H^0(V, \mathcal{F}) \to
H^0(U \cap V, \mathcal{F}) \to
H^1(X, \mathcal{F}) \to \ldots
$$
see Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris}.
By induction we see that the groups $H^i(U, \mathcal{F})$,
$H^i(V, \mathcal{F})$, $H^i(U \cap V, \mathcal{F})$ are zero for
$i \geq t - 1$. It follows immediately that $H^i(X, \mathcal{F})$
is zero for $i \geq t$.

\medskip\noindent
Second proof.
Let $\mathcal{U} : X = \bigcup_{i = 1}^t U_i$ be a finite affine open
covering. Since $X$ is has affine diagonal the multiple intersections
$U_{i_0 \ldots i_p}$ are all affine, see
Lemma \ref{lemma-affine-diagonal}.
By Lemma \ref{lemma-cech-cohomology-quasi-coherent} the {\v C}ech
cohomology groups $\check{H}^p(\mathcal{U}, \mathcal{F})$
agree with the cohomology groups. By
Cohomology, Lemma \ref{cohomology-lemma-alternating-usual}
the {\v C}ech cohomology groups may be computed using the alternating
{\v C}ech complex $\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F})$.
As the covering consists of $t$ elements we see immediately
that $\check{\mathcal{C}}_{alt}^p(\mathcal{U}, \mathcal{F}) = 0$
for all $p \geq t$. Hence the result follows.
\end{proof}

\begin{lemma}
\label{lemma-affine-diagonal-universal-delta-functor}
Let $X$ be a quasi-compact scheme with affine diagonal
(for example if $X$ is separated). Then
\begin{enumerate}
\item given a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
there exists an embedding $\mathcal{F} \to \mathcal{F}'$ of
quasi-coherent $\mathcal{O}_X$-modules
such that $H^p(X, \mathcal{F}') = 0$ for all $p \geq 1$, and
\item $\{H^n(X, -)\}_{n \geq 0}$
is a universal $\delta$-functor from $\QCoh(\mathcal{O}_X)$ to
$\textit{Ab}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X = \bigcup U_i$ be an affine open covering.
Set $U = \coprod U_i$ and denote $f : U \to X$
the morphism inducing the given open immersions $U_i \to X$.
For every $\mathcal{O}_X$-module $\mathcal{F}$ there is
a canonical map $\mathcal{F} \to j_*j^*\mathcal{F}$.
This map is injective as can be seen by checking on stalks:
if $x \in U_i$, then we have a factorization
$$
\mathcal{F}_x \to (j_*j^*\mathcal{F})_x
\to (j^*\mathcal{F})_{x'} = \mathcal{F}_x
$$
where $x' \in U$ is the point $x$ viewed as a point of $U_i \subset U$.
Now if $\mathcal{F}$ is quasi-coherent, then $j^*\mathcal{F}$
is quasi-coherent on the affine scheme $U$ hence has vanishing
higher cohomology. Then $H^p(X, j_*j^*\mathcal{F}) = 0$ for
$p > 0$ by Lemma \ref{lemma-relative-affine-cohomology} as $j$ is affine by
Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}.
This proves (1).
Then $H^p(X, \mathcal{F}) \to H^p(X, j_*j^*\mathcal{F})$
is zero and part (2) follows from
Homology, Lemma \ref{homology-lemma-efface-implies-universal}.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-nr-affines-quasi-separated}
Let $X$ be a quasi-compact quasi-separated scheme.
Let $X = U_1 \cup \ldots \cup U_t$ be an affine open covering.
Set
$$
d = \max\nolimits_{I \subset \{1, \ldots, t\}}
\left(|I| + t(\bigcap\nolimits_{i \in I} U_i)\right)
$$
where $t(U)$ is the minimal number of affines needed to cover
the scheme $U$. Then $H^n(X, \mathcal{F}) = 0$ for all $n \geq d$ and all
quasi-coherent sheaves $\mathcal{F}$.
\end{lemma}

\begin{proof}
Note that since $X$ is quasi-separated the numbers
$t(\bigcap_{i \in I} U_i)$ are finite.
Let $\mathcal{U} : X = \bigcup_{i = 1}^t U_i$.
By
Cohomology, Lemma \ref{cohomology-lemma-cech-spectral-sequence}
there is a spectral sequence
$$
E_2^{p, q} = \check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F}))
$$
converging to $H^{p + q}(U, \mathcal{F})$. By
Cohomology, Lemma \ref{cohomology-lemma-alternating-usual}
we have
$$
E_2^{p, q} =
H^p(\check{\mathcal{C}}_{alt}^\bullet(
\mathcal{U}, \underline{H}^q(\mathcal{F}))
$$
The alternating {\v C}ech complex with values in the presheaf
$\underline{H}^q(\mathcal{F})$ vanishes in high degrees by
Lemma \ref{lemma-vanishing-nr-affines},
more precisely $E_2^{p, q} = 0$ for $p + q \geq d$.
Hence the result follows.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-higher-direct-images}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is quasi-separated and quasi-compact.
\begin{enumerate}
\item For any quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the
higher direct images $R^pf_*\mathcal{F}$ are quasi-coherent on $S$.
\item If $S$ is quasi-compact, there exists an integer $n = n(X, S, f)$
such that $R^pf_*\mathcal{F} = 0$ for all $p \geq n$ and any
quasi-coherent sheaf $\mathcal{F}$ on $X$.
\item In fact, if $S$ is quasi-compact we can find $n = n(X, S, f)$
such that for every
morphism of schemes $S' \to S$ we have $R^p(f')_*\mathcal{F}' = 0$
for $p \geq n$ and any quasi-coherent sheaf $\mathcal{F}'$
on $X'$. Here $f' : X' = S' \times_S X \to S'$ is the base change of $f$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove (1). Note that under the hypotheses of the lemma the sheaf
$R^0f_*\mathcal{F} = f_*\mathcal{F}$ is quasi-coherent by
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
Using
Cohomology, Lemma \ref{cohomology-lemma-localize-higher-direct-images}
we see that forming higher direct images commutes with restriction
to open subschemes. Since being quasi-coherent is local on $S$ we
may assume $S$ is affine.

\medskip\noindent
Assume $S$ is affine and $f$ quasi-compact and separated.
Let $t \geq 1$ be the minimal number of affine opens needed to cover $X$.
We will prove this case of (1) by induction on $t$.
If $t = 1$ then the morphism $f$ is affine by
Morphisms, Lemma \ref{morphisms-lemma-morphism-affines-affine}
and (1) follows from
Lemma \ref{lemma-relative-affine-vanishing}.
If $t > 1$ write $X = U \cup V$ with $V$ affine open and
$U = U_1 \cup \ldots \cup U_{t - 1}$ a union of $t - 1$ open affines.
Note that in this case
$U \cap V =  (U_1 \cap V) \cup \ldots (U_{t - 1} \cap V)$
is also a union of $t - 1$ affine open subschemes, see
Schemes, Lemma \ref{schemes-lemma-characterize-separated}.
We will apply the relative Mayer-Vietoris sequence
$$
0 \to
f_*\mathcal{F} \to
a_*(\mathcal{F}|_U) \oplus b_*(\mathcal{F}|_V) \to
c_*(\mathcal{F}|_{U \cap V}) \to
R^1f_*\mathcal{F} \to \ldots
$$
see Cohomology, Lemma \ref{cohomology-lemma-relative-mayer-vietoris}.
By induction we see that
$R^pa_*\mathcal{F}$, $R^pb_*\mathcal{F}$ and $R^pc_*\mathcal{F}$
are all quasi-coherent. This implies that each of the sheaves
$R^pf_*\mathcal{F}$ is quasi-coherent since it sits in the middle of a short
exact sequence with a cokernel of a map between quasi-coherent sheaves
on the left and a kernel of a map between quasi-coherent sheaves on the right.
Using the results on quasi-coherent sheaves in
Schemes, Section \ref{schemes-section-quasi-coherent} we see
conclude $R^pf_*\mathcal{F}$ is quasi-coherent.

\medskip\noindent
Assume $S$ is affine and $f$ quasi-compact and quasi-separated.
Let $t \geq 1$ be the minimal number of affine opens needed to cover $X$.
We will prove (1) by induction on $t$.
In case $t = 1$ the morphism $f$ is separated and we are back
in the previous case (see previous paragraph).
If $t > 1$ write $X = U \cup V$ with $V$ affine open and
$U$ a union of $t - 1$ open affines.
Note that in this case $U \cap V$ is an open subscheme of an affine
scheme and hence separated (see
Schemes, Lemma \ref{schemes-lemma-affine-separated}).
We will apply the relative Mayer-Vietoris sequence
$$
0 \to
f_*\mathcal{F} \to
a_*(\mathcal{F}|_U) \oplus b_*(\mathcal{F}|_V) \to
c_*(\mathcal{F}|_{U \cap V}) \to
R^1f_*\mathcal{F} \to \ldots
$$
see Cohomology, Lemma \ref{cohomology-lemma-relative-mayer-vietoris}.
By induction and the result of the previous paragraph we see that
$R^pa_*\mathcal{F}$, $R^pb_*\mathcal{F}$ and $R^pc_*\mathcal{F}$
are quasi-coherent. As in the previous paragraph this implies each of
sheaves $R^pf_*\mathcal{F}$ is quasi-coherent.

\medskip\noindent
Next, we prove (3) and a fortiori (2). Choose a finite affine open
covering $S = \bigcup_{j = 1, \ldots m} S_j$. For each $i$ choose
a finite affine open covering
$f^{-1}(S_j) = \bigcup_{i = 1, \ldots t_j} U_{ji} $.
Let
$$
d_j = \max\nolimits_{I \subset \{1, \ldots, t_j\}}
\left(|I| + t(\bigcap\nolimits_{i \in I} U_{ji})\right)
$$
be the integer found in
Lemma \ref{lemma-vanishing-nr-affines-quasi-separated}.
We claim that $n(X, S, f) = \max d_j$ works.

\medskip\noindent
Namely, let $S' \to S$ be a morphism of schemes and let
$\mathcal{F}'$ be a quasi-coherent sheaf on $X' = S' \times_S X$.
We want to show that $R^pf'_*\mathcal{F}' = 0$ for $p \geq n(X, S, f)$.
Since this question is local on $S'$ we may assume that $S'$ is affine
and maps into $S_j$ for some $j$. Then $X' = S' \times_{S_j} f^{-1}(S_j)$
is covered by the open affines $S' \times_{S_j} U_{ji}$, $i = 1, \ldots t_j$
and the intersections
$$
\bigcap\nolimits_{i \in I} S' \times_{S_j} U_{ji} =
S' \times_{S_j} \bigcap\nolimits_{i \in I} U_{ji}
$$
are covered by the same number of affines as before the base change.
Applying
Lemma \ref{lemma-vanishing-nr-affines-quasi-separated}
we get $H^p(X', \mathcal{F}') = 0$. By the first part of the proof
we already know that each $R^qf'_*\mathcal{F}'$ is quasi-coherent
hence has vanishing higher cohomology groups on our affine scheme $S'$,
thus we see that $H^0(S', R^pf'_*\mathcal{F}') = H^p(X', \mathcal{F}') = 0$
by Cohomology, Lemma \ref{cohomology-lemma-apply-Leray}.
Since $R^pf'_*\mathcal{F}'$ is quasi-coherent
we conclude that $R^pf'_*\mathcal{F}' = 0$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-higher-direct-images-application}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is quasi-separated and quasi-compact.
Assume $S$ is affine.
For any quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
we have
$$
H^q(X, \mathcal{F}) = H^0(S, R^qf_*\mathcal{F})
$$
for all $q \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the Leray spectral sequence $E_2^{p, q} = H^p(S, R^qf_*\mathcal{F})$
converging to $H^{p + q}(X, \mathcal{F})$, see
Cohomology, Lemma \ref{cohomology-lemma-Leray}.
By Lemma \ref{lemma-quasi-coherence-higher-direct-images}
we see that the sheaves $R^qf_*\mathcal{F}$ are quasi-coherent.
By Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}
we see that $E_2^{p, q} = 0$ when $p > 0$.
Hence the spectral sequence degenerates at $E_2$ and we win.
See also
Cohomology, Lemma \ref{cohomology-lemma-apply-Leray} (2)
for the general principle.
\end{proof}








\section{Cohomology and base change, I}
\label{section-cohomology-and-base-change}

\noindent
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Suppose further that $g : S' \to S$ is any morphism of schemes. Denote
$X' = X_{S'} = S' \times_S X$ the base change of $X$ and denote
$f' : X' \to S'$ the base change of $f$.
Also write $g' : X' \to X$ the projection,
and set $\mathcal{F}' = (g')^*\mathcal{F}$.
Here is a diagram representing the situation:
\begin{equation}
\label{equation-base-change-diagram}
\vcenter{
\xymatrix{
\mathcal{F}' = (g')^*\mathcal{F} &
X' \ar[r]_{g'} \ar[d]_{f'} &
X \ar[d]^f &
\mathcal{F} \\
Rf'_*\mathcal{F}' &
S' \ar[r]^g &
S &
Rf_*\mathcal{F}
}
}
\end{equation}
Here is the simplest case of the base change property we have in mind.

\begin{lemma}
\label{lemma-affine-base-change}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume $f$ is affine.
In this case $f_*\mathcal{F} \cong Rf_*\mathcal{F}$ is
a quasi-coherent sheaf, and for every base change diagram
(\ref{equation-base-change-diagram})
we have
$$
g^*f_*\mathcal{F} = f'_*(g')^*\mathcal{F}.
$$
\end{lemma}

\begin{proof}
The vanishing of higher direct images is
Lemma \ref{lemma-relative-affine-vanishing}.
The statement is local on $S$ and $S'$. Hence we may
assume $X = \Spec(A)$, $S = \Spec(R)$,
$S' = \Spec(R')$ and $\mathcal{F} = \widetilde{M}$
for some $A$-module $M$.
We use Schemes, Lemma \ref{schemes-lemma-widetilde-pullback}
to describe pullbacks and pushforwards of $\mathcal{F}$.
Namely, $X' = \Spec(R' \otimes_R A)$ and
$\mathcal{F}'$ is the quasi-coherent sheaf associated
to $(R' \otimes_R A) \otimes_A M$.
Thus we see that the lemma boils down to the
equality
$$
(R' \otimes_R A) \otimes_A M = R' \otimes_R M
$$
as $R'$-modules.
\end{proof}

\noindent
In many situations it is sufficient to know about the following
special case of cohomology and base change. It follows immediately
from the stronger results in
Section \ref{section-cohomology-and-base-change-derived},
but since it is so important it deserves its own proof.

\begin{lemma}[Flat base change]
\label{lemma-flat-base-change-cohomology}
Consider a cartesian diagram of schemes
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
with pullback $\mathcal{F}' = (g')^*\mathcal{F}$.
Assume that $g$ is flat and that $f$ is quasi-compact and quasi-separated.
For any $i \geq 0$
\begin{enumerate}
\item the base change map of
Cohomology, Lemma \ref{cohomology-lemma-base-change-map-flat-case}
is an isomorphism
$$
g^*R^if_*\mathcal{F} \longrightarrow R^if'_*\mathcal{F}',
$$
\item if $S = \Spec(A)$ and $S' = \Spec(B)$, then
$H^i(X, \mathcal{F}) \otimes_A B = H^i(X', \mathcal{F}')$.
\end{enumerate}
\end{lemma}

\begin{proof}
We claim that part (1) follows from part (2). Namely,
part (1) is local on $S'$ and hence we may assume $S$
and $S'$ are affine. In other words, we have $S = \Spec(A)$
and $S' = \Spec(B)$ as in (2).
Then since $R^if_*\mathcal{F}$ is quasi-coherent
(Lemma \ref{lemma-quasi-coherence-higher-direct-images}),
it is the quasi-coherent $\mathcal{O}_S$-module associated to the
$A$-module $H^0(S, R^if_*\mathcal{F}) = H^i(X, \mathcal{F})$
(equality by
Lemma \ref{lemma-quasi-coherence-higher-direct-images-application}).
Similarly, $R^if'_*\mathcal{F}'$ is the quasi-coherent
$\mathcal{O}_{S'}$-module associated to the $B$-module
$H^i(X', \mathcal{F}')$. Since pullback by $g$ corresponds
to $- \otimes_A B$ on modules
(Schemes, Lemma \ref{schemes-lemma-widetilde-pullback})
we see that it suffices to prove (1).

\medskip\noindent
Let $A \to B$ be a flat ring homomorphism.
Let $X$ be a quasi-compact and quasi-separated scheme over $A$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Set $X_B = X \times_{\Spec(A)} \Spec(B)$ and denote
$\mathcal{F}_B$ the pullback of $\mathcal{F}$.
We are trying to show that the map
$$
H^i(X, \mathcal{F}) \otimes_A B \longrightarrow H^i(X_B, \mathcal{F}_B)
$$
(given by the reference in the statement of the lemma)
is an isomorphism where $X_B = \Spec(B) \times_{\Spec(A)} X$ and
$\mathcal{F}_B$ is the pullback of $\mathcal{F}$ to $X_B$.

\medskip\noindent
In case $X$ is separated, choose an affine open covering
$\mathcal{U} : X = U_1 \cup \ldots \cup U_t$ and recall that
$$
\check{H}^p(\mathcal{U}, \mathcal{F}) = H^p(X, \mathcal{F}),
$$
see
Lemma \ref{lemma-cech-cohomology-quasi-coherent}.
If $\mathcal{U}_B : X_B = (U_1)_B \cup \ldots \cup (U_t)_B$ we obtain
by base change, then it is still the case that each $(U_i)_B$ is affine
and that $X_B$ is separated. Thus we obtain
$$
\check{H}^p(\mathcal{U}_B, \mathcal{F}_B) = H^p(X_B, \mathcal{F}_B).
$$
We have the following relation between the {\v C}ech complexes
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}_B, \mathcal{F}_B) =
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \otimes_A B
$$
as follows from
Lemma \ref{lemma-affine-base-change}.
Since $A \to B$ is flat, the same thing remains true on taking cohomology.

\medskip\noindent
In case $X$ is quasi-separated, choose an affine open covering
$\mathcal{U} : X = U_1 \cup \ldots \cup U_t$. We will use the
{\v C}ech-to-cohomology spectral sequence
Cohomology, Lemma \ref{cohomology-lemma-cech-spectral-sequence}.
The reader who wishes to avoid this spectral sequence
can use Mayer-Vietoris and induction on $t$ as in the proof of
Lemma \ref{lemma-quasi-coherence-higher-direct-images}.
The spectral sequence has $E_2$-page
$E_2^{p, q} = \check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F}))$
and converges to $H^{p + q}(X, \mathcal{F})$.
Similarly, we have a spectral sequence with $E_2$-page
$E_2^{p, q} = \check{H}^p(\mathcal{U}_B, \underline{H}^q(\mathcal{F}_B))$
which converges to $H^{p + q}(X_B, \mathcal{F}_B)$.
Since the intersections $U_{i_0 \ldots i_p}$ are quasi-compact
and separated, the result of the second paragraph of the proof gives
$\check{H}^p(\mathcal{U}_B, \underline{H}^q(\mathcal{F}_B)) =
\check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F})) \otimes_A B$.
Using that $A \to B$ is flat we conclude that
$H^i(X, \mathcal{F}) \otimes_A B \to H^i(X_B, \mathcal{F}_B)$
is an isomorphism for all $i$ and we win.
\end{proof}

\begin{lemma}[Finite locally free base change]
\label{lemma-finite-locally-free-base-change-cohomology}
Consider a cartesian diagram of schemes
$$
\xymatrix{
Y \ar[d]_{g} \ar[r]_h & X \ar[d]^f \\
\Spec(B) \ar[r] & \Spec(A)
}
$$
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
with pullback $\mathcal{G} = h^*\mathcal{F}$.
If $B$ is a finite locally free $A$-module, then
$H^i(X, \mathcal{F}) \otimes_A B = H^i(Y, \mathcal{G})$.
\end{lemma}

\noindent
{\bf Warning}: Do not use this lemma unless you understand the difference
between this and Lemma \ref{lemma-flat-base-change-cohomology}.

\begin{proof}
In case $X$ is separated, choose an affine open covering
$\mathcal{U} : X = \bigcup_{i \in I} U_i$ and recall that
$$
\check{H}^p(\mathcal{U}, \mathcal{F}) = H^p(X, \mathcal{F}),
$$
see
Lemma \ref{lemma-cech-cohomology-quasi-coherent}.
Let $\mathcal{V} : Y = \bigcup_{i \in I} g^{-1}(U_i)$
be the corresponding affine open covering of $Y$.
The opens $V_i = g^{-1}(U_i) = U_i \times_{\Spec(A)} \Spec(B)$
are affine and $Y$ is separated. Thus we obtain
$$
\check{H}^p(\mathcal{V}, \mathcal{G}) = H^p(Y, \mathcal{G}).
$$
We claim the map of {\v C}ech complexes
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \otimes_A B
\longrightarrow
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{G})
$$
is an isomorphism. Namely, as $B$ is finitely presented as an $A$-module
we see that tensoring with $B$ over $A$ commutes with products, see
Algebra, Proposition \ref{algebra-proposition-fp-tensor}.
Thus it suffices to show that the maps
$\Gamma(U_{i_0 \ldots i_p}, \mathcal{F}) \otimes_A B \to
\Gamma(V_{i_0 \ldots i_p}, \mathcal{G})$ 
are isomorphisms which follows from
Lemma \ref{lemma-affine-base-change}.
Since $A \to B$ is flat, the same thing remains true on taking cohomology.

\medskip\noindent
In the general case we argue in exactly the same way using affine
open covering $\mathcal{U} : X = \bigcup_{i \in I} U_i$ and the
corresponding covering $\mathcal{V} : Y = \bigcup_{i \in I} V_i$
with $V_i = g^{-1}(U_i)$ as above. We will use the
{\v C}ech-to-cohomology spectral sequence
Cohomology, Lemma \ref{cohomology-lemma-cech-spectral-sequence}.
The spectral sequence has $E_2$-page
$E_2^{p, q} = \check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F}))$
and converges to $H^{p + q}(X, \mathcal{F})$.
Similarly, we have a spectral sequence with $E_2$-page
$E_2^{p, q} = \check{H}^p(\mathcal{V}, \underline{H}^q(\mathcal{G}))$
which converges to $H^{p + q}(Y, \mathcal{G})$.
Since the intersections $U_{i_0 \ldots i_p}$ are separated, the result
of the previous paragraph gives isomorphisms
$\Gamma(U_{i_0 \ldots i_p}, \underline{H}^q(\mathcal{F})) \otimes_A B
\to \Gamma(V_{i_0 \ldots i_p}, \underline{H}^q(\mathcal{G}))$.
Using that $- \otimes_A B$ commutes with products and is exact, we conclude
that
$\check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F})) \otimes_A B
\to \check{H}^p(\mathcal{V}, \underline{H}^q(\mathcal{G}))$
is an isomorphism. Using that $A \to B$ is flat we conclude that
$H^i(X, \mathcal{F}) \otimes_A B \to H^i(Y, \mathcal{G})$
is an isomorphism for all $i$ and we win.
\end{proof}









\section{Colimits and higher direct images}
\label{section-colimits}

\noindent
General results of this nature can be found in
Cohomology, Section \ref{cohomology-section-limits},
Sheaves, Lemma \ref{sheaves-lemma-directed-colimits-sections}, and
Modules, Lemma \ref{modules-lemma-finite-presentation-quasi-compact-colimit}.

\begin{lemma}
\label{lemma-colimit-cohomology}
Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of schemes.
Let $\mathcal{F} = \colim \mathcal{F}_i$ be a filtered colimit
of quasi-coherent sheaves on $X$.
Then for any $p \geq 0$ we have
$$
R^pf_*\mathcal{F} = \colim R^pf_*\mathcal{F}_i.
$$
\end{lemma}

\begin{proof}
Recall that $R^pf_*\mathcal{F}$ is the sheaf associated to
$U \mapsto H^p(f^{-1}U, \mathcal{F})$, see
Cohomology, Lemma \ref{cohomology-lemma-describe-higher-direct-images}.
Recall that the colimit is the sheaf associated to the presheaf colimit
(taking colimits over opens). Hence we can apply
Cohomology, Lemma \ref{cohomology-lemma-quasi-separated-cohomology-colimit}
to $H^p(f^{-1}U, -)$ where $U$ is affine to conclude. (Because the
basis of affine opens in $f^{-1}U$ satisfies the assumptions of that
lemma.)
\end{proof}










\section{Cohomology and base change, II}
\label{section-cohomology-and-base-change-derived}

\noindent
Let $f : X \to S$ be a morphism of schemes and let $\mathcal{F}$
be a quasi-coherent $\mathcal{O}_X$-module. If $f$ is quasi-compact
and quasi-separated we would like to represent $Rf_*\mathcal{F}$
by a complex of quasi-coherent sheaves on $S$. This follows
from the fact that the sheaves $R^if_*\mathcal{F}$ are quasi-coherent
if $S$ is quasi-compact and has affine diagonal,
using that $D_\QCoh(S)$ is equivalent to
$D(\QCoh(\mathcal{O}_S))$, see
Derived Categories of Schemes, Proposition
\ref{perfect-proposition-quasi-compact-affine-diagonal}.

\medskip\noindent
In this section we will use a different approach which produces an
explicit complex having a good base change property. The construction
is particularly easy if $f$ and $S$ are separated, or more generally
have affine diagonal. Since this is the case which
by far the most often used we treat it separately.

\begin{lemma}
\label{lemma-separated-case-relative-cech}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume $X$ is quasi-compact and $X$ and $S$ have affine diagonal
(e.g., if $X$ and $S$ are separated).
In this case we can compute $Rf_*\mathcal{F}$ as follows:
\begin{enumerate}
\item Choose a finite affine open covering
$\mathcal{U} : X = \bigcup_{i = 1, \ldots, n} U_i$.
\item For $i_0, \ldots, i_p \in \{1, \ldots, n\}$ denote
$f_{i_0 \ldots i_p} : U_{i_0 \ldots i_p} \to S$ the restriction of $f$
to the intersection $U_{i_0 \ldots i_p} = U_{i_0} \cap \ldots \cap U_{i_p}$.
\item Set $\mathcal{F}_{i_0 \ldots i_p}$ equal to the restriction
of $\mathcal{F}$ to $U_{i_0 \ldots i_p}$.
\item Set
$$
\check{\mathcal{C}}^p(\mathcal{U}, f, \mathcal{F}) =
\bigoplus\nolimits_{i_0 \ldots i_p}
f_{i_0 \ldots i_p *} \mathcal{F}_{i_0 \ldots i_p}
$$
and define differentials
$d : \check{\mathcal{C}}^p(\mathcal{U}, f, \mathcal{F})
\to \check{\mathcal{C}}^{p + 1}(\mathcal{U}, f, \mathcal{F})$
as in Cohomology, Equation (\ref{cohomology-equation-d-cech}).
\end{enumerate}
Then the complex $\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})$
is a complex of quasi-coherent sheaves on $S$ which comes equipped with an
isomorphism
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
\longrightarrow
Rf_*\mathcal{F}
$$
in $D^{+}(S)$. This isomorphism is functorial in the quasi-coherent
sheaf $\mathcal{F}$.
\end{lemma}

\begin{proof}
Consider the resolution
$\mathcal{F} \to {\mathfrak C}^\bullet(\mathcal{U}, \mathcal{F})$
of Cohomology, Lemma \ref{cohomology-lemma-covering-resolution}.
We have an equality of complexes
$\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F}) =
f_*{\mathfrak C}^\bullet(\mathcal{U}, \mathcal{F})$
of quasi-coherent $\mathcal{O}_S$-modules.
The morphisms $j_{i_0 \ldots i_p} : U_{i_0 \ldots i_p} \to X$
and the morphisms $f_{i_0 \ldots i_p} : U_{i_0 \ldots i_p} \to S$
are affine by Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}
and Lemma \ref{lemma-affine-diagonal}.
Hence $R^qj_{i_0 \ldots i_p *}\mathcal{F}_{i_0 \ldots i_p}$
as well as $R^qf_{i_0 \ldots i_p *}\mathcal{F}_{i_0 \ldots i_p}$
are zero for $q > 0$ (Lemma \ref{lemma-relative-affine-vanishing}).
Using $f \circ j_{i_0 \ldots i_p} = f_{i_0 \ldots i_p}$ and
the spectral sequence of
Cohomology, Lemma \ref{cohomology-lemma-relative-Leray}
we conclude that
$R^qf_*(j_{i_0 \ldots i_p *}\mathcal{F}_{i_0 \ldots i_p}) = 0$
for $q > 0$.
Since the terms of the complex
${\mathfrak C}^\bullet(\mathcal{U}, \mathcal{F})$ are finite direct
sums of the sheaves $j_{i_0 \ldots i_p *}\mathcal{F}_{i_0 \ldots i_p}$
we conclude using Leray's acyclicity lemma
(Derived Categories, Lemma \ref{derived-lemma-leray-acyclicity})
that
$$
Rf_* \mathcal{F} = f_*{\mathfrak C}^\bullet(\mathcal{U}, \mathcal{F}) =
\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
$$
as desired.
\end{proof}

\noindent
Next, we are going to consider what happens if we do a base change.

\begin{lemma}
\label{lemma-base-change-complex}
With notation as in diagram (\ref{equation-base-change-diagram}).
Assume $f : X \to S$ and $\mathcal{F}$ satisfy the hypotheses of
Lemma \ref{lemma-separated-case-relative-cech}. Choose a finite
affine open covering $\mathcal{U} : X = \bigcup U_i$ of $X$.
There is a canonical isomorphism
$$
g^*\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
\longrightarrow
Rf'_*\mathcal{F}'
$$
in $D^{+}(S')$. Moreover, if $S' \to S$ is affine, then in fact
$$
g^*\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
=
\check{\mathcal{C}}^\bullet(\mathcal{U}', f', \mathcal{F}')
$$
with $\mathcal{U}' : X' = \bigcup U_i'$ where
$U_i' = (g')^{-1}(U_i) = U_{i, S'}$ is also affine.
\end{lemma}

\begin{proof}
In fact we may define $U_i' = (g')^{-1}(U_i) = U_{i, S'}$ no matter
whether $S'$ is affine over $S$ or not.
Let $\mathcal{U}' : X' = \bigcup U_i'$ be the induced covering of $X'$.
In this case we claim that
$$
g^*\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
=
\check{\mathcal{C}}^\bullet(\mathcal{U}', f', \mathcal{F}')
$$
with $\check{\mathcal{C}}^\bullet(\mathcal{U}', f', \mathcal{F}')$
defined in exactly the same manner as in
Lemma \ref{lemma-separated-case-relative-cech}.
This is clear from the case of affine morphisms
(Lemma \ref{lemma-affine-base-change}) by working locally on $S'$.
Moreover, exactly as in the proof of
Lemma \ref{lemma-separated-case-relative-cech}
one sees that there is an isomorphism
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}', f', \mathcal{F}')
\longrightarrow
Rf'_*\mathcal{F}'
$$
in $D^{+}(S')$ since the morphisms $U_i' \to X'$ and $U_i' \to S'$
are still affine (being base changes of affine morphisms).
Details omitted.
\end{proof}

\noindent
The lemma above says that the complex
$$
\mathcal{K}^\bullet = \check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})
$$
is a bounded below complex of quasi-coherent sheaves on $S$ which
{\it universally} computes the higher direct images of $f : X \to S$.
This is something about this particular complex and
it is not preserved by replacing
$\check{\mathcal{C}}^\bullet(\mathcal{U}, f, \mathcal{F})$ by
a quasi-isomorphic complex in general! In other words, this is
not a statement that makes sense in the derived category.
The reason is that the pullback $g^*\mathcal{K}^\bullet$ is
{\it not} equal to the derived pullback $Lg^*\mathcal{K}^\bullet$
of $\mathcal{K}^\bullet$ in general!

\medskip\noindent
Here is a more general case where we can prove this statement.
We remark that the condition of $S$ being separated is harmless
in most applications, since this is usually used to prove some
local property of the total derived image.
The proof is significantly more involved and uses hypercoverings;
it is a nice example of how you can use them sometimes.

\begin{lemma}
\label{lemma-hypercoverings}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume that $f$ is quasi-compact and quasi-separated and
that $S$ is quasi-compact and separated.
There exists a bounded below complex $\mathcal{K}^\bullet$
of quasi-coherent $\mathcal{O}_S$-modules with the
following property: For every morphism
$g : S' \to S$ the complex $g^*\mathcal{K}^\bullet$ is
a representative for $Rf'_*\mathcal{F}'$ with notation as in
diagram (\ref{equation-base-change-diagram}).
\end{lemma}

\begin{proof}
(If $f$ is separated as well, please see
Lemma \ref{lemma-base-change-complex}.)
The assumptions imply in particular that $X$
is quasi-compact and quasi-separated as a scheme.
Let $\mathcal{B}$ be the set of affine opens of $X$. By
Hypercoverings,
Lemma \ref{hypercovering-lemma-quasi-separated-quasi-compact-hypercovering}
we can find a hypercovering $K = (I, \{U_i\})$ such that each
$I_n$ is finite and each $U_i$ is an affine open of $X$. By
Hypercoverings, Lemma \ref{hypercovering-lemma-cech-spectral-sequence}
there is a spectral sequence with $E_2$-page
$$
E_2^{p, q} = \check{H}^p(K, \underline{H}^q(\mathcal{F}))
$$
converging to $H^{p + q}(X, \mathcal{F})$. Note that
$\check{H}^p(K, \underline{H}^q(\mathcal{F}))$ is the $p$th cohomology
group of the complex
$$
\prod\nolimits_{i \in I_0} H^q(U_i, \mathcal{F})
\to
\prod\nolimits_{i \in I_1} H^q(U_i, \mathcal{F})
\to
\prod\nolimits_{i \in I_2} H^q(U_i, \mathcal{F})
\to \ldots
$$
Since each $U_i$ is affine we see that this is zero unless $q = 0$
in which case we obtain
$$
\prod\nolimits_{i \in I_0} \mathcal{F}(U_i)
\to
\prod\nolimits_{i \in I_1} \mathcal{F}(U_i)
\to
\prod\nolimits_{i \in I_2} \mathcal{F}(U_i)
\to \ldots
$$
Thus we conclude that $R\Gamma(X, \mathcal{F})$ is computed by
this complex.

\medskip\noindent
For any $n$ and $i \in I_n$ denote $f_i : U_i \to S$ the restriction of
$f$ to $U_i$. As $S$ is separated and $U_i$ is affine this morphism
is affine. Consider the complex of quasi-coherent sheaves
$$
\mathcal{K}^\bullet = (
\prod\nolimits_{i \in I_0} f_{i, *}\mathcal{F}|_{U_i}
\to
\prod\nolimits_{i \in I_1} f_{i, *}\mathcal{F}|_{U_i}
\to
\prod\nolimits_{i \in I_2} f_{i, *}\mathcal{F}|_{U_i}
\to \ldots )
$$
on $S$. As in
Hypercoverings, Lemma \ref{hypercovering-lemma-cech-spectral-sequence}
we obtain a map $\mathcal{K}^\bullet \to Rf_*\mathcal{F}$ in
$D(\mathcal{O}_S)$ by choosing an injective resolution of $\mathcal{F}$
(details omitted). Consider any affine scheme $V$ and a morphism
$g : V \to S$. Then the base change $X_V$ has a hypercovering
$K_V = (I, \{U_{i, V}\})$ obtained by base change. Moreover,
$g^*f_{i, *}\mathcal{F} = f_{i, V, *}(g')^*\mathcal{F}|_{U_{i, V}}$.
Thus the arguments above prove that $\Gamma(V, g^*\mathcal{K}^\bullet)$
computes $R\Gamma(X_V, (g')^*\mathcal{F})$.
This finishes the proof of the lemma as it suffices to prove
the equality of complexes Zariski locally on $S'$.
\end{proof}






\section{Cohomology of projective space}
\label{section-cohomology-projective-space}

\noindent
In this section we compute the cohomology of the twists of the
structure sheaf on $\mathbf{P}^n_S$ over a scheme $S$.
Recall that $\mathbf{P}^n_S$ was defined as the fibre product
$
\mathbf{P}^n_S = S \times_{\Spec(\mathbf{Z})} \mathbf{P}^n_{\mathbf{Z}}
$
in Constructions, Definition \ref{constructions-definition-projective-space}.
It was shown to be equal to
$$
\mathbf{P}^n_S = \underline{\text{Proj}}_S(\mathcal{O}_S[T_0, \ldots, T_n])
$$
in Constructions, Lemma \ref{constructions-lemma-projective-space-bundle}.
In particular, projective space is a particular case of a projective bundle.
If $S = \Spec(R)$ is affine then we have
$$
\mathbf{P}^n_S = \mathbf{P}^n_R = \text{Proj}(R[T_0, \ldots, T_n]).
$$
All these identifications are compatible and compatible with the constructions
of the twisted structure sheaves $\mathcal{O}_{\mathbf{P}^n_S}(d)$.

\medskip\noindent
Before we state the result we need some notation.
Let $R$ be a ring.
Recall that $R[T_0, \ldots, T_n]$ is a graded
$R$-algebra where each $T_i$ is homogeneous of degree $1$.
Denote $(R[T_0, \ldots, T_n])_d$ the degree $d$ summand.
It is a finite free $R$-module of rank $\binom{n + d}{d}$
when $d \geq 0$ and zero else.
It has a basis consisting of monomials $T_0^{e_0} \ldots T_n^{e_n}$
with $\sum e_i = d$. We will also use the following notation:
$R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]$ denotes the $\mathbf{Z}$-graded
ring with $\frac{1}{T_i}$ in degree $-1$. In particular the
$\mathbf{Z}$-graded $R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]$ module
$$
\frac{1}{T_0 \ldots T_n} R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]
$$
which shows up in the statement below is zero in degrees
$\geq -n$, is free on the generator $\frac{1}{T_0 \ldots T_n}$
in degree $-n - 1$ and is free of rank $(-1)^n\binom{n + d}{d}$ for
$d \leq -n - 1$.

\begin{lemma}
\label{lemma-cohomology-projective-space-over-ring}
Let $R$ be a ring.
Let $n \geq 0$ be an integer.
We have
$$
H^q(\mathbf{P}^n, \mathcal{O}_{\mathbf{P}^n_R}(d)) =
\left\{
\begin{matrix}
(R[T_0, \ldots, T_n])_d & \text{if} & q = 0 \\
0 & \text{if} & q \not = 0, n \\
\left(\frac{1}{T_0 \ldots T_n} R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]\right)_d
& \text{if} & q = n
\end{matrix}
\right.
$$
as $R$-modules.
\end{lemma}

\begin{proof}
We will use the standard affine open covering
$$
\mathcal{U} : \mathbf{P}^n_R = \bigcup\nolimits_{i = 0}^n D_{+}(T_i)
$$
to compute the cohomology using the {\v C}ech complex.
This is permissible by Lemma \ref{lemma-cech-cohomology-quasi-coherent}
since any intersection of finitely many affine $D_{+}(T_i)$ is also a
standard affine open (see
Constructions, Section \ref{constructions-section-proj}).
In fact, we can use the alternating or ordered {\v C}ech complex according to
Cohomology, Lemmas \ref{cohomology-lemma-ordered-alternating} and
\ref{cohomology-lemma-alternating-usual}.

\medskip\noindent
The ordering we will use on $\{0, \ldots, n\}$ is the usual one.
Hence the complex we are looking at has terms
$$
\check{\mathcal{C}}_{ord}^p(\mathcal{U}, \mathcal{O}_{\mathbf{P}_R}(d))
=
\bigoplus\nolimits_{i_0 < \ldots < i_p}
(R[T_0, \ldots, T_n, \frac{1}{T_{i_0} \ldots T_{i_p}}])_d
$$
Moreover, the maps are given by the usual formula
$$
d(s)_{i_0 \ldots i_{p + 1}} =
\sum\nolimits_{j = 0}^{p + 1} (-1)^j s_{i_0 \ldots \hat i_j \ldots i_{p + 1}}
$$
see Cohomology, Section \ref{cohomology-section-alternating-cech}.
Note that each term of this complex has a natural
$\mathbf{Z}^{n + 1}$-grading. Namely, we get this by declaring a monomial
$T_0^{e_0} \ldots T_n^{e_n}$ to be homogeneous with weight
$(e_0, \ldots, e_n) \in \mathbf{Z}^{n + 1}$. It is clear that the differential
given above respects the grading. In a formula we have
$$
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U}, \mathcal{O}_{\mathbf{P}_R}(d))
=
\bigoplus\nolimits_{\vec{e} \in \mathbf{Z}^{n + 1}}
\check{\mathcal{C}}^\bullet(\vec{e})
$$
where not all summands on the right hand side occur (see below).
Hence in order to compute the cohomology
modules of the complex it suffices to compute the cohomology of the graded
pieces and take the direct sum at the end.

\medskip\noindent
Fix $\vec{e} = (e_0, \ldots, e_n) \in \mathbf{Z}^{n + 1}$. In order for this
weight to occur in the complex above we need to assume
$e_0 + \ldots + e_n = d$ (if not then it occurs for a different twist of
the structure sheaf of course). Assuming this, set
$$
NEG(\vec{e}) = \{i \in \{0, \ldots, n\} \mid e_i < 0\}.
$$
With this notation the weight $\vec{e}$ summand
$\check{\mathcal{C}}^\bullet(\vec{e})$ of the {\v C}ech complex above has
the following terms
$$
\check{\mathcal{C}}^p(\vec{e})
=
\bigoplus\nolimits_{i_0 < \ldots < i_p,
\ NEG(\vec{e}) \subset \{i_0, \ldots, i_p\}}
R \cdot T_0^{e_0} \ldots T_n^{e_n}
$$
In other words, the terms corresponding to $i_0 < \ldots < i_p$ such
that $NEG(\vec{e})$ is not contained in $\{i_0 \ldots i_p\}$ are zero.
The differential of the complex $\check{\mathcal{C}}^\bullet(\vec{e})$
is still given by the exact same formula as above.

\medskip\noindent
Suppose that $NEG(\vec{e}) = \{0, \ldots, n\}$, i.e., that all
exponents $e_i$ are negative.
In this case the complex $\check{\mathcal{C}}^\bullet(\vec{e})$ has
only one term, namely $\check{\mathcal{C}}^n(\vec{e}) =
R \cdot \frac{1}{T^{-e_0} \ldots T^{-e_n}}$. Hence in this
case
$$
H^q(\check{\mathcal{C}}^\bullet(\vec{e})) =
\left\{
\begin{matrix}
R \cdot \frac{1}{T^{-e_0} \ldots T^{-e_n}} & \text{if} & q = n \\
0 & \text{if} & \text{else}
\end{matrix}
\right.
$$
The direct sum of all of these terms clearly gives the value
$$
\left(\frac{1}{T_0 \ldots T_n} R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]\right)_d
$$
in degree $n$ as stated in the lemma. Moreover these terms do not contribute
to cohomology in other degrees (also in accordance with the statement of the
lemma).

\medskip\noindent
Assume $NEG(\vec{e}) = \emptyset$. In this case the complex
$\check{\mathcal{C}}^\bullet(\vec{e})$ has a summand $R$ corresponding
to all $i_0 < \ldots < i_p$.
Let us compare the complex $\check{\mathcal{C}}^\bullet(\vec{e})$
to another complex. Namely, consider the affine open open covering
$$
\mathcal{V} : \Spec(R) = \bigcup\nolimits_{i \in \{0, \ldots, n\}} V_i
$$
where $V_i = \Spec(R)$ for all $i$. Consider the alternating
{\v C}ech complex
$$
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{V}, \mathcal{O}_{\Spec(R)})
$$
By the same reasoning as above this computes the cohomology of the
structure sheaf on $\Spec(R)$. Hence we see that
$H^p(
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{V}, \mathcal{O}_{\Spec(R)})
) = R$ if $p = 0$ and is $0$ whenever $p > 0$.
For these facts, see
Lemma \ref{lemma-cech-cohomology-quasi-coherent-trivial} and its proof.
Note that also
$\check{\mathcal{C}}_{ord}^\bullet(\mathcal{V}, \mathcal{O}_{\Spec(R)})$
has a summand $R$ for every $i_0 < \ldots < i_p$ and has exactly the same
differential as $\check{\mathcal{C}}^\bullet(\vec{e})$. In other words
these complexes are isomorphic complexes and hence have the same cohomology.
We conclude that
$$
H^q(\check{\mathcal{C}}^\bullet(\vec{e})) =
\left\{
\begin{matrix}
R \cdot T^{e_0} \ldots T^{e_n} & \text{if} & q = 0 \\
0 & \text{if} & \text{else}
\end{matrix}
\right.
$$
in the case that $NEG(\vec{e}) = \emptyset$.
The direct sum of all of these terms clearly gives the value
$$
(R[T_0, \ldots, T_n])_d
$$
in degree $0$ as stated in the lemma. Moreover these terms do not contribute
to cohomology in other degrees (also in accordance with the statement of the
lemma).

\medskip\noindent
To finish the proof of the lemma we have to show that the complexes
$\check{\mathcal{C}}^\bullet(\vec{e})$ are acyclic when
$NEG(\vec{e})$ is neither empty nor equal to $\{0, \ldots, n\}$.
Pick an index $i_{\text{fix}} \not \in NEG(\vec{e})$ (such an index exists).
Consider the map
$$
h :
\check{\mathcal{C}}^{p + 1}(\vec{e})
\to
\check{\mathcal{C}}^p(\vec{e})
$$
given by the rule
$$
h(s)_{i_0 \ldots i_p} = s_{i_{\text{fix}} i_0 \ldots i_p}
$$
(compare with the proof of
Lemma \ref{lemma-cech-cohomology-quasi-coherent-trivial}).
It is clear that this is well defined since
$$
NEG(\vec{e}) \subset \{i_0, \ldots, i_p\}
\Leftrightarrow
NEG(\vec{e}) \subset \{i_{\text{fix}}, i_0, \ldots, i_p\}
$$
Also $\check{\mathcal{C}}^0(\vec{e}) = 0$ so that this
formula does work for all $p$ including $p = - 1$.
The exact same (combinatorial) computation as in the
proof of Lemma \ref{lemma-cech-cohomology-quasi-coherent-trivial}
shows that
$$
(hd + dh)(s)_{i_0 \ldots i_p}
=
s_{i_0 \ldots i_p}
$$
Hence we see that the identity map of the complex
$\check{\mathcal{C}}^\bullet(\vec{e})$ is homotopic to zero
which implies that it is acyclic.
\end{proof}

\noindent
In the following lemma we are going to use the pairing of free
$R$-modules
$$
R[T_0, \ldots, T_n]
\times
\frac{1}{T_0 \ldots T_n} R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]
\longrightarrow
R
$$
which is defined by the rule
$$
(f, g)
\longmapsto
\text{coefficient of }
\frac{1}{T_0 \ldots T_n}
\text{ in }fg.
$$
In other words, the basis element $T_0^{e_0} \ldots T_n^{e_n}$ pairs
with the basis element $T_0^{d_0} \ldots T_n^{d_n}$ to give $1$ if and only
if $e_i + d_i = -1$ for all $i$, and pairs to zero in all other cases.
Using this pairing we get an identification
$$
\left(\frac{1}{T_0 \ldots T_n} R[\frac{1}{T_0}, \ldots, \frac{1}{T_n}]\right)_d
=
\Hom_R((R[T_0, \ldots, T_n])_{-n - 1 - d}, R)
$$
Thus we can reformulate the result of
Lemma \ref{lemma-cohomology-projective-space-over-ring} as saying that
\begin{equation}
\label{equation-identify}
H^q(\mathbf{P}^n, \mathcal{O}_{\mathbf{P}^n_R}(d)) =
\left\{
\begin{matrix}
(R[T_0, \ldots, T_n])_d & \text{if} & q = 0 \\
0 & \text{if} & q \not = 0, n \\
\Hom_R((R[T_0, \ldots, T_n])_{-n - 1 - d}, R)
& \text{if} & q = n
\end{matrix}
\right.
\end{equation}

\begin{lemma}
\label{lemma-identify-functorially}
The identifications of Equation (\ref{equation-identify}) are
compatible with base change w.r.t.\ ring maps $R \to R'$.
Moreover, for any $f \in R[T_0, \ldots, T_n]$ homogeneous
of degree $m$ the map multiplication by $f$
$$
\mathcal{O}_{\mathbf{P}^n_R}(d)
\longrightarrow
\mathcal{O}_{\mathbf{P}^n_R}(d + m)
$$
induces the map on the cohomology group via the identifications
of Equation (\ref{equation-identify}) which is multiplication by
$f$ for $H^0$ and the contragredient of multiplication by $f$
$$
(R[T_0, \ldots, T_n])_{-n - 1 - (d + m)}
\longrightarrow
(R[T_0, \ldots, T_n])_{-n - 1 - d}
$$
on $H^n$.
\end{lemma}

\begin{proof}
Suppose that $R \to R'$ is a ring map.
Let $\mathcal{U}$ be the standard affine open covering of $\mathbf{P}^n_R$,
and let $\mathcal{U}'$ be the standard affine open covering of
$\mathbf{P}^n_{R'}$. Note that $\mathcal{U}'$ is the pullback of the covering
$\mathcal{U}$ under the canonical morphism
$\mathbf{P}^n_{R'} \to \mathbf{P}^n_R$. Hence there
is a map of {\v C}ech complexes
$$
\gamma :
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U},
\mathcal{O}_{\mathbf{P}_R}(d))
\longrightarrow
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U}',
\mathcal{O}_{\mathbf{P}_{R'}}(d))
$$
which is compatible with the map on cohomology by
Cohomology, Lemma \ref{cohomology-lemma-functoriality-cech}.
It is clear from the computations in the proof of
Lemma \ref{lemma-cohomology-projective-space-over-ring}
that this map of {\v C}ech complexes is compatible with the identifications
of the cohomology groups in question. (Namely the basis elements for
the {\v C}ech complex over $R$ simply map to the corresponding basis elements
for the {\v C}ech complex over $R'$.) Whence the first statement of the lemma.

\medskip\noindent
Now fix the ring $R$ and consider two homogeneous polynomials
$f, g \in R[T_0, \ldots, T_n]$ both of the same degree $m$.
Since cohomology is an additive functor, it is clear that the
map induced by multiplication by $f + g$ is the same as the sum
of the maps induced by multiplication by $f$ and the map induced
by multiplication by $g$. Moreover, since cohomology is a functor,
a similar result holds for multiplication by a product $fg$ where
$f, g$ are both homogeneous (but not necessarily of the same degree).
Hence to verify the second statement of the lemma it suffices to
prove this when $f = x \in R$ or when $f = T_i$.
In the case of multiplication by an element $x \in R$ the result
follows since every cohomology groups or complex in sight has the
structure of an $R$-module or complex of $R$-modules.
Finally, we consider the case of multiplication by $T_i$
as a $\mathcal{O}_{\mathbf{P}^n_R}$-linear map
$$
\mathcal{O}_{\mathbf{P}^n_R}(d)
\longrightarrow
\mathcal{O}_{\mathbf{P}^n_R}(d + 1)
$$
The statement on $H^0$ is clear. For the statement on $H^n$
consider multiplication by $T_i$ as a map on {\v C}ech complexes
$$
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U},
\mathcal{O}_{\mathbf{P}_R}(d))
\longrightarrow
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U},
\mathcal{O}_{\mathbf{P}_R}(d + 1))
$$
We are going to use the notation introduced in the proof of
Lemma \ref{lemma-cohomology-projective-space-over-ring}.
We consider the effect of multiplication by $T_i$
in terms of the decompositions
$$
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U}, \mathcal{O}_{\mathbf{P}_R}(d))
=
\bigoplus\nolimits_{\vec{e} \in \mathbf{Z}^{n + 1}, \ \sum e_i = d}
\check{\mathcal{C}}^\bullet(\vec{e})
$$
and
$$
\check{\mathcal{C}}_{ord}^\bullet(\mathcal{U},
\mathcal{O}_{\mathbf{P}_R}(d + 1))
=
\bigoplus\nolimits_{\vec{e} \in \mathbf{Z}^{n + 1}, \ \sum e_i = d + 1}
\check{\mathcal{C}}^\bullet(\vec{e})
$$
It is clear that it maps the subcomplex
$\check{\mathcal{C}}^\bullet(\vec{e})$ to the subcomplex
$\check{\mathcal{C}}^\bullet(\vec{e} + \vec{b}_i)$ where
$\vec{b}_i = (0, \ldots, 0, 1, 0, \ldots, 0))$ the $i$th basis vector.
In other words, it maps the summand of $H^n$ corresponding to
$\vec{e}$ with $e_i < 0$ and $\sum e_i = d$
to the summand of $H^n$ corresponding to
$\vec{e} + \vec{b}_i$ (which is zero if $e_i + b_i \geq 0$).
It is easy to see that this corresponds exactly to the action
of the contragredient of multiplication by $T_i$ as a map
$$
(R[T_0, \ldots, T_n])_{-n - 1 - (d + 1)}
\longrightarrow
(R[T_0, \ldots, T_n])_{-n - 1 - d}
$$
This proves the lemma.
\end{proof}

\noindent
Before we state the relative version we need some notation.
Namely, recall that $\mathcal{O}_S[T_0, \ldots, T_n]$ is a graded
$\mathcal{O}_S$-module where each $T_i$ is homogeneous of degree $1$.
Denote $(\mathcal{O}_S[T_0, \ldots, T_n])_d$ the degree $d$ summand.
It is a finite locally free sheaf of rank $\binom{n + d}{d}$ on $S$.

\begin{lemma}
\label{lemma-cohomology-projective-space-over-base}
Let $S$ be a scheme.
Let $n \geq 0$ be an integer.
Consider the structure morphism
$$
f : \mathbf{P}^n_S \longrightarrow S.
$$
We have
$$
R^qf_*(\mathcal{O}_{\mathbf{P}^n_S}(d)) =
\left\{
\begin{matrix}
(\mathcal{O}_S[T_0, \ldots, T_n])_d & \text{if} & q = 0 \\
0 & \text{if} & q \not = 0, n \\
\SheafHom_{\mathcal{O}_S}(
(\mathcal{O}_S[T_0, \ldots, T_n])_{- n - 1 - d}, \mathcal{O}_S)
& \text{if} & q = n
\end{matrix}
\right.
$$
\end{lemma}

\begin{proof}
Omitted. Hint: This follows since the identifications in
(\ref{equation-identify}) are compatible with affine base change
by Lemma \ref{lemma-identify-functorially}.
\end{proof}

\noindent
Next we state the version for projective bundles associated to finite locally
free sheaves. Let $S$ be a scheme. Let $\mathcal{E}$ be a finite locally
free $\mathcal{O}_S$-module of constant rank $n + 1$, see
Modules, Section \ref{modules-section-locally-free}.
In this case we think of $\text{Sym}(\mathcal{E})$ as a graded
$\mathcal{O}_S$-module where $\mathcal{E}$ is the graded part of degree $1$.
And $\text{Sym}^d(\mathcal{E})$ is the degree $d$ summand.
It is a finite locally free sheaf of rank $\binom{n + d}{d}$ on $S$.
Recall that our normalization is that
$$
\pi :
\mathbf{P}(\mathcal{E})
=
\underline{\text{Proj}}_S(\text{Sym}(\mathcal{E}))
\longrightarrow
S
$$
and that there are natural maps
$\text{Sym}^d(\mathcal{E}) \to \pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d)$.

\begin{lemma}
\label{lemma-cohomology-projective-bundle}
Let $S$ be a scheme. Let $n \geq 1$.
Let $\mathcal{E}$ be a finite locally
free $\mathcal{O}_S$-module of constant rank $n + 1$.
Consider the structure morphism
$$
\pi : \mathbf{P}(\mathcal{E}) \longrightarrow S.
$$
We have
$$
R^q\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d)) =
\left\{
\begin{matrix}
\text{Sym}^d(\mathcal{E}) & \text{if} & q = 0 \\
0 & \text{if} & q \not = 0, n \\
\SheafHom_{\mathcal{O}_S}(
\text{Sym}^{- n - 1 - d}(\mathcal{E})
\otimes_{\mathcal{O}_S}
\wedge^{n + 1}\mathcal{E},
\mathcal{O}_S)
& \text{if} & q = n
\end{matrix}
\right.
$$
These identifications are compatible with base change and
isomorphism between locally free sheaves.
\end{lemma}

\begin{proof}
Consider the canonical map
$$
\pi^*\mathcal{E} \longrightarrow \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)
$$
and twist down by $1$ to get
$$
\pi^*(\mathcal{E})(-1) \longrightarrow \mathcal{O}_{\mathbf{P}(\mathcal{E})}
$$
This is a surjective map from a locally free rank $n + 1$ sheaf onto
the structure sheaf. Hence the corresponding Koszul complex is
exact (More on Algebra, Lemma
\ref{more-algebra-lemma-homotopy-koszul-abstract}).
In other words there is an exact complex
$$
0 \to
\pi^*(\wedge^{n + 1}\mathcal{E})(-n - 1) \to
\ldots \to
\pi^*(\wedge^i\mathcal{E})(-i) \to
\ldots \to
\pi^*\mathcal{E}(-1) \to
\mathcal{O}_{\mathbf{P}(\mathcal{E})} \to 0
$$
We will think of the term $\pi^*(\wedge^i\mathcal{E})(-i)$ as being
in degree $-i$.
We are going to compute the higher direct images
of this acyclic complex using the first spectral sequence of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
Namely, we see that there is a spectral sequence with terms
$$
E_1^{p, q} = R^q\pi_*\left(\pi^*(\wedge^{-p}\mathcal{E})(p)\right)
$$
converging to zero! By the projection formula
(Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
we have
$$
E_1^{p, q} = \wedge^{-p} \mathcal{E} \otimes_{\mathcal{O}_S}
R^q\pi_*\left(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(p)\right).
$$
Note that locally on $S$ the sheaf $\mathcal{E}$ is trivial,
i.e., isomorphic to $\mathcal{O}_S^{\oplus n + 1}$, hence locally on
$S$ the morphism $\mathbf{P}(\mathcal{E}) \to S$ can be identified
with $\mathbf{P}^n_S \to S$. Hence
locally on $S$ we can use the result of Lemmas
\ref{lemma-cohomology-projective-space-over-ring},
\ref{lemma-identify-functorially}, or
\ref{lemma-cohomology-projective-space-over-base}.
It follows that $E_1^{p, q} = 0$ unless $(p, q)$ is $(0, 0)$
or $(-n - 1, n)$. The nonzero terms are
\begin{align*}
E_1^{0, 0} & = \pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})} = \mathcal{O}_S \\
E_1^{-n - 1, n} & =
R^n\pi_*\left(\pi^*(\wedge^{n + 1}\mathcal{E})(-n - 1)\right) =
\wedge^{n + 1}\mathcal{E} \otimes_{\mathcal{O}_S}
R^n\pi_*\left(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-n - 1)\right)
\end{align*}
Hence there can only be one nonzero
differential in the spectral sequence namely the map
$d_{n + 1}^{-n - 1, n} : E_{n + 1}^{-n - 1, n} \to E_{n + 1}^{0, 0}$
which has to be an isomorphism (because the spectral sequence converges
to the $0$ sheaf). Thus $E_1^{p, q} = E_{n + 1}^{p, q}$ and
we obtain a canonical isomorphism
$$
\wedge^{n + 1}\mathcal{E} \otimes_{\mathcal{O}_S}
R^n\pi_*\left(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-n - 1)\right) =
R^n\pi_*\left(\pi^*(\wedge^{n + 1}\mathcal{E})(-n - 1)\right)
\xrightarrow{d_{n + 1}^{-n - 1, n}}
\mathcal{O}_S
$$
Since $\wedge^{n + 1}\mathcal{E}$ is an invertible
sheaf, this implies that
$R^n\pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-n - 1)$ is invertible
as well and canonically isomorphic to the inverse of
$\wedge^{n + 1}\mathcal{E}$. In other words we have proved the case
$d = - n - 1$ of the lemma.

\medskip\noindent
Working locally on $S$ we see immediately from the computation of
cohomology in Lemmas \ref{lemma-cohomology-projective-space-over-ring},
\ref{lemma-identify-functorially}, or
\ref{lemma-cohomology-projective-space-over-base} the statements on
vanishing of the lemma. Moreover the result on $R^0\pi_*$ is clear
as well, since there are canonical maps
$\text{Sym}^d(\mathcal{E}) \to \pi_* \mathcal{O}_{\mathbf{P}(\mathcal{E})}(d)$
for all $d$. It remains to show that the description of
$R^n\pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d)$ is correct
for $d < -n - 1$. In order to do this we consider the map
$$
\pi^*(\text{Sym}^{-d - n - 1}(\mathcal{E}))
\otimes_{\mathcal{O}_{\mathbf{P}(\mathcal{E})}}
\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d)
\longrightarrow
\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-n - 1)
$$
Applying $R^n\pi_*$ and the projection formula (see above) we get a map
$$
\text{Sym}^{-d - n - 1}(\mathcal{E})
\otimes_{\mathcal{O}_S}
R^n\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d))
\longrightarrow
R^n\pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-n - 1) =
(\wedge^{n + 1}\mathcal{E})^{\otimes -1}
$$
(the last equality we have shown above).
Again by the local calculations of Lemmas
\ref{lemma-cohomology-projective-space-over-ring},
\ref{lemma-identify-functorially}, or
\ref{lemma-cohomology-projective-space-over-base}
it follows that this map induces a perfect pairing between
$R^n\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(d))$ and
$\text{Sym}^{-d - n - 1}(\mathcal{E}) \otimes \wedge^{n + 1}(\mathcal{E})$
as desired.
\end{proof}

















\section{Coherent sheaves on locally Noetherian schemes}
\label{section-coherent-sheaves}

\noindent
We have defined the notion of a coherent module on any ringed space in
Modules, Section \ref{modules-section-coherent}.
Although it is possible to consider coherent sheaves on non-Noetherian
schemes we will always assume the base scheme is locally Noetherian when
we consider coherent sheaves. Here is a characterization of coherent
sheaves on locally Noetherian schemes.

\begin{lemma}
\label{lemma-coherent-Noetherian}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is coherent,
\item $\mathcal{F}$ is a quasi-coherent, finite type $\mathcal{O}_X$-module,
\item $\mathcal{F}$ is a finitely presented $\mathcal{O}_X$-module,
\item for any affine open $\Spec(A) = U \subset X$ we have
$\mathcal{F}|_U = \widetilde M$ with $M$ a finite $A$-module, and
\item there exists an affine open covering $X = \bigcup U_i$,
$U_i = \Spec(A_i)$ such that each
$\mathcal{F}|_{U_i} = \widetilde M_i$ with $M_i$ a finite $A_i$-module.
\end{enumerate}
In particular $\mathcal{O}_X$ is coherent, any invertible
$\mathcal{O}_X$-module is coherent, and more generally any
finite locally free $\mathcal{O}_X$-module is coherent.
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) and (1) $\Rightarrow$ (3) hold
in general, see
Modules, Lemma \ref{modules-lemma-coherent-finite-presentation}.
If $\mathcal{F}$ is finitely presented then $\mathcal{F}$ is
quasi-coherent, see
Modules, Lemma \ref{modules-lemma-finite-presentation-quasi-coherent}.
Hence also (3) $\Rightarrow$ (2).

\medskip\noindent
Assume $\mathcal{F}$ is a quasi-coherent, finite type $\mathcal{O}_X$-module.
By
Properties, Lemma \ref{properties-lemma-finite-type-module}
we see that on any affine open
$\Spec(A) = U \subset X$ we have $\mathcal{F}|_U = \widetilde M$
with $M$ a finite $A$-module. Since $A$ is Noetherian we see that
$M$ has a finite resolution
$$
A^{\oplus m} \to A^{\oplus n} \to M \to 0.
$$
Hence $\mathcal{F}$ is of finite presentation by
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
In other words (2) $\Rightarrow$ (3).

\medskip\noindent
By Modules, Lemma \ref{modules-lemma-coherent-structure-sheaf} it suffices
to show that $\mathcal{O}_X$ is coherent in order to show that (3)
implies (1). Thus we have to show: given any open $U \subset X$ and
any finite collection of sections $f_i \in \mathcal{O}_X(U)$,
$i = 1, \ldots, n$ the kernel of the map
$\bigoplus_{i = 1, \ldots, n} \mathcal{O}_U \to \mathcal{O}_U$
is of finite type. Since being of finite type is a local property
it suffices to check this in a neighbourhood of any $x \in U$.
Thus we may assume $U = \Spec(A)$ is affine. In this case
$f_1, \ldots, f_n \in A$ are elements of $A$. Since $A$ is
Noetherian, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian}
the kernel $K$ of the map $\bigoplus_{i = 1, \ldots, n} A \to A$
is a finite $A$-module. See for example
Algebra, Lemma \ref{algebra-lemma-Noetherian-basic}.
As the functor\ $\widetilde{ }$\ is exact, see
Schemes, Lemma \ref{schemes-lemma-spec-sheaves}
we get an exact sequence
$$
\widetilde K \to
\bigoplus\nolimits_{i = 1, \ldots, n} \mathcal{O}_U \to
\mathcal{O}_U
$$
and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
again we see that $\widetilde K$ is of finite type. We conclude
that (1), (2) and (3) are all equivalent.

\medskip\noindent
It follows from
Properties, Lemma \ref{properties-lemma-finite-type-module}
that (2) implies (4). It is trivial that (4) implies (5).
The discussion in
Schemes, Section \ref{schemes-section-quasi-coherent}
show that (5) implies
that $\mathcal{F}$ is quasi-coherent and it is clear that (5)
implies that $\mathcal{F}$ is of finite type. Hence (5) implies
(2) and we win.
\end{proof}

\begin{lemma}
\label{lemma-coherent-abelian-Noetherian}
Let $X$ be a locally Noetherian scheme.
The category of coherent $\mathcal{O}_X$-modules is abelian.
More precisely, the kernel and cokernel of a map of coherent
$\mathcal{O}_X$-modules are coherent. Any extension
of coherent sheaves is coherent.
\end{lemma}

\begin{proof}
This is a restatement of
Modules, Lemma \ref{modules-lemma-coherent-abelian}
in a particular case.
\end{proof}

\noindent
The following lemma does not always hold for the category of coherent
$\mathcal{O}_X$-modules on a general ringed space $X$.

\begin{lemma}
\label{lemma-coherent-Noetherian-quasi-coherent-sub-quotient}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Any quasi-coherent submodule of $\mathcal{F}$ is coherent.
Any quasi-coherent quotient module of $\mathcal{F}$ is coherent.
\end{lemma}

\begin{proof}
We may assume that $X$ is affine, say $X = \Spec(A)$.
Properties, Lemma \ref{properties-lemma-locally-Noetherian}
implies that $A$ is Noetherian. Lemma \ref{lemma-coherent-Noetherian}
turns this into algebra. The algebraic counter part of
the lemma is that a quotient, or a submodule of a finite $A$-module
is a finite $A$-module, see for example
Algebra, Lemma \ref{algebra-lemma-Noetherian-basic}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-hom-coherent}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules.
The $\mathcal{O}_X$-modules $\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{G}$
and $\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ are
coherent.
\end{lemma}

\begin{proof}
It is shown in
Modules, Lemma \ref{modules-lemma-internal-hom-locally-kernel-direct-sum} that
$\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ is coherent.
The result for tensor products is
Modules, Lemma \ref{modules-lemma-tensor-product-permanence}
\end{proof}

\begin{lemma}
\label{lemma-local-isomorphism}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules.
Let $\varphi : \mathcal{G} \to \mathcal{F}$ be a homomorphism
of $\mathcal{O}_X$-modules. Let $x \in X$.
\begin{enumerate}
\item If $\mathcal{F}_x = 0$ then there exists an open neighbourhood
$U \subset X$ of $x$ such that $\mathcal{F}|_U = 0$.
\item If $\varphi_x : \mathcal{G}_x \to \mathcal{F}_x$ is injective,
then there exists an open neighbourhood $U \subset X$ of $x$ such that
$\varphi|_U$ is injective.
\item If $\varphi_x : \mathcal{G}_x \to \mathcal{F}_x$ is surjective,
then there exists an open neighbourhood $U \subset X$ of $x$ such that
$\varphi|_U$ is surjective.
\item If $\varphi_x : \mathcal{G}_x \to \mathcal{F}_x$ is bijective,
then there exists an open neighbourhood $U \subset X$ of $x$ such that
$\varphi|_U$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
See Modules, Lemmas
\ref{modules-lemma-finite-type-surjective-on-stalk},
\ref{modules-lemma-finite-type-stalk-zero}, and
\ref{modules-lemma-finite-type-to-coherent-injective-on-stalk}.
\end{proof}

\begin{lemma}
\label{lemma-map-stalks-local-map}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules.
Let $x \in X$.
Suppose $\psi : \mathcal{G}_x \to \mathcal{F}_x$ is a map of
$\mathcal{O}_{X, x}$-modules.
Then there exists an open neighbourhood $U \subset X$ of $x$ and a map
$\varphi : \mathcal{G}|_U \to \mathcal{F}|_U$ such that
$\varphi_x = \psi$.
\end{lemma}

\begin{proof}
In view of Lemma \ref{lemma-coherent-Noetherian}
this is a reformulation of
Modules, Lemma \ref{modules-lemma-stalk-internal-hom}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-support-closed}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_X$-module. Then $\text{Supp}(\mathcal{F})$ is closed, and
$\mathcal{F}$ comes from a coherent sheaf on the scheme theoretic support
of $\mathcal{F}$, see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-support}.
\end{lemma}

\begin{proof}
Let $i : Z \to X$ be the scheme theoretic support of $\mathcal{F}$ and
let $\mathcal{G}$ be the finite type quasi-coherent sheaf on $Z$
such that $i_*\mathcal{G} \cong \mathcal{F}$.
Since $Z = \text{Supp}(\mathcal{F})$ we see that the support is closed.
The scheme $Z$ is locally Noetherian by
Morphisms, Lemmas \ref{morphisms-lemma-immersion-locally-finite-type}
and \ref{morphisms-lemma-finite-type-noetherian}.
Finally, $\mathcal{G}$ is a coherent $\mathcal{O}_Z$-module by
Lemma \ref{lemma-coherent-Noetherian}
\end{proof}

\begin{lemma}
\label{lemma-i-star-equivalence}
Let $i : Z \to X$ be a closed immersion of locally Noetherian schemes.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaf of ideals
cutting out $Z$. The functor $i_*$ induces an equivalence between the
category of coherent $\mathcal{O}_X$-modules annihilated by $\mathcal{I}$
and the category of coherent $\mathcal{O}_Z$-modules.
\end{lemma}

\begin{proof}
The functor is fully faithful by
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module
annihilated by $\mathcal{I}$. By
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}
we can write $\mathcal{F} = i_*\mathcal{G}$ for some quasi-coherent
sheaf $\mathcal{G}$ on $Z$. By
Modules, Lemma \ref{modules-lemma-i-star-reflects-finite-type}
we see that $\mathcal{G}$ is of finite type.
Hence $\mathcal{G}$ is coherent by
Lemma \ref{lemma-coherent-Noetherian}.
Thus the functor is also essentially surjective as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-pushforward-coherent}
Let $f : X \to Y$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume $f$ is finite and $Y$ locally Noetherian.
Then $R^pf_*\mathcal{F} = 0$ for $p > 0$ and
$f_*\mathcal{F}$ is coherent if $\mathcal{F}$ is coherent.
\end{lemma}

\begin{proof}
The higher direct images vanish by
Lemma \ref{lemma-relative-affine-vanishing} and because
a finite morphism is affine (by definition).
Note that the assumptions imply that also $X$ is locally Noetherian
(see Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian})
and hence the statement makes sense.
Let $\Spec(A) = V \subset Y$ be an affine open subset.
By Morphisms, Definition \ref{morphisms-definition-integral}
we see that $f^{-1}(V) = \Spec(B)$ with $A \to B$ finite.
Lemma \ref{lemma-coherent-Noetherian}
turns the statement of the lemma into the following algebra
fact: If $M$ is a finite $B$-module, then $M$ is also finite
viewed as a $A$-module, see
Algebra, Lemma \ref{algebra-lemma-finite-module-over-finite-extension}.
\end{proof}

\noindent
In the situation of the lemma also the higher direct images are
coherent since they vanish.
We will show that this is always the case for a proper morphism
between locally Noetherian schemes (insert future reference here).

\begin{lemma}
\label{lemma-coherent-support-dimension-0}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$
be a coherent sheaf with $\dim(\text{Supp}(\mathcal{F})) \leq 0$.
Then $\mathcal{F}$ is generated by global sections and
$H^i(X, \mathcal{F}) = 0$ for $i > 0$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-coherent-support-closed} we see that
$\mathcal{F} = i_*\mathcal{G}$ where $i : Z \to X$ is the inclusion
of the scheme theoretic support of $\mathcal{F}$ and where $\mathcal{G}$
is a coherent $\mathcal{O}_Z$-module. Since the dimension of $Z$ is
$0$, we see $Z$ is a disjoint union of affines (Properties, Lemma
\ref{properties-lemma-locally-Noetherian-dimension-0}).
Hence $\mathcal{G}$ is globally generated and the higher
cohomology groups of $\mathcal{G}$ are zero
(Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}).
Hence $\mathcal{F} = i_*\mathcal{G}$ is globally generated.
Since the cohomologies of $\mathcal{F}$ and $\mathcal{G}$ agree
(Lemma \ref{lemma-relative-affine-cohomology} applies as a
closed immersion is affine)
we conclude that the higher cohomology groups of $\mathcal{F}$ are zero.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-coherent-on-open}
Let $X$ be a scheme. Let $j : U \to X$ be the inclusion of an open.
Let $T \subset X$ be a closed subset contained in $U$.
If $\mathcal{F}$ is a coherent $\mathcal{O}_U$-module
with $\text{Supp}(\mathcal{F}) \subset T$, then
$j_*\mathcal{F}$ is a coherent $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Consider the open covering $X = U \cup (X \setminus T)$.
Then $j_*\mathcal{F}|_U = \mathcal{F}$ is coherent and
$j_*\mathcal{F}|_{X \setminus T} = 0$ is also coherent.
Hence $j_*\mathcal{F}$ is coherent.
\end{proof}













\section{Coherent sheaves on Noetherian schemes}
\label{section-coherent-quasi-compact}

\noindent
In this section we mention some properties of coherent sheaves on
Noetherian schemes.

\begin{lemma}
\label{lemma-acc-coherent}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
The ascending chain condition holds for quasi-coherent submodules
of $\mathcal{F}$. In other words, given any sequence
$$
\mathcal{F}_1 \subset \mathcal{F}_2 \subset \ldots \subset \mathcal{F}
$$
of quasi-coherent submodules, then
$\mathcal{F}_n = \mathcal{F}_{n + 1} = \ldots $ for some $n \geq 0$.
\end{lemma}

\begin{proof}
Choose a finite affine open covering.
On each member of the covering we get stabilization by
Algebra, Lemma \ref{algebra-lemma-Noetherian-basic}.
Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-power-ideal-kills-sheaf}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent
sheaf of ideals corresponding to a closed subscheme $Z \subset X$.
Then there is some $n \geq 0$ such that $\mathcal{I}^n\mathcal{F} = 0$
if and only if $\text{Supp}(\mathcal{F}) \subset Z$ (set theoretically).
\end{lemma}

\begin{proof}
This follows immediately from
Algebra, Lemma \ref{algebra-lemma-Noetherian-power-ideal-kills-module}
because $X$ has a finite covering by spectra of Noetherian rings.
\end{proof}

\begin{lemma}[Artin-Rees]
\label{lemma-Artin-Rees}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let $\mathcal{G} \subset \mathcal{F}$ be a quasi-coherent subsheaf.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of
ideals.
Then there exists a $c \geq 0$ such that for all $n \geq c$ we
have
$$
\mathcal{I}^{n - c}(\mathcal{I}^c\mathcal{F} \cap \mathcal{G})
=
\mathcal{I}^n\mathcal{F} \cap \mathcal{G}
$$
\end{lemma}

\begin{proof}
This follows immediately from
Algebra, Lemma \ref{algebra-lemma-Artin-Rees}
because $X$ has a finite covering by spectra of Noetherian rings.
\end{proof}

\begin{lemma}
\label{lemma-homs-over-open}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $\mathcal{G}$ be coherent $\mathcal{O}_X$-module.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of
ideals. Denote $Z \subset X$ the corresponding closed subscheme and
set $U = X \setminus Z$.
There is a canonical isomorphism
$$
\colim_n \Hom_{\mathcal{O}_X}(\mathcal{I}^n\mathcal{G}, \mathcal{F})
\longrightarrow
\Hom_{\mathcal{O}_U}(\mathcal{G}|_U, \mathcal{F}|_U).
$$
In particular we have an isomorphism
$$
\colim_n \Hom_{\mathcal{O}_X}(
\mathcal{I}^n, \mathcal{F})
\longrightarrow
\Gamma(U, \mathcal{F}).
$$
\end{lemma}

\begin{proof}
We first prove the second map is an isomorphism. It is injective by 
Properties, Lemma \ref{properties-lemma-sections-over-quasi-compact-open}.
Since $\mathcal{F}$ is the union of its coherent submodules, see
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
(and Lemma \ref{lemma-coherent-Noetherian})
we may and do assume that $\mathcal{F}$ is coherent to prove surjectivity.
Let $\mathcal{F}_n$ denote the quasi-coherent subsheaf of $\mathcal{F}$
consisting of sections annihilated by $\mathcal{I}^n$,
see Properties, Lemma \ref{properties-lemma-sections-over-quasi-compact-open}.
Since $\mathcal{F}_1 \subset \mathcal{F}_2 \subset \ldots$ we see that
$\mathcal{F}_n = \mathcal{F}_{n + 1} = \ldots $ for some $n \geq 0$
by Lemma \ref{lemma-acc-coherent}. Set $\mathcal{H} = \mathcal{F}_n$
for this $n$. By Artin-Rees (Lemma \ref{lemma-Artin-Rees})
there exists an $c \geq 0$ such that
$\mathcal{I}^m\mathcal{F} \cap \mathcal{H}
\subset \mathcal{I}^{m - c}\mathcal{H}$. Picking $m = n + c$ we get
$\mathcal{I}^m\mathcal{F} \cap \mathcal{H} \subset \mathcal{I}^n\mathcal{H}
= 0$. Thus if we set $\mathcal{F}' = \mathcal{I}^m\mathcal{F}$ then we
see that $\mathcal{F}' \cap \mathcal{F}_n = 0$ and
$\mathcal{F}'|_U = \mathcal{F}|_U$. Note in particular that the subsheaf
$(\mathcal{F}')_N$ of sections annihilated by $\mathcal{I}^N$ is zero
for all $N \geq 0$. Hence by
Properties, Lemma \ref{properties-lemma-sections-over-quasi-compact-open}
we deduce that
the top horizontal arrow in the following commutative
diagram is a bijection:
$$
\xymatrix{
\colim_n \Hom_{\mathcal{O}_X}(
\mathcal{I}^n, \mathcal{F}')
\ar[r] \ar[d] &
\Gamma(U, \mathcal{F}') \ar[d] \\
\colim_n \Hom_{\mathcal{O}_X}(
\mathcal{I}^n, \mathcal{F})
\ar[r] &
\Gamma(U, \mathcal{F})
}
$$
Since also the right vertical arrow is a bijection we conclude that
the bottom horizontal arrow is surjective as desired.

\medskip\noindent
Next, we prove the first arrow of the lemma is a bijection.
By Lemma \ref{lemma-coherent-Noetherian} the sheaf $\mathcal{G}$
is of finite presentation and hence the sheaf
$\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{G}, \mathcal{F})$
is quasi-coherent, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
By definition we have
$$
\mathcal{H}(U)
=
\Hom_{\mathcal{O}_U}(\mathcal{G}|_U, \mathcal{F}|_U)
$$
Pick a $\psi$ in the right hand side of the first arrow of the
lemma, i.e.,  $\psi \in \mathcal{H}(U)$. The result just proved applies
to $\mathcal{H}$ and hence there exists an $n \geq 0$ and an
$\varphi : \mathcal{I}^n \to \mathcal{H}$ which recovers
$\psi$ on restriction to $U$. By
Modules, Lemma \ref{modules-lemma-internal-hom}
$\varphi$ corresponds to a map
$$
\varphi :
\mathcal{I}^{\otimes n} \otimes_{\mathcal{O}_X} \mathcal{G}
\longrightarrow
\mathcal{F}.
$$
This is almost what we want except that the source of the arrow
is the tensor product of $\mathcal{I}^n$ and $\mathcal{G}$
and not the product. We will show that, at the cost of increasing $n$,
the difference is irrelevant. Consider the short exact sequence
$$
0 \to \mathcal{K} \to
\mathcal{I}^n \otimes_{\mathcal{O}_X} \mathcal{G} \to
\mathcal{I}^n\mathcal{G} \to 0
$$
where $\mathcal{K}$ is defined as the kernel. Note that
$\mathcal{I}^n\mathcal{K} = 0$ (proof omitted). By Artin-Rees
again we see that
$$
\mathcal{K}
\cap
\mathcal{I}^m(\mathcal{I}^n \otimes_{\mathcal{O}_X} \mathcal{G})
=
0
$$
for some $m$ large enough. In other words we see that
$$
\mathcal{I}^m(\mathcal{I}^n \otimes_{\mathcal{O}_X} \mathcal{G})
\longrightarrow
\mathcal{I}^{n + m}\mathcal{G}
$$
is an isomorphism. Let $\varphi'$ be the restriction of
$\varphi$ to this submodule thought of as a map
$\mathcal{I}^{m + n}\mathcal{G} \to \mathcal{F}$.
Then $\varphi'$ gives an element
of the left hand side of the first arrow of the lemma which
maps to $\psi$ via the arrow. In other words we have proved surjectivity
of the arrow. We omit the proof of injectivity.
\end{proof}









\section{Depth}
\label{section-depth}

\noindent
In this section we talk a little bit about depth and property
$(S_k)$ for coherent modules on locally Noetherian schemes.
Note that we have already discussed this notion for locally
Noetherian schemes in Properties, Section \ref{properties-section-Rk}.

\begin{definition}
\label{definition-depth}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Let $k \geq 0$ be an integer.
\begin{enumerate}
\item We say $\mathcal{F}$ has {\it depth $k$ at a point}
$x$ of $X$ if $\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) = k$.
\item We say $X$ has {\it depth $k$ at a point} $x$ of $X$ if
$\text{depth}(\mathcal{O}_{X, x}) = k$.
\item We say $\mathcal{F}$ has property {\it $(S_k)$} if
$$
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x)
\geq \min(k, \dim(\text{Supp}(\mathcal{F}_x)))
$$
for all $x \in X$.
\item We say $X$ has property {\it $(S_k)$} if $\mathcal{O}_X$ has
property $(S_k)$.
\end{enumerate}
\end{definition}

\noindent
Any coherent sheaf satisfies condition $(S_0)$.
Condition $(S_1)$ is equivalent to having no embedded associated
points, see Divisors, Lemma \ref{divisors-lemma-S1-no-embedded}.

\medskip\noindent
We have seen in Properties, Lemma \ref{properties-lemma-scheme-CM-iff-all-Sk}
that a locally Noetherian
scheme is Cohen-Macaulay if and only if $(S_k)$ holds for all $k$.
Thus it makes sense to introduce the following definition, which
is equivalent to the condition that all stalks are Cohen-Macaulay modules.

\begin{definition}
\label{definition-Cohen-Macaulay}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
We say $\mathcal{F}$ is {\it Cohen-Macaulay} if and only
if $(S_k)$ holds for all $k \geq 0$.
\end{definition}

\begin{lemma}
\label{lemma-hom-into-S2}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$, $\mathcal{G}$
be coherent $\mathcal{O}_X$-modules.
\begin{enumerate}
\item If $\mathcal{G}$ has property $(S_1)$, then
$\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ has property $(S_1)$.
\item If $\mathcal{G}$ has property $(S_2)$, then
$\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ has property $(S_2)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ is
a coherent $\mathcal{O}_X$-module by Lemma \ref{lemma-tensor-hom-coherent}.
Coherent modules are of finite presentation
(Lemma \ref{lemma-coherent-Noetherian}) hence taking stalks commutes
with taking $\SheafHom$ and $\Hom$, see
Modules, Lemma \ref{modules-lemma-stalk-internal-hom}.
Thus we reduce to the case of finite modules over local
rings which is More on Algebra, Lemma \ref{more-algebra-lemma-hom-into-depth}.
\end{proof}

\begin{lemma}
\label{lemma-Cohen-Macaulay-over-regular}
Let $X$ be a regular scheme. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_X$-module. The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is Cohen-Macaulay and $\text{Supp}(\mathcal{F}) = X$,
\item $\mathcal{F}$ is finite locally free of rank $>0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in X$. If (2) holds, then $\mathcal{F}_x$ is a free
$\mathcal{O}_{X, x}$-module of rank $> 0$. Hence
$\text{depth}(\mathcal{F}_x) = \dim(\mathcal{O}_{X, x})$
because a regular local ring is Cohen-Macaulay
(Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}).
Conversely, if (1) holds, then $\mathcal{F}_x$ is a
maximal Cohen-Macaulay module over $\mathcal{O}_{X, x}$
(Algebra, Definition \ref{algebra-definition-maximal-CM}).
Hence $\mathcal{F}_x$ is free by
Algebra, Lemma \ref{algebra-lemma-regular-mcm-free}.
\end{proof}









\section{Devissage of coherent sheaves}
\label{section-devissage}

\noindent
Let $X$ be a Noetherian scheme. Consider an integral closed subscheme
$i : Z \to X$. It is often convenient to consider coherent sheaves of
the form $i_*\mathcal{G}$ where $\mathcal{G}$ is a coherent sheaf on
$Z$. In particular we are interested in these sheaves when $\mathcal{G}$
is a torsion free rank $1$ sheaf. For example $\mathcal{G}$ could be
a nonzero sheaf of ideals on $Z$, or even more specifically
$\mathcal{G} = \mathcal{O}_Z$.

\medskip\noindent
Throughout this section we will use that a coherent sheaf is the
same thing as a finite type quasi-coherent sheaf and that a
quasi-coherent subquotient of a coherent sheaf is coherent, see
Section \ref{section-coherent-sheaves}.
The support of a coherent sheaf is closed, see
Modules, Lemma \ref{modules-lemma-support-finite-type-closed}.

\begin{lemma}
\label{lemma-prepare-filter-support}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Suppose that $\text{Supp}(\mathcal{F}) = Z \cup Z'$ with $Z$, $Z'$ closed.
Then there exists a short exact sequence of coherent sheaves
$$
0 \to \mathcal{G}' \to \mathcal{F} \to \mathcal{G} \to 0
$$
with $\text{Supp}(\mathcal{G}') \subset Z'$ and
$\text{Supp}(\mathcal{G}) \subset Z$.
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the sheaf of ideals
defining the reduced induced closed subscheme structure on $Z$, see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}.
Consider the subsheaves
$\mathcal{G}'_n = \mathcal{I}^n\mathcal{F}$ and the
quotients $\mathcal{G}_n = \mathcal{F}/\mathcal{I}^n\mathcal{F}$.
For each $n$ we have a short exact sequence
$$
0 \to \mathcal{G}'_n \to \mathcal{F} \to \mathcal{G}_n \to 0
$$
For every point $x$ of $Z' \setminus Z$ we have
$\mathcal{I}_x = \mathcal{O}_{X, x}$
and hence $\mathcal{G}_{n, x} = 0$. Thus we see that
$\text{Supp}(\mathcal{G}_n) \subset Z$. Note that $X \setminus Z'$
is a Noetherian scheme. Hence by Lemma \ref{lemma-power-ideal-kills-sheaf}
there exists an $n$ such that
$\mathcal{G}'_n|_{X \setminus Z'} =
\mathcal{I}^n\mathcal{F}|_{X \setminus Z'} = 0$.
For such an $n$ we see that $\text{Supp}(\mathcal{G}'_n) \subset Z'$.
Thus setting
$\mathcal{G}' = \mathcal{G}'_n$ and $\mathcal{G} = \mathcal{G}_n$
works.
\end{proof}

\begin{lemma}
\label{lemma-prepare-filter-irreducible}
Let $X$ be a Noetherian scheme.
Let $i : Z \to X$ be an integral closed subscheme.
Let $\xi \in Z$ be the generic point.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\mathcal{F}_\xi$ is annihilated by
$\mathfrak m_\xi$. Then there exists an integer
$r \geq 0$ and a sheaf of ideals $\mathcal{I} \subset \mathcal{O}_Z$
and an injective map of coherent sheaves
$$
i_*\left(\mathcal{I}^{\oplus r}\right) \to \mathcal{F}
$$
which is an isomorphism in a neighbourhood of $\xi$.
\end{lemma}

\begin{proof}
Let $\mathcal{J} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$.
Let $\mathcal{F}' \subset \mathcal{F}$ be the subsheaf of
local sections of $\mathcal{F}$ which are annihilated by
$\mathcal{J}$. It is a quasi-coherent sheaf by
Properties, Lemma \ref{properties-lemma-sections-annihilated-by-ideal}.
Moreover, $\mathcal{F}'_\xi = \mathcal{F}_\xi$ because
$\mathcal{J}_\xi = \mathfrak m_\xi$ and part (3) of
Properties, Lemma \ref{properties-lemma-sections-annihilated-by-ideal}.
By Lemma \ref{lemma-local-isomorphism} we see that
$\mathcal{F}' \to \mathcal{F}$
induces an isomorphism in a neighbourhood of $\xi$.
Hence we may replace $\mathcal{F}$ by $\mathcal{F}'$ and assume
that $\mathcal{F}$ is annihilated by $\mathcal{J}$.

\medskip\noindent
Assume $\mathcal{J}\mathcal{F} = 0$. By
Lemma \ref{lemma-i-star-equivalence} we can write
$\mathcal{F} = i_*\mathcal{G}$ for some coherent
sheaf $\mathcal{G}$ on $Z$. Suppose we can find a morphism
$\mathcal{I}^{\oplus r} \to \mathcal{G}$ which is an isomorphism
in a neighbourhood of the generic point $\xi$ of $Z$.
Then applying $i_*$ (which is left exact) we get the result of the lemma.
Hence we have reduced to the case $X = Z$.

\medskip\noindent
Suppose $Z = X$ is an integral Noetherian scheme with generic point $\xi$.
Note that $\mathcal{O}_{X, \xi} = \kappa(\xi)$ is the function field of $X$
in this case.
Since $\mathcal{F}_\xi$ is a finite $\mathcal{O}_\xi$-module we see
that $r = \dim_{\kappa(\xi)} \mathcal{F}_\xi$ is finite.
Hence the sheaves $\mathcal{O}_X^{\oplus r}$ and $\mathcal{F}$
have isomorphic stalks at $\xi$.
By Lemma \ref{lemma-map-stalks-local-map} there exists a nonempty
open $U \subset X$ and a morphism
$\psi : \mathcal{O}_X^{\oplus r}|_U \to \mathcal{F}|_U$
which is an isomorphism
at $\xi$, and hence an isomorphism in a neighbourhood of $\xi$ by
Lemma \ref{lemma-local-isomorphism}.
By Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}
there exists a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$
whose associated closed subscheme $Z \subset X$ is the complement
of $U$.
By Lemma \ref{lemma-homs-over-open} there exists an $n \geq 0$ and a morphism
$\mathcal{I}^n(\mathcal{O}_X^{\oplus r}) \to \mathcal{F}$
which recovers our $\psi$ over $U$. Since
$\mathcal{I}^n(\mathcal{O}_X^{\oplus r}) = (\mathcal{I}^n)^{\oplus r}$
we get a map as in the lemma. It is injective because $X$ is
integral and it is injective at the generic point of $X$
(easy proof omitted).
\end{proof}

\begin{lemma}
\label{lemma-coherent-filter}
Let $X$ be a Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
There exists a filtration
$$
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset
\ldots \subset \mathcal{F}_m = \mathcal{F}
$$
by coherent subsheaves such that for each $j = 1, \ldots, m$
there exists an integral closed subscheme $Z_j \subset X$
and a sheaf of ideals $\mathcal{I}_j \subset \mathcal{O}_{Z_j}$
such that
$$
\mathcal{F}_j/\mathcal{F}_{j - 1}
\cong (Z_j \to X)_* \mathcal{I}_j
$$
\end{lemma}

\begin{proof}
Consider the collection
$$
\mathcal{T} =
\left\{
\begin{matrix}
Z \subset X
\text{ closed such that there exists a coherent sheaf }
\mathcal{F} \\
\text{ with }
\text{Supp}(\mathcal{F}) = Z
\text{ for which the lemma is wrong}
\end{matrix}
\right\}
$$
We are trying to show that $\mathcal{T}$ is empty. If not, then
because $X$ is Noetherian we can choose a minimal element
$Z \in \mathcal{T}$. This means that there exists a coherent
sheaf $\mathcal{F}$ on $X$ whose support is $Z$ and for which the
lemma does not hold. Clearly $Z \not = \emptyset$ since the only
sheaf whose support is empty is the zero sheaf for which the
lemma does hold (with $m = 0$).

\medskip\noindent
If $Z$ is not irreducible, then we can write $Z = Z_1 \cup Z_2$
with $Z_1, Z_2$ closed and strictly smaller than $Z$.
Then we can apply Lemma \ref{lemma-prepare-filter-support}
to get a short exact sequence of coherent sheaves
$$
0 \to
\mathcal{G}_1 \to
\mathcal{F} \to
\mathcal{G}_2 \to 0
$$
with $\text{Supp}(\mathcal{G}_i) \subset Z_i$. By minimality of
$Z$ each of $\mathcal{G}_i$ has a filtration as in the statement
of the lemma. By considering the induced filtration on $\mathcal{F}$
we arrive at a contradiction. Hence we conclude
that $Z$ is irreducible.

\medskip\noindent
Suppose $Z$ is irreducible. Let $\mathcal{J}$ be the sheaf of ideals
cutting out the reduced induced closed subscheme structure of $Z$,
see Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}.
By Lemma \ref{lemma-power-ideal-kills-sheaf} we see there exists
an $n \geq 0$ such that $\mathcal{J}^n\mathcal{F} = 0$. Hence we obtain
a filtration
$$
0 = \mathcal{J}^n\mathcal{F} \subset \mathcal{J}^{n - 1}\mathcal{F}
\subset \ldots \subset \mathcal{J}\mathcal{F} \subset \mathcal{F}
$$
each of whose successive subquotients is annihilated by $\mathcal{J}$.
Hence if each of these subquotients has a filtration as in the statement
of the lemma then also $\mathcal{F}$ does. In other words we may
assume that $\mathcal{J}$ does annihilate $\mathcal{F}$.

\medskip\noindent
In the case where $Z$ is irreducible and $\mathcal{J}\mathcal{F} = 0$
we can apply Lemma \ref{lemma-prepare-filter-irreducible}.
This gives a short exact sequence
$$
0 \to
i_*(\mathcal{I}^{\oplus r}) \to
\mathcal{F} \to
\mathcal{Q} \to 0
$$
where $\mathcal{Q}$ is defined as the quotient.
Since $\mathcal{Q}$ is zero in a neighbourhood of $\xi$ by
the lemma just cited we see that the support of $\mathcal{Q}$
is strictly smaller than $Z$. Hence we see that $\mathcal{Q}$
has a filtration of the desired type by minimality of $Z$.
But then clearly $\mathcal{F}$ does too, which is our final contradiction.
\end{proof}

\begin{lemma}
\label{lemma-property-initial}
Let $X$ be a Noetherian scheme.
Let $\mathcal{P}$ be a property of coherent sheaves on $X$. Assume
\begin{enumerate}
\item For any short exact sequence of coherent sheaves
$$
0 \to \mathcal{F}_1 \to \mathcal{F} \to \mathcal{F}_2 \to 0
$$
if $\mathcal{F}_i$, $i = 1, 2$ have property $\mathcal{P}$
then so does $\mathcal{F}$.
\item For every integral closed subscheme $Z \subset X$
and every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Z$ we have
$\mathcal{P}$ for $i_*\mathcal{I}$.
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
on $X$.
\end{lemma}

\begin{proof}
First note that if $\mathcal{F}$ is a coherent sheaf with a filtration
$$
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset
\ldots \subset \mathcal{F}_m = \mathcal{F}
$$
by coherent subsheaves such that each of $\mathcal{F}_i/\mathcal{F}_{i - 1}$
has property $\mathcal{P}$, then so does $\mathcal{F}$.
This follows from the property (1) for $\mathcal{P}$.
On the other hand, by Lemma \ref{lemma-coherent-filter}
we can filter any $\mathcal{F}$
with successive subquotients as in (2).
Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-property-irreducible}
Let $X$ be a Noetherian scheme. Let $Z_0 \subset X$ be an irreducible closed
subset with generic point $\xi$. Let $\mathcal{P}$ be a property of coherent
sheaves on $X$ with support contained in $Z_0$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves if two
out of three of them have property $\mathcal{P}$ then so does the
third.
\item For every integral closed subscheme $Z \subset Z_0 \subset X$,
$Z \not = Z_0$ and every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Z$ we have
$\mathcal{P}$ for $(Z \to X)_*\mathcal{I}$.
\item There exists some coherent sheaf $\mathcal{G}$ on $X$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z_0$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$,
\item $\dim_{\kappa(\xi)} \mathcal{G}_\xi = 1$, and
\item property $\mathcal{P}$ holds for $\mathcal{G}$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
$\mathcal{F}$ on $X$ whose support is contained in $Z_0$.
\end{lemma}

\begin{proof}
First note that if $\mathcal{F}$ is a coherent sheaf with support
contained in $Z_0$ with a filtration
$$
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset
\ldots \subset \mathcal{F}_m = \mathcal{F}
$$
by coherent subsheaves such that each of $\mathcal{F}_i/\mathcal{F}_{i - 1}$
has property $\mathcal{P}$, then so does $\mathcal{F}$. Or, if $\mathcal{F}$
has property $\mathcal{P}$ and all but one of the
$\mathcal{F}_i/\mathcal{F}_{i - 1}$ has property $\mathcal{P}$ then
so does the last one. This follows from assumption (1).

\medskip\noindent
As a first application we conclude that any coherent sheaf whose support
is strictly contained in $Z_0$ has property $\mathcal{P}$. Namely, such a
sheaf has a filtration (see Lemma \ref{lemma-coherent-filter})
whose subquotients have property $\mathcal{P}$ according to (2).

\medskip\noindent
Let $\mathcal{G}$ be as in (3). By Lemma \ref{lemma-prepare-filter-irreducible}
there exist a sheaf of ideals $\mathcal{I}$ on $Z_0$, an
integer $r \geq 1$, and a short exact sequence
$$
0 \to
\left((Z_0 \to X)_*\mathcal{I}\right)^{\oplus r} \to
\mathcal{G} \to
\mathcal{Q} \to 0
$$
where the support of $\mathcal{Q}$ is strictly contained in $Z_0$.
By (3)(c) we see that $r = 1$. Since $\mathcal{Q}$ has property $\mathcal{P}$
too we conclude that $(Z_0 \to X)_*\mathcal{I}$ has property
$\mathcal{P}$.

\medskip\noindent
Next, suppose that $\mathcal{I}' \not = 0$ is another quasi-coherent
sheaf of ideals on $Z_0$. Then we can consider the intersection
$\mathcal{I}'' = \mathcal{I}' \cap \mathcal{I}$ and we get
two short exact sequences
$$
0 \to
(Z_0 \to X)_*\mathcal{I}'' \to
(Z_0 \to X)_*\mathcal{I} \to
\mathcal{Q} \to 0
$$
and
$$
0 \to
(Z_0 \to X)_*\mathcal{I}'' \to
(Z_0 \to X)_*\mathcal{I}' \to
\mathcal{Q}' \to 0.
$$
Note that the support of the coherent sheaves $\mathcal{Q}$ and
$\mathcal{Q}'$ are strictly contained in $Z_0$.
Hence $\mathcal{Q}$ and $\mathcal{Q}'$ have property $\mathcal{P}$
(see above). Hence we conclude using (1)
that $(Z_0 \to X)_*\mathcal{I}''$ and $(Z_0 \to X)_*\mathcal{I}'$
both have $\mathcal{P}$ as well.

\medskip\noindent
The final step of the proof is to note that any coherent sheaf
$\mathcal{F}$ on $X$ whose support is contained in $Z_0$ has a filtration
(see Lemma \ref{lemma-coherent-filter} again) whose subquotients
all have property $\mathcal{P}$ by what we just said.
\end{proof}

\begin{lemma}
\label{lemma-property}
Let $X$ be a Noetherian scheme.
Let $\mathcal{P}$ be a property of coherent sheaves on $X$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves if two
out of three of them have property $\mathcal{P}$ then so does the
third.
\item For every integral closed subscheme $Z \subset X$
with generic point $\xi$ there exists
some coherent sheaf $\mathcal{G}$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$,
\item $\dim_{\kappa(\xi)} \mathcal{G}_\xi = 1$, and
\item property $\mathcal{P}$ holds for $\mathcal{G}$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
on $X$.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-property-initial} it suffices to show that
for all integral closed subschemes $Z \subset X$ and all quasi-coherent
ideal sheaves $\mathcal{I} \subset \mathcal{O}_Z$ we have $\mathcal{P}$
for $(Z \to X)_*\mathcal{I}$. If this fails, then since $X$ is Noetherian
there is a minimal integral closed subscheme $Z_0 \subset X$ such that
$\mathcal{P}$ fails for $(Z_0 \to X)_*\mathcal{I}_0$ for some
quasi-coherent sheaf of ideals $\mathcal{I}_0 \subset \mathcal{O}_{Z_0}$,
but $\mathcal{P}$ does hold for $(Z \to X)_*\mathcal{I}$ for all integral
closed subschemes $Z \subset Z_0$, $Z \not = Z_0$ and quasi-coherent
ideal sheaves $\mathcal{I} \subset \mathcal{O}_Z$. Since we have the
existence of $\mathcal{G}$ for $Z_0$ by part (2), according to
Lemma \ref{lemma-property-irreducible} this cannot happen.
\end{proof}

\begin{lemma}
\label{lemma-property-irreducible-higher-rank-cohomological}
Let $X$ be a Noetherian scheme. Let $Z_0 \subset X$ be an irreducible
closed subset with generic point $\xi$. Let $\mathcal{P}$ be a property
of coherent sheaves on $X$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves
$$
0 \to \mathcal{F}_1 \to \mathcal{F} \to \mathcal{F}_2 \to 0
$$
if $\mathcal{F}_i$, $i = 1, 2$ have property $\mathcal{P}$
then so does $\mathcal{F}$.
\item If $\mathcal{P}$ holds for a direct sum of coherent sheaves
then it holds for both.
\item For every integral closed subscheme $Z \subset Z_0 \subset X$,
$Z \not = Z_0$ and every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Z$ we have
$\mathcal{P}$ for $(Z \to X)_*\mathcal{I}$.
\item There exists some coherent sheaf $\mathcal{G}$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z_0$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$, and
\item for every quasi-coherent sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_X$ such that
$\mathcal{J}_\xi = \mathcal{O}_{X, \xi}$ there exists a quasi-coherent
subsheaf $\mathcal{G}' \subset \mathcal{J}\mathcal{G}$ with
$\mathcal{G}'_\xi = \mathcal{G}_\xi$ and such that
$\mathcal{P}$ holds for $\mathcal{G}'$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
$\mathcal{F}$ on $X$ whose support is contained in $Z_0$.
\end{lemma}

\begin{proof}
Note that if $\mathcal{F}$ is a coherent sheaf with a filtration
$$
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset
\ldots \subset \mathcal{F}_m = \mathcal{F}
$$
by coherent subsheaves such that each of $\mathcal{F}_i/\mathcal{F}_{i - 1}$
has property $\mathcal{P}$, then so does $\mathcal{F}$.
This follows from assumption (1).

\medskip\noindent
As a first application we conclude that any coherent sheaf whose support
is strictly contained in $Z_0$ has property $\mathcal{P}$. Namely, such a
sheaf has a filtration (see Lemma \ref{lemma-coherent-filter})
whose subquotients have property $\mathcal{P}$ according to (3).

\medskip\noindent
Let us denote $i : Z_0 \to X$ the closed immersion.
Consider a coherent sheaf $\mathcal{G}$ as in (4).
By Lemma \ref{lemma-prepare-filter-irreducible}
there exists a sheaf of ideals $\mathcal{I}$ on $Z_0$ and
a short exact sequence
$$
0 \to
i_*\mathcal{I}^{\oplus r} \to
\mathcal{G} \to
\mathcal{Q} \to 0
$$
where the support of $\mathcal{Q}$ is strictly contained in $Z_0$.
In particular $r > 0$ and $\mathcal{I}$ is nonzero
because the support of $\mathcal{G}$ is equal to $Z_0$.
Let $\mathcal{I}' \subset \mathcal{I}$ be any nonzero quasi-coherent
sheaf of ideals on $Z_0$ contained in $\mathcal{I}$.
Then we also get a short exact sequence
$$
0 \to
i_*(\mathcal{I}')^{\oplus r} \to
\mathcal{G} \to
\mathcal{Q}' \to 0
$$
where $\mathcal{Q}'$ has support properly contained in $Z_0$.
Let $\mathcal{J} \subset \mathcal{O}_X$ be a quasi-coherent sheaf
of ideals cutting out the support of $\mathcal{Q}'$ (for example
the ideal corresponding to the reduced induced closed subscheme
structure on the support of $\mathcal{Q}'$). Then
$\mathcal{J}_\xi = \mathcal{O}_{X, \xi}$. By
Lemma \ref{lemma-power-ideal-kills-sheaf}
we see that $\mathcal{J}^n\mathcal{Q}' = 0$ for some $n$.
Hence $\mathcal{J}^n\mathcal{G} \subset i_*(\mathcal{I}')^{\oplus r}$.
By assumption (4)(c) of the lemma we see there exists
a quasi-coherent subsheaf $\mathcal{G}' \subset \mathcal{J}^n\mathcal{G}$
with $\mathcal{G}'_\xi = \mathcal{G}_\xi$
for which property $\mathcal{P}$ holds.
Hence we get a short exact sequence
$$
0 \to \mathcal{G}' \to
i_*(\mathcal{I}')^{\oplus r} \to
\mathcal{Q}'' \to 0
$$
where $\mathcal{Q}''$ has support properly contained in $Z_0$.
Thus by our initial remarks and property (1) of the lemma
we conclude that $i_*(\mathcal{I}')^{\oplus r}$ satisfies
$\mathcal{P}$. Hence we see that $i_*\mathcal{I}'$ satisfies
$\mathcal{P}$ by (2). Finally, for an arbitrary quasi-coherent
sheaf of ideals $\mathcal{I}'' \subset \mathcal{O}_{Z_0}$ we can set
$\mathcal{I}' = \mathcal{I}'' \cap \mathcal{I}$ and we get
a short exact sequence
$$
0 \to
i_*(\mathcal{I}') \to
i_*(\mathcal{I}'') \to
\mathcal{Q}''' \to 0
$$
where $\mathcal{Q}'''$ has support properly contained in $Z_0$.
Hence we conclude that property $\mathcal{P}$ holds for
$i_*\mathcal{I}''$ as well.

\medskip\noindent
The final step of the proof is to note that any coherent sheaf
$\mathcal{F}$ on $X$ whose support is contained in $Z_0$ has a filtration
(see Lemma \ref{lemma-coherent-filter} again) whose subquotients
all have property $\mathcal{P}$ by what we just said.
\end{proof}

\begin{lemma}
\label{lemma-property-higher-rank-cohomological}
Let $X$ be a Noetherian scheme.
Let $\mathcal{P}$ be a property of coherent sheaves on $X$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves
$$
0 \to \mathcal{F}_1 \to \mathcal{F} \to \mathcal{F}_2 \to 0
$$
if $\mathcal{F}_i$, $i = 1, 2$ have property $\mathcal{P}$
then so does $\mathcal{F}$.
\item If $\mathcal{P}$ holds for a direct sum of coherent sheaves
then it holds for both.
\item For every integral closed subscheme $Z \subset X$
with generic point $\xi$ there exists
some coherent sheaf $\mathcal{G}$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$, and
\item for every quasi-coherent sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_X$ such that
$\mathcal{J}_\xi = \mathcal{O}_{X, \xi}$ there exists a quasi-coherent
subsheaf $\mathcal{G}' \subset \mathcal{J}\mathcal{G}$ with
$\mathcal{G}'_\xi = \mathcal{G}_\xi$ and such that
$\mathcal{P}$ holds for $\mathcal{G}'$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
on $X$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-property-irreducible-higher-rank-cohomological}
in exactly the same way that Lemma \ref{lemma-property} follows from
Lemma \ref{lemma-property-irreducible}.
\end{proof}








\section{Finite morphisms and affines}
\label{section-finite-affine}

\noindent
In this section we use the results of the preceding sections
to show that the image of a Noetherian affine scheme under a finite
morphism is affine. We will see later that this result holds more
generally (see Limits, Lemma \ref{limits-lemma-affine}).

\begin{lemma}
\label{lemma-finite-morphism-Noetherian}
Let $f : Y \to X$ be a morphism of schemes.
Assume $f$ is finite, surjective and $X$ locally Noetherian.
Let $Z \subset X$ be an integral closed subscheme with
generic point $\xi$. Then
there exists a coherent sheaf $\mathcal{F}$ on $Y$
such that the support of $f_*\mathcal{F}$ is equal to $Z$
and $(f_*\mathcal{F})_\xi$ is annihilated by $\mathfrak m_\xi$.
\end{lemma}

\begin{proof}
Note that $Y$ is locally Noetherian by
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}.
Because $f$ is surjective the fibre $Y_\xi$ is not empty.
Pick $\xi' \in Y$ mapping to $\xi$. Let $Z' = \overline{\{\xi'\}}$.
We may think of $Z' \subset Y$ as a reduced closed subscheme,
see Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}.
Hence the sheaf $\mathcal{F} = (Z' \to Y)_*\mathcal{O}_{Z'}$
is a coherent sheaf on $Y$ (see
Lemma \ref{lemma-finite-pushforward-coherent}).
Look at the commutative diagram
$$
\xymatrix{
Z' \ar[r]_{i'} \ar[d]_{f'} &
Y \ar[d]^f \\
Z \ar[r]^i &
X
}
$$
We see that $f_*\mathcal{F} = i_*f'_*\mathcal{O}_{Z'}$.
Hence the stalk of $f_*\mathcal{F}$ at $\xi$ is the stalk
of $f'_*\mathcal{O}_{Z'}$ at $\xi$. Note that since $Z'$ is
integral with generic point $\xi'$ we have that
$\xi'$ is the only point of $Z'$ lying over $\xi$, see
Algebra, Lemmas \ref{algebra-lemma-finite-is-integral} and
\ref{algebra-lemma-integral-no-inclusion}.
Hence the stalk of $f'_*\mathcal{O}_{Z'}$ at $\xi$
equal $\mathcal{O}_{Z', \xi'} = \kappa(\xi')$. In particular
the stalk of $f_*\mathcal{F}$ at $\xi$ is not zero.
This combined with the fact that $f_*\mathcal{F}$ is
of the form $i_*f'_*(\text{something})$ implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-affine-morphism-projection-ideal}
Let $f : Y \to X$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $Y$.
Let $\mathcal{I}$ be a quasi-coherent sheaf of ideals on $X$.
If the morphism $f$ is affine then
$\mathcal{I}f_*\mathcal{F} = f_*(f^{-1}\mathcal{I}\mathcal{F})$.
\end{lemma}

\begin{proof}
The notation means the following. Since $f^{-1}$ is an exact functor
we see that $f^{-1}\mathcal{I}$ is a sheaf
of ideals of $f^{-1}\mathcal{O}_X$. Via the map
$f^\sharp : f^{-1}\mathcal{O}_X \to \mathcal{O}_Y$ this acts on
$\mathcal{F}$. Then $f^{-1}\mathcal{I}\mathcal{F}$ is the subsheaf
generated by sums of local sections of the form $as$ where $a$
is a local section of $f^{-1}\mathcal{I}$ and $s$ is a local section
of $\mathcal{F}$. It is a quasi-coherent $\mathcal{O}_Y$-submodule
of $\mathcal{F}$ because it is also the image of a natural map
$f^*\mathcal{I} \otimes_{\mathcal{O}_Y} \mathcal{F} \to \mathcal{F}$.

\medskip\noindent
Having said this the proof is straightforward. Namely, the question is local
and hence we may assume $X$ is affine. Since $f$ is affine we see that
$Y$ is affine too. Thus we may write
$Y = \Spec(B)$, $X = \Spec(A)$, $\mathcal{F} = \widetilde{M}$,
and $\mathcal{I} = \widetilde{I}$. The assertion of the lemma in this
case boils down to the statement that
$$
I(M_A) = ((IB)M)_A
$$
where $M_A$ indicates the $A$-module associated to the $B$-module $M$.
\end{proof}

\begin{lemma}
\label{lemma-image-affine-finite-morphism-affine-Noetherian}
Let $f : Y \to X$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $f$ finite,
\item $f$ surjective,
\item $Y$ affine, and
\item $X$ Noetherian.
\end{enumerate}
Then $X$ is affine.
\end{lemma}

\begin{proof}
We will prove that under the assumptions of the lemma for any coherent
$\mathcal{O}_X$-module $\mathcal{F}$ we have $H^1(X, \mathcal{F}) = 0$.
This will in particular imply that $H^1(X, \mathcal{I}) = 0$
for every quasi-coherent sheaf of ideals of $\mathcal{O}_X$. Then it
follows that $X$ is affine from either
Lemma \ref{lemma-quasi-compact-h1-zero-covering} or
Lemma \ref{lemma-quasi-separated-h1-zero-covering}.

\medskip\noindent
Let $\mathcal{P}$ be the property of coherent sheaves
$\mathcal{F}$ on $X$ defined by the rule
$$
\mathcal{P}(\mathcal{F}) \Leftrightarrow H^1(X, \mathcal{F}) = 0.
$$
We are going to apply Lemma \ref{lemma-property-higher-rank-cohomological}.
Thus we have to verify (1), (2) and (3) of that lemma for $\mathcal{P}$.
Property (1) follows from the long exact cohomology sequence associated
to a short exact sequence of sheaves. Property (2) follows since
$H^1(X, -)$ is an additive functor. To see (3) let $Z \subset X$ be
an integral closed subscheme with generic point $\xi$.
Let $\mathcal{F}$ be a coherent sheaf on $Y$ such that
the support of $f_*\mathcal{F}$ is equal to $Z$
and $(f_*\mathcal{F})_\xi$ is annihilated by $\mathfrak m_\xi$,
see Lemma \ref{lemma-finite-morphism-Noetherian}. We claim that
taking $\mathcal{G} = f_*\mathcal{F}$ works. We only have to verify
part (3)(c) of Lemma \ref{lemma-property-higher-rank-cohomological}.
Hence assume that $\mathcal{J} \subset \mathcal{O}_X$ is a
quasi-coherent sheaf of ideals such that
$\mathcal{J}_\xi = \mathcal{O}_{X, \xi}$.
A finite morphism is affine hence by
Lemma \ref{lemma-affine-morphism-projection-ideal} we see that
$\mathcal{J}\mathcal{G} = f_*(f^{-1}\mathcal{J}\mathcal{F})$.
Also, as pointed out in the proof of
Lemma \ref{lemma-affine-morphism-projection-ideal} the sheaf
$f^{-1}\mathcal{J}\mathcal{F}$ is a quasi-coherent $\mathcal{O}_Y$-module.
Since $Y$ is affine we see that $H^1(Y, f^{-1}\mathcal{J}\mathcal{F}) = 0$,
see Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}.
Since $f$ is finite, hence affine, we see that
$$
H^1(X, \mathcal{J}\mathcal{G}) =
H^1(X, f_*(f^{-1}\mathcal{J}\mathcal{F})) =
H^1(Y, f^{-1}\mathcal{J}\mathcal{F}) = 0
$$
by Lemma \ref{lemma-relative-affine-cohomology}.
Hence the quasi-coherent subsheaf $\mathcal{G}' = \mathcal{J}\mathcal{G}$
satisfies $\mathcal{P}$. This verifies property (3)(c) of
Lemma \ref{lemma-property-higher-rank-cohomological} as desired.
\end{proof}












\section{Coherent sheaves on Proj, I}
\label{section-coherent-proj}

\noindent
In this section we discuss coherent sheaves on $\text{Proj}(A)$
where $A$ is a Noetherian graded ring generated by $A_1$ over $A_0$.
In the next section we discuss what happens if $A$ is not generated
by degree $1$ elements. First, we formulate an all-in-one result for
projective space over a Noetherian ring.

\begin{lemma}
\label{lemma-coherent-projective}
Let $R$ be a Noetherian ring.
Let $n \geq 0$ be an integer.
For every coherent sheaf $\mathcal{F}$ on $\mathbf{P}^n_R$
we have the following:
\begin{enumerate}
\item There exists an $r \geq 0$ and
$d_1, \ldots, d_r \in \mathbf{Z}$ and a surjection
$$
\bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j)
\longrightarrow
\mathcal{F}.
$$
\item We have $H^i(\mathbf{P}^n_R, \mathcal{F}) = 0$ unless
$0 \leq i \leq n$.
\item For any $i$ the cohomology group $H^i(\mathbf{P}^n_R, \mathcal{F})$
is a finite $R$-module.
\item If $i > 0$, then
$H^i(\mathbf{P}^n_R, \mathcal{F}(d)) = 0$ for all $d$ large enough.
\item For any $k \in \mathbf{Z}$ the graded $R[T_0, \ldots, T_n]$-module
$$
\bigoplus\nolimits_{d \geq k} H^0(\mathbf{P}^n_R, \mathcal{F}(d))
$$
is a finite $R[T_0, \ldots, T_n]$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use that $\mathcal{O}_{\mathbf{P}^n_R}(1)$ is an ample invertible
sheaf on
the scheme $\mathbf{P}^n_R$. This follows directly from the definition
since $\mathbf{P}^n_R$ covered by the standard affine opens $D_{+}(T_i)$.
Hence by
Properties, Proposition \ref{properties-proposition-characterize-ample}
every finite type quasi-coherent $\mathcal{O}_{\mathbf{P}^n_R}$-module
is a quotient of a finite direct sum of tensor powers of
$\mathcal{O}_{\mathbf{P}^n_R}(1)$. On the other hand coherent sheaves
and finite type quasi-coherent sheaves are the same thing on projective
space over $R$ by Lemma \ref{lemma-coherent-Noetherian}. Thus we see (1).

\medskip\noindent
Projective $n$-space $\mathbf{P}^n_R$ is covered by $n + 1$ affines,
namely the standard opens $D_{+}(T_i)$, $i = 0, \ldots, n$, see Constructions,
Lemma \ref{constructions-lemma-standard-covering-projective-space}.
Hence we see that for any quasi-coherent
sheaf $\mathcal{F}$ on $\mathbf{P}^n_R$
we have $H^i(\mathbf{P}^n_R, \mathcal{F}) = 0$ for $i \geq n + 1$,
see Lemma \ref{lemma-vanishing-nr-affines}. Hence (2) holds.

\medskip\noindent
Let us prove (3) and (4) simultaneously for all coherent sheaves
on $\mathbf{P}^n_R$ by descending induction on $i$. Clearly the result
holds for $i \geq n + 1$ by (2). Suppose we know the result for
$i + 1$ and we want to show the result for $i$. (If $i = 0$, then
part (4) is vacuous.) Let $\mathcal{F}$ be a coherent sheaf on
$\mathbf{P}^n_R$. Choose a surjection as in (1) and denote
$\mathcal{G}$ the kernel so that we have a short exact sequence
$$
0 \to \mathcal{G} \to
\bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j)
\to
\mathcal{F} \to 0
$$
By Lemma \ref{lemma-coherent-abelian-Noetherian}
we see that $\mathcal{G}$ is coherent. The long exact
cohomology sequence gives an exact sequence
$$
H^i(\mathbf{P}^n_R, \bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j))
\to
H^i(\mathbf{P}^n_R, \mathcal{F})
\to
H^{i + 1}(\mathbf{P}^n_R, \mathcal{G}).
$$
By induction assumption the right $R$-module is finite and by
Lemma \ref{lemma-cohomology-projective-space-over-ring} the left
$R$-module is finite. Since $R$ is Noetherian it follows immediately
that $H^i(\mathbf{P}^n_R, \mathcal{F})$ is a finite $R$-module.
This proves the induction step for assertion (3).
Since $\mathcal{O}_{\mathbf{P}^n_R}(d)$ is invertible
we see that twisting on $\mathbf{P}^n_R$ is an exact functor (since
you get it by tensoring with an invertible sheaf, see
Constructions, Definition \ref{constructions-definition-twist}).
This means that for all $d \in \mathbf{Z}$ the sequence
$$
0 \to \mathcal{G}(d) \to
\bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j + d)
\to
\mathcal{F}(d) \to 0
$$
is short exact. The resulting cohomology sequence is
$$
H^i(\mathbf{P}^n_R, \bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j + d))
\to
H^i(\mathbf{P}^n_R, \mathcal{F}(d))
\to
H^{i + 1}(\mathbf{P}^n_R, \mathcal{G}(d)).
$$
By induction assumption we see the module on the right is zero
for $d \gg 0$ and by the computation in
Lemma \ref{lemma-cohomology-projective-space-over-ring}
the module on the left is zero as soon as $d \geq -\min\{d_j\}$
and $i \geq 1$. Hence the induction step for assertion (4).
This concludes the proof of (3) and (4).

\medskip\noindent
In order to prove (5) note that for all sufficiently large $d$
the map
$$
H^0(\mathbf{P}^n_R, \bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j + d))
\to
H^0(\mathbf{P}^n_R, \mathcal{F}(d))
$$
is surjective by the vanishing of $H^1(\mathbf{P}^n_R, \mathcal{G}(d))$
we just proved. In other words, the module
$$
M_k
=
\bigoplus\nolimits_{d \geq k} H^0(\mathbf{P}^n_R, \mathcal{F}(d))
$$
is for $k$ large enough a quotient of the corresponding module
$$
N_k
=
\bigoplus\nolimits_{d \geq k} H^0(\mathbf{P}^n_R,
\bigoplus\nolimits_{j = 1, \ldots, r}
\mathcal{O}_{\mathbf{P}^n_R}(d_j + d)
)
$$
When $k$ is sufficiently small (e.g.\ $k < -d_j$ for all $j$) then
$$
N_k = \bigoplus\nolimits_{j = 1, \ldots, r}
R[T_0, \ldots, T_n](d_j)
$$
by our computations in Section \ref{section-cohomology-projective-space}.
In particular it is finitely generated.
Suppose $k \in \mathbf{Z}$ is arbitrary.
Choose $k_{-} \ll k \ll k_{+}$.
Consider the diagram
$$
\xymatrix{
N_{k_{-}} & N_{k_{+}} \ar[d] \ar[l] \\
M_k & M_{k_{+}} \ar[l]
}
$$
where the vertical arrow is the surjective map above and
the horizontal arrows are the obvious inclusion maps.
By what was said above we see that $N_{k_{-}}$ is a finitely
generated $R[T_0, \ldots, T_n]$-module. Hence $N_{k_{+}}$ is
a finitely generated $R[T_0, \ldots, T_n]$-module because it
is a submodule of a finitely generated module and the ring
$R[T_0, \ldots, T_n]$ is Noetherian. Since the vertical arrow
is surjective we conclude that $M_{k_{+}}$ is a finitely
generated $R[T_0, \ldots, T_n]$-module. The quotient
$M_k/M_{k_{+}}$ is finite as an $R$-module since it is a
finite direct sum of the finite $R$-modules
$H^0(\mathbf{P}^n_R, \mathcal{F}(d))$ for $k \leq d < k_{+}$.
Note that we use part (3) for $i = 0$ here. Hence
$M_k/M_{k_{+}}$ is a fortiori a finite $R[T_0, \ldots, T_n]$-module.
In other words, we have sandwiched $M_k$ between two finite
$R[T_0, \ldots, T_n]$-modules and we win.
\end{proof}

\begin{lemma}
\label{lemma-coherent-on-proj}
Let $A$ be a graded ring such that $A_0$ is Noetherian and
$A$ is generated by finitely many elements of $A_1$ over $A_0$.
Set $X = \text{Proj}(A)$. Then $X$ is a Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item There exists an $r \geq 0$ and
$d_1, \ldots, d_r \in \mathbf{Z}$ and a surjection
$$
\bigoplus\nolimits_{j = 1, \ldots, r} \mathcal{O}_X(d_j)
\longrightarrow \mathcal{F}.
$$
\item For any $p$ the cohomology group $H^p(X, \mathcal{F})$ is a finite
$A_0$-module.
\item If $p > 0$, then $H^p(X, \mathcal{F}(d)) = 0$ for all $d$ large enough.
\item For any $k \in \mathbf{Z}$ the graded $A$-module
$$
\bigoplus\nolimits_{d \geq k} H^0(X, \mathcal{F}(d))
$$
is a finite $A$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
By assumption there exists a surjection of graded $A_0$-algebras
$$
A_0[T_0, \ldots, T_n] \longrightarrow A
$$
where $\deg(T_j) = 1$ for $j = 0, \ldots, n$. By Constructions, Lemma
\ref{constructions-lemma-surjective-graded-rings-generated-degree-1-map-proj}
this defines a closed immersion $i : X \to \mathbf{P}^n_{A_0}$
such that $i^*\mathcal{O}_{\mathbf{P}^n_{A_0}}(1) = \mathcal{O}_X(1)$.
In particular, $X$ is Noetherian as a closed subscheme of the Noetherian
scheme $\mathbf{P}^n_{A_0}$. We claim that the results of the lemma for
$\mathcal{F}$ follow from the corresponding
results of Lemma \ref{lemma-coherent-projective} for the coherent sheaf
$i_*\mathcal{F}$ (Lemma \ref{lemma-i-star-equivalence}) on
$\mathbf{P}^n_{A_0}$. For example, by this lemma there
exists a surjection
$$
\bigoplus\nolimits_{j = 1, \ldots, r} \mathcal{O}_{\mathbf{P}^n_{A_0}}(d_j)
\longrightarrow i_*\mathcal{F}.
$$
By adjunction this corresponds to a map
$\bigoplus_{j = 1, \ldots, r} \mathcal{O}_X(d_j) \longrightarrow \mathcal{F}$
which is surjective as well. The statements on cohomology follow from the
fact that
$H^p(X, \mathcal{F}(d)) = H^p(\mathbf{P}^n_{A_0}, i_*\mathcal{F}(d))$
by Lemma \ref{lemma-relative-affine-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-recover-tail-graded-module}
Let $A$ be a graded ring such that $A_0$ is Noetherian and $A$ is generated
by finitely many elements of $A_1$ over $A_0$. Let $M$ be a
finite graded $A$-module. Set $X = \text{Proj}(A)$ and let $\widetilde{M}$
be the quasi-coherent $\mathcal{O}_X$-module on $X$ associated to $M$.
The maps
$$
M_n \longrightarrow \Gamma(X, \widetilde{M}(n))
$$
from Constructions, Lemma \ref{constructions-lemma-apply-modules}
are isomorphisms for all sufficiently large $n$.
\end{lemma}

\begin{proof}
Because $M$ is a finite $A$-module we see that
$\widetilde{M}$ is a finite type $\mathcal{O}_X$-module,
i.e., a coherent $\mathcal{O}_X$-module.
Set $N = \bigoplus_{n \geq 0} \Gamma(X, \widetilde{M}(n))$.
We have to show that the map $M \to N$ of graded $A$-modules
is an isomorphism in all sufficiently large degrees.
By Properties, Lemma \ref{properties-lemma-proj-quasi-coherent}
we have a canonical isomorphism $\widetilde{N} \to \widetilde{M}$
such that $M_n \to N_n = \Gamma(X, \widetilde{M}(n))$
is the canonical map. Let $K = \Ker(M \to N)$ and $Q = \Coker(M \to N)$.
Recall that the functor
$M \mapsto \widetilde{M}$ is exact, see
Constructions, Lemma \ref{constructions-lemma-proj-sheaves}.
Hence we see that $\widetilde{K} = 0$ and $\widetilde{Q} = 0$.
On the other hand, $A$ is a Noetherian ring and $M$ and $N$
are finitely generated $A$-modules (for $N$ this follows from
the last part of Lemma \ref{lemma-coherent-on-proj}).
Hence $K$ and $Q$ are finite $A$-modules. Thus it suffices to show
that a finite $A$-module $K$ with $\widetilde{K} = 0$
has only finitely many nonzero homogeneous parts $K_d$.
To do this, let $x_1, \ldots, x_r \in K$ be homogeneous generators
say sitting in degrees $d_1, \ldots, d_r$.
Let $f_1, \ldots, f_n \in A_1$ be elements generating $A$ over $A_0$.
For each $i$ and $j$ there exists an $n_{ij} \geq 0$ such that
$f_i^{n_{ij}} x_j = 0$ in $K_{d_j + n_{ij}}$: if not then
$x_i/f_i^{d_i} \in K_{(f_i)}$ would not be zero, i.e., $\widetilde{K}$
would not be zero.
Then we see that $K_d$ is zero for $d > \max_j(d_j + \sum_i n_{ij})$
as every element of $K_d$ is a sum of terms where each term is a
monomials in the $f_i$ times one of the $x_j$ of total degree $d$.
\end{proof}

\noindent
Let $A$ be a graded ring such that $A_0$ is Noetherian and $A$ is generated
by finitely many elements of $A_1$ over $A_0$. Recall that
$A_+ = \bigoplus_{n > 0} A_n$ is the irrelevant ideal.
Let $M$ be a graded $A$-module. Recall that
$M$ is an $A_+$-power torsion module if for all $x \in M$
there is an $n \geq 1$ such that $(A_+)^n x = 0$, see
More on Algebra, Definition \ref{more-algebra-definition-f-power-torsion}.
If $M$ is finitely generated, then we see that
this is equivalent to $M_n = 0$ for $n \gg 0$.
Sometimes $A_+$-power torsion modules are called torsion modules.
Sometimes a graded $A$-module $M$ is called torsion free if
$x \in M$ with $(A_+)^n x = 0$, $n > 0$ implies $x = 0$.
Denote $\text{Mod}_A$ the category of graded $A$-modules,
$\text{Mod}^{fg}_A$ the full subcategory of finitely generated ones,
and $\text{Mod}^{fg}_{A, torsion}$ the full subcategory of
modules $M$ such that $M_n = 0$ for $n \gg 0$.

\begin{proposition}
\label{proposition-coherent-modules-on-proj}
Let $A$ be a graded ring such that $A_0$ is Noetherian and $A$ is generated
by finitely many elements of $A_1$ over $A_0$.
Set $X = \text{Proj}(A)$. The functor $M \mapsto \widetilde M$
induces an equivalence
$$
\text{Mod}^{fg}_A/\text{Mod}^{fg}_{A, torsion}
\longrightarrow
\textit{Coh}(\mathcal{O}_X)
$$
whose quasi-inverse is given by
$\mathcal{F} \longmapsto \bigoplus_{n \geq 0} \Gamma(X, \mathcal{F}(n))$.
\end{proposition}

\begin{proof}
The subcategory $\text{Mod}^{fg}_{A, torsion}$ is a Serre subcategory
of $\text{Mod}^{fg}_A$, see
Homology, Definition \ref{homology-definition-serre-subcategory}.
This is clear from the description of objects given above but it also follows
from More on Algebra, Lemma \ref{more-algebra-lemma-I-power-torsion}.
Hence the quotient category on the left of the arrow is defined
in Homology, Lemma \ref{homology-lemma-serre-subcategory-is-kernel}.
To define the functor of the proposition, it suffices to show that
the functor $M \mapsto \widetilde M$ sends torsion modules to $0$.
This is clear because for any $f \in A_+$ homogeneous the
module $M_f$ is zero and hence the value $M_{(f)}$ of $\widetilde M$
on $D_+(f)$ is zero too.

\medskip\noindent
By Lemma \ref{lemma-coherent-on-proj} the proposed quasi-inverse
makes sense. Namely, the lemma shows that
$\mathcal{F} \longmapsto \bigoplus_{n \geq 0} \Gamma(X, \mathcal{F}(n))$
is a functor $\textit{Coh}(\mathcal{O}_X) \to \text{Mod}^{fg}_A$
which we can compose with the quotient functor
$\text{Mod}^{fg}_A \to \text{Mod}^{fg}_A/\text{Mod}^{fg}_{A, torsion}$.

\medskip\noindent
By Lemma \ref{lemma-recover-tail-graded-module}
the composite left to right to left is isomorphic to the identity functor.

\medskip\noindent
Finally, let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Set $M = \bigoplus_{n \in \mathbf{Z}} \Gamma(X, \mathcal{F}(n))$
viewed as a graded $A$-module, so that our functor sends $\mathcal{F}$ to
$M_{\geq 0} = \bigoplus_{n \geq 0} M_n$.
By Properties, Lemma \ref{properties-lemma-proj-quasi-coherent}
the canonical map $\widetilde M \to \mathcal{F}$
is an isomorphism. Since the inclusion map
$M_{\geq 0} \to M$ defines an isomorphism
$\widetilde{M_{\geq 0}} \to \widetilde M$ we conclude that
the composite right to left to right is isomorphic to the identity
functor as well.
\end{proof}





\section{Coherent sheaves on Proj, II}
\label{section-coherent-proj-general}

\noindent
In this section we discuss coherent sheaves on $\text{Proj}(A)$
where $A$ is a Noetherian graded ring. Most of the results will
be deduced by sleight of hand from the corresponding result in the
previous section where we discussed what happens if $A$ is generated
by degree $1$ elements.

\begin{lemma}
\label{lemma-coherent-on-proj-general}
Let $A$ be a Noetherian graded ring. Set $X = \text{Proj}(A)$. Then $X$
is a Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item There exists an $r \geq 0$ and
$d_1, \ldots, d_r \in \mathbf{Z}$ and a surjection
$$
\bigoplus\nolimits_{j = 1, \ldots, r} \mathcal{O}_X(d_j)
\longrightarrow \mathcal{F}.
$$
\item For any $p$ the cohomology group $H^p(X, \mathcal{F})$ is a finite
$A_0$-module.
\item If $p > 0$, then $H^p(X, \mathcal{F}(d)) = 0$ for all $d$ large enough.
\item For any $k \in \mathbf{Z}$ the graded $A$-module
$$
\bigoplus\nolimits_{d \geq k} H^0(X, \mathcal{F}(d))
$$
is a finite $A$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We will prove this by reducing the statement to
Lemma \ref{lemma-coherent-on-proj}.
By Algebra, Lemmas \ref{algebra-lemma-graded-Noetherian} and
\ref{algebra-lemma-S-plus-generated} the ring $A_0$ is Noetherian
and $A$ is generated over $A_0$ by finitely many elements
$f_1, \ldots, f_r$ homogeneous of positive degree.
Let $d = \text{lcm}(\deg(f_i))$. Set $A' = A^{(d)}$ with notation
as in Algebra, Section \ref{algebra-section-graded}.
Observe that $A'$ is generated over $A_0$ by the monomials
$f_1^{e_1} \ldots f_r^{e_r} \in A'_1 = A_d$ with $\sum e_i = d$.
Thus Lemma \ref{lemma-coherent-on-proj} applies to $X' = \text{Proj}(A')$.

\medskip\noindent
By Constructions, Lemma \ref{constructions-lemma-d-uple} there exist
an isomorphism of schemes $i : X \to X'$ and
isomorphisms $\mathcal{O}_X(nd) \to i^*\mathcal{O}_{X'}(n)$
compatible with the map $A' \to A$ and the maps
$A_n \to H^0(X, \mathcal{O}_X(n)$ and $A'_n \to H^0(X', \mathcal{O}_{X'}(n))$.
Thus Lemma \ref{lemma-coherent-on-proj} implies $X$ is Noetherian and that
(1) and (2) hold. To see (3) and (4)
we can use that for any fixed $k$, $p$, and $q$ we have
$$
\bigoplus\nolimits_{dn + q \geq k} H^p(X, \mathcal{F}(dn + q)) =
\bigoplus\nolimits_{dn + q \geq k} H^p(X', (i_*\mathcal{F}(q))(n)
$$
by the compatibilities above. If $p > 0$, we have the vanishing of the right
hand side for $k$ depending on $q$ large enough by
Lemma \ref{lemma-coherent-on-proj}. Since there are only a finite number
of congruence classes of integers modulo $d$, we see that (3) holds for
$\mathcal{F}$ on $X$. If $p = 0$, then we have that the right hand side
is a finite $A'$-module by Lemma \ref{lemma-coherent-on-proj}. Using
the finiteness of congruence classes once more, we find that
$\bigoplus_{n \geq k} H^0(X, \mathcal{F}(n))$ is a finite $A'$-module too.
Since the $A'$-module structure comes from the $A$-module structure
(by the compatibilities mentioned above), we conclude it is finite
as an $A$-module as well.
\end{proof}

\begin{lemma}
\label{lemma-recover-tail-graded-module-general}
Let $A$ be a Noetherian graded ring and let $d$ be the lcm of generators
of $A$ over $A_0$. Let $M$ be a finite graded $A$-module.
Set $X = \text{Proj}(A)$ and let $\widetilde{M}$ be
the quasi-coherent $\mathcal{O}_X$-module on $X$ associated to $M$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item $N' = \bigoplus_{n \geq k} H^0(X, \widetilde{M(n)})$
is a finite $A$-module,
\item $N = \bigoplus_{n \geq k} H^0(X, \widetilde{M}(n))$
is a finite $A$-module,
\item there is a canonical map $N \to N'$,
\item if $k$ is small enough there is a canonical map $M \to N'$,
\item the map $M_n \to N'_n$ is an isomorphism for $n \gg 0$,
\item $N_n \to N'_n$ is an isomorphism for $d | n$.
\end{enumerate}
\end{lemma}

\begin{proof}
The map $N \to N'$ in (3) comes from
Constructions, Equation (\ref{constructions-equation-multiply-more-generally})
by taking global sections.

\medskip\noindent
By
Constructions, Equation
(\ref{constructions-equation-global-sections-more-generally})
there is a map of graded $A$-modules
$M \to \bigoplus_{n \in \mathbf{Z}} H^0(X, \widetilde{M(n)})$.
If the generators of $M$ sit in degrees $\geq k$, then the image
is contained in the submodule
$N' \subset \bigoplus_{n \in \mathbf{Z}} H^0(X, \widetilde{M(n)})$
and we get the map in (4).

\medskip\noindent
By Algebra, Lemmas \ref{algebra-lemma-graded-Noetherian} and
\ref{algebra-lemma-S-plus-generated} the ring $A_0$ is Noetherian
and $A$ is generated over $A_0$ by finitely many elements
$f_1, \ldots, f_r$ homogeneous of positive degree.
Let $d = \text{lcm}(\deg(f_i))$. Then we see that (6) holds
for example by
Constructions, Lemma \ref{constructions-lemma-where-invertible}.

\medskip\noindent
Because $M$ is a finite $A$-module we see that
$\widetilde{M}$ is a finite type $\mathcal{O}_X$-module,
i.e., a coherent $\mathcal{O}_X$-module.
Thus part (2) follows from Lemma \ref{lemma-coherent-on-proj-general}.

\medskip\noindent
We will deduce (1) from (2) using a trick. For $q \in \{0, \ldots, d - 1\}$
write
$$
{}^qN = \bigoplus\nolimits_{n + q \geq k} H^0(X, \widetilde{M(q)}(n))
$$
By part (2) these are finite $A$-modules. The Noetherian ring $A$
is finite over $A^{(d)} = \bigoplus_{n \geq 0} A_{dn}$, because
it is generated by $f_i$ over $A^{(d)}$ and $f_i^d \in A^{(d)}$.
Hence ${}^qN$ is a finite $A^{(d)}$-module.
Moreover, $A^{(d)}$ is Noetherian (follows from
Algebra, Lemma \ref{algebra-lemma-dehomogenize-finite-type}).
It follows that the $A^{(d)}$-submodule
${}^qN^{(d)} = \bigoplus_{n \in \mathbf{Z}} {}^qN_{dn}$
is a finite module over $A^{(d)}$. Using the isomorphisms
$\widetilde{M(dn + q)} = \widetilde{M(q)}(dn)$ we can write
$$
N' =
\bigoplus\nolimits_{q \in \{0, \ldots, d - 1\}}
\bigoplus\nolimits_{dn + q \geq k}
H^0(X, \widetilde{M(q)}(dn)) =
\bigoplus\nolimits_{q \in \{0, \ldots, d - 1\}} {}^qN^{(d)}
$$
Thus $N'$ is finite over $A^{(d)}$ and a fortiori finite over $A$.
Thus (1) is true.

\medskip\noindent
Let $K$ be a finite $A$-module such that $\widetilde{K} = 0$. We claim
that $K_n = 0$ for $d|n$ and $n \gg 0$. Arguing as above we see that
$K^{(d)}$ is a finite $A^{(d)}$-module. Let
$x_1, \ldots, x_m \in K$ be homogeneous generators of $K^{(d)}$
over $A^{(d)}$, say sitting in degrees $d_1, \ldots, d_m$ with $d | d_j$.
For each $i$ and $j$ there exists an $n_{ij} \geq 0$ such that
$f_i^{n_{ij}} x_j = 0$ in $K_{d_j + n_{ij}}$: if not then
$x_j/f_i^{d_i/\deg(f_i)} \in K_{(f_i)}$ would not be zero, i.e.,
$\widetilde{K}$ would not be zero. Here we use that $\deg(f_i) | d | d_j$
for all $i, j$. We conclude that $K_n$ is zero for
$n$ with $d | n$ and $n > \max_j (d_j + \sum_i n_{ij} \deg(f_i))$
as every element of $K_n$ is a sum of terms where each term is a
monomials in the $f_i$ times one of the $x_j$ of total degree $n$.

\medskip\noindent
To finish the proof, we have to show that $M \to N'$ is an isomorphism
in all sufficiently large degrees. The map $N \to N'$ induces an
isomorphism $\widetilde{N} \to \widetilde{N'}$ because on the affine
opens $D_+(f_i) = D_+(f_i^d)$ the corresponding modules are isomorphic:
$N_{(f_i)} \cong N_{(f_i^d)} \cong N'_{(f_i^d)} \cong N'_{(f_i)}$
by property (6).
By Properties, Lemma \ref{properties-lemma-proj-quasi-coherent}
we have a canonical isomorphism $\widetilde{N} \to \widetilde{M}$.
The composition $\widetilde{N} \to \widetilde{M} \to \widetilde{N'}$
is the isomorphism above (proof omitted; hint: look on standard
affine opens to check this). Thus the map $M \to N'$ induces an isomorphism
$\widetilde{M} \to \widetilde{N'}$.
Let $K = \Ker(M \to N')$ and $Q = \Coker(M \to N')$.
Recall that the functor
$M \mapsto \widetilde{M}$ is exact, see
Constructions, Lemma \ref{constructions-lemma-proj-sheaves}.
Hence we see that $\widetilde{K} = 0$ and $\widetilde{Q} = 0$.
By the result of the previous paragraph we see that $K_n = 0$ and
$Q_n = 0$ for $d | n$ and $n \gg 0$. At this point we finally see
the advantage of using $N'$ over $N$: the functor $M \leadsto N'$
is compatible with shifts (immediate from the construction).
Thus, repeating the whole argument with $M$ replaced by $M(q)$
we find that $K_n = 0$ and $Q_n = 0$ for $n \equiv q \bmod d$
and $n \gg 0$. Since there are
only finitely many congruence classes modulo $n$ the proof is finished.
\end{proof}

\noindent
Let $A$ be a Noetherian graded ring. Recall that
$A_+ = \bigoplus_{n > 0} A_n$ is the irrelevant ideal.
By Algebra, Lemmas \ref{algebra-lemma-graded-Noetherian} and
\ref{algebra-lemma-S-plus-generated} the ring $A_0$ is Noetherian
and $A$ is generated over $A_0$ by finitely many elements
$f_1, \ldots, f_r$ homogeneous of positive degree.
Let $d = \text{lcm}(\deg(f_i))$. Let $M$ be a graded $A$-module.
In this situation we say a homogeneous element $x \in M$
is {\it irrelevant}\footnote{This is nonstandard notation.} if
$$
(A_+ x)_{nd} = 0\text{ for all }n \gg 0
$$
If $x \in M$ is homogeneous and irrelevant and $f \in A$
is homogeneous, then $fx$ is irrelevant too. Hence
the set of irrelevant elements generate a graded submodule
$M_{irrelevant} \subset M$. We will say $M$ is {\it irrelevant}
if every homogeneous element of $M$ is irrelevant, i.e.,
if $M_{irrelevant} = M$.
If $M$ is finitely generated, then we see that
this is equivalent to $M_{nd} = 0$ for $n \gg 0$.
Denote $\text{Mod}_A$ the category of graded $A$-modules,
$\text{Mod}^{fg}_A$ the full subcategory of finitely generated ones,
and $\text{Mod}^{fg}_{A, irrelevant}$ the full subcategory of
irrelevant modules.

\begin{proposition}
\label{proposition-coherent-modules-on-proj-general}
Let $A$ be a Noetherian graded ring. Set $X = \text{Proj}(A)$. The functor
$M \mapsto \widetilde M$ induces an equivalence
$$
\text{Mod}^{fg}_A/\text{Mod}^{fg}_{A, irrelevant}
\longrightarrow
\textit{Coh}(\mathcal{O}_X)
$$
whose quasi-inverse is given by
$\mathcal{F} \longmapsto \bigoplus_{n \geq 0} \Gamma(X, \mathcal{F}(n))$.
\end{proposition}

\begin{proof}
We urge the reader to read the proof in the case where $A$
is generated in degree $1$ first, see
Proposition \ref{proposition-coherent-modules-on-proj}.
Let $f_1, \ldots, f_r \in A$ be homogeneous elements of positive degree
which generate $A$ over $A_0$. Let $d$ be the lcm of the degrees
$d_i$ of $f_i$. Let $M$ be a finite $A$-module.
Let us show that $\widetilde{M}$ is zero if and
only if $M$ is an irrelevant graded $A$-module (as defined above
the statement of the proposition). Namely, let $x \in M$ be a
homogeneous element.
Choose $k \in \mathbf{Z}$ sufficiently small and let
$N \to N'$ and $M \to N'$ be as in
Lemma \ref{lemma-recover-tail-graded-module-general}.
We may also pick $l$ sufficiently large such that
$M_n \to N_n$ is an isomorphism for $n \geq l$.
If $\widetilde{M}$ is zero, then $N = 0$.
Thus for any $f \in A_+$ homogeneous with
$\deg(f) + \deg(x) = nd$ and $nd > l$ we see that $fx$ is zero
because $N_{nd} \to N'_{nd}$ and $M_{nd} \to N'_{nd}$ are isomorphisms.
Hence $x$ is irrelevant.
Conversely, assume $M$ is irrelevant. Then $M_{nd}$ is zero
for $n \gg 0$ (see discussion above proposition).
Clearly this implies that $M_{(f_i)} = M_{(f_i^{d/\deg(f_i)})} = 0$,
whence $\widetilde{M} = 0$ by construction.

\medskip\noindent
It follows that the subcategory $\text{Mod}^{fg}_{A, irrelevant}$
is a Serre subcategory of $\text{Mod}^{fg}_A$ as the kernel
of the exact functor $M \mapsto \widetilde M$, see
Homology, Lemma \ref{homology-lemma-kernel-exact-functor}
and Constructions, Lemma \ref{constructions-lemma-proj-sheaves}.
Hence the quotient category on the left of the arrow is defined
in Homology, Lemma \ref{homology-lemma-serre-subcategory-is-kernel}.
To define the functor of the proposition, it suffices to show that
the functor $M \mapsto \widetilde M$ sends irrelevant modules to $0$
which we have shown above.

\medskip\noindent
By Lemma \ref{lemma-coherent-on-proj-general} the proposed quasi-inverse
makes sense. Namely, the lemma shows that
$\mathcal{F} \longmapsto \bigoplus_{n \geq 0} \Gamma(X, \mathcal{F}(n))$
is a functor $\textit{Coh}(\mathcal{O}_X) \to \text{Mod}^{fg}_A$
which we can compose with the quotient functor
$\text{Mod}^{fg}_A \to \text{Mod}^{fg}_A/\text{Mod}^{fg}_{A, irrelevant}$.

\medskip\noindent
By Lemma \ref{lemma-recover-tail-graded-module-general}
the composite left to right to left is isomorphic to the identity functor.
Namely, let $M$ be a finite graded $A$-module and let
$k \in \mathbf{Z}$ sufficiently small and let
$N \to N'$ and $M \to N'$ be as in
Lemma \ref{lemma-recover-tail-graded-module-general}.
Then the kernel and cokernel of $M \to N'$ are nonzero in
only finitely many degrees, hence are irrelevant. Moreover, the
kernel and cokernel of the map $N \to N'$ are zero in all sufficiently
large degrees divisible by $d$, hence these are irrelevant modules too.
Thus $M \to N'$ and $N \to N'$ are both isomorphisms in the quotient
category, as desired.

\medskip\noindent
Finally, let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Set $M = \bigoplus_{n \in \mathbf{Z}} \Gamma(X, \mathcal{F}(n))$
viewed as a graded $A$-module, so that our functor sends $\mathcal{F}$ to
$M_{\geq 0} = \bigoplus_{n \geq 0} M_n$.
By Properties, Lemma \ref{properties-lemma-proj-quasi-coherent}
the canonical map $\widetilde M \to \mathcal{F}$
is an isomorphism. Since the inclusion map
$M_{\geq 0} \to M$ defines an isomorphism
$\widetilde{M_{\geq 0}} \to \widetilde M$ we conclude that
the composite right to left to right is isomorphic to the identity
functor as well.
\end{proof}










\section{Higher direct images along projective morphisms}
\label{section-projective-pushforward}

\noindent
We first state and prove a result for when the base is affine
and then we deduce some results for projective morphisms.

\begin{lemma}
\label{lemma-coherent-proper-ample}
Let $R$ be a Noetherian ring. Let $X \to \Spec(R)$ be a proper morphism.
Let $\mathcal{L}$ be an ample invertible sheaf on $X$. Let $\mathcal{F}$
be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The graded ring
$A = \bigoplus_{d \geq 0} H^0(X, \mathcal{L}^{\otimes d})$
is a finitely generated $R$-algebra.
\item There exists an $r \geq 0$ and
$d_1, \ldots, d_r \in \mathbf{Z}$ and a surjection
$$
\bigoplus\nolimits_{j = 1, \ldots, r} \mathcal{L}^{\otimes d_j}
\longrightarrow \mathcal{F}.
$$
\item For any $p$ the cohomology group $H^p(X, \mathcal{F})$ is a finite
$R$-module.
\item If $p > 0$, then
$H^p(X, \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes d}) = 0$
for all $d$ large enough.
\item For any $k \in \mathbf{Z}$ the graded $A$-module
$$
\bigoplus\nolimits_{d \geq k}
H^0(X, \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes d})
$$
is a finite $A$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Morphisms, Lemma \ref{morphisms-lemma-finite-type-over-affine-ample-very-ample}
there exists a $d > 0$ and an immersion $i : X \to \mathbf{P}^n_R$
such that $\mathcal{L}^{\otimes d} \cong i^*\mathcal{O}_{\mathbf{P}^n_R}(1)$.
Since $X$ is proper over $R$ the morphism $i$ is a closed immersion
(Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}).
Thus we have $H^i(X, \mathcal{G}) = H^i(\mathbf{P}^n_R, i_*\mathcal{G})$
for any quasi-coherent sheaf $\mathcal{G}$ on $X$
(by Lemma \ref{lemma-relative-affine-cohomology} and the fact that
closed immersions are affine, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-affine}).
Moreover, if $\mathcal{G}$ is coherent, then $i_*\mathcal{G}$
is coherent as well (Lemma \ref{lemma-i-star-equivalence}).
We will use these facts without further mention.

\medskip\noindent
Proof of (1). Set $S = R[T_0, \ldots, T_n]$ so that
$\mathbf{P}^n_R = \text{Proj}(S)$.
Observe that $A$ is an $S$-algebra (but the ring map $S \to A$ is not
a homomorphism of graded rings because $S_n$ maps into $A_{dn}$).
By the projection formula
(Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
we have
$$
i_*(\mathcal{L}^{\otimes nd + q}) =
i_*(\mathcal{L}^{\otimes q})
\otimes_{\mathcal{O}_{\mathbf{P}^n_R}}
\mathcal{O}_{\mathbf{P}^n_R}(n)
$$
for all $n \in \mathbf{Z}$. We conclude that $\bigoplus_{n \geq 0} A_{nd + q}$
is a finite graded $S$-module by Lemma \ref{lemma-coherent-projective}.
Since
$A = \bigoplus_{q \in \{0, \ldots, d - 1} \bigoplus_{n \geq 0} A_{nd + q}$
we see that $A$ is finite as an $S$-algebra, hence (1) is true.

\medskip\noindent
Proof of (2). This follows from
Properties, Proposition \ref{properties-proposition-characterize-ample}.

\medskip\noindent
Proof of (3). Apply Lemma \ref{lemma-coherent-projective}
and use $H^p(X, \mathcal{F}) = H^p(\mathbf{P}^n_R, i_*\mathcal{F})$.

\medskip\noindent
Proof of (4). Fix $p > 0$. By the projection formula we have
$$
i_*(\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes nd + q}) =
i_*(\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes q})
\otimes_{\mathcal{O}_{\mathbf{P}^n_R}}
\mathcal{O}_{\mathbf{P}^n_R}(n)
$$
for all $n \in \mathbf{Z}$. By Lemma \ref{lemma-coherent-projective}
we conclude that $H^p(X, \mathcal{F} \otimes \mathcal{L}^{nd + q}) = 0$
for $n \gg 0$. Since there are only finitely many congruence classes
of integers modulo $d$ this proves (4).

\medskip\noindent
Proof of (5). Fix an integer $k$. Set
$M = \bigoplus_{n \geq k} H^0(X, \mathcal{F} \otimes \mathcal{L}^{\otimes n})$.
Arguing as above we conclude that $\bigoplus_{nd + q \geq k} A_{nd + q}$
is a finite graded $S$-module. Since
$M = \bigoplus_{q \in \{0, \ldots, d - 1\}}
\bigoplus_{nd + q \geq k} M_{nd + q}$
we see that $M$ is finite as an $S$-module. Since the $S$-module structure
factors through the ring map $S \to A$, we conclude that $M$ is finite
as an $A$-module.
\end{proof}

\begin{lemma}
\label{lemma-kill-by-twisting}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume that
\begin{enumerate}
\item $S$ is Noetherian,
\item $f$ is proper,
\item $\mathcal{F}$ is coherent, and
\item $\mathcal{L}$ is relatively ample on $X/S$.
\end{enumerate}
Then there exists an $n_0$ such that for all $n \geq n_0$
we have
$$
R^pf_*\left(\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}\right)
=
0
$$
for all $p > 0$.
\end{lemma}

\begin{proof}
Choose a finite affine open covering $S = \bigcup V_j$ and
set $X_j = f^{-1}(V_j)$.
Clearly, if we solve the question for each of the finitely many
systems $(X_j \to V_j, \mathcal{L}|_{X_j}, \mathcal{F}|_{V_j})$
then the result follows. Thus we may assume $S$ is affine.
In this case the vanishing of
$R^pf_*(\mathcal{F} \otimes \mathcal{L}^{\otimes n})$
is equivalent to the vanishing of
$H^p(X, \mathcal{F} \otimes \mathcal{L}^{\otimes n})$, see
Lemma \ref{lemma-quasi-coherence-higher-direct-images-application}.
Thus the required vanishing follows
from Lemma \ref{lemma-coherent-proper-ample} (which applies because
$\mathcal{L}$ is ample on $X$ by Morphisms, Lemma
\ref{morphisms-lemma-finite-type-over-affine-ample-very-ample}).
\end{proof}

\begin{lemma}
\label{lemma-locally-projective-pushforward}
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a locally projective morphism.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then $R^if_*\mathcal{F}$ is a coherent $\mathcal{O}_S$-module
for all $i \geq 0$.
\end{lemma}

\begin{proof}
We first remark that a locally projective morphism is proper
(Morphisms, Lemma \ref{morphisms-lemma-locally-projective-proper})
and hence of finite type.
In particular $X$ is locally Noetherian
(Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian})
and hence the statement makes sense.
Moreover, by Lemma \ref{lemma-quasi-coherence-higher-direct-images}
the sheaves $R^pf_*\mathcal{F}$ are quasi-coherent.

\medskip\noindent
Having said this the statement is local on $S$ (for example by
Cohomology, Lemma \ref{cohomology-lemma-localize-higher-direct-images}).
Hence we may assume $S = \Spec(R)$ is the spectrum of
a Noetherian ring, and $X$ is a closed subscheme of
$\mathbf{P}^n_R$ for some $n$, see
Morphisms, Lemma \ref{morphisms-lemma-characterize-locally-projective}.
In this case, the sheaves $R^pf_*\mathcal{F}$ are the quasi-coherent
sheaves associated to the $R$-modules $H^p(X, \mathcal{F})$, see
Lemma \ref{lemma-quasi-coherence-higher-direct-images-application}.
Hence it suffices to show that $R$-modules $H^p(X, \mathcal{F})$
are finite $R$-modules (Lemma \ref{lemma-coherent-Noetherian}).
This follows from Lemma \ref{lemma-coherent-proper-ample}
(because the restriction of $\mathcal{O}_{\mathbf{P}^n_R}(1)$
to $X$ is ample on $X$).
\end{proof}








\section{Ample invertible sheaves and cohomology}
\label{section-ample-cohomology}

\noindent
Here is a criterion for ampleness on proper schemes over affine bases
in terms of vanishing of cohomology after twisting.

\begin{lemma}
\label{lemma-vanshing-gives-ample}
Let $R$ be a Noetherian ring. Let $f : X \to \Spec(R)$ be a proper morphism.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The following are equivalent
\begin{enumerate}
\item $\mathcal{L}$ is ample on $X$ (this is equivalent to many other
things, see
Properties, Proposition \ref{properties-proposition-characterize-ample} and
Morphisms, Lemma
\ref{morphisms-lemma-finite-type-over-affine-ample-very-ample}),
\item for every coherent $\mathcal{O}_X$-module $\mathcal{F}$ there exists
an $n_0 \geq 0$ such that
$H^p(X, \mathcal{F} \otimes \mathcal{L}^{\otimes n}) = 0$ for all $n \geq n_0$
and $p > 0$, and
\item for every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$, there exists an $n \geq 1$
such that $H^1(X, \mathcal{I} \otimes \mathcal{L}^{\otimes n}) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows from
Lemma \ref{lemma-coherent-proper-ample}.
The implication (2) $\Rightarrow$ (3) is trivial.
The implication (3) $\Rightarrow$ (1) is
Lemma \ref{lemma-quasi-compact-h1-zero-invertible}.
\end{proof}

\begin{lemma}
\label{lemma-surjective-finite-morphism-ample}
Let $R$ be a Noetherian ring. Let $f : Y \to X$ be a morphism of
schemes proper over $R$. Let $\mathcal{L}$ be an
invertible $\mathcal{O}_X$-module. Assume $f$ is finite and surjective.
Then $\mathcal{L}$ is ample if and only if $f^*\mathcal{L}$ is ample.
\end{lemma}

\begin{proof}
The pullback of an ample invertible sheaf by a quasi-affine morphism
is ample, see Morphisms, Lemma
\ref{morphisms-lemma-pullback-ample-tensor-relatively-ample}.
This proves one of the implications as a finite morphism is affine
by definition. To prove the other we will use
the criterion of Lemma \ref{lemma-vanshing-gives-ample}.

\medskip\noindent
Assume that $f^*\mathcal{L}$ is ample. Let $P$ be the following property on
coherent $\mathcal{O}_X$-modules $\mathcal{F}$: there exists an $n_0$
such that $H^p(X, \mathcal{F} \otimes \mathcal{L}^{\otimes n}) = 0$
for all $n \geq n_0$ and $p > 0$. We will prove that $P$ holds
for any coherent $\mathcal{O}_X$-module $\mathcal{F}$, which suffices
to prove that $\mathcal{L}$ is ample.
We are going to apply Lemma \ref{lemma-property-higher-rank-cohomological}.
Thus we have to verify (1), (2) and (3) of that lemma for $P$.
Property (1) follows from the long exact cohomology sequence associated
to a short exact sequence of sheaves and the fact that tensoring with
an invertible sheaf is an exact functor. Property (2) follows since
$H^p(X, -)$ is an additive functor. To see (3) let $Z \subset X$ be
an integral closed subscheme with generic point $\xi$.
Let $\mathcal{F}$ be a coherent sheaf on $Y$ such that
the support of $f_*\mathcal{F}$ is equal to $Z$
and $(f_*\mathcal{F})_\xi$ is annihilated by $\mathfrak m_\xi$,
see Lemma \ref{lemma-finite-morphism-Noetherian}. We claim that
taking $\mathcal{G} = f_*\mathcal{F}$ works. We only have to verify
part (3)(c) of Lemma \ref{lemma-property-higher-rank-cohomological}.
Hence assume that $\mathcal{J} \subset \mathcal{O}_X$ is a
quasi-coherent sheaf of ideals such that
$\mathcal{J}_\xi = \mathcal{O}_{X, \xi}$.
A finite morphism is affine hence by
Lemma \ref{lemma-affine-morphism-projection-ideal} we see that
$\mathcal{J}\mathcal{G} = f_*(f^{-1}\mathcal{J}\mathcal{F})$.
Also, as pointed out in the proof of
Lemma \ref{lemma-affine-morphism-projection-ideal} the sheaf
$f^{-1}\mathcal{J}\mathcal{F}$ is a coherent $\mathcal{O}_Y$-module.
By assumption we see that there exists an $n_0$ such that
$$
H^p(Y, f^{-1}\mathcal{J}\mathcal{F}
\otimes_{\mathcal{O}_Y} f^*\mathcal{L}^{\otimes n}) = 0,
$$
for $n \geq n_0$ and $p > 0$. Since $f$ is finite, hence affine, we see that
\begin{align*}
H^p(X, \mathcal{J}\mathcal{G} \otimes_{\mathcal{O}_X}
\mathcal{L}^{\otimes n})
& =
H^p(X, f_*(f^{-1}\mathcal{J}\mathcal{F}) \otimes_{\mathcal{O}_X}
\mathcal{L}^{\otimes n}) \\
& =
H^p(X, f_*(f^{-1}\mathcal{J}\mathcal{F}) \otimes_{\mathcal{O}_Y}
f^*\mathcal{L}^{\otimes n})) \\
& =
H^p(Y, f^{-1}\mathcal{J}\mathcal{F} \otimes_{\mathcal{O}_Y}
f^*\mathcal{L}^{\otimes n}) = 0
\end{align*}
by references cited earlier in this proof.
Hence the quasi-coherent subsheaf $\mathcal{G}' = \mathcal{J}\mathcal{G}$
satisfies $P$. This verifies property (3)(c) of
Lemma \ref{lemma-property-higher-rank-cohomological} as desired.
\end{proof}

\noindent
Cohomology is functorial. In particular, given a ringed space $X$,
an invertible $\mathcal{O}_X$-module $\mathcal{L}$, a section
$s \in \Gamma(X, \mathcal{L})$ we get maps
$$
H^p(X, \mathcal{F})
\longrightarrow
H^p(X, \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}), \quad
\xi \longmapsto s\xi
$$
induced by the map
$\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
which is multiplication by $s$. We set
$\Gamma_*(X, \mathcal{L}) =
\bigoplus_{n \geq 0} \Gamma(X, \mathcal{L}^{\otimes n})$
as a graded ring, see
Modules, Definition \ref{modules-definition-gamma-star}.
Given a sheaf of $\mathcal{O}_X$-modules $\mathcal{F}$ and an integer
$p \geq 0$ we set
$$
H^p_*(X, \mathcal{L}, \mathcal{F}) =
\bigoplus\nolimits_{n \in \mathbf{Z}} H^p(X,
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n})
$$
This is a graded $\Gamma_*(X, \mathcal{L})$-module by the multiplication
defined above. Warning: the notation $H^p_*(X, \mathcal{L}, \mathcal{F})$
is nonstandard.

\begin{lemma}
\label{lemma-invert-s-cohomology}
Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible sheaf on $X$.
Let $s \in \Gamma(X, \mathcal{L})$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $X$ is quasi-compact and quasi-separated, the canonical map
$$
H^p_*(X, \mathcal{L}, \mathcal{F})_{(s)}
\longrightarrow
H^p(X_s, \mathcal{F})
$$
which maps $\xi/s^n$ to $s^{-n}\xi$ is an isomorphism.
\end{lemma}

\begin{proof}
Note that for $p = 0$ this is
Properties, Lemma \ref{properties-lemma-invert-s-sections}.
We will prove the statement using the induction
principle (Lemma \ref{lemma-induction-principle}) where for
$U \subset X$ quasi-compact open we let $P(U)$ be the property:
for all $p \geq 0$ the map
$$
H^p_*(U, \mathcal{L}, \mathcal{F})_{(s)}
\longrightarrow
H^p(U_s, \mathcal{F})
$$
is an isomorphism.

\medskip\noindent
If $U$ is affine, then both sides of the arrow displayed above
are zero for $p > 0$ by
Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}
and
Properties, Lemma \ref{properties-lemma-affine-cap-s-open}
and the statement is true. If $P$ is true for $U$, $V$, and $U \cap V$,
then we can use the Mayer-Vietoris sequences
(Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris}) to obtain
a map of long exact sequences
$$
\xymatrix{
H^{p - 1}_*(U \cap V, \mathcal{L}, \mathcal{F})_{(s)} \ar[r] \ar[d] &
H^p_*(U \cup V, \mathcal{L}, \mathcal{F})_{(s)} \ar[r] \ar[d] &
H^p_*(U, \mathcal{L}, \mathcal{F})_{(s)}
\oplus
H^p_*(V, \mathcal{L}, \mathcal{F})_{(s)} \ar[d] \\
H^{p - 1}(U_s \cap V_s, \mathcal{F}) \ar[r]&
H^p(U_s \cup V_s, \mathcal{F}) \ar[r] &
H^p(U_s, \mathcal{F})
\oplus
H^p(V_s, \mathcal{F})
}
$$
(only a snippet shown). Observe that $U_s \cap V_s = (U \cap V)_s$ and
that $U_s \cup V_s = (U \cup V)_s$. Thus the left and right vertical
maps are isomorphisms (as well as one more to the right and one more
to the left which are not shown in the diagram).
We conclude that $P(U \cup V)$ holds by
the 5-lemma (Homology, Lemma \ref{homology-lemma-five-lemma}).
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-section-affine-open-kills-classes}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a section.
Assume that
\begin{enumerate}
\item $X$ is quasi-compact and quasi-separated, and
\item $X_s$ is affine.
\end{enumerate}
Then for every quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ and
every $p > 0$ and all $\xi \in H^p(X, \mathcal{F})$ there exists
an $n \geq 0$ such that $s^n\xi = 0$ in
$H^p(X, \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n})$.
\end{lemma}

\begin{proof}
Recall that $H^p(X_s, \mathcal{G})$ is zero for every quasi-coherent
module $\mathcal{G}$ by
Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}.
Hence the lemma follows from
Lemma \ref{lemma-invert-s-cohomology}.
\end{proof}

\noindent
For a more general version of the following lemma see
Limits, Lemma \ref{limits-lemma-ample-on-reduction}.

\begin{lemma}
\label{lemma-ample-on-reduction}
Let $i : Z \to X$ be a closed immersion of Noetherian schemes
inducing a homeomorphism of underlying topological spaces.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Then $i^*\mathcal{L}$ is ample on $Z$, if and only if
$\mathcal{L}$ is ample on $X$.
\end{lemma}

\begin{proof}
If $\mathcal{L}$ is ample, then $i^*\mathcal{L}$ is ample for
example by Morphisms, Lemma
\ref{morphisms-lemma-pullback-ample-tensor-relatively-ample}.
Assume $i^*\mathcal{L}$ is ample. We have to show that $\mathcal{L}$
is ample on $X$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the coherent sheaf of ideals
cutting out the closed subscheme $Z$. Since $i(Z) = X$ set theoretically
we see that $\mathcal{I}^n = 0$ for some $n$ by
Lemma \ref{lemma-power-ideal-kills-sheaf}.
Consider the sequence
$$
X = Z_n \supset Z_{n - 1} \supset Z_{n - 2} \supset \ldots \supset Z_1 = Z
$$
of closed subschemes cut out by
$0 = \mathcal{I}^n \subset \mathcal{I}^{n - 1} \subset \ldots \subset
\mathcal{I}$. Then each of the closed immersions $Z_i \to Z_{i - 1}$
is defined by a coherent sheaf of ideals of square zero. In this way
we reduce to the case that $\mathcal{I}^2 = 0$.

\medskip\noindent
Consider the short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{O}_X \to i_*\mathcal{O}_Z \to 0
$$
of quasi-coherent $\mathcal{O}_X$-modules. Tensoring with
$\mathcal{L}^{\otimes n}$ we obtain short exact sequences
\begin{equation}
\label{equation-ses}
0 \to \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}
\to \mathcal{L}^{\otimes n} \to i_*i^*\mathcal{L}^{\otimes n} \to 0
\end{equation}
As $\mathcal{I}^2 = 0$, we can use
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}
to think of $\mathcal{I}$ as a quasi-coherent $\mathcal{O}_Z$-module
and then $\mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n} =
\mathcal{I} \otimes_{\mathcal{O}_Z} i^*\mathcal{L}^{\otimes n}$ with
obvious abuse of notation.
Moreover, the cohomology of this sheaf over $Z$ is canonically
the same as the cohomology of this sheaf over $X$ (as $i$ is a
homeomorphism).

\medskip\noindent
Let $x \in X$ be a point and denote $z \in Z$ the corresponding point.
Because $i^*\mathcal{L}$ is ample there exists an $n$ and a section
$s \in \Gamma(Z, i^*\mathcal{L}^{\otimes n})$ with $z \in Z_s$
and with $Z_s$ affine. The obstruction to lifting $s$ to a section
of $\mathcal{L}^{\otimes n}$ over $X$ is the boundary
$$
\xi = \partial s \in
H^1(X, \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}) =
H^1(Z, \mathcal{I} \otimes_{\mathcal{O}_Z} i^*\mathcal{L}^{\otimes n})
$$
coming from the short exact sequence of sheaves (\ref{equation-ses}).
If we replace $s$ by $s^{e + 1}$ then $\xi$ is replaced by
$\partial(s^{e + 1}) = (e + 1) s^e \xi$ in
$H^1(Z, \mathcal{I} \otimes_{\mathcal{O}_Z} i^*\mathcal{L}^{\otimes (e + 1)n})$
because the boundary map for
$$
0 \to
\bigoplus\nolimits_{m \geq 0}
\mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes m} \to
\bigoplus\nolimits_{m \geq 0}
\mathcal{L}^{\otimes m} \to
\bigoplus\nolimits_{m \geq 0}
i_*i^*\mathcal{L}^{\otimes m} \to 0
$$
is a derivation by Cohomology, Lemma
\ref{cohomology-lemma-boundary-derivation-over-cup-product}. By
Lemma \ref{lemma-section-affine-open-kills-classes}
we see that $s^e \xi$ is zero for $e$ large enough.
Hence, after replacing $s$ by a power, we can assume $s$ is the image
of a section $s' \in \Gamma(X, \mathcal{L}^{\otimes n})$.
Then $X_{s'}$ is an open subscheme and $Z_s \to X_{s'}$ is a surjective
closed immersion of Noetherian schemes with $Z_s$ affine. Hence
$X_s$ is affine by
Lemma \ref{lemma-image-affine-finite-morphism-affine-Noetherian} and
we conclude that $\mathcal{L}$ is ample.
\end{proof}

\noindent
For a more general version of the following lemma see
Limits, Lemma \ref{limits-lemma-thickening-quasi-affine}.

\begin{lemma}
\label{lemma-thickening-quasi-affine}
Let $i : Z \to X$ be a closed immersion of Noetherian schemes
inducing a homeomorphism of underlying topological spaces.
Then $X$ is quasi-affine if and only if $Z$ is quasi-affine.
\end{lemma}

\begin{proof}
Recall that a scheme is quasi-affine
if and only if the structure sheaf is ample, see
Properties, Lemma \ref{properties-lemma-quasi-affine-O-ample}.
Hence if $Z$ is quasi-affine, then $\mathcal{O}_Z$ is ample,
hence $\mathcal{O}_X$ is ample by
Lemma \ref{lemma-ample-on-reduction}, hence
$X$ is quasi-affine. A proof of the converse, which
can also be seen in an elementary way, is gotten by
reading the argument just given backwards.
\end{proof}







\section{Chow's Lemma}
\label{section-chows-lemma}

\noindent
In this section we prove Chow's lemma in the Noetherian
case (Lemma \ref{lemma-chow-Noetherian}).
In
Limits, Section \ref{limits-section-chows-lemma}
we prove some variants for the non-Noetherian case.

\begin{lemma}
\label{lemma-chow-Noetherian}
Let $S$ be a Noetherian scheme.
Let $f : X \to S$ be a separated morphism of finite type.
Then there exists an $n \geq 0$ and a diagram
$$
\xymatrix{
X \ar[rd] & X' \ar[d] \ar[l]^\pi \ar[r] & \mathbf{P}^n_S \ar[dl] \\
& S &
}
$$
where $X' \to \mathbf{P}^n_S$ is an immersion, and
$\pi : X' \to X$ is proper and surjective. Moreover, we may
arrange it such that there exists a dense open subscheme
$U \subset X$ such that $\pi^{-1}(U) \to U$ is an isomorphism.
\end{lemma}

\begin{proof}
All of the schemes we will encounter during the rest of the proof
are going to be of finite type over the Noetherian scheme $S$ and
hence Noetherian
(see Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}).
All morphisms between them will automatically be quasi-compact, locally of
finite type and quasi-separated, see
Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type} and
Properties,
Lemmas \ref{properties-lemma-locally-Noetherian-quasi-separated} and
\ref{properties-lemma-morphism-Noetherian-schemes-quasi-compact}.

\medskip\noindent
The scheme $X$ has only finitely many irreducible components
(Properties, Lemma \ref{properties-lemma-Noetherian-irreducible-components}).
Say $X = X_1 \cup \ldots \cup X_r$ is the decomposition
of $X$ into irreducible components.
Let $\eta_i \in X_i$ be the generic point.
For every point $x \in X$ there exists an affine open
$U_x \subset X$ which contains $x$ and each of the generic
points $\eta_i$. See
Properties, Lemma \ref{properties-lemma-point-and-maximal-points-affine}.
Since $X$ is quasi-compact, we can find a finite affine open
covering $X = U_1 \cup \ldots \cup U_m$ such that
each $U_i$ contains $\eta_1, \ldots, \eta_r$.
In particular we conclude that the open
$U = U_1 \cap \ldots \cap U_m \subset X$ is
a dense open. This and the fact that the $U_i$ are affine opens
covering $X$ is all that we will use below.

\medskip\noindent
Let $X^* \subset X$ be the scheme theoretic closure of $U \to X$, see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-image}.
Let $U_i^* = X^* \cap U_i$. Note that $U_i^*$ is a closed subscheme
of $U_i$. Hence $U_i^*$ is affine. Since $U$ is dense in $X$ the
morphism $X^* \to X$ is a surjective closed immersion. It is an
isomorphism over $U$. Hence we may replace $X$ by $X^*$ and
$U_i$ by $U_i^*$ and assume that $U$ is scheme theoretically dense
in $X$, see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretically-dense}.

\medskip\noindent
By Morphisms, Lemma \ref{morphisms-lemma-quasi-projective-finite-type-over-S}
we can find an immersion $j_i : U_i \to \mathbf{P}_S^{n_i}$
for each $i$. By
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-immersion} we can find
closed subschemes $Z_i \subset \mathbf{P}_S^{n_i}$
such that $j_i : U_i \to Z_i$ is a scheme theoretically
dense open immersion. Note that $Z_i \to S$ is proper, see
Morphisms, Lemma \ref{morphisms-lemma-locally-projective-proper}.
Consider the morphism
$$
j = (j_1|_U, \ldots, j_m|_U) : U \longrightarrow
\mathbf{P}_S^{n_1} \times_S \ldots \times_S \mathbf{P}_S^{n_m}.
$$
By the lemma cited above we can find a closed subscheme
$Z$ of $\mathbf{P}_S^{n_1} \times_S \ldots \times_S \mathbf{P}_S^{n_m}$
such that $j : U \to Z$ is an open immersion and such that $U$
is scheme theoretically dense in $Z$. The morphism $Z \to S$
is proper. Consider the $i$th projection
$$
\text{pr}_i|_Z : Z \longrightarrow \mathbf{P}^{n_i}_S.
$$
This morphism factors through $Z_i$ (see Morphisms,
Lemma \ref{morphisms-lemma-factor-factor}). Denote $p_i : Z \to Z_i$
the induced morphism. This is a proper morphism, see
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}
for example. At this point we have that
$U \subset U_i \subset Z_i$ are scheme theoretically
dense open immersions. Moreover, we can think of $Z$ as the
scheme theoretic image of the ``diagonal'' morphism
$U \to Z_1 \times_S \ldots \times_S Z_m$.

\medskip\noindent
Set $V_i = p_i^{-1}(U_i)$. Note that $p_i|_{V_i} : V_i \to U_i$ is proper.
Set $X' = V_1 \cup \ldots \cup V_m$. By construction $X'$ has an immersion
into the scheme
$\mathbf{P}^{n_1}_S \times_S \ldots \times_S \mathbf{P}^{n_m}_S$.
Thus by the Segre embedding (see
Constructions, Lemma \ref{constructions-lemma-segre-embedding})
we see that $X'$ has
an immersion into a projective space over $S$.

\medskip\noindent
We claim that the morphisms $p_i|_{V_i}: V_i \to U_i$ glue to a morphism
$X' \to X$. Namely, it is clear that $p_i|_U$ is the identity map
from $U$ to $U$. Since $U \subset X'$ is scheme theoretically
dense by construction, it is also scheme theoretically dense
in the open subscheme $V_i \cap V_j$. Thus we see that
$p_i|_{V_i \cap V_j} = p_j|_{V_i \cap V_j}$ as morphisms into the
separated $S$-scheme $X$, see
Morphisms, Lemma \ref{morphisms-lemma-equality-of-morphisms}.
We denote the resulting morphism $\pi : X' \to X$.

\medskip\noindent
We claim that $\pi^{-1}(U_i) = V_i$.
Since $\pi|_{V_i} = p_i|_{V_i}$ it follows that
$V_i \subset \pi^{-1}(U_i)$. Consider the diagram
$$
\xymatrix{
V_i \ar[r] \ar[rd]_{p_i|_{V_i}} & \pi^{-1}(U_i) \ar[d] \\
& U_i
}
$$
Since $V_i \to U_i$ is proper we see that the image of
the horizontal arrow is closed, see
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}.
Since $V_i \subset \pi^{-1}(U_i)$ is scheme
theoretically dense (as it contains $U$)
we conclude that $V_i = \pi^{-1}(U_i)$ as claimed.

\medskip\noindent
This shows that $\pi^{-1}(U_i) \to U_i$ is identified with the proper
morphism $p_i|_{V_i} : V_i \to U_i$. Hence we see that $X$ has a
finite affine covering $X = \bigcup U_i$ such that the restriction
of $\pi$ is proper on each member of the covering.
Thus by Morphisms, Lemma \ref{morphisms-lemma-proper-local-on-the-base}
we see that $\pi$ is proper.

\medskip\noindent
Finally we have to show that $\pi^{-1}(U) = U$. To see this we argue in the
same way as above using the diagram
$$
\xymatrix{
U \ar[r] \ar[rd] & \pi^{-1}(U) \ar[d] \\
& U
}
$$
and using that $\text{id}_U : U \to U$ is proper and that
$U$ is scheme theoretically dense in $\pi^{-1}(U)$.
\end{proof}

\begin{remark}
\label{remark-chow-Noetherian}
In the situation of Chow's
Lemma \ref{lemma-chow-Noetherian}:
\begin{enumerate}
\item The morphism $\pi$ is actually H-projective (hence projective, see
Morphisms, Lemma \ref{morphisms-lemma-H-projective})
since the morphism $X' \to \mathbf{P}^n_S \times_S X = \mathbf{P}^n_X$
is a closed immersion (use the fact that $\pi$ is proper, see
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}).
\item We may assume that $\pi^{-1}(U)$ is scheme theoretically dense
in $X'$. Namely, we can simply replace $X'$ by the scheme theoretic
closure of $\pi^{-1}(U)$. In this case we can think of $U$ as a
scheme theoretically dense open subscheme of $X'$.
See Morphisms, Section \ref{morphisms-section-scheme-theoretic-image}.
\item If $X$ is reduced then we may choose $X'$ reduced. This is clear
from (2).
\end{enumerate}
\end{remark}






\section{Higher direct images of coherent sheaves}
\label{section-proper-pushforward}

\noindent
In this section we prove the fundamental fact that the higher
direct images of a coherent sheaf under a proper morphism
are coherent.

\begin{proposition}
\label{proposition-proper-pushforward-coherent}
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a proper morphism.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then $R^if_*\mathcal{F}$ is a coherent $\mathcal{O}_S$-module
for all $i \geq 0$.
\end{proposition}

\begin{proof}
Since the problem is local on $S$ we may assume that $S$ is
a Noetherian scheme. Since a proper morphism is of finite type
we see that in this case $X$ is a Noetherian scheme also.
Consider the property $\mathcal{P}$ of coherent sheaves
on $X$ defined by the rule
$$
\mathcal{P}(\mathcal{F}) \Leftrightarrow
R^pf_*\mathcal{F}\text{ is coherent for all }p \geq 0
$$
We are going to use the result of
Lemma \ref{lemma-property} to prove that
$\mathcal{P}$ holds for every coherent sheaf on $X$.

\medskip\noindent
Let
$$
0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0
$$
be a short exact sequence of coherent sheaves on $X$.
Consider the long exact sequence of higher direct images
$$
R^{p - 1}f_*\mathcal{F}_3 \to
R^pf_*\mathcal{F}_1 \to
R^pf_*\mathcal{F}_2 \to
R^pf_*\mathcal{F}_3 \to
R^{p + 1}f_*\mathcal{F}_1
$$
Then it is clear that if 2-out-of-3 of the sheaves $\mathcal{F}_i$
have property $\mathcal{P}$, then the higher direct images of the
third are sandwiched in this exact complex between two coherent
sheaves. Hence these higher direct images are also coherent by
Lemma \ref{lemma-coherent-abelian-Noetherian} and
\ref{lemma-coherent-Noetherian-quasi-coherent-sub-quotient}.
Hence property $\mathcal{P}$ holds for the third as well.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme.
We have to find a coherent sheaf $\mathcal{F}$ on $X$ whose support is
contained in $Z$, whose stalk at the generic point $\xi$ of $Z$ is a
$1$-dimensional vector space over $\kappa(\xi)$ such that $\mathcal{P}$
holds for $\mathcal{F}$. Denote $g = f|_Z : Z \to S$ the restriction of $f$.
Suppose we can find a coherent sheaf $\mathcal{G}$ on $Z$ such
that
(a) $\mathcal{G}_\xi$ is a $1$-dimensional vector space over $\kappa(\xi)$,
(b) $R^pg_*\mathcal{G} = 0$ for $p > 0$, and
(c) $g_*\mathcal{G}$ is coherent. Then we can consider
$\mathcal{F} = (Z \to X)_*\mathcal{G}$. As $Z \to X$ is a closed immersion
we see that $(Z \to X)_*\mathcal{G}$ is coherent on $X$
and $R^p(Z \to X)_*\mathcal{G} = 0$ for $p > 0$
(Lemma \ref{lemma-finite-pushforward-coherent}).
Hence by the relative Leray spectral sequence
(Cohomology, Lemma \ref{cohomology-lemma-relative-Leray})
we will have $R^pf_*\mathcal{F} = R^pg_*\mathcal{G} = 0$ for $p > 0$
and $f_*\mathcal{F} = g_*\mathcal{G}$ is coherent.
Finally $\mathcal{F}_\xi = ((Z \to X)_*\mathcal{G})_\xi = \mathcal{G}_\xi$
which verifies the condition on the stalk at $\xi$.
Hence everything depends on finding a coherent sheaf $\mathcal{G}$
on $Z$ which has properties (a), (b), and (c).

\medskip\noindent
We can apply Chow's Lemma \ref{lemma-chow-Noetherian}
to the morphism $Z \to S$. Thus we get a diagram
$$
\xymatrix{
Z \ar[rd]_g & Z' \ar[d]^-{g'} \ar[l]^\pi \ar[r]_i & \mathbf{P}^n_S \ar[dl] \\
& S &
}
$$
as in the statement of Chow's lemma. Also, let $U \subset Z$ be
the dense open subscheme such that $\pi^{-1}(U) \to U$ is an isomorphism.
By the discussion in Remark \ref{remark-chow-Noetherian} we see that
$i' = (i, \pi) : Z' \to \mathbf{P}^n_Z$ is
a closed immersion. Hence
$$
\mathcal{L} = i^*\mathcal{O}_{\mathbf{P}^n_S}(1) \cong
(i')^*\mathcal{O}_{\mathbf{P}^n_Z}(1)
$$
is $g'$-relatively ample and $\pi$-relatively ample (for example by
Morphisms, Lemma \ref{morphisms-lemma-characterize-ample-on-finite-type}).
Hence by Lemma \ref{lemma-kill-by-twisting}
there exists an $n \geq 0$ such that
both $R^p\pi_*\mathcal{L}^{\otimes n} = 0$ for all $p > 0$ and
$R^p(g')_*\mathcal{L}^{\otimes n} = 0$ for all $p > 0$.
Set $\mathcal{G} = \pi_*\mathcal{L}^{\otimes n}$.
Property (a) holds because $\pi_*\mathcal{L}^{\otimes}|_U$ is
an invertible sheaf (as $\pi^{-1}(U) \to U$ is an isomorphism).
Properties (b) and (c) hold because by the relative Leray
spectral sequence
(Cohomology, Lemma \ref{cohomology-lemma-relative-Leray})
we have
$$
E_2^{p, q} = R^pg_* R^q\pi_*\mathcal{L}^{\otimes n}
\Rightarrow
R^{p + q}(g')_*\mathcal{L}^{\otimes n}
$$
and by choice of $n$ the only nonzero terms in $E_2^{p, q}$ are
those with $q = 0$ and the only nonzero terms of
$R^{p + q}(g')_*\mathcal{L}^{\otimes n}$ are those with $p = q = 0$.
This implies that $R^pg_*\mathcal{G} = 0$ for $p > 0$ and
that $g_*\mathcal{G} = (g')_*\mathcal{L}^{\otimes n}$.
Finally, applying the previous
Lemma \ref{lemma-locally-projective-pushforward}
we see that $g_*\mathcal{G} = (g')_*\mathcal{L}^{\otimes n}$ is
coherent as desired.
\end{proof}

\begin{lemma}
\label{lemma-proper-over-affine-cohomology-finite}
Let $S = \Spec(A)$ with $A$ a Noetherian ring.
Let $f : X \to S$ be a proper morphism.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then $H^i(X, \mathcal{F})$ is finite $A$-module for all $i \geq 0$.
\end{lemma}

\begin{proof}
This is just the affine case of
Proposition \ref{proposition-proper-pushforward-coherent}.
Namely, by Lemmas \ref{lemma-quasi-coherence-higher-direct-images} and
\ref{lemma-quasi-coherence-higher-direct-images-application} we know that
$R^if_*\mathcal{F}$ is the quasi-coherent sheaf associated
to the $A$-module $H^i(X, \mathcal{F})$
and by Lemma \ref{lemma-coherent-Noetherian} this is
a coherent sheaf if and only if $H^i(X, \mathcal{F})$
is an $A$-module of finite type.
\end{proof}

\begin{lemma}
\label{lemma-graded-finiteness}
Let $A$ be a Noetherian ring.
Let $B$ be a finitely generated graded $A$-algebra.
Let $f : X \to \Spec(A)$ be a proper morphism.
Set $\mathcal{B} = f^*\widetilde B$.
Let $\mathcal{F}$ be a quasi-coherent
graded $\mathcal{B}$-module of finite type.
\begin{enumerate}
\item For every $p \geq 0$ the graded $B$-module $H^p(X, \mathcal{F})$
is a finite $B$-module.
\item If $\mathcal{L}$ is an ample invertible $\mathcal{O}_X$-module,
then there exists an integer $d_0$ such that
$H^p(X, \mathcal{F} \otimes \mathcal{L}^{\otimes d}) = 0$
for all $p > 0$ and $d \geq d_0$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove this we consider the fibre product diagram
$$
\xymatrix{
X' = \Spec(B) \times_{\Spec(A)} X
\ar[r]_-\pi \ar[d]_{f'} &
X \ar[d]^f \\
\Spec(B) \ar[r] &
\Spec(A)
}
$$
Note that $f'$ is a proper morphism, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
Also, $B$ is a finitely generated $A$-algebra, and hence
Noetherian (Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}).
This implies that $X'$ is a Noetherian scheme
(Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}).
Note that $X'$ is the relative spectrum of the quasi-coherent
$\mathcal{O}_X$-algebra $\mathcal{B}$ by
Constructions, Lemma \ref{constructions-lemma-spec-properties}.
Since $\mathcal{F}$ is a quasi-coherent $\mathcal{B}$-module
we see that there is a unique quasi-coherent
$\mathcal{O}_{X'}$-module $\mathcal{F}'$ such that
$\pi_*\mathcal{F}' = \mathcal{F}$, see
Morphisms, Lemma \ref{morphisms-lemma-affine-equivalence-modules}
Since $\mathcal{F}$ is finite type as a $\mathcal{B}$-module we
conclude that $\mathcal{F}'$ is a finite type
$\mathcal{O}_{X'}$-module (details omitted). In other words,
$\mathcal{F}'$ is a coherent $\mathcal{O}_{X'}$-module
(Lemma \ref{lemma-coherent-Noetherian}).
Since the morphism $\pi : X' \to X$ is affine we have
$$
H^p(X, \mathcal{F}) = H^p(X', \mathcal{F}')
$$
by Lemma \ref{lemma-relative-affine-cohomology}.
Thus (1) follows from
Lemma \ref{lemma-proper-over-affine-cohomology-finite}.
Given $\mathcal{L}$ as in (2) we set
$\mathcal{L}' = \pi^*\mathcal{L}$. Note that $\mathcal{L}'$ is
ample on $X'$ by
Morphisms, Lemma \ref{morphisms-lemma-pullback-ample-tensor-relatively-ample}.
By the projection formula
(Cohomology, Lemma \ref{cohomology-lemma-projection-formula}) we have
$\pi_*(\mathcal{F}' \otimes \mathcal{L}') = \mathcal{F} \otimes \mathcal{L}$.
Thus part (2) follows by the same reasoning as above from
Lemma \ref{lemma-kill-by-twisting}.
\end{proof}












\section{The theorem on formal functions}
\label{section-theorem-formal-functions}

\noindent
In this section we study the behaviour of cohomology of
sequences of sheaves either of the form $\{I^n\mathcal{F}\}_{n \geq 0}$
or of the form $\{\mathcal{F}/I^n\mathcal{F}\}_{n \geq 0}$ as
$n$ varies.

\medskip\noindent
Here and below we use the following notation.
Given a morphism of schemes $f : X \to Y$, a quasi-coherent sheaf
$\mathcal{F}$ on $X$, and a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Y$ we denote
$\mathcal{I}^n\mathcal{F}$ the quasi-coherent subsheaf generated
by products of local sections of $f^{-1}(\mathcal{I}^n)$ and
$\mathcal{F}$. In a formula
$$
\mathcal{I}^n\mathcal{F}
=
\Im\left(
f^*(\mathcal{I}^n) \otimes_{\mathcal{O}_X} \mathcal{F}
\longrightarrow
\mathcal{F}
\right).
$$
Note that there are natural maps
$$
f^{-1}(\mathcal{I}^n) \otimes_{f^{-1}\mathcal{O}_Y} \mathcal{I}^m\mathcal{F}
\longrightarrow
f^*(\mathcal{I}^n) \otimes_{\mathcal{O}_X} \mathcal{I}^m\mathcal{F}
\longrightarrow
\mathcal{I}^{n + m}\mathcal{F}
$$
Hence a section of $\mathcal{I}^n$ will give rise to a
map $R^pf_*(\mathcal{I}^m\mathcal{F}) \to
R^pf_*(\mathcal{I}^{n + m}\mathcal{F})$ by functoriality
of higher direct images. Localizing and then sheafifying we
see that there are $\mathcal{O}_Y$-module maps
$$
\mathcal{I}^n \otimes_{\mathcal{O}_Y} R^pf_*(\mathcal{I}^m\mathcal{F})
\longrightarrow
R^pf_*(\mathcal{I}^{n + m}\mathcal{F}).
$$
In other words we see that
$\bigoplus_{n \geq 0} R^pf_*(\mathcal{I}^n\mathcal{F})$
is a graded $\bigoplus_{n \geq 0} \mathcal{I}^n$-module.

\medskip\noindent
If $Y = \Spec(A)$ and $\mathcal{I} = \widetilde{I}$ we denote
$\mathcal{I}^n\mathcal{F}$ simply $I^n\mathcal{F}$. The maps
introduced above give $M = \bigoplus H^p(X, I^n\mathcal{F})$ the
structure of a graded $S = \bigoplus I^n$-module. If $f$ is proper,
$A$ is Noetherian and $\mathcal{F}$ is coherent, then this turns out
to be a module of finite type.

\begin{lemma}
\label{lemma-cohomology-powers-ideal-times-F}
Let $A$ be a Noetherian ring.
Let $I \subset A$ be an ideal.
Set $B = \bigoplus_{n \geq 0} I^n$.
Let $f : X \to \Spec(A)$ be a proper morphism.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Then for every $p \geq 0$ the graded $B$-module
$\bigoplus_{n \geq 0} H^p(X, I^n\mathcal{F})$ is
a finite $B$-module.
\end{lemma}

\begin{proof}
Let $\mathcal{B} = \bigoplus I^n\mathcal{O}_X = f^*\widetilde{B}$.
Then $\bigoplus I^n\mathcal{F}$ is a finite type
graded $\mathcal{B}$-module. Hence the result follows
from Lemma \ref{lemma-graded-finiteness} part (1).
\end{proof}

\begin{lemma}
\label{lemma-cohomology-powers-ideal-times-sheaf}
Given a morphism of schemes $f : X \to Y$, a quasi-coherent sheaf
$\mathcal{F}$ on $X$, and a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Y$. Assume $Y$ locally
Noetherian, $f$ proper, and $\mathcal{F}$ coherent.
Then
$$
\mathcal{M} =
\bigoplus\nolimits_{n \geq 0} R^pf_*(\mathcal{I}^n\mathcal{F})
$$
is a graded $\mathcal{A} = \bigoplus_{n \geq 0} \mathcal{I}^n$-module
which is quasi-coherent and of finite type.
\end{lemma}

\begin{proof}
The statement is local on $Y$, hence this reduces to the
case where $Y$ is affine. In the affine case the result follows
from Lemma \ref{lemma-cohomology-powers-ideal-times-F}.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-powers-ideal-application}
Let $A$ be a Noetherian ring.
Let $I \subset A$ be an ideal.
Let $f : X \to \Spec(A)$ be a proper morphism.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Then for every $p \geq 0$ there exists an integer $c \geq 0$
such that
\begin{enumerate}
\item the multiplication map
$I^{n - c} \otimes H^p(X, I^c\mathcal{F}) \to H^p(X, I^n\mathcal{F})$
is surjective for all $n \geq c$, and
\item the image of $H^p(X, I^{n + m}\mathcal{F}) \to H^p(X, I^n\mathcal{F})$
is contained in the submodule $I^{m - c} H^p(X, I^n\mathcal{F})$
for all $n \geq 0$, $m \geq c$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-cohomology-powers-ideal-times-F}
we can find $d_1, \ldots, d_t \geq 0$, and
$x_i \in H^p(X, I^{d_i}\mathcal{F})$ such that
$\bigoplus_{n \geq 0} H^p(X, I^n\mathcal{F})$ is generated
by $x_1, \ldots, x_t$ over $S = \bigoplus_{n \geq 0} I^n$.
Take $c = \max\{d_i\}$. It is clear that (1) holds.
For (2) let $b = \max(0, n - c)$.
Consider the commutative diagram of $A$-modules
$$
\xymatrix{
I^{n + m - c - b} \otimes I^b \otimes
H^p(X, I^c\mathcal{F}) \ar[r] \ar[d] &
I^{n + m - c} \otimes H^p(X, I^c\mathcal{F}) \ar[r] &
H^p(X, I^{n + m}\mathcal{F}) \ar[d] \\
I^{n + m - c - b} \otimes H^p(X, I^n\mathcal{F}) \ar[rr] & &
H^p(X, I^n\mathcal{F})
}
$$
By part (1) of the lemma the composition of the horizontal arrows
is surjective if $n + m \geq c$. On the other hand, it is clear
that $n + m - c - b \geq m - c$. Hence part (2).
\end{proof}

\noindent
In the situation of Lemmas \ref{lemma-cohomology-powers-ideal-times-F} and
\ref{lemma-cohomology-powers-ideal-application} consider the inverse
system
$$
\mathcal{F}/I\mathcal{F} \leftarrow
\mathcal{F}/I^2\mathcal{F} \leftarrow
\mathcal{F}/I^3\mathcal{F} \leftarrow \ldots
$$
We would like to know what happens to the cohomology groups.
Here is a first result.

\begin{lemma}
\label{lemma-ML-cohomology-powers-ideal}
Let $A$ be a Noetherian ring.
Let $I \subset A$ be an ideal.
Let $f : X \to \Spec(A)$ be a proper morphism.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Fix $p \geq 0$.
\begin{enumerate}
\item There exists a $c_1 \geq 0$ such that for all $n \geq c_1$
we have
$$
\Ker(
H^p(X, \mathcal{F}) \to H^p(X, \mathcal{F}/I^n\mathcal{F})
)
\subset
I^{n - c_1}H^p(X, \mathcal{F}).
$$
\item The inverse system
$$
\left(H^p(X, \mathcal{F}/I^n\mathcal{F})\right)_{n \in \mathbf{N}}
$$
satisfies the Mittag-Leffler condition (see
Homology, Definition \ref{homology-definition-Mittag-Leffler}).
\item In fact for any $p$ and $n$ there exists a $c_2(n) \geq n$
such that
$$
\Im(H^p(X, \mathcal{F}/I^k\mathcal{F})
\to H^p(X, \mathcal{F}/I^n\mathcal{F}))
=
\Im(H^p(X, \mathcal{F})
\to H^p(X, \mathcal{F}/I^n\mathcal{F}))
$$
for all $k \geq c_2(n)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $c_1 = \max\{c_p, c_{p + 1}\}$, where $c_p, c_{p +1}$ are the integers
found in Lemma \ref{lemma-cohomology-powers-ideal-application} for
$H^p$ and $H^{p + 1}$. We will use this constant in the proofs of
(1), (2) and (3).

\medskip\noindent
Let us prove part (1). Consider the short exact sequence
$$
0 \to I^n\mathcal{F} \to \mathcal{F} \to \mathcal{F}/I^n\mathcal{F} \to 0
$$
From the long exact cohomology sequence we see that
$$
\Ker(
H^p(X, \mathcal{F}) \to H^p(X, \mathcal{F}/I^n\mathcal{F})
)
=
\Im(
H^p(X, I^n\mathcal{F}) \to H^p(X, \mathcal{F})
)
$$
Hence by our choice of $c_1$ we see that this is contained in
$I^{n - c_1}H^p(X, \mathcal{F})$ for $n \geq c_1$.

\medskip\noindent
Note that part (3) implies part (2) by definition of the Mittag-Leffler
condition.

\medskip\noindent
Let us prove part (3).
Fix an $n$ throughout the rest of the proof.
Consider the commutative diagram
$$
\xymatrix{
0 \ar[r] &
I^n\mathcal{F} \ar[r] &
\mathcal{F} \ar[r] &
\mathcal{F}/I^n\mathcal{F} \ar[r] &
0 \\
0 \ar[r] &
I^{n + m}\mathcal{F} \ar[r] \ar[u] &
\mathcal{F} \ar[r] \ar[u] &
\mathcal{F}/I^{n + m}\mathcal{F} \ar[r] \ar[u] &
0
}
$$
This gives rise to the following commutative diagram
$$
\xymatrix{
H^p(X, I^n\mathcal{F}) \ar[r] &
H^p(X, \mathcal{F}) \ar[r] &
H^p(X, \mathcal{F}/I^n\mathcal{F}) \ar[r]_\delta &
H^{p + 1}(X, I^n\mathcal{F}) \\
H^p(X, I^{n + m}\mathcal{F}) \ar[r] \ar[u] &
H^p(X, \mathcal{F}) \ar[r] \ar[u]^1 &
H^p(X, \mathcal{F}/I^{n + m}\mathcal{F}) \ar[r] \ar[u] &
H^{p + 1}(X, I^{n + m}\mathcal{F}) \ar[u]^a
}
$$
If $m \geq c_1$ we see that the image of $a$ is
contained in $I^{m - c_1} H^{p + 1}(X, I^n\mathcal{F})$.
By the Artin-Rees lemma (see Algebra, Lemma \ref{algebra-lemma-map-AR})
there exists an integer $c_3(n)$ such that
$$
I^N H^{p + 1}(X, I^n\mathcal{F}) \cap \Im(\delta)
\subset
\delta\left(I^{N - c_3(n)}H^p(X, \mathcal{F}/I^n\mathcal{F})\right)
$$
for all $N \geq c_3(n)$. As $H^p(X, \mathcal{F}/I^n\mathcal{F})$
is annihilated by $I^n$, we see that if $m \geq c_3(n) + c_1 + n$,
then
$$
\Im(H^p(X, \mathcal{F}/I^{n + m}\mathcal{F})
\to H^p(X, \mathcal{F}/I^n\mathcal{F}))
=
\Im(H^p(X, \mathcal{F})
\to H^p(X, \mathcal{F}/I^n\mathcal{F}))
$$
In other words, part (3) holds with $c_2(n) = c_3(n) + c_1 + n$.
\end{proof}

\begin{theorem}[Theorem on formal functions]
\label{theorem-formal-functions}
Let $A$ be a Noetherian ring.
Let $I \subset A$ be an ideal.
Let $f : X \to \Spec(A)$ be a proper morphism.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Fix $p \geq 0$.
The system of maps
$$
H^p(X, \mathcal{F})/I^nH^p(X, \mathcal{F})
\longrightarrow
H^p(X, \mathcal{F}/I^n\mathcal{F})
$$
define an isomorphism of limits
$$
H^p(X, \mathcal{F})^\wedge
\longrightarrow
\lim_n H^p(X, \mathcal{F}/I^n\mathcal{F})
$$
where the left hand side is the completion of the $A$-module
$H^p(X, \mathcal{F})$ with respect to the ideal $I$, see
Algebra, Section \ref{algebra-section-completion}.
Moreover, this is in fact a homeomorphism for the limit topologies.
\end{theorem}

\begin{proof}
In fact, this follows immediately from
Lemma \ref{lemma-ML-cohomology-powers-ideal}. We spell out the details.
Set $M = H^p(X, \mathcal{F})$ and $M_n = H^p(X, \mathcal{F}/I^n\mathcal{F})$.
Denote $N_n = \Im(M \to M_n)$.
By the description of the limit in Homology, Section
\ref{homology-section-inverse-systems} we have
$$
\lim_n M_n
=
\{(x_n) \in \prod M_n \mid \varphi_i(x_n) = x_{n - 1}, \ n = 2, 3, \ldots\}
$$
Pick an element $x = (x_n) \in \lim_n M_n$.
By Lemma \ref{lemma-ML-cohomology-powers-ideal} part (3)
we have $x_n \in N_n$ for all $n$ since by
definition $x_n$ is the image of some $x_{n + m} \in M_{n + m}$ for
all $m$. By Lemma \ref{lemma-ML-cohomology-powers-ideal} part (1)
we see that there exists a factorization
$$
M \to N_n \to M/I^{n - c_1}M
$$
of the reduction map. Denote $y_n \in M/I^{n - c_1}M$ the image of $x_n$
for $n \geq c_1$. Since for $n' \geq n$ the composition
$M \to M_{n'} \to M_n$ is the given map $M \to M_n$ we see that
$y_{n'}$ maps to $y_n$ under the canonical map
$M/I^{n' - c_1}M \to M/I^{n - c_1}M$. Hence $y = (y_{n + c_1})$
defines an element of $\lim_n M/I^nM$.
We omit the verification that $y$ maps to $x$ under the
map
$$
M^\wedge = \lim_n M/I^nM \longrightarrow \lim_n M_n
$$
of the lemma. We also omit the verification on topologies.
\end{proof}

\begin{lemma}
\label{lemma-spell-out-theorem-formal-functions}
Let $A$ be a ring. Let $I \subset A$ be an ideal. Assume $A$ is
Noetherian and complete with respect to $I$.
Let $f : X \to \Spec(A)$ be a proper morphism.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Then
$$
H^p(X, \mathcal{F}) = \lim_n H^p(X, \mathcal{F}/I^n\mathcal{F})
$$
for all $p \geq 0$.
\end{lemma}

\begin{proof}
This is a reformulation of the theorem on formal functions
(Theorem \ref{theorem-formal-functions}) in the
case of a complete Noetherian base ring. Namely, in this case the
$A$-module $H^p(X, \mathcal{F})$ is finite
(Lemma \ref{lemma-proper-over-affine-cohomology-finite}) hence
$I$-adically complete (Algebra, Lemma \ref{algebra-lemma-completion-tensor})
and we see that completion on the left hand side is not necessary.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions-stalk}
Given a morphism of schemes $f : X \to Y$ and a quasi-coherent sheaf
$\mathcal{F}$ on $X$. Assume
\begin{enumerate}
\item $Y$ locally Noetherian,
\item $f$ proper, and
\item $\mathcal{F}$ coherent.
\end{enumerate}
Let $y \in Y$ be a point. Consider the infinitesimal neighbourhoods
$$
\xymatrix{
X_n =
\Spec(\mathcal{O}_{Y, y}/\mathfrak m_y^n) \times_Y X
\ar[r]_-{i_n} \ar[d]_{f_n} &
X \ar[d]^f \\
\Spec(\mathcal{O}_{Y, y}/\mathfrak m_y^n) \ar[r]^-{c_n} & Y
}
$$
of the fibre $X_1 = X_y$ and set $\mathcal{F}_n = i_n^*\mathcal{F}$.
Then we have
$$
\left(R^pf_*\mathcal{F}\right)_y^\wedge
\cong
\lim_n H^p(X_n, \mathcal{F}_n)
$$
as $\mathcal{O}_{Y, y}^\wedge$-modules.
\end{lemma}

\begin{proof}
This is just a reformulation of a special case of the theorem
on formal functions, Theorem \ref{theorem-formal-functions}.
Let us spell it out. Note that $\mathcal{O}_{Y, y}$ is a Noetherian
local ring. Consider the canonical morphism
$c : \Spec(\mathcal{O}_{Y, y}) \to Y$, see
Schemes, Equation (\ref{schemes-equation-canonical-morphism}).
This is a flat morphism as it identifies local rings.
Denote momentarily $f' : X' \to \Spec(\mathcal{O}_{Y, y})$
the base change of $f$ to this local ring. We see that
$c^*R^pf_*\mathcal{F} = R^pf'_*\mathcal{F}'$ by
Lemma \ref{lemma-flat-base-change-cohomology}.
Moreover, the infinitesimal neighbourhoods of
the fibre $X_y$ and $X'_y$ are identified (verification omitted; hint:
the morphisms $c_n$ factor through $c$).

\medskip\noindent
Hence we may assume that $Y = \Spec(A)$ is the spectrum of
a Noetherian local ring $A$ with maximal ideal $\mathfrak m$
and that $y \in Y$ corresponds to the closed point (i.e., to $\mathfrak m$).
In particular it follows that
$$
\left(R^pf_*\mathcal{F}\right)_y =
\Gamma(Y, R^pf_*\mathcal{F}) =
H^p(X, \mathcal{F}).
$$

\medskip\noindent
In this case also, the morphisms $c_n$ are each closed immersions.
Hence their base changes $i_n$ are closed immersions as well.
Note that $i_{n, *}\mathcal{F}_n = i_{n, *}i_n^*\mathcal{F}
= \mathcal{F}/\mathfrak m^n\mathcal{F}$. By the Leray spectral sequence
for $i_n$, and Lemma \ref{lemma-finite-pushforward-coherent} we see that
$$
H^p(X_n, \mathcal{F}_n) =
H^p(X, i_{n, *}\mathcal{F}) =
H^p(X, \mathcal{F}/\mathfrak m^n\mathcal{F})
$$
Hence we may indeed apply the theorem on formal functions to compute
the limit in the statement of the lemma and we win.
\end{proof}

\noindent
Here is a lemma which we will generalize later to fibres of
dimension $ > 0$, namely the next lemma.

\begin{lemma}
\label{lemma-higher-direct-images-zero-finite-fibre}
Let $f : X \to Y$ be a morphism of schemes.
Let $y \in Y$.
Assume
\begin{enumerate}
\item $Y$ locally Noetherian,
\item $f$ is proper, and
\item $f^{-1}(\{y\})$ is finite.
\end{enumerate}
Then for any coherent sheaf $\mathcal{F}$ on $X$ we have
$(R^pf_*\mathcal{F})_y = 0$ for all $p > 0$.
\end{lemma}

\begin{proof}
The fibre $X_y$ is finite, and by
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre} it
is a finite discrete space. Moreover, the underlying topological
space of each infinitesimal neighbourhood $X_n$ is the same.
Hence each of the schemes $X_n$ is affine according to
Schemes, Lemma \ref{schemes-lemma-scheme-finite-discrete-affine}.
Hence it follows that $H^p(X_n, \mathcal{F}_n) = 0$ for all
$p > 0$. Hence we see that $(R^pf_*\mathcal{F})_y^\wedge = 0$
by Lemma \ref{lemma-formal-functions-stalk}.
Note that $R^pf_*\mathcal{F}$ is coherent by
Proposition \ref{proposition-proper-pushforward-coherent} and
hence $R^pf_*\mathcal{F}_y$ is a finite
$\mathcal{O}_{Y, y}$-module.
By Algebra, Lemma \ref{algebra-lemma-completion-tensor}
this implies that $(R^pf_*\mathcal{F})_y = 0$.
\end{proof}

\begin{lemma}
\label{lemma-higher-direct-images-zero-above-dimension-fibre}
Let $f : X \to Y$ be a morphism of schemes.
Let $y \in Y$.
Assume
\begin{enumerate}
\item $Y$ locally Noetherian,
\item $f$ is proper, and
\item $\dim(X_y) = d$.
\end{enumerate}
Then for any coherent sheaf $\mathcal{F}$ on $X$ we have
$(R^pf_*\mathcal{F})_y = 0$ for all $p > d$.
\end{lemma}

\begin{proof}
The fibre $X_y$ is of finite type over $\Spec(\kappa(y))$.
Hence $X_y$ is a Noetherian scheme by
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}.
Hence the underlying topological space of $X_y$ is Noetherian, see
Properties, Lemma \ref{properties-lemma-Noetherian-topology}.
Moreover, the underlying topological space of each infinitesimal
neighbourhood $X_n$ is the same as that of $X_y$.
Hence $H^p(X_n, \mathcal{F}_n) = 0$ for all $p > d$ by
Cohomology, Proposition \ref{cohomology-proposition-vanishing-Noetherian}.
Hence we see that $(R^pf_*\mathcal{F})_y^\wedge = 0$
by Lemma \ref{lemma-formal-functions-stalk} for $p > d$.
Note that $R^pf_*\mathcal{F}$ is coherent by
Proposition \ref{proposition-proper-pushforward-coherent} and
hence $R^pf_*\mathcal{F}_y$ is a finite
$\mathcal{O}_{Y, y}$-module.
By Algebra, Lemma \ref{algebra-lemma-completion-tensor}
this implies that $(R^pf_*\mathcal{F})_y = 0$.
\end{proof}








\section{Applications of the theorem on formal functions}
\label{section-applications-formal-functions}


\noindent
We will add more here as needed. For the moment we need the
following characterization of finite morphisms (in the Noetherian
case -- for a more general version see the chapter More on Morphisms,
Section \ref{more-morphisms-section-application-etale-neighbourhoods}).

\begin{lemma}
\label{lemma-characterize-finite}
(For a more general version see
More on Morphisms, Lemma \ref{more-morphisms-lemma-characterize-finite}).
Let $f : X \to S$ be a morphism of schemes.
Assume $S$ is locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $f$ is finite, and
\item $f$ is proper with finite fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
A finite morphism is proper according to
Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
A finite morphism is quasi-finite according to
Morphisms, Lemma \ref{morphisms-lemma-finite-quasi-finite}.
A quasi-finite morphism has finite fibres, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}.
Hence a finite morphism is proper and has finite fibres.

\medskip\noindent
Assume $f$ is proper with finite fibres.
We want to show $f$ is finite.
In fact it suffices to prove $f$ is affine.
Namely, if $f$ is affine, then it follows that
$f$ is integral by
Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed}
whereupon it follows from
Morphisms, Lemma \ref{morphisms-lemma-finite-integral}
that $f$ is finite.

\medskip\noindent
To show that $f$ is affine we may assume that $S$ is affine, and our
goal is to show that $X$ is affine too.
Since $f$ is proper we see that $X$ is separated and quasi-compact.
Hence we may use the criterion of
Lemma \ref{lemma-quasi-separated-h1-zero-covering} to prove that $X$
is affine. To see this let $\mathcal{I} \subset \mathcal{O}_X$
be a finite type ideal sheaf. In particular $\mathcal{I}$ is
a coherent sheaf on $X$. By
Lemma \ref{lemma-higher-direct-images-zero-finite-fibre} we conclude that
$R^1f_*\mathcal{I}_s = 0$ for all $s \in S$.
In other words, $R^1f_*\mathcal{I} = 0$. Hence we see from
the Leray Spectral Sequence for $f$ that
$H^1(X , \mathcal{I}) = H^1(S, f_*\mathcal{I})$.
Since $S$ is affine, and $f_*\mathcal{I}$ is quasi-coherent
(Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent})
we conclude $H^1(S, f_*\mathcal{I}) = 0$
from Lemma \ref{lemma-quasi-coherent-affine-cohomology-zero}
as desired. Hence $H^1(X, \mathcal{I}) = 0$ as desired.
\end{proof}

\noindent
As a consequence we have the following useful result.

\begin{lemma}
\label{lemma-proper-finite-fibre-finite-in-neighbourhood}
\begin{slogan}
A proper morphism is finite in a neighbourhood of a finite fiber.
\end{slogan}
(For a more general version see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-proper-finite-fibre-finite-in-neighbourhood}).
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$.
Assume
\begin{enumerate}
\item $S$ is locally Noetherian,
\item $f$ is proper, and
\item $f^{-1}(\{s\})$ is a finite set.
\end{enumerate}
Then there exists an open neighbourhood $V \subset S$ of $s$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
The morphism $f$ is quasi-finite at all the points of $f^{-1}(\{s\})$
by Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open} the
set of points at which $f$ is quasi-finite is an open $U \subset X$.
Let $Z = X \setminus U$. Then $s \not \in f(Z)$. Since $f$ is proper
the set $f(Z) \subset S$ is closed. Choose any open neighbourhood
$V \subset S$ of $s$ with $Z \cap V = \emptyset$. Then
$f^{-1}(V) \to V$ is locally quasi-finite and proper.
Hence it is quasi-finite
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-locally-quasi-compact}),
hence has finite fibres
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}), hence
is finite by Lemma \ref{lemma-characterize-finite}.
\end{proof}





\section{Cohomology and base change, III}
\label{section-cohomology-and-base-change-perfect}

\noindent
In this section we prove the simplest case of a very general phenomenon
that will be discussed in
Derived Categories of Schemes, Section
\ref{perfect-section-cohomology-and-base-change-perfect}.
Please see Remark \ref{remark-explain-perfect-direct-image} for a translation
of the following lemma into algebra.

\begin{lemma}
\label{lemma-perfect-direct-image}
Let $A$ be a Noetherian ring and set $S = \Spec(A)$. Let $f : X \to S$ be a
proper morphism of schemes. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_X$-module flat over $S$. Then
\begin{enumerate}
\item $R\Gamma(X, \mathcal{F})$ is a perfect object of $D(A)$, and
\item for any ring map $A \to A'$ the base change map
$$
R\Gamma(X, \mathcal{F}) \otimes_A^{\mathbf{L}} A'
\longrightarrow
R\Gamma(X_{A'}, \mathcal{F}_{A'})
$$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a finite affine open covering $X = \bigcup_{i = 1, \ldots, n} U_i$.
By Lemmas \ref{lemma-separated-case-relative-cech} and
\ref{lemma-base-change-complex} the {\v C}ech complex
$K^\bullet = {\check C}^\bullet(\mathcal{U}, \mathcal{F})$ satisfies
$$
K^\bullet \otimes_A A' = R\Gamma(X_{A'}, \mathcal{F}_{A'})
$$
for all ring maps $A \to A'$. Let
$K_{alt}^\bullet = {\check C}_{alt}^\bullet(\mathcal{U}, \mathcal{F})$
be the alternating {\v C}ech complex. By
Cohomology, Lemma \ref{cohomology-lemma-alternating-usual}
there is a homotopy equivalence $K_{alt}^\bullet \to K^\bullet$
of $A$-modules. In particular, we have
$$
K_{alt}^\bullet \otimes_A A' = R\Gamma(X_{A'}, \mathcal{F}_{A'})
$$
as well. Since $\mathcal{F}$ is flat over $A$ we see that each $K_{alt}^n$
is flat over $A$ (see
Morphisms, Lemma \ref{morphisms-lemma-flat-module-characterize}).
Since moreover $K_{alt}^\bullet$ is bounded above (this is why we switched
to the alternating {\v C}ech complex)
$K_{alt}^\bullet \otimes_A A' = K_{alt}^\bullet \otimes_A^{\mathbf{L}} A'$
by the definition of derived tensor products (see
More on Algebra, Section \ref{more-algebra-section-derived-tensor-product}).
By
Lemma \ref{lemma-proper-over-affine-cohomology-finite}
the cohomology groups $H^i(K_{alt}^\bullet)$ are finite $A$-modules.
As $K_{alt}^\bullet$ is bounded, we conclude that $K_{alt}^\bullet$
is pseudo-coherent, see
More on Algebra, Lemma \ref{more-algebra-lemma-Noetherian-pseudo-coherent}.
Given any $A$-module $M$ set $A' = A \oplus M$ where $M$ is a square zero
ideal, i.e., $(a, m) \cdot (a', m') = (aa', am' + a'm)$. By the
above we see that $K_{alt}^\bullet \otimes_A^\mathbf{L} A'$ has cohomology
in degrees $0, \ldots, n$. Hence $K_{alt}^\bullet \otimes_A^\mathbf{L} M$
has cohomology in degrees $0, \ldots, n$. Hence $K_{alt}^\bullet$ has
finite Tor dimension, see
More on Algebra, Definition \ref{more-algebra-definition-tor-amplitude}.
We win by More on Algebra, Lemma \ref{more-algebra-lemma-perfect}.
\end{proof}

\begin{remark}
\label{remark-explain-perfect-direct-image}
A consequence of Lemma \ref{lemma-perfect-direct-image} is that there
exists a finite complex of finite projective $A$-modules $M^\bullet$ such
that we have
$$
H^i(X_{A'}, \mathcal{F}_{A'}) = H^i(M^\bullet \otimes_A A')
$$
functorially in $A'$. The condition that $\mathcal{F}$ is
flat over $A$ is essential, see \cite{Hartshorne}.
\end{remark}





\section{Grothendieck's existence theorem, I}
\label{section-existence}

\noindent
In this section we discuss Grothendieck's existence theorem for the
projective case. As we do not
yet have the theory of formal schemes to our disposal, we temporarily develop
a bit of language that replaces the notion of a ``coherent module on a
Noetherian adic formal scheme''. The reader who is familiar
with formal schemes is encouraged to read the statement and proof
of the theorem in \cite{EGA}.

\medskip\noindent
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Below we will consider inverse
systems $(\mathcal{F}_n)$ of coherent $\mathcal{O}_X$-modules such that
\begin{enumerate}
\item $\mathcal{F}_n$ is annihilated by $\mathcal{I}^n$, and
\item the transition maps induce isomorphisms
$\mathcal{F}_{n + 1}/\mathcal{I}^n\mathcal{F}_{n + 1} \to \mathcal{F}_n$.
\end{enumerate}
A morphism of such inverse systems is defined as usual.
Let us denote the category of these inverse systems with
$\textit{Coh}(X, \mathcal{I})$. We are going to proceed by proving
a bunch of lemmas about objects in this category. In fact, most
of the lemmas that follow are straightforward consequences of the following
description of the category in the affine case.

\begin{lemma}
\label{lemma-inverse-systems-affine}
If $X = \Spec(A)$ is the spectrum of a Noetherian ring and
$\mathcal{I}$ is the quasi-coherent sheaf of ideals associated to the ideal
$I \subset A$, then $\textit{Coh}(X, \mathcal{I})$ is equivalent to the
category of finite $A^\wedge$-modules where $A^\wedge$ is the completion
of $A$ with respect to $I$.
\end{lemma}

\begin{proof}
Let $\text{Mod}^{fg}_{A, I}$ be the category of inverse systems $(M_n)$
of finite $A$-modules satisfying: (1) $M_n$ is annihilated by $I^n$ and (2)
$M_{n + 1}/I^nM_{n + 1} = M_n$. By the correspondence between coherent
sheaves on $X$ and finite $A$-modules (Lemma \ref{lemma-coherent-Noetherian})
it suffices to show $\text{Mod}^{fg}_{A, I}$ is equivalent to the category of
finite $A^\wedge$-modules. To see this it suffices to prove that given
an object $(M_n)$ of $\text{Mod}^{fg}_{A, I}$ the module
$$
M = \lim M_n
$$
is a finite $A^\wedge$-module and that $M/I^nM = M_n$. As the transition
maps are surjective, we see that $M \to M_1$ is surjective.
Pick $x_1, \ldots, x_t \in M$ which map to generators of $M_1$.
This induces a map of systems $(A/I^n)^{\oplus t} \to M_n$.
By Nakayama's lemma (Algebra, Lemma \ref{algebra-lemma-NAK}) these maps are
surjective. Let $K_n \subset (A/I^n)^{\oplus t}$ be the kernel.
Property (2) implies that $K_{n + 1} \to K_n$ is surjective, in particular
the system $(K_n)$ satisfies the Mittag-Leffler condition.
By Homology, Lemma \ref{homology-lemma-Mittag-Leffler}
we obtain an exact sequence
$0 \to K \to (A^\wedge)^{\oplus t} \to M \to 0$
with $K = \lim K_n$.
Hence $M$ is a finite $A^\wedge$-module.
As $K \to K_n$ is surjective it follows that
$$
M/I^nM = \Coker(K \to (A/I^n)^{\oplus t}) =
(A/I^n)^{\oplus t}/K_n = M_n
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-inverse-systems-abelian}
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals.
\begin{enumerate}
\item The category $\textit{Coh}(X, \mathcal{I})$ is abelian.
\item For $U \subset X$ open the restriction functor
$\textit{Coh}(X, \mathcal{I}) \to \textit{Coh}(U, \mathcal{I}|_U)$
is exact.
\item Exactness in $\textit{Coh}(X, \mathcal{I})$ may be checked by
restricting to the members of an open covering of $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\alpha =(\alpha_n) : (\mathcal{F}_n) \to (\mathcal{G}_n)$ be a morphism of
$\textit{Coh}(X, \mathcal{I})$. The cokernel of $\alpha$ is the inverse system
$(\Coker(\alpha_n))$ (details omitted). To describe the kernel let
$$
\mathcal{K}'_{l, m} = \Im(\Ker(\alpha_l) \to \mathcal{F}_m)
$$
for $l \geq m$.
We claim:
\begin{enumerate}
\item[(a)] the inverse system $(\mathcal{K}'_{l, m})_{l \geq m}$ is
eventually constant, say with value $\mathcal{K}'_m$,
\item[(b)] the system $(\mathcal{K}'_m/\mathcal{I}^n\mathcal{K}'_m)_{m \geq n}$
is eventually constant, say with value $\mathcal{K}_n$,
\item[(c)] the system $(\mathcal{K}_n)$ forms an object of
$\textit{Coh}(X, \mathcal{I})$, and
\item[(d)] this object is the kernel of $\alpha$.
\end{enumerate}
To see (a), (b), and (c) we may work affine locally, say $X = \Spec(A)$
and $\mathcal{I}$ corresponds to the ideal $I \subset A$. By
Lemma \ref{lemma-inverse-systems-affine}
$\alpha$ corresponds to a map $f : M \to N$ of finite $A^\wedge$-modules.
Denote $K = \Ker(f)$. Note that $A^\wedge$ is a Noetherian
ring (Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian}).
Choose an integer $c \geq 0$ such that
$K \cap I^n M \subset I^{n - c}K$ for $n \geq c$
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
and which satisfies Algebra, Lemma \ref{algebra-lemma-map-AR}
for the map $f$ and the ideal $I^\wedge = IA^\wedge$. Then
$\mathcal{K}'_{l, m}$ corresponds to the $A$-module
$$
K'_{l, m} = \frac{a^{-1}(I^lN) + I^mM}{I^mM} =
\frac{K + I^{l - c}f^{-1}(I^cN) + I^mM}{I^mM} =
\frac{K + I^mM}{I^mM}
$$
where the last equality holds if $l \geq m + c$. So $\mathcal{K}'_m$
corresponds to the $A$-module $K/K \cap I^mM$ and
$\mathcal{K}'_m/\mathcal{I}^n\mathcal{K}'_m$ corresponds to
$$
\frac{K}{K \cap I^mM + I^nK} = \frac{K}{I^nK}
$$
for $m \geq n + c$ by our choice of $c$ above. Hence $\mathcal{K}_n$
corresponds to $K/I^nK$.

\medskip\noindent
We prove (d). It is clear from the description on affines above that
the composition $(\mathcal{K}_n) \to (\mathcal{F}_n) \to (\mathcal{G}_n)$
is zero. Let $\beta : (\mathcal{H}_n) \to (\mathcal{F}_n)$
be a morphism such that $\alpha \circ \beta = 0$. Then
$\mathcal{H}_l \to \mathcal{F}_l$ maps into $\Ker(\alpha_l)$.
Since $\mathcal{H}_m = \mathcal{H}_l/\mathcal{I}^m\mathcal{H}_l$
for $l \geq m$ we obtain a system of maps
$\mathcal{H}_m \to \mathcal{K}'_{l, m}$. Thus a map
$\mathcal{H}_m \to \mathcal{K}_m'$. Since
$\mathcal{H}_n = \mathcal{H}_m/\mathcal{I}^n\mathcal{H}_m$ we obtain
a system of maps $\mathcal{H}_n \to \mathcal{K}'_m/\mathcal{I}^n\mathcal{K}'_m$
and hence a map $\mathcal{H}_n \to \mathcal{K}_n$ as desired.

\medskip\noindent
To finish the proof of (1) we still have to show that $\Coim = \Im$
in $\textit{Coh}(X, \mathcal{I})$. We have seen above that taking
kernels and cokernels commutes, over affines, with the description
of $\textit{Coh}(X, \mathcal{I})$ as a category of modules. Since
$\Im = \Coim$ holds in the category of modules
this gives $\Coim = \Im$ in $\textit{Coh}(X, \mathcal{I})$.
Parts (2) and (3) of the lemma are immediate from our construction
of kernels and cokernels.
\end{proof}

\begin{lemma}
\label{lemma-inverse-systems-surjective}
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. A map
$(\mathcal{F}_n) \to (\mathcal{G}_n)$ is surjective in
$\textit{Coh}(X, \mathcal{I})$
if and only if $\mathcal{F}_1 \to \mathcal{G}_1$ is surjective.
\end{lemma}

\begin{proof}
Omitted. Hint: Look on affine opens, use
Lemma \ref{lemma-inverse-systems-affine}, and use
Algebra, Lemma \ref{algebra-lemma-NAK}.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-rees-algebra}
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. If $(\mathcal{F}_n)$ is an object of
$\textit{Coh}(X, \mathcal{I})$ then
$\bigoplus \Ker(\mathcal{F}_{n + 1} \to \mathcal{F}_n)$ is
a finite type, graded, quasi-coherent
$\bigoplus \mathcal{I}^n/\mathcal{I}^{n + 1}$-module.
\end{lemma}

\begin{proof}
The question is local on $X$ hence we may assume $X$ is affine, i.e.,
we have a situation as in Lemma \ref{lemma-inverse-systems-affine}.
In this case, if $(\mathcal{F}_n)$ corresponds to the finite $A^\wedge$
module $M$, then $\bigoplus \Ker(\mathcal{F}_{n + 1} \to \mathcal{F}_n)$
corresponds to $\bigoplus I^nM/I^{n + 1}M$ which is clearly a finite
module over $\bigoplus I^n/I^{n + 1}$.
\end{proof}

\noindent
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. There is a functor
\begin{equation}
\label{equation-completion-functor}
\textit{Coh}(\mathcal{O}_X) \longrightarrow \textit{Coh}(X, \mathcal{I}), \quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
\end{equation}
which associates to the coherent $\mathcal{O}_X$-module $\mathcal{F}$
the object $\mathcal{F}^\wedge = (\mathcal{F}/\mathcal{I}^n\mathcal{F})$
of $\textit{Coh}(X, \mathcal{I})$.

\begin{lemma}
\label{lemma-exact}
The functor (\ref{equation-completion-functor}) is exact.
\end{lemma}

\begin{proof}
It suffices to check this locally on $X$. Hence we may assume $X$ is
affine, i.e., we have a situation as in
Lemma \ref{lemma-inverse-systems-affine}.
The functor is the functor $\text{Mod}^{fg}_A \to \text{Mod}^{fg}_{A^\wedge}$
which associates to a finite $A$-module $M$ the completion $M^\wedge$.
Thus the result follows from
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
\end{proof}

\begin{lemma}
\label{lemma-completion-internal-hom}
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $\mathcal{F}$, $\mathcal{G}$ be
coherent $\mathcal{O}_X$-modules. Set
$\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{G}, \mathcal{F})$.
Then
$$
\lim H^0(X, \mathcal{H}/\mathcal{I}^n\mathcal{H}) =
\Mor_{\textit{Coh}(X, \mathcal{I})}
(\mathcal{G}^\wedge, \mathcal{F}^\wedge).
$$
\end{lemma}

\begin{proof}
To prove this we may work affine locally on $X$.
Hence we may assume $X = \Spec(A)$ and $\mathcal{F}$, $\mathcal{G}$
given by finite $A$-module $M$ and $N$. Then $\mathcal{H}$
corresponds to the finite $A$-module $H = \Hom_A(M, N)$.
The statement of the lemma becomes the statement
$$
H^\wedge = \Hom_{A^\wedge}(M^\wedge, N^\wedge)
$$
via the equivalence of Lemma \ref{lemma-inverse-systems-affine}.
By Algebra, Lemma \ref{algebra-lemma-completion-flat}
(used 3 times) we have
$$
H^\wedge = \Hom_A(M, N) \otimes_A A^\wedge =
\Hom_{A^\wedge}(M \otimes_A A^\wedge, N \otimes_A A^\wedge) =
\Hom_{A^\wedge}(M^\wedge, N^\wedge)
$$
where the second equality uses that $A^\wedge$ is flat over $A$
(see More on Algebra, Remark
\ref{more-algebra-remark-pseudo-coherence-and-base-change-ext}).
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful}
Let $A$ be Noetherian ring complete with respect to an ideal $I$.
Let $f : X \to \Spec(A)$ be a proper morphism. Let
$\mathcal{I} = I\mathcal{O}_X$.
Then the functor (\ref{equation-completion-functor}) is fully faithful.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules.
Then $\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{G}, \mathcal{F})$
is a coherent $\mathcal{O}_X$-module, see
Modules, Lemma \ref{modules-lemma-internal-hom-locally-kernel-direct-sum}.
By Lemma \ref{lemma-completion-internal-hom} the map
$$
\lim_n H^0(X, \mathcal{H}/\mathcal{I}^n\mathcal{H})
\to
\Mor_{\textit{Coh}(X, \mathcal{I})}
(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
is bijective. Hence fully faithfulness of
(\ref{equation-completion-functor}) follows from the theorem on formal
functions (Lemma \ref{lemma-spell-out-theorem-formal-functions})
for the coherent sheaf $\mathcal{H}$.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-projective}
Let $A$ be Noetherian ring and $I \subset A$ and ideal.
Let $f : X \to \Spec(A)$ be a proper morphism and let
$\mathcal{L}$ be an $f$-ample invertible sheaf. Let
$\mathcal{I} = I\mathcal{O}_X$. Let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(X, \mathcal{I})$. Then there exists an
integer $d_0$ such that
$$
H^1(X, \Ker(\mathcal{F}_{n + 1} \to \mathcal{F}_n)
\otimes \mathcal{L}^{\otimes d} )
= 0
$$
for all $n \geq 0$ and all $d \geq d_0$.
\end{lemma}

\begin{proof}
Set $B = \bigoplus I^n/I^{n + 1}$ and
$\mathcal{B} = \bigoplus \mathcal{I}^n/\mathcal{I}^{n + 1} = f^*\widetilde{B}$.
By Lemma \ref{lemma-finite-over-rees-algebra} the graded quasi-coherent
$\mathcal{B}$-module
$\mathcal{G} = \bigoplus \Ker(\mathcal{F}_{n + 1} \to \mathcal{F}_n)$
is of finite type. Hence the lemma follows from
Lemma \ref{lemma-graded-finiteness} part (2).
\end{proof}

\begin{lemma}
\label{lemma-existence-projective}
Let $A$ be Noetherian ring complete with respect to an ideal $I$.
Let $f : X \to \Spec(A)$ be a projective morphism. Let
$\mathcal{I} = I\mathcal{O}_X$.
Then the functor (\ref{equation-completion-functor}) is an equivalence.
\end{lemma}

\begin{proof}
We have already seen that (\ref{equation-completion-functor}) is
fully faithful in Lemma \ref{lemma-fully-faithful}. Thus it suffices
to show that the functor is essentially surjective.

\medskip\noindent
We first show that every object $(\mathcal{F}_n)$ of
$\textit{Coh}(X, \mathcal{I})$ is the quotient of an object
in the image of (\ref{equation-completion-functor}). 
Let $\mathcal{L}$ be an $f$-ample invertible sheaf on $X$.
Choose $d_0$ as in Lemma \ref{lemma-vanishing-projective}.
Choose a $d \geq d_0$ such that
$\mathcal{F}_1 \otimes \mathcal{L}^{\otimes d}$
is globally generated by some sections $s_{1, 1}, \ldots, s_{t, 1}$.
Since the transition maps of the system
$$
H^0(X, \mathcal{F}_{n + 1} \otimes \mathcal{L}^{\otimes d})
\longrightarrow
H^0(X, \mathcal{F}_n \otimes \mathcal{L}^{\otimes d})
$$
are surjective by the vanishing of $H^1$ we can lift
$s_{1, 1}, \ldots, s_{t, 1}$ to a compatible system of global sections
$s_{1, n}, \ldots, s_{t, n}$ of
$\mathcal{F}_n \otimes \mathcal{L}^{\otimes d}$.
These determine a compatible system of maps
$$
(s_{1, n}, \ldots, s_{t, n}) :
(\mathcal{L}^{\otimes -d})^{\oplus t} \longrightarrow \mathcal{F}_n
$$
Using Lemma \ref{lemma-inverse-systems-surjective}
we deduce that we have a surjective map
$$
\left((\mathcal{L}^{\otimes -d})^{\oplus t}\right)^\wedge
\longrightarrow
(\mathcal{F}_n)
$$
as desired.

\medskip\noindent
The result of the previous paragraph and the fact that
$\textit{Coh}(X, \mathcal{I})$ is abelian
(Lemma \ref{lemma-inverse-systems-abelian})
implies that
every object of $\textit{Coh}(X, \mathcal{I})$ is a cokernel
of a map between objects coming from $\textit{Coh}(\mathcal{O}_X)$.
As (\ref{equation-completion-functor}) is fully faithful and exact by
Lemmas \ref{lemma-fully-faithful} and \ref{lemma-exact}
we conclude.
\end{proof}








\section{Grothendieck's existence theorem, II}
\label{section-existence-proper}

\noindent
In this section we discuss Grothendieck's existence theorem.
Before we give the statement and proof, we need to develop a bit
more theory regarding the categories $\textit{Coh}(X, \mathcal{I})$
introduced in Section \ref{section-existence}.

\begin{lemma}
\label{lemma-inverse-systems-pullback}
Let $f : X \to Y$ be a morphism of Noetherian schemes.
Let $\mathcal{J} \subset \mathcal{O}_Y$ be a quasi-coherent sheaf
of ideals and set $\mathcal{I} = f^{-1}\mathcal{J} \mathcal{O}_X$.
Then there is a right exact functor
$$
f^* : \textit{Coh}(Y, \mathcal{J}) \longrightarrow \textit{Coh}(X, \mathcal{I})
$$
which sends $(\mathcal{G}_n)$ to $(f^*\mathcal{G}_n)$. If $f$ is flat,
then $f^*$ is an exact functor.
\end{lemma}

\begin{proof}
Since $f^* : \textit{Coh}(\mathcal{O}_Y) \to \textit{Coh}(\mathcal{O}_X)$
is right exact we have
$$
f^*\mathcal{G}_n =
f^*(\mathcal{G}_{n + 1}/\mathcal{I}^n\mathcal{G}_{n + 1}) =
f^*\mathcal{G}_{n + 1}/f^{-1}\mathcal{I}^nf^*\mathcal{G}_{n + 1} =
f^*\mathcal{G}_{n + 1}/\mathcal{J}^nf^*\mathcal{G}_{n + 1}
$$
hence the pullback of a system is a system. The construction of
cokernels in the proof of Lemma \ref{lemma-inverse-systems-abelian}
shows that
$f^* : \textit{Coh}(Y, \mathcal{J}) \to \textit{Coh}(X, \mathcal{I})$
is always right exact. If $f$ is flat, then
$f^* : \textit{Coh}(\mathcal{O}_Y) \to \textit{Coh}(\mathcal{O}_X)$
is an exact functor. It follows from the construction of kernels
in the proof of Lemma \ref{lemma-inverse-systems-abelian}
that in this case
$f^* : \textit{Coh}(Y, \mathcal{J}) \to \textit{Coh}(X, \mathcal{I})$
also transforms kernels into kernels.
\end{proof}

\begin{remark}
\label{remark-inverse-systems-kernel-cokernel-annihilated-by}
Let $X$ be a Noetherian scheme and let
$\mathcal{I}, \mathcal{K} \subset \mathcal{O}_X$
be quasi-coherent sheaves of ideals. Let
$\alpha : (\mathcal{F}_n) \to (\mathcal{G}_n)$ be a morphism of
$\textit{Coh}(X, \mathcal{I})$.
Given an affine open $\Spec(A) = U \subset X$ with
$\mathcal{I}|_U, \mathcal{K}|_U$ corresponding to ideals $I, K \subset A$
denote $\alpha_U : M \to N$ of finite $A^\wedge$-modules which
corresponds to $\alpha|_U$ via Lemma \ref{lemma-inverse-systems-affine}.
We claim the following are equivalent
\begin{enumerate}
\item there exists an integer $t \geq 1$ such that
$\Ker(\alpha_n)$ and $\Coker(\alpha_n)$
are annihilated by $\mathcal{K}^t$ for all $n \geq 1$,
\item for any affine open $\Spec(A) = U \subset X$ as above
the modules $\Ker(\alpha_U)$ and $\Coker(\alpha_U)$
are annihilated by $K^t$ for some integer $t \geq 1$, and
\item there exists a finite affine open covering $X = \bigcup U_i$
such that the conclusion of (2) holds for $\alpha_{U_i}$.
\end{enumerate}
If these equivalent conditions hold we will say that
$\alpha$ is a
{\it map whose kernel and cokernel are annihilated by a power of
$\mathcal{K}$}.
To see the equivalence we use the following commutative algebra fact:
suppose given an exact sequence
$$
0 \to T \to M \to N \to Q \to 0
$$
of $A$-modules with $T$ and $Q$ annihilated by $K^t$ for some
ideal $K \subset A$. Then for every $f, g \in K^t$ there exists a
canonical map $"fg": N \to M$ such that $M \to N \to M$ is equal to
multiplication by $fg$. Namely, for $y \in N$ we can pick $x \in M$
mapping to $fy$ in $N$ and then we can set $"fg"(y) = gx$. Thus it is
clear that $\Ker(M/JM \to N/JN)$ and $\Coker(M/JM \to N/JN)$
are annihilated by $K^{2t}$ for any ideal $J \subset A$.

\medskip\noindent
Applying the commutative algebra fact to $\alpha_{U_i}$ and $J = I^n$
we see that (3) implies (1). Conversely,
suppose (1) holds and $M \to N$ is equal to $\alpha_U$. Then there is
a $t \geq 1$ such that
$\Ker(M/I^nM \to N/I^nN)$ and $\Coker(M/I^nM \to N/I^nN)$
are annihilated by $K^t$ for all $n$. We obtain maps
$"fg" : N/I^nN \to M/I^nM$ which in the limit induce a map $N \to M$
as $N$ and $M$ are $I$-adically complete. Since the composition with
$N \to M \to N$ is multiplication by $fg$ we conclude that $fg$
annihilates $T$ and $Q$. In other words $T$ and $Q$ are annihilated by
$K^{2t}$ as desired.
\end{remark}

\begin{lemma}
\label{lemma-existence-easy}
Let $X$ be a Noetherian scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $\mathcal{G}$ be a coherent
$\mathcal{O}_X$-module, $(\mathcal{F}_n)$ an object of
$\textit{Coh}(X, \mathcal{I})$, and
$\alpha : (\mathcal{F}_n) \to \mathcal{G}^\wedge$
a map whose kernel and cokernel are annihilated by a power of $\mathcal{I}$.
Then there exists a unique (up to unique isomorphism) triple
$(\mathcal{F}, a, \beta)$ where
\begin{enumerate}
\item $\mathcal{F}$ is a coherent $\mathcal{O}_X$-module,
\item $a : \mathcal{F} \to \mathcal{G}$ is an $\mathcal{O}_X$-module map
whose kernel and cokernel are annihilated by a power of $\mathcal{I}$,
\item $\beta : (\mathcal{F}_n) \to \mathcal{F}^\wedge$ is an isomorphism, and
\item $\alpha = a^\wedge \circ \beta$.
\end{enumerate}
\end{lemma}

\begin{proof}
The uniqueness implies it suffices to construct $(\mathcal{F}, a, \beta)$
Zariski locally on $X$. Thus we may assume $X = \Spec(A)$ and $\mathcal{I}$
corresponds to the ideal $I \subset A$. In this situation
Lemma \ref{lemma-inverse-systems-affine} applies.
Let $M'$ be the finite $A^\wedge$-module corresponding
to $(\mathcal{F}_n)$. Let $N$ be the finite $A$-module corresponding to
$\mathcal{G}$. Then $\alpha$ corresponds to a map
$$
\varphi : M' \longrightarrow N^\wedge
$$
whose kernel and cokernel are annihilated by $I^t$ for some $t$. Recall that
$N^\wedge = N \otimes_A A^\wedge$
(Algebra, Lemma \ref{algebra-lemma-completion-tensor}).
By More on Algebra, Lemma \ref{more-algebra-lemma-application-formal-glueing}
there is an $A$-module map $\psi : M \to N$ whose kernel and cokernel are
$I$-power torsion and an isomorphism
$M \otimes_A A^\wedge = M'$ compatible with $\varphi$.
As $N$ and $M'$ are finite modules, we conclude that $M$
is a finite $A$-module, see
More on Algebra, Remark \ref{more-algebra-remark-formal-glueing-algebras}.
Hence $M \otimes_A A^\wedge = M^\wedge$. We omit the verification
that the triple $(M, N \to M, M^\wedge \to M')$ so obtained
is unique up to unique isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-existence-tricky}
Let $X$ be a Noetherian scheme. Let
$\mathcal{I}, \mathcal{K} \subset \mathcal{O}_X$
be quasi-coherent sheaves of ideals.
Let $X_e \subset X$ be the closed subscheme cut out by $\mathcal{K}^e$.
Let $\mathcal{I}_e = \mathcal{I}\mathcal{O}_{X_e}$.
Let $(\mathcal{F}_n)$ be an object of $\textit{Coh}(X, \mathcal{I})$.
Assume
\begin{enumerate}
\item the functor
$\textit{Coh}(\mathcal{O}_{X_e}) \to \textit{Coh}(X_e, \mathcal{I}_e)$
is an equivalence for all $e \geq 1$, and
\item there exists a coherent sheaf $\mathcal{H}$ on $X$ and a map
$\alpha : (\mathcal{F}_n) \to \mathcal{H}^\wedge$ whose
kernel and cokernel are annihilated by a power of $\mathcal{K}$.
\end{enumerate}
Then $(\mathcal{F}_n)$ is in the essential image of
(\ref{equation-completion-functor}).
\end{lemma}

\begin{proof}
During this proof we will use without further mention that for a closed
immersion $i : Z \to X$ the functor $i_*$ gives an equivalence between the
category of coherent modules on $Z$ and coherent modules on $X$ annihilated
by the ideal sheaf of $Z$, see Lemma \ref{lemma-i-star-equivalence}.
In particular we may identify $\textit{Coh}(\mathcal{O}_{X_e})$
with the category of coherent $\mathcal{O}_X$-modules annihilated by
$\mathcal{K}^e$ and $\textit{Coh}(X_e, \mathcal{I}_e)$ as the full subcategory
of $\textit{Coh}(X, \mathcal{I})$ of objects annihilated by $\mathcal{K}^e$.
Moreover (1) tells us these two categories are equivalent under the
completion functor (\ref{equation-completion-functor}).

\medskip\noindent
Applying this equivalence we get a coherent $\mathcal{O}_X$-module
$\mathcal{G}_e$ annihilated by $\mathcal{K}^e$ corresponding to the system
$(\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n)$ of
$\textit{Coh}(X, \mathcal{I})$. The maps
$\mathcal{F}_n/\mathcal{K}^{e + 1}\mathcal{F}_n \to
\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n$ correspond to canonical maps
$\mathcal{G}_{e + 1} \to \mathcal{G}_e$ which induce isomorphisms
$\mathcal{G}_{e + 1}/\mathcal{K}^e\mathcal{G}_{e + 1} \to \mathcal{G}_e$.
Hence $(\mathcal{G}_e)$ is an object of $\textit{Coh}(X, \mathcal{K})$.
The map $\alpha$ induces a system of maps
$$
\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n
\longrightarrow
\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H}
$$
whence maps $\mathcal{G}_e \to \mathcal{H}/\mathcal{K}^e\mathcal{H}$
(by the equivalence of categories again).
Let $t \geq 1$ be an integer, which exists by assumption (2),
such that $\mathcal{K}^t$ annihilates the kernel and cokernel of all the maps
$\mathcal{F}_n \to \mathcal{H}/\mathcal{I}^n\mathcal{H}$.
Then $\mathcal{K}^{2t}$ annihilates the kernel and cokernel of the maps
$\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n \to
\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H}$, see
Remark \ref{remark-inverse-systems-kernel-cokernel-annihilated-by}.
Whereupon we conclude that $\mathcal{K}^{4t}$ annihilates the kernel and
the cokernel of the maps
$$
\mathcal{G}_e
\longrightarrow
\mathcal{H}/\mathcal{K}^e\mathcal{H},
$$
see Remark \ref{remark-inverse-systems-kernel-cokernel-annihilated-by}.
We apply Lemma \ref{lemma-existence-easy} to obtain a coherent
$\mathcal{O}_X$-module $\mathcal{F}$, a map
$a : \mathcal{F} \to \mathcal{H}$ and an isomorphism
$\beta : (\mathcal{G}_e) \to (\mathcal{F}/\mathcal{K}^e\mathcal{F})$
in $\textit{Coh}(X, \mathcal{K})$. Working backwards, for a given $n$
the triple
$(\mathcal{F}/\mathcal{I}^n\mathcal{F}, a \bmod \mathcal{I}^n, \beta
\bmod \mathcal{I}^n)$ is a triple as in the lemma for the morphism
$\alpha_n \bmod \mathcal{K}^e :
(\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n) \to
(\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H})$
of $\textit{Coh}(X, \mathcal{K})$. Thus the uniqueness in
Lemma \ref{lemma-existence-easy}
gives a canonical isomorphism
$\mathcal{F}/\mathcal{I}^n\mathcal{F} \to \mathcal{F}_n$
compatible with all the morphisms in sight. This finishes the proof
of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-inverse-systems-push-pull}
Let $Y$ be a Noetherian scheme. Let
$\mathcal{J}, \mathcal{K} \subset \mathcal{O}_Y$
be quasi-coherent sheaves of ideals.
Let $f : X \to Y$ be a proper morphism which is an isomorphism
over $V = Y \setminus V(\mathcal{K})$.
Set $\mathcal{I} = f^{-1}\mathcal{J} \mathcal{O}_X$.
Let $(\mathcal{G}_n)$ be an object of $\textit{Coh}(Y, \mathcal{J})$,
let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module, and let
$\beta : (f^*\mathcal{G}_n)  \to \mathcal{F}^\wedge$ be an isomorphism in
$\textit{Coh}(X, \mathcal{I})$. Then there exists a map
$$
\alpha :
(\mathcal{G}_n)
\longrightarrow
(f_*\mathcal{F})^\wedge
$$
in $\textit{Coh}(Y, \mathcal{J})$ whose kernel and cokernel
are annihilated by a power of $\mathcal{K}$.
\end{lemma}

\begin{proof}
Since $f$ is a proper morphism we see that $f_*\mathcal{F}$
is a coherent $\mathcal{O}_Y$-module
(Proposition \ref{proposition-proper-pushforward-coherent}).
Thus the statement of the lemma makes sense.
Consider the compositions
$$
\gamma_n : \mathcal{G}_n \to
f_*f^*\mathcal{G}_n \to
f_*(\mathcal{F}/\mathcal{I}^n\mathcal{F}).
$$
Here the first map is the adjunction map and the second is $f_*\beta_n$.
We claim that there exists a unique $\alpha$ as in the lemma
such that the compositions
$$
\mathcal{G}_n \xrightarrow{\alpha_n}
f_*\mathcal{F}/\mathcal{J}^nf_*\mathcal{F} \to
f_*(\mathcal{F}/\mathcal{I}^n\mathcal{F})
$$
equal $\gamma_n$ for all $n$. Because of the uniqueness we may assume
that $Y = \Spec(B)$ is affine. Let $J \subset B$ corresponds to the
ideal $\mathcal{J}$. Set
$$
M_n = H^0(X, \mathcal{F}/\mathcal{I}^n\mathcal{F})
\quad\text{and}\quad
M = H^0(X, \mathcal{F})
$$
By Lemma \ref{lemma-ML-cohomology-powers-ideal} and
Theorem \ref{theorem-formal-functions}
the inverse limit of the modules
$M_n$ equals the completion $M^\wedge = \lim M/J^nM$.
Set $N_n = H^0(Y, \mathcal{G}_n)$ and $N = \lim N_n$.
Via the equivalence of categories of
Lemma \ref{lemma-inverse-systems-affine}
the finite $B^\wedge$ modules $N$ and $M^\wedge$ correspond
to $(\mathcal{G}_n)$ and $f_*\mathcal{F}^\wedge$.
It follows from this that $\alpha$ has to be the morphism of
$\textit{Coh}(Y, \mathcal{J})$ corresponding to the homomorphism
$$
\lim \gamma_n : N = \lim_n N_n \longrightarrow \lim M_n = M^\wedge
$$
of finite $B^\wedge$-modules.

\medskip\noindent
We still have to show that the kernel and cokernel of $\alpha$ are
annihilated by a power of $\mathcal{K}$. Set $Y' = \Spec(B^\wedge)$
and $X' = Y' \times_Y X$. Let $\mathcal{K}'$, $\mathcal{J}'$, $\mathcal{G}'_n$
and $\mathcal{I}'$, $\mathcal{F}'$ be the pullback of
$\mathcal{K}$, $\mathcal{J}$, $\mathcal{G}_n$ and
$\mathcal{I}$, $\mathcal{F}$, to $Y'$ and $X'$.
The projection morphism $f' : X' \to Y'$ is the base change of
$f$ by $Y' \to Y$. Note that $Y' \to Y$ is a flat morphism of schemes
as $B \to B^\wedge$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Hence $f'_*\mathcal{F}'$, resp.\ $f'_*(f')^*\mathcal{G}_n'$
is the pullback of $f_*\mathcal{F}$, resp.\ $f_*f^*\mathcal{G}_n$
to $Y'$ by Lemma \ref{lemma-flat-base-change-cohomology}.
The uniqueness of our construction shows the pullback of $\alpha$ to $Y'$
is the corresponding map $\alpha'$ constructed for the situation on $Y'$.
Moreover, to check that the kernel and cokernel of $\alpha$ are
annihilated by $\mathcal{K}^t$ it suffices to check that the
kernel and cokernel of $\alpha'$ are annihilated by
$(\mathcal{K}')^t$. Namely, to see this we need to check this for
kernels and cokernels of the maps $\alpha_n$ and $\alpha'_n$
(see Remark \ref{remark-inverse-systems-kernel-cokernel-annihilated-by})
and the ring map $B \to B^\wedge$ induces
an equivalence of categories between modules annihilated by
$J^n$ and $(J')^n$, see
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-equivalence}.
Thus we may assume $B$ is complete with respect to $J$.

\medskip\noindent
Assume $Y = \Spec(B)$ is affine, $\mathcal{J}$ corresponds to the ideal
$J \subset B$, and $B$ is complete with respect to $J$.
In this case $(\mathcal{G}_n)$ is in the essential image of the functor
$\textit{Coh}(\mathcal{O}_Y) \to \textit{Coh}(Y, \mathcal{J})$.
Say $\mathcal{G}$ is a coherent $\mathcal{O}_Y$-module such that
$(\mathcal{G}_n) = \mathcal{G}^\wedge$. Note that
$f^*(\mathcal{G}^\wedge) = (f^*\mathcal{G})^\wedge$. Hence
Lemma \ref{lemma-fully-faithful}
tells us that $\beta$ comes from an isomorphism
$b : f^*\mathcal{G} \to \mathcal{F}$
and $\alpha$ is the completion functor applied to
$$
\mathcal{G} \to f_*f^*\mathcal{G} \cong f_*\mathcal{F}
$$
Hence we are trying to verify that the kernel and cokernel of the
adjunction map $c : \mathcal{G} \to f_*f^*\mathcal{G}$ are annihilated by
a power of $\mathcal{K}$. However, since the restriction
$f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is an isomorphism
we see that $c|_V$ is an isomorphism. Thus the coherent sheaves
$\Ker(c)$ and $\Coker(c)$ are supported on $V(\mathcal{K})$
hence are annihilated by a power of $\mathcal{K}$
(Lemma \ref{lemma-power-ideal-kills-sheaf}) as desired.
\end{proof}

\noindent
The following proposition is the form of Grothendieck's existence
theorem which is most often used in practice.

\begin{proposition}
\label{proposition-existence-proper}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Let $f : X \to \Spec(A)$ be a proper morphism of schemes.
Set $\mathcal{I} = I\mathcal{O}_X$.
Then the functor (\ref{equation-completion-functor}) is an equivalence.
\end{proposition}

\begin{proof}
We have already seen that (\ref{equation-completion-functor}) is
fully faithful in Lemma \ref{lemma-fully-faithful}. Thus it suffices
to show that the functor is essentially surjective.

\medskip\noindent
Consider the collection $\Xi$ of quasi-coherent sheaves of ideals
$\mathcal{K} \subset \mathcal{O}_X$ such that every object
$(\mathcal{F}_n)$ annihilated by $\mathcal{K}$ is in the essential image.
We want to show $(0)$ is in $\Xi$. If not, then since $X$ is Noetherian
there exists a maximal quasi-coherent sheaf of ideals $\mathcal{K}$
not in $\Xi$, see
Lemma \ref{lemma-acc-coherent}.
After replacing $X$ by the closed subscheme of $X$
corresponding to $\mathcal{K}$ we may assume that every nonzero
$\mathcal{K}$ is in $\Xi$. (This uses the correspondence by
coherent modules annihilated by $\mathcal{K}$ and coherent modules
on the closed subscheme corresponding to $\mathcal{K}$, see
Lemma \ref{lemma-i-star-equivalence}.)
Let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}(X, \mathcal{I})$.
We will show that this object is in the essential image of the
functor (\ref{equation-completion-functor}), thereby completion the
proof of the proposition.

\medskip\noindent
Apply Chow's lemma (Lemma \ref{lemma-chow-Noetherian}) to find a
proper surjective morphism $f : X' \to X$ which is an isomorphism
over a dense open $U \subset X$ such that $X'$ is projective over $A$.
Let $\mathcal{K}$ be the quasi-coherent sheaf of ideals cutting
out the reduced complement $X \setminus U$. By the projective
case of Grothendieck's existence theorem
(Lemma \ref{lemma-existence-projective})
there exists a coherent module $\mathcal{F}'$ on $X'$ such
that $(\mathcal{F}')^\wedge \cong (f^*\mathcal{F}_n)$. By
Proposition \ref{proposition-proper-pushforward-coherent}
the $\mathcal{O}_X$-module $\mathcal{H} = f_*\mathcal{F}'$ is coherent
and by Lemma \ref{lemma-inverse-systems-push-pull}
there exists a morphism $(\mathcal{F}_n) \to \mathcal{H}^\wedge$
of $\textit{Coh}(X, \mathcal{I})$ whose kernel and cokernel are
annihilated by a power of $\mathcal{K}$. The powers $\mathcal{K}^e$
are all in $\Xi$ so that (\ref{equation-completion-functor})
is an equivalence for the closed subschemes $X_e = V(\mathcal{K}^e)$.
We conclude by Lemma \ref{lemma-existence-tricky}.
\end{proof}





\section{Being proper over a base}
\label{section-proper-over-base}

\noindent
This is just a short section to point out some useful features
of closed subsets proper over a base and finite type, quasi-coherent
modules with support proper over a base.

\begin{lemma}
\label{lemma-closed-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $Z \subset X$ be a closed subset. The following are equivalent
\begin{enumerate}
\item the morphism $Z \to S$ is proper if $Z$ is endowed with the reduced
induced closed subscheme structure
(Schemes, Definition \ref{schemes-definition-reduced-induced-scheme}),
\item for some closed subscheme structure on $Z$ the morphism $Z \to S$
is proper,
\item for any closed subscheme structure on $Z$ the morphism
$Z \to S$ is proper.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (3) $\Rightarrow$ (2) and (1) $\Rightarrow$ (2)
are immediate. Thus it suffices to prove that (2) implies (3).
We urge the reader to find their own proof of this fact.
Let $Z'$ and $Z''$ be closed subscheme structures on $Z$
such that $Z' \to S$ is proper. We have to show that $Z'' \to S$ is proper.
Let $Z''' = Z' \cup Z''$ be the scheme theoretic union, see
Morphisms, Definition
\ref{morphisms-definition-scheme-theoretic-intersection-union}.
Then $Z'''$ is another closed subscheme structure on $Z$.
This follows for example from the description of scheme theoretic unions in
Morphisms, Lemma \ref{morphisms-lemma-scheme-theoretic-union}.
Since $Z'' \to Z'''$ is a closed immersion it suffices to prove
that $Z''' \to S$ is proper (see
Morphisms, Lemmas \ref{morphisms-lemma-closed-immersion-proper} and
\ref{morphisms-lemma-composition-proper}).
The morphism $Z' \to Z'''$ is a bijective closed immersion
and in particular surjective and universally closed.
Then the fact that $Z' \to S$ is separated implies that
$Z''' \to S$ is separated, see
Morphisms, Lemma \ref{morphisms-lemma-image-universally-closed-separated}.
Moreover $Z''' \to S$ is locally of finite type
as $X \to S$ is locally of finite type
(Morphisms, Lemmas \ref{morphisms-lemma-immersion-locally-finite-type} and
\ref{morphisms-lemma-composition-finite-type}).
Since $Z' \to S$ is quasi-compact and $Z' \to Z'''$ is a homeomorphism
we see that $Z''' \to S$ is quasi-compact.
Finally, since $Z' \to S$ is universally closed, we see that
the same thing is true for $Z''' \to S$ by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-is-proper}.
This finishes the proof.
\end{proof}

\begin{definition}
\label{definition-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $Z \subset X$ be a closed subset.
We say {\it $Z$ is proper over $S$}
if the equivalent conditions of Lemma \ref{lemma-closed-proper-over-base}
are satisfied.
\end{definition}

\noindent
The lemma used in the definition above is false if the morphism
$f : X \to S$ is not locally of finite type. Therefore we urge
the reader not to use this terminology if $f$ is not locally of
finite type.

\begin{lemma}
\label{lemma-closed-closed-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $Y \subset Z \subset X$ be closed subsets.
If $Z$ is proper over $S$, then the same is true for $Y$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-closed-proper-over-base}
Consider a cartesian diagram of schemes
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
with $f$ locally of finite type.
If $Z$ is a closed subset of $X$ proper over $S$, then
$(g')^{-1}(Z)$ is a closed subset of $X'$ proper over $S'$.
\end{lemma}

\begin{proof}
Observe that the statement makes sense as $f'$ is locally of
finite type by Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-type}.
Endow $Z$ with the reduced induced closed subscheme structure.
Denote $Z' = (g')^{-1}(Z)$ the scheme theoretic inverse image
(Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}).
Then $Z' = X' \times_X Z = (S' \times_S X) \times_X Z = S' \times_S Z$
is proper over $S'$ as a base change of $Z$ over $S$
(Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}).
\end{proof}

\begin{lemma}
\label{lemma-functoriality-closed-proper-over-base}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes which
are locally of finite type over $S$.
\begin{enumerate}
\item If $Y$ is separated over $S$ and $Z \subset X$ is a closed subset
proper over $S$, then $f(Z)$ is a closed subset of $Y$ proper over $S$.
\item If $f$ is universally closed and $Z \subset X$ is a
closed subset proper over $S$, then $f(Z)$ is a closed subset
of $Y$ proper over $S$.
\item If $f$ is proper and $Z \subset Y$ is a closed subset
proper over $S$, then $f^{-1}(Z)$ is a closed subset of $X$ proper over $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Assume $Y$ is separated over $S$ and $Z \subset X$
is a closed subset proper over $S$. Endow $Z$ with the reduced induced
closed subscheme structure and apply
Morphisms, Lemma \ref{morphisms-lemma-scheme-theoretic-image-is-proper}
to $Z \to Y$ over $S$ to conclude.

\medskip\noindent
Proof of (2). Assume $f$ is universally closed and $Z \subset X$ is a
closed subset proper over $S$. Endow $Z$ and $Z' = f(Z)$ with their reduced
induced closed subscheme structures. We obtain an induced
morphism $Z \to Z'$.
Denote $Z'' = f^{-1}(Z')$ the scheme theoretic inverse image
(Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}).
Then $Z'' \to Z'$ is universally closed as a base change of $f$
(Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}).
Hence $Z \to Z'$ is universally closed as a composition of
the closed immersion $Z \to Z''$ and $Z'' \to Z'$
(Morphisms, Lemmas
\ref{morphisms-lemma-closed-immersion-proper} and
\ref{morphisms-lemma-composition-proper}).
We conclude that $Z' \to S$ is separated by
Morphisms, Lemma \ref{morphisms-lemma-image-universally-closed-separated}.
Since $Z \to S$ is quasi-compact and $Z \to Z'$ is surjective
we see that $Z' \to S$ is quasi-compact.
Since $Z' \to S$ is the composition of $Z' \to Y$ and $Y \to S$
we see that $Z' \to S$ is locally of finite type
(Morphisms, Lemmas \ref{morphisms-lemma-immersion-locally-finite-type} and
\ref{morphisms-lemma-composition-finite-type}).
Finally, since $Z \to S$ is universally closed, we see that
the same thing is true for $Z' \to S$ by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-is-proper}.
This finishes the proof.

\medskip\noindent
Proof of (3). Assume $f$ is proper and $Z \subset Y$ is a closed subset
proper over $S$. Endow $Z$ with the reduced induced closed subscheme
structure. Denote $Z' = f^{-1}(Z)$ the scheme theoretic inverse image
(Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}).
Then $Z' \to Z$ is proper as a base change of $f$
(Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}).
Whence $Z' \to S$ is proper as the composition of $Z' \to Z$
and $Z \to S$
(Morphisms, Lemma \ref{morphisms-lemma-composition-proper}).
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-union-closed-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $Z_i \subset X$, $i = 1, \ldots, n$ be closed subsets.
If $Z_i$, $i = 1, \ldots, n$ are proper over $S$, then the same is
true for $Z_1 \cup \ldots \cup Z_n$.
\end{lemma}

\begin{proof}
Endow $Z_i$ with their reduced induced closed subscheme structures.
The morphism
$$
Z_1 \amalg \ldots \amalg Z_n \longrightarrow X
$$
is finite by Morphisms, Lemmas
\ref{morphisms-lemma-closed-immersion-finite} and
\ref{morphisms-lemma-finite-union-finite}.
As finite morphisms are universally closed
(Morphisms, Lemma \ref{morphisms-lemma-finite-proper})
and since $Z_1 \amalg \ldots \amalg Z_n$ is proper over $S$
we conclude by
Lemma \ref{lemma-functoriality-closed-proper-over-base} part (2)
that the image $Z_1 \cup \ldots \cup Z_n$ is proper over $S$.
\end{proof}

\noindent
Let $f : X \to S$ be a morphism of schemes which is locally
of finite type. Let $\mathcal{F}$ be a finite type, quasi-coherent
$\mathcal{O}_X$-module. Then the support $\text{Supp}(\mathcal{F})$
of $\mathcal{F}$ is a closed subset of $X$, see
Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}.
Hence it makes sense to say
``the support of $\mathcal{F}$ is proper over $S$''.

\begin{lemma}
\label{lemma-module-support-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally
of finite type. Let $\mathcal{F}$ be a finite type, quasi-coherent
$\mathcal{O}_X$-module. The following are equivalent
\begin{enumerate}
\item the support of $\mathcal{F}$ is proper over $S$,
\item the scheme theoretic support of $\mathcal{F}$
(Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-support})
is proper over $S$, and
\item there exists a closed subscheme $Z \subset X$ and
a finite type, quasi-coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ such that (a) $Z \to S$ is proper, and (b)
$(Z \to X)_*\mathcal{G} = \mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
The support $\text{Supp}(\mathcal{F})$ of $\mathcal{F}$ is a closed subset
of $X$, see Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}.
Hence we can apply Definition \ref{definition-proper-over-base}.
Since the scheme theoretic support of $\mathcal{F}$ is a closed
subscheme whose underlying closed subset is $\text{Supp}(\mathcal{F})$
we see that (1) and (2) are equivalent by
Definition \ref{definition-proper-over-base}.
It is clear that (2) implies (3).
Conversely, if (3) is true, then
$\text{Supp}(\mathcal{F}) \subset Z$
(an inclusion of closed subsets of $X$)
and hence $\text{Supp}(\mathcal{F})$
is proper over $S$ for example by
Lemma \ref{lemma-closed-closed-proper-over-base}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-module-support-proper-over-base}
Consider a cartesian diagram of schemes
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
with $f$ locally of finite type. Let $\mathcal{F}$ be a
finite type, quasi-coherent $\mathcal{O}_X$-module.
If the support of $\mathcal{F}$ is proper over $S$, then
the support of $(g')^*\mathcal{F}$ is proper over $S'$.
\end{lemma}

\begin{proof}
Observe that the statement makes sense because
$(g')*\mathcal{F}$ is of finite type by
Modules, Lemma \ref{modules-lemma-pullback-finite-type}.
We have $\text{Supp}((g')^*\mathcal{F}) = (g')^{-1}(\text{Supp}(\mathcal{F}))$
by Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}.
Thus the lemma follows from
Lemma \ref{lemma-base-change-closed-proper-over-base}.
\end{proof}

\begin{lemma}
\label{lemma-cat-module-support-proper-over-base}
Let $f : X \to S$ be a morphism of schemes which is locally
of finite type. Let $\mathcal{F}$, $\mathcal{G}$
be finite type, quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item If the supports of $\mathcal{F}$, $\mathcal{G}$
are proper over $S$, then the same is true
for $\mathcal{F} \oplus \mathcal{G}$, for any extension
of $\mathcal{G}$ by $\mathcal{F}$, for $\Im(u)$ and $\Coker(u)$
given any $\mathcal{O}_X$-module map $u : \mathcal{F} \to \mathcal{G}$,
and for any quasi-coherent quotient of $\mathcal{F}$ or $\mathcal{G}$.
\item If $S$ is locally Noetherian, then the category of
coherent $\mathcal{O}_X$-modules with support proper over
$S$ is a Serre subcategory (Homology, Definition
\ref{homology-definition-serre-subcategory})
of the abelian category of
coherent $\mathcal{O}_X$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $Z$, $Z'$ be the support of $\mathcal{F}$
and $\mathcal{G}$. Then all the sheaves mentioned in (1)
have support contained in $Z \cup Z'$. Thus the assertion itself
is clear from Lemmas \ref{lemma-closed-closed-proper-over-base} and
\ref{lemma-union-closed-proper-over-base}
provided we check that these sheaves are finite type
and quasi-coherent. For quasi-coherence we refer the reader to
Schemes, Section \ref{schemes-section-quasi-coherent}.
For ``finite type'' we suggest the reader take a look at
Modules, Section \ref{modules-section-finite-type}.

\medskip\noindent
Proof of (2). The proof is the same as the proof of (1). Note that
the assertions make sense as $X$ is locally Noetherian by
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}
and by the description of the category of coherent
modules in Section \ref{section-coherent-sheaves}.
\end{proof}

\begin{lemma}
\label{lemma-support-proper-over-base-pushforward}
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module
with support proper over $S$. Then $R^pf_*\mathcal{F}$
is a coherent $\mathcal{O}_S$-module for all $p \geq 0$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-module-support-proper-over-base}
there exists a closed immersion $i : Z \to X$ and
a finite type, quasi-coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ such that (a) $g = f \circ i : Z \to S$ is proper, and (b)
$i_*\mathcal{G} = \mathcal{F}$.
We see that $R^pg_*\mathcal{G}$ is coherent on $S$ by
Proposition \ref{proposition-proper-pushforward-coherent}.
On the other hand, $R^qi_*\mathcal{G} = 0$ for $q > 0$
(Lemma \ref{lemma-finite-pushforward-coherent}).
By Cohomology, Lemma \ref{cohomology-lemma-relative-Leray}
we get $R^pf_*\mathcal{F} = R^pg_*\mathcal{G}$ which concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-systems-with-proper-support}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a finite type morphism.
Let $\mathcal{I} \subset \mathcal{O}_X$ be
a quasi-coherent sheaf of ideals. The following are Serre subcategories
of $\textit{Coh}(X, \mathcal{I})$
\begin{enumerate}
\item the full subcategory of $\textit{Coh}(X, \mathcal{I})$
consisting of those objects $(\mathcal{F}_n)$ such that
the support of $\mathcal{F}_1$ is proper over $S$,
\item the full subcategory of $\textit{Coh}(X, \mathcal{I})$
consisting of those objects $(\mathcal{F}_n)$ such that
there exists a closed subscheme $Z \subset X$ proper over $S$
with $\mathcal{I}_Z \mathcal{F}_n = 0$ for all $n \geq 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use the criterion of
Homology, Lemma \ref{homology-lemma-characterize-serre-subcategory}.
Moreover, we will use that if
$0 \to (\mathcal{G}_n) \to (\mathcal{F}_n) \to (\mathcal{H}_n) \to 0$
is a short exact sequence of $\textit{Coh}(X, \mathcal{I})$, then
(a) $\mathcal{G}_n \to \mathcal{F}_n \to \mathcal{H}_n \to 0$
is exact for all $n \geq 1$ and
(b) $\mathcal{G}_n$ is a quotient of $\Ker(\mathcal{F}_m \to \mathcal{H}_m)$
for some $m \geq n$. See proof of Lemma \ref{lemma-inverse-systems-abelian}.

\medskip\noindent
Proof of (1). Let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}(X, \mathcal{I})$. Then
$\text{Supp}(\mathcal{F}_n) = \text{Supp}(\mathcal{F}_1)$ for all $n \geq 1$.
Hence by remarks (a) and (b) above we see that
for any short exact sequence
$0 \to (\mathcal{G}_n) \to (\mathcal{F}_n) \to (\mathcal{H}_n) \to 0$
of $\textit{Coh}(X, \mathcal{I})$ we have
$\text{Supp}(\mathcal{G}_1) \cup \text{Supp}(\mathcal{H}_1) =
\text{Supp}(\mathcal{F}_1)$.
This proves that the category defined in (1)
is a Serre subcategory of $\textit{Coh}(X, \mathcal{I})$.

\medskip\noindent
Proof of (2). Here we argue the same way. Let
$0 \to (\mathcal{G}_n) \to (\mathcal{F}_n) \to (\mathcal{H}_n) \to 0$
be a short exact sequence of $\textit{Coh}(X, \mathcal{I})$.
If $Z \subset X$ is a closed subscheme and $\mathcal{I}_Z$
annihilates $\mathcal{F}_n$ for all $n$, then
$\mathcal{I}_Z$ annihilates $\mathcal{G}_n$ and $\mathcal{H}_n$
for all $n$ by (a) and (b) above.
Hence if $Z \to S$ is proper, then we conclude that the category
defined in (2) is closed under taking sub and quotient objects
inside of $\textit{Coh}(X, \mathcal{I})$.
Finally, suppose that $Z \subset X$ and $Y \subset X$ are
closed subschemes proper over $S$ such that
$\mathcal{I}_Z \mathcal{G}_n = 0$ and
$\mathcal{I}_Y \mathcal{H}_n = 0$ for all $n \geq 1$.
Then it follows from (a) above that
$\mathcal{I}_{Z \cup Y} = \mathcal{I}_Z \cdot \mathcal{I}_Y$
annihilates $\mathcal{F}_n$ for all $n$.
By Lemma \ref{lemma-union-closed-proper-over-base}
(and via Definition \ref{definition-proper-over-base} which
tells us we may choose an arbitrary scheme structure used on the union)
we see that $Z \cup Y \to S$ is proper and the proof is complete.
\end{proof}








\section{Grothendieck's existence theorem, III}
\label{section-existence-proper-support}

\noindent
To state the general version of Grothendieck's existence theorem
we introduce a bit more notation. Let $A$ be a Noetherian ring
complete with respect to an ideal $I$. Let $f : X \to \Spec(A)$
be a separated finite type morphism of schemes. Set
$\mathcal{I} = I\mathcal{O}_X$. In this situation we let
$$
\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_X)
$$
be the full subcategory of $\textit{Coh}(\mathcal{O}_X)$
consisting of those coherent $\mathcal{O}_X$-modules whose
support is proper over $\Spec(A)$. This is a Serre subcategory of
$\textit{Coh}(\mathcal{O}_X)$, see
Lemma \ref{lemma-cat-module-support-proper-over-base}.
Similarly, we let
$$
\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})
$$
be the full subcategory of $\textit{Coh}(X, \mathcal{I})$
consisting of those objects $(\mathcal{F}_n)$ such that
the support of $\mathcal{F}_1$ is proper over $\Spec(A)$.
This is a Serre subcategory of $\text{Coh}(X, \mathcal{I})$
by Lemma \ref{lemma-systems-with-proper-support} part (1).
Since the support of a quotient module is contained in the support
of the module, it follows that (\ref{equation-completion-functor})
induces a functor
\begin{equation}
\label{equation-completion-functor-proper-over-A}
\textit{Coh}_{\text{support proper over }A}(\mathcal{O}_X)
\longrightarrow
\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})
\end{equation}
We are now ready to state the main theorem of this section.

\begin{theorem}[Grothendieck's existence theorem]
\label{theorem-grothendieck-existence}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Let $X$ be a separated, finite type scheme over $A$. Then
the functor
(\ref{equation-completion-functor-proper-over-A})
$$
\textit{Coh}_{\text{support proper over }A}(\mathcal{O}_X)
\longrightarrow
\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})
$$
is an equivalence.
\end{theorem}

\begin{proof}
We will use the equivalence of categories of
Lemma \ref{lemma-i-star-equivalence}
without further mention.
For a closed subscheme $Z \subset X$ proper over $A$
in this proof we will say a coherent module on $X$ is
``supported on $Z$'' if it is annihilated by the ideal
sheaf of $Z$ or equivalently if it is the pushforward
of a coherent module on $Z$.
By Proposition \ref{proposition-existence-proper} we know
that the result is true for
the functor between coherent modules and systems of coherent
modules supported on $Z$. Hence it suffices to show that
every object of
$\textit{Coh}_{\text{support proper over }A}(\mathcal{O}_X)$
and every object of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$ is
supported on a closed subscheme $Z \subset X$ proper over $A$.
This holds by definition for objects of
$\textit{Coh}_{\text{support proper over }A}(\mathcal{O}_X)$.
We will prove this statement for objects of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$
using the method of proof of Proposition \ref{proposition-existence-proper}.
We urge the reader to read that proof first.

\medskip\noindent
Consider the collection $\Xi$ of quasi-coherent sheaves of ideals
$\mathcal{K} \subset \mathcal{O}_X$ such that the statement holds
for every object $(\mathcal{F}_n)$ of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$
annihilated by $\mathcal{K}$. We want to show $(0)$ is in $\Xi$.
If not, then since $X$ is Noetherian there exists a maximal
quasi-coherent sheaf of ideals $\mathcal{K}$ not in $\Xi$, see
Lemma \ref{lemma-acc-coherent}.
After replacing $X$ by the closed subscheme of $X$
corresponding to $\mathcal{K}$ we may assume that every nonzero
$\mathcal{K}$ is in $\Xi$. Let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$.
We will show that this object is supported on a closed subscheme
$Z \subset X$ proper over $A$, thereby completing the
proof of the theorem.

\medskip\noindent
Apply Chow's lemma (Lemma \ref{lemma-chow-Noetherian}) to find a
proper surjective morphism $f : Y \to X$ which is an isomorphism
over a dense open $U \subset X$ such that $Y$ is H-quasi-projective
over $A$. Choose an open immersion $j : Y \to Y'$ with
$Y'$ projective over $A$, see
Morphisms, Lemma \ref{morphisms-lemma-H-quasi-projective-open-H-projective}.
Observe that
$$
\text{Supp}(f^*\mathcal{F}_n) = f^{-1}\text{Supp}(\mathcal{F}_n) =
f^{-1}\text{Supp}(\mathcal{F}_1)
$$
The first equality by
Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}.
By assumption and
Lemma \ref{lemma-functoriality-closed-proper-over-base} part (3)
we see that $f^{-1}\text{Supp}(\mathcal{F}_1)$ is proper over $A$.
Hence the image of $f^{-1}\text{Supp}(\mathcal{F}_1)$
under $j$ is closed in $Y'$ by
Lemma \ref{lemma-functoriality-closed-proper-over-base} part (1).
Thus $\mathcal{F}'_n = j_*f^*\mathcal{F}_n$ is coherent on
$Y'$ by Lemma \ref{lemma-pushforward-coherent-on-open}.
It follows that $(\mathcal{F}_n')$
is an object of $\textit{Coh}(Y', I\mathcal{O}_{Y'})$.
By the projective case of Grothendieck's existence theorem
(Lemma \ref{lemma-existence-projective})
there exists a coherent $\mathcal{O}_{Y'}$-module
$\mathcal{F}'$ and an isomorphism
$(\mathcal{F}')^\wedge \cong (\mathcal{F}'_n)$ in
$\textit{Coh}(Y', I\mathcal{O}_{Y'})$.
Since $\mathcal{F}'/I\mathcal{F}' = \mathcal{F}'_1$ we see that
$$
\text{Supp}(\mathcal{F}') \cap V(I\mathcal{O}_{Y'}) =
\text{Supp}(\mathcal{F}'_1) = j(f^{-1}\text{Supp}(\mathcal{F}_1))
$$
The structure morphism $p' : Y' \to \Spec(A)$ is proper, hence
$p'(\text{Supp}(\mathcal{F}') \setminus j(Y))$
is closed in $\Spec(A)$. A nonempty closed subset of $\Spec(A)$
contains a point of $V(I)$ as $I \subset \text{rad}(A)$
by Algebra, Lemma \ref{algebra-lemma-radical-completion}.
The displayed equation shows that
$\text{Supp}(\mathcal{F}') \cap (p')^{-1}V(I) \subset j(Y)$
hence we conclude that $\text{Supp}(\mathcal{F}') \subset j(Y)$.
Thus $\mathcal{F}'|_Y = j^*\mathcal{F}'$
is supported on a closed subscheme $Z'$ of $Y$ proper over $A$
and $(\mathcal{F}'|_Y)^\wedge = (f^*\mathcal{F}_n)$.

\medskip\noindent
Let $\mathcal{K}$ be the quasi-coherent sheaf of ideals cutting
out the reduced complement $X \setminus U$. By
Proposition \ref{proposition-proper-pushforward-coherent}
the $\mathcal{O}_X$-module $\mathcal{H} = f_*(\mathcal{F}'|_Y)$ is coherent
and by Lemma \ref{lemma-inverse-systems-push-pull}
there exists a morphism $\alpha : (\mathcal{F}_n) \to \mathcal{H}^\wedge$
of $\textit{Coh}(X, \mathcal{I})$ whose kernel and cokernel are
annihilated by a power $\mathcal{K}^t$ of $\mathcal{K}$.
We obtain an exact sequence
$$
0 \to \Ker(\alpha) \to (\mathcal{F}_n) \to
\mathcal{H}^\wedge \to \Coker(\alpha) \to 0
$$
in $\textit{Coh}(X, \mathcal{I})$. If $Z_0 \subset X$ is the scheme theoretic
support of $\mathcal{H}$, then it is clear that $Z_0 \subset f(Z')$
set-theoretically. Hence $Z_0$ is proper over $A$ by
Lemma \ref{lemma-closed-closed-proper-over-base} and
Lemma \ref{lemma-functoriality-closed-proper-over-base} part (2).
Hence $\mathcal{H}^\wedge$ is in the subcategory defined in
Lemma \ref{lemma-systems-with-proper-support} part (2)
and a fortiori in
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$.
We conclude that $\Ker(\alpha)$ and $\Coker(\alpha)$
are in $\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$
by Lemma \ref{lemma-systems-with-proper-support} part (1).
By induction hypothesis, more precisely because $\mathcal{K}^t$ is in $\Xi$,
we see that $\Ker(\alpha)$ and $\Coker(\alpha)$ are in
the subcategory defined in
Lemma \ref{lemma-systems-with-proper-support} part (2).
Since this is a Serre subcategory by the lemma, we conclude that the
same is true for $(\mathcal{F}_n)$ which is what we wanted to show.
\end{proof}

\begin{remark}[Unwinding Grothendieck's existence theorem]
\label{remark-reformulate-existence-theorem}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a separated morphism of finite type.
For $n \geq 1$ we set $X_n = X \times_S S_n$.
Picture:
$$
\xymatrix{
X_1 \ar[r]_{i_1} \ar[d] & X_2 \ar[r]_{i_2} \ar[d] & X_3 \ar[r] \ar[d] &
\ldots & X \ar[d] \\
S_1 \ar[r] & S_2 \ar[r] & S_3 \ar[r] & \ldots & S
}
$$
In this situation we consider systems $(\mathcal{F}_n, \varphi_n)$
where
\begin{enumerate}
\item $\mathcal{F}_n$ is a coherent $\mathcal{O}_{X_n}$-module,
\item $\varphi_n : i_n^*\mathcal{F}_{n + 1} \to \mathcal{F}_n$
is an isomorphism, and
\item $\text{Supp}(\mathcal{F}_1)$ is proper over $S_1$.
\end{enumerate}
Theorem \ref{theorem-grothendieck-existence} says that the
completion functor
$$
\begin{matrix}
\text{coherent }\mathcal{O}_X\text{-modules }\mathcal{F} \\
\text{with support proper over }A
\end{matrix}
\quad
\longrightarrow
\quad
\begin{matrix}
\text{systems }(\mathcal{F}_n) \\
\text{as above}
\end{matrix}
$$
is an equivalence of categories. In the special case that $X$ is
proper over $A$ we can omit the conditions on the supports.
\end{remark}



\section{Grothendieck's algebraization theorem}
\label{section-algebraization}

\noindent
Our first result is a translation of Grothendieck's existence
theorem in terms of closed subschemes and finite morphisms.

\begin{lemma}
\label{lemma-algebraize-formal-closed-subscheme}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a separated morphism of finite type.
For $n \geq 1$ we set $X_n = X \times_S S_n$.
Suppose given a commutative diagram
$$
\xymatrix{
Z_1 \ar[r] \ar[d] & Z_2 \ar[r] \ar[d] & Z_3 \ar[r] \ar[d] & \ldots \\
X_1 \ar[r]^{i_1} & X_2 \ar[r]^{i_2} & X_3 \ar[r] & \ldots
}
$$
of schemes with cartesian squares. Assume that
\begin{enumerate}
\item $Z_1 \to X_1$ is a closed immersion, and
\item $Z_1 \to S_1$ is proper.
\end{enumerate}
Then there exists a closed immersion of schemes $Z \to X$ such that
$Z_n = Z \times_S S_n$. Moreover, $Z$ is proper over $S$.
\end{lemma}

\begin{proof}
Let's write $j_n : Z_n \to X_n$ for the vertical morphisms.
As the squares in the statement are cartesian
we see that the base change of $j_n$ to $X_1$ is $j_1$.
Thus Morphisms, Lemma \ref{morphisms-lemma-check-closed-infinitesimally}
shows that $j_n$ is a closed immersion.
Set $\mathcal{F}_n = j_{n, *}\mathcal{O}_{Z_n}$, so that
$j_n^\sharp$ is a surjection $\mathcal{O}_{X_n} \to \mathcal{F}_n$.
Again using that the squares are cartesian we see that
the pullback of $\mathcal{F}_{n + 1}$ to $X_n$ is $\mathcal{F}_n$.
Hence Grothendieck's existence theorem, as reformulated in
Remark \ref{remark-reformulate-existence-theorem},
tells us there exists a map
$\mathcal{O}_X \to \mathcal{F}$
of coherent $\mathcal{O}_X$-modules whose restriction to
$X_n$ recovers $\mathcal{O}_{X_n} \to \mathcal{F}_n$.
Moreover, the support of $\mathcal{F}$ is proper over $S$.
As the completion functor is exact (Lemma \ref{lemma-exact})
we see that the cokernel $\mathcal{Q}$ of $\mathcal{O}_X \to \mathcal{F}$
has vanishing completion. Since $\mathcal{F}$ has support
proper over $S$ and so does $\mathcal{Q}$ this implies that
$\mathcal{Q} = 0$ for example because the functor
(\ref{equation-completion-functor-proper-over-A}) is an equivalence
by Grothendieck's existence theorem.
Thus $\mathcal{F} = \mathcal{O}_X/\mathcal{J}$
for some quasi-coherent sheaf of ideals $\mathcal{J}$.
Setting $Z = V(\mathcal{J})$ finishes the proof.
\end{proof}

\noindent
In the following lemma it is actually enough to assume that $Y_1 \to X_1$
is finite as it will imply that $Y_n \to X_n$ is finite too
(see More on Morphisms, Lemma
\ref{more-morphisms-lemma-thicken-property-morphisms-cartesian}).

\begin{lemma}
\label{lemma-algebraize-formal-scheme-finite-over-proper}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a separated morphism of finite type.
For $n \geq 1$ we set $X_n = X \times_S S_n$.
Suppose given a commutative diagram
$$
\xymatrix{
Y_1 \ar[r] \ar[d] & Y_2 \ar[r] \ar[d] & Y_3 \ar[r] \ar[d] & \ldots \\
X_1 \ar[r]^{i_1} & X_2 \ar[r]^{i_2} & X_3 \ar[r] & \ldots
}
$$
of schemes with cartesian squares. Assume that
\begin{enumerate}
\item $Y_n \to X_n$ is a finite morphism, and
\item $Y_1 \to S_1$ is proper.
\end{enumerate}
Then there exists a finite morphism of schemes $Y \to X$ such that
$Y_n = Y \times_S S_n$. Moreover, $Y$ is proper over $S$.
\end{lemma}

\begin{proof}
Let's write $f_n : Y_n \to X_n$ for the vertical morphisms.
Set $\mathcal{F}_n = f_{n, *}\mathcal{O}_{Y_n}$. This is
a coherent $\mathcal{O}_{X_n}$-module as $f_n$ is finite
(Lemma \ref{lemma-finite-pushforward-coherent}).
Using that the squares are cartesian we see that
the pullback of $\mathcal{F}_{n + 1}$ to $X_n$ is $\mathcal{F}_n$.
Hence Grothendieck's existence theorem, as reformulated in
Remark \ref{remark-reformulate-existence-theorem},
tells us there exists a coherent $\mathcal{O}_X$-module
$\mathcal{F}$ whose restriction to $X_n$ recovers $\mathcal{F}_n$.
Moreover, the support of $\mathcal{F}$ is proper over $S$.
As the completion functor is fully faithful
(Theorem \ref{theorem-grothendieck-existence})
we see that the multiplication maps
$\mathcal{F}_n \otimes_{\mathcal{O}_{X_n}} \mathcal{F}_n \to
\mathcal{F}_n$ fit together to give an algebra structure on $\mathcal{F}$.
Setting $Y = \underline{\Spec}_X(\mathcal{F})$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-morphism}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$. Let $X$, $Y$ be schemes
over $S$. For $n \geq 1$ we set $X_n = X \times_S S_n$ and
$Y_n = Y \times_S S_n$. Suppose given a compatible system of
commutative diagrams
$$
\xymatrix{
& & X_{n + 1} \ar[rd] \ar[rr]_{g_{n + 1}} & & Y_{n + 1} \ar[ld] \\
X_n \ar[rru] \ar[rd] \ar[rr]_{g_n} & & Y_n \ar[rru] \ar[ld] & S_{n + 1} \\
& S_n \ar[rru]
}
$$
Assume that
\begin{enumerate}
\item $X \to S$ is proper, and
\item $Y \to S$ is separated of finite type.
\end{enumerate}
Then there exists a unique morphism of schemes $g : X \to Y$
over $S$ such that $g_n$ is the base change of $g$ to $S_n$.
\end{lemma}

\begin{proof}
The morphisms $(1, g_n) : X_n \to X_n \times_S Y_n$ are closed immersions
because $Y_n \to S_n$ is separated
(Schemes, Lemma \ref{schemes-lemma-section-immersion}). Thus by
Lemma \ref{lemma-algebraize-formal-closed-subscheme}
there exists a closed subscheme $Z \subset X \times_S Y$
proper over $S$ whose base change to $S_n$ recovers
$X_n \subset X_n \times_S Y_n$. The first projection $p : Z \to X$
is a proper morphism (as $Z$ is proper over $S$, see
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed})
whose base change to $S_n$ is an isomorphism
for all $n$. In particular, $p : Z \to X$ is finite over an open
neighbourhood of $X_0$ by
Lemma \ref{lemma-proper-finite-fibre-finite-in-neighbourhood}.
As $X$ is proper over $S$ this open neighbourhood is all of $X$
and we conclude $p : Z \to X$ is finite.
Applying the equivalence of Proposition \ref{proposition-existence-proper}
we see that $p_*\mathcal{O}_Z = \mathcal{O}_X$ as this is true
modulo $I^n$ for all $n$. Hence $p$ is an isomorphism and we obtain
the morphism $g$ as the composition $X \cong Z \to Y$.
We omit the proof of uniqueness.
\end{proof}

\noindent
In order to prove an ``abstract'' algebraization theorem we need
to assume we have an ample invertible sheaf, as the result is false
without such an assumption.

\begin{theorem}[Grothendieck's algebraization theorem]
\label{theorem-algebraization}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Set $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$. Consider a commutative
diagram
$$
\xymatrix{
X_1 \ar[r]_{i_1} \ar[d] & X_2 \ar[r]_{i_2} \ar[d] & X_3 \ar[r] \ar[d] &
\ldots \\
S_1 \ar[r] & S_2 \ar[r] & S_3 \ar[r] & \ldots
}
$$
of schemes with cartesian squares. Suppose given $(\mathcal{L}_n, \varphi_n)$
where each $\mathcal{L}_n$ is an invertible sheaf on $X_n$ and
$\varphi_n : i_n^*\mathcal{L}_{n + 1} \to \mathcal{L}_n$
is an isomorphism. If
\begin{enumerate}
\item $X_1 \to S_1$ is proper, and
\item $\mathcal{L}_1$ is ample on $X_1$
\end{enumerate}
then there exists a proper morphism of schemes $X \to S$
and an ample invertible $\mathcal{O}_X$-module $\mathcal{L}$
and isomorphisms $X_n \cong X \times_S S_n$ and
$\mathcal{L}_n \cong \mathcal{L}|_{X_n}$ compatible with
the morphisms $i_n$ and $\varphi_n$.
\end{theorem}

\begin{proof}
Since the squares in the diagram are cartesian and since the morphisms
$S_n \to S_{n + 1}$ are closed immersions, we see that the morphisms
$i_n$ are closed immersions too. In particular we may think of
$X_m$ as a closed subscheme of $X_n$ for $m < n$. In fact $X_m$ is
the closed subscheme cut out by the quasi-coherent sheaf of ideals
$I^m\mathcal{O}_{X_n}$. Moreover, the underlying topological spaces
of the schemes $X_1, X_2, X_3, \ldots$ are all identified, hence we
may (and do) think of sheaves $\mathcal{O}_{X_n}$ as living on the
same underlying topological space; similarly for coherent
$\mathcal{O}_{X_n}$-modules. Set
$$
\mathcal{F}_n =
\Ker(\mathcal{O}_{X_{n + 1}} \to \mathcal{O}_{X_n})
$$
so that we obtain short exact sequences
$$
0 \to \mathcal{F}_n \to \mathcal{O}_{X_{n + 1}} \to \mathcal{O}_{X_n} \to 0
$$
By the above we have $\mathcal{F}_n = I^n\mathcal{O}_{X_{n + 1}}$.
It follows $\mathcal{F}_n$ is a coherent sheaf on $X_{n + 1}$
annihilated by $I$, hence we may (and do) think of it as a coherent
module $\mathcal{O}_{X_1}$-module. Observe that for $m > n$ the sheaf
$$
I^n\mathcal{O}_{X_m}/I^{n + 1}\mathcal{O}_{X_m}
$$
maps isomorphically to $\mathcal{F}_n$ under the map
$\mathcal{O}_{X_m} \to \mathcal{O}_{X_{n + 1}}$. Hence given
$n_1, n_2 \geq 0$ we can pick an $m > n_1 + n_2$ and consider the
multiplication map
$$
I^{n_1}\mathcal{O}_{X_m} \times I^{n_2}\mathcal{O}_{X_m}
\longrightarrow
I^{n_1 + n_2}\mathcal{O}_{X_m} \to \mathcal{F}_{n_1 + n_2}
$$
This induces an $\mathcal{O}_{X_1}$-bilinear map
$$
\mathcal{F}_{n_1} \times \mathcal{F}_{n_2} \longrightarrow
\mathcal{F}_{n_1 + n_2}
$$
which in turn defines the structure of a graded $\mathcal{O}_{X_1}$-algebra
on $\mathcal{F} = \bigoplus_{n \geq 0} \mathcal{F}_n$.

\medskip\noindent
Set $B = \bigoplus I^n/I^{n + 1}$; this is a finitely generated
graded $A/I$-algebra. Set $\mathcal{B} = (X_1 \to S_1)^*\widetilde{B}$.
The discussion above provides us with a canonical surjection
$$
\mathcal{B} \longrightarrow \mathcal{F}
$$
of graded $\mathcal{O}_{X_1}$-algebras. In particular we see that
$\mathcal{F}$ is a finite type quasi-coherent graded $\mathcal{B}$-module.
By Lemma \ref{lemma-graded-finiteness} we can find an integer $d_0$
such that $H^1(X_1, \mathcal{F} \otimes \mathcal{L}^{\otimes d}) = 0$
for all $d \geq d_0$. Pick a $d \geq d_0$ such that there exist sections
$s_{0, 1}, \ldots, s_{N, 1} \in \Gamma(X_1, \mathcal{L}_1^{\otimes d})$
which induce an immersion
$$
\psi_1 : X_1 \to \mathbf{P}^N_{S_1}
$$
over $S_1$, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-over-affine-ample-very-ample}.
As $X_1$ is proper over $S_1$ we see that $\psi_1$
is a closed immersion, see
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}
and
Schemes, Lemma \ref{schemes-lemma-immersion-when-closed}.
We are going to ``lift'' $\psi_1$ to a compatible system of
closed immersions of $X_n$ into $\mathbf{P}^N$.

\medskip\noindent
Upon tensoring the short exact sequences of the first paragraph
of the proof
by $\mathcal{L}_{n + 1}^{\otimes d}$ we obtain short exact sequences
$$
0 \to \mathcal{F}_n \otimes \mathcal{L}_{n + 1}^{\otimes d} \to
\mathcal{L}_{n + 1}^{\otimes d} \to \mathcal{L}_{n + 1}^{\otimes d} \to 0
$$
Using the isomorphisms $\varphi_n$ we obtain isomorphisms
$\mathcal{L}_{n + 1} \otimes \mathcal{O}_{X_l} = \mathcal{L}_l$
for $l \leq n$. Whence the sequence above becomes
$$
0 \to \mathcal{F}_n \otimes \mathcal{L}_1^{\otimes d} \to
\mathcal{L}_{n + 1}^{\otimes d} \to \mathcal{L}_n^{\otimes d} \to 0
$$
The vanishing of $H^1(X, \mathcal{F}_n \otimes \mathcal{L}_1^{\otimes d})$
implies we can inductively lift
$s_{0, 1}, \ldots, s_{N, 1} \in \Gamma(X_1, \mathcal{L}_1^{\otimes d})$
to sections
$s_{0, n}, \ldots, s_{N, n} \in \Gamma(X_n, \mathcal{L}_n^{\otimes d})$.
Thus we obtain a commutative diagram
$$
\xymatrix{
X_1 \ar[r]_{i_1} \ar[d]_{\psi_1} &
X_2 \ar[r]_{i_2} \ar[d]_{\psi_2} &
X_3 \ar[r] \ar[d]_{\psi_3} &
\ldots \\
\mathbf{P}^N_{S_1} \ar[r] &
\mathbf{P}^N_{S_2} \ar[r] &
\mathbf{P}^N_{S_3} \ar[r] & \ldots
}
$$
where
$\psi_n = \varphi_{(\mathcal{L}_n, (s_{0, n}, \ldots, s_{N, n}))}$
in the notation of Constructions, Section
\ref{constructions-section-projective-space}.
As the squares in the statement of the theorem are cartesian
we see that the squares in the above diagram are cartesian.
We win by applying Lemma \ref{lemma-algebraize-formal-closed-subscheme}.
\end{proof}

















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
\input{preamble}

% OK, start here.
%
\begin{document}

\title{Cohomology of Sheaves}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this document we work out some topics on cohomology of sheaves
on topological spaces. We mostly work in the generality of modules
over a sheaf of rings and we work with morphisms of ringed spaces.
To see what happens for sheaves on sites take a look at the chapter
Cohomology on Sites, Section \ref{sites-cohomology-section-introduction}.
Basic references are \cite{Godement} and \cite{Iversen}.


\section{Topics}
\label{section-topics}

\noindent
Here are some topics that should be discussed in this chapter,
and have not yet been written.
\begin{enumerate}
\item Ext-groups.
\item Ext sheaves.
\item Tor functors.
\item Derived pullback for morphisms between ringed spaces.
\item Cup-product.
\item Etc, etc, etc.
\end{enumerate}



\section{Cohomology of sheaves}
\label{section-cohomology-sheaves}

\noindent
Let $X$ be a topological space. Let $\mathcal{F}$ be a abelian sheaf.
We know that the category of abelian sheaves on $X$ has enough injectives, see
Injectives, Lemma \ref{injectives-lemma-abelian-sheaves-space}.
Hence we can choose an injective resolution
$\mathcal{F}[0] \to \mathcal{I}^\bullet$. As is customary we define
\begin{equation}
\label{equation-cohomology}
H^i(X, \mathcal{F}) = H^i(\Gamma(X, \mathcal{I}^\bullet))
\end{equation}
to be the {\it $i$th cohomology group of the abelian sheaf $\mathcal{F}$}.
The family of functors $H^i((X, -)$ forms a universal $\delta$-functor
from $\textit{Ab}(X) \to \textit{Ab}$.

\medskip\noindent
Let $f : X \to Y$ be a continuous map of topological spaces. With
$\mathcal{F}[0] \to \mathcal{I}^\bullet$ as above
we define
\begin{equation}
\label{equation-higher-direct-image}
R^if_*\mathcal{F} = H^i(f_*\mathcal{I}^\bullet)
\end{equation}
to be the {\it $i$th higher direct image of $\mathcal{F}$}.
The family of functors $R^if_*$ forms a universal $\delta$-functor
from $\textit{Ab}(X) \to \textit{Ab}(Y)$.

\medskip\noindent
Let $(X, \mathcal{O}_X)$ be a ringed space. Let $\mathcal{F}$ be an
$\mathcal{O}_X$-module. We know that the category of $\mathcal{O}_X$-modules
on $X$ has enough injectives, see
Injectives, Lemma \ref{injectives-lemma-sheaves-modules-space}.
Hence we can choose an injective resolution
$\mathcal{F}[0] \to \mathcal{I}^\bullet$. As is customary we define
\begin{equation}
\label{equation-cohomology-modules}
H^i(X, \mathcal{F}) = H^i(\Gamma(X, \mathcal{I}^\bullet))
\end{equation}
to be the {\it $i$th cohomology group of $\mathcal{F}$}.
The family of functors $H^i((X, -)$ forms a universal $\delta$-functor
from $\textit{Mod}(\mathcal{O}_X) \to \text{Mod}_{\mathcal{O}_X(X)}$.

\medskip\noindent
Let $f : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism of ringed
spaces. With $\mathcal{F}[0] \to \mathcal{I}^\bullet$ as above
we define
\begin{equation}
\label{equation-higher-direct-image-modules}
R^if_*\mathcal{F} = H^i(f_*\mathcal{I}^\bullet)
\end{equation}
to be the {\it $i$th higher direct image of $\mathcal{F}$}.
The family of functors $R^if_*$ forms a universal $\delta$-functor
from $\textit{Mod}(\mathcal{O}_X) \to \textit{Mod}(\mathcal{O}_Y)$.





\section{Derived functors}
\label{section-derived-functors}

\noindent
We briefly explain an approach to right derived functors using resolution
functors. Let $(X, \mathcal{O}_X)$ be a ringed space. The category
$\textit{Mod}(\mathcal{O}_X)$ is abelian, see
Modules, Lemma \ref{modules-lemma-abelian}.
In this chapter we will write
$$
K(X) = K(\mathcal{O}_X) = K(\textit{Mod}(\mathcal{O}_X))
\quad
\text{and}
\quad
D(X) = D(\mathcal{O}_X) = D(\textit{Mod}(\mathcal{O}_X)).
$$
and similarly for the bounded versions for the triangulated categories
introduced in
Derived Categories, Definition \ref{derived-definition-complexes-notation} and
Definition \ref{derived-definition-unbounded-derived-category}.
By
Derived Categories, Remark \ref{derived-remark-big-abelian-category}
there exists a resolution functor
$$
j = j_X :
K^{+}(\textit{Mod}(\mathcal{O}_X))
\longrightarrow
K^{+}(\mathcal{I})
$$
where $\mathcal{I}$ is the strictly full additive subcategory of
$\textit{Mod}(\mathcal{O}_X)$ consisting of injective sheaves.
For any left exact functor
$F : \textit{Mod}(\mathcal{O}_X) \to \mathcal{B}$
into any abelian category $\mathcal{B}$ we will denote $RF$ the
right derived functor described in
Derived Categories, Section \ref{derived-section-right-derived-functor}
and constructed using the resolution functor $j_X$ just described:
\begin{equation}
\label{equation-RF}
RF = F \circ j_X' : D^{+}(X) \longrightarrow D^{+}(\mathcal{B})
\end{equation}
see
Derived Categories, Lemma \ref{derived-lemma-right-derived-functor}
for notation. Note that we may think of $RF$ as defined on
$\textit{Mod}(\mathcal{O}_X)$,
$\text{Comp}^{+}(\textit{Mod}(\mathcal{O}_X))$,
$K^{+}(X)$, or $D^{+}(X)$
depending on the situation. According to
Derived Categories, Definition \ref{derived-definition-higher-derived-functors}
we obtain the $i$th right derived functor
\begin{equation}
\label{equation-RFi}
R^iF = H^i \circ RF : \textit{Mod}(\mathcal{O}_X) \longrightarrow \mathcal{B}
\end{equation}
so that $R^0F = F$ and $\{R^iF, \delta\}_{i \geq 0}$ is universal
$\delta$-functor, see
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}.

\medskip\noindent
Here are two special cases of this construction.
Given a ring $R$ we write $K(R) = K(\text{Mod}_R)$ and
$D(R) = D(\text{Mod}_R)$ and similarly for bounded versions.
For any open $U \subset X$ we have a left exact functor
$
\Gamma(U, -) :
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\text{Mod}_{\mathcal{O}_X(U)}
$
which gives rise to
\begin{equation}
\label{equation-total-derived-cohomology}
R\Gamma(U, -) :
D^{+}(X)
\longrightarrow
D^{+}(\mathcal{O}_X(U))
\end{equation}
by the discussion above. We set $H^i(U, -) = R^i\Gamma(U, -)$.
If $U = X$ we recover (\ref{equation-cohomology-modules}).
If $f : X \to Y$ is a morphism of ringed spaces, then we have
the left exact functor
$
f_* :
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\textit{Mod}(\mathcal{O}_Y)
$
which gives rise to the {\it derived pushforward}
\begin{equation}
\label{equation-total-derived-direct-image}
Rf_* :
D^{+}(X)
\longrightarrow
D^{+}(Y)
\end{equation}
The $i$th cohomology sheaf of $Rf_*\mathcal{F}^\bullet$ is denoted
$R^if_*\mathcal{F}^\bullet$ and called the $i$th {\it higher direct image}
in accordance with (\ref{equation-higher-direct-image-modules}).
The two displayed functors above are exact functors
of derived categories.

\medskip\noindent
{\bf Abuse of notation:} When the functor $Rf_*$, or any other
derived functor, is applied to a sheaf $\mathcal{F}$ on $X$ or a complex
of sheaves it is understood that $\mathcal{F}$ has been replaced by a
suitable resolution of $\mathcal{F}$. To facilitate this kind of
operation we will say, given an object $\mathcal{F}^\bullet \in D(X)$,
that a bounded below complex $\mathcal{I}^\bullet$ of injectives of
$\textit{Mod}(\mathcal{O}_X)$
{\it represents $\mathcal{F}^\bullet$ in the derived category}
if there exists a quasi-isomorphism
$\mathcal{F}^\bullet \to \mathcal{I}^\bullet$. In the same vein the phrase
``let $\alpha : \mathcal{F}^\bullet \to \mathcal{G}^\bullet$ be
a morphism of $D(X)$'' does not mean that $\alpha$ is represented by a
morphism of complexes. If we have an actual morphism of complexes we will
say so.









\section{First cohomology and torsors}
\label{section-h1-torsors}

\begin{definition}
\label{definition-torsor}
Let $X$ be a topological space.
Let $\mathcal{G}$ be a sheaf of (possibly non-commutative) groups on $X$.
A {\it torsor}, or more precisely a {\it $\mathcal{G}$-torsor}, is a sheaf
of sets $\mathcal{F}$ on $X$ endowed with an action
$\mathcal{G} \times \mathcal{F} \to \mathcal{F}$ such that
\begin{enumerate}
\item whenever $\mathcal{F}(U)$ is nonempty the action
$\mathcal{G}(U) \times \mathcal{F}(U) \to \mathcal{F}(U)$
is simply transitive, and
\item for every $x \in X$ the stalk $\mathcal{F}_x$ is nonempty.
\end{enumerate}
A {\it morphism of $\mathcal{G}$-torsors} $\mathcal{F} \to \mathcal{F}'$
is simply a morphism of sheaves of sets compatible with the
$\mathcal{G}$-actions. The {\it trivial $\mathcal{G}$-torsor}
is the sheaf $\mathcal{G}$ endowed with the obvious left
$\mathcal{G}$-action.
\end{definition}

\noindent
It is clear that a morphism of torsors is automatically an isomorphism.

\begin{lemma}
\label{lemma-trivial-torsor}
Let $X$ be a topological space.
Let $\mathcal{G}$ be a sheaf of (possibly non-commutative) groups on $X$.
A $\mathcal{G}$-torsor $\mathcal{F}$ is trivial if and only if
$\mathcal{F}(X) \not = \emptyset$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-torsors-h1}
Let $X$ be a topological space.
Let $\mathcal{H}$ be an abelian sheaf on $X$.
There is a canonical bijection between the set of isomorphism
classes of $\mathcal{H}$-torsors and $H^1(X, \mathcal{H})$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be a $\mathcal{H}$-torsor.
Consider the free abelian sheaf $\mathbf{Z}[\mathcal{F}]$
on $\mathcal{F}$. It is the sheafification of the rule
which associates to $U \subset X$ open the collection of finite
formal sums $\sum n_i[s_i]$ with $n_i \in \mathbf{Z}$
and $s_i \in \mathcal{F}(U)$. There is a natural map
$$
\sigma : \mathbf{Z}[\mathcal{F}] \longrightarrow \underline{\mathbf{Z}}
$$
which to a local section $\sum n_i[s_i]$ associates $\sum n_i$.
The kernel of $\sigma$ is generated by the local section of the form
$[s] - [s']$. There is a canonical map
$a : \Ker(\sigma) \to \mathcal{H}$
which maps $[s] - [s'] \mapsto h$ where $h$ is the local section of
$\mathcal{H}$ such that $h \cdot s = s'$. Consider the pushout diagram
$$
\xymatrix{
0 \ar[r] &
\Ker(\sigma) \ar[r] \ar[d]^a &
\mathbf{Z}[\mathcal{F}] \ar[r] \ar[d] &
\underline{\mathbf{Z}} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{H} \ar[r] &
\mathcal{E} \ar[r] &
\underline{\mathbf{Z}} \ar[r] &
0
}
$$
Here $\mathcal{E}$ is the extension obtained by pushout.
From the long exact cohomology sequence associated to the lower
short exact sequence we obtain an element
$\xi = \xi_\mathcal{F} \in H^1(X, \mathcal{H})$
by applying the boundary operator to $1 \in H^0(X, \underline{\mathbf{Z}})$.

\medskip\noindent
Conversely, given $\xi \in H^1(X, \mathcal{H})$ we can associate to
$\xi$ a torsor as follows. Choose an embedding $\mathcal{H} \to \mathcal{I}$
of $\mathcal{H}$ into an injective abelian sheaf $\mathcal{I}$. We set
$\mathcal{Q} = \mathcal{I}/\mathcal{H}$ so that we have a short exact
sequence
$$
\xymatrix{
0 \ar[r] &
\mathcal{H} \ar[r] &
\mathcal{I} \ar[r] &
\mathcal{Q} \ar[r] &
0
}
$$
The element $\xi$ is the image of a global section $q \in H^0(X, \mathcal{Q})$
because $H^1(X, \mathcal{I}) = 0$ (see
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}).
Let $\mathcal{F} \subset \mathcal{I}$ be the subsheaf (of sets) of sections
that map to $q$ in the sheaf $\mathcal{Q}$. It is easy to verify that
$\mathcal{F}$ is a torsor.

\medskip\noindent
We omit the verification that the two constructions given
above are mutually inverse.
\end{proof}







\section{First cohomology and extensions}
\label{section-h1-extensions}

\begin{lemma}
\label{lemma-h1-extensions}
Let $(X, \mathcal{O}_X)$ be a ringed space. Let $\mathcal{F}$ be a sheaf of
$\mathcal{O}_X$-modules. There is a canonical bijection
$$
\text{Ext}^1_{\textit{Mod}(\mathcal{O}_X)}(\mathcal{O}_X, \mathcal{F})
\longrightarrow
H^1(X, \mathcal{F})
$$
which associates to the extension
$$
0 \to \mathcal{F} \to \mathcal{E} \to \mathcal{O}_X \to 0
$$
the image of $1 \in \Gamma(X, \mathcal{O}_X)$ in $H^1(X, \mathcal{F})$.
\end{lemma}

\begin{proof}
Let us construct the inverse of the map given in the lemma. Let
$\xi \in H^1(X, \mathcal{F})$. Choose an injection
$\mathcal{F} \subset \mathcal{I}$ with $\mathcal{I}$ injective in
$\textit{Mod}(\mathcal{O}_X)$.
Set $\mathcal{Q} = \mathcal{I}/\mathcal{F}$.
By the long exact sequence of cohomology, we see that
$\xi$ is the image of of a section
$\tilde \xi \in \Gamma(X, \mathcal{Q}) =
\Hom_{\mathcal{O}_X}(\mathcal{O}_X, \mathcal{Q})$.
Now, we just form the pullback
$$
\xymatrix{
0 \ar[r] &
\mathcal{F} \ar[r] \ar@{=}[d] &
\mathcal{E} \ar[r] \ar[d] &
\mathcal{O}_X \ar[r] \ar[d]^{\tilde \xi} &
0 \\
0 \ar[r] &
\mathcal{F} \ar[r] &
\mathcal{I} \ar[r] &
\mathcal{Q} \ar[r] &
0
}
$$
see Homology, Section \ref{homology-section-extensions}.
\end{proof}








\section{First cohomology and invertible sheaves}
\label{section-invertible-sheaves}

\noindent
The Picard group of a ringed space is defined in
Modules, Section \ref{modules-section-invertible}.

\begin{lemma}
\label{lemma-h1-invertible}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
There is a canonical isomorphism
$$
H^1(X, \mathcal{O}_X^*) = \text{Pic}(X).
$$
of abelian groups.
\end{lemma}

\begin{proof}
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Consider the presheaf $\mathcal{L}^*$ defined by the rule
$$
U \longmapsto \{s \in \mathcal{L}(U)
\text{ such that } \mathcal{O}_U \xrightarrow{s \cdot -} \mathcal{L}_U
\text{ is an isomorphism}\}
$$
This presheaf satisfies the sheaf condition. Moreover, if
$f \in \mathcal{O}_X^*(U)$ and $s \in \mathcal{L}^*(U)$, then clearly
$fs \in \mathcal{L}^*(U)$. By the same token, if $s, s' \in \mathcal{L}^*(U)$
then there exists a unique $f \in \mathcal{O}_X^*(U)$ such that
$fs = s'$. Moreover, the sheaf $\mathcal{L}^*$ has sections locally
by Modules, Lemma \ref{modules-lemma-invertible-is-locally-free-rank-1}.
In other words we
see that $\mathcal{L}^*$ is a $\mathcal{O}_X^*$-torsor. Thus we get
a map
$$
\begin{matrix}
\text{invertible sheaves on }(X, \mathcal{O}_X) \\
\text{ up to isomorphism}
\end{matrix}
\longrightarrow
\begin{matrix}
\mathcal{O}_X^*\text{-torsors} \\
\text{ up to isomorphism}
\end{matrix}
$$
We omit the verification that this is a homomorphism of abelian groups.
By
Lemma \ref{lemma-torsors-h1}
the right hand side is canonically
bijective to $H^1(X, \mathcal{O}_X^*)$.
Thus we have to show this map is injective and surjective.

\medskip\noindent
Injective. If the torsor $\mathcal{L}^*$ is trivial, this means by
Lemma \ref{lemma-trivial-torsor}
that $\mathcal{L}^*$ has a global section.
Hence this means exactly that $\mathcal{L} \cong \mathcal{O}_X$ is
the neutral element in $\text{Pic}(X)$.

\medskip\noindent
Surjective. Let $\mathcal{F}$ be an $\mathcal{O}_X^*$-torsor.
Consider the presheaf of sets
$$
\mathcal{L}_1 : U \longmapsto
(\mathcal{F}(U) \times \mathcal{O}_X(U))/\mathcal{O}_X^*(U)
$$
where the action of $f \in \mathcal{O}_X^*(U)$ on
$(s, g)$ is $(fs, f^{-1}g)$. Then $\mathcal{L}_1$ is a presheaf
of $\mathcal{O}_X$-modules by setting
$(s, g) + (s', g') = (s, g + (s'/s)g')$ where $s'/s$ is the local
section $f$ of $\mathcal{O}_X^*$ such that $fs = s'$, and
$h(s, g) = (s, hg)$ for $h$ a local section of $\mathcal{O}_X$.
We omit the verification that the sheafification
$\mathcal{L} = \mathcal{L}_1^\#$ is an invertible $\mathcal{O}_X$-module
whose associated $\mathcal{O}_X^*$-torsor $\mathcal{L}^*$ is isomorphic
to $\mathcal{F}$.
\end{proof}













\section{Locality of cohomology}
\label{section-locality}

\noindent
The following lemma says there is no ambiguity in defining the cohomology
of a sheaf $\mathcal{F}$ over an open.

\begin{lemma}
\label{lemma-cohomology-of-open}
Let $X$ be a ringed space.
Let $U \subset X$ be an open subspace.
\begin{enumerate}
\item If $\mathcal{I}$ is an injective $\mathcal{O}_X$-module
then $\mathcal{I}|_U$ is an injective $\mathcal{O}_U$-module.
\item For any sheaf of $\mathcal{O}_X$-modules $\mathcal{F}$ we have
$H^p(U, \mathcal{F}) = H^p(U, \mathcal{F}|_U)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $j : U \to X$ the open immersion.
Recall that the functor $j^{-1}$ of restriction to $U$ is a right adjoint
to the functor $j_!$ of extension by $0$, see
Sheaves, Lemma \ref{sheaves-lemma-j-shriek-modules}.
Moreover, $j_!$ is exact. Hence (1) follows from
Homology, Lemma \ref{homology-lemma-adjoint-preserve-injectives}.

\medskip\noindent
By definition $H^p(U, \mathcal{F}) = H^p(\Gamma(U, \mathcal{I}^\bullet))$
where $\mathcal{F} \to \mathcal{I}^\bullet$ is an injective resolution
in $\textit{Mod}(\mathcal{O}_X)$.
By the above we see that $\mathcal{F}|_U \to \mathcal{I}^\bullet|_U$
is an injective resolution in $\textit{Mod}(\mathcal{O}_U)$.
Hence $H^p(U, \mathcal{F}|_U)$ is equal to
$H^p(\Gamma(U, \mathcal{I}^\bullet|_U))$.
Of course $\Gamma(U, \mathcal{F}) = \Gamma(U, \mathcal{F}|_U)$ for
any sheaf $\mathcal{F}$ on $X$.
Hence the equality
in (2).
\end{proof}

\noindent
Let $X$ be a ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
Let $U \subset V \subset X$ be open subsets.
Then there is a canonical {\it restriction mapping}
\begin{equation}
\label{equation-restriction-mapping}
H^n(V, \mathcal{F})
\longrightarrow
H^n(U, \mathcal{F}), \quad
\xi \longmapsto \xi|_U
\end{equation}
functorial in $\mathcal{F}$. Namely, choose any injective
resolution $\mathcal{F} \to \mathcal{I}^\bullet$. The restriction
mappings of the sheaves $\mathcal{I}^p$ give a morphism of complexes
$$
\Gamma(V, \mathcal{I}^\bullet)
\longrightarrow
\Gamma(U, \mathcal{I}^\bullet)
$$
The LHS is a complex representing $R\Gamma(V, \mathcal{F})$
and the RHS is a complex representing $R\Gamma(U, \mathcal{F})$.
We get the map on cohomology groups by applying the functor $H^n$.
As indicated we will use the notation $\xi \mapsto \xi|_U$ to denote this map.
Thus the rule $U \mapsto H^n(U, \mathcal{F})$ is a presheaf of
$\mathcal{O}_X$-modules. This presheaf is customarily denoted
$\underline{H}^n(\mathcal{F})$. We will give another interpretation
of this presheaf in Lemma \ref{lemma-include}.

\begin{lemma}
\label{lemma-kill-cohomology-class-on-covering}
Let $X$ be a ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
Let $U \subset X$ be an open subspace.
Let $n > 0$ and let $\xi \in H^n(U, \mathcal{F})$.
Then there exists an open covering
$U = \bigcup_{i\in I} U_i$ such that $\xi|_{U_i} = 0$ for
all $i \in I$.
\end{lemma}

\begin{proof}
Let $\mathcal{F} \to \mathcal{I}^\bullet$ be an injective resolution.
Then
$$
H^n(U, \mathcal{F}) =
\frac{\Ker(\mathcal{I}^n(U) \to \mathcal{I}^{n + 1}(U))}
{\Im(\mathcal{I}^{n - 1}(U) \to \mathcal{I}^n(U))}.
$$
Pick an element $\tilde \xi \in \mathcal{I}^n(U)$ representing the
cohomology class in the presentation above. Since $\mathcal{I}^\bullet$
is an injective resolution of $\mathcal{F}$ and $n > 0$ we see that
the complex $\mathcal{I}^\bullet$ is exact in degree $n$. Hence
$\Im(\mathcal{I}^{n - 1} \to \mathcal{I}^n) =
\Ker(\mathcal{I}^n \to \mathcal{I}^{n + 1})$ as sheaves.
Since $\tilde \xi$ is a section of the kernel sheaf over $U$
we conclude there exists an open covering $U = \bigcup_{i \in I} U_i$
such that $\tilde \xi|_{U_i}$ is the image under $d$ of a section
$\xi_i \in \mathcal{I}^{n - 1}(U_i)$. By our definition of the
restriction $\xi|_{U_i}$ as corresponding to the class of
$\tilde \xi|_{U_i}$ we conclude.
\end{proof}

\begin{lemma}
\label{lemma-describe-higher-direct-images}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{F}$ be a $\mathcal{O}_X$-module.
The sheaves $R^if_*\mathcal{F}$ are the sheaves
associated to the presheaves
$$
V \longmapsto H^i(f^{-1}(V), \mathcal{F})
$$
with restriction mappings as in Equation (\ref{equation-restriction-mapping}).
There is a similar statement for $R^if_*$ applied to a
bounded below complex $\mathcal{F}^\bullet$.
\end{lemma}

\begin{proof}
Let $\mathcal{F} \to \mathcal{I}^\bullet$ be an injective resolution.
Then $R^if_*\mathcal{F}$ is by definition the $i$th cohomology sheaf
of the complex
$$
f_*\mathcal{I}^0 \to f_*\mathcal{I}^1 \to f_*\mathcal{I}^2 \to \ldots
$$
By definition of the abelian category structure on $\mathcal{O}_Y$-modules
this cohomology sheaf is the sheaf associated to the presheaf
$$
V
\longmapsto
\frac{\Ker(f_*\mathcal{I}^i(V) \to f_*\mathcal{I}^{i + 1}(V))}
{\Im(f_*\mathcal{I}^{i - 1}(V) \to f_*\mathcal{I}^i(V))}
$$
and this is obviously equal to
$$
\frac{\Ker(\mathcal{I}^i(f^{-1}(V)) \to \mathcal{I}^{i + 1}(f^{-1}(V)))}
{\Im(\mathcal{I}^{i - 1}(f^{-1}(V)) \to \mathcal{I}^i(f^{-1}(V)))}
$$
which is equal to $H^i(f^{-1}(V), \mathcal{F})$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-localize-higher-direct-images}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Let $V \subset Y$ be an open subspace.
Denote $g : f^{-1}(V) \to V$ the restriction of $f$.
Then we have
$$
R^pg_*(\mathcal{F}|_{f^{-1}(V)}) = (R^pf_*\mathcal{F})|_V
$$
There is a similar statement for the
derived image $Rf_*\mathcal{F}^\bullet$ where $\mathcal{F}^\bullet$
is a bounded below complex of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
First proof. Apply Lemmas \ref{lemma-describe-higher-direct-images}
and \ref{lemma-cohomology-of-open} to see the displayed equality.
Second proof. Choose an injective resolution
$\mathcal{F} \to \mathcal{I}^\bullet$
and use that $\mathcal{F}|_{f^{-1}(V)} \to \mathcal{I}^\bullet|_{f^{-1}(V)}$
is an injective resolution also.
\end{proof}

\begin{remark}
\label{remark-daniel}
Here is a different approach to the proofs of
Lemmas \ref{lemma-kill-cohomology-class-on-covering} and
\ref{lemma-describe-higher-direct-images} above.
Let $(X, \mathcal{O}_X)$ be a ringed space.
Let $i_X : \textit{Mod}(\mathcal{O}_X) \to \textit{PMod}(\mathcal{O}_X)$
be the inclusion functor and let $\#$ be the sheafification functor.
Recall that $i_X$ is left exact and $\#$ is exact.
\begin{enumerate}
\item First prove Lemma \ref{lemma-include} below which says that the
right derived functors of $i_X$ are given by
$R^pi_X\mathcal{F} = \underline{H}^p(\mathcal{F})$.
Here is another proof: The equality is clear for $p = 0$.
Both $(R^pi_X)_{p \geq 0}$ and $(\underline{H}^p)_{p \geq 0}$
are delta functors vanishing on injectives, hence both are universal,
hence they are isomorphic. See Homology,
Section \ref{homology-section-cohomological-delta-functor}.
\item A restatement of Lemma \ref{lemma-kill-cohomology-class-on-covering}
is that $(\underline{H}^p(\mathcal{F}))^\# = 0$, $p > 0$ for any sheaf of
$\mathcal{O}_X$-modules $\mathcal{F}$.
To see this is true, use that ${}^\#$ is exact so
$$
(\underline{H}^p(\mathcal{F}))^\# =
(R^pi_X\mathcal{F})^\# =
R^p(\# \circ i_X)(\mathcal{F}) = 0
$$
because $\# \circ i_X$ is the identity functor.
\item Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module. The presheaf
$V \mapsto H^p(f^{-1}V, \mathcal{F})$ is equal to
$R^p (i_Y \circ f_*)\mathcal{F}$. You can prove this by noticing that
both give universal delta functors as in the argument of (1) above.
Hence Lemma \ref{lemma-describe-higher-direct-images}
says that $R^p f_* \mathcal{F}= (R^p (i_Y \circ f_*)\mathcal{F})^\#$.
Again using that $\#$ is exact a that $\# \circ i_Y$ is the identity
functor we see that
$$
R^p f_* \mathcal{F} =
R^p(\# \circ i_Y \circ f_*)\mathcal{F} =
(R^p (i_Y \circ f_*)\mathcal{F})^\#
$$
as desired.
\end{enumerate}
\end{remark}






\section{Mayer-Vietoris}
\label{section-mayer-vietoris}

\noindent
Below will construct the {\v C}ech-to-cohomology spectral sequence, see
Lemma \ref{lemma-cech-spectral-sequence}.
A special case of that spectral sequence is the Mayer-Vietoris
long exact sequence. Since it is such a basic, useful and easy to understand
variant of the spectral sequence we treat it here separately.

\begin{lemma}
\label{lemma-injective-restriction-surjective}
Let $X$ be a ringed space.
Let $U' \subset U \subset X$ be open subspaces.
For any injective $\mathcal{O}_X$-module $\mathcal{I}$ the
restriction mapping
$\mathcal{I}(U) \to \mathcal{I}(U')$ is surjective.
\end{lemma}

\begin{proof}
Let $j : U \to X$ and $j' : U' \to X$ be the open immersions.
Recall that $j_!\mathcal{O}_U$ is the extension by zero of
$\mathcal{O}_U = \mathcal{O}_X|_U$, see
Sheaves, Section \ref{sheaves-section-open-immersions}.
Since $j_!$ is a left adjoint to restriction we see that
for any sheaf $\mathcal{F}$ of $\mathcal{O}_X$-modules
$$
\Hom_{\mathcal{O}_X}(j_!\mathcal{O}_U, \mathcal{F})
=
\Hom_{\mathcal{O}_U}(\mathcal{O}_U, \mathcal{F}|_U)
=
\mathcal{F}(U)
$$
see Sheaves, Lemma \ref{sheaves-lemma-j-shriek-modules}.
Similarly, the sheaf $j'_!\mathcal{O}_{U'}$ represents the
functor $\mathcal{F} \mapsto \mathcal{F}(U')$.
Moreover there
is an obvious canonical map of $\mathcal{O}_X$-modules
$$
j'_!\mathcal{O}_{U'} \longrightarrow j_!\mathcal{O}_U
$$
which corresponds to the restriction mapping
$\mathcal{F}(U) \to \mathcal{F}(U')$ via Yoneda's lemma
(Categories, Lemma \ref{categories-lemma-yoneda}). By the description
of the stalks of the sheaves
$j'_!\mathcal{O}_{U'}$, $j_!\mathcal{O}_U$
we see that the displayed map above is injective (see lemma cited above).
Hence if $\mathcal{I}$ is an injective $\mathcal{O}_X$-module,
then the map
$$
\Hom_{\mathcal{O}_X}(j_!\mathcal{O}_U, \mathcal{I})
\longrightarrow
\Hom_{\mathcal{O}_X}(j'_!\mathcal{O}_{U'}, \mathcal{I})
$$
is surjective, see
Homology, Lemma \ref{homology-lemma-characterize-injectives}.
Putting everything together we obtain the lemma.
\end{proof}

\begin{lemma}[Mayer-Vietoris]
\label{lemma-mayer-vietoris}
Let $X$ be a ringed space. Suppose that $X = U \cup V$ is a
union of two open subsets. For every $\mathcal{O}_X$-module $\mathcal{F}$
there exists a long exact cohomology sequence
$$
0 \to
H^0(X, \mathcal{F}) \to
H^0(U, \mathcal{F}) \oplus H^0(V, \mathcal{F}) \to
H^0(U \cap V, \mathcal{F}) \to
H^1(X, \mathcal{F}) \to \ldots
$$
This long exact sequence is functorial in $\mathcal{F}$.
\end{lemma}

\begin{proof}
The sheaf condition says that the kernel of
$(1, -1) : \mathcal{F}(U) \oplus \mathcal{F}(V) \to \mathcal{F}(U \cap V)$
is equal to the image of $\mathcal{F}(X)$ by the first map
for any abelian sheaf $\mathcal{F}$.
Lemma \ref{lemma-injective-restriction-surjective} above implies that the map
$(1, -1) : \mathcal{I}(U) \oplus \mathcal{I}(V) \to \mathcal{I}(U \cap V)$
is surjective whenever $\mathcal{I}$ is an injective $\mathcal{O}_X$-module.
Hence if $\mathcal{F} \to \mathcal{I}^\bullet$ is an injective resolution
of $\mathcal{F}$, then we get a short exact sequence of complexes
$$
0 \to
\mathcal{I}^\bullet(X) \to
\mathcal{I}^\bullet(U) \oplus \mathcal{I}^\bullet(V) \to
\mathcal{I}^\bullet(U \cap V) \to
0.
$$
Taking cohomology gives the result (use
Homology, Lemma \ref{homology-lemma-long-exact-sequence-cochain}).
We omit the proof of the functoriality of the sequence.
\end{proof}

\begin{lemma}[Relative Mayer-Vietoris]
\label{lemma-relative-mayer-vietoris}
Let $f : X \to Y$ be a morphism of ringed spaces.
Suppose that $X = U \cup V$ is a union of two open subsets.
Denote $a = f|_U : U \to Y$, $b = f|_V : V \to Y$, and
$c = f|_{U \cap V} : U \cap V \to Y$.
For every $\mathcal{O}_X$-module $\mathcal{F}$
there exists a long exact sequence
$$
0 \to
f_*\mathcal{F} \to
a_*(\mathcal{F}|_U) \oplus b_*(\mathcal{F}|_V) \to
c_*(\mathcal{F}|_{U \cap V}) \to
R^1f_*\mathcal{F} \to \ldots
$$
This long exact sequence is functorial in $\mathcal{F}$.
\end{lemma}

\begin{proof}
Let $\mathcal{F} \to \mathcal{I}^\bullet$ be an injective resolution
of $\mathcal{F}$. We claim that we
get a short exact sequence of complexes
$$
0 \to
f_*\mathcal{I}^\bullet \to
a_*\mathcal{I}^\bullet|_U \oplus b_*\mathcal{I}^\bullet|_V \to
c_*\mathcal{I}^\bullet|_{U \cap V} \to
0.
$$
Namely, for any open $W \subset Y$, and for any $n \geq 0$ the
corresponding sequence of groups of sections over $W$
$$
0 \to
\mathcal{I}^n(f^{-1}(W)) \to
\mathcal{I}^n(U \cap f^{-1}(W))
\oplus \mathcal{I}^n(V \cap f^{-1}(W)) \to
\mathcal{I}^n(U \cap V \cap f^{-1}(W)) \to
0
$$
was shown to be short exact in the proof of Lemma \ref{lemma-mayer-vietoris}.
The lemma follows by taking cohomology sheaves and using the fact that
$\mathcal{I}^\bullet|_U$ is an injective resolution of $\mathcal{F}|_U$
and similarly for $\mathcal{I}^\bullet|_V$, $\mathcal{I}^\bullet|_{U \cap V}$
see Lemma \ref{lemma-cohomology-of-open}.
\end{proof}




















\section{The {\v C}ech complex and {\v C}ech cohomology}
\label{section-cech}

\noindent
Let $X$ be a topological space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be an open covering,
see Topology, Basic notion (\ref{topology-item-covering}).
As is customary we denote
$U_{i_0\ldots i_p} = U_{i_0} \cap \ldots \cap U_{i_p}$ for the
$(p + 1)$-fold intersection of members of $\mathcal{U}$.
Let $\mathcal{F}$ be an abelian presheaf on $X$.
Set
$$
\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})
=
\prod\nolimits_{(i_0, \ldots, i_p) \in I^{p + 1}}
\mathcal{F}(U_{i_0\ldots i_p}).
$$
This is an abelian group. For
$s \in \check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})$ we denote
$s_{i_0\ldots i_p}$ its value in $\mathcal{F}(U_{i_0\ldots i_p})$.
Note that if $s \in \check{\mathcal{C}}^1(\mathcal{U}, \mathcal{F})$
and $i, j \in I$ then $s_{ij}$ and $s_{ji}$ are both elements
of $\mathcal{F}(U_i \cap U_j)$ but there is no imposed
relation between $s_{ij}$ and $s_{ji}$. In other words, we are {\it not}
working with alternating cochains (these will be defined
in Section \ref{section-alternating-cech}). We define
$$
d : \check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})
\longrightarrow
\check{\mathcal{C}}^{p + 1}(\mathcal{U}, \mathcal{F})
$$
by the formula
\begin{equation}
\label{equation-d-cech}
d(s)_{i_0\ldots i_{p + 1}}
=
\sum\nolimits_{j = 0}^{p + 1}
(-1)^j
s_{i_0\ldots \hat i_j \ldots i_{p + 1}}|_{U_{i_0\ldots i_{p + 1}}}
\end{equation}
It is straightforward to see that $d \circ d = 0$. In other words
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})$ is a complex.

\begin{definition}
\label{definition-cech-complex}
Let $X$ be a topological space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be an open covering.
Let $\mathcal{F}$ be an abelian presheaf on $X$.
The complex $\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})$
is the {\it {\v C}ech complex} associated to $\mathcal{F}$ and the
open covering $\mathcal{U}$. Its cohomology groups
$H^i(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}))$ are
called the {\it {\v C}ech cohomology groups} associated to
$\mathcal{F}$ and the covering $\mathcal{U}$.
They are denoted $\check H^i(\mathcal{U}, \mathcal{F})$.
\end{definition}

\begin{lemma}
\label{lemma-cech-h0}
Let $X$ be a topological space.
Let $\mathcal{F}$ be an abelian presheaf on $X$.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an abelian sheaf and
\item for every open covering $\mathcal{U} : U = \bigcup_{i \in I} U_i$
the natural map
$$
\mathcal{F}(U) \to \check{H}^0(\mathcal{U}, \mathcal{F})
$$
is bijective.
\end{enumerate}
\end{lemma}

\begin{proof}
This is true since the sheaf condition is exactly that
$\mathcal{F}(U) \to \check{H}^0(\mathcal{U}, \mathcal{F})$
is bijective for every open covering.
\end{proof}






\section{{\v C}ech cohomology as a functor on presheaves}
\label{section-cech-functor}

\noindent
Warning: In this section we work almost exclusively with presheaves and
categories of presheaves and the results are completely wrong in the
setting of sheaves and categories of sheaves!

\medskip\noindent
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be an open covering.
Let $\mathcal{F}$ be a presheaf of $\mathcal{O}_X$-modules.
We have the {\v C}ech complex
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})$
of $\mathcal{F}$ just by thinking of $\mathcal{F}$
as a presheaf of abelian groups. However, each term
$\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})$ has a natural
structure of a $\mathcal{O}_X(U)$-module and the differential is given by
$\mathcal{O}_X(U)$-module maps. Moreover, it is clear that the
construction
$$
\mathcal{F} \longmapsto \check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
$$
is functorial in $\mathcal{F}$. In fact, it is a functor
\begin{equation}
\label{equation-cech-functor}
\check{\mathcal{C}}^\bullet(\mathcal{U}, -) :
\textit{PMod}(\mathcal{O}_X)
\longrightarrow
\text{Comp}^{+}(\text{Mod}_{\mathcal{O}_X(U)})
\end{equation}
see
Derived Categories, Definition \ref{derived-definition-complexes-notation}
for notation. Recall that the category of bounded below complexes
in an abelian category is an abelian category, see
Homology, Lemma \ref{homology-lemma-cat-cochain-abelian}.

\begin{lemma}
\label{lemma-cech-exact-presheaves}
The functor given by Equation (\ref{equation-cech-functor})
is an exact functor (see Homology, Lemma \ref{homology-lemma-exact-functor}).
\end{lemma}

\begin{proof}
For any open $W \subset U$ the functor
$\mathcal{F} \mapsto \mathcal{F}(W)$ is an additive exact functor
from $\textit{PMod}(\mathcal{O}_X)$ to $\text{Mod}_{\mathcal{O}_X(U)}$.
The terms
$\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})$
of the complex are products of these exact functors and hence exact.
Moreover a sequence of complexes is exact if and only if the sequence
of terms in a given degree is exact. Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-cech-cohomology-delta-functor-presheaves}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be an open covering.
The functors $\mathcal{F} \mapsto \check{H}^n(\mathcal{U}, \mathcal{F})$
form a $\delta$-functor from the abelian category of
presheaves of $\mathcal{O}_X$-modules to the category
of $\mathcal{O}_X(U)$-modules (see
Homology, Definition \ref{homology-definition-cohomological-delta-functor}).
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-cech-exact-presheaves}
a short exact sequence of presheaves of
$\mathcal{O}_X$-modules
$0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
is turned into a short exact sequence of complexes of
$\mathcal{O}_X(U)$-modules. Hence we can use
Homology, Lemma \ref{homology-lemma-long-exact-sequence-cochain}
to get the boundary maps
$\delta_{\mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3} :
\check{H}^n(\mathcal{U}, \mathcal{F}_3) \to
\check{H}^{n + 1}(\mathcal{U}, \mathcal{F}_1)$
and a corresponding long exact sequence. We omit the verification
that these maps are compatible with maps between short exact
sequences of presheaves.
\end{proof}


\noindent
In the formulation of the following lemma we use the functor $j_{p!}$ of
extension by $0$ for presheaves of modules
relative to an open immersion $j : U \to X$.
See Sheaves, Section \ref{sheaves-section-open-immersions}. For any open
$W \subset X$ and any presheaf $\mathcal{G}$ of $\mathcal{O}_X|_U$-modules
we have
$$
(j_{p!}\mathcal{G})(W) =
\left\{
\begin{matrix}
\mathcal{G}(W) & \text{if } W \subset U \\
0 & \text{else.}
\end{matrix}
\right.
$$
Moreover, the functor $j_{p!}$ is a left adjoint to the restriction functor
see Sheaves, Lemma \ref{sheaves-lemma-j-shriek-modules}.
In particular we have the following formula
$$
\Hom_{\mathcal{O}_X}(j_{p!}\mathcal{O}_U, \mathcal{F})
=
\Hom_{\mathcal{O}_U}(\mathcal{O}_U, \mathcal{F}|_U)
=
\mathcal{F}(U).
$$
Since the functor $\mathcal{F} \mapsto \mathcal{F}(U)$ is an exact functor
on the category of presheaves we conclude that the presheaf
$j_{p!}\mathcal{O}_U$ is a projective object in the category
$\textit{PMod}(\mathcal{O}_X)$, see
Homology, Lemma \ref{homology-lemma-characterize-projectives}.

\medskip\noindent
Note that if we are given open subsets $U \subset V \subset X$
with associated open immersions $j_U, j_V$, then we have a canonical
map $(j_U)_{p!}\mathcal{O}_U \to (j_V)_{p!}\mathcal{O}_V$. It is the
identity on sections over any open $W \subset U$ and $0$ else.
In terms of the identification
$\Hom_{\mathcal{O}_X}((j_U)_{p!}\mathcal{O}_U, (j_V)_{p!}\mathcal{O}_V) =
(j_V)_{p!}\mathcal{O}_V(U) = \mathcal{O}_V(U)$ it corresponds to
the element $1 \in \mathcal{O}_V(U)$.

\begin{lemma}
\label{lemma-cech-map-into}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
Denote $j_{i_0\ldots i_p} : U_{i_0 \ldots i_p} \to X$ the open immersion.
Consider the chain complex $K(\mathcal{U})_\bullet$
of presheaves of $\mathcal{O}_X$-modules
$$
\ldots
\to
\bigoplus_{i_0i_1i_2} (j_{i_0i_1i_2})_{p!}\mathcal{O}_{U_{i_0i_1i_2}}
\to
\bigoplus_{i_0i_1} (j_{i_0i_1})_{p!}\mathcal{O}_{U_{i_0i_1}}
\to
\bigoplus_{i_0} (j_{i_0})_{p!}\mathcal{O}_{U_{i_0}}
\to 0 \to \ldots
$$
where the last nonzero term is placed in degree $0$
and where the map
$$
(j_{i_0\ldots i_{p + 1}})_{p!}\mathcal{O}_{U_{i_0\ldots i_{p + 1}}}
\longrightarrow
(j_{i_0\ldots \hat i_j \ldots i_{p + 1}})_{p!}
\mathcal{O}_{U_{i_0\ldots \hat i_j \ldots i_{p + 1}}}
$$
is given by $(-1)^j$ times the canonical map.
Then there is an isomorphism
$$
\Hom_{\mathcal{O}_X}(K(\mathcal{U})_\bullet, \mathcal{F})
=
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
$$
functorial in $\mathcal{F} \in \Ob(\textit{PMod}(\mathcal{O}_X))$.
\end{lemma}

\begin{proof}
We saw in the discussion just above the lemma that
$$
\Hom_{\mathcal{O}_X}(
(j_{i_0\ldots i_p})_{p!}\mathcal{O}_{U_{i_0\ldots i_p}},
\mathcal{F})
=
\mathcal{F}(U_{i_0\ldots i_p}).
$$
Hence we see that it is indeed the case that the direct sum
$$
\bigoplus\nolimits_{i_0 \ldots i_p}
(j_{i_0 \ldots i_p})_{p!}\mathcal{O}_{U_{i_0 \ldots i_p}}
$$
represents the functor
$$
\mathcal{F}
\longmapsto
\prod\nolimits_{i_0\ldots i_p} \mathcal{F}(U_{i_0\ldots i_p}).
$$
Hence by Categories, Yoneda Lemma \ref{categories-lemma-yoneda}
we see that there is a complex $K(\mathcal{U})_\bullet$ with terms
as given. It is a simple matter to see that the maps are as given
in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-homology-complex}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
Let $\mathcal{O}_\mathcal{U} \subset \mathcal{O}_X$
be the image presheaf of the map
$\bigoplus j_{p!}\mathcal{O}_{U_i} \to \mathcal{O}_X$.
The chain complex $K(\mathcal{U})_\bullet$ of presheaves
of Lemma \ref{lemma-cech-map-into} above has homology presheaves
$$
H_i(K(\mathcal{U})_\bullet) =
\left\{
\begin{matrix}
0 & \text{if} & i \not = 0 \\
\mathcal{O}_\mathcal{U} & \text{if} & i = 0
\end{matrix}
\right.
$$
\end{lemma}

\begin{proof}
Consider the extended complex $K^{ext}_\bullet$ one gets by putting
$\mathcal{O}_\mathcal{U}$ in degree $-1$ with the obvious map
$K(\mathcal{U})_0 =
\bigoplus_{i_0} (j_{i_0})_{p!}\mathcal{O}_{U_{i_0}} \to
\mathcal{O}_\mathcal{U}$.
It suffices to show that taking sections of this extended complex over
any open $W \subset X$ leads to an acyclic complex.
In fact, we claim that for every $W \subset X$ the complex
$K^{ext}_\bullet(W)$ is homotopy equivalent to the zero complex.
Write $I = I_1 \amalg I_2$ where $W \subset U_i$ if and only
if $i \in I_1$.

\medskip\noindent
If $I_1 = \emptyset$, then the complex $K^{ext}_\bullet(W) = 0$ so there is
nothing to prove.

\medskip\noindent
If $I_1 \not = \emptyset$, then
$\mathcal{O}_\mathcal{U}(W) = \mathcal{O}_X(W)$
and
$$
K^{ext}_p(W) =
\bigoplus\nolimits_{i_0 \ldots i_p \in I_1} \mathcal{O}_X(W).
$$
This is true because of the simple description of the presheaves
$(j_{i_0 \ldots i_p})_{p!}\mathcal{O}_{U_{i_0 \ldots i_p}}$.
Moreover, the differential of the complex $K^{ext}_\bullet(W)$
is given by
$$
d(s)_{i_0 \ldots i_p} =
\sum\nolimits_{j = 0, \ldots, p + 1} \sum\nolimits_{i \in I_1}
(-1)^j s_{i_0 \ldots i_{j - 1} i i_j \ldots i_p}.
$$
The sum is finite as the element $s$ has finite support.
Fix an element $i_{\text{fix}} \in I_1$. Define a map
$$
h : K^{ext}_p(W) \longrightarrow K^{ext}_{p + 1}(W)
$$
by the rule
$$
h(s)_{i_0 \ldots i_{p + 1}} =
\left\{
\begin{matrix}
0 & \text{if} & i_0 \not = i \\
s_{i_1 \ldots i_{p + 1}} & \text{if} & i_0 = i_{\text{fix}}
\end{matrix}
\right.
$$
We will use the shorthand
$h(s)_{i_0 \ldots i_{p + 1}} = (i_0 = i_{\text{fix}}) s_{i_1 \ldots i_p}$
for this. Then we compute
\begin{eqnarray*}
& & (dh + hd)(s)_{i_0 \ldots i_p} \\
& = &
\sum_j \sum_{i \in I_1} (-1)^j h(s)_{i_0 \ldots i_{j - 1} i i_j \ldots i_p}
+
(i = i_0) d(s)_{i_1 \ldots i_p} \\
& = &
s_{i_0 \ldots i_p} +
\sum_{j \geq 1}\sum_{i \in I_1}
(-1)^j (i_0 = i_{\text{fix}}) s_{i_1 \ldots i_{j - 1} i i_j \ldots i_p}
+
(i_0 = i_{\text{fix}}) d(s)_{i_1 \ldots i_p}
\end{eqnarray*}
which is equal to $s_{i_0 \ldots i_p}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-cech-cohomology-derived-presheaves}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$
be an open covering of $U \subset X$.
The {\v C}ech cohomology functors $\check{H}^p(\mathcal{U}, -)$
are canonically isomorphic as a $\delta$-functor to
the right derived functors of the functor
$$
\check{H}^0(\mathcal{U}, -) :
\textit{PMod}(\mathcal{O}_X)
\longrightarrow
\text{Mod}_{\mathcal{O}_X(U)}.
$$
Moreover, there is a functorial quasi-isomorphism
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
\longrightarrow
R\check{H}^0(\mathcal{U}, \mathcal{F})
$$
where the right hand side indicates the right derived functor
$$
R\check{H}^0(\mathcal{U}, -) :
D^{+}(\textit{PMod}(\mathcal{O}_X))
\longrightarrow
D^{+}(\mathcal{O}_X(U))
$$
of the left exact functor $\check{H}^0(\mathcal{U}, -)$.
\end{lemma}

\begin{proof}
Note that the category of presheaves of $\mathcal{O}_X$-modules
has enough injectives, see
Injectives, Proposition \ref{injectives-proposition-presheaves-modules}.
Note that $\check{H}^0(\mathcal{U}, -)$ is a left exact functor
from the category of presheaves of $\mathcal{O}_X$-modules
to the category of $\mathcal{O}_X(U)$-modules.
Hence the derived functor and the right derived functor exist, see
Derived Categories, Section \ref{derived-section-right-derived-functor}.

\medskip\noindent
Let $\mathcal{I}$ be a injective presheaf of $\mathcal{O}_X$-modules.
In this case the functor $\Hom_{\mathcal{O}_X}(-, \mathcal{I})$
is exact on $\textit{PMod}(\mathcal{O}_X)$. By
Lemma \ref{lemma-cech-map-into} we have
$$
\Hom_{\mathcal{O}_X}(K(\mathcal{U})_\bullet, \mathcal{I})
=
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}).
$$
By Lemma \ref{lemma-homology-complex} we have that $K(\mathcal{U})_\bullet$ is
quasi-isomorphic to $\mathcal{O}_\mathcal{U}[0]$. Hence by
the exactness of Hom into $\mathcal{I}$ mentioned above we see
that $\check{H}^i(\mathcal{U}, \mathcal{I}) = 0$ for all
$i > 0$. Thus the $\delta$-functor $(\check{H}^n, \delta)$
(see Lemma \ref{lemma-cech-cohomology-delta-functor-presheaves})
satisfies the assumptions of
Homology, Lemma \ref{homology-lemma-efface-implies-universal},
and hence is a universal $\delta$-functor.

\medskip\noindent
By
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}
also the sequence $R^i\check{H}^0(\mathcal{U}, -)$
forms a universal $\delta$-functor. By the uniqueness of universal
$\delta$-functors, see
Homology, Lemma \ref{homology-lemma-uniqueness-universal-delta-functor}
we conclude that
$R^i\check{H}^0(\mathcal{U}, -) = \check{H}^i(\mathcal{U}, -)$.
This is enough for most applications
and the reader is suggested to skip the rest of the proof.

\medskip\noindent
Let $\mathcal{F}$ be any presheaf of $\mathcal{O}_X$-modules.
Choose an injective resolution $\mathcal{F} \to \mathcal{I}^\bullet$
in the category $\textit{PMod}(\mathcal{O}_X)$.
Consider the double complex $A^{\bullet, \bullet}$ with terms
$$
A^{p, q} =
\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{I}^q).
$$
Consider the simple complex $sA^\bullet$ associated to this double
complex. There is a map of complexes
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
\longrightarrow
sA^\bullet
$$
coming from the maps
$\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})
\to A^{p, 0} = \check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}^0)$
and there is a map of complexes
$$
\check{H}^0(\mathcal{U}, \mathcal{I}^\bullet)
\longrightarrow
sA^\bullet
$$
coming from the maps
$\check{H}^0(\mathcal{U}, \mathcal{I}^q) \to
A^{0, q} = \check{\mathcal{C}}^0(\mathcal{U}, \mathcal{I}^q)$.
Both of these maps are quasi-isomorphisms by an application of
Homology, Lemma \ref{homology-lemma-double-complex-gives-resolution}.
Namely, the columns of the double complex are exact in positive degrees
because the {\v C}ech complex as a functor is exact
(Lemma \ref{lemma-cech-exact-presheaves})
and the rows of the double complex are exact in positive degrees
since as we just saw the higher {\v C}ech cohomology groups of the injective
presheaves $\mathcal{I}^q$ are zero.
Since quasi-isomorphisms become invertible
in $D^{+}(\mathcal{O}_X(U))$ this gives the last displayed morphism
of the lemma. We omit the verification that this morphism is
functorial.
\end{proof}





\section{{\v C}ech cohomology and cohomology}
\label{section-cech-cohomology-cohomology}

\begin{lemma}
\label{lemma-injective-trivial-cech}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
Let $\mathcal{I}$ be an injective $\mathcal{O}_X$-module.
Then
$$
\check{H}^p(\mathcal{U}, \mathcal{I}) =
\left\{
\begin{matrix}
\mathcal{I}(U) & \text{if} & p = 0 \\
0 & \text{if} & p > 0
\end{matrix}
\right.
$$
\end{lemma}

\begin{proof}
An injective $\mathcal{O}_X$-module is also injective as an object in
the category $\textit{PMod}(\mathcal{O}_X)$ (for example since
sheafification is an exact left adjoint to the inclusion functor,
using Homology, Lemma \ref{homology-lemma-adjoint-preserve-injectives}).
Hence we can apply Lemma \ref{lemma-cech-cohomology-derived-presheaves}
(or its proof) to see the result.
\end{proof}

\begin{lemma}
\label{lemma-cech-cohomology}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
There is a transformation
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, -)
\longrightarrow
R\Gamma(U, -)
$$
of functors
$\textit{Mod}(\mathcal{O}_X) \to D^{+}(\mathcal{O}_X(U))$.
In particular this provides canonical maps
$\check{H}^p(\mathcal{U}, \mathcal{F}) \to H^p(U, \mathcal{F})$ for
$\mathcal{F}$ ranging over $\textit{Mod}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module. Choose an injective resolution
$\mathcal{F} \to \mathcal{I}^\bullet$. Consider the double complex
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}^\bullet)$ with terms
$\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{I}^q)$.
There is a map of complexes
$$
\alpha :
\Gamma(U, \mathcal{I}^\bullet)
\longrightarrow
\text{Tot}(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}^\bullet))
$$
coming from the maps
$\mathcal{I}^q(U) \to \check{H}^0(\mathcal{U}, \mathcal{I}^q)$
and a map of complexes
$$
\beta :
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
\longrightarrow
\text{Tot}(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}^\bullet))
$$
coming from the map $\mathcal{F} \to \mathcal{I}^0$.
We can apply
Homology, Lemma \ref{homology-lemma-double-complex-gives-resolution}
to see that $\alpha$ is a quasi-isomorphism.
Namely, Lemma \ref{lemma-injective-trivial-cech} implies that
the $q$th row of the double complex
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}^\bullet)$ is a
resolution of $\Gamma(U, \mathcal{I}^q)$.
Hence $\alpha$ becomes invertible in $D^{+}(\mathcal{O}_X(U))$ and
the transformation of the lemma is the composition of $\beta$
followed by the inverse of $\alpha$. We omit the verification
that this is functorial.
\end{proof}

\begin{lemma}
\label{lemma-cech-h1}
Let $X$ be a topological space. Let $\mathcal{H}$ be an abelian sheaf
on $X$. Let $\mathcal{U} : X = \bigcup_{i \in I} U_i$ be an open covering.
The map
$$
\check{H}^1(\mathcal{U}, \mathcal{H}) \longrightarrow H^1(X, \mathcal{H})
$$
is injective and identifies $\check{H}^1(\mathcal{U}, \mathcal{H})$ via
the bijection of Lemma \ref{lemma-torsors-h1}
with the set of isomorphism classes of $\mathcal{H}$-torsors
which restrict to trivial torsors over each $U_i$.
\end{lemma}

\begin{proof}
To see this we construct an inverse map. Namely, let $\mathcal{F}$ be a
$\mathcal{H}$-torsor whose restriction to $U_i$ is trivial. By
Lemma \ref{lemma-trivial-torsor} this means there
exists a section $s_i \in \mathcal{F}(U_i)$. On $U_{i_0} \cap U_{i_1}$
there is a unique section $s_{i_0i_1}$ of $\mathcal{H}$ such that
$s_{i_0i_1} \cdot s_{i_0}|_{U_{i_0} \cap U_{i_1}} =
s_{i_1}|_{U_{i_0} \cap U_{i_1}}$. A computation shows
that $s_{i_0i_1}$ is a {\v C}ech cocycle and that its class is well
defined (i.e., does not depend on the choice of the sections $s_i$).
The inverse maps the isomorphism class of $\mathcal{F}$ to the cohomology
class of the cocycle $(s_{i_0i_1})$.
We omit the verification that this map is indeed an inverse.
\end{proof}

\begin{lemma}
\label{lemma-include}
Let $X$ be a ringed space.
Consider the functor
$i : \textit{Mod}(\mathcal{O}_X) \to \textit{PMod}(\mathcal{O}_X)$.
It is a left exact functor with right derived functors given by
$$
R^pi(\mathcal{F}) = \underline{H}^p(\mathcal{F}) :
U \longmapsto H^p(U, \mathcal{F})
$$
see discussion in Section \ref{section-locality}.
\end{lemma}

\begin{proof}
It is clear that $i$ is left exact.
Choose an injective resolution $\mathcal{F} \to \mathcal{I}^\bullet$.
By definition $R^pi$ is the $p$th cohomology {\it presheaf}
of the complex $\mathcal{I}^\bullet$. In other words, the
sections of $R^pi(\mathcal{F})$ over an open $U$ are given by
$$
\frac{\Ker(\mathcal{I}^n(U) \to \mathcal{I}^{n + 1}(U))}
{\Im(\mathcal{I}^{n - 1}(U) \to \mathcal{I}^n(U))}.
$$
which is the definition of $H^p(U, \mathcal{F})$.
\end{proof}

\begin{lemma}
\label{lemma-cech-spectral-sequence}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
For any sheaf of $\mathcal{O}_X$-modules $\mathcal{F}$ there
is a spectral sequence $(E_r, d_r)_{r \geq 0}$ with
$$
E_2^{p, q} = \check{H}^p(\mathcal{U}, \underline{H}^q(\mathcal{F}))
$$
converging to $H^{p + q}(U, \mathcal{F})$.
This spectral sequence is functorial in $\mathcal{F}$.
\end{lemma}

\begin{proof}
This is a Grothendieck spectral sequence
(see
Derived Categories, Lemma \ref{derived-lemma-grothendieck-spectral-sequence})
for the functors
$$
i :  \textit{Mod}(\mathcal{O}_X) \to \textit{PMod}(\mathcal{O}_X)
\quad\text{and}\quad
\check{H}^0(\mathcal{U}, - ) : \textit{PMod}(\mathcal{O}_X)
\to \text{Mod}_{\mathcal{O}_X(U)}.
$$
Namely, we have $\check{H}^0(\mathcal{U}, i(\mathcal{F})) = \mathcal{F}(U)$
by Lemma \ref{lemma-cech-h0}. We have that $i(\mathcal{I})$ is
{\v C}ech acyclic by Lemma \ref{lemma-injective-trivial-cech}. And we
have that $\check{H}^p(\mathcal{U}, -) = R^p\check{H}^0(\mathcal{U}, -)$
as functors on $\textit{PMod}(\mathcal{O}_X)$
by Lemma \ref{lemma-cech-cohomology-derived-presheaves}.
Putting everything together gives the lemma.
\end{proof}

\begin{lemma}
\label{lemma-cech-spectral-sequence-application}
Let $X$ be a ringed space.
Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be a covering.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Assume that $H^i(U_{i_0 \ldots i_p}, \mathcal{F}) = 0$
for all $i > 0$, all $p \geq 0$ and all $i_0, \ldots, i_p \in I$.
Then $\check{H}^p(\mathcal{U}, \mathcal{F}) = H^p(U, \mathcal{F})$
as $\mathcal{O}_X(U)$-modules.
\end{lemma}

\begin{proof}
We will use the spectral sequence of
Lemma \ref{lemma-cech-spectral-sequence}.
The assumptions mean that $E_2^{p, q} = 0$ for all $(p, q)$ with
$q \not = 0$. Hence the spectral sequence degenerates at $E_2$
and the result follows.
\end{proof}

\begin{lemma}
\label{lemma-ses-cech-h1}
Let $X$ be a ringed space.
Let
$$
0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0
$$
be a short exact sequence of $\mathcal{O}_X$-modules.
Let $U \subset X$ be an open subset.
If there exists a cofinal system of open coverings $\mathcal{U}$
of $U$ such that $\check{H}^1(\mathcal{U}, \mathcal{F}) = 0$,
then the map $\mathcal{G}(U) \to \mathcal{H}(U)$ is
surjective.
\end{lemma}

\begin{proof}
Take an element $s \in \mathcal{H}(U)$. Choose an open covering
$\mathcal{U} : U = \bigcup_{i \in I} U_i$ such that
(a) $\check{H}^1(\mathcal{U}, \mathcal{F}) = 0$ and (b)
$s|_{U_i}$ is the image of a section $s_i \in \mathcal{G}(U_i)$.
Since we can certainly find a covering such that (b) holds
it follows from the assumptions of the lemma that we can find
a covering such that (a) and (b) both hold.
Consider the sections
$$
s_{i_0i_1} = s_{i_1}|_{U_{i_0i_1}} - s_{i_0}|_{U_{i_0i_1}}.
$$
Since $s_i$ lifts $s$ we see that $s_{i_0i_1} \in \mathcal{F}(U_{i_0i_1})$.
By the vanishing of $\check{H}^1(\mathcal{U}, \mathcal{F})$ we can
find sections $t_i \in \mathcal{F}(U_i)$ such that
$$
s_{i_0i_1} = t_{i_1}|_{U_{i_0i_1}} - t_{i_0}|_{U_{i_0i_1}}.
$$
Then clearly the sections $s_i - t_i$ satisfy the sheaf condition
and glue to a section of $\mathcal{G}$ over $U$ which maps to $s$.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-cech-vanish}
\begin{slogan}
If higher {\v C}ech cohomology of an abelian sheaf vanishes for all open covers,
then higher cohomology vanishes.
\end{slogan}
Let $X$ be a ringed space.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module such that
$$
\check{H}^p(\mathcal{U}, \mathcal{F}) = 0
$$
for all $p > 0$ and any open covering $\mathcal{U} : U = \bigcup_{i \in I} U_i$
of an open of $X$. Then $H^p(U, \mathcal{F}) = 0$ for all $p > 0$
and any open $U \subset X$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be a sheaf satisfying the assumption of the lemma.
We will indicate this by saying ``$\mathcal{F}$ has vanishing higher
{\v C}ech cohomology for any open covering''.
Choose an embedding $\mathcal{F} \to \mathcal{I}$ into an
injective $\mathcal{O}_X$-module.
By Lemma \ref{lemma-injective-trivial-cech} $\mathcal{I}$ has vanishing higher
{\v C}ech cohomology for any open covering.
Let $\mathcal{Q} = \mathcal{I}/\mathcal{F}$
so that we have a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{I} \to \mathcal{Q} \to 0.
$$
By Lemma \ref{lemma-ses-cech-h1} and our assumptions
this sequence is actually exact as a sequence of presheaves!
In particular we have a long exact sequence of {\v C}ech cohomology
groups for any open covering $\mathcal{U}$, see
Lemma \ref{lemma-cech-cohomology-delta-functor-presheaves}
for example. This implies that $\mathcal{Q}$ is also an $\mathcal{O}_X$-module
with vanishing higher {\v C}ech cohomology for all open coverings.

\medskip\noindent
Next, we look at the long exact cohomology sequence
$$
\xymatrix{
0 \ar[r] &
H^0(U, \mathcal{F}) \ar[r] &
H^0(U, \mathcal{I}) \ar[r] &
H^0(U, \mathcal{Q}) \ar[lld] \\
&
H^1(U, \mathcal{F}) \ar[r] &
H^1(U, \mathcal{I}) \ar[r] &
H^1(U, \mathcal{Q}) \ar[lld] \\
&
\ldots & \ldots & \ldots \\
}
$$
for any open $U \subset X$. Since $\mathcal{I}$ is injective we
have $H^n(U, \mathcal{I}) = 0$ for $n > 0$ (see
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}).
By the above we see that $H^0(U, \mathcal{I}) \to H^0(U, \mathcal{Q})$
is surjective and hence $H^1(U, \mathcal{F}) = 0$.
Since $\mathcal{F}$ was an arbitrary $\mathcal{O}_X$-module with
vanishing higher {\v C}ech cohomology we conclude that also
$H^1(U, \mathcal{Q}) = 0$ since $\mathcal{Q}$ is another of these
sheaves (see above). By the long exact sequence this in turn implies
that $H^2(U, \mathcal{F}) = 0$. And so on and so forth.
\end{proof}

\begin{lemma}
\label{lemma-cech-vanish-basis}
(Variant of Lemma \ref{lemma-cech-vanish}.)
Let $X$ be a ringed space.
Let $\mathcal{B}$ be a basis for the topology on $X$.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Assume there exists a set of open coverings $\text{Cov}$
with the following properties:
\begin{enumerate}
\item For every $\mathcal{U} \in \text{Cov}$
with $\mathcal{U} : U = \bigcup_{i \in I} U_i$ we have
$U, U_i \in \mathcal{B}$ and every $U_{i_0 \ldots i_p} \in \mathcal{B}$.
\item For every $U \in \mathcal{B}$ the open coverings of $U$
occurring in $\text{Cov}$ is a cofinal system of open coverings
of $U$.
\item For every $\mathcal{U} \in \text{Cov}$ we have
$\check{H}^p(\mathcal{U}, \mathcal{F}) = 0$ for all $p > 0$.
\end{enumerate}
Then $H^p(U, \mathcal{F}) = 0$ for all $p > 0$ and any $U \in \mathcal{B}$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ and $\text{Cov}$ be as in the lemma.
We will indicate this by saying ``$\mathcal{F}$ has vanishing higher
{\v C}ech cohomology for any $\mathcal{U} \in \text{Cov}$''.
Choose an embedding $\mathcal{F} \to \mathcal{I}$ into an
injective $\mathcal{O}_X$-module.
By Lemma \ref{lemma-injective-trivial-cech} $\mathcal{I}$
has vanishing higher {\v C}ech cohomology for any $\mathcal{U} \in \text{Cov}$.
Let $\mathcal{Q} = \mathcal{I}/\mathcal{F}$
so that we have a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{I} \to \mathcal{Q} \to 0.
$$
By Lemma \ref{lemma-ses-cech-h1} and our assumption (2)
this sequence gives rise to an exact sequence
$$
0 \to \mathcal{F}(U) \to \mathcal{I}(U) \to \mathcal{Q}(U) \to 0.
$$
for every $U \in \mathcal{B}$. Hence for any $\mathcal{U} \in \text{Cov}$
we get a short exact sequence of {\v C}ech complexes
$$
0 \to
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \to
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}) \to
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{Q}) \to 0
$$
since each term in the {\v C}ech complex is made up out of a product of
values over elements of $\mathcal{B}$ by assumption (1).
In particular we have a long exact sequence of {\v C}ech cohomology
groups for any open covering $\mathcal{U} \in \text{Cov}$.
This implies that $\mathcal{Q}$ is also an $\mathcal{O}_X$-module
with vanishing higher {\v C}ech cohomology for all
$\mathcal{U} \in \text{Cov}$.

\medskip\noindent
Next, we look at the long exact cohomology sequence
$$
\xymatrix{
0 \ar[r] &
H^0(U, \mathcal{F}) \ar[r] &
H^0(U, \mathcal{I}) \ar[r] &
H^0(U, \mathcal{Q}) \ar[lld] \\
&
H^1(U, \mathcal{F}) \ar[r] &
H^1(U, \mathcal{I}) \ar[r] &
H^1(U, \mathcal{Q}) \ar[lld] \\
&
\ldots & \ldots & \ldots \\
}
$$
for any $U \in \mathcal{B}$. Since $\mathcal{I}$ is injective we
have $H^n(U, \mathcal{I}) = 0$ for $n > 0$ (see
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}).
By the above we see that $H^0(U, \mathcal{I}) \to H^0(U, \mathcal{Q})$
is surjective and hence $H^1(U, \mathcal{F}) = 0$.
Since $\mathcal{F}$ was an arbitrary $\mathcal{O}_X$-module with
vanishing higher {\v C}ech cohomology for all $\mathcal{U} \in \text{Cov}$
we conclude that also $H^1(U, \mathcal{Q}) = 0$ since $\mathcal{Q}$ is
another of these sheaves (see above). By the long exact sequence this in
turn implies that $H^2(U, \mathcal{F}) = 0$. And so on and so forth.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-injective}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{I}$ be an injective $\mathcal{O}_X$-module.
Then
\begin{enumerate}
\item $\check{H}^p(\mathcal{V}, f_*\mathcal{I}) = 0$
for all $p > 0$ and any open covering
$\mathcal{V} : V = \bigcup_{j \in J} V_j$ of $Y$.
\item $H^p(V, f_*\mathcal{I}) = 0$ for all $p > 0$ and
every open $V \subset Y$.
\end{enumerate}
In other words, $f_*\mathcal{I}$ is right acyclic for $\Gamma(U, -)$
(see
Derived Categories, Definition \ref{derived-definition-derived-functor})
for any $U \subset X$ open.
\end{lemma}

\begin{proof}
Set $\mathcal{U} : f^{-1}(V) = \bigcup_{j \in J} f^{-1}(V_j)$.
It is an open covering of $X$ and
$$
\check{\mathcal{C}}^\bullet(\mathcal{V}, f_*\mathcal{I}) =
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}).
$$
This is true because
$$
f_*\mathcal{I}(V_{j_0 \ldots j_p})
= \mathcal{I}(f^{-1}(V_{j_0 \ldots j_p})) =
\mathcal{I}(f^{-1}(V_{j_0}) \cap \ldots \cap f^{-1}(V_{j_p}))
= \mathcal{I}(U_{j_0 \ldots j_p}).
$$
Thus the first statement of the lemma follows from
Lemma \ref{lemma-injective-trivial-cech}. The second statement
follows from the first and Lemma \ref{lemma-cech-vanish}.
\end{proof}

\noindent
The following lemma implies in particular that
$f_* : \textit{Ab}(X) \to \textit{Ab}(Y)$ transforms injective
abelian sheaves into injective abelian sheaves.

\begin{lemma}
\label{lemma-pushforward-injective-flat}
Let $f : X \to Y$ be a morphism of ringed spaces.
Assume $f$ is flat.
Then $f_*\mathcal{I}$ is an injective $\mathcal{O}_Y$-module
for any injective $\mathcal{O}_X$-module $\mathcal{I}$.
\end{lemma}

\begin{proof}
In this case the functor $f^*$ transforms injections into injections
(Modules, Lemma \ref{modules-lemma-pullback-flat}).
Hence the result follows from
Homology, Lemma \ref{homology-lemma-adjoint-preserve-injectives}.
\end{proof}






\section{Flasque sheaves}
\label{section-flasque}

\noindent
Here is the definition.

\begin{definition}
\label{definition-flasque}
Let $X$ be a topological space. We say a presheaf of sets
$\mathcal{F}$ is {\it flasque} or {\it flabby} if for every
$U \subset V$ open in $X$ the restriction map
$\mathcal{F}(V) \to \mathcal{F}(U)$ is surjective.
\end{definition}

\noindent
We will use this terminology also for abelian sheaves and
sheaves of modules if $X$ is a ringed space.
Clearly it suffices to assume the restriction maps
$\mathcal{F}(X) \to \mathcal{F}(U)$ is surjective for every
open $U \subset X$.

\begin{lemma}
\label{lemma-injective-flasque}
Let $(X, \mathcal{O}_X)$ be a ringed space.
Then any injective $\mathcal{O}_X$-module is flasque.
\end{lemma}

\begin{proof}
This is a reformulation of Lemma \ref{lemma-injective-restriction-surjective}.
\end{proof}

\begin{lemma}
\label{lemma-flasque-acyclic}
Let $(X, \mathcal{O}_X)$ be a ringed space. Any flasque $\mathcal{O}_X$-module
is acyclic for $R\Gamma(X, -)$ as well as $R\Gamma(U, -)$ for any
open $U$ of $X$.
\end{lemma}

\begin{proof}
We will prove this using
Derived Categories, Lemma \ref{derived-lemma-subcategory-right-acyclics}.
Since every injective module is flasque we see that we can embed
every $\mathcal{O}_X$-module into a flasque module, see
Injectives, Lemma \ref{injectives-lemma-abelian-sheaves-space}.
Thus it suffices to show that given a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0
$$
with $\mathcal{F}$, $\mathcal{G}$ flasque, then $\mathcal{H}$
is flasque and the sequence remains short exact after taking sections
on any open of $X$. In fact, the second statement implies the first.
Thus, let $U \subset X$ be an open subspace. Let $s \in \mathcal{H}(U)$.
We will show that we can lift $s$ to a sequence of $\mathcal{G}$
over $U$. To do this consider the set $T$ of pairs $(V, t)$
where $V \subset U$ is open and $t \in \mathcal{G}(V)$ is a section
mapping to $s|_V$ in $\mathcal{H}$.
We put a partial ordering on $T$ by setting
$(V, t) \leq (V', t')$ if and only if $V \subset V'$ and $t'|_V = t$.
If $(V_\alpha, t_\alpha)$, $\alpha \in A$
is a totally ordered subset of $T$, then $V = \bigcup V_\alpha$
is open and there is a unique section $t \in \mathcal{G}(V)$
restricting to $t_\alpha$ over $V_\alpha$ by the sheaf condition on
$\mathcal{G}$. Thus by Zorn's lemma there exists a maximal element
$(V, t)$ in $T$. We will show that $V = U$ thereby finishing the proof.
Namely, pick any $x \in U$. We can find a small open neighbourhood
$W \subset U$ of $x$ and $t' \in \mathcal{G}(W)$ mapping to $s|_W$
in $\mathcal{H}$. Then $t'|_{W \cap V} - t|_{W \cap V}$ maps to
zero in $\mathcal{H}$, hence comes from some section
$r' \in \mathcal{F}(W \cap V)$. Using that $\mathcal{F}$ is flasque
we find a section $r \in \mathcal{F}(W)$ restricting to $r'$
over $W \cap V$. Modifying $t'$ by the image of $r$ we may
assume that $t$ and $t'$ restrict to the same section over
$W \cap V$. By the sheaf condition of $\mathcal{G}$
we can find a section $\tilde t$ of $\mathcal{G}$ over
$W \cup V$ restricting to $t$ and $t'$.
By maximality of $(V, t)$ we see that $V \cap W = V$.
Thus $x \in V$ and we are done.
\end{proof}

\noindent
The following lemma does not hold for flasque presheaves.

\begin{lemma}
\label{lemma-flasque-acyclic-cech}
Let $(X, \mathcal{O}_X)$ be a ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
Let $\mathcal{U} : U = \bigcup U_i$ be an open covering.
If $\mathcal{F}$ is flasque, then
$\check{H}^p(\mathcal{U}, \mathcal{F}) = 0$ for $p > 0$.
\end{lemma}

\begin{proof}
The presheaves $\underline{H}^q(\mathcal{F})$ used in the statement
of Lemma \ref{lemma-cech-spectral-sequence} are zero by
Lemma \ref{lemma-flasque-acyclic}.
Hence $\check{H}^p(U, \mathcal{F}) = H^p(U, \mathcal{F}) = 0$
by Lemma \ref{lemma-flasque-acyclic} again.
\end{proof}

\begin{lemma}
\label{lemma-flasque-acyclic-pushforward}
Let $(X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism
of ringed spaces. Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
If $\mathcal{F}$ is flasque, then
$R^pf_*\mathcal{F} = 0$ for $p > 0$.
\end{lemma}

\begin{proof}
Immediate from 
Lemma \ref{lemma-describe-higher-direct-images} and
Lemma \ref{lemma-flasque-acyclic}.
\end{proof}

\noindent
The following lemma can be proved by an elementary induction
argument for finite coverings, compare with the discussion
of {\v C}ech cohomology in \cite{FOAG}.

\begin{lemma}
\label{lemma-vanishing-ravi}
Let $X$ be a topological space. Let $\mathcal{F}$ be an abelian sheaf
on $X$. Let $\mathcal{U} : U = \bigcup_{i \in I} U_i$ be an
open covering. Assume the restriction mappings
$\mathcal{F}(U) \to \mathcal{F}(U')$ are surjective
for $U'$ an arbitrary union of opens of the form $U_{i_0 \ldots i_p}$.
Then $\check{H}^p(\mathcal{U}, \mathcal{F})$
vanishes for $p > 0$.
\end{lemma}

\begin{proof}
Let $Y$ be the set of nonempty subsets of $I$. We will use the letters
$A, B, C, \ldots$ to denote elements of $Y$, i.e., nonempty subsets of $I$.
For a finite nonempty subset $J \subset I$ let
$$
V_J = \{A \in Y \mid J \subset A\}
$$
This means that $V_{\{i\}} = \{A \in Y \mid i \in A\}$ and
$V_J = \bigcap_{j \in J} V_{\{j\}}$.
Then $V_J \subset V_K$ if and only if $J \supset K$.
There is a unique topology on $Y$ such that the collection of
subsets $V_J$ is a basis for the topology on $Y$. Any open is of the form
$$
V = \bigcup\nolimits_{t \in T} V_{J_t}
$$
for some family of finite subsets $J_t$. If $J_t \subset J_{t'}$
then we may remove $J_{t'}$ from the family without changing $V$.
Thus we may assume there are no inclusions among the $J_t$.
In this case the minimal elements of $V$ are the sets $A = J_t$.
Hence we can read off the family $(J_t)_{t \in T}$ from the open $V$.

\medskip\noindent
We can completely understand open coverings in $Y$. First, because
the elements $A \in Y$ are nonempty subsets of $I$ we have
$$
Y = \bigcup\nolimits_{i \in I} V_{\{i\}}
$$
To understand other coverings, let $V$ be as above and let $V_s \subset Y$
be an open corresponding to the family $(J_{s, t})_{t \in T_s}$. Then
$$
V = \bigcup\nolimits_{s \in S} V_s
$$
if and only if for each $t \in T$ there exists an $s \in S$ and
$t_s \in T_s$ such that $J_t = J_{s, t_s}$. Namely, as the family
$(J_t)_{t \in T}$ is minimal, the minimal element $A = J_t$
has to be in $V_s$ for some $s$, hence $A \in V_{J_{t_s}}$ for some
$t_s \in T_s$. But since $A$ is also minimal in $V_s$ we conclude
that $J_{t_s} = J_t$.

\medskip\noindent
Next we map the set of opens of $Y$ to opens of $X$. Namely, we send
$Y$ to $U$, we use the rule
$$
V_J \mapsto U_J = \bigcap\nolimits_{i \in J} U_i
$$
on the opens $V_J$, and we extend it to arbitrary opens $V$ by the rule
$$
V = \bigcup\nolimits_{t \in T} V_{J_t}
\mapsto
\bigcup\nolimits_{t \in T} U_{J_t}
$$
The classification of open coverings of $Y$ given above shows that
this rule transforms open coverings into open coverings. Thus we obtain
an abelian sheaf $\mathcal{G}$ on $Y$ by setting
$\mathcal{G}(Y) = \mathcal{F}(U)$ and for
$V = \bigcup\nolimits_{t \in T} V_{J_t}$ setting
$$
\mathcal{G}(V) = \mathcal{F}\left(\bigcup\nolimits_{t \in T} U_{J_t}\right)
$$
and using the restriction maps of $\mathcal{F}$.

\medskip\noindent
With these preliminaries out of the way we can prove our lemma as follows.
We have an open covering
$\mathcal{V} : Y = \bigcup_{i \in I} V_{\{i\}}$ of $Y$.
By construction we have an equality
$$
\check{C}^\bullet(\mathcal{V}, \mathcal{G}) =
\check{C}^\bullet(\mathcal{U}, \mathcal{F})
$$
of {\v C}ech complexes. Since the sheaf $\mathcal{G}$ is flasque on $Y$
(by our assumption on $\mathcal{F}$ in the statement of the lemma)
the vanishing follows from
Lemma \ref{lemma-flasque-acyclic-cech}.
\end{proof}




\section{The Leray spectral sequence}
\label{section-Leray}

\begin{lemma}
\label{lemma-before-Leray}
Let $f : X \to Y$ be a morphism of ringed spaces.
There is a commutative diagram
$$
\xymatrix{
D^{+}(X) \ar[rr]_-{R\Gamma(X, -)} \ar[d]_{Rf_*} & &
D^{+}(\mathcal{O}_X(X)) \ar[d]^{\text{restriction}} \\
D^{+}(Y) \ar[rr]^-{R\Gamma(Y, -)} & &
D^{+}(\mathcal{O}_Y(Y))
}
$$
More generally for any $V \subset Y$ open and $U = f^{-1}(V)$ there
is a commutative diagram
$$
\xymatrix{
D^{+}(X) \ar[rr]_-{R\Gamma(U, -)} \ar[d]_{Rf_*} & &
D^{+}(\mathcal{O}_X(U)) \ar[d]^{\text{restriction}} \\
D^{+}(Y) \ar[rr]^-{R\Gamma(V, -)} & &
D^{+}(\mathcal{O}_Y(V))
}
$$
See also Remark \ref{remark-elucidate-lemma} for more explanation.
\end{lemma}

\begin{proof}
Let
$\Gamma_{res} : \textit{Mod}(\mathcal{O}_X) \to \text{Mod}_{\mathcal{O}_Y(Y)}$
be the functor which associates to an $\mathcal{O}_X$-module $\mathcal{F}$
the global sections of $\mathcal{F}$ viewed as a $\mathcal{O}_Y(Y)$-module
via the map $f^\sharp : \mathcal{O}_Y(Y) \to \mathcal{O}_X(X)$. Let
$restriction : \text{Mod}_{\mathcal{O}_X(X)} \to \text{Mod}_{\mathcal{O}_Y(Y)}$
be the restriction functor induced by
$f^\sharp : \mathcal{O}_Y(Y) \to \mathcal{O}_X(X)$. Note that $restriction$
is exact so that
its right derived functor is computed by simply applying the restriction
functor, see
Derived Categories, Lemma \ref{derived-lemma-right-derived-exact-functor}.
It is clear that
$$
\Gamma_{res}
=
restriction \circ \Gamma(X, -)
=
\Gamma(Y, -) \circ f_*
$$
We claim that
Derived Categories, Lemma \ref{derived-lemma-compose-derived-functors}
applies to both compositions. For the first this is clear by our remarks
above. For the second, it follows from
Lemma \ref{lemma-pushforward-injective} which implies that
injective $\mathcal{O}_X$-modules are mapped to $\Gamma(Y, -)$-acyclic
sheaves on $Y$.
\end{proof}

\begin{remark}
\label{remark-elucidate-lemma}
Here is a down-to-earth explanation of the meaning of
Lemma \ref{lemma-before-Leray}. It says that given
$f : X \to Y$ and $\mathcal{F} \in \textit{Mod}(\mathcal{O}_X)$
and given an injective resolution $\mathcal{F} \to \mathcal{I}^\bullet$
we have
$$
\begin{matrix}
R\Gamma(X, \mathcal{F}) & \text{is represented by} &
\Gamma(X, \mathcal{I}^\bullet) \\
Rf_*\mathcal{F} & \text{is represented by} & f_*\mathcal{I}^\bullet \\
R\Gamma(Y, Rf_*\mathcal{F}) & \text{is represented by} &
\Gamma(Y, f_*\mathcal{I}^\bullet)
\end{matrix}
$$
the last fact coming from Leray's acyclicity lemma
(Derived Categories, Lemma \ref{derived-lemma-leray-acyclicity})
and Lemma \ref{lemma-pushforward-injective}.
Finally, it combines this with the trivial observation that
$$
\Gamma(X, \mathcal{I}^\bullet)
=
\Gamma(Y, f_*\mathcal{I}^\bullet).
$$
to arrive at the commutativity of the diagram of the lemma.
\end{remark}

\begin{lemma}
\label{lemma-modules-abelian}
Let $X$ be a ringed space.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
\begin{enumerate}
\item The cohomology groups $H^i(U, \mathcal{F})$ for $U \subset X$ open
of $\mathcal{F}$ computed as an $\mathcal{O}_X$-module, or computed as an
abelian sheaf are identical.
\item Let $f : X \to Y$ be a morphism of ringed spaces.
The higher direct images $R^if_*\mathcal{F}$ of $\mathcal{F}$
computed as an $\mathcal{O}_X$-module, or computed as an abelian sheaf
are identical.
\end{enumerate}
There are similar statements in the case of bounded below
complexes of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
Consider the morphism of ringed spaces
$(X, \mathcal{O}_X) \to (X, \underline{\mathbf{Z}}_X)$ given
by the identity on the underlying topological space and by
the unique map of sheaves of rings
$\underline{\mathbf{Z}}_X \to \mathcal{O}_X$.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Denote $\mathcal{F}_{ab}$ the same sheaf seen as an
$\underline{\mathbf{Z}}_X$-module, i.e., seen as a sheaf of
abelian groups. Let
$\mathcal{F} \to \mathcal{I}^\bullet$ be an injective resolution.
By Remark \ref{remark-elucidate-lemma} we see that
$\Gamma(X, \mathcal{I}^\bullet)$ computes both
$R\Gamma(X, \mathcal{F})$ and $R\Gamma(X, \mathcal{F}_{ab})$.
This proves (1).

\medskip\noindent
To prove (2) we use (1) and Lemma \ref{lemma-describe-higher-direct-images}.
The result follows immediately.
\end{proof}

\begin{lemma}[Leray spectral sequence]
\label{lemma-Leray}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{F}^\bullet$ be
a bounded below complex of $\mathcal{O}_X$-modules.
There is a spectral sequence
$$
E_2^{p, q} = H^p(Y, R^qf_*(\mathcal{F}^\bullet))
$$
converging to $H^{p + q}(X, \mathcal{F}^\bullet)$.
\end{lemma}

\begin{proof}
This is just the Grothendieck spectral sequence
Derived Categories, Lemma \ref{derived-lemma-grothendieck-spectral-sequence}
coming from the composition of functors
$\Gamma_{res} = \Gamma(Y, -) \circ f_*$ where $\Gamma_{res}$ is as
in the proof of Lemma \ref{lemma-before-Leray}.
To see that the assumptions of
Derived Categories, Lemma \ref{derived-lemma-grothendieck-spectral-sequence}
are satisfied, see the proof of Lemma \ref{lemma-before-Leray} or
Remark \ref{remark-elucidate-lemma}.
\end{proof}

\begin{remark}
\label{remark-Leray-ss-more-structure}
The Leray spectral sequence, the way we proved it in Lemma \ref{lemma-Leray}
is a spectral sequence of $\Gamma(Y, \mathcal{O}_Y)$-modules. However, it
is quite easy to see that it is in fact a spectral sequence of
$\Gamma(X, \mathcal{O}_X)$-modules. For example $f$ gives rise to
a morphism of ringed spaces
$f' :  (X, \mathcal{O}_X) \to (Y, f_*\mathcal{O}_X)$.
By Lemma \ref{lemma-modules-abelian} the terms $E_r^{p, q}$ of the
Leray spectral sequence for an $\mathcal{O}_X$-module $\mathcal{F}$
and $f$ are identical with those for $\mathcal{F}$ and $f'$
at least for $r \geq 2$. Namely, they both agree with the terms of the Leray
spectral sequence for $\mathcal{F}$ as an abelian sheaf.
And since $(f_*\mathcal{O}_X)(Y) = \mathcal{O}_X(X)$ we see the result.
It is often the case
that the Leray spectral sequence carries additional structure.
\end{remark}

\begin{lemma}
\label{lemma-apply-Leray}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
\begin{enumerate}
\item If $R^qf_*\mathcal{F} = 0$ for $q > 0$, then
$H^p(X, \mathcal{F}) = H^p(Y, f_*\mathcal{F})$ for all $p$.
\item If $H^p(Y, R^qf_*\mathcal{F}) = 0$ for all $q$ and $p > 0$, then
$H^q(X, \mathcal{F}) = H^0(Y, R^qf_*\mathcal{F})$ for all $q$.
\end{enumerate}
\end{lemma}

\begin{proof}
These are two simple conditions that force the Leray spectral sequence to
degenerate at $E_2$. You can also prove these facts directly (without using
the spectral sequence) which is a good exercise in cohomology of sheaves.
\end{proof}

\begin{lemma}
\label{lemma-higher-direct-images-compose}
\begin{slogan}
The total derived functor of a composition is the
composition of the total derived functors.
\end{slogan}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of ringed spaces.
In this case $Rg_* \circ Rf_* = R(g \circ f)_*$ as functors
from $D^{+}(X) \to D^{+}(Z)$.
\end{lemma}

\begin{proof}
We are going to apply
Derived Categories, Lemma \ref{derived-lemma-compose-derived-functors}.
It is clear that $g_* \circ f_* = (g \circ f)_*$, see
Sheaves, Lemma \ref{sheaves-lemma-pushforward-composition}.
It remains to show that $f_*\mathcal{I}$ is $g_*$-acyclic.
This follows from Lemma \ref{lemma-pushforward-injective}
and the description of the
higher direct images $R^ig_*$ in
Lemma \ref{lemma-describe-higher-direct-images}.
\end{proof}

\begin{lemma}[Relative Leray spectral sequence]
\label{lemma-relative-Leray}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of ringed spaces.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
There is a spectral sequence with
$$
E_2^{p, q} = R^pg_*(R^qf_*\mathcal{F})
$$
converging to $R^{p + q}(g \circ f)_*\mathcal{F}$.
This spectral sequence is functorial in $\mathcal{F}$, and there
is a version for bounded below complexes of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
This is a Grothendieck spectral sequence for composition of functors
and follows from Lemma \ref{lemma-higher-direct-images-compose} and
Derived Categories, Lemma \ref{derived-lemma-grothendieck-spectral-sequence}.
\end{proof}














\section{Functoriality of cohomology}
\label{section-functoriality}

\begin{lemma}
\label{lemma-functoriality}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{G}^\bullet$, resp.\ $\mathcal{F}^\bullet$ be
a bounded below complex of $\mathcal{O}_Y$-modules,
resp.\ $\mathcal{O}_X$-modules. Let
$\varphi : \mathcal{G}^\bullet \to f_*\mathcal{F}^\bullet$
be a morphism of complexes. There is a canonical morphism
$$
\mathcal{G}^\bullet
\longrightarrow
Rf_*(\mathcal{F}^\bullet)
$$
in $D^{+}(Y)$. Moreover this construction is functorial in the triple
$(\mathcal{G}^\bullet, \mathcal{F}^\bullet, \varphi)$.
\end{lemma}

\begin{proof}
Choose an injective resolution $\mathcal{F}^\bullet \to \mathcal{I}^\bullet$.
By definition $Rf_*(\mathcal{F}^\bullet)$ is represented by
$f_*\mathcal{I}^\bullet$ in $K^{+}(\mathcal{O}_Y)$.
The composition
$$
\mathcal{G}^\bullet \to f_*\mathcal{F}^\bullet \to f_*\mathcal{I}^\bullet
$$
is a morphism in $K^{+}(Y)$ which turns
into the morphism of the lemma upon applying the
localization functor $j_Y : K^{+}(Y) \to D^{+}(Y)$.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{G}$ be an $\mathcal{O}_Y$-module and let
$\mathcal{F}$ be an $\mathcal{O}_X$-module. Recall that an
$f$-map $\varphi$ from $\mathcal{G}$ to $\mathcal{F}$ is a map
$\varphi : \mathcal{G} \to f_*\mathcal{F}$, or what is the same
thing, a map $\varphi : f^*\mathcal{G} \to \mathcal{F}$.
See Sheaves, Definition \ref{sheaves-definition-f-map}.
Such an $f$-map gives rise to a morphism of complexes
\begin{equation}
\label{equation-functorial-derived}
\varphi :
R\Gamma(Y, \mathcal{G})
\longrightarrow
R\Gamma(X, \mathcal{F})
\end{equation}
in $D^{+}(\mathcal{O}_Y(Y))$. Namely, we use the morphism
$\mathcal{G} \to Rf_*\mathcal{F}$ in $D^{+}(Y)$ of
Lemma \ref{lemma-functoriality}, and we apply $R\Gamma(Y, -)$.
By Lemma \ref{lemma-before-Leray} we see that
$R\Gamma(X, \mathcal{F}) = R\Gamma(Y, Rf_*\mathcal{F})$
and we get the displayed arrow. We spell this out completely in
Remark \ref{remark-explain-arrow} below.
In particular it gives
rise to maps on cohomology
\begin{equation}
\label{equation-functorial}
\varphi : H^i(Y, \mathcal{G}) \longrightarrow H^i(X, \mathcal{F}).
\end{equation}

\begin{remark}
\label{remark-explain-arrow}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\mathcal{G}$ be an $\mathcal{O}_Y$-module.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Let $\varphi$ be an $f$-map from $\mathcal{G}$ to $\mathcal{F}$.
Choose a resolution $\mathcal{F} \to \mathcal{I}^\bullet$
by a complex of injective $\mathcal{O}_X$-modules.
Choose resolutions $\mathcal{G} \to \mathcal{J}^\bullet$ and
$f_*\mathcal{I}^\bullet \to (\mathcal{J}')^\bullet$ by complexes
of injective $\mathcal{O}_Y$-modules. By
Derived Categories, Lemma \ref{derived-lemma-morphisms-lift}
there exists a map of complexes
$\beta$ such that the diagram
\begin{equation}
\label{equation-choice}
\xymatrix{
\mathcal{G} \ar[d] \ar[r] &
f_*\mathcal{F} \ar[r] &
f_*\mathcal{I}^\bullet \ar[d] \\
\mathcal{J}^\bullet \ar[rr]^\beta & &
(\mathcal{J}')^\bullet
}
\end{equation}
commutes. Applying global section functors we see
that we get a diagram
$$
\xymatrix{
 & & \Gamma(Y, f_*\mathcal{I}^\bullet) \ar[d]_{qis} \ar@{=}[r] &
\Gamma(X, \mathcal{I}^\bullet) \\
\Gamma(Y, \mathcal{J}^\bullet) \ar[rr]^\beta & &
\Gamma(Y, (\mathcal{J}')^\bullet) &
}
$$
The complex on the bottom left represents $R\Gamma(Y, \mathcal{G})$
and the complex on the top right represents $R\Gamma(X, \mathcal{F})$.
The vertical arrow is a quasi-isomorphism by
Lemma \ref{lemma-before-Leray} which becomes invertible after
applying the localization functor
$K^{+}(\mathcal{O}_Y(Y)) \to D^{+}(\mathcal{O}_Y(Y))$.
The arrow (\ref{equation-functorial-derived}) is given by the
composition of the horizontal map by the inverse of the vertical map.
\end{remark}





\section{Refinements and {\v C}ech cohomology}
\label{section-refinements-cech}

\noindent
Let $(X, \mathcal{O}_X)$ be a ringed space. Let
$\mathcal{U} : X = \bigcup_{i \in I} U_i$ and
$\mathcal{V} : X = \bigcup_{j \in J} V_j$ be open coverings.
Assume that $\mathcal{U}$ is a refinement of $\mathcal{V}$.
Choose a map $c : I \to J$ such that $U_i \subset V_{c(i)}$
for all $i \in I$. This induces a map of {\v C}ech complexes
$$
\gamma :
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{F})
\longrightarrow
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}),
\quad
(\xi_{j_0 \ldots j_p})
\longmapsto
(\xi_{c(i_0) \ldots c(i_p)}|_{U_{i_0 \ldots i_p}})
$$
functorial in the sheaf of $\mathcal{O}_X$-modules $\mathcal{F}$.
Suppose that $c' : I \to J$ is a second map such that
$U_i \subset V_{c'(i)}$ for all $i \in I$. Then the corresponding maps
$\gamma$ and $\gamma'$ are homotopic. Namely,
$\gamma - \gamma' = \text{d} \circ h + h \circ \text{d}$
with
$h : \check{\mathcal{C}}^{p + 1}(\mathcal{V}, \mathcal{F}) \to
\check{\mathcal{C}}^p(\mathcal{U}, \mathcal{F})$
given by the rule
$$
h(\xi)_{i_0 \ldots i_p} =
\sum\nolimits_{a = 0}^{p}
(-1)^a
\alpha_{c(i_0)\ldots c(i_a) c'(i_a) \ldots c'(i_p)}
$$
We omit the computation showing this works; please see the discussion
following (\ref{equation-transformation}) for the proof in a more general
case. In particular, the map on {\v C}ech cohomology groups is independent
of the choice of $c$. Moreover, it is clear that if
$\mathcal{W} : X = \bigcup_{k \in K} W_k$ is a third open covering
and $\mathcal{V}$ is a refinement of $\mathcal{W}$, then the composition
of the maps
$$
\check{\mathcal{C}}^\bullet(\mathcal{W}, \mathcal{F})
\longrightarrow
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{F})
\longrightarrow
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
$$
associated to maps $I \to J$ and $J \to K$ is the map associated
to the composition $I \to K$.
In particular, we can define the {\v C}ech cohomology
groups
$$
\check{H}^p(X, \mathcal{F}) =
\colim_\mathcal{U} \check{H}^p(\mathcal{U}, \mathcal{F})
$$
where the colimit is over all open coverings of $X$ preordered by refinement.

\medskip\noindent
It turns out that the maps $\gamma$ defined above are compatible with
the map to cohomology, in other words, the composition
$$
\check{H}^p(\mathcal{V}, \mathcal{F}) \to
\check{H}^p(\mathcal{U}, \mathcal{F})
\xrightarrow{\text{Lemma \ref{lemma-cech-cohomology}}}
H^p(X, \mathcal{F})
$$
is the canonical map from the first group to cohomology of
Lemma \ref{lemma-cech-cohomology}. 
In the lemma below we will prove this in a slightly more general
setting. A consequence is that we obtain a well defined map
\begin{equation}
\label{equation-cech-to-cohomology}
\check{H}^p(X, \mathcal{F}) =
\colim_\mathcal{U} \check{H}^p(\mathcal{U}, \mathcal{F})
\longrightarrow
H^p(X, \mathcal{F})
\end{equation}
from {\v C}ech cohomology to cohomology.

\begin{lemma}
\label{lemma-functoriality-cech}
Let $f : X \to Y$ be a morphism of ringed spaces.
Let $\varphi : f^*\mathcal{G} \to \mathcal{F}$ be an $f$-map
from an $\mathcal{O}_Y$-module $\mathcal{G}$ to an
$\mathcal{O}_X$-module $\mathcal{F}$.
Let $\mathcal{U} : X = \bigcup_{i \in I} U_i$ and
$\mathcal{V} : Y = \bigcup_{j \in J} V_j$ be open coverings.
Assume that $\mathcal{U}$ is a refinement of
$f^{-1}\mathcal{V} : X = \bigcup_{j \in J} f^{-1}(V_j)$.
In this case there exists a commutative diagram
$$
\xymatrix{
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \ar[r] &
R\Gamma(X, \mathcal{F}) \\
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{G}) \ar[r]
\ar[u]^\gamma &
R\Gamma(Y, \mathcal{G}) \ar[u]
}
$$
in $D^{+}(\mathcal{O}_X(X))$ with horizontal arrows given by
Lemma \ref{lemma-cech-cohomology} and right vertical arrow by
(\ref{equation-functorial-derived}).
In particular we get commutative diagrams of cohomology groups
$$
\xymatrix{
\check{H}^p(\mathcal{U}, \mathcal{F}) \ar[r] &
H^p(X, \mathcal{F}) \\
\check{H}^p(\mathcal{V}, \mathcal{G}) \ar[r]
\ar[u]^\gamma &
H^p(Y, \mathcal{G}) \ar[u]
}
$$
where the right vertical arrow is (\ref{equation-functorial})
\end{lemma}

\begin{proof}
We first define the left vertical arrow. Namely, choose a map
$c : I \to J$ such that $U_i \subset f^{-1}(V_{c(i)})$ for all
$i \in I$. In degree $p$ we define the map by the rule
$$
\gamma(s)_{i_0 \ldots i_p} = \varphi(s)_{c(i_0) \ldots c(i_p)}
$$
This makes sense because $\varphi$ does indeed induce maps
$\mathcal{G}(V_{c(i_0) \ldots c(i_p)}) \to \mathcal{F}(U_{i_0 \ldots i_p})$
by assumption. It is also clear that this defines a morphism of complexes.
Choose injective resolutions
$\mathcal{F} \to \mathcal{I}^\bullet$ on $X$ and
$\mathcal{G} \to J^\bullet$ on $Y$. According to
the proof of Lemma \ref{lemma-cech-cohomology} we introduce the double
complexes $A^{\bullet, \bullet}$ and $B^{\bullet, \bullet}$
with terms
$$
B^{p, q} = \check{\mathcal{C}}^p(\mathcal{V}, \mathcal{J}^q)
\quad
\text{and}
\quad
A^{p, q} = \check{\mathcal{C}}^p(\mathcal{U}, \mathcal{I}^q).
$$
As in Remark \ref{remark-explain-arrow} above we also choose an
injective resolution
$f_*\mathcal{I} \to (\mathcal{J}')^\bullet$ on $Y$ and a morphism
of complexes $\beta : \mathcal{J} \to (\mathcal{J}')^\bullet$
making (\ref{equation-choice}) commutes. We introduce some more
double complexes, namely $(B')^{\bullet, \bullet}$ and
$(B''){\bullet, \bullet}$ with
$$
(B')^{p, q} = \check{\mathcal{C}}^p(\mathcal{V}, (\mathcal{J}')^q)
\quad
\text{and}
\quad
(B'')^{p, q} = \check{\mathcal{C}}^p(\mathcal{V}, f_*\mathcal{I}^q).
$$
Note that there is an $f$-map of complexes from
$f_*\mathcal{I}^\bullet$ to $\mathcal{I}^\bullet$. Hence
it is clear that the same rule as above defines a morphism
of double complexes
$$
\gamma : (B'')^{\bullet, \bullet} \longrightarrow A^{\bullet, \bullet}.
$$
Consider the diagram of complexes
$$
\xymatrix{
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F})
\ar[r] &
sA^\bullet & & &
\Gamma(X, \mathcal{I}^\bullet) \ar[lll]^{qis}
\ar@{=}[ddl]\\
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{G})
\ar[r] \ar[u]^\gamma &
sB^\bullet \ar[r]^\beta &
s(B')^\bullet &
s(B'')^\bullet \ar[l] \ar[llu]_{s\gamma} \\
& \Gamma(Y, \mathcal{J}^\bullet) \ar[u]^{qis} \ar[r]^\beta &
\Gamma(Y, (\mathcal{J}')^\bullet) \ar[u] &
\Gamma(Y, f_*\mathcal{I}^\bullet) \ar[u] \ar[l]_{qis}
}
$$
The two horizontal arrows with targets $sA^\bullet$ and
$sB^\bullet$ are the ones explained in Lemma \ref{lemma-cech-cohomology}.
The left upper shape (a pentagon) is commutative simply
because (\ref{equation-choice}) is commutative.
The two lower squares are trivially commutative.
It is also immediate from the definitions that the
right upper shape (a square) is commutative.
The result of the lemma now follows from the definitions
and the fact that going around the diagram on the outer sides
from $\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{G})$
to $\Gamma(X, \mathcal{I}^\bullet)$ either on top or on bottom
is the same (where you have to invert any quasi-isomorphisms along the way).
\end{proof}





\section{Cohomology on Hausdorff quasi-compact spaces}
\label{section-cohomology-LC}

\noindent
For such a space {\v C}ech cohomology agrees with cohomology.

\begin{lemma}
\label{lemma-cech-always}
Let $X$ be a topological space. Let $\mathcal{F}$ be an abelian sheaf. Then
the map $\check{H}^1(X, \mathcal{F}) \to H^1(X, \mathcal{F})$ defined
in (\ref{equation-cech-to-cohomology}) is an isomorphism.
\end{lemma}

\begin{proof}
Let $\mathcal{U}$ be an open covering of $X$.
By Lemma \ref{lemma-cech-spectral-sequence}
there is an exact sequence
$$
0 \to \check{H}^1(\mathcal{U}, \mathcal{F}) \to H^1(X, \mathcal{F})
\to \check{H}^0(\mathcal{U}, \underline{H}^1(\mathcal{F}))
$$
Thus the map is injective. To show surjectivity it suffices to show that
any element of $\check{H}^0(\mathcal{U}, \underline{H}^1(\mathcal{F}))$
maps to zero after replacing $\mathcal{U}$ by a refinement.
This is immediate from the definitions and the fact that
$\underline{H}^1(\mathcal{F})$ is a presheaf of abelian groups
whose sheafification is zero by locality of cohomology, see
Lemma \ref{lemma-kill-cohomology-class-on-covering}.
\end{proof}

\begin{lemma}
\label{lemma-cech-Hausdorff-quasi-compact}
Let $X$ be a Hausdorff and quasi-compact topological space. Let
$\mathcal{F}$ be an abelian sheaf on $X$. Then
the map $\check{H}^n(X, \mathcal{F}) \to H^n(X, \mathcal{F})$ defined
in (\ref{equation-cech-to-cohomology}) is an isomorphism for
all $n$.
\end{lemma}

\begin{proof}
We already know that $\check{H}^n(X, -) \to H^p(X, -)$
is an isomorphism of functors for $n = 0, 1$, see
Lemma \ref{lemma-cech-always}.
The functors $H^n(X, -)$ form a universal $\delta$-functor, see
Derived Categories, Lemma \ref{derived-lemma-higher-derived-functors}.
If we show that $\check{H}^n(X, -)$ forms a universal $\delta$-functor
and that $\check{H}^n(X, -) \to H^n(X, -)$ is compatible with boundary
maps, then the map will automatically be an isomorphism by uniqueness
of universal $\delta$-functors, see
Homology, Lemma \ref{homology-lemma-uniqueness-universal-delta-functor}.

\medskip\noindent
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of abelian sheaves on $X$.
Let $\mathcal{U} : X = \bigcup_{i \in I} U_i$ be an open covering.
This gives a complex of complexes
$$
0 \to \check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \to
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{G}) \to
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{H}) \to 0
$$
which is in general not exact on the right. The sequence defines
the maps
$$
\check{H}^n(\mathcal{U}, \mathcal{F}) \to
\check{H}^n(\mathcal{U}, \mathcal{G}) \to
\check{H}^n(\mathcal{U}, \mathcal{H})
$$
but isn't good enough to define a boundary operator
$\delta : \check{H}^n(\mathcal{U}, \mathcal{H}) \to
\check{H}^{n + 1}(\mathcal{U}, \mathcal{F})$. Indeed
such a thing will not exist in general. However, given an
element $\overline{h} \in \check{H}^n(\mathcal{U}, \mathcal{H})$
which is the cohomology class of a cocycle
$h = (h_{i_0 \ldots i_n})$
we can choose open coverings
$$
U_{i_0 \ldots i_n} = \bigcup W_{i_0 \ldots i_n, k}
$$
such that $h_{i_0 \ldots i_n}|_{W_{i_0 \ldots i_n, k}}$
lifts to a section of $\mathcal{G}$ over $W_{i_0 \ldots i_n, k}$.
By Topology, Lemma \ref{topology-lemma-refine-covering}
we can choose an open covering $\mathcal{V} : X = \bigcup_{j \in J} V_j$
and $\alpha : J \to I$ such that $V_j \subset U_{\alpha(j)}$
(it is a refinement) and such that for all $j_0, \ldots, j_n \in J$
there is a $k$ such that
$V_{j_0 \ldots j_n} \subset W_{\alpha(j_0) \ldots \alpha(j_n), k}$.
We obtain maps of complexes
$$
\xymatrix{
0 \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \ar[d] \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{G}) \ar[d] \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{H}) \ar[d] \ar[r] &
0 \\
0 \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{F}) \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{G}) \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{H}) \ar[r] &
0
}
$$
In fact, the vertical arrows are the maps of complexes used
to define the transition maps between the {\v C}ech cohomology groups.
Our choice of refinement shows that we may choose
$$
g_{j_0 \ldots j_n} \in
\mathcal{G}(V_{j_0 \ldots j_n}),\quad
g_{j_0 \ldots j_n} \longmapsto
h_{\alpha(j_0) \ldots \alpha(j_n)}|_{V_{j_0 \ldots j_n}}
$$
The cochain $g = (g_{j_0 \ldots j_n})$ is not a cocycle
in general but we know that its {\v C}ech boundary $\text{d}(g)$
maps to zero in $\check{\mathcal{C}}^{n + 1}(\mathcal{V}, \mathcal{H})$
(by the commutative diagram above and the fact that $h$ is a cocycle).
Hence $\text{d}(g)$ is a cocycle in
$\check{\mathcal{C}}^\bullet(\mathcal{V}, \mathcal{F})$.
This allows us to define
$$
\delta(\overline{h}) = \text{class of }\text{d}(g)\text{ in }
\check{H}^{n + 1}(\mathcal{V}, \mathcal{F})
$$
Now, given an element $\xi \in \check{H}^n(X, \mathcal{G})$
we choose an open covering $\mathcal{U}$ and an element
$\overline{h} \in \check{H}^n(\mathcal{U}, \mathcal{G})$
mapping to $\xi$ in the colimit defining {\v C}ech cohomology.
Then we choose $\mathcal{V}$ and $g$ as above and set
$\delta(\xi)$ equal to the image of $\delta(\overline{h})$
in $\check{H}^n(X, \mathcal{F})$.
At this point a lot of properties have to be checked, all of which
are straightforward. For example, we need to check that our construction
is independent of the choice of
$\mathcal{U}, \overline{h}, \mathcal{V}, \alpha : J \to I, g$.
The class of $\text{d}(g)$ is independent of the choice of the lifts
$g_{i_0 \ldots i_n}$ because the difference will be a coboundary.
Independence of $\alpha$ holds\footnote{This is an important
check because the nonuniqueness of $\alpha$ is the only thing preventing
us from taking the colimit of {\v C}ech complexes over all open
coverings of $X$ to get a short exact sequence of complexes computing
{\v C}ech cohomology.}
because a different choice
of $\alpha$ determines homotopic vertical maps of complexes
in the diagram above, see Section \ref{section-refinements-cech}.
For the other choices we use that given a finite collection
of coverings of $X$ we can always find a covering refining all
of them. We also need to check additivity which is shown in the same manner.
Finally, we need to check that the maps
$\check{H}^n(X, -) \to H^n(X, -)$ are compatible
with boundary maps. To do this we choose injective
resolutions
$$
\xymatrix{
0 \ar[r] &
\mathcal{F} \ar[r] \ar[d] &
\mathcal{G} \ar[r] \ar[d] &
\mathcal{H} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{I}_1^\bullet \ar[r] &
\mathcal{I}_2^\bullet \ar[r] &
\mathcal{I}_3^\bullet \ar[r] &
0
}
$$
as in Derived Categories, Lemma \ref{derived-lemma-injective-resolution-ses}.
This will give a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \ar[r] \ar[d] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \ar[r] \ar[d] &
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{F}) \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\text{Tot}(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}_1^\bullet))
\ar[r] &
\text{Tot}(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}_2^\bullet))
\ar[r] &
\text{Tot}(\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}_3^\bullet))
\ar[r] &
0
}
$$
Here $\mathcal{U}$ is an open covering as above and
the vertical maps are those used to define the maps
$\check{H}^n(\mathcal{U}, -) \to H^n(X, -)$, see
Lemma \ref{lemma-cech-cohomology}.
The bottom complex is exact as the sequence of
complexes of injectives is termwise split exact.
Hence the boundary map in cohomology is computed
by the usual procedure for this lower exact sequence, see
Homology, Lemma \ref{homology-lemma-long-exact-sequence-cochain}.
The same will be true after passing to the refinement
$\mathcal{V}$ where the boundary map for {\v C}ech cohomology
was defined. Hence the boundary maps agree because they
use the same construction (whenever the first one is defined
on an element in {\v C}ech cohomology on a given covering).
This finishes our discussion of the construction of
the structure of a $\delta$-functor on {\v C}ech cohomology
and why this structure is compatible with the given
$\delta$-functor structure on usual cohomology.

\medskip\noindent
Finally, we may apply Lemma \ref{lemma-injective-trivial-cech}
to see that higher {\v C}ech cohomology is trivial on injective
sheaves. Hence we see that {\v C}ech cohomology is a universal
$\delta$-functor by
Homology, Lemma \ref{homology-lemma-efface-implies-universal}.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-of-closed}
\begin{reference}
\cite[Expose V bis, 4.1.3]{SGA4}
\end{reference}
Let $X$ be a topological space. Let $Z \subset X$ be a quasi-compact subset
such that any two points of $Z$ have disjoint open neighbourhoods in $X$.
For every abelian sheaf $\mathcal{F}$ on $X$ the canonical
map
$$
\colim H^p(U, \mathcal{F})
\longrightarrow
H^p(Z, \mathcal{F}|_Z)
$$
where the colimit is over open neighbourhoods $U$ of $Z$ in $X$
is an isomorphism.
\end{lemma}

\begin{proof}
We first prove this for $p = 0$. Injectivity follows from
the definition of $\mathcal{F}|_Z$ and holds in general
(for any subset of any topological space $X$). Next, suppose that
$s \in H^0(Z, \mathcal{F}|_Z)$. Then we can find opens $U_i \subset X$
such that $Z \subset \bigcup U_i$ and such that $s|_{Z \cap U_i}$
comes from $s_i \in \mathcal{F}(U_i)$. It follows that
there exist opens $W_{ij} \subset U_i \cap U_j$ with
$W_{ij} \cap Z = U_i \cap U_j \cap Z$ such that
$s_i|_{W_{ij}} = s_j|_{W_{ij}}$. Applying
Topology, Lemma
\ref{topology-lemma-lift-covering-of-quasi-compact-hausdorff-subset}
we find opens $V_i$ of $X$ such that $V_i \subset U_i$ and
such that $V_i \cap V_j \subset W_{ij}$. Hence we see that
$s_i|_{V_i}$ glue to a section of $\mathcal{F}$ over the
open neighbourhood $\bigcup V_i$ of $Z$.

\medskip\noindent
To finish the proof, it suffices to show that if $\mathcal{I}$ is an
injective abelian sheaf on $X$, then $H^p(Z, \mathcal{I}|_Z) = 0$
for $p > 0$. This follows using short exact sequences and dimension
shifting; details omitted. Thus, suppose $\overline{\xi}$ is an element
of $H^p(Z, \mathcal{I}|_Z)$ for some $p > 0$.
By Lemma \ref{lemma-cech-Hausdorff-quasi-compact}
the element $\overline{\xi}$ comes from
$\check{H}^p(\mathcal{V}, \mathcal{I}|_Z)$
for some open covering $\mathcal{V} : Z = \bigcup V_i$ of $Z$.
Say $\overline{\xi}$ is the image of the class of a cocycle
$\xi = (\xi_{i_0 \ldots i_p})$ in
$\check{\mathcal{C}}^p(\mathcal{V}, \mathcal{I}|_Z)$.

\medskip\noindent
Let $\mathcal{I}' \subset \mathcal{I}|_Z$ be the subpresheaf
defined by the rule
$$
\mathcal{I}'(V) =
\{s \in \mathcal{I}|_Z(V) \mid
\exists (U, t),\ U \subset X\text{ open},
\ t \in \mathcal{I}(U),\ V = Z \cap U,\ s = t|_{Z \cap U} \}
$$
Then $\mathcal{I}|_Z$ is the sheafification of $\mathcal{I}'$.
Thus for every $(p + 1)$-tuple $i_0 \ldots i_p$ we can find an
open covering $V_{i_0 \ldots i_p} = \bigcup W_{i_0 \ldots i_p, k}$
such that $\xi_{i_0 \ldots i_p}|_{W_{i_0 \ldots i_p, k}}$ is
a section of $\mathcal{I}'$. Applying
Topology, Lemma \ref{topology-lemma-refine-covering}
we may after refining $\mathcal{V}$ assume that each
$\xi_{i_0 \ldots i_p}$ is a section of the presheaf $\mathcal{I}'$.

\medskip\noindent
Write $V_i = Z \cap U_i$ for some opens $U_i \subset X$.
Since $\mathcal{I}$ is flasque (Lemma \ref{lemma-injective-flasque})
and since $\xi_{i_0 \ldots i_p}$ is a section of $\mathcal{I}'$
for every $(p + 1)$-tuple $i_0 \ldots i_p$ we can choose
a section $s_{i_0 \ldots i_p} \in \mathcal{I}(U_{i_0 \ldots i_p})$
which restricts to $\xi_{i_0 \ldots i_p}$ on
$V_{i_0 \ldots i_p} = Z \cap U_{i_0 \ldots i_p}$.
(This appeal to injectives being flasque can be avoided by an
additional application of
Topology, Lemma
\ref{topology-lemma-lift-covering-of-quasi-compact-hausdorff-subset}.)
Let $s = (s_{i_0 \ldots i_p})$ be the corresponding cochain
for the open covering $U = \bigcup U_i$.
Since $\text{d}(\xi) = 0$ we see that the sections
$\text{d}(s)_{i_0 \ldots i_{p + 1}}$ restrict to zero
on $Z \cap U_{i_0 \ldots i_{p + 1}}$. Hence, by the initial
remarks of the proof, there exists open subsets
$W_{i_0 \ldots i_{p + 1}} \subset U_{i_0 \ldots i_{p + 1}}$
with $Z \cap W_{i_0 \ldots i_{p + 1}} = Z \cap U_{i_0 \ldots i_{p + 1}}$
such that $\text{d}(s)_{i_0 \ldots i_{p + 1}}|_{W_{i_0 \ldots i_{p + 1}}} = 0$.
By Topology, Lemma
\ref{topology-lemma-lift-covering-of-quasi-compact-hausdorff-subset}
we can find $U'_i \subset U_i$ such that $Z \subset \bigcup U'_i$
and such that $U'_{i_0 \ldots i_{p + 1}} \subset W_{i_0 \ldots i_{p + 1}}$.
Then $s' = (s'_{i_0 \ldots i_p})$ with
$s'_{i_0 \ldots i_p} = s_{i_0 \ldots i_p}|_{U'_{i_0 \ldots i_p}}$
is a cocycle for $\mathcal{I}$ for the open covering
$U' = \bigcup U'_i$ of an open neighbourhood of $Z$.
Since $\mathcal{I}$ has trivial higher {\v C}ech cohomology groups
(Lemma \ref{lemma-injective-trivial-cech})
we conclude that $s'$ is a coboundary. It follows that the image of
$\xi$ in the {\v C}ech complex for the open covering
$Z = \bigcup Z \cap U'_i$ is a coboundary and we are done.
\end{proof}






\section{The base change map}
\label{section-base-change-map}

\noindent
We will need to know how to construct the base change map in some cases.
Since we have not yet discussed derived pullback we only discuss
this in the case of a base change by a flat morphism of ringed spaces.
Before we state the result, let us discuss flat pullback on the derived
category. Namely, suppose that $g : X \to Y$ is a flat morphism of
ringed spaces. By Modules, Lemma \ref{modules-lemma-pullback-flat}
the functor $g^* : \textit{Mod}(\mathcal{O}_Y) \to
\textit{Mod}(\mathcal{O}_X)$ is exact. Hence it has a derived functor
$$
g^* : D^{+}(Y) \to D^{+}(X)
$$
which is computed by simply pulling back an representative of a given
object in $D^{+}(Y)$, see
Derived Categories, Lemma \ref{derived-lemma-right-derived-exact-functor}.
Hence as indicated we indicate this functor by $g^*$ rather than
$Lg^*$.

\begin{lemma}
\label{lemma-base-change-map-flat-case}
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
be a commutative diagram of ringed spaces.
Let $\mathcal{F}^\bullet$ be a bounded below complex of
$\mathcal{O}_X$-modules.
Assume both $g$ and $g'$ are flat.
Then there exists a canonical base change map
$$
g^*Rf_*\mathcal{F}^\bullet
\longrightarrow
R(f')_*(g')^*\mathcal{F}^\bullet
$$
in $D^{+}(S')$.
\end{lemma}

\begin{proof}
Choose injective resolutions $\mathcal{F}^\bullet \to \mathcal{I}^\bullet$
and $(g')^*\mathcal{F}^\bullet \to \mathcal{J}^\bullet$.
By Lemma \ref{lemma-pushforward-injective-flat} we see that
$(g')_*\mathcal{J}^\bullet$ is a complex of injectives representing
$R(g')_*(g')^*\mathcal{F}^\bullet$. Hence by
Derived Categories, Lemmas \ref{derived-lemma-morphisms-lift}
and \ref{derived-lemma-morphisms-equal-up-to-homotopy}
the arrow $\beta$ in the diagram
$$
\xymatrix{
(g')_*(g')^*\mathcal{F}^\bullet \ar[r] &
(g')_*\mathcal{J}^\bullet \\
\mathcal{F}^\bullet \ar[u]^{adjunction} \ar[r] &
\mathcal{I}^\bullet \ar[u]_\beta
}
$$
exists and is unique up to homotopy.
Pushing down to $S$ we get
$$
f_*\beta :
f_*\mathcal{I}^\bullet
\longrightarrow
f_*(g')_*\mathcal{J}^\bullet
=
g_*(f')_*\mathcal{J}^\bullet
$$
By adjunction of $g^*$ and $g_*$ we get a map of complexes
$g^*f_*\mathcal{I}^\bullet \to (f')_*\mathcal{J}^\bullet$.
Note that this map is unique up to homotopy since the only
choice in the whole process was the choice of the map $\beta$
and everything was done on the level of complexes.
\end{proof}

\begin{remark}
\label{remark-correct-version-base-change-map}
The ``correct'' version of the base change map is map
$$
Lg^* Rf_* \mathcal{F}^\bullet
\longrightarrow
R(f')_* L(g')^*\mathcal{F}^\bullet.
$$
The construction of this map involves
unbounded complexes, see Remark \ref{remark-base-change}.
\end{remark}





\section{Proper base change in topology}
\label{section-proper-base-change}

\noindent
In this section we prove a very general version of the proper base change
theorem in topology. It tells us that the stalks of the higher direct
images $R^pf_*$ can be computed on the fibre.

\begin{lemma}
\label{lemma-proper-base-change}
Let $f : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism of
ringed spaces. Let $y \in Y$. Assume that
\begin{enumerate}
\item $f$ is closed,
\item $f$ is separated, and
\item $f^{-1}(y)$ is quasi-compact.
\end{enumerate}
Then for $E$ in $D^+(\mathcal{O}_X)$
we have $(Rf_*E)_y = R\Gamma(f^{-1}(y), E|_{f^{-1}(y)})$ in
$D^+(\mathcal{O}_{Y, y})$.
\end{lemma}

\begin{proof}
The base change map of Lemma \ref{lemma-base-change-map-flat-case}
gives a canonical map $(Rf_*E)_y \to R\Gamma(f^{-1}(y), E|_{f^{-1}(y)})$.
To prove this map is an isomorphism, we represent $E$ by a bounded
below complex of injectives $\mathcal{I}^\bullet$.
Set $Z = f^{-1}(\{y\})$. The assumptions of
Lemma \ref{lemma-cohomology-of-closed}
are satisfied, see Topology, Lemma \ref{topology-lemma-separated}.
Hence the restrictions
$\mathcal{I}^n|_Z$ are acyclic for $\Gamma(Z, -)$.
Thus $R\Gamma(Z, E|_Z)$ is represented by the
complex $\Gamma(Z, \mathcal{I}^\bullet|_Z)$, see
Derived Categories, Lemma \ref{derived-lemma-leray-acyclicity}.
In other words, we have to show the map
$$
\colim_V \mathcal{I}^\bullet(f^{-1}(V))
\longrightarrow
\Gamma(Z, \mathcal{I}^\bullet|_Z)
$$
is an isomorphism. Using Lemma \ref{lemma-cohomology-of-closed}
we see that it suffices to show that the collection of open neighbourhoods
$f^{-1}(V)$ of $Z = f^{-1}(\{y\})$
is cofinal in the system of all open neighbourhoods.
If $f^{-1}(\{y\}) \subset U$ is an open neighbourhood, then as $f$ is closed
the set $V = Y \setminus f(X \setminus U)$ is an open neighbourhood
of $y$ with $f^{-1}(V) \subset U$. This proves the lemma.
\end{proof}

\begin{theorem}[Proper base change]
\label{theorem-proper-base-change}
\begin{reference}
\cite[Expose V bis, 4.1.1]{SGA4}
\end{reference}
Consider a cartesian square of topological spaces
$$
\xymatrix{
X' = Y' \times_Y X \ar[d]_{f'} \ar[r]_-{g'} & X \ar[d]_f \\
Y' \ar[r]^g & Y
}
$$
Assume that $f$ is proper and separated.
Let $E$ be an object of $D^+(X)$. Then the base change map
$$
g^{-1}Rf_*E \longrightarrow Rf'_*(g')^{-1}E
$$
of Lemma \ref{lemma-base-change-map-flat-case} is an isomorphism
in $D^+(Y')$.
\end{theorem}

\begin{proof}
Let $y' \in Y'$ be a point with image $y \in Y$. It suffices to show that
the base change map induces an isomorphism on stalks at $y'$.
As $f$ is proper it follows that $f'$ is proper, the
fibres of $f$ and $f'$ are quasi-compact and $f$ and $f'$ are closed, see
Topology, Theorem \ref{topology-theorem-characterize-proper}.
Moreover $f'$ is separated by
Topology, Lemma \ref{topology-lemma-base-change-separated}.
Thus we can apply Lemma \ref{lemma-proper-base-change} twice to see that
$$
(Rf'_*(g')^{-1}E)_{y'} = R\Gamma((f')^{-1}(y'), (g')^{-1}E|_{(f')^{-1}(y')})
$$
and
$$
(Rf_*E)_y = R\Gamma(f^{-1}(y), E|_{f^{-1}(y)})
$$
The induced map of fibres $(f')^{-1}(y') \to f^{-1}(y)$ is
a homeomorphism of topological spaces and the pull back of
$E|_{f^{-1}(y)}$ is $(g')^{-1}E|_{(f')^{-1}(y')}$. The
desired result follows.
\end{proof}



\section{Cohomology and colimits}
\label{section-limits}

\noindent
Let $X$ be a ringed space. Let $(\mathcal{F}_i, \varphi_{ii'})$ be
a system of sheaves of $\mathcal{O}_X$-modules over the directed set $I$, see
Categories, Section \ref{categories-section-posets-limits}.
Since for each $i$ there is a canonical map
$\mathcal{F}_i \to \colim_i \mathcal{F}_i$ we get a
canonical map
$$
\colim_i H^p(X, \mathcal{F}_i)
\longrightarrow
H^p(X, \colim_i \mathcal{F}_i)
$$
for every $p \geq 0$. Of course there is a similar map for
every open $U \subset X$. These maps are in general not isomorphisms,
even for $p = 0$. In this section we generalize the results of
Sheaves, Lemma \ref{sheaves-lemma-directed-colimits-sections}.
See also
Modules, Lemma \ref{modules-lemma-finite-presentation-quasi-compact-colimit}
(in the special case $\mathcal{G} = \mathcal{O}_X$).

\begin{lemma}
\label{lemma-quasi-separated-cohomology-colimit}
Let $X$ be a ringed space. Assume that the underlying topological space
of $X$ has the following properties:
\begin{enumerate}
\item there exists a basis of quasi-compact open subsets, and
\item the intersection of any two quasi-compact opens is quasi-compact.
\end{enumerate}
Then for any directed system $(\mathcal{F}_i, \varphi_{ii'})$
of sheaves of $\mathcal{O}_X$-modules and for any quasi-compact open
$U \subset X$ the canonical map
$$
\colim_i H^q(U, \mathcal{F}_i)
\longrightarrow
H^q(U, \colim_i \mathcal{F}_i)
$$
is an isomorphism for every $q \geq 0$.
\end{lemma}

\begin{proof}
It is important in this proof to argue for all quasi-compact opens
$U \subset X$ at the same time.
The result is true for $i = 0$ and any quasi-compact open $U \subset X$ by
Sheaves, Lemma \ref{sheaves-lemma-directed-colimits-sections}
(combined with
Topology, Lemma \ref{topology-lemma-topology-quasi-separated-scheme}).
Assume that we have proved the result for all $q \leq q_0$ and let
us prove the result for $q = q_0 + 1$.

\medskip\noindent
By our conventions on directed systems the index set $I$ is directed,
and any system of $\mathcal{O}_X$-modules $(\mathcal{F}_i, \varphi_{ii'})$
over $I$ is directed.
By Injectives, Lemma \ref{injectives-lemma-sheaves-modules-space} the category
of $\mathcal{O}_X$-modules has functorial injective embeddings.
Thus for any system $(\mathcal{F}_i, \varphi_{ii'})$ there exists a
system $(\mathcal{I}_i, \varphi_{ii'})$ with each $\mathcal{I}_i$ an
injective $\mathcal{O}_X$-module and a morphism of systems given
by injective $\mathcal{O}_X$-module maps
$\mathcal{F}_i \to \mathcal{I}_i$. Denote $\mathcal{Q}_i$ the
cokernel so that we have short exact sequences
$$
0 \to
\mathcal{F}_i \to
\mathcal{I}_i \to
\mathcal{Q}_i \to 0.
$$
We claim that the sequence
$$
0 \to
\colim_i \mathcal{F}_i \to
\colim_i \mathcal{I}_i \to
\colim_i \mathcal{Q}_i \to 0.
$$
is also a short exact sequence of $\mathcal{O}_X$-modules.
We may check this on stalks. By
Sheaves, Sections \ref{sheaves-section-limits-presheaves}
and \ref{sheaves-section-limits-sheaves}
taking stalks commutes with colimits. Since a directed colimit
of short exact sequences of abelian groups is short exact
(see Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact})
we deduce the result. We claim that
$H^q(U, \colim_i \mathcal{I}_i) = 0$ for all quasi-compact
open $U \subset X$ and all $q \geq 1$. Accepting this claim
for the moment consider the diagram
$$
\xymatrix{
\colim_i H^{q_0}(U, \mathcal{I}_i) \ar[d] \ar[r] &
\colim_i H^{q_0}(U, \mathcal{Q}_i) \ar[d] \ar[r] &
\colim_i H^{q_0 + 1}(U, \mathcal{F}_i) \ar[d] \ar[r] &
0 \ar[d] \\
H^{q_0}(U, \colim_i \mathcal{I}_i) \ar[r] &
H^{q_0}(U, \colim_i \mathcal{Q}_i) \ar[r] &
H^{q_0 + 1}(U, \colim_i \mathcal{F}_i) \ar[r] &
0
}
$$
The zero at the lower right corner comes from the claim and the
zero at the upper right corner comes from the fact that the sheaves
$\mathcal{I}_i$ are injective.
The top row is exact by an application of
Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}.
Hence by the snake lemma we deduce the
result for $q = q_0 + 1$.

\medskip\noindent
It remains to show that the claim is true. We will use
Lemma \ref{lemma-cech-vanish-basis}.
Let $\mathcal{B}$ be the collection of all quasi-compact open
subsets of $X$. This is a basis for the topology on $X$ by assumption.
Let $\text{Cov}$ be the collection of finite open coverings
$\mathcal{U} : U = \bigcup_{j = 1, \ldots, m} U_j$ with each
of $U$, $U_j$ quasi-compact open in $X$. By the result for $q = 0$
we see that for $\mathcal{U} \in \text{Cov}$ we have
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, \colim_i \mathcal{I}_i)
=
\colim_i \check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{I}_i)
$$
because all the multiple intersections $U_{j_0 \ldots j_p}$
are quasi-compact. By Lemma \ref{lemma-injective-trivial-cech}
each of the complexes in the colimit of {\v C}ech complexes is
acyclic in degree $\geq 1$. Hence by
Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}
we see that also the {\v C}ech complex
$\check{\mathcal{C}}^\bullet(\mathcal{U}, \colim_i \mathcal{I}_i)$
is acyclic in degrees $\geq 1$. In other words we see that
$\check{H}^p(\mathcal{U},  \colim_i \mathcal{I}_i) = 0$
for all $p \geq 1$. Thus the assumptions of
Lemma \ref{lemma-cech-vanish-basis} are satisfied and the claim follows.
\end{proof}

\noindent
Next we formulate the analogy of
Sheaves, Lemma \ref{sheaves-lemma-descend-opens}
for cohomology.
Let $X$ be a spectral space which is written as a cofiltered limit
of spectral spaces $X_i$ for a diagram with spectral transition morphisms
as in
Topology, Lemma \ref{topology-lemma-directed-inverse-limit-spectral-spaces}.
Assume given
\begin{enumerate}
\item an abelian sheaf $\mathcal{F}_i$ on $X_i$ for all
$i \in \Ob(\mathcal{I})$,
\item for $a : j \to i$ an $f_a$-map
$\varphi_a : \mathcal{F}_i \to \mathcal{F}_j$ of abelian sheaves (see
Sheaves, Definition \ref{sheaves-definition-f-map})
\end{enumerate}
such that $\varphi_c = \varphi_b \circ \varphi_a$
whenever $c = a \circ b$. Set $\mathcal{F} = \colim p_i^{-1}\mathcal{F}_i$
on $X$.

\begin{lemma}
\label{lemma-colimit}
In the situation discussed above.
Let $i \in \Ob(\mathcal{I})$ and let $U_i \subset X_i$ be quasi-compact open.
Then
$$
\colim_{a : j \to i} H^p(f_a^{-1}(U_i), \mathcal{F}_j) =
H^p(p_i^{-1}(U_i), \mathcal{F})
$$
for all $p \geq 0$. In particular we have
$H^p(X, \mathcal{F}) = \colim H^p(X_i, \mathcal{F}_i)$.
\end{lemma}

\begin{proof}
The case $p = 0$ is Sheaves, Lemma \ref{sheaves-lemma-descend-opens}.

\medskip\noindent
In this paragraph we show that we can find a map of systems
$(\gamma_i) : (\mathcal{F}_i, \varphi_a) \to (\mathcal{G}_i, \psi_a)$
with $\mathcal{G}_i$ an injective abelian sheaf and $\gamma_i$ injective.
For each $i$ we pick an injection $\mathcal{F}_i \to \mathcal{I}_i$
where $\mathcal{I}_i$ is an injective abelian sheaf on $X_i$.
Then we can consider the family of maps
$$
\gamma_i :
\mathcal{F}_i
\longrightarrow
\prod\nolimits_{b : k \to i} f_{b, *}\mathcal{I}_k = \mathcal{G}_i
$$
where the component maps are the maps adjoint to the maps
$f_b^{-1}\mathcal{F}_i \to \mathcal{F}_k \to \mathcal{I}_k$.
For $a : j \to i$ in $\mathcal{I}$ there is a canonical map
$$
\psi_a : f_a^{-1}\mathcal{G}_i \to \mathcal{G}_j
$$
whose components are the canonical maps
$f_b^{-1}f_{a \circ b, *}\mathcal{I}_k \to f_{b, *}\mathcal{I}_k$
for $b : k \to j$. Thus we find an injection
$\{\gamma_i\} : \{\mathcal{F}_i, \varphi_a) \to (\mathcal{G}_i, \psi_a)$
of systems of abelian sheaves. Note that $\mathcal{G}_i$ is an injective
sheaf of abelian groups on $\mathcal{C}_i$, see
Lemma \ref{lemma-pushforward-injective-flat} and
Homology, Lemma \ref{homology-lemma-product-injectives}.
This finishes the construction.

\medskip\noindent
Arguing exactly as in the proof of
Lemma \ref{lemma-quasi-separated-cohomology-colimit}
we see that it suffices to prove that
$H^p(X, \colim f_i^{-1}\mathcal{G}_i) = 0$ for $p > 0$.

\medskip\noindent
Set $\mathcal{G} = \colim f_i^{-1}\mathcal{G}_i$.
To show vanishing of cohomology of $\mathcal{G}$ on every quasi-compact
open of $X$, it suffices to show that the {\v C}ech cohomology of
$\mathcal{G}$ for any covering $\mathcal{U}$ of a quasi-compact open of
$X$ by finitely many quasi-compact opens is zero, see
Lemma \ref{lemma-cech-vanish-basis}.
Such a covering is the inverse by $p_i$ of such a covering $\mathcal{U}_i$
on the space $X_i$ for some $i$ by
Topology, Lemma \ref{topology-lemma-descend-opens}. We have
$$
\check{\mathcal{C}}^\bullet(\mathcal{U}, \mathcal{G}) =
\colim_{a : j \to i}
\check{\mathcal{C}}^\bullet(f_a^{-1}(\mathcal{U}_i), \mathcal{G}_j)
$$
by the case $p = 0$. The right hand side is a filtered colimit of
complexes each of which is acyclic in positive degrees by
Lemma \ref{lemma-injective-trivial-cech}. Thus we conclude by
Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}.
\end{proof}









\section{Vanishing on Noetherian topological spaces}
\label{section-vanishing-Noetherian}

\noindent
The aim is to prove a theorem of Grothendieck namely
Proposition \ref{proposition-vanishing-Noetherian}. See \cite{Tohoku}.

\begin{lemma}
\label{lemma-cohomology-and-closed-immersions}
Let $i : Z \to X$ be a closed immersion of topological spaces.
For any abelian sheaf $\mathcal{F}$ on $Z$ we have
$H^p(Z, \mathcal{F}) = H^p(X, i_*\mathcal{F})$.
\end{lemma}

\begin{proof}
This is true because $i_*$ is exact (see
Modules, Lemma \ref{modules-lemma-i-star-exact}),
and hence $R^pi_* = 0$ as a functor
(Derived Categories, Lemma \ref{derived-lemma-right-derived-exact-functor}).
Thus we may apply Lemma \ref{lemma-apply-Leray}.
\end{proof}

\begin{lemma}
\label{lemma-irreducible-constant-cohomology-zero}
Let $X$ be an irreducible topological space.
Then $H^p(X, \underline{A}) = 0$ for all $p > 0$
and any abelian group $A$.
\end{lemma}

\begin{proof}
Recall that $\underline{A}$ is the constant sheaf as defined
in Sheaves, Definition \ref{sheaves-definition-constant-sheaf}.
It is clear that for any nonempty
open $U \subset X$ we have $\underline{A}(U) = A$ as $X$ is
irreducible (and hence $U$ is connected).
We will show that the higher {\v C}ech cohomology groups
$\check{H}^p(\mathcal{U}, \underline{A})$ are zero for
any open covering $\mathcal{U} : U = \bigcup_{i\in I} U_i$
of an open $U \subset X$. Then the lemma will follow
from Lemma \ref{lemma-cech-vanish}.

\medskip\noindent
Recall that the value of an abelian
sheaf on the empty open set is $0$. Hence we may clearly assume
$U_i \not = \emptyset$ for all $i \in I$. In this case we see
that $U_i \cap U_{i'} \not = \emptyset$ for all $i, i' \in I$.
Hence we see that the {\v C}ech complex is simply the complex
$$
\prod_{i_0 \in I} A \to
\prod_{(i_0, i_1) \in I^2} A \to
\prod_{(i_0, i_1, i_2) \in I^3} A \to
\ldots
$$
We have to see this has trivial higher cohomology groups.
We can see this for example because this is the {\v C}ech complex for the
covering of a $1$-point space and {\v C}ech cohomology agrees with cohomology
on such a space. (You can also directly verify it
by writing an explicit homotopy.)
\end{proof}

\begin{lemma}
\label{lemma-subsheaf-of-constant-sheaf}
\begin{reference}
\cite[Page 168]{Tohoku}.
\end{reference}
Let $X$ be a topological space such that the intersection of any
two quasi-compact opens is quasi-compact. Let
$\mathcal{F} \subset \underline{\mathbf{Z}}$
be a subsheaf generated by finitely many sections over quasi-compact opens.
Then there exists a finite filtration
$$
(0) = \mathcal{F}_0 \subset \mathcal{F}_1 \subset \ldots \subset
\mathcal{F}_n = \mathcal{F}
$$
by abelian subsheaves such that for each $0 < i \leq n$
there exists a short exact sequence
$$
0 \to j'_!\underline{\mathbf{Z}}_V \to j_!\underline{\mathbf{Z}}_U \to
\mathcal{F}_i/\mathcal{F}_{i - 1} \to 0
$$
with $j : U \to X$ and $j' : V \to X$ the inclusion of quasi-compact opens
into $X$.
\end{lemma}

\begin{proof}
Say $\mathcal{F}$ is generated by the sections $s_1, \ldots, s_t$ over the
quasi-compact opens $U_1, \ldots, U_t$. Since $U_i$ is quasi-compact and
$s_i$ a locally constant function to $\mathbf{Z}$ we may assume, after
possibly replacing $U_i$ by the parts of a finite decomposition into open
and closed subsets, that $s_i$ is a constant section.
Say $s_i = n_i$ with $n_i \in \mathbf{Z}$. Of course we can remove
$(U_i, n_i)$ from the list if $n_i = 0$. Flipping signs if necessary
we may also assume $n_i > 0$. Next, for any subset $I \subset \{1, \ldots, t\}$
we may add $\bigcup_{i \in I} U_i$ and $\gcd(n_i, i \in I)$ to the list.
After doing this we see that our list $(U_1, n_1), \ldots, (U_t, n_t)$
satisfies the following property:
For $x \in X$ set $I_x = \{i \in \{1, \ldots, t\} \mid x \in U_i\}$.
Then $\gcd(n_i, i \in I_x)$ is attained by $n_i$ for some $i \in I_x$.

\medskip\noindent
As our filtration we take $\mathcal{F}_0 = (0)$ and
$\mathcal{F}_n$ generated by the sections $n_i$ over $U_i$ for those
$i$ such that $n_i \leq n$. It is clear that
$\mathcal{F}_n = \mathcal{F}$ for $n \gg 0$. Moreover, the quotient
$\mathcal{F}_n/\mathcal{F}_{n - 1}$ is generated by the section
$n$ over $U = \bigcup_{n_i \leq n} U_i$ and the kernel of the map
$j_!\underline{\mathbf{Z}}_U \to \mathcal{F}_n/\mathcal{F}_{n - 1}$
is generated by the section $n$ over $V = \bigcup_{n_i \leq n - 1} U_i$.
Thus a short exact sequence as in the statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-generated-one-section}
\begin{reference}
This is a special case of \cite[Proposition 3.6.1]{Tohoku}.
\end{reference}
Let $X$ be a topological space. Let $d \geq 0$ be an integer. Assume
\begin{enumerate}
\item $X$ is quasi-compact,
\item the quasi-compact opens form a basis for $X$, and
\item the intersection of two quasi-compact opens is quasi-compact.
\item $H^p(X, j_!\underline{\mathbf{Z}}_U) = 0$ for all $p > d$
and any quasi-compact open $j : U \to X$.
\end{enumerate}
Then $H^p(X, \mathcal{F}) = 0$ for all $p > d$
and any abelian sheaf $\mathcal{F}$ on $X$.
\end{lemma}

\begin{proof}
Let $S = \coprod_{U \subset X} \mathcal{F}(U)$ where $U$ runs over the
quasi-compact opens of $X$.
For any finite subset $A = \{s_1, \ldots, s_n\} \subset S$,
let $\mathcal{F}_A$ be the subsheaf of $\mathcal{F}$ generated
by all $s_i$ (see
Modules, Definition \ref{modules-definition-generated-by-local-sections}).
Note that if $A \subset A'$, then $\mathcal{F}_A \subset \mathcal{F}_{A'}$.
Hence $\{\mathcal{F}_A\}$ forms a system over the
directed partially ordered set of finite subsets of $S$.
By Modules, Lemma \ref{modules-lemma-generated-by-local-sections-stalk}
it is clear that
$$
\colim_A \mathcal{F}_A = \mathcal{F}
$$
by looking at stalks. By
Lemma \ref{lemma-quasi-separated-cohomology-colimit} we have
$$
H^p(X, \mathcal{F}) =
\colim_A H^p(X, \mathcal{F}_A)
$$
Hence it suffices to prove the vanishing for the abelian sheaves
$\mathcal{F}_A$. In other words, it suffices to prove the
result when $\mathcal{F}$ is generated by finitely many local sections
over quasi-compact opens of $X$.

\medskip\noindent
Suppose that $\mathcal{F}$ is generated by the local sections
$s_1, \ldots, s_n$. Let $\mathcal{F}' \subset \mathcal{F}$
be the subsheaf generated by $s_1, \ldots, s_{n - 1}$.
Then we have a short exact sequence
$$
0 \to \mathcal{F}' \to \mathcal{F} \to \mathcal{F}/\mathcal{F}' \to 0
$$
From the long exact sequence of cohomology we see that it suffices
to prove the vanishing for the abelian sheaves $\mathcal{F}'$
and $\mathcal{F}/\mathcal{F}'$ which are generated by fewer than
$n$ local sections. Hence it suffices to prove the vanishing
for sheaves generated by at most one local section. These sheaves
are exactly the quotients of the sheaves $j_!\underline{\mathbf{Z}}_U$
where $U$ is a quasi-compact open of $X$.

\medskip\noindent
Assume now that we have a short exact sequence
$$
0 \to \mathcal{K} \to j_!\underline{\mathbf{Z}}_U \to \mathcal{F} \to 0
$$
with $U$ quasi-compact open in $X$.
It suffices to show that $H^q(X, \mathcal{K})$ is zero for $q \geq d + 1$.
As above we can write $\mathcal{K}$ as the filtered colimit of
subsheaves $\mathcal{K}'$ generated by finitely many sections over
quasi-compact opens. Then $\mathcal{F}$ is the filtered colimit of the
sheaves $j_!\underline{\mathbf{Z}}_U/\mathcal{K}'$. In this way we
reduce to the case that $\mathcal{K}$ is generated by finitely many
sections over quasi-compact opens. Note that $\mathcal{K}$
is a subsheaf of $\underline{\mathbf{Z}}_X$. Thus by
Lemma \ref{lemma-subsheaf-of-constant-sheaf} there exists a finite
filtration of $\mathcal{K}$ whose successive quotients $\mathcal{Q}$ fit
into a short exact sequence
$$
0 \to j''_!\underline{\mathbf{Z}}_W \to
j'_!\underline{\mathbf{Z}}_V \to \mathcal{Q} \to 0
$$
with $j'' : W \to X$ and $j' : V \to X$ the inclusions of quasi-compact opens.
Hence the vanishing of $H^p(X, \mathcal{Q})$ for $p > d$ follows
from our assumption (in the lemma) on the vanishing of the cohomology groups
of $j''_!\underline{\mathbf{Z}}_W$ and $j'_!\underline{\mathbf{Z}}_V$.
Returning to $\mathcal{K}$ this, via an induction argument using the
long exact cohomology sequence, implies the desired vanishing for it as well.
\end{proof}

\begin{example}
\label{example-datta}
Let $X = \mathbf{N}$ endowed with the topology whose opens are
$\emptyset$, $X$, and $U_n = \{i \mid i \leq n\}$ for $n \geq 1$.
An abelian sheaf $\mathcal{F}$ on $X$ is the same as an inverse
system of abelian groups $A_n = \mathcal{F}(U_n)$ and
$\Gamma(X, \mathcal{F}) = \lim A_n$. Since the inverse limit
functor is not an exact functor on the category of inverse systems,
we see that there is an abelian sheaf with nonzero $H^1$.
Finally, the reader can check that $H^p(X, j_!\mathbf{Z}_U) = 0$,
$p \geq 1$ if $j : U = U_n \to X$ is the inclusion. Thus we see
that $X$ is an example of a space satisfying conditions (2), (3), and (4) of
Lemma \ref{lemma-vanishing-generated-one-section} for $d = 0$
but not the conclusion.
\end{example}

\begin{lemma}
\label{lemma-subsheaf-irreducible}
Let $X$ be an irreducible topological space.
Let $\mathcal{H} \subset \underline{\mathbf{Z}}$ be
an abelian subsheaf of the constant sheaf.
Then there exists a nonempty open $U \subset X$ such
that $\mathcal{H}|_U = \underline{d\mathbf{Z}}_U$
for some $d \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Recall that $\underline{\mathbf{Z}}(V) = \mathbf{Z}$
for any nonempty open $V$ of $X$ (see proof of
Lemma \ref{lemma-irreducible-constant-cohomology-zero}).
If $\mathcal{H} = 0$, then the lemma holds with $d = 0$.
If $\mathcal{H} \not = 0$, then there exists a nonempty open
$U \subset X$ such that $\mathcal{H}(U) \not = 0$.
Say $\mathcal{H}(U) = n\mathbf{Z}$ for some $n \geq 1$.
Hence we see that
$\underline{n\mathbf{Z}}_U
\subset \mathcal{H}|_U \subset
\underline{\mathbf{Z}}_U$. If the first inclusion is strict we
can find a nonempty $U' \subset U$ and an integer $1 \leq n' < n$
such that
$\underline{n'\mathbf{Z}}_{U'}
\subset \mathcal{H}|_{U'} \subset
\underline{\mathbf{Z}}_{U'}$.
This process has to stop after a finite number of steps, and
hence we get the lemma.
\end{proof}

\begin{proposition}[Grothendieck]
\label{proposition-vanishing-Noetherian}
\begin{reference}
\cite[Theorem 3.6.5]{Tohoku}.
\end{reference}
Let $X$ be a Noetherian topological space.
If $\dim(X) \leq d$, then $H^p(X, \mathcal{F}) = 0$
for all $p > d$ and any abelian sheaf $\mathcal{F}$
on $X$.
\end{proposition}

\begin{proof}
We prove this lemma by induction on $d$.
So fix $d$ and assume the lemma holds for all
Noetherian topological spaces of dimension $< d$.

\medskip\noindent
Let $\mathcal{F}$ be an abelian sheaf on $X$.
Suppose $U \subset X$ is an open. Let $Z \subset X$
denote the closed complement.
Denote $j : U \to X$ and $i : Z \to X$ the inclusion maps.
Then there is a short exact sequence
$$
0 \to j_{!}j^*\mathcal{F} \to \mathcal{F} \to i_*i^*\mathcal{F} \to 0
$$
see Modules, Lemma \ref{modules-lemma-canonical-exact-sequence}.
Note that $j_!j^*\mathcal{F}$ is supported on
the topological closure $Z'$ of $U$, i.e., it is of
the form $i'_*\mathcal{F}'$ for some abelian sheaf $\mathcal{F}'$
on $Z'$, where $i' : Z' \to X$ is the inclusion.

\medskip\noindent
We can use this to reduce to the case where $X$ is irreducible.
Namely, according to
Topology, Lemma \ref{topology-lemma-Noetherian}
$X$ has finitely
many irreducible components. If $X$ has more than one irreducible
component, then let $Z \subset X$ be an irreducible component of $X$
and set $U = X \setminus Z$. By the above, and the long exact sequence
of cohomology, it suffices to prove the vanishing of
$H^p(X, i_*i^*\mathcal{F})$ and $H^p(X, i'_*\mathcal{F}')$ for $p > d$.
By Lemma \ref{lemma-cohomology-and-closed-immersions} it suffices to prove
$H^p(Z, i^*\mathcal{F})$ and $H^p(Z', \mathcal{F}')$ vanish for $p > d$.
Since $Z'$ and $Z$ have fewer irreducible components we indeed
reduce to the case of an irreducible $X$.

\medskip\noindent
If $d = 0$ and $X = \{*\}$, then every sheaf is constant and
higher cohomology
groups vanish (for example by
Lemma \ref{lemma-irreducible-constant-cohomology-zero}).

\medskip\noindent
Suppose $X$ is irreducible of dimension $d$.
By Lemma \ref{lemma-vanishing-generated-one-section}
we reduce to the case where
$\mathcal{F} = j_!\underline{\mathbf{Z}}_U$ for some open $U \subset X$.
In this case we look at the short exact sequence
$$
0 \to j_!(\underline{\mathbf{Z}}_U) \to
\underline{\mathbf{Z}}_X \to i_*\underline{\mathbf{Z}}_Z \to 0
$$
where $Z = X \setminus U$.
By Lemma \ref{lemma-irreducible-constant-cohomology-zero}
we have the vanishing of $H^p(X, \underline{\mathbf{Z}}_X)$
for all $p \geq 1$. By induction we have
$H^p(X, i_*\underline{\mathbf{Z}}_Z) = H^p(Z, \underline{\mathbf{Z}}_Z) = 0$
for $p \geq d$. Hence we win by the long exact cohomology sequence.
\end{proof}





\section{Cohomology with support in a closed}
\label{section-cohomology-support}

\noindent
Let $X$ be a topological space and let $Z \subset X$ be a closed subset.
Let $\mathcal{F}$ be an abelian sheaf on $X$. We let
$$
\Gamma_Z(X, \mathcal{F}) =
\{s \in \mathcal{F}(X) \mid \text{Supp}(s) \subset Z\}
$$
be the sections with support in $Z$
(Modules, Definition \ref{modules-definition-support}).
This is a left exact functor which is not exact in general.
Hence we obtain a derived functor
$$
R\Gamma_Z(X, -) : D(X) \longrightarrow D(\textit{Ab})
$$
and cohomology groups with support in $Z$ defined by
$H^q_Z(X, \mathcal{F}) = R^q\Gamma_Z(X, \mathcal{F})$.

\medskip\noindent
Let $\mathcal{I}$ be an injective abelian sheaf on $X$. Let
$U = X \setminus Z$. Then the
restriction map $\mathcal{I}(X) \to \mathcal{I}(U)$ is surjective
(Lemma \ref{lemma-injective-restriction-surjective})
with kernel $\Gamma_Z(X, \mathcal{I})$. It immediately follows that
for $K \in D(X)$ there is a distinguished triangle
$$
R\Gamma_Z(X, K) \to R\Gamma(X, K) \to R\Gamma(U, K) \to R\Gamma_Z(X, K)[1]
$$
in $D(\textit{Ab})$. As a consequence we obtain a long exact cohomology
sequence
$$
\ldots \to H^i_Z(X, K) \to H^i(X, K) \to H^i(U, K) \to
H^{i + 1}_Z(X, K) \to \ldots
$$
for any $K$ in $D(X)$.

\medskip\noindent
For an abelian sheaf $\mathcal{F}$ on $X$ we can consider
the {\it subsheaf of sections with support in $Z$}, denoted
$\mathcal{H}_Z(\mathcal{F})$, defined by the rule
$$
\mathcal{H}_Z(\mathcal{F})(U) =
\{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset U \cap Z\}
$$
Using the equivalence of Modules, Lemma \ref{modules-lemma-i-star-exact}
we may view $\mathcal{H}_Z(\mathcal{F})$ as an abelian sheaf on
$Z$ (see also Modules, Lemmas
\ref{modules-lemma-sections-support-in-closed} and
\ref{modules-lemma-i-star-right-adjoint}).
Thus we obtain a functor
$$
\textit{Ab}(X) \longrightarrow \textit{Ab}(Z),\quad
\mathcal{F} \longmapsto
\mathcal{H}_Z(\mathcal{F})\text{ viewed as a sheaf on }Z
$$
which is left exact, but in general not exact.

\begin{lemma}
\label{lemma-sections-with-support-acyclic}
Let $i : Z \to X$ be the inclusion of a closed subset.
Let $\mathcal{I}$ be an injective abelian sheaf on $X$.
Then $\mathcal{H}_Z(\mathcal{I})$ is an injective abelian sheaf on $Z$.
\end{lemma}

\begin{proof}
Observe that for any abelian sheaf $\mathcal{G}$ on $Z$
we have
$$
\Hom_Z(\mathcal{G}, \mathcal{H}_Z(\mathcal{F})) =
\Hom_X(i_*\mathcal{G}, \mathcal{F})
$$
because after all any section of $i_*\mathcal{G}$ has support in $Z$.
Since $i_*$ is exact (Modules, Lemma \ref{modules-lemma-i-star-exact})
and $\mathcal{I}$ injective on $X$ we conclude that
$\mathcal{H}_Z(\mathcal{I})$ is injective on $Z$.
\end{proof}

\noindent
Denote
$$
R\mathcal{H}_Z : D(X) \longrightarrow D(Z)
$$
the derived functor. We set
$\mathcal{H}^q_Z(\mathcal{F}) = R^q\mathcal{H}_Z(\mathcal{F})$ so that
$\mathcal{H}^0_Z(\mathcal{F}) = \mathcal{H}_Z(\mathcal{F})$.
By the lemma above we have a Grothendieck spectral sequence
$$
E_2^{p, q} = H^p(Z, \mathcal{H}^q_Z(\mathcal{F}))
\Rightarrow H^{p + q}_Z(X, \mathcal{F})
$$

\begin{lemma}
\label{lemma-cohomology-with-support-sheaf-on-support}
Let $i : Z \to X$ be the inclusion of a closed subset.
Let $\mathcal{G}$ be an injective abelian sheaf on $Z$.
Then $\mathcal{H}^p_Z(i_*\mathcal{G}) = 0$ for $p > 0$.
\end{lemma}

\begin{proof}
This is true because the functor $i_*$ is exact and transforms
injective abelian sheaves into injective abelian sheaves by Lemma
\ref{lemma-pushforward-injective-flat}.
\end{proof}

\noindent
Let $X$ be a topological space and let $Z \subset X$ be a closed subset.
We denote $D_Z(X)$ the strictly full saturated triangulated subcategory of
$D(X)$ consisting of complexes whose cohomology sheaves are supported on
$Z$.

\begin{lemma}
\label{lemma-complexes-with-support-on-closed}
Let $i : Z \to X$ be the inclusion of a closed subset of a topological
space $X$. The map $Ri_* = i_* : D(Z) \to D(X)$ induces an equivalence
$D(Z) \to D_Z(X)$ with quasi-inverse
$$
i^{-1}|_{D_Z(X)} = R\mathcal{H}_Z|_{D_Z(X)}
$$
\end{lemma}

\begin{proof}
Recall that $i^{-1}$ and $i_*$ is an adjoint pair of exact functors such
that $i^{-1}i_*$ is isomorphic to the identify functor on abelian sheaves. See
Modules, Lemmas \ref{modules-lemma-exactness-pushforward-pullback} and
\ref{modules-lemma-i-star-exact}. Thus
$i_* : D(Z) \to D_Z(X)$ is fully faithful and $i^{-1}$ determines
a left inverse. On the other hand, suppose that $K$ is an object of
$D_Z(X)$ and consider the adjunction map $K \to i_*i^{-1}K$.
Using exactness of $i_*$ and $i^{-1}$ this induces the adjunction maps
$H^n(K) \to i_*i^{-1}H^n(K)$ on cohomology sheaves. Since these cohomology
sheaves are supported on $Z$ we see these adjunction maps are isomorphisms
and we conclude that $D(Z) \to D_Z(X)$ is an equivalence.

\medskip\noindent
To finish the proof we have to show that $R\mathcal{H}_Z(K) = i^{-1}K$ if
$K$ is an object of $D_Z(X)$. To do this we can use that $K = i_*i^{-1}K$
as we've just proved this is the case. Then we
can choose a K-injective representative $\mathcal{I}^\bullet$ for $i^{-1}K$.
Since $i_*$ is the right adjoint to the exact functor $i^{-1}$, the
complex $i_*\mathcal{I}^\bullet$ is K-injective
(Derived Categories, Lemma \ref{derived-lemma-adjoint-preserve-K-injectives}).
We see that $R\mathcal{H}_Z(K)$ is computed by
$\mathcal{H}_Z(i_*\mathcal{I}^\bullet) = \mathcal{I}^\bullet$ as desired.
\end{proof}




\section{Cohomology on spectral spaces}
\label{section-spectral}

\noindent
A key result on the cohomology of spectral spaces is Lemma \ref{lemma-colimit}
which loosely speaking says that cohomology commutes with cofiltered limits
in the category of spectral spaces as defined in
Topology, Definition \ref{topology-definition-spectral-space}.
This can be applied to give analogues of
Lemmas \ref{lemma-cohomology-of-closed} and \ref{lemma-proper-base-change}
as follows.

\begin{lemma}
\label{lemma-cohomology-of-neighbourhoods-of-closed}
Let $X$ be a spectral space. Let $\mathcal{F}$ be an abelian sheaf on $X$.
Let $E \subset X$ be a quasi-compact subset. Let $W \subset X$ be the set of
points of $X$ which specialize to a point of $E$.
\begin{enumerate}
\item $H^p(W, \mathcal{F}|_W) = \colim H^p(U, \mathcal{F})$
where the colimit is over quasi-compact open neighbourhoods of $E$,
\item $H^p(W \setminus E, \mathcal{F}|_{W \setminus E}) =
\colim H^p(U \setminus E, \mathcal{F}|_{U \setminus E})$
if $E$ is a constructible subset.
\end{enumerate}
\end{lemma}

\begin{proof}
From Topology, Lemma \ref{topology-lemma-make-spectral-space}
we see that $W = \lim U$ where the limit is over the quasi-compact
opens containing $E$. Each $U$ is a spectral space by
Topology, Lemma \ref{topology-lemma-spec